# LFI2RCE poprzez wieczne oczekiwanie

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>

## Podstawowe informacje

Domylnie, gdy plik jest przesyany do PHP (nawet jeli nie jest oczekiwany), zostanie wygenerowany tymczasowy plik w `/tmp` o nazwie takiej jak **`php[a-zA-Z0-9]{6}`**, chocia偶 zdarzyo mi si zobaczy niekt贸re obrazy Docker, w kt贸rych wygenerowane pliki nie zawieraj cyfr.

W przypadku lokalnego wczenia pliku, **jeli uda ci si wczy ten przesany plik, uzyskasz RCE**.

Nale偶y zauwa偶y, 偶e domylnie **PHP pozwala tylko na przesanie 20 plik贸w w jednym 偶daniu** (ustawione w `/etc/php/<version>/apache2/php.ini`):
```
; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20
```
R贸wnie偶, **liczba potencjalnych nazw plik贸w wynosi 62\*62\*62\*62\*62\*62 = 56800235584**

### Inne techniki

Inne techniki polegaj na atakowaniu protoko贸w PHP (nie bdziesz w stanie tego zrobi, jeli kontrolujesz tylko ostatni cz cie偶ki), ujawnianiu cie偶ki pliku, nadu偶ywaniu oczekiwanych plik贸w lub **spowodowaniu awarii segmentacji PHP, aby tymczasowe pliki nie byy usuwane**.\
Ta technika jest **bardzo podobna do poprzedniej, ale nie wymaga znajdowania luki zero day**.

### Technika wiecznego oczekiwania

W tej technice **wystarczy kontrolowa cie偶k wzgldn**. Jeli uda nam si przesa pliki i sprawi, 偶e **LFI nigdy si nie zakoczy**, bdziemy mieli "wystarczajco du偶o czasu", aby **przebrutowa przesane pliki** i **znale藕** kt贸rykolwiek z nich.

**Zalety tej techniki**:

* Wystarczy kontrolowa cie偶k wzgldn wewntrz include
* Nie wymaga nginx ani nieoczekiwanego poziomu dostpu do plik贸w dziennika
* Nie wymaga luki zero day do spowodowania awarii segmentacji
* Nie wymaga ujawnienia cie偶ki

**G贸wne problemy** tej techniki to:

* Wymaga obecnoci okrelonego pliku/plik贸w (mo偶e ich by wicej)
* **Niewiarygodna** liczba potencjalnych nazw plik贸w: **56800235584**
* Jeli serwer **nie u偶ywa cyfr**, cakowita potencjalna liczba wynosi: **19770609664**
* Domylnie **tylko 20 plik贸w** mo偶e by przesanych w **jednym 偶daniu**.
* **Maksymalna liczba r贸wnolegych pracownik贸w** u偶ywanego serwera.
* Te ograniczenia w poczeniu z poprzednimi mog sprawi, 偶e atak ten potrwa zbyt dugo
* **Limit czasu dla 偶dania PHP**. Idealnie powinien by wieczny lub powinien zabi proces PHP bez usuwania tymczasowych przesanych plik贸w, jeli nie, r贸wnie偶 bdzie to problem

Wic, jak mo偶na **spowodowa, 偶e include PHP nigdy si nie zakoczy**? Wystarczy doczy plik **`/sys/kernel/security/apparmor/revision`** (**niestety niedostpny w kontenerach Docker**).

Spr贸buj tego, po prostu wywoujc:
```bash
php -a # open php cli
include("/sys/kernel/security/apparmor/revision");
```
## Apache2

Domylnie Apache obsuguje **150 r贸wnoczesnych pocze**, zgodnie z [https://ubiq.co/tech-blog/increase-max-connections-apache/](https://ubiq.co/tech-blog/increase-max-connections-apache/) mo偶na zwikszy t liczb do 8000. Postpuj zgodnie z tym, aby u偶ywa PHP z tym moduem: [https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04).

Domylnie (jak mog zobaczy w moich testach), **proces PHP mo偶e trwa wiecznie**.

Zr贸bmy troch matematyki:

* Mo偶emy u偶y **149 pocze** do wygenerowania **149 \* 20 = 2980 plik贸w tymczasowych** za pomoc naszego webshell.
* Nastpnie u偶yj **ostatniego poczenia** do **brute-force** potencjalnych plik贸w.
* Przy prdkoci **10 偶da/s** czasy to:
* 56800235584 / 2980 / 10 / 3600 \~= **530 godzin** (50% szans w 265h)
* (bez cyfr) 19770609664 / 2980 / 10 / 3600 \~= 185h (50% szans w 93h)

{% hint style="warning" %}
Nale偶y zauwa偶y, 偶e w poprzednim przykadzie **cakowicie DoSujemy innych klient贸w**!
{% endhint %}

Jeli serwer Apache zostanie ulepszony i bdziemy mogli wykorzysta **4000 pocze** (poowa maksymalnej liczby). Moglibymy utworzy `3999*20 = 79980` **plik贸w** i **liczba** zmniejszyaby si do okoo **19.7h** lub **6.9h** (10h, 3.5h 50% szans).

## PHP-FMP

Jeli zamiast u偶ywa standardowego moduu php dla apache do uruchamiania skrypt贸w PHP, **strona internetowa korzysta z PHP-FMP** (co poprawia wydajno strony internetowej, wic jest to czste), istnieje co innego, co mo偶na zrobi, aby poprawi technik.

PHP-FMP pozwala na **konfiguracj parametru** **`request_terminate_timeout`** w **`/etc/php/<php-version>/fpm/pool.d/www.conf`**.\
Ten parametr wskazuje maksymaln liczb sekund, **kiedy 偶danie do PHP musi si zakoczy** (domylnie nieskoczono, ale **30s, jeli parametr jest odkomentowany**). Gdy 偶danie jest przetwarzane przez PHP przez okrelon liczb sekund, jest **zabijane**. Oznacza to, 偶e jeli 偶danie przesyao tymczasowe pliki, poniewa偶 **przetwarzanie php zostao zatrzymane**, te **pliki nie zostan usunite**. Dlatego, jeli mo偶esz sprawi, 偶e 偶danie potrwa tyle czasu, mo偶esz **generowa tysice tymczasowych plik贸w**, kt贸re nie zostan usunite, co przyspieszy proces ich znalezienia i zmniejszy prawdopodobiestwo DoS dla platformy poprzez zu偶ycie wszystkich pocze.

Wic, aby **unikn DoS**, za贸偶my, 偶e **atakujcy bdzie u偶ywa tylko 100 pocze** jednoczenie, a maksymalny czas przetwarzania PHP przez **php-fmp** (`request_terminate_timeout`**)** wynosi **30s**. Liczba **plik贸w tymczasowych**, kt贸re mo偶na wygenerowa **na sekund**, wynosi `100*20/30 = 66.67`.

Nastpnie, aby wygenerowa **10000 plik贸w**, atakujcemu zajoby: **`10000/66.67 = 150s`** (aby wygenerowa **100000 plik贸w**, czas wyni贸sby **25 minut**).

Nastpnie, atakujcy m贸gby u偶y tych **100 pocze** do przeprowadzenia **brute-force**. Przy zao偶eniu prdkoci 300 偶da/s czas potrzebny do wykorzystania tej techniki wynosi:

* 56800235584 / 10000 / 300 / 3600 \~= **5.25 godziny** (50% szans w 2.63h)
* (z 100000 plikami) 56800235584 / 100000 / 300 / 3600 \~= **0.525 godziny** (50% szans w 0.263h)

Tak, jest mo偶liwe wygenerowanie 100000 tymczasowych plik贸w na instancji o rednim rozmiarze EC2:

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Nale偶y zauwa偶y, 偶e w celu wywoania limitu czasu wystarczy **doczy podatn stron LFI**, aby wprowadzi j w wieczn ptl include.
{% endhint %}

## Nginx

Wyglda na to, 偶e domylnie Nginx obsuguje **512 r贸wnoczesnych pocze** (a ta liczba mo偶e by zwikszona).
