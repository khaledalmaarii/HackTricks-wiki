# LFI2RCE via Eternal waiting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

Domylnie, gdy plik jest przesyany do PHP (nawet jeli nie jest tego oczekiwany), generowany jest plik tymczasowy w `/tmp` o nazwie takiej jak **`php[a-zA-Z0-9]{6}`**, chocia偶 widziaem niekt贸re obrazy dockera, w kt贸rych generowane pliki nie zawieraj cyfr.

W przypadku lokalnego wczenia pliku, **jeli uda ci si doczy ten przesany plik, uzyskasz RCE**.

Zauwa偶, 偶e domylnie **PHP pozwala na przesanie tylko 20 plik贸w w jednym 偶daniu** (ustawione w `/etc/php/<version>/apache2/php.ini`):
```
; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20
```
Also, the **liczba potencjalnych nazw plik贸w wynosi 62\*62\*62\*62\*62\*62 = 56800235584**

### Inne techniki

Inne techniki polegaj na atakowaniu protoko贸w PHP (nie bdziesz w stanie, jeli kontrolujesz tylko ostatni cz cie偶ki), ujawnianiu cie偶ki pliku, nadu偶ywaniu oczekiwanych plik贸w lub **sprawieniu, by PHP doznao bdu segmentacji, aby przesane pliki tymczasowe nie zostay usunite**.\
Ta technika jest **bardzo podobna do ostatniej, ale nie wymaga znalezienia zero day**.

### Technika wiecznego czekania

W tej technice **musimy tylko kontrolowa wzgldn cie偶k**. Jeli uda nam si przesa pliki i sprawi, by **LFI nigdy si nie koczy**, bdziemy mieli "wystarczajco du偶o czasu", aby **brute-forcowa przesane pliki** i **znale藕** dowolny z przesanych.

**Zalety tej techniki**:

* Musisz tylko kontrolowa wzgldn cie偶k wewntrz include
* Nie wymaga nginx ani nieoczekiwanego poziomu dostpu do plik贸w dziennika
* Nie wymaga 0 day, aby spowodowa bd segmentacji
* Nie wymaga ujawnienia cie偶ki

**G贸wne problemy** tej techniki to:

* Potrzebujesz, aby konkretne pliki byy obecne (mo偶e by ich wicej)
* **szalona** liczba potencjalnych nazw plik贸w: **56800235584**
* Jeli serwer **nie u偶ywa cyfr**, cakowita potencjalna liczba wynosi: **19770609664**
* Domylnie **tylko 20 plik贸w** mo偶e by przesanych w **jednym 偶daniu**.
* **maksymalna liczba r贸wnolegych pracownik贸w** u偶ywanego serwera.
* Ten limit w poczeniu z poprzednimi mo偶e sprawi, 偶e atak bdzie trwa zbyt dugo
* **Limit czasu dla 偶dania PHP**. Idealnie powinien by wieczny lub powinien zabi proces PHP bez usuwania przesanych plik贸w tymczasowych, w przeciwnym razie bdzie to r贸wnie偶 problem

Wic, jak mo偶esz **sprawi, by include PHP nigdy si nie koczy**? Po prostu przez doczenie pliku **`/sys/kernel/security/apparmor/revision`** (**niestety niedostpny w kontenerach Docker...**).

Spr贸buj to, po prostu wywoujc:
```bash
php -a # open php cli
include("/sys/kernel/security/apparmor/revision");
```
## Apache2

Domylnie, Apache obsuguje **150 r贸wnolegych pocze**, zgodnie z [https://ubiq.co/tech-blog/increase-max-connections-apache/](https://ubiq.co/tech-blog/increase-max-connections-apache/) mo偶na zwikszy t liczb do 8000. Postpuj zgodnie z tym, aby u偶ywa PHP z tym moduem: [https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04).

Domylnie, (jak widz w moich testach), **proces PHP mo偶e trwa wiecznie**.

Zr贸bmy kilka oblicze:

* Mo偶emy u偶y **149 pocze** do wygenerowania **149 \* 20 = 2980 plik贸w tymczasowych** z naszym webshell.
* Nastpnie, u偶yj **ostatniego poczenia** do **brute-force** potencjalnych plik贸w.
* Przy prdkoci **10 偶da/s** czasy wynosz:
* 56800235584 / 2980 / 10 / 3600 \~= **530 godzin** (50% szans w 265h)
* (bez cyfr) 19770609664 / 2980 / 10 / 3600 \~= 185h (50% szans w 93h)

{% hint style="warning" %}
Zauwa偶, 偶e w poprzednim przykadzie **cakowicie DoSujemy innych klient贸w**!
{% endhint %}

Jeli serwer Apache jest ulepszony i moglibymy nadu偶ywa **4000 pocze** (w poowie drogi do maksymalnej liczby). Moglibymy stworzy `3999*20 = 79980` **plik贸w** a **liczba** zostaaby **zmniejszona** do okoo **19.7h** lub **6.9h** (10h, 3.5h 50% szans).

## PHP-FMP

Jeli zamiast u偶ywa regularnego moduu php dla apache do uruchamiania skrypt贸w PHP, **strona internetowa u偶ywa** **PHP-FMP** (to poprawia wydajno strony internetowej, wic jest powszechnie spotykane), mo偶na zrobi co jeszcze, aby poprawi t technik.

PHP-FMP pozwala na **konfiguracj** **parametru** **`request_terminate_timeout`** w **`/etc/php/<php-version>/fpm/pool.d/www.conf`**.\
Ten parametr wskazuje maksymaln liczb sekund **kiedy** **偶danie do PHP musi zakoczy si** (domylnie nieskoczono, ale **30s, jeli parametr jest odkomentowany**). Gdy 偶danie jest przetwarzane przez PHP przez wskazan liczb sekund, jest **zabijane**. Oznacza to, 偶e jeli 偶danie przesyao pliki tymczasowe, poniewa偶 **przetwarzanie php zostao zatrzymane**, te **pliki nie zostan usunite**. Dlatego, jeli mo偶esz sprawi, aby 偶danie trwao ten czas, mo偶esz **generowa tysice plik贸w tymczasowych**, kt贸re nie zostan usunite, co **przyspieszy proces ich znajdowania** i zmniejsza prawdopodobiestwo DoS dla platformy poprzez wykorzystanie wszystkich pocze.

Aby **unika DoS**, za贸偶my, 偶e **atakujcy bdzie u偶ywa tylko 100 pocze** w tym samym czasie, a maksymalny czas przetwarzania php przez **php-fmp** (`request_terminate_timeout`**)** wynosi **30s**. Dlatego liczba **plik贸w tymczasowych**, kt贸re mog by generowane **na sekund** wynosi `100*20/30 = 66.67`.

Aby wygenerowa **10000 plik贸w**, atakujcy potrzebowaby: **`10000/66.67 = 150s`** (aby wygenerowa **100000 plik贸w** czas wyni贸sby **25min**).

Nastpnie atakujcy m贸gby u偶y tych **100 pocze** do przeprowadzenia **brute-force**. \*\*\*\* Zakadajc prdko 300 req/s, czas potrzebny do wykorzystania tego jest nastpujcy:

* 56800235584 / 10000 / 300 / 3600 \~= **5.25 godzin** (50% szans w 2.63h)
* (z 100000 plikami) 56800235584 / 100000 / 300 / 3600 \~= **0.525 godzin** (50% szans w 0.263h)

Tak, mo偶liwe jest wygenerowanie 100000 plik贸w tymczasowych na instancji redniej wielkoci EC2:

<figure><img src="../../.gitbook/assets/image (240).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Zauwa偶, 偶e aby wywoa limit czasu, wystarczy **wczy podatn stron LFI**, aby wesza w wieczn ptl doczania.
{% endhint %}

## Nginx

Wyglda na to, 偶e domylnie Nginx obsuguje **512 r贸wnolegych pocze** w tym samym czasie (a ta liczba mo偶e by poprawiona).

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
