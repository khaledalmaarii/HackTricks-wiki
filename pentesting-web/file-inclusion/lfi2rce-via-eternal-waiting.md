# LFI2RCE via Eternal waiting

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Podrazumevano, kada se fajl otpremi na PHP (캜ak i ako to ne o캜ekuje), generisa캖e privremeni fajl u `/tmp` sa imenom kao 코to je **`php[a-zA-Z0-9]{6}`**, iako sam video neke docker slike gde generisani fajlovi ne sadr쬰 cifre.

U slu캜aju lokalne inkluzije fajla, **ako uspete da uklju캜ite taj otpremljeni fajl, dobi캖ete RCE**.

Napomena: podrazumevano **PHP dozvoljava otpremanje samo 20 fajlova u jednoj zahtev** (postavljeno u `/etc/php/<version>/apache2/php.ini`):
```
; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20
```
Tako캠e, **broj potencijalnih imena datoteka je 62\*62\*62\*62\*62\*62 = 56800235584**

### Druge tehnike

Druge tehnike se oslanjaju na napad PHP protokola (ne캖ete mo캖i ako kontroli코ete samo poslednji deo putanje), otkrivanje putanje datoteke, zloupotrebu o캜ekivanih datoteka, ili **uzrokovanje segmentacione gre코ke u PHP-u tako da otpremljene privremene datoteke nisu obrisane**.\
Ova tehnika je **veoma sli캜na prethodnoj, ali bez potrebe da se prona캠e zero day**.

### Tehnika ve캜nog 캜ekanja

U ovoj tehnici **samo treba da kontroli코emo relativnu putanju**. Ako uspemo da otpremimo datoteke i u캜inimo da **LFI nikada ne zavr코i**, ima캖emo "dovoljno vremena" da **brute-force-ujemo otpremljene datoteke** i **prona캠emo** bilo koju od njih.

**Prednosti ove tehnike**:

* Samo treba da kontroli코ete relativnu putanju unutar include
* Ne zahteva nginx ili neo캜ekivani nivo pristupa log datotekama
* Ne zahteva 0 day da izazove segmentacionu gre코ku
* Ne zahteva otkrivanje putanje

**Glavni problemi** ove tehnike su:

* Potrebna je specifi캜na datoteka(e) da budu prisutne (mo쬰 ih biti vi코e)
* **Luda** koli캜ina potencijalnih imena datoteka: **56800235584**
* Ako server **ne koristi cifre**, ukupna potencijalna koli캜ina je: **19770609664**
* Po defaultu **samo 20 datoteka** mo쬰 biti otpremljeno u **jednom zahtevu**.
* **Maksimalan broj paralelnih radnika** kori코캖enog servera.
* Ova ograni캜enja sa prethodnim mogu u캜initi da ovaj napad traje predugo
* **Timeout za PHP zahtev**. Idealno bi trebalo da bude ve캜an ili da ubije PHP proces bez brisanja privremeno otpremljenih datoteka, ina캜e 캖e to tako캠e biti problem

Dakle, kako mo쬰te **u캜initi da PHP include nikada ne zavr코i**? Samo uklju캜ivanjem datoteke **`/sys/kernel/security/apparmor/revision`** (**na쬬lost, nije dostupna u Docker kontejnerima...**).

Poku코ajte jednostavno pozivaju캖i:
```bash
php -a # open php cli
include("/sys/kernel/security/apparmor/revision");
```
## Apache2

Podrazumevano, Apache podr쬬va **150 paralelnih konekcija**, prema [https://ubiq.co/tech-blog/increase-max-connections-apache/](https://ubiq.co/tech-blog/increase-max-connections-apache/) mogu캖e je pove캖ati ovaj broj do 8000. Pratite ovo da biste koristili PHP sa tim modulom: [https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04).

Podrazumevano, (kako mogu da vidim u svojim testovima), **PHP proces mo쬰 trajati ve캜no**.

Hajde da uradimo malo matematike:

* Mo쬰mo koristiti **149 konekcija** da generi코emo **149 \* 20 = 2980 temp fajlova** sa na코im webshell-om.
* Zatim, koristimo **poslednju konekciju** da **brute-force** potencijalne fajlove.
* Pri brzini od **10 zahteva/s** vreme je:
* 56800235584 / 2980 / 10 / 3600 \~= **530 sati** (50% 코anse u 265h)
* (bez cifara) 19770609664 / 2980 / 10 / 3600 \~= 185h (50% 코anse u 93h)

{% hint style="warning" %}
Imajte na umu da u prethodnom primeru **potpuno DoS-ujemo druge klijente**!
{% endhint %}

Ako je Apache server unapre캠en i mogli bismo da zloupotrebimo **4000 konekcija** (na pola puta do maksimalnog broja). Mogli bismo da kreiramo `3999*20 = 79980` **fajlova** i **broj** bi bio **smanjen** na oko **19.7h** ili **6.9h** (10h, 3.5h 50% 코anse).

## PHP-FMP

Ako umesto kori코캖enja regularnog php modula za apache za pokretanje PHP skripti **web stranica koristi** **PHP-FMP** (to pobolj코ava efikasnost web stranice, tako da je uobi캜ajeno na캖i ga), postoji ne코to drugo 코to se mo쬰 u캜initi da se pobolj코a tehnika.

PHP-FMP omogu캖ava da se **konfiguri코e** **parametar** **`request_terminate_timeout`** u **`/etc/php/<php-version>/fpm/pool.d/www.conf`**.\
Ovaj parametar ozna캜ava maksimalan broj sekundi **kada** **zahtev za PHP mora da se zavr코i** (beskona캜no podrazumevano, ali **30s ako je parametar otkomentarisano**). Kada se zahtev obra캠uje od strane PHP-a, ozna캜eni broj sekundi, on se **ubija**. To zna캜i da, ako je zahtev u캜itavao privremene fajlove, zato 코to je **php obrada prekinuta**, ti **fajlovi ne캖e biti obrisani**. Stoga, ako mo쬰te da napravite zahtev koji traje to vreme, mo쬰te **generisati hiljade privremenih fajlova** koji ne캖e biti obrisani, 코to 캖e **ubrati proces pronala쬰nja njih** i smanjiti verovatno캖u DoS-a na platformi tro코e캖i sve konekcije.

Dakle, da bismo **izbegli DoS**, pretpostavimo da **napada캜 koristi samo 100 konekcija** u isto vreme i maksimalno vreme obrade php-a od strane **php-fmp** (`request_terminate_timeout`**)** je **30s**. Stoga, broj **temp fajlova** koji se mo쬰 generisati **po sekundi** je `100*20/30 = 66.67`.

Zatim, da generi코e **10000 fajlova** napada캜 bi trebao: **`10000/66.67 = 150s`** (da generi코e **100000 fajlova** vreme bi bilo **25min**).

Zatim, napada캜 bi mogao koristiti tih **100 konekcija** da izvr코i **pretragu brute-force**. \*\*\*\* Pretpostavljaju캖i brzinu od 300 req/s vreme potrebno za eksploataciju je slede캖e:

* 56800235584 / 10000 / 300 / 3600 \~= **5.25 sati** (50% 코anse u 2.63h)
* (sa 100000 fajlova) 56800235584 / 100000 / 300 / 3600 \~= **0.525 sati** (50% 코anse u 0.263h)

Da, mogu캖e je generisati 100000 privremenih fajlova na EC2 srednjoj instanci:

<figure><img src="../../.gitbook/assets/image (240).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Imajte na umu da bi za aktiviranje vremenskog ograni캜enja bilo **dovoljno uklju캜iti ranjivu LFI stranicu**, tako da u캠e u ve캜nu petlju uklju캜ivanja.
{% endhint %}

## Nginx

Izgleda da podrazumevano Nginx podr쬬va **512 paralelnih konekcija** u isto vreme (i ovaj broj se mo쬰 pobolj코ati).

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
