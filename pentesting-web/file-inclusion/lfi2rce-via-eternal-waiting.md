# LFI2RCE via Eternal waiting

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

VarsayÄ±lan olarak, bir dosya PHP'ye yÃ¼klendiÄŸinde (beklemese bile), **`php[a-zA-Z0-9]{6}`** gibi bir isimle `/tmp` dizininde geÃ§ici bir dosya oluÅŸturur, ancak bazÄ± docker imajlarÄ±nda oluÅŸturulan dosyalarÄ±n rakam iÃ§ermediÄŸini gÃ¶rdÃ¼m.

Yerel dosya dahil etmede, **o yÃ¼klenen dosyayÄ± dahil etmeyi baÅŸarÄ±rsanÄ±z, RCE elde edersiniz**.

VarsayÄ±lan olarak, **PHP yalnÄ±zca tek bir istekte 20 dosya yÃ¼klemeye izin verir** (bu ayar `/etc/php/<version>/apache2/php.ini` dosyasÄ±nda yapÄ±lmÄ±ÅŸtÄ±r):
```
; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20
```
AyrÄ±ca, **potansiyel dosya adlarÄ±nÄ±n sayÄ±sÄ± 62\*62\*62\*62\*62\*62 = 56800235584**

### DiÄŸer teknikler

DiÄŸer teknikler, PHP protokollerine saldÄ±rmayÄ±, dosyanÄ±n yolunu ifÅŸa etmeyi, beklenen dosyalarÄ± kÃ¶tÃ¼ye kullanmayÄ± veya **yÃ¼klenen geÃ§ici dosyalarÄ±n silinmemesi iÃ§in PHP'nin bir segmentasyon hatasÄ± yaÅŸamasÄ±nÄ± saÄŸlamayÄ±** iÃ§erir.\
Bu teknik, **sÄ±fÄ±r gÃ¼n bulmaya gerek kalmadan** sonuncusuna **Ã§ok benzer**.

### Sonsuz bekleme tekniÄŸi

Bu teknikte **sadece bir gÃ¶reli yolu kontrol etmemiz gerekiyor**. DosyalarÄ± yÃ¼klemeyi baÅŸarabilir ve **LFI'nin asla bitmemesini** saÄŸlayabilirsek, **yÃ¼klenen dosyalarÄ± brute-force** yapacak ve **yÃ¼klenenlerden herhangi birini bulmak iÃ§in "yeterince zaman"** elde edeceÄŸiz.

**Bu tekniÄŸin avantajlarÄ±**:

* Sadece bir include iÃ§inde bir gÃ¶reli yolu kontrol etmeniz gerekiyor
* Nginx veya log dosyalarÄ±na beklenmedik bir eriÅŸim seviyesi gerektirmiyor
* Segmentasyon hatasÄ± oluÅŸturmak iÃ§in bir 0 gÃ¼n gerektirmiyor
* Yol ifÅŸasÄ± gerektirmiyor

Bu tekniÄŸin **ana sorunlarÄ±** ÅŸunlardÄ±r:

* Belirli bir dosya(lar)Ä±n mevcut olmasÄ±nÄ± gerektirir (daha fazlasÄ± olabilir)
* **Ã‡Ä±lgÄ±n** miktarda potansiyel dosya adÄ±: **56800235584**
* Sunucu **rakam kullanmÄ±yorsa** toplam potansiyel miktar: **19770609664**
* VarsayÄ±lan olarak **tek bir istekte yalnÄ±zca 20 dosya** yÃ¼klenebilir.
* KullanÄ±lan sunucunun **maksimum paralel iÅŸÃ§i sayÄ±sÄ±**.
* Bu limit, Ã¶nceki limitlerle birlikte bu saldÄ±rÄ±nÄ±n Ã§ok uzun sÃ¼rmesine neden olabilir
* **PHP isteÄŸi iÃ§in zaman aÅŸÄ±mÄ±**. Ä°deal olarak bu sonsuz olmalÄ± veya geÃ§ici yÃ¼klenen dosyalarÄ± silmeden PHP sÃ¼recini Ã¶ldÃ¼rmelidir, aksi takdirde bu da bir sorun olacaktÄ±r

Peki, **PHP include'Ä±nÄ± asla nasÄ±l bitirebilirsiniz**? Sadece dosyayÄ± **`/sys/kernel/security/apparmor/revision`** dahil ederek (**maalesef Docker konteynerlerinde mevcut deÄŸil...**).

Bunu sadece arayarak deneyin:
```bash
php -a # open php cli
include("/sys/kernel/security/apparmor/revision");
```
## Apache2

VarsayÄ±lan olarak, Apache **150 eÅŸzamanlÄ± baÄŸlantÄ±yÄ±** destekler, [https://ubiq.co/tech-blog/increase-max-connections-apache/](https://ubiq.co/tech-blog/increase-max-connections-apache/) adresine gÃ¶re bu sayÄ± **8000**'e kadar artÄ±rÄ±labilir. Bu modÃ¼l ile PHP kullanmak iÃ§in ÅŸunu takip edin: [https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04).

VarsayÄ±lan olarak, (testlerimde gÃ¶rdÃ¼ÄŸÃ¼m kadarÄ±yla), bir **PHP sÃ¼reci sonsuza kadar sÃ¼rebilir**.

Hesap yapalÄ±m:

* **149 baÄŸlantÄ±yÄ±** kullanarak **149 \* 20 = 2980 geÃ§ici dosya** oluÅŸturabiliriz.
* Sonra, **son baÄŸlantÄ±yÄ±** potansiyel dosyalarÄ± **brute-force** iÃ§in kullanÄ±n.
* **10 istek/s** hÄ±zÄ±nda sÃ¼reler:
* 56800235584 / 2980 / 10 / 3600 \~= **530 saat** (265 saat iÃ§inde %50 ÅŸans)
* (rakam olmadan) 19770609664 / 2980 / 10 / 3600 \~= 185 saat (93 saat iÃ§inde %50 ÅŸans)

{% hint style="warning" %}
Ã–nceki Ã¶rnekte **diÄŸer istemcileri tamamen DoS'ladÄ±ÄŸÄ±mÄ±zÄ±** unutmayÄ±n!
{% endhint %}

EÄŸer Apache sunucusu geliÅŸtirilirse ve **4000 baÄŸlantÄ±yÄ±** kÃ¶tÃ¼ye kullanabilirsek (maksimum sayÄ±ya yarÄ± yol). `3999*20 = 79980` **dosya** oluÅŸturabiliriz ve **sayÄ±** yaklaÅŸÄ±k **19.7 saat** veya **6.9 saat** (10 saat, 3.5 saat %50 ÅŸans) olarak **azalÄ±r**.

## PHP-FMP

EÄŸer PHP betiklerini Ã§alÄ±ÅŸtÄ±rmak iÃ§in Apache iÃ§in standart php modunu kullanmak yerine **web sayfasÄ±** **PHP-FMP** kullanÄ±yorsa (bu, web sayfasÄ±nÄ±n verimliliÄŸini artÄ±rÄ±r, bu yÃ¼zden sÄ±kÃ§a bulunur), tekniÄŸi geliÅŸtirmek iÃ§in baÅŸka bir ÅŸey yapÄ±labilir.

PHP-FMP, **`/etc/php/<php-version>/fpm/pool.d/www.conf`** dosyasÄ±nda **`request_terminate_timeout`** **parametresini** **ayarlar**.\
Bu parametre, **PHP'ye yapÄ±lan isteÄŸin ne zaman sona ereceÄŸini** belirten maksimum saniye sayÄ±sÄ±nÄ± gÃ¶sterir (varsayÄ±lan olarak sonsuzdur, ancak **parametre yorum satÄ±rÄ±ndan Ã§Ä±karÄ±ldÄ±ÄŸÄ±nda 30 saniye** olur). PHP tarafÄ±ndan iÅŸlenen bir isteÄŸin belirtilen saniye sayÄ±sÄ± dolduÄŸunda, **Ã¶ldÃ¼rÃ¼lÃ¼r**. Bu, eÄŸer istek geÃ§ici dosyalar yÃ¼klÃ¼yorsa, **php iÅŸlemesi durdurulduÄŸu iÃ§in**, o **dosyalarÄ±n silinmeyeceÄŸi** anlamÄ±na gelir. Bu nedenle, bir isteÄŸin o sÃ¼re boyunca sÃ¼rmesini saÄŸlarsanÄ±z, **silinmeyecek binlerce geÃ§ici dosya** oluÅŸturabilirsiniz, bu da **bulma sÃ¼recini hÄ±zlandÄ±rÄ±r** ve platforma tÃ¼m baÄŸlantÄ±larÄ± tÃ¼keterek DoS olasÄ±lÄ±ÄŸÄ±nÄ± azaltÄ±r.

Bu nedenle, **DoS'tan kaÃ§Ä±nmak iÃ§in** bir **saldÄ±rganÄ±n aynÄ± anda yalnÄ±zca 100 baÄŸlantÄ± kullanacaÄŸÄ±nÄ±** varsayalÄ±m ve php max iÅŸleme sÃ¼resi **php-fmp** (`request_terminate_timeout`**)** **30 saniye**. Bu nedenle, **saniyede** oluÅŸturulabilecek **geÃ§ici dosya** sayÄ±sÄ± `100*20/30 = 66.67`'dir.

Sonra, **10000 dosya** oluÅŸturmak iÃ§in bir saldÄ±rganÄ±n ihtiyacÄ± olacak: **`10000/66.67 = 150s`** ( **100000 dosya** oluÅŸturmak iÃ§in sÃ¼re **25 dakika** olacaktÄ±r).

Sonra, saldÄ±rgan bu **100 baÄŸlantÄ±yÄ±** bir **arama brute-force** gerÃ§ekleÅŸtirmek iÃ§in kullanabilir. \*\*\*\* 300 req/s hÄ±zÄ±nda bu durumu istismar etmek iÃ§in gereken sÃ¼re ÅŸudur:

* 56800235584 / 10000 / 300 / 3600 \~= **5.25 saat** (2.63 saat iÃ§inde %50 ÅŸans)
* (100000 dosya ile) 56800235584 / 100000 / 300 / 3600 \~= **0.525 saat** (0.263 saat iÃ§inde %50 ÅŸans)

Evet, bir EC2 orta boyutlu Ã¶rneÄŸinde 100000 geÃ§ici dosya oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r:

<figure><img src="../../.gitbook/assets/image (240).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Zaman aÅŸÄ±mÄ±nÄ± tetiklemek iÃ§in **aÃ§Ä±kÃ§a savunmasÄ±z LFI sayfasÄ±nÄ± dahil etmek yeterli olacaktÄ±r**, bÃ¶ylece sonsuz bir dahil etme dÃ¶ngÃ¼sÃ¼ne girer.
{% endhint %}

## Nginx

GÃ¶rÃ¼nÃ¼ÅŸe gÃ¶re varsayÄ±lan olarak Nginx **512 paralel baÄŸlantÄ±yÄ±** aynÄ± anda destekler (ve bu sayÄ± artÄ±rÄ±labilir).

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.**

</details>
{% endhint %}
