# Aktualizacja Przemytu Nag贸wk贸w

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### Przemyt H2C <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 nad Czystym Tekstem (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, czyli **http2 nad czystym tekstem**, odbiega od normy tymczasowych pocze HTTP, aktualizujc standardowe poczenie HTTP **do trwaego**. To zaktualizowane poczenie wykorzystuje binarny protok贸 http2 do cigej komunikacji, w przeciwiestwie do jednorazowego charakteru plaintext HTTP.

Rdze problemu przemytu pojawia si przy u偶yciu **serwera proxy odwrotnego**. Zazwyczaj serwer proxy odwraca i przekazuje 偶dania HTTP do backendu, zwracajc odpowied藕 backendu po tym. Jednak gdy nag贸wek `Connection: Upgrade` jest obecny w 偶daniu HTTP (czsto widoczny w poczeniach websocket), serwer **proxy utrzymuje trwae poczenie** midzy klientem a serwerem, uatwiajc cig wymian wymagan przez pewne protokoy. Dla pocze H2C, zgodno z RFC wymaga obecnoci trzech konkretnych nag贸wk贸w:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
# Wykorzystanie H2C Smuggling <a href="#exploitation" id="exploitation"></a>

Podatno pojawia si, gdy po zaktualizowaniu poczenia, odwrotny proxy przestaje zarzdza poszczeg贸lnymi 偶daniami, zakadajc, 偶e jego zadanie routingu jest zakoczone po ustanowieniu poczenia. Wykorzystanie H2C Smuggling pozwala na obejcie regu odwrotnego proxy stosowanych podczas przetwarzania 偶dania, takich jak routowanie oparte na cie偶ce, uwierzytelnianie i przetwarzanie WAF, zakadajc, 偶e poczenie H2C zostao pomylnie zainicjowane.

#### Nara偶one Proksy <a href="#exploitation" id="exploitation"></a>

Podatno zale偶y od obsugi przez odwrotne proxy nag贸wk贸w `Upgrade` i czasami `Connection`. Nastpujce proksy z natury przekazuj te nag贸wki podczas przekazywania proxy-pass, co z natury umo偶liwia H2C smuggling:

* HAProxy
* Traefik
* Nuster

Z kolei te usugi z natury nie przekazuj obu nag贸wk贸w podczas przekazywania proxy-pass. Jednak偶e mog by skonfigurowane w spos贸b niebezpieczny, umo偶liwiajc niefiltrowane przekazywanie nag贸wk贸w `Upgrade` i `Connection`:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### Wykorzystanie <a href="#exploitation" id="exploitation"></a>

Nale偶y zauwa偶y, 偶e nie wszystkie serwery z natury przekazuj nag贸wki wymagane do zgodnej aktualizacji poczenia H2C. Dlatego serwery takie jak AWS ALB/CLB, NGINX i Apache Traffic Server, midzy innymi, naturalnie blokuj poczenia H2C. Niemniej jednak warto przetestowa z niezgodn wersj `Connection: Upgrade`, kt贸ra wyklucza warto `HTTP2-Settings` z nag贸wka `Connection`, poniewa偶 niekt贸re backendy mog nie by zgodne ze standardami.

{% hint style="danger" %}
Niezale偶nie od okrelonej **cie偶ki** w adresie URL `proxy_pass` (np. `http://backend:9999/socket.io`), ustanowione poczenie domylnie przekierowuje do `http://backend:9999`. Pozwala to na interakcj z dowoln cie偶k wewntrz tego wewntrznego punktu kocowego, wykorzystujc t technik. W rezultacie okrelenie cie偶ki w adresie URL `proxy_pass` nie ogranicza dostpu.
{% endhint %}

Narzdzia [**h2csmuggler od BishopFox**](https://github.com/BishopFox/h2csmuggler) i [**h2csmuggler od assetnote**](https://github.com/assetnote/h2csmuggler) uatwiaj pr贸by **obejcia narzuconych przez proxy zabezpiecze** poprzez ustanowienie poczenia H2C, umo偶liwiajc dostp do zasob贸w zabezpieczonych przez proxy.

Aby uzyska dodatkowe informacje na temat tej podatnoci, szczeg贸lnie dotyczce NGINX, zapoznaj si z [**tym szczeg贸owym 藕r贸dem**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Websocket smuggling, w przeciwiestwie do tworzenia tunelu HTTP2 do punktu kocowego dostpnego za porednictwem proxy, ustanawia tunel Websocket w celu obejcia potencjalnych ogranicze proxy i uatwienia bezporedniej komunikacji z punktem kocowym.

### Scenariusz 1

W tym scenariuszu zoliwy klient, kt贸ry d偶y do uzyskania dostpu do wewntrznego REST API, celuje w backend oferujcy publiczne API Websocket obok niedostpnego wewntrznego REST API. Atak przebiega w kilku krokach:

1. Klient rozpoczyna wysyajc 偶danie Upgrade do odwrotnego proxy z nieprawidow wersj protokou `Sec-WebSocket-Version` w nag贸wku. Proxy, nie sprawdzajc nag贸wka `Sec-WebSocket-Version`, uznaje 偶danie Upgrade za wa偶ne i przekazuje je do backendu.
2. Backend odpowiada kodem stanu `426`, wskazujc nieprawidow wersj protokou w nag贸wku `Sec-WebSocket-Version`. Odwrotne proxy, pomijajc status odpowiedzi backendu, zakada gotowo do komunikacji Websocket i przekazuje odpowied藕 klientowi.
3. W rezultacie odwrotne proxy zostaje wprowadzone w bd, uznajc, 偶e zostao ustanowione poczenie Websocket midzy klientem a backendem, podczas gdy w rzeczywistoci backend odrzuci 偶danie Upgrade. Mimo to, proxy utrzymuje otwarte poczenie TCP lub TLS midzy klientem a backendem, umo偶liwiajc klientowi nieograniczony dostp do prywatnego REST API poprzez to poczenie.

Nara偶one odwrotne proksy obejmuj Varnish, kt贸ry odm贸wi rozwizania problemu, oraz odwrotne proxy Envoy w wersji 1.8.0 lub starszej, przy czym p贸藕niejsze wersje zmieniy mechanizm aktualizacji. Inne proksy mog r贸wnie偶 by podatne.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Scenariusz 2

Ten scenariusz dotyczy backendu posiadajcego zar贸wno publiczne API Websocket, jak i publiczne API REST do sprawdzania stanu zdrowia, obok niedostpnego wewntrznego REST API. Atak, bardziej zo偶ony, obejmuje nastpujce kroki:

1. Klient wysya 偶danie POST, aby uruchomi API sprawdzania stanu zdrowia, zawierajc dodatkowy nag贸wek HTTP `Upgrade: websocket`. NGINX, dziaajcy jako odwrotne proxy, interpretuje to jako standardowe 偶danie Upgrade oparte wycznie na nag贸wku `Upgrade`, pomijajc inne aspekty 偶dania, i przekazuje je do backendu.
2. Backend wykonuje API sprawdzania stanu zdrowia, sigajc do zewntrznego zasobu kontrolowanego przez atakujcego, kt贸ry zwraca odpowied藕 HTTP ze statusem `101`. Ta odpowied藕, po otrzymaniu przez backend i przekazaniu do NGINX, wprowadza proxy w bd, sugerujc ustanowienie poczenia Websocket ze wzgldu na walidacj tylko statusu odpowiedzi.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Ostrze偶enie:** Zo偶ono tej techniki wzrasta, poniewa偶 wymaga zdolnoci do interakcji z punktem kocowym zdolnym do zwr贸cenia statusu 101.

Ostatecznie NGINX zostaje oszukany, 偶e istnieje poczenie Websocket midzy klientem a backendem. W rzeczywistoci takie poczenie nie istnieje; celem byo API REST sprawdzania stanu zdrowia. Niemniej jednak odwrotne proxy utrzymuje otwarte poczenie, umo偶liwiajc klientowi dostp do prywatnego REST API poprzez nie.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

Wikszo odwrotnych proks贸w jest podatna na ten scenariusz, ale wykorzystanie zale偶y od obecnoci zewntrznej podatnoci SSRF, zazwyczaj uwa偶anej za problem o niskim stopniu zagro偶enia.

#### Laboratoria

Sprawd藕 laboratoria, aby przetestowa oba scenariusze na [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### Referencje

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
