# Upgrade Header Smuggling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 Over Cleartext (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, czyli **http2 over cleartext**, odbiega od normy przejrzystych pocze HTTP, aktualizujc standardowe poczenie HTTP **do poczenia trwaego**. To zaktualizowane poczenie wykorzystuje binarny protok贸 http2 do bie偶cej komunikacji, w przeciwiestwie do jednorazowego charakteru tekstowego HTTP.

Sedno problemu z smugglingiem pojawia si przy u偶yciu **reverse proxy**. Zwykle reverse proxy przetwarza i przekazuje 偶dania HTTP do backendu, zwracajc odpowied藕 backendu po tym. Jednak gdy nag贸wek `Connection: Upgrade` jest obecny w 偶daniu HTTP (czsto spotykanym w poczeniach websocket), reverse **proxy utrzymuje trwae poczenie** midzy klientem a serwerem, uatwiajc cig wymian wymagan przez niekt贸re protokoy. Dla pocze H2C przestrzeganie RFC wymaga obecnoci trzech specyficznych nag贸wk贸w:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Wra偶liwo pojawia si, gdy po zaktualizowaniu poczenia, odwrotny proxy przestaje zarzdza poszczeg贸lnymi 偶daniami, zakadajc, 偶e jego zadanie routingu jest zakoczone po nawizaniu poczenia. Wykorzystanie H2C Smuggling pozwala na obejcie zasad odwrotnego proxy stosowanych podczas przetwarzania 偶da, takich jak routing oparty na cie偶kach, uwierzytelnianie i przetwarzanie WAF, zakadajc, 偶e poczenie H2C zostao pomylnie nawizane.

#### Wra偶liwe proxy <a href="#exploitation" id="exploitation"></a>

Wra偶liwo zale偶y od obsugi przez odwrotny proxy nag贸wk贸w `Upgrade` i czasami `Connection`. Nastpujce proxy z natury przekazuj te nag贸wki podczas proxy-pass, co z natury umo偶liwia H2C smuggling:

* HAProxy
* Traefik
* Nuster

Z drugiej strony, te usugi nie przekazuj z natury obu nag贸wk贸w podczas proxy-pass. Mog jednak by skonfigurowane w spos贸b niebezpieczny, co pozwala na nieprzefiltrowane przekazywanie nag贸wk贸w `Upgrade` i `Connection`:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### Wykorzystanie <a href="#exploitation" id="exploitation"></a>

Wa偶ne jest, aby zauwa偶y, 偶e nie wszystkie serwery z natury przekazuj nag贸wki wymagane do zgodnej aktualizacji poczenia H2C. W zwizku z tym serwery takie jak AWS ALB/CLB, NGINX i Apache Traffic Server, midzy innymi, naturalnie blokuj poczenia H2C. Niemniej jednak warto przetestowa niezgodn wersj `Connection: Upgrade`, kt贸ra wyklucza warto `HTTP2-Settings` z nag贸wka `Connection`, poniewa偶 niekt贸re backendy mog nie przestrzega standard贸w.

{% hint style="danger" %}
Niezale偶nie od konkretnej **cie偶ki** wyznaczonej w URL `proxy_pass` (np. `http://backend:9999/socket.io`), nawizane poczenie domylnie odnosi si do `http://backend:9999`. Umo偶liwia to interakcj z dowoln cie偶k w tym wewntrznym punkcie kocowym, wykorzystujc t technik. W zwizku z tym okrelenie cie偶ki w URL `proxy_pass` nie ogranicza dostpu.
{% endhint %}

Narzdzia [**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) i [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) uatwiaj pr贸by **obejcia zabezpiecze nao偶onych przez proxy** poprzez nawizanie poczenia H2C, co umo偶liwia dostp do zasob贸w chronionych przez proxy.

Aby uzyska dodatkowe informacje na temat tej wra偶liwoci, szczeg贸lnie w odniesieniu do NGINX, zapoznaj si z [**tym szczeg贸owym zasobem**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Websocket smuggling, w przeciwiestwie do tworzenia tunelu HTTP2 do punktu kocowego dostpnego przez proxy, ustanawia tunel Websocket, aby obej potencjalne ograniczenia proxy i umo偶liwi bezporedni komunikacj z punktem kocowym.

### Scenariusz 1

W tym scenariuszu atakowany jest backend, kt贸ry oferuje publiczne API WebSocket obok niedostpnego wewntrznego API REST. Atak przebiega w kilku krokach:

1. Klient inicjuje, wysyajc 偶danie Upgrade do odwrotnego proxy z nieprawidow wersj protokou `Sec-WebSocket-Version` w nag贸wku. Proxy, nie weryfikujc nag贸wka `Sec-WebSocket-Version`, uwa偶a 偶danie Upgrade za wa偶ne i przekazuje je do backendu.
2. Backend odpowiada kodem statusu `426`, wskazujc na nieprawidow wersj protokou w nag贸wku `Sec-WebSocket-Version`. Odwrotny proxy, pomijajc status odpowiedzi backendu, zakada gotowo do komunikacji WebSocket i przekazuje odpowied藕 do klienta.
3. W konsekwencji odwrotny proxy jest wprowadzany w bd, wierzc, 偶e nawizano poczenie WebSocket midzy klientem a backendem, podczas gdy w rzeczywistoci backend odrzuci 偶danie Upgrade. Mimo to proxy utrzymuje otwarte poczenie TCP lub TLS midzy klientem a backendem, co pozwala klientowi na nieograniczony dostp do prywatnego API REST przez to poczenie.

Dotknite odwrotne proxy obejmuj Varnish, kt贸ry odm贸wi rozwizania problemu, oraz wersj proxy Envoy 1.8.0 lub starsz, przy czym nowsze wersje zmieniy mechanizm aktualizacji. Inne proxy mog by r贸wnie偶 podatne.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Scenariusz 2

Ten scenariusz dotyczy backendu z publicznym API WebSocket oraz publicznym API REST do sprawdzania stanu, a tak偶e niedostpnego wewntrznego API REST. Atak, bardziej zo偶ony, obejmuje nastpujce kroki:

1. Klient wysya 偶danie POST, aby uruchomi API sprawdzania stanu, w tym dodatkowy nag贸wek HTTP `Upgrade: websocket`. NGINX, dziaajcy jako odwrotny proxy, interpretuje to jako standardowe 偶danie Upgrade wycznie na podstawie nag贸wka `Upgrade`, zaniedbujc inne aspekty 偶dania, i przekazuje je do backendu.
2. Backend wykonuje API sprawdzania stanu, kontaktujc si z zewntrznym zasobem kontrolowanym przez atakujcego, kt贸ry zwraca odpowied藕 HTTP z kodem statusu `101`. Ta odpowied藕, po odebraniu przez backend i przekazaniu do NGINX, wprowadza proxy w bd, mylc, 偶e nawizano poczenie WebSocket z powodu jego weryfikacji tylko na podstawie kodu statusu.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Ostrze偶enie:** Zo偶ono tej techniki wzrasta, poniewa偶 wymaga mo偶liwoci interakcji z punktem kocowym zdolnym do zwr贸cenia kodu statusu 101.

Ostatecznie NGINX jest wprowadzany w bd, wierzc, 偶e istnieje poczenie WebSocket midzy klientem a backendem. W rzeczywistoci takie poczenie nie istnieje; celem byo API REST sprawdzania stanu. Niemniej jednak odwrotny proxy utrzymuje poczenie otwarte, umo偶liwiajc klientowi dostp do prywatnego API REST przez nie.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

Wikszo odwrotnych proxy jest podatna na ten scenariusz, ale wykorzystanie zale偶y od obecnoci zewntrznej podatnoci SSRF, zazwyczaj uwa偶anej za problem o niskim ci偶arze.

#### Laboratoria

Sprawd藕 laboratoria, aby przetestowa oba scenariusze w [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### Odniesienia

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
