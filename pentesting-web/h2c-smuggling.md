# YÃ¼kseltme BaÅŸlÄ±ÄŸÄ± KaÃ§akÃ§Ä±lÄ±ÄŸÄ±

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na gÃ¶z atÄ±n (https://github.com/sponsors/carlospolop)!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

**Try Hard GÃ¼venlik Grubu**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

### H2C KaÃ§akÃ§Ä±lÄ±ÄŸÄ± <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### AÃ§Ä±k Metin Ãœzerinden HTTP2 (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C veya **aÃ§Ä±k metin Ã¼zerinden http2**, standart bir HTTP **baÄŸlantÄ±sÄ±nÄ± kalÄ±cÄ± bir baÄŸlantÄ±ya yÃ¼kselterek** geÃ§ici HTTP baÄŸlantÄ±larÄ±nÄ±n normundan sapar. Bu yÃ¼kseltilmiÅŸ baÄŸlantÄ±, dÃ¼z metin HTTP'nin tek istek doÄŸasÄ±na karÅŸÄ± devam eden iletiÅŸim iÃ§in http2 ikili protokolÃ¼nÃ¼ kullanÄ±r.

KaÃ§akÃ§Ä±lÄ±k sorununun Ã¶zÃ¼, bir **ters proxy**'nin kullanÄ±mÄ±yla ortaya Ã§Ä±kar. Genellikle, ters proxy HTTP isteklerini iÅŸler ve arka uca ileterek, ardÄ±ndan arka uÃ§ yanÄ±tÄ±nÄ± dÃ¶ndÃ¼rÃ¼r. Ancak, bir HTTP isteÄŸinde `Connection: Upgrade` baÅŸlÄ±ÄŸÄ± bulunduÄŸunda (genellikle websocket baÄŸlantÄ±larÄ±yla gÃ¶rÃ¼lÃ¼r), ters **proxy istemci ve sunucu arasÄ±nda kalÄ±cÄ± bir baÄŸlantÄ±** sÃ¼rdÃ¼rÃ¼r, belirli protokollerin gerektirdiÄŸi sÃ¼rekli deÄŸiÅŸimi kolaylaÅŸtÄ±rÄ±r. H2C baÄŸlantÄ±larÄ± iÃ§in, RFC'ye uyum, Ã¼Ã§ belirli baÅŸlÄ±ÄŸÄ±n varlÄ±ÄŸÄ±nÄ± gerektirir:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
#### H2C Smuggling SÃ¶mÃ¼rÃ¼sÃ¼ <a href="#exploitation" id="exploitation"></a>

Zafiyet, bir baÄŸlantÄ±yÄ± yÃ¼kselttikten sonra ters vekilin, yÃ¶nlendirmenin tamamlanmasÄ±ndan sonra bireysel istekleri yÃ¶netmeyi bÄ±rakmasÄ± durumunda ortaya Ã§Ä±kar. H2C Smuggling'i sÃ¶mÃ¼rmek, baÅŸarÄ±lÄ± bir H2C baÄŸlantÄ±sÄ± baÅŸlatÄ±ldÄ±ÄŸÄ±nda, istek iÅŸleme sÄ±rasÄ±nda uygulanan ters vekil kurallarÄ±nÄ± atlamayÄ± saÄŸlar; Ã¶rneÄŸin, yol tabanlÄ± yÃ¶nlendirme, kimlik doÄŸrulama ve WAF iÅŸleme.

#### Zafiyetli Vekiller <a href="#exploitation" id="exploitation"></a>

Zafiyet, ters vekilin `Upgrade` ve bazen `Connection` baÅŸlÄ±klarÄ±nÄ± nasÄ±l iÅŸlediÄŸine baÄŸlÄ±dÄ±r. AÅŸaÄŸÄ±daki vekiller, bu baÅŸlÄ±klarÄ± varsayÄ±lan olarak iletir ve bÃ¶ylece H2C smuggling'i varsayÄ±lan olarak etkinleÅŸtirir:

* HAProxy
* Traefik
* Nuster

Ã–te yandan, aÅŸaÄŸÄ±daki hizmetler, bu baÅŸlÄ±klarÄ± varsayÄ±lan olarak iletmez. Bununla birlikte, `Upgrade` ve `Connection` baÅŸlÄ±klarÄ±nÄ±n filtresiz iletilmesine izin veren gÃ¼vensiz bir ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸ olabilirler:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### SÃ¶mÃ¼rÃ¼ <a href="#exploitation" id="exploitation"></a>

Uyumlu bir H2C baÄŸlantÄ±sÄ± yÃ¼kseltmek iÃ§in gereken baÅŸlÄ±klarÄ± varsayÄ±lan olarak ileten tÃ¼m sunucularÄ±n olmadÄ±ÄŸÄ±nÄ± belirtmek Ã¶nemlidir. Bu nedenle, AWS ALB/CLB, NGINX ve Apache Traffic Server gibi sunucular, H2C baÄŸlantÄ±larÄ±nÄ± doÄŸal olarak engeller. Bununla birlikte, bazÄ± arka uÃ§larÄ±n standartlara uymayabileceÄŸi iÃ§in, uyumsuz `Connection: Upgrade` varyantÄ± ile test etmek faydalÄ± olabilir.

{% hint style="danger" %}
`proxy_pass` URL'sinde belirtilen belirli **yol** (Ã¶rneÄŸin, `http://backend:9999/socket.io`) baÄŸlantÄ±nÄ±n varsayÄ±lan olarak `http://backend:9999` olmasÄ±na neden olur. Bu, bu tekniÄŸi kullanarak dahili uÃ§ noktadaki herhangi bir yola etkileÅŸim saÄŸlar. DolayÄ±sÄ±yla, `proxy_pass` URL'sinde bir yol belirtmek eriÅŸimi kÄ±sÄ±tlamaz.
{% endhint %}

[**BishopFox tarafÄ±ndan h2csmuggler**](https://github.com/BishopFox/h2csmuggler) ve [**assetnote tarafÄ±ndan h2csmuggler**](https://github.com/assetnote/h2csmuggler) araÃ§larÄ±, bir H2C baÄŸlantÄ±sÄ± kurarak **proxy tarafÄ±ndan uygulanan korumalarÄ± atlamaya** yÃ¶nelik giriÅŸimleri kolaylaÅŸtÄ±rÄ±r.

Bu zafiyetle ilgili ek bilgiler iÃ§in Ã¶zellikle NGINX hakkÄ±nda [**bu detaylÄ± kaynaÄŸa**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection) baÅŸvurun.

## Websocket Smuggling

Websocket smuggling, bir HTTP2 tÃ¼neli oluÅŸturmanÄ±n aksine, bir Websocket tÃ¼neli kurarak potansiyel proxy kÄ±sÄ±tlamalarÄ±nÄ± atlamayÄ± ve uca doÄŸrudan iletiÅŸimi kolaylaÅŸtÄ±rmayÄ± amaÃ§lar.

### Senaryo 1

Bu senaryoda, bir iÃ§ REST API'ye eriÅŸilemeyen bir arka uÃ§, bir kamu WebSocket API'si sunar ve kÃ¶tÃ¼ niyetli bir istemcinin iÃ§ REST API'ye eriÅŸim aradÄ±ÄŸÄ± hedeflenir. SaldÄ±rÄ± ÅŸu adÄ±mlarda gerÃ§ekleÅŸir:

1. Ä°stemci, baÅŸlÄ±kta yanlÄ±ÅŸ bir `Sec-WebSocket-Version` protokol sÃ¼rÃ¼mÃ¼ ile bir Upgrade isteÄŸi gÃ¶ndererek ters vekile baÅŸlar. Ters vekil, `Sec-WebSocket-Version` baÅŸlÄ±ÄŸÄ±nÄ± doÄŸrulayamadÄ±ÄŸÄ± iÃ§in Upgrade isteÄŸini geÃ§erli olarak kabul eder ve arka uca iletir.
2. Arka uÃ§, baÅŸlÄ±kta yanlÄ±ÅŸ protokol sÃ¼rÃ¼mÃ¼nÃ¼ belirten bir durum kodu `426` ile yanÄ±t verir. Ters vekil, arka ucun yanÄ±t durumunu gÃ¶z ardÄ± ederek WebSocket iletiÅŸimi iÃ§in hazÄ±r olduÄŸunu varsayar ve yanÄ±tÄ± istemciye iletir.
3. SonuÃ§ olarak, ters vekil, istemci ile arka uÃ§ arasÄ±nda bir WebSocket baÄŸlantÄ±sÄ± kurulmuÅŸ gibi yanÄ±ltÄ±lÄ±rken, aslÄ±nda arka uÃ§, Upgrade isteÄŸini reddetmiÅŸtir. Bununla birlikte, vekil, istemci ile arka uÃ§ arasÄ±nda aÃ§Ä±k bir TCP veya TLS baÄŸlantÄ±sÄ±nÄ± sÃ¼rdÃ¼rÃ¼r ve istemcinin bu baÄŸlantÄ± aracÄ±lÄ±ÄŸÄ±yla Ã¶zel REST API'ye kÄ±sÄ±tlamasÄ±z eriÅŸim saÄŸlamasÄ±na olanak tanÄ±r.

Etkilenen ters vekiller arasÄ±nda, sorunu ele almaktan kaÃ§Ä±nan Varnish ve Envoy proxy sÃ¼rÃ¼mÃ¼ 1.8.0 veya daha eski olanlar, daha sonraki sÃ¼rÃ¼mlerde yÃ¼kseltme mekanizmasÄ±nÄ± deÄŸiÅŸtirmiÅŸlerdir. DiÄŸer vekiller de savunmasÄ±z olabilir.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Senaryo 2

Bu senaryo, hem bir kamu WebSocket API'si hem de bir saÄŸlÄ±k kontrolÃ¼ iÃ§in bir kamu REST API'si sunan bir arka uÃ§ iÃ§erir ve bir iÃ§ REST API'ye eriÅŸilemeyen bir hedeflenir. Daha karmaÅŸÄ±k olan saldÄ±rÄ±, aÅŸaÄŸÄ±daki adÄ±mlarÄ± iÃ§erir:

1. Ä°stemci, saÄŸlÄ±k kontrol API'sini tetiklemek iÃ§in bir POST isteÄŸi gÃ¶nderirken, ek bir HTTP baÅŸlÄ±k `Upgrade: websocket` iÃ§erir. Ters vekil olarak hizmet veren NGINX, yalnÄ±zca `Upgrade` baÅŸlÄ±ÄŸÄ±na dayanarak bu isteÄŸi standart bir Upgrade isteÄŸi olarak yorumlar ve arka uca iletir.
2. Arka uÃ§, saÄŸlÄ±k kontrol API'sini yÃ¼rÃ¼tÃ¼rken, saldÄ±rgan tarafÄ±ndan kontrol edilen bir harici kaynaÄŸa ulaÅŸÄ±r ve bir HTTP yanÄ±tÄ± ile durum kodu `101` dÃ¶ndÃ¼rÃ¼r. Bu yanÄ±t, arka uÃ§ tarafÄ±ndan alÄ±ndÄ±ÄŸÄ±nda ve NGINX'e iletilirken, yalnÄ±zca durum kodunu doÄŸruladÄ±ÄŸÄ± iÃ§in vekili, bir WebSocket baÄŸlantÄ±sÄ±nÄ±n kurulduÄŸuna inandÄ±rÄ±r.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **UyarÄ±:** Bu tekniÄŸin karmaÅŸÄ±klÄ±ÄŸÄ±, genellikle dÃ¼ÅŸÃ¼k Ã¶nem derecesi olarak kabul edilen bir harici SSRF zafiyetinin varlÄ±ÄŸÄ±nÄ± gerektirir.

SonuÃ§ olarak, NGINX, istemci ile arka uÃ§ arasÄ±nda bir WebSocket baÄŸlantÄ±sÄ± olduÄŸuna inanÄ±r. AslÄ±nda bÃ¶yle bir baÄŸlantÄ± yoktur; saÄŸlÄ±k kontrol REST API'si hedef alÄ±nmÄ±ÅŸtÄ±r. Bununla birlikte, ters vekil baÄŸlantÄ±yÄ± aÃ§Ä±k tutar ve istemcinin bu aracÄ±lÄ±ÄŸÄ±yla Ã¶zel REST API'ye eriÅŸmesine olanak tanÄ±r.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

Ã‡oÄŸu ters vekil bu senaryoya karÅŸÄ± savunmasÄ±z olabilir, ancak sÃ¶mÃ¼rÃ¼, genellikle dÃ¼ÅŸÃ¼k Ã¶nem derecesi olarak kabul edilen bir harici SSRF zafiyetinin varlÄ±ÄŸÄ±na baÄŸlÄ±dÄ±r.

#### Lablar

Her iki senaryoyu test etmek iÃ§in lablara [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git) adresinden eriÅŸebilirsiniz.

### Referanslar

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)
