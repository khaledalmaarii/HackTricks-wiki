# å‡çº§å¤´éƒ¨åŠ«æŒ

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

### H2CåŠ«æŒ <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### æ˜æ–‡HTTP2ï¼ˆH2Cï¼‰ <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2Cï¼Œæˆ–**æ˜æ–‡http2**ï¼Œé€šè¿‡å°†æ ‡å‡†HTTP **è¿æ¥å‡çº§ä¸ºæŒä¹…è¿æ¥**ï¼Œåç¦»äº†çŸ­æš‚HTTPè¿æ¥çš„å¸¸è§„ã€‚è¿™ç§å‡çº§åçš„è¿æ¥åˆ©ç”¨http2äºŒè¿›åˆ¶åè®®è¿›è¡ŒæŒç»­é€šä¿¡ï¼Œè€Œä¸æ˜¯æ˜æ–‡HTTPçš„å•è¯·æ±‚æ€§è´¨ã€‚

åŠ«æŒé—®é¢˜çš„å…³é”®åœ¨äº**åå‘ä»£ç†**çš„ä½¿ç”¨ã€‚é€šå¸¸ï¼Œåå‘ä»£ç†å¤„ç†å¹¶è½¬å‘HTTPè¯·æ±‚åˆ°åç«¯ï¼Œç„¶åè¿”å›åç«¯çš„å“åº”ã€‚ç„¶è€Œï¼Œå½“HTTPè¯·æ±‚ä¸­å­˜åœ¨`Connection: Upgrade`å¤´éƒ¨ï¼ˆé€šå¸¸åœ¨websocketè¿æ¥ä¸­çœ‹åˆ°ï¼‰ï¼Œåå‘**ä»£ç†ä¼šç»´æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æŒä¹…è¿æ¥**ï¼Œä¿ƒè¿›æŸäº›åè®®æ‰€éœ€çš„æŒç»­äº¤æ¢ã€‚å¯¹äºH2Cè¿æ¥ï¼Œéµå¾ªRFCéœ€è¦å­˜åœ¨ä¸‰ä¸ªç‰¹å®šçš„å¤´éƒ¨ï¼š
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
æ¼æ´å‡ºç°åœ¨å‡çº§è¿æ¥åï¼Œåå‘ä»£ç†åœæ­¢ç®¡ç†å•ä¸ªè¯·æ±‚ï¼Œå‡è®¾å…¶è·¯ç”±å·¥ä½œåœ¨è¿æ¥å»ºç«‹åå·²å®Œæˆã€‚åˆ©ç”¨H2C Smuggling å¯ç»•è¿‡åå‘ä»£ç†åœ¨è¯·æ±‚å¤„ç†æœŸé—´åº”ç”¨çš„è§„åˆ™ï¼Œå¦‚åŸºäºè·¯å¾„çš„è·¯ç”±ã€èº«ä»½éªŒè¯å’ŒWAFå¤„ç†ï¼Œå‡è®¾æˆåŠŸå¯åŠ¨äº†H2Cè¿æ¥ã€‚

#### å—å½±å“çš„ä»£ç† <a href="#exploitation" id="exploitation"></a>

è¯¥æ¼æ´å–å†³äºåå‘ä»£ç†å¤„ç† `Upgrade` å’Œæœ‰æ—¶ `Connection` å¤´çš„æ–¹å¼ã€‚ä»¥ä¸‹ä»£ç†åœ¨ä»£ç†ä¼ é€’æœŸé—´å›ºæœ‰åœ°è½¬å‘è¿™äº›å¤´ï¼Œä»è€Œå›ºæœ‰åœ°å¯ç”¨ H2C smugglingï¼š

* HAProxy
* Traefik
* Nuster

ç›¸åï¼Œè¿™äº›æœåŠ¡åœ¨ä»£ç†ä¼ é€’æœŸé—´ä¸å›ºæœ‰åœ°è½¬å‘è¿™ä¸¤ä¸ªå¤´ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬å¯èƒ½é…ç½®ä¸å®‰å…¨ï¼Œå…è®¸æœªç»è¿‡æ»¤åœ°è½¬å‘ `Upgrade` å’Œ `Connection` å¤´ï¼š

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### åˆ©ç”¨ <a href="#exploitation" id="exploitation"></a>

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰æœåŠ¡å™¨å›ºæœ‰åœ°è½¬å‘ç”¨äºç¬¦åˆ H2C è¿æ¥å‡çº§æ‰€éœ€çš„å¤´ã€‚å› æ­¤ï¼Œåƒ AWS ALB/CLBã€NGINX å’Œ Apache Traffic Server ç­‰æœåŠ¡å™¨è‡ªç„¶åœ°é˜»æ­¢ H2C è¿æ¥ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå€¼å¾—å°è¯•ä½¿ç”¨ä¸ç¬¦åˆæ ‡å‡†çš„ `Connection: Upgrade` å˜ä½“è¿›è¡Œæµ‹è¯•ï¼Œè¯¥å˜ä½“åœ¨ `Connection` å¤´ä¸­æ’é™¤äº† `HTTP2-Settings` å€¼ï¼Œå› ä¸ºä¸€äº›åç«¯å¯èƒ½ä¸ç¬¦åˆæ ‡å‡†ã€‚

{% hint style="danger" %}
æ— è®ºåœ¨ `proxy_pass` URL ä¸­æŒ‡å®šçš„å…·ä½“ **è·¯å¾„** æ˜¯ä»€ä¹ˆï¼ˆä¾‹å¦‚ `http://backend:9999/socket.io`ï¼‰ï¼Œå»ºç«‹çš„è¿æ¥é»˜è®¤ä¸º `http://backend:9999`ã€‚è¿™å…è®¸ä¸è¯¥å†…éƒ¨ç«¯ç‚¹ä¸­çš„ä»»ä½•è·¯å¾„è¿›è¡Œäº¤äº’ï¼Œåˆ©ç”¨è¿™ç§æŠ€æœ¯ã€‚å› æ­¤ï¼Œåœ¨ `proxy_pass` URL ä¸­æŒ‡å®šè·¯å¾„ä¸ä¼šé™åˆ¶è®¿é—®ã€‚
{% endhint %}

å·¥å…· [**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) å’Œ [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) é€šè¿‡å»ºç«‹ H2C è¿æ¥ï¼Œæœ‰åŠ©äºå°è¯•ç»•è¿‡ä»£ç†æ–½åŠ çš„ä¿æŠ¤ï¼Œä»è€Œè®¿é—®è¢«ä»£ç†å±è”½çš„èµ„æºã€‚

æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯å…³äº NGINX çš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒ [**æ­¤è¯¦ç»†èµ„æº**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection)ã€‚

## Websocket Smuggling

ä¸åˆ›å»ºåˆ°é€šè¿‡ä»£ç†å¯è®¿é—®çš„ç«¯ç‚¹çš„ HTTP2 éš§é“ä¸åŒï¼ŒWebsocket smuggling å»ºç«‹äº†ä¸€ä¸ª Websocket éš§é“ï¼Œä»¥ç»•è¿‡æ½œåœ¨çš„ä»£ç†é™åˆ¶ï¼Œå¹¶ä¿ƒè¿›ä¸ç«¯ç‚¹çš„ç›´æ¥é€šä¿¡ã€‚

### åœºæ™¯ 1

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œä¸€ä¸ªæä¾›å…¬å…± WebSocket API å’Œæ— æ³•è®¿é—®çš„å†…éƒ¨ REST API çš„åç«¯è¢«æ¶æ„å®¢æˆ·ç«¯æ”»å‡»ï¼Œè¯•å›¾è®¿é—®å†…éƒ¨ REST APIã€‚æ”»å‡»åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š

1. å®¢æˆ·ç«¯é€šè¿‡åœ¨æ ‡å¤´ä¸­ä½¿ç”¨ä¸æ­£ç¡®çš„ `Sec-WebSocket-Version` åè®®ç‰ˆæœ¬å‘åå‘ä»£ç†å‘é€å‡çº§è¯·æ±‚ã€‚ä»£ç†æœªèƒ½éªŒè¯ `Sec-WebSocket-Version` æ ‡å¤´ï¼Œè®¤ä¸ºå‡çº§è¯·æ±‚æœ‰æ•ˆï¼Œå¹¶å°†å…¶è½¬å‘åˆ°åç«¯ã€‚
2. åç«¯ä»¥çŠ¶æ€ç  `426` å“åº”ï¼ŒæŒ‡ç¤º `Sec-WebSocket-Version` æ ‡å¤´ä¸­çš„ä¸æ­£ç¡®åè®®ç‰ˆæœ¬ã€‚åå‘ä»£ç†å¿½ç•¥åç«¯çš„å“åº”çŠ¶æ€ï¼Œå‡è®¾å·²å‡†å¤‡å¥½è¿›è¡Œ WebSocket é€šä¿¡ï¼Œå¹¶å°†å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚
3. ç»“æœï¼Œåå‘ä»£ç†è¢«è¯¯å¯¼ä»¥ä¸ºå®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´å·²å»ºç«‹äº† WebSocket è¿æ¥ï¼Œè€Œå®é™…ä¸Šï¼Œåç«¯å·²æ‹’ç»äº†å‡çº§è¯·æ±‚ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä»£ç†ä»ä¿æŒå®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´çš„å¼€æ”¾ TCP æˆ– TLS è¿æ¥ï¼Œä½¿å®¢æˆ·ç«¯é€šè¿‡æ­¤è¿æ¥æ— é™åˆ¶åœ°è®¿é—®ç§æœ‰ REST APIã€‚

å—å½±å“çš„åå‘ä»£ç†åŒ…æ‹¬ Varnishï¼Œå®ƒæ‹’ç»è§£å†³æ­¤é—®é¢˜ï¼Œä»¥åŠ Envoy ä»£ç†ç‰ˆæœ¬ 1.8.0 æˆ–æ›´æ—©ç‰ˆæœ¬ï¼Œåç»­ç‰ˆæœ¬å·²æ›´æ”¹äº†å‡çº§æœºåˆ¶ã€‚å…¶ä»–ä»£ç†ä¹Ÿå¯èƒ½å—åˆ°å½±å“ã€‚

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### åœºæ™¯ 2

æ­¤åœºæ™¯æ¶‰åŠä¸€ä¸ªå…·æœ‰å…¬å…± WebSocket API å’Œç”¨äºå¥åº·æ£€æŸ¥çš„å…¬å…± REST API çš„åç«¯ï¼Œä»¥åŠä¸€ä¸ªæ— æ³•è®¿é—®çš„å†…éƒ¨ REST APIã€‚æ”»å‡»æ›´ä¸ºå¤æ‚ï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ï¼š

1. å®¢æˆ·ç«¯å‘é€ POST è¯·æ±‚ä»¥è§¦å‘å¥åº·æ£€æŸ¥ APIï¼ŒåŒ…æ‹¬é¢å¤–çš„ HTTP æ ‡å¤´ `Upgrade: websocket`ã€‚ä½œä¸ºåå‘ä»£ç†çš„ NGINX ä»…åŸºäº `Upgrade` æ ‡å¤´è§£é‡Šæ­¤è¯·æ±‚ä¸ºæ ‡å‡†å‡çº§è¯·æ±‚ï¼Œå¿½ç•¥è¯·æ±‚çš„å…¶ä»–æ–¹é¢ï¼Œå¹¶å°†å…¶è½¬å‘åˆ°åç«¯ã€‚
2. åç«¯æ‰§è¡Œå¥åº·æ£€æŸ¥ APIï¼Œè®¿é—®ç”±æ”»å‡»è€…æ§åˆ¶çš„å¤–éƒ¨èµ„æºï¼Œè¯¥èµ„æºè¿”å›å¸¦æœ‰çŠ¶æ€ç  `101` çš„ HTTP å“åº”ã€‚ä¸€æ—¦åç«¯æ¥æ”¶åˆ°æ­¤å“åº”å¹¶å°†å…¶è½¬å‘åˆ° NGINXï¼Œç”±äºä»£ç†ä»…éªŒè¯çŠ¶æ€ç ï¼Œå®ƒè¢«æ¬ºéª—ä»¥ä¸ºå·²å»ºç«‹ WebSocket è¿æ¥ã€‚

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **è­¦å‘Šï¼š** è¯¥æŠ€æœ¯çš„å¤æ‚æ€§å¢åŠ ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸èƒ½å¤Ÿè¿”å›çŠ¶æ€ç  101 çš„ç«¯ç‚¹è¿›è¡Œäº¤äº’ã€‚

æœ€ç»ˆï¼ŒNGINX è¢«æ¬ºéª—ä»¥ä¸ºå®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´å­˜åœ¨ WebSocket è¿æ¥ã€‚å®é™…ä¸Šï¼Œå¹¶ä¸å­˜åœ¨è¿™æ ·çš„è¿æ¥ï¼›å¥åº·æ£€æŸ¥ REST API æ˜¯æ”»å‡»ç›®æ ‡ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåå‘ä»£ç†ä¿æŒè¿æ¥å¼€æ”¾ï¼Œä½¿å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ç§æœ‰ REST APIã€‚

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

å¤§å¤šæ•°åå‘ä»£ç†éƒ½å®¹æ˜“å—åˆ°æ­¤åœºæ™¯çš„å½±å“ï¼Œä½†åˆ©ç”¨å–å†³äºå­˜åœ¨å¤–éƒ¨ SSRF æ¼æ´ï¼Œé€šå¸¸è¢«è§†ä¸ºä½ä¸¥é‡æ€§é—®é¢˜ã€‚

#### å®éªŒå®¤

æ£€æŸ¥å®éªŒå®¤ï¼Œæµ‹è¯•ä¸¤ç§åœºæ™¯ï¼š[https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### å‚è€ƒèµ„æ–™

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Šæˆ–ä¸‹è½½ HackTricks çš„ PDFï¼Œè¯·æŸ¥çœ‹ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
