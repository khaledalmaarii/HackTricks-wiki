# Upgrade Header Smuggling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 Over Cleartext (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, ou **http2 sur texte clair**, s'√©carte de la norme des connexions HTTP transitoires en mettant √† niveau une **connexion HTTP standard en une connexion persistante**. Cette connexion mise √† niveau utilise le protocole binaire http2 pour la communication continue, contrairement √† la nature de requ√™te unique de l'HTTP en texte clair.

Le c≈ìur du probl√®me de contournement r√©side dans l'utilisation d'un **proxy inverse**. Ordinairement, le proxy inverse traite et transmet les requ√™tes HTTP au backend, renvoyant la r√©ponse du backend apr√®s cela. Cependant, lorsque l'en-t√™te `Connection: Upgrade` est pr√©sent dans une requ√™te HTTP (souvent observ√© avec les connexions websocket), le **proxy inverse maintient une connexion persistante** entre le client et le serveur, facilitant l'√©change continu requis par certains protocoles. Pour les connexions H2C, le respect de la RFC n√©cessite la pr√©sence de trois en-t√™tes sp√©cifiques :
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
La vuln√©rabilit√© survient lorsque, apr√®s la mise √† niveau d'une connexion, le proxy inverse cesse de g√©rer les requ√™tes individuelles, supposant que son travail de routage est termin√© apr√®s l'√©tablissement de la connexion. L'exploitation de H2C Smuggling permet de contourner les r√®gles du proxy inverse appliqu√©es lors du traitement des requ√™tes, telles que le routage bas√© sur le chemin, l'authentification et le traitement WAF, √† condition qu'une connexion H2C soit correctement initi√©e.

#### Proxies vuln√©rables <a href="#exploitation" id="exploitation"></a>

La vuln√©rabilit√© d√©pend de la gestion par le proxy inverse des en-t√™tes `Upgrade` et parfois `Connection`. Les proxies suivants transmettent intrins√®quement ces en-t√™tes lors du proxy-pass, permettant ainsi intrins√®quement le H2C smuggling :

* HAProxy
* Traefik
* Nuster

En revanche, ces services ne transmettent pas intrins√®quement les deux en-t√™tes lors du proxy-pass. Cependant, ils peuvent √™tre configur√©s de mani√®re non s√©curis√©e, permettant le transfert non filtr√© des en-t√™tes `Upgrade` et `Connection` :

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### Exploitation <a href="#exploitation" id="exploitation"></a>

Il est crucial de noter que tous les serveurs ne transmettent pas intrins√®quement les en-t√™tes requis pour une mise √† niveau de connexion H2C conforme. Ainsi, des serveurs comme AWS ALB/CLB, NGINX et Apache Traffic Server, entre autres, bloquent naturellement les connexions H2C. N√©anmoins, il vaut la peine de tester avec la variante non conforme `Connection: Upgrade`, qui exclut la valeur `HTTP2-Settings` de l'en-t√™te `Connection`, car certains backends peuvent ne pas se conformer aux normes.

{% hint style="danger" %}
Ind√©pendamment du **chemin** sp√©cifique d√©sign√© dans l'URL `proxy_pass` (par exemple, `http://backend:9999/socket.io`), la connexion √©tablie par d√©faut √† `http://backend:9999`. Cela permet d'interagir avec n'importe quel chemin au sein de ce point de terminaison interne, en tirant parti de cette technique. Par cons√©quent, la sp√©cification d'un chemin dans l'URL `proxy_pass` ne restreint pas l'acc√®s.
{% endhint %}

Les outils [**h2csmuggler par BishopFox**](https://github.com/BishopFox/h2csmuggler) et [**h2csmuggler par assetnote**](https://github.com/assetnote/h2csmuggler) facilitent les tentatives de **contourner les protections impos√©es par le proxy** en √©tablissant une connexion H2C, permettant ainsi l'acc√®s √† des ressources prot√©g√©es par le proxy.

Pour plus d'informations sur cette vuln√©rabilit√©, en particulier concernant NGINX, consultez [**cette ressource d√©taill√©e**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Le websocket smuggling, contrairement √† la cr√©ation d'un tunnel HTTP2 vers un point de terminaison accessible via un proxy, √©tablit un tunnel Websocket pour contourner les limitations potentielles du proxy et faciliter la communication directe avec le point de terminaison.

### Sc√©nario 1

Dans ce sc√©nario, un backend qui offre une API WebSocket publique aux c√¥t√©s d'une API REST interne inaccessible est cibl√© par un client malveillant cherchant √† acc√©der √† l'API REST interne. L'attaque se d√©roule en plusieurs √©tapes :

1. Le client commence par envoyer une requ√™te Upgrade au proxy inverse avec une version de protocole `Sec-WebSocket-Version` incorrecte dans l'en-t√™te. Le proxy, ne validant pas l'en-t√™te `Sec-WebSocket-Version`, croit que la requ√™te Upgrade est valide et la transmet au backend.
2. Le backend r√©pond avec un code d'√©tat `426`, indiquant la version de protocole incorrecte dans l'en-t√™te `Sec-WebSocket-Version`. Le proxy inverse, n√©gligeant le statut de r√©ponse du backend, suppose qu'il est pr√™t pour la communication WebSocket et relaye la r√©ponse au client.
3. Par cons√©quent, le proxy inverse est induit en erreur en croyant qu'une connexion WebSocket a √©t√© √©tablie entre le client et le backend, alors qu'en r√©alit√©, le backend avait rejet√© la requ√™te Upgrade. Malgr√© cela, le proxy maintient une connexion TCP ou TLS ouverte entre le client et le backend, permettant au client d'acc√©der sans restriction √† l'API REST priv√©e via cette connexion.

Les proxies inverses affect√©s incluent Varnish, qui a refus√© de traiter le probl√®me, et la version 1.8.0 ou ant√©rieure du proxy Envoy, les versions ult√©rieures ayant modifi√© le m√©canisme de mise √† niveau. D'autres proxies peuvent √©galement √™tre susceptibles.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Sc√©nario 2

Ce sc√©nario implique un backend avec √† la fois une API WebSocket publique et une API REST publique pour le contr√¥le de la sant√©, ainsi qu'une API REST interne inaccessible. L'attaque, plus complexe, implique les √©tapes suivantes :

1. Le client envoie une requ√™te POST pour d√©clencher l'API de contr√¥le de la sant√©, incluant un en-t√™te HTTP suppl√©mentaire `Upgrade: websocket`. NGINX, servant de proxy inverse, interpr√®te cela comme une requ√™te de mise √† niveau standard bas√©e uniquement sur l'en-t√™te `Upgrade`, n√©gligeant les autres aspects de la requ√™te, et la transmet au backend.
2. Le backend ex√©cute l'API de contr√¥le de la sant√©, contactant une ressource externe contr√¥l√©e par l'attaquant qui renvoie une r√©ponse HTTP avec le code d'√©tat `101`. Cette r√©ponse, une fois re√ßue par le backend et transmise √† NGINX, trompe le proxy en pensant qu'une connexion WebSocket a √©t√© √©tablie en raison de sa validation uniquement du code d'√©tat.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Avertissement :** La complexit√© de cette technique augmente car elle n√©cessite la capacit√© d'interagir avec un point de terminaison capable de renvoyer un code d'√©tat 101.

En fin de compte, NGINX est tromp√© en croyant qu'une connexion WebSocket existe entre le client et le backend. En r√©alit√©, aucune connexion de ce type n'existe ; l'API REST de contr√¥le de la sant√© √©tait la cible. N√©anmoins, le proxy inverse maintient la connexion ouverte, permettant au client d'acc√©der √† l'API REST priv√©e √† travers elle.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

La plupart des proxies inverses sont vuln√©rables √† ce sc√©nario, mais l'exploitation d√©pend de la pr√©sence d'une vuln√©rabilit√© SSRF externe, g√©n√©ralement consid√©r√©e comme un probl√®me de faible gravit√©.

#### Laboratoires

V√©rifiez les laboratoires pour tester les deux sc√©narios √† [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### R√©f√©rences

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
