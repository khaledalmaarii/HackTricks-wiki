# Nadogradnja Smugglinga Zaglavlja

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 preko Äistog teksta (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, ili **http2 preko Äistog teksta**, odstupa od norme prolaznih HTTP veza nadogradnjom standardne HTTP **veze na postojanu**. Ova nadograÄ‘ena veza koristi http2 binarni protokol za kontinuiranu komunikaciju, za razliku od jednokratne prirode plaintext HTTP-a.

SrÅ¾ problema sa smugglingom nastaje sa koriÅ¡Ä‡enjem **reverse proxy-ja**. ObiÄno, reverse proxy obraÄ‘uje i prosleÄ‘uje HTTP zahteve backend-u, vraÄ‡ajuÄ‡i odgovor backend-a nakon toga. MeÄ‘utim, kada je zaglavlje `Connection: Upgrade` prisutno u HTTP zahtevu (Äesto viÄ‘eno kod websocket veza), reverse **proxy odrÅ¾ava postojanu vezu** izmeÄ‘u klijenta i servera, olakÅ¡avajuÄ‡i kontinuiranu razmenu potrebnu za odreÄ‘ene protokole. Za H2C veze, poÅ¡tovanje RFC-a zahteva prisustvo tri specifiÄna zaglavlja:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
### Ranjivi Proksi <a href="#exploitation" id="exploitation"></a>

Ranjivost se javlja kada, nakon aÅ¾uriranja veze, obrnuti proksi prestaje da upravlja pojedinaÄnim zahtevima, pretpostavljajuÄ‡i da je njegov posao rutiranja zavrÅ¡en nakon uspostavljanja veze. IskoriÅ¡Ä‡avanje H2C Smugglinga omoguÄ‡ava zaobilaÅ¾enje pravila obrnutog proksija primenjenih tokom obrade zahteva, poput rutiranja zasnovanog na putanji, autentifikacije i WAF obrade, pod uslovom da je H2C veza uspeÅ¡no uspostavljena.

### Ranjivi Proksiji <a href="#exploitation" id="exploitation"></a>

Ranjivost zavisi od rukovanja proksija sa `Upgrade` i ponekad `Connection` zaglavljima. SledeÄ‡i proksiji inherentno prosleÄ‘uju ova zaglavlja tokom proksi-pasa, Äime inherentno omoguÄ‡avaju H2C smuggling:

- HAProxy
- Traefik
- Nuster

S druge strane, ovi servisi inherentno ne prosleÄ‘uju oba zaglavlja tokom proksi-pasa. MeÄ‘utim, mogu biti konfigurisani nebezbedno, omoguÄ‡avajuÄ‡i nefiltrirano prosleÄ‘ivanje `Upgrade` i `Connection` zaglavlja:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### IskoriÅ¡Ä‡avanje <a href="#exploitation" id="exploitation"></a>

VaÅ¾no je napomenuti da ne svi serveri inherentno prosleÄ‘uju zaglavlja potrebna za usklaÄ‘enu H2C vezu. Stoga, serveri poput AWS ALB/CLB, NGINX i Apache Traffic Server, meÄ‘u ostalima, prirodno blokiraju H2C veze. Ipak, vredi testirati sa neusklaÄ‘enom varijantom `Connection: Upgrade`, koja iskljuÄuje vrednost `HTTP2-Settings` iz `Connection` zaglavlja, jer neki backend-ovi moÅ¾da ne poÅ¡tuju standarde.

{% hint style="danger" %}
Bez obzira na specifiÄnu **putanju** odreÄ‘enu u URL-u `proxy_pass` (npr. `http://backend:9999/socket.io`), uspostavljena veza podrazumevano se vraÄ‡a na `http://backend:9999`. Ovo omoguÄ‡ava interakciju sa bilo kojom putanjom unutar te interne taÄke, koristeÄ‡i ovu tehniku. Stoga, specificiranje putanje u URL-u `proxy_pass` ne ograniÄava pristup.
{% endhint %}

Alati [**h2csmuggler od BishopFox-a**](https://github.com/BishopFox/h2csmuggler) i [**h2csmuggler od assetnote-a**](https://github.com/assetnote/h2csmuggler) olakÅ¡avaju pokuÅ¡aje **zaobilaÅ¾enja zaÅ¡tita nametnutih proksijem** uspostavljanjem H2C veze, Äime se omoguÄ‡ava pristup resursima zaÅ¡tiÄ‡enim proksijem.

Za dodatne informacije o ovoj ranjivosti, posebno u vezi sa NGINX-om, pogledajte [**ovaj detaljni resurs**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

# Websocket Smuggling

Websocket smuggling, za razliku od kreiranja HTTP2 tunela do taÄke pristupa preko proksija, uspostavlja Websocket tunel zaobiÄ‡i potencijalna ograniÄenja proksija i olakÅ¡ati direktnu komunikaciju sa taÄkom pristupa.

## Scenario 1

U ovom scenariju, zlonamerni klijent cilja backend koji nudi javni WebSocket API zajedno sa nepristupaÄnim internim REST API-jem. Napad se odvija u nekoliko koraka:

1. Klijent zapoÄinje slanjem Upgrade zahteva obrnutom proksiju sa netaÄnom verzijom protokola `Sec-WebSocket-Version` u zaglavlju. Proksi, ne uspevajuÄ‡i da validira `Sec-WebSocket-Version` zaglavlje, veruje da je Upgrade zahtev validan i prosleÄ‘uje ga backend-u.
2. Backend odgovara status kodom `426`, ukazujuÄ‡i na netaÄnu verziju protokola u `Sec-WebSocket-Version` zaglavlju. Obrnuti proksi, ignorisavÅ¡i odgovor backend-a, pretpostavlja spremnost za WebSocket komunikaciju i prosleÄ‘uje odgovor klijentu.
3. Kao rezultat, obrnuti proksi je zaveden da veruje da je WebSocket veza uspostavljena izmeÄ‘u klijenta i backend-a, dok je zapravo backend odbio Upgrade zahtev. Bez obzira na to, proksi odrÅ¾ava otvorenu TCP ili TLS vezu izmeÄ‘u klijenta i backend-a, omoguÄ‡avajuÄ‡i klijentu neograniÄen pristup privatnom REST API-ju putem ove veze.

PogoÄ‘eni obrnuti proksiji ukljuÄuju Varnish, koji nije reÅ¡io ovaj problem, i Envoy proksi verziju 1.8.0 ili starije, pri Äemu su kasnije verzije promenile mehanizam nadogradnje. Drugi proksiji takoÄ‘e mogu biti podloÅ¾ni.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Scenario 2

Ovaj scenario ukljuÄuje backend sa javnim WebSocket API-jem i javnim REST API-jem za proveru zdravlja, zajedno sa nepristupaÄnim internim REST API-jem. Napad, sloÅ¾eniji, ukljuÄuje sledeÄ‡e korake:

1. Klijent Å¡alje POST zahtev kako bi pokrenuo API za proveru zdravlja, ukljuÄujuÄ‡i dodatni HTTP zaglavlje `Upgrade: websocket`. NGINX, koji sluÅ¾i kao obrnuti proksi, tumaÄi ovo kao standardni Upgrade zahtev zasnovan iskljuÄivo na `Upgrade` zaglavlju, zanemarujuÄ‡i druge aspekte zahteva, i prosleÄ‘uje ga backend-u.
2. Backend izvrÅ¡ava API za proveru zdravlja, pristupajuÄ‡i spoljnom resursu koji kontroliÅ¡e napadaÄ i koji vraÄ‡a HTTP odgovor sa status kodom `101`. Ovaj odgovor, kada backend primi i prosledi NGINX-u, zavodi proksi da veruje da je uspostavljena WebSocket veza zbog validacije samo status koda.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Upozorenje:** SloÅ¾enost ove tehnike se poveÄ‡ava jer zahteva sposobnost interakcije sa taÄkom pristupa koja moÅ¾e vratiti status kod 101.

Na kraju, NGINX je prevaren da veruje da postoji WebSocket veza izmeÄ‘u klijenta i backend-a. U stvarnosti, takva veza ne postoji; API za proveru zdravlja je bio meta. Ipak, obrnuti proksi odrÅ¾ava otvorenu vezu, omoguÄ‡avajuÄ‡i klijentu pristup privatnom REST API-ju kroz nju.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

VeÄ‡ina obrnutih proksija je ranjiva na ovaj scenario, ali iskoriÅ¡Ä‡avanje zavisi od prisustva spoljne SSRF ranjivosti, obiÄno smatrane kao problem niskog stepena ozbiljnosti.

### Laboratorije

Proverite laboratorije kako biste testirali oba scenarija na [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

## Reference

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)
