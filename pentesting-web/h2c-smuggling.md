# å‡çº§å¤´éƒ¨æ¬ºéª—

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

### H2C æ¬ºéª— <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### æ˜æ–‡ HTTP2 (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2Cï¼Œæˆ–ç§°ä¸º **æ˜æ–‡ HTTP2**ï¼Œé€šè¿‡å°†æ ‡å‡† HTTP **è¿æ¥å‡çº§ä¸ºæŒä¹…è¿æ¥**ï¼Œåç¦»äº†ç¬æ€ HTTP è¿æ¥çš„å¸¸è§„ã€‚è¿™ç§å‡çº§çš„è¿æ¥åˆ©ç”¨ http2 äºŒè¿›åˆ¶åè®®è¿›è¡ŒæŒç»­é€šä¿¡ï¼Œè€Œä¸æ˜¯æ˜æ–‡ HTTP çš„å•è¯·æ±‚ç‰¹æ€§ã€‚

æ¬ºéª—é—®é¢˜çš„å…³é”®åœ¨äºä½¿ç”¨ **åå‘ä»£ç†**ã€‚é€šå¸¸ï¼Œåå‘ä»£ç†å¤„ç†å¹¶è½¬å‘ HTTP è¯·æ±‚åˆ°åç«¯ï¼Œç„¶åè¿”å›åç«¯çš„å“åº”ã€‚ç„¶è€Œï¼Œå½“ HTTP è¯·æ±‚ä¸­å­˜åœ¨ `Connection: Upgrade` å¤´æ—¶ï¼ˆé€šå¸¸åœ¨ websocket è¿æ¥ä¸­çœ‹åˆ°ï¼‰ï¼Œåå‘ **ä»£ç†åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¿æŒæŒä¹…è¿æ¥**ï¼Œä¿ƒè¿›æŸäº›åè®®æ‰€éœ€çš„æŒç»­äº¤æ¢ã€‚å¯¹äº H2C è¿æ¥ï¼Œéµå¾ª RFC éœ€è¦å­˜åœ¨ä¸‰ä¸ªç‰¹å®šçš„å¤´éƒ¨ï¼š
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
æ¼æ´äº§ç”Ÿäºåœ¨å‡çº§è¿æ¥åï¼Œåå‘ä»£ç†åœæ­¢ç®¡ç†å•ä¸ªè¯·æ±‚ï¼Œå‡è®¾å…¶è·¯ç”±å·¥ä½œåœ¨è¿æ¥å»ºç«‹åå·²å®Œæˆã€‚åˆ©ç”¨ H2C Smuggling å¯ä»¥ç»•è¿‡åœ¨è¯·æ±‚å¤„ç†æœŸé—´åº”ç”¨çš„åå‘ä»£ç†è§„åˆ™ï¼Œä¾‹å¦‚åŸºäºè·¯å¾„çš„è·¯ç”±ã€èº«ä»½éªŒè¯å’Œ WAF å¤„ç†ï¼Œå‰ææ˜¯æˆåŠŸå‘èµ· H2C è¿æ¥ã€‚

#### æ˜“å—æ”»å‡»çš„ä»£ç† <a href="#exploitation" id="exploitation"></a>

è¯¥æ¼æ´ä¾èµ–äºåå‘ä»£ç†å¯¹ `Upgrade` å’Œæœ‰æ—¶ `Connection` å¤´çš„å¤„ç†ã€‚ä»¥ä¸‹ä»£ç†åœ¨ä»£ç†ä¼ é€’æœŸé—´å›ºæœ‰åœ°è½¬å‘è¿™äº›å¤´ï¼Œä»è€Œå›ºæœ‰åœ°å¯ç”¨ H2C smugglingï¼š

* HAProxy
* Traefik
* Nuster

ç›¸åï¼Œè¿™äº›æœåŠ¡åœ¨ä»£ç†ä¼ é€’æœŸé—´å¹¶ä¸å›ºæœ‰åœ°è½¬å‘è¿™ä¸¤ä¸ªå¤´ã€‚ç„¶è€Œï¼Œå®ƒä»¬å¯èƒ½è¢«ä¸å®‰å…¨åœ°é…ç½®ï¼Œå…è®¸ä¸ç»è¿‡è¿‡æ»¤åœ°è½¬å‘ `Upgrade` å’Œ `Connection` å¤´ï¼š

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### åˆ©ç”¨ <a href="#exploitation" id="exploitation"></a>

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰æœåŠ¡å™¨éƒ½å›ºæœ‰åœ°è½¬å‘ç¬¦åˆ H2C è¿æ¥å‡çº§æ‰€éœ€çš„å¤´ã€‚å› æ­¤ï¼Œåƒ AWS ALB/CLBã€NGINX å’Œ Apache Traffic Server ç­‰æœåŠ¡å™¨è‡ªç„¶ä¼šé˜»æ­¢ H2C è¿æ¥ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå€¼å¾—æµ‹è¯•ä¸åˆè§„çš„ `Connection: Upgrade` å˜ä½“ï¼Œè¯¥å˜ä½“ä» `Connection` å¤´ä¸­æ’é™¤äº† `HTTP2-Settings` å€¼ï¼Œå› ä¸ºæŸäº›åç«¯å¯èƒ½ä¸ç¬¦åˆæ ‡å‡†ã€‚

{% hint style="danger" %}
æ— è®ºåœ¨ `proxy_pass` URL ä¸­æŒ‡å®šçš„å…·ä½“ **è·¯å¾„**ï¼ˆä¾‹å¦‚ `http://backend:9999/socket.io`ï¼‰æ˜¯ä»€ä¹ˆï¼Œå»ºç«‹çš„è¿æ¥é»˜è®¤ä¸º `http://backend:9999`ã€‚è¿™å…è®¸ä¸è¯¥å†…éƒ¨ç«¯ç‚¹å†…çš„ä»»ä½•è·¯å¾„è¿›è¡Œäº¤äº’ï¼Œåˆ©ç”¨æ­¤æŠ€æœ¯ã€‚å› æ­¤ï¼Œåœ¨ `proxy_pass` URL ä¸­æŒ‡å®šè·¯å¾„å¹¶ä¸é™åˆ¶è®¿é—®ã€‚
{% endhint %}

å·¥å…· [**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) å’Œ [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) é€šè¿‡å»ºç«‹ H2C è¿æ¥æ¥å¸®åŠ©å°è¯• **ç»•è¿‡ä»£ç†æ–½åŠ çš„ä¿æŠ¤**ï¼Œä»è€Œè®¿é—®è¢«ä»£ç†ä¿æŠ¤çš„èµ„æºã€‚

æœ‰å…³æ­¤æ¼æ´çš„æ›´å¤šä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯å…³äº NGINX çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… [**æ­¤è¯¦ç»†èµ„æº**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection)ã€‚

## Websocket Smuggling

Websocket smuggling ä¸é€šè¿‡ä»£ç†åˆ›å»º HTTP2 éš§é“åˆ°å¯è®¿é—®çš„ç«¯ç‚¹ä¸åŒï¼Œå®ƒå»ºç«‹ä¸€ä¸ª Websocket éš§é“ä»¥ç»•è¿‡æ½œåœ¨çš„ä»£ç†é™åˆ¶å¹¶ä¿ƒè¿›ä¸ç«¯ç‚¹çš„ç›´æ¥é€šä¿¡ã€‚

### åœºæ™¯ 1

åœ¨æ­¤åœºæ™¯ä¸­ï¼Œåç«¯æä¾›å…¬å…± WebSocket APIï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªæ— æ³•è®¿é—®çš„å†…éƒ¨ REST APIï¼Œæ¶æ„å®¢æˆ·ç«¯è¯•å›¾è®¿é—®å†…éƒ¨ REST APIã€‚æ”»å‡»åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š

1. å®¢æˆ·ç«¯é€šè¿‡å‘åå‘ä»£ç†å‘é€å¸¦æœ‰é”™è¯¯çš„ `Sec-WebSocket-Version` åè®®ç‰ˆæœ¬çš„ Upgrade è¯·æ±‚æ¥å¯åŠ¨ã€‚ä»£ç†æœªèƒ½éªŒè¯ `Sec-WebSocket-Version` å¤´ï¼Œè®¤ä¸º Upgrade è¯·æ±‚æœ‰æ•ˆå¹¶å°†å…¶è½¬å‘ç»™åç«¯ã€‚
2. åç«¯ä»¥çŠ¶æ€ç  `426` å“åº”ï¼ŒæŒ‡ç¤º `Sec-WebSocket-Version` å¤´ä¸­çš„åè®®ç‰ˆæœ¬ä¸æ­£ç¡®ã€‚åå‘ä»£ç†å¿½è§†åç«¯çš„å“åº”çŠ¶æ€ï¼Œå‡è®¾å·²å‡†å¤‡å¥½è¿›è¡Œ WebSocket é€šä¿¡ï¼Œå¹¶å°†å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚
3. å› æ­¤ï¼Œåå‘ä»£ç†è¢«è¯¯å¯¼è®¤ä¸ºå®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´å·²å»ºç«‹ WebSocket è¿æ¥ï¼Œè€Œå®é™…ä¸Šåç«¯å·²æ‹’ç» Upgrade è¯·æ±‚ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä»£ç†åœ¨å®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´ä¿æŒå¼€æ”¾çš„ TCP æˆ– TLS è¿æ¥ï¼Œå…è®¸å®¢æˆ·ç«¯é€šè¿‡æ­¤è¿æ¥æ— é™åˆ¶è®¿é—®ç§æœ‰ REST APIã€‚

å—å½±å“çš„åå‘ä»£ç†åŒ…æ‹¬ Varnishï¼Œè¯¥ä»£ç†æ‹’ç»è§£å†³æ­¤é—®é¢˜ï¼Œä»¥åŠ Envoy ä»£ç†ç‰ˆæœ¬ 1.8.0 æˆ–æ›´æ—©ç‰ˆæœ¬ï¼Œåç»­ç‰ˆæœ¬å·²æ›´æ”¹å‡çº§æœºåˆ¶ã€‚å…¶ä»–ä»£ç†ä¹Ÿå¯èƒ½æ˜“å—æ”»å‡»ã€‚

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### åœºæ™¯ 2

æ­¤åœºæ™¯æ¶‰åŠä¸€ä¸ªåç«¯ï¼Œæ—¢æœ‰å…¬å…± WebSocket APIï¼Œä¹Ÿæœ‰ç”¨äºå¥åº·æ£€æŸ¥çš„å…¬å…± REST APIï¼Œä»¥åŠä¸€ä¸ªæ— æ³•è®¿é—®çš„å†…éƒ¨ REST APIã€‚æ”»å‡»æ›´å¤æ‚ï¼Œæ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š

1. å®¢æˆ·ç«¯å‘é€ POST è¯·æ±‚ä»¥è§¦å‘å¥åº·æ£€æŸ¥ APIï¼ŒåŒ…æ‹¬é¢å¤–çš„ HTTP å¤´ `Upgrade: websocket`ã€‚NGINX ä½œä¸ºåå‘ä»£ç†ï¼Œå°†å…¶è§£é‡Šä¸ºåŸºäº `Upgrade` å¤´çš„æ ‡å‡† Upgrade è¯·æ±‚ï¼Œå¿½ç•¥è¯·æ±‚çš„å…¶ä»–æ–¹é¢ï¼Œå¹¶å°†å…¶è½¬å‘ç»™åç«¯ã€‚
2. åç«¯æ‰§è¡Œå¥åº·æ£€æŸ¥ APIï¼Œè”ç³»ç”±æ”»å‡»è€…æ§åˆ¶çš„å¤–éƒ¨èµ„æºï¼Œè¯¥èµ„æºè¿”å›çŠ¶æ€ç ä¸º `101` çš„ HTTP å“åº”ã€‚æ­¤å“åº”åœ¨è¢«åç«¯æ¥æ”¶å¹¶è½¬å‘ç»™ NGINX åï¼Œæ¬ºéª—ä»£ç†è®¤ä¸ºå·²å»ºç«‹ WebSocket è¿æ¥ï¼Œå› ä¸ºå®ƒä»…éªŒè¯äº†çŠ¶æ€ç ã€‚

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **è­¦å‘Šï¼š** æ­¤æŠ€æœ¯çš„å¤æ‚æ€§å¢åŠ ï¼Œå› ä¸ºå®ƒéœ€è¦èƒ½å¤Ÿä¸èƒ½å¤Ÿè¿”å›çŠ¶æ€ç  101 çš„ç«¯ç‚¹è¿›è¡Œäº¤äº’ã€‚

æœ€ç»ˆï¼ŒNGINX è¢«æ¬ºéª—è®¤ä¸ºå®¢æˆ·ç«¯å’Œåç«¯ä¹‹é—´å­˜åœ¨ WebSocket è¿æ¥ã€‚å®é™…ä¸Šï¼Œå¹¶ä¸å­˜åœ¨è¿™æ ·çš„è¿æ¥ï¼›å¥åº·æ£€æŸ¥ REST API æ˜¯ç›®æ ‡ã€‚å°½ç®¡å¦‚æ­¤ï¼Œåå‘ä»£ç†ä¿æŒè¿æ¥å¼€æ”¾ï¼Œä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡å®ƒè®¿é—®ç§æœ‰ REST APIã€‚

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

å¤§å¤šæ•°åå‘ä»£ç†åœ¨æ­¤åœºæ™¯ä¸­æ˜“å—æ”»å‡»ï¼Œä½†åˆ©ç”¨å–å†³äºå­˜åœ¨å¤–éƒ¨ SSRF æ¼æ´ï¼Œé€šå¸¸è¢«è§†ä¸ºä½ä¸¥é‡æ€§é—®é¢˜ã€‚

#### å®éªŒå®¤

æ£€æŸ¥å®éªŒå®¤ä»¥æµ‹è¯•è¿™ä¸¤ç§åœºæ™¯ [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### å‚è€ƒæ–‡çŒ®

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æ”»å‡»ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
