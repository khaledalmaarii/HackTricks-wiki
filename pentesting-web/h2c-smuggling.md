# Ulepszenie Smuglowania Nag贸wka

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Znajd藕 najwa偶niejsze podatnoci, aby m贸c je szybko naprawi. Intruder ledzi powierzchni ataku, wykonuje proaktywne skanowanie zagro偶e, znajduje problemy w caym stosie technologicznym, od interfejs贸w API po aplikacje internetowe i systemy chmurowe. [**Wypr贸buj go za darmo**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) ju偶 dzi.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Smuglowanie H2C <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 nad czystym tekstem (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, czyli **http2 nad czystym tekstem**, odbiega od normy przejciowych pocze HTTP, uaktualniajc standardowe poczenie HTTP do trwaego. To uaktualnione poczenie wykorzystuje binarny protok贸 http2 do cigej komunikacji, w przeciwiestwie do jednorazowego charakteru czystego HTTP.

Istota problemu smuglowania wynika z u偶ycia **odwr贸conego proxy**. Zwykle odwr贸cone proxy przetwarza i przekazuje 偶dania HTTP do backendu, zwracajc odpowied藕 backendu po tym. Jednak gdy nag贸wek `Connection: Upgrade` jest obecny w 偶daniu HTTP (czsto widoczny w poczeniach websocket), odwr贸cone **proxy utrzymuje trwae poczenie** midzy klientem a serwerem, uatwiajc cig wymian wymagan przez pewne protokoy. Dla pocze H2C, zgodno z RFC wymaga obecnoci trzech konkretnych nag贸wk贸w:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Podatno pojawia si, gdy po uaktualnieniu poczenia, odwr贸cony proxy przestaje zarzdza poszczeg贸lnymi 偶daniami, zakadajc, 偶e jego zadanie polegajce na kierowaniu jest zakoczone po ustanowieniu poczenia. Wykorzystanie H2C Smuggling umo偶liwia obejcie regu odwr贸conego proxy stosowanych podczas przetwarzania 偶dania, takich jak kierowanie oparte na cie偶ce, uwierzytelnianie i przetwarzanie WAF, zakadajc, 偶e poczenie H2C zostanie pomylnie nawizane.

### Podatne proxy <a href="#exploitation" id="exploitation"></a>

Podatno zale偶y od obsugi nag贸wk贸w `Upgrade` i czasami `Connection` przez odwr贸cone proxy. Nastpujce proxy domylnie przekazuj te nag贸wki podczas proxy-pass, co umo偶liwia automatyczne wczenie H2C smuggling:

- HAProxy
- Traefik
- Nuster

Z kolei te usugi nie przekazuj obu nag贸wk贸w domylnie podczas proxy-pass. Jednak mog by skonfigurowane w spos贸b niebezpieczny, umo偶liwiajcy niefiltrowane przekazywanie nag贸wk贸w `Upgrade` i `Connection`:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### Wykorzystanie <a href="#exploitation" id="exploitation"></a>

Warto zauwa偶y, 偶e nie wszystkie serwery domylnie przekazuj nag贸wki wymagane do zgodnego uaktualnienia poczenia H2C. Dlatego warto przetestowa wariant niezgodny z zasadami, kt贸ry nie zawiera wartoci `HTTP2-Settings` w nag贸wku `Connection`, poniewa偶 niekt贸re backendy mog nie by zgodne ze standardami.

{% hint style="danger" %}
Niezale偶nie od okrelonej **cie偶ki** w URL `proxy_pass` (np. `http://backend:9999/socket.io`), ustanowione poczenie domylnie odwouje si do `http://backend:9999`. Pozwala to na interakcj z dowoln cie偶k wewntrz tego wewntrznego punktu kocowego, wykorzystujc t technik. Okrelenie cie偶ki w URL `proxy_pass` nie ogranicza dostpu.
{% endhint %}

Narzdzia [**h2csmuggler od BishopFox**](https://github.com/BishopFox/h2csmuggler) i [**h2csmuggler od assetnote**](https://github.com/assetnote/h2csmuggler) uatwiaj pr贸by **obejcia ochrony narzuconej przez proxy** poprzez ustanowienie poczenia H2C, umo偶liwiajc dostp do zasob贸w zabezpieczonych przez proxy.

Aby uzyska dodatkowe informacje na temat tej podatnoci, zwaszcza dotyczce NGINX, odwoaj si do [**tego szczeg贸owego 藕r贸da**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

# Websocket Smuggling

Websocket smuggling, w przeciwiestwie do tworzenia tunelu HTTP2 do punktu kocowego dostpnego za porednictwem proxy, ustanawia tunel Websocket w celu obejcia potencjalnych ogranicze proxy i uatwienia bezporedniej komunikacji z punktem kocowym.

## Scenariusz 1

W tym scenariuszu zoliwy klient, kt贸ry chce uzyska dostp do wewntrznego REST API, kieruje atak na backend, kt贸ry oferuje publiczne API Websocket obok niedostpnego wewntrznego REST API. Atak skada si z kilku krok贸w:

1. Klient rozpoczyna, wysyajc 偶danie Upgrade do odwr贸conego proxy z nieprawidow wersj protokou `Sec-WebSocket-Version` w nag贸wku. Proxy, nie sprawdzajc nag贸wka `Sec-WebSocket-Version`, uznaje 偶danie Upgrade za prawidowe i przekazuje je do backendu.
2. Backend odpowiada kodem stanu `426`, wskazujcym nieprawidow wersj protokou w nag贸wku `Sec-WebSocket-Version`. Odwr贸cone proxy, pomijajc status odpowiedzi backendu, zakada gotowo do komunikacji Websocket i przekazuje odpowied藕 do klienta.
3. W rezultacie odwr贸cone proxy zostaje wprowadzone w bd, wierzc, 偶e zostao ustanowione poczenie Websocket midzy klientem a backendem, podczas gdy w rzeczywistoci backend odrzuci 偶danie Upgrade. Mimo to, proxy utrzymuje otwarte poczenie TCP lub TLS midzy klientem a backendem, umo偶liwiajc klientowi nieograniczony dostp do prywatnego REST API za porednictwem tego poczenia.

Podatne odwr贸cone proxy obejmuj Varnish, kt贸ry odm贸wi rozwizania tego problemu, oraz proxy Envoy w wersji 1.8.0 lub starszej, przy czym p贸藕niejsze wersje zmieniy mechanizm uaktualniania. Inne proxy mog r贸wnie偶 by podatne.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Scenariusz 2

Ten scenariusz dotyczy backendu posiadajcego zar贸wno publiczne API Websocket, jak i publiczne API REST do sprawdzania stanu zdrowia, oraz niedostpnego wewntrznego REST API. Atak, bardziej zo偶ony, obejmuje nastpujce kroki:

1. Klient wysya 偶danie POST, aby uruchomi API sprawdzania stanu zdrowia, zawierajc dodatkowy nag贸wek HTTP `Upgrade: websocket`. NGINX, dziaajcy jako odwr贸cone proxy, interpretuje to jako standardowe 偶danie Upgrade, opierajc si wycznie na nag贸wku `Upgrade`, ignorujc inne aspekty 偶dania, i przekazuje je do backendu.
2. Backend wykonuje API sprawdzania stanu zdrowia, sigajc do zewntrznego zasobu kontrolowanego przez atakujcego, kt贸ry zwraca odpowied藕 HTTP ze statusem `101`. Ta odpowied藕, po otrzymaniu jej przez backend i przekazaniu do NGINX, wprowadza proxy w bd, sugerujc, 偶e zostao ustanowione poczenie Websocket ze wzgldu na sprawdzenie tylko kodu stanu.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Ostrze偶enie:** Zo偶ono tej techniki wzrasta, poniewa偶 wymaga mo偶liwoci interakcji z punktem kocowym, kt贸ry mo偶e zwr贸ci kod stanu 101.

Ostatecznie NGINX zostaje wprowadzone w bd, wierzc, 偶e istnieje poczenie Websocket midzy klientem a backendem. W rzeczywistoci takie poczenie nie istnieje; celem bya REST API sprawdzania stanu zdrowia. Niemniej jednak, odwr贸cone proxy utrzymuje otwarte poczenie, umo偶liwiajc klientowi dostp do prywatnego REST API za porednictwem niego.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/web
