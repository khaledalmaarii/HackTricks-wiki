# Nadogradnja Smugglinga Zaglavlja

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

PronaÄ‘ite najvaÅ¾nije ranjivosti kako biste ih brÅ¾e popravili. Intruder prati vaÅ¡u povrÅ¡inu napada, pokreÄ‡e proaktivne pretnje, pronalazi probleme u celokupnom tehnoloÅ¡kom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 preko Äistog teksta (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, ili **http2 preko Äistog teksta**, odstupa od norme privremenih HTTP veza nadogradnjom standardne HTTP **veze na trajnu vezu**. Ova nadograÄ‘ena veza koristi http2 binarni protokol za kontinuiranu komunikaciju, za razliku od jednokratne prirode plaintext HTTP-a.

SrÅ¾ problema sa smugglingom nastaje sa koriÅ¡Ä‡enjem **obrnute proxy**-je. ObiÄno, obrnuta proxy obraÄ‘uje i prosleÄ‘uje HTTP zahteve ka backend-u, vraÄ‡ajuÄ‡i odgovor backend-a nakon toga. MeÄ‘utim, kada je zaglavlje `Connection: Upgrade` prisutno u HTTP zahtevu (Äesto viÄ‘eno kod websocket veza), obrnuta **proxy odrÅ¾ava trajnu vezu** izmeÄ‘u klijenta i servera, omoguÄ‡avajuÄ‡i kontinuiranu razmenu potrebnu za odreÄ‘ene protokole. Za H2C veze, poÅ¡tovanje RFC-a zahteva prisustvo tri specifiÄna zaglavlja:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Ranjivost se javlja kada, nakon nadogradnje veze, obrnuti proxy prestaje da upravlja pojedinaÄnim zahtevima, pretpostavljajuÄ‡i da je njegov posao rutiranja zavrÅ¡en nakon uspostavljanja veze. IskoriÅ¡Ä‡avanje H2C Smugglinga omoguÄ‡ava zaobilaÅ¾enje pravila obrnutog proxyja koja se primenjuju tokom obrade zahteva, kao Å¡to su rutiranje na osnovu putanje, autentifikacija i obrada WAF-a, pod uslovom da je H2C veza uspeÅ¡no uspostavljena.

### Ranjivi proxyji <a href="#exploitation" id="exploitation"></a>

Ranjivost zavisi od rukovanja proxyja obrnutim `Upgrade` i ponekad `Connection` zaglavljima. SledeÄ‡i proxyji inherentno prosleÄ‘uju ova zaglavlja tokom proxy-pass, Äime inherentno omoguÄ‡avaju H2C smuggling:

- HAProxy
- Traefik
- Nuster

S druge strane, ovi servisi ne prosleÄ‘uju inherentno oba zaglavlja tokom proxy-pass. MeÄ‘utim, mogu biti konfigurisani nesigurno, Å¡to omoguÄ‡ava nefiltrirano prosleÄ‘ivanje zaglavlja `Upgrade` i `Connection`:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### IskoriÅ¡Ä‡avanje <a href="#exploitation" id="exploitation"></a>

VaÅ¾no je napomenuti da ne sve servere inherentno prosleÄ‘uju zaglavlja potrebna za usklaÄ‘eno nadogradnju H2C veze. Zbog toga, serveri poput AWS ALB/CLB, NGINX i Apache Traffic Server, izmeÄ‘u ostalih, prirodno blokiraju H2C veze. Ipak, vredi testirati sa neusklaÄ‘enom varijantom `Connection: Upgrade`, koja iskljuÄuje vrednost `HTTP2-Settings` iz zaglavlja `Connection`, jer neki backendovi moÅ¾da ne poÅ¡tuju standarde.

{% hint style="danger" %}
Bez obzira na specifiÄnu **putanju** odreÄ‘enu u URL-u `proxy_pass` (npr. `http://backend:9999/socket.io`), uspostavljena veza podrazumeva podrazumevano `http://backend:9999`. To omoguÄ‡ava interakciju sa bilo kojom putanjom unutar tog internog krajnog taÄke, koristeÄ‡i ovu tehniku. Stoga, specificiranje putanje u URL-u `proxy_pass` ne ograniÄava pristup.
{% endhint %}

Alati [**h2csmuggler od strane BishopFox-a**](https://github.com/BishopFox/h2csmuggler) i [**h2csmuggler od strane assetnote-a**](https://github.com/assetnote/h2csmuggler) olakÅ¡avaju pokuÅ¡aje **zaobilaÅ¾enja zaÅ¡tite nametnute proxyjem** uspostavljanjem H2C veze, Äime se omoguÄ‡ava pristup resursima zaÅ¡tiÄ‡enim proxyjem.

Za dodatne informacije o ovoj ranjivosti, posebno u vezi sa NGINX-om, pogledajte [**ovaj detaljni resurs**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

# Websocket Smuggling

Websocket smuggling, za razliku od kreiranja HTTP2 tunela do endpointa koji je dostupan putem proxyja, uspostavlja Websocket tunel kako bi zaobiÅ¡ao potencijalna ograniÄenja proxyja i omoguÄ‡io direktnu komunikaciju sa endpointom.

## Scenario 1

U ovom scenariju, zlonamerni klijent cilja backend koji nudi javni WebSocket API zajedno sa nepristupaÄnim internim REST API-jem i Å¾eli pristupiti internom REST API-ju. Napad se odvija u nekoliko koraka:

1. Klijent zapoÄinje slanjem Upgrade zahteva obrnutom proxyju sa netaÄnom verzijom protokola `Sec-WebSocket-Version` u zaglavlju. Proxy, ne uspevajuÄ‡i da validira zaglavlje `Sec-WebSocket-Version`, veruje da je Upgrade zahtev validan i prosleÄ‘uje ga backendu.
2. Backend odgovara sa status kodom `426`, koji ukazuje na netaÄnu verziju protokola u zaglavlju `Sec-WebSocket-Version`. Obrnuti proxy, ne primeÄ‡ujuÄ‡i statusni kod odgovora backenda, pretpostavlja da je spreman za WebSocket komunikaciju i prosleÄ‘uje odgovor klijentu.
3. Kao rezultat toga, obrnuti proxy je zaveden da veruje da je WebSocket veza uspostavljena izmeÄ‘u klijenta i backenda, dok je u stvarnosti backend odbio Upgrade zahtev. Bez obzira na to, proxy odrÅ¾ava otvorenu TCP ili TLS vezu izmeÄ‘u klijenta i backenda, omoguÄ‡avajuÄ‡i klijentu neograniÄen pristup privatnom REST API-ju putem ove veze.

PogoÄ‘eni obrnuti proxyji ukljuÄuju Varnish, koji nije Å¾eleo da se bavi ovim problemom, i Envoy proxy verziju 1.8.0 ili starije, pri Äemu su kasnije verzije izmenile mehanizam nadogradnje. Ostali proxyji takoÄ‘e mogu biti podloÅ¾ni.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Scenario 2

Ovaj scenario ukljuÄuje backend sa javnim WebSocket API-jem i javnim REST API-jem za proveru stanja, zajedno sa nepristupaÄnim internim REST API-jem. Napad, koji je sloÅ¾eniji, ukljuÄuje sledeÄ‡e korake:

1. Klijent Å¡alje POST zahtev za pokretanje API-ja za proveru stanja, ukljuÄujuÄ‡i dodatno HTTP zaglavlje `Upgrade: websocket`. NGINX, koji sluÅ¾i kao obrnuti proxy, tumaÄi ovo kao standardni Upgrade zahtev samo na osnovu zaglavlja `Upgrade`, zanemarujuÄ‡i druge aspekte zahteva, i prosleÄ‘uje ga backendu.
2. Backend izvrÅ¡ava API za proveru stanja, pristupajuÄ‡i spoljnom resursu koji kontroliÅ¡e napadaÄ i koji vraÄ‡a HTTP odgovor sa status kodom `101`. Ovaj odgovor, kada ga backend primi i prosledi NGINX-u, vara proxy da misli da je WebSocket veza uspostavljena zbog njegove validacije samo statusnog koda.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Upozorenje:** SloÅ¾enost ove tehnike se poveÄ‡ava jer zahteva moguÄ‡nost interakcije sa endpointom koji moÅ¾e vratiti status kod 101.

KonaÄno, NGINX je prevaran da veruje da postoji WebSocket veza izmeÄ‘u klijenta i backenda. U stvarnosti, takva veza ne postoji; cilj je bio REST API za proveru stanja. Ipak, obrnuti proxy odrÅ¾ava otvorenu vezu, omoguÄ‡avajuÄ‡i klijentu pristup privatnom REST API-ju putem nje.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

VeÄ‡ina obrnutih proxyja je ranjiva na ovaj scenario, ali iskoriÅ¡Ä‡avanje zavisi od prisustva ranjivosti spoljnjeg SSRF-a, koja se obiÄno smatra problemom n
