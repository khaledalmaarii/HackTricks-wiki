# Upgrade Header Smuggling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 √úber Klartext (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, oder **http2 √ºber Klartext**, weicht von der Norm der transienten HTTP-Verbindungen ab, indem es eine standardm√§√üige HTTP-**Verbindung zu einer persistenten** aufwertet. Diese aufgewertete Verbindung nutzt das http2-Bin√§rprotokoll f√ºr die fortlaufende Kommunikation, im Gegensatz zur Einzelanfrage-Natur von Klartext-HTTP.

Der Kern des Smuggling-Problems ergibt sich aus der Verwendung eines **Reverse Proxys**. Gew√∂hnlich verarbeitet der Reverse Proxy HTTP-Anfragen und leitet sie an das Backend weiter, wobei er die Antwort des Backends danach zur√ºckgibt. Wenn jedoch der `Connection: Upgrade`-Header in einer HTTP-Anfrage vorhanden ist (h√§ufig bei Websocket-Verbindungen zu sehen), h√§lt der Reverse **Proxy eine persistente Verbindung** zwischen Client und Server aufrecht, was den kontinuierlichen Austausch erm√∂glicht, der von bestimmten Protokollen gefordert wird. F√ºr H2C-Verbindungen erfordert die Einhaltung des RFC das Vorhandensein von drei spezifischen Headern:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Die Schwachstelle entsteht, wenn der Reverse-Proxy nach dem Upgrade einer Verbindung aufh√∂rt, einzelne Anfragen zu verwalten, und davon ausgeht, dass seine Aufgabe des Routings nach der Herstellung der Verbindung abgeschlossen ist. Die Ausnutzung von H2C Smuggling erm√∂glicht es, die vom Reverse-Proxy w√§hrend der Anfrageverarbeitung angewendeten Regeln zu umgehen, wie z.B. pfadbasierte Weiterleitung, Authentifizierung und WAF-Verarbeitung, vorausgesetzt, eine H2C-Verbindung wird erfolgreich initiiert.

#### Verwundbare Proxys <a href="#exploitation" id="exploitation"></a>

Die Schwachstelle h√§ngt von der Handhabung der `Upgrade`- und manchmal `Connection`-Header durch den Reverse-Proxy ab. Die folgenden Proxys leiten diese Header w√§hrend des Proxy-Pass inherently weiter und erm√∂glichen somit H2C Smuggling:

* HAProxy
* Traefik
* Nuster

Im Gegensatz dazu leiten diese Dienste nicht inherent beide Header w√§hrend des Proxy-Pass weiter. Sie k√∂nnen jedoch unsicher konfiguriert werden, was eine ungefilterte Weiterleitung der `Upgrade`- und `Connection`-Header erm√∂glicht:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### Ausnutzung <a href="#exploitation" id="exploitation"></a>

Es ist wichtig zu beachten, dass nicht alle Server die f√ºr ein konformes H2C-Verbindungsupgrade erforderlichen Header inherent weiterleiten. Daher blockieren Server wie AWS ALB/CLB, NGINX und Apache Traffic Server unter anderem nat√ºrlich H2C-Verbindungen. Dennoch ist es wert, mit der nicht konformen `Connection: Upgrade`-Variante zu testen, die den `HTTP2-Settings`-Wert aus dem `Connection`-Header ausschlie√üt, da einige Backends m√∂glicherweise nicht den Standards entsprechen.

{% hint style="danger" %}
Unabh√§ngig von dem spezifischen **Pfad**, der in der `proxy_pass`-URL angegeben ist (z.B. `http://backend:9999/socket.io`), wird die hergestellte Verbindung standardm√§√üig auf `http://backend:9999` gesetzt. Dies erm√∂glicht die Interaktion mit jedem Pfad innerhalb dieses internen Endpunkts, indem diese Technik genutzt wird. Folglich schr√§nkt die Angabe eines Pfades in der `proxy_pass`-URL den Zugriff nicht ein.
{% endhint %}

Die Tools [**h2csmuggler von BishopFox**](https://github.com/BishopFox/h2csmuggler) und [**h2csmuggler von assetnote**](https://github.com/assetnote/h2csmuggler) erleichtern Versuche, **Proxy-gesch√ºtzte Ressourcen zu umgehen**, indem sie eine H2C-Verbindung herstellen und so den Zugriff auf durch den Proxy gesch√ºtzte Ressourcen erm√∂glichen.

F√ºr weitere Informationen zu dieser Schwachstelle, insbesondere in Bezug auf NGINX, siehe [**diese detaillierte Ressource**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Websocket Smuggling, im Gegensatz zur Erstellung eines HTTP2-Tunnels zu einem √ºber einen Proxy zug√§nglichen Endpunkt, etabliert einen Websocket-Tunnel, um potenzielle Proxy-Beschr√§nkungen zu umgehen und die direkte Kommunikation mit dem Endpunkt zu erm√∂glichen.

### Szenario 1

In diesem Szenario wird ein Backend, das eine √∂ffentliche WebSocket-API neben einer nicht zug√§nglichen internen REST-API anbietet, von einem b√∂swilligen Client angegriffen, der Zugriff auf die interne REST-API sucht. Der Angriff entfaltet sich in mehreren Schritten:

1. Der Client initiiert, indem er eine Upgrade-Anfrage an den Reverse-Proxy mit einer falschen `Sec-WebSocket-Version`-Protokollversion im Header sendet. Der Proxy, der den `Sec-WebSocket-Version`-Header nicht validiert, glaubt, dass die Upgrade-Anfrage g√ºltig ist, und leitet sie an das Backend weiter.
2. Das Backend antwortet mit einem Statuscode `426`, der die falsche Protokollversion im `Sec-WebSocket-Version`-Header anzeigt. Der Reverse-Proxy, der den Status der Backend-Antwort √ºbersieht, geht von der Bereitschaft zur WebSocket-Kommunikation aus und leitet die Antwort an den Client weiter.
3. Folglich wird der Reverse-Proxy in die Irre gef√ºhrt und glaubt, dass eine WebSocket-Verbindung zwischen dem Client und dem Backend hergestellt wurde, w√§hrend das Backend die Upgrade-Anfrage tats√§chlich abgelehnt hat. Dennoch h√§lt der Proxy eine offene TCP- oder TLS-Verbindung zwischen dem Client und dem Backend aufrecht, was dem Client ungehinderten Zugriff auf die private REST-API √ºber diese Verbindung erm√∂glicht.

Betroffene Reverse-Proxys sind Varnish, das sich weigerte, das Problem zu beheben, und Envoy-Proxy-Version 1.8.0 oder √§lter, wobei sp√§tere Versionen den Upgrade-Mechanismus ge√§ndert haben. Auch andere Proxys k√∂nnen anf√§llig sein.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Szenario 2

Dieses Szenario umfasst ein Backend mit sowohl einer √∂ffentlichen WebSocket-API als auch einer √∂ffentlichen REST-API zur Gesundheits√ºberpr√ºfung, zusammen mit einer nicht zug√§nglichen internen REST-API. Der Angriff, der komplexer ist, umfasst die folgenden Schritte:

1. Der Client sendet eine POST-Anfrage, um die Gesundheits√ºberpr√ºfungs-API auszul√∂sen, einschlie√ülich eines zus√§tzlichen HTTP-Headers `Upgrade: websocket`. NGINX, das als Reverse-Proxy fungiert, interpretiert dies als eine Standard-Upgrade-Anfrage, die ausschlie√ülich auf dem `Upgrade`-Header basiert, und √ºbersieht die anderen Aspekte der Anfrage und leitet sie an das Backend weiter.
2. Das Backend f√ºhrt die Gesundheits√ºberpr√ºfungs-API aus und kontaktiert eine externe Ressource, die vom Angreifer kontrolliert wird und eine HTTP-Antwort mit dem Statuscode `101` zur√ºckgibt. Diese Antwort, sobald sie vom Backend empfangen und an NGINX weitergeleitet wird, t√§uscht den Proxy dar√ºber hinweg, dass eine WebSocket-Verbindung aufgrund seiner Validierung nur des Statuscodes hergestellt wurde.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Warnung:** Die Komplexit√§t dieser Technik steigt, da sie die F√§higkeit erfordert, mit einem Endpunkt zu interagieren, der in der Lage ist, einen Statuscode 101 zur√ºckzugeben.

Letztendlich wird NGINX in die Irre gef√ºhrt und glaubt, dass eine WebSocket-Verbindung zwischen dem Client und dem Backend besteht. In Wirklichkeit existiert keine solche Verbindung; die Gesundheits√ºberpr√ºfungs-REST-API war das Ziel. Dennoch h√§lt der Reverse-Proxy die Verbindung offen, was dem Client den Zugriff auf die private REST-API √ºber ihn erm√∂glicht.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

Die meisten Reverse-Proxys sind anf√§llig f√ºr dieses Szenario, aber die Ausnutzung h√§ngt von der Existenz einer externen SSRF-Schwachstelle ab, die typischerweise als geringf√ºgiges Problem angesehen wird.

#### Labs

√úberpr√ºfen Sie die Labs, um beide Szenarien zu testen in [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### Referenzen

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichen.

</details>
{% endhint %}
