# YÃ¼kseltme BaÅŸlÄ±ÄŸÄ± Smuggling

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramanla Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi paylaÅŸarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶nderin**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En Ã¶nemli olan zayÄ±flÄ±klarÄ± bulun, bÃ¶ylece daha hÄ±zlÄ± dÃ¼zeltebilirsiniz. Intruder saldÄ±rÄ± yÃ¼zeyinizi takip eder, proaktif tehdit taramalarÄ± yapar, API'lerden web uygulamalarÄ±na ve bulut sistemlerine kadar tÃ¼m teknoloji yÄ±ÄŸÄ±nÄ±nÄ±zda sorunlarÄ± bulur. [**Ãœcretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugÃ¼n.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### AÃ§Ä±k Metin Ãœzerinden HTTP2 (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C veya **aÃ§Ä±k metin Ã¼zerinden http2**, geÃ§ici HTTP baÄŸlantÄ±larÄ±nÄ±n normundan saparak standart bir HTTP baÄŸlantÄ±sÄ±nÄ± sÃ¼rekli bir baÄŸlantÄ±ya yÃ¼kseltir. Bu yÃ¼kseltilmiÅŸ baÄŸlantÄ±, dÃ¼z metin HTTP'nin tek istekli doÄŸasÄ±nÄ±n aksine, sÃ¼rekli iletiÅŸim iÃ§in http2 ikili protokolÃ¼nÃ¼ kullanÄ±r.

Smuggling sorunu, bir **ters proxy** kullanÄ±mÄ±yla ortaya Ã§Ä±kar. Normalde, ters proxy HTTP isteklerini iÅŸler ve arka uca ileterek ardÄ±ndan arka uÃ§ yanÄ±tÄ±nÄ± dÃ¶ndÃ¼rÃ¼r. Ancak, bir HTTP isteÄŸinde (`Connection: Upgrade` baÅŸlÄ±ÄŸÄ± genellikle websocket baÄŸlantÄ±larÄ±yla gÃ¶rÃ¼lÃ¼r) `Connection: Upgrade` baÅŸlÄ±ÄŸÄ± bulunduÄŸunda, ters **proxy istemci ve sunucu arasÄ±nda sÃ¼rekli bir baÄŸlantÄ±** saÄŸlayarak belirli protokollerin gerektirdiÄŸi sÃ¼rekli deÄŸiÅŸimi kolaylaÅŸtÄ±rÄ±r. H2C baÄŸlantÄ±larÄ± iÃ§in, RFC'ye uyum, Ã¼Ã§ belirli baÅŸlÄ±ÄŸÄ±n varlÄ±ÄŸÄ±nÄ± gerektirir:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Zafiyet, bir baÄŸlantÄ±yÄ± yÃ¼kselttikten sonra ters proxy'nin bireysel istekleri yÃ¶netmeyi bÄ±rakmasÄ± durumunda ortaya Ã§Ä±kar ve yÃ¶nlendirme iÅŸleminin baÄŸlantÄ± kurulduktan sonra tamamlandÄ±ÄŸÄ±nÄ± varsayar. H2C Smuggling'i sÃ¶mÃ¼rmek, baÅŸarÄ±lÄ± bir H2C baÄŸlantÄ±sÄ± baÅŸlatÄ±ldÄ±ÄŸÄ±nda, istek iÅŸleme sÄ±rasÄ±nda ters proxy tarafÄ±ndan uygulanan kurallarÄ±, yani yol tabanlÄ± yÃ¶nlendirme, kimlik doÄŸrulama ve WAF iÅŸleme gibi kurallarÄ± atlamayÄ± saÄŸlar.

### Zafiyetli Proxy'ler <a href="#exploitation" id="exploitation"></a>

Zafiyet, ters proxy'nin `Upgrade` ve bazen `Connection` baÅŸlÄ±klarÄ±nÄ± nasÄ±l iÅŸlediÄŸine baÄŸlÄ±dÄ±r. AÅŸaÄŸÄ±daki proxy'ler, proxy geÃ§iÅŸi sÄ±rasÄ±nda bu baÅŸlÄ±klarÄ± doÄŸal olarak ileterek H2C smuggling'i etkinleÅŸtirir:

- HAProxy
- Traefik
- Nuster

Bununla birlikte, aÅŸaÄŸÄ±daki hizmetler, `Upgrade` ve `Connection` baÅŸlÄ±klarÄ±nÄ± doÄŸal olarak iletmemektedir. Bununla birlikte, bunlar gÃ¼vensiz bir ÅŸekilde yapÄ±landÄ±rÄ±labilir ve `Upgrade` ve `Connection` baÅŸlÄ±klarÄ±nÄ±n filtresiz bir ÅŸekilde iletilmesine izin verebilir:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### SÃ¶mÃ¼rÃ¼ <a href="#exploitation" id="exploitation"></a>

Bir uyumlu H2C baÄŸlantÄ±sÄ± yÃ¼kseltmek iÃ§in gereken baÅŸlÄ±klarÄ± doÄŸal olarak ileten tÃ¼m sunucularÄ±n olmadÄ±ÄŸÄ±nÄ± unutmamak Ã¶nemlidir. Bu nedenle, AWS ALB/CLB, NGINX ve Apache Traffic Server gibi sunucularÄ±n H2C baÄŸlantÄ±larÄ±nÄ± engellediÄŸini unutmamak Ã¶nemlidir. Bununla birlikte, standartlara uymayan `Connection: Upgrade` varyantÄ±yla test etmek de faydalÄ± olabilir, Ã§Ã¼nkÃ¼ bazÄ± arka uÃ§lar standartlara uymayabilir.

{% hint style="danger" %}
`proxy_pass` URL'sinde belirtilen belirli bir **yol** (Ã¶rneÄŸin, `http://backend:9999/socket.io`) gÃ¶z ardÄ± edilir ve kurulan baÄŸlantÄ± varsayÄ±lan olarak `http://backend:9999` olarak kabul edilir. Bu, bu teknikten yararlanarak iÃ§ uÃ§ noktadaki herhangi bir yola etkileÅŸim saÄŸlar. SonuÃ§ olarak, `proxy_pass` URL'sinde bir yol belirtmek eriÅŸimi sÄ±nÄ±rlamaz.
{% endhint %}

[**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) ve [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) araÃ§larÄ±, H2C baÄŸlantÄ±sÄ± kurarak proxy tarafÄ±ndan uygulanan korumalarÄ± atlamaya yÃ¶nelik giriÅŸimleri kolaylaÅŸtÄ±rÄ±r ve bu sayede proxy tarafÄ±ndan korunan kaynaklara eriÅŸim saÄŸlar.

NGINX hakkÄ±nda daha fazla bilgi iÃ§in [**bu ayrÄ±ntÄ±lÄ± kaynaÄŸa**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection) baÅŸvurun.

# Websocket Smuggling

Websocket smuggling, bir proxy Ã¼zerinden eriÅŸilebilen bir uca bir HTTP2 tÃ¼neli oluÅŸturmanÄ±n aksine, bir Websocket tÃ¼neli oluÅŸturarak potansiyel proxy sÄ±nÄ±rlamalarÄ±nÄ± atlamayÄ± ve uca doÄŸrudan iletiÅŸim saÄŸlamayÄ± amaÃ§lar.

## Senaryo 1

Bu senaryoda, eriÅŸilemeyen bir iÃ§ REST API yanÄ±nda halka aÃ§Ä±k bir WebSocket API sunan bir arka uÃ§, iÃ§ REST API'ye eriÅŸim saÄŸlamak isteyen kÃ¶tÃ¼ niyetli bir istemci tarafÄ±ndan hedef alÄ±nÄ±r. SaldÄ±rÄ± aÅŸaÄŸÄ±daki adÄ±mlarla gerÃ§ekleÅŸir:

1. Ä°stemci, baÅŸlÄ±kta yanlÄ±ÅŸ bir `Sec-WebSocket-Version` protokol sÃ¼rÃ¼mÃ¼ ile birlikte bir YÃ¼kseltme isteÄŸi gÃ¶ndererek baÅŸlar. Proxy, `Sec-WebSocket-Version` baÅŸlÄ±ÄŸÄ±nÄ± doÄŸrulayamadÄ±ÄŸÄ± iÃ§in YÃ¼kseltme isteÄŸini geÃ§erli olarak kabul eder ve arka uca iletilir.
2. Arka uÃ§, `Sec-WebSocket-Version` baÅŸlÄ±ÄŸÄ±ndaki yanlÄ±ÅŸ protokol sÃ¼rÃ¼mÃ¼nÃ¼ belirten `426` durum koduyla yanÄ±t verir. Ters proxy, arka uÃ§ yanÄ±t durumunu gÃ¶z ardÄ± ederek WebSocket iletiÅŸimi iÃ§in hazÄ±r olduÄŸunu varsayar ve yanÄ±tÄ± istemciye ileterek yanÄ±ltÄ±lÄ±r.
3. SonuÃ§ olarak, ters proxy, istemci ve arka uÃ§ arasÄ±nda bir WebSocket baÄŸlantÄ±sÄ± kurulduÄŸuna inanÄ±rken, aslÄ±nda arka uÃ§ YÃ¼kseltme isteÄŸini reddetmiÅŸtir. Bununla birlikte, proxy, istemci ve arka uÃ§ arasÄ±nda aÃ§Ä±k bir TCP veya TLS baÄŸlantÄ±sÄ± korur ve istemcinin bu baÄŸlantÄ± Ã¼zerinden Ã¶zel REST API'ye sÄ±nÄ±rsÄ±z eriÅŸim saÄŸlamasÄ±na olanak tanÄ±r.

Etkilenen ters proxy'ler arasÄ±nda Varnish, sorunu ele almamÄ±ÅŸtÄ±r ve Envoy proxy'nin 1.8.0 veya daha eski sÃ¼rÃ¼mleri, daha sonraki sÃ¼rÃ¼mlerde yÃ¼kseltme mekanizmasÄ±nÄ± deÄŸiÅŸtirdiÄŸi iÃ§in etkilenir. DiÄŸer proxy'ler de etkilenebilir.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Senaryo 2

Bu senaryo, halka aÃ§Ä±k bir WebSocket API ve saÄŸlÄ±k kontrolÃ¼ iÃ§in halka aÃ§Ä±k bir REST API'ye sahip bir arka uÃ§ ile eriÅŸilemeyen bir iÃ§ REST API'ye sahip bir arka uÃ§ iÃ§erir. Daha karmaÅŸÄ±k olan saldÄ±rÄ± aÅŸaÄŸÄ±daki adÄ±mlarÄ± iÃ§erir:

1. Ä°stemci, bir POST isteÄŸi gÃ¶ndererek saÄŸlÄ±k kontrolÃ¼ API'sini tetikler ve ek bir HTTP baÅŸlÄ±ÄŸÄ± olan `Upgrade: websocket`'i iÃ§erir. Ters proxy olarak hizmet veren NGINX, yalnÄ±zca `Upgrade` baÅŸlÄ±ÄŸÄ±na dayanarak bu isteÄŸi standart bir YÃ¼kseltme isteÄŸi olarak yorumlar ve isteÄŸin diÄŸer yÃ¶nlerini gÃ¶z ardÄ± eder ve arka uca iletilir.
2. Arka uÃ§, saÄŸlÄ±k kontrolÃ¼ API'sini yÃ¼rÃ¼tÃ¼rken, saldÄ±rgan tarafÄ±ndan kontrol edilen bir dÄ±ÅŸ kaynaÄŸa ulaÅŸan bir HTTP yanÄ±tÄ±yla `101` durum kodunu dÃ¶ndÃ¼rÃ¼r. Bu yanÄ±t, arka uÃ§ tarafÄ±ndan alÄ±ndÄ±ÄŸÄ±nda ve NGINX'e iletilirken, yalnÄ±zca durum kodunu doÄŸruladÄ±ÄŸÄ± iÃ§in proxy'yi WebSocket baÄŸlantÄ±sÄ± kurulmuÅŸ gibi yanÄ±ltÄ±r.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **UyarÄ±:** Bu teknik, bir status kodu 101 dÃ¶ndÃ¼rebilen bir uca etkileÅŸim saÄŸlama yeteneÄŸini gerektirdiÄŸi iÃ§in karmaÅŸÄ±klÄ±ÄŸÄ± artÄ±rÄ±r.

SonuÃ§ olarak, NGINX, istemci ve arka uÃ§ arasÄ±nda bir WebSocket baÄŸlantÄ±sÄ± olduÄŸuna inanÄ±r. AslÄ±nda bÃ¶yle bir baÄŸlantÄ± yoktur; saÄŸlÄ±k kontrolÃ¼ REST API'si hedef alÄ±nmÄ±ÅŸtÄ±r. Bununla birlikte, ters proxy baÄŸlantÄ±yÄ± aÃ§Ä±k tutar ve istemcinin bu baÄŸlantÄ± Ã¼zerinden Ã¶zel REST API'ye er
