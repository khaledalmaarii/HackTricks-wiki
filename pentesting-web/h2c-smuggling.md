# Upgrade Header Smuggling

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 Over Cleartext (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, ou **http2 sobre texto claro**, desvia da norma das conex√µes HTTP transit√≥rias ao atualizar uma **conex√£o HTTP padr√£o para uma persistente**. Esta conex√£o atualizada utiliza o protocolo bin√°rio http2 para comunica√ß√£o cont√≠nua, ao contr√°rio da natureza de solicita√ß√£o √∫nica do HTTP em texto claro.

O cerne do problema de smuggling surge com o uso de um **proxy reverso**. Normalmente, o proxy reverso processa e encaminha solicita√ß√µes HTTP para o backend, retornando a resposta do backend ap√≥s isso. No entanto, quando o cabe√ßalho `Connection: Upgrade` est√° presente em uma solicita√ß√£o HTTP (comumente visto com conex√µes websocket), o **proxy reverso mant√©m uma conex√£o persistente** entre cliente e servidor, facilitando a troca cont√≠nua exigida por certos protocolos. Para conex√µes H2C, a ades√£o ao RFC exige a presen√ßa de tr√™s cabe√ßalhos espec√≠ficos:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
A vulnerabilidade surge quando, ap√≥s a atualiza√ß√£o de uma conex√£o, o proxy reverso deixa de gerenciar solicita√ß√µes individuais, assumindo que seu trabalho de roteamento est√° completo ap√≥s o estabelecimento da conex√£o. Explorar H2C Smuggling permite contornar as regras do proxy reverso aplicadas durante o processamento de solicita√ß√µes, como roteamento baseado em caminho, autentica√ß√£o e processamento de WAF, assumindo que uma conex√£o H2C √© iniciada com sucesso.

#### Proxies Vulner√°veis <a href="#exploitation" id="exploitation"></a>

A vulnerabilidade depende do manuseio dos cabe√ßalhos `Upgrade` e, √†s vezes, `Connection` pelo proxy reverso. Os seguintes proxies encaminham esses cabe√ßalhos durante o proxy-pass, permitindo assim o H2C smuggling:

* HAProxy
* Traefik
* Nuster

Por outro lado, esses servi√ßos n√£o encaminham inherentemente ambos os cabe√ßalhos durante o proxy-pass. No entanto, eles podem ser configurados de forma insegura, permitindo o encaminhamento n√£o filtrado dos cabe√ßalhos `Upgrade` e `Connection`:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### Explora√ß√£o <a href="#exploitation" id="exploitation"></a>

√â crucial notar que nem todos os servidores encaminham inherentemente os cabe√ßalhos necess√°rios para uma atualiza√ß√£o de conex√£o H2C compat√≠vel. Assim, servidores como AWS ALB/CLB, NGINX e Apache Traffic Server, entre outros, bloqueiam naturalmente conex√µes H2C. No entanto, vale a pena testar com a variante n√£o compat√≠vel `Connection: Upgrade`, que exclui o valor `HTTP2-Settings` do cabe√ßalho `Connection`, j√° que alguns backends podem n√£o estar em conformidade com os padr√µes.

{% hint style="danger" %}
Independentemente do **caminho** espec√≠fico designado na URL `proxy_pass` (por exemplo, `http://backend:9999/socket.io`), a conex√£o estabelecida padr√£o √© `http://backend:9999`. Isso permite a intera√ß√£o com qualquer caminho dentro desse endpoint interno, aproveitando essa t√©cnica. Consequentemente, a especifica√ß√£o de um caminho na URL `proxy_pass` n√£o restringe o acesso.
{% endhint %}

As ferramentas [**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) e [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) facilitam tentativas de **contornar as prote√ß√µes impostas pelo proxy** ao estabelecer uma conex√£o H2C, permitindo assim o acesso a recursos protegidos pelo proxy.

Para mais informa√ß√µes sobre essa vulnerabilidade, particularmente em rela√ß√£o ao NGINX, consulte [**este recurso detalhado**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Websocket smuggling, ao contr√°rio da cria√ß√£o de um t√∫nel HTTP2 para um endpoint acess√≠vel via um proxy, estabelece um t√∫nel Websocket para contornar potenciais limita√ß√µes do proxy e facilitar a comunica√ß√£o direta com o endpoint.

### Cen√°rio 1

Neste cen√°rio, um backend que oferece uma API WebSocket p√∫blica juntamente com uma API REST interna inacess√≠vel √© alvo de um cliente malicioso que busca acesso √† API REST interna. O ataque se desenrola em v√°rias etapas:

1. O cliente inicia enviando uma solicita√ß√£o Upgrade para o proxy reverso com uma vers√£o de protocolo `Sec-WebSocket-Version` incorreta no cabe√ßalho. O proxy, n√£o validando o cabe√ßalho `Sec-WebSocket-Version`, acredita que a solicita√ß√£o Upgrade √© v√°lida e a encaminha para o backend.
2. O backend responde com um c√≥digo de status `426`, indicando a vers√£o de protocolo incorreta no cabe√ßalho `Sec-WebSocket-Version`. O proxy reverso, ignorando o status de resposta do backend, assume que est√° pronto para comunica√ß√£o WebSocket e retransmite a resposta ao cliente.
3. Consequentemente, o proxy reverso √© induzido a acreditar que uma conex√£o WebSocket foi estabelecida entre o cliente e o backend, enquanto na realidade, o backend havia rejeitado a solicita√ß√£o Upgrade. Apesar disso, o proxy mant√©m uma conex√£o TCP ou TLS aberta entre o cliente e o backend, permitindo que o cliente acesse sem restri√ß√µes a API REST privada atrav√©s dessa conex√£o.

Os proxies reversos afetados incluem Varnish, que se recusou a abordar o problema, e a vers√£o 1.8.0 ou anterior do proxy Envoy, com vers√µes posteriores tendo alterado o mecanismo de atualiza√ß√£o. Outros proxies tamb√©m podem ser suscet√≠veis.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Cen√°rio 2

Este cen√°rio envolve um backend com uma API WebSocket p√∫blica e uma API REST p√∫blica para verifica√ß√£o de sa√∫de, juntamente com uma API REST interna inacess√≠vel. O ataque, mais complexo, envolve as seguintes etapas:

1. O cliente envia uma solicita√ß√£o POST para acionar a API de verifica√ß√£o de sa√∫de, incluindo um cabe√ßalho HTTP adicional `Upgrade: websocket`. O NGINX, atuando como o proxy reverso, interpreta isso como uma solicita√ß√£o de Upgrade padr√£o com base apenas no cabe√ßalho `Upgrade`, negligenciando outros aspectos da solicita√ß√£o, e a encaminha para o backend.
2. O backend executa a API de verifica√ß√£o de sa√∫de, contatando um recurso externo controlado pelo atacante que retorna uma resposta HTTP com c√≥digo de status `101`. Essa resposta, uma vez recebida pelo backend e encaminhada para o NGINX, engana o proxy, fazendo-o pensar que uma conex√£o WebSocket foi estabelecida devido √† sua valida√ß√£o apenas do c√≥digo de status.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Aviso:** A complexidade dessa t√©cnica aumenta √† medida que requer a capacidade de interagir com um endpoint capaz de retornar um c√≥digo de status 101.

No final, o NGINX √© enganado a acreditar que uma conex√£o WebSocket existe entre o cliente e o backend. Na realidade, nenhuma conex√£o desse tipo existe; a API REST de verifica√ß√£o de sa√∫de foi o alvo. No entanto, o proxy reverso mant√©m a conex√£o aberta, permitindo que o cliente acesse a API REST privada atrav√©s dela.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

A maioria dos proxies reversos √© vulner√°vel a esse cen√°rio, mas a explora√ß√£o depende da presen√ßa de uma vulnerabilidade SSRF externa, geralmente considerada um problema de baixa severidade.

#### Labs

Verifique os labs para testar ambos os cen√°rios em [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### Refer√™ncias

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
