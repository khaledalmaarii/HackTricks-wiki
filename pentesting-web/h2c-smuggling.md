# Aktualizacja Przemytu Nag贸wka

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Przemyt H2C <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 nad Czystym Tekstem (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, czyli **http2 nad czystym tekstem**, odbiega od normy tymczasowych pocze HTTP, aktualizujc standardowe poczenie HTTP **do trwaego**. To zaktualizowane poczenie wykorzystuje binarny protok贸 http2 do cigej komunikacji, w przeciwiestwie do jednorazowego charakteru protokou HTTP w postaci tekstu.

Rdze problemu przemytu pojawia si przy u偶yciu **serwera proxy odwrotnego**. Zazwyczaj serwer proxy odwrotny przetwarza i przekazuje 偶dania HTTP do backendu, zwracajc odpowied藕 backendu po tym. Jednak gdy nag贸wek `Connection: Upgrade` jest obecny w 偶daniu HTTP (czsto widziany w poczeniach websocket), serwer **proxy utrzymuje trwae poczenie** midzy klientem a serwerem, uatwiajc cig wymian wymagan przez pewne protokoy. Dla pocze H2C, zgodno z RFC wymaga obecnoci trzech konkretnych nag贸wk贸w:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
### Nara偶enie na ryzyko <a href="#exploitation" id="exploitation"></a>

Podatno pojawia si, gdy po zaktualizowaniu poczenia, odwrotny proxy przestaje zarzdza poszczeg贸lnymi 偶daniami, zakadajc, 偶e jego zadanie routingu jest zakoczone po ustanowieniu poczenia. Wykorzystanie H2C Smuggling pozwala na obejcie regu odwrotnego proxy stosowanych podczas przetwarzania 偶dania, takich jak routowanie oparte na cie偶ce, uwierzytelnianie i przetwarzanie WAF, zakadajc, 偶e poczenie H2C zostao pomylnie zainicjowane.

### Nara偶one Proksy <a href="#exploitation" id="exploitation"></a>

Podatno zale偶y od obsugi przez odwrotne proxy nag贸wk贸w `Upgrade` i czasami `Connection`. Nastpujce proksy z natury przekazuj te nag贸wki podczas przekazywania proxy-pass, co z natury umo偶liwia H2C smuggling:

- HAProxy
- Traefik
- Nuster

Z kolei te usugi z natury nie przekazuj obu nag贸wk贸w podczas przekazywania proxy-pass. Jednak偶e mog by skonfigurowane w spos贸b niebezpieczny, umo偶liwiajc niefiltrowane przekazywanie nag贸wk贸w `Upgrade` i `Connection`:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### Wykorzystanie <a href="#exploitation" id="exploitation"></a>

Nale偶y zauwa偶y, 偶e nie wszystkie serwery z natury przekazuj wymagane nag贸wki do zgodnej aktualizacji poczenia H2C. Dlatego serwery takie jak AWS ALB/CLB, NGINX i Apache Traffic Server, midzy innymi, naturalnie blokuj poczenia H2C. Niemniej warto przetestowa z niezgodn wersj `Connection: Upgrade`, kt贸ra wyklucza warto `HTTP2-Settings` z nag贸wka `Connection`, poniewa偶 niekt贸re backendy mog nie by zgodne ze standardami.

{% hint style="danger" %}
Niezale偶nie od okrelonej **cie偶ki** w adresie URL `proxy_pass` (np. `http://backend:9999/socket.io`), ustanowione poczenie domylnie przekierowuje do `http://backend:9999`. Pozwala to na interakcj z dowoln cie偶k wewntrz tego wewntrznego punktu kocowego, wykorzystujc t technik. W rezultacie okrelenie cie偶ki w adresie URL `proxy_pass` nie ogranicza dostpu.
{% endhint %}

Narzdzia [**h2csmuggler od BishopFox**](https://github.com/BishopFox/h2csmuggler) i [**h2csmuggler od assetnote**](https://github.com/assetnote/h2csmuggler) uatwiaj pr贸by **obejcia narzuconych przez proxy zabezpiecze** poprzez ustanowienie poczenia H2C, umo偶liwiajc dostp do zasob贸w zabezpieczonych przez proxy.

Aby uzyska dodatkowe informacje na temat tej podatnoci, szczeg贸lnie dotyczce NGINX, zapoznaj si z [**tym szczeg贸owym 藕r贸dem**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).
