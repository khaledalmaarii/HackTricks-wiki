# Cookies Hacking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Atributos de Cookies

Las cookies vienen con varios atributos que controlan su comportamiento en el navegador del usuario. Aqu칤 hay un resumen de estos atributos en una voz m치s pasiva:

### Expires y Max-Age

La fecha de caducidad de una cookie se determina por el atributo `Expires`. Por el contrario, el atributo `Max-age` define el tiempo en segundos hasta que se elimina una cookie. **Opta por `Max-age` ya que refleja pr치cticas m치s modernas.**

### Dominio

Los hosts que recibir치n una cookie se especifican mediante el atributo `Domain`. Por defecto, esto se establece en el host que emiti칩 la cookie, sin incluir sus subdominios. Sin embargo, cuando el atributo `Domain` se establece expl칤citamente, abarca tambi칠n los subdominios. Esto hace que la especificaci칩n del atributo `Domain` sea una opci칩n menos restrictiva, 칰til para escenarios donde compartir cookies entre subdominios es necesario. Por ejemplo, establecer `Domain=mozilla.org` hace que las cookies sean accesibles en sus subdominios como `developer.mozilla.org`.

### Ruta

Un camino de URL espec칤fico que debe estar presente en la URL solicitada para que se env칤e el encabezado `Cookie` se indica mediante el atributo `Path`. Este atributo considera el car치cter `/` como un separador de directorios, permitiendo coincidencias en subdirectorios tambi칠n.

### Reglas de Ordenaci칩n

Cuando dos cookies tienen el mismo nombre, la que se elige para enviar se basa en:

* La cookie que coincide con la ruta m치s larga en la URL solicitada.
* La cookie establecida m치s recientemente si las rutas son id칠nticas.

### SameSite

* El atributo `SameSite` dicta si las cookies se env칤an en solicitudes que provienen de dominios de terceros. Ofrece tres configuraciones:
* **Strict**: Restringe el env칤o de la cookie en solicitudes de terceros.
* **Lax**: Permite que la cookie se env칤e con solicitudes GET iniciadas por sitios web de terceros.
* **None**: Permite que la cookie se env칤e desde cualquier dominio de terceros.

Recuerda, al configurar cookies, entender estos atributos puede ayudar a garantizar que se comporten como se espera en diferentes escenarios.

| **Tipo de Solicitud** | **C칩digo de Ejemplo**                   | **Cookies Enviadas Cuando** |
| --------------------- | --------------------------------------- | ---------------------------- |
| Enlace                | \<a href="...">\</a>                   | NotSet\*, Lax, None          |
| Prerender             | \<link rel="prerender" href=".."/>     | NotSet\*, Lax, None          |
| Formulario GET        | \<form method="GET" action="...">      | NotSet\*, Lax, None          |
| Formulario POST       | \<form method="POST" action="...">     | NotSet\*, None               |
| iframe                | \<iframe src="...">\</iframe>           | NotSet\*, None               |
| AJAX                  | $.get("...")                            | NotSet\*, None               |
| Imagen                | \<img src="...">                        | NetSet\*, None               |

Tabla de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) y ligeramente modificada.\
Una cookie con el atributo _**SameSite**_ **mitigar치 ataques CSRF** donde se necesita una sesi칩n iniciada.

**\*Ten en cuenta que desde Chrome80 (feb/2019) el comportamiento predeterminado de una cookie sin un atributo SameSite** **ser치 lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Ten en cuenta que temporalmente, despu칠s de aplicar este cambio, las **cookies sin una pol칤tica SameSite** **en Chrome ser치n** **tratadas como None** durante los **primeros 2 minutos y luego como Lax para solicitudes POST de nivel superior entre sitios.**

## Banderas de Cookies

### HttpOnly

Esto evita que el **cliente** acceda a la cookie (a trav칠s de **Javascript**, por ejemplo: `document.cookie`)

#### **Evasiones**

* Si la p치gina est치 **enviando las cookies como respuesta** a una solicitud (por ejemplo, en una p치gina **PHPinfo**), es posible abusar de la XSS para enviar una solicitud a esta p치gina y **robar las cookies** de la respuesta (ver un ejemplo en [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Esto podr칤a ser evadido con solicitudes **TRACE** **HTTP** ya que la respuesta del servidor (si este m칠todo HTTP est치 disponible) reflejar치 las cookies enviadas. Esta t칠cnica se llama **Cross-Site Tracking**.
* Esta t칠cnica es evitada por **navegadores modernos al no permitir el env칤o de una solicitud TRACE** desde JS. Sin embargo, se han encontrado algunas evasiones en software espec칤fico como enviar `\r\nTRACE` en lugar de `TRACE` a IE6.0 SP2.
* Otra forma es la explotaci칩n de vulnerabilidades de d칤a cero en los navegadores.
* Es posible **sobrescribir cookies HttpOnly** realizando un ataque de desbordamiento de Cookie Jar:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Es posible usar un ataque de [**Cookie Smuggling**](./#cookie-smuggling) para exfiltrar estas cookies

### Seguro

La solicitud **solo** enviar치 la cookie en una solicitud HTTP solo si la solicitud se transmite a trav칠s de un canal seguro (t칤picamente **HTTPS**).

## Prefijos de Cookies

Las cookies con el prefijo `__Secure-` deben establecerse junto con la bandera `secure` de p치ginas que est치n aseguradas por HTTPS.

Para las cookies con el prefijo `__Host-`, se deben cumplir varias condiciones:

* Deben establecerse con la bandera `secure`.
* Deben originarse de una p치gina asegurada por HTTPS.
* Se les proh칤be especificar un dominio, lo que impide su transmisi칩n a subdominios.
* La ruta para estas cookies debe establecerse en `/`.

Es importante tener en cuenta que las cookies con el prefijo `__Host-` no pueden enviarse a superdominios o subdominios. Esta restricci칩n ayuda a aislar las cookies de la aplicaci칩n. Por lo tanto, emplear el prefijo `__Host-` para todas las cookies de la aplicaci칩n puede considerarse una buena pr치ctica para mejorar la seguridad y el aislamiento.

### Sobrescribiendo cookies

As칤, una de las protecciones de las cookies con prefijo `__Host-` es evitar que sean sobrescritas desde subdominios. Previniendo, por ejemplo, [**ataques de Cookie Tossing**](cookie-tossing.md). En la charla [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg) ([**paper**](https://www.usenix.org/system/files/usenixsecurity23-squarcina.pdf)) se presenta que era posible establecer cookies con prefijo \_\_HOST- desde un subdominio, enga침ando al analizador, por ejemplo, a침adiendo "=" al principio o al final...:

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

O en PHP era posible a침adir **otros caracteres al principio** del nombre de la cookie que iban a ser **reemplazados por caracteres de subrayado**, permitiendo sobrescribir cookies `__HOST-`:

<figure><img src="../../.gitbook/assets/image (7) (1).png" alt="" width="373"><figcaption></figcaption></figure>

## Ataques de Cookies

Si una cookie personalizada contiene datos sensibles, rev칤sala (especialmente si est치s participando en un CTF), ya que podr칤a ser vulnerable.

### Decodificaci칩n y Manipulaci칩n de Cookies

Los datos sensibles incrustados en las cookies siempre deben ser examinados. Las cookies codificadas en Base64 o formatos similares a menudo pueden ser decodificadas. Esta vulnerabilidad permite a los atacantes alterar el contenido de la cookie e impersonar a otros usuarios codificando sus datos modificados de nuevo en la cookie.

### Secuestro de Sesi칩n

Este ataque implica robar la cookie de un usuario para obtener acceso no autorizado a su cuenta dentro de una aplicaci칩n. Al usar la cookie robada, un atacante puede hacerse pasar por el usuario leg칤timo.

### Fijaci칩n de Sesi칩n

En este escenario, un atacante enga침a a una v칤ctima para que use una cookie espec칤fica para iniciar sesi칩n. Si la aplicaci칩n no asigna una nueva cookie al iniciar sesi칩n, el atacante, que posee la cookie original, puede hacerse pasar por la v칤ctima. Esta t칠cnica se basa en que la v칤ctima inicie sesi칩n con una cookie proporcionada por el atacante.

Si encontraste un **XSS en un subdominio** o **controlas un subdominio**, lee:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Donaci칩n de Sesi칩n

Aqu칤, el atacante convence a la v칤ctima para que use la cookie de sesi칩n del atacante. La v칤ctima, creyendo que ha iniciado sesi칩n en su propia cuenta, realizar치 inadvertidamente acciones en el contexto de la cuenta del atacante.

Si encontraste un **XSS en un subdominio** o **controlas un subdominio**, lee:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookies JWT](../hacking-jwt-json-web-tokens.md)

Haz clic en el enlace anterior para acceder a una p치gina que explica posibles fallas en JWT.

Los JSON Web Tokens (JWT) utilizados en cookies tambi칠n pueden presentar vulnerabilidades. Para obtener informaci칩n detallada sobre posibles fallas y c칩mo explotarlas, se recomienda acceder al documento vinculado sobre el hacking de JWT.

### Cross-Site Request Forgery (CSRF)

Este ataque obliga a un usuario autenticado a ejecutar acciones no deseadas en una aplicaci칩n web en la que actualmente est치 autenticado. Los atacantes pueden explotar cookies que se env칤an autom치ticamente con cada solicitud al sitio vulnerable.

### Cookies Vac칤as

(Revisa m치s detalles en la [investigaci칩n original](https://blog.ankursundara.com/cookie-bugs/)) Los navegadores permiten la creaci칩n de cookies sin un nombre, lo que se puede demostrar a trav칠s de JavaScript de la siguiente manera:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
El resultado en el encabezado de la cookie enviada es `a=v1; test value; b=v2;`. Intrigantemente, esto permite la manipulaci칩n de cookies si se establece una cookie con un nombre vac칤o, potencialmente controlando otras cookies al establecer la cookie vac칤a a un valor espec칤fico:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
Esto lleva a que el navegador env칤e un encabezado de cookie interpretado por cada servidor web como una cookie llamada `a` con un valor `b`.

#### Error de Chrome: Problema de C칩digo de Sustituci칩n Unicode

En Chrome, si un c칩digo de sustituci칩n Unicode es parte de una cookie establecida, `document.cookie` se corrompe, devolviendo una cadena vac칤a posteriormente:
```js
document.cookie = "\ud800=meep";
```
Esto resulta en que `document.cookie` devuelve una cadena vac칤a, lo que indica una corrupci칩n permanente.

#### Cookie Smuggling Debido a Problemas de An치lisis

(Revisa m치s detalles en la [investigaci칩n original](https://blog.ankursundara.com/cookie-bugs/)) Varios servidores web, incluidos los de Java (Jetty, TomCat, Undertow) y Python (Zope, cherrypy, web.py, aiohttp, bottle, webob), manejan incorrectamente las cadenas de cookies debido al soporte obsoleto de RFC2965. Lee un valor de cookie entre comillas dobles como un solo valor, incluso si incluye puntos y comas, que normalmente deber칤an separar pares clave-valor:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Vulnerabilidades de Inyecci칩n de Cookies

(Revisa m치s detalles en la [investigaci칩n original](https://blog.ankursundara.com/cookie-bugs/)) El an치lisis incorrecto de cookies por parte de los servidores, notablemente Undertow, Zope y aquellos que utilizan `http.cookie.SimpleCookie` y `http.cookie.BaseCookie` de Python, crea oportunidades para ataques de inyecci칩n de cookies. Estos servidores no delimitan adecuadamente el inicio de nuevas cookies, permitiendo a los atacantes suplantar cookies:

* Undertow espera una nueva cookie inmediatamente despu칠s de un valor entre comillas sin un punto y coma.
* Zope busca una coma para comenzar a analizar la siguiente cookie.
* Las clases de cookies de Python comienzan a analizar en un car치cter de espacio.

Esta vulnerabilidad es particularmente peligrosa en aplicaciones web que dependen de la protecci칩n CSRF basada en cookies, ya que permite a los atacantes inyectar cookies de token CSRF suplantadas, potencialmente eludiendo medidas de seguridad. El problema se agrava por el manejo de nombres de cookies duplicados en Python, donde la 칰ltima ocurrencia anula las anteriores. Tambi칠n plantea preocupaciones para las cookies `__Secure-` y `__Host-` en contextos inseguros y podr칤a llevar a eludir autorizaciones cuando las cookies se env칤an a servidores de back-end susceptibles a suplantaci칩n.

### Comprobaciones de Cookies Extra Vulnerables

#### **Comprobaciones b치sicas**

* La **cookie** es la **misma** cada vez que **inicias sesi칩n**.
* Cierra sesi칩n e intenta usar la misma cookie.
* Intenta iniciar sesi칩n con 2 dispositivos (o navegadores) en la misma cuenta usando la misma cookie.
* Verifica si la cookie tiene alguna informaci칩n y trata de modificarla.
* Intenta crear varias cuentas con nombres de usuario casi id칠nticos y verifica si puedes ver similitudes.
* Revisa la opci칩n de "**recordarme**" si existe para ver c칩mo funciona. Si existe y podr칤a ser vulnerable, siempre usa la cookie de **recordarme** sin ninguna otra cookie.
* Verifica si la cookie anterior funciona incluso despu칠s de cambiar la contrase침a.

#### **Ataques avanzados a cookies**

Si la cookie permanece igual (o casi) cuando inicias sesi칩n, esto probablemente significa que la cookie est치 relacionada con alg칰n campo de tu cuenta (probablemente el nombre de usuario). Entonces puedes:

* Intentar crear muchas **cuentas** con nombres de usuario muy **similares** y tratar de **adivinar** c칩mo est치 funcionando el algoritmo.
* Intentar **fuerza bruta al nombre de usuario**. Si la cookie se guarda solo como un m칠todo de autenticaci칩n para tu nombre de usuario, entonces puedes crear una cuenta con el nombre de usuario "**Bmin**" y **fuerza bruta** cada **bit** de tu cookie porque una de las cookies que intentar치s ser치 la que pertenece a "**admin**".
* Intentar **Padding** **Oracle** (puedes descifrar el contenido de la cookie). Usa **padbuster**.

**Padding Oracle - Ejemplos de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster har치 varios intentos y te preguntar치 cu치l es la condici칩n de error (la que no es v치lida).

Luego comenzar치 a descifrar la cookie (puede tardar varios minutos)

Si el ataque se ha realizado con 칠xito, entonces podr칤as intentar cifrar una cadena de tu elecci칩n. Por ejemplo, si quisieras **encrypt** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Esta ejecuci칩n te dar치 la cookie correctamente cifrada y codificada con la cadena **user=administrator** dentro.

**CBC-MAC**

Tal vez una cookie podr칤a tener alg칰n valor y podr칤a ser firmada usando CBC. Entonces, la integridad del valor es la firma creada utilizando CBC con el mismo valor. Como se recomienda usar como IV un vector nulo, este tipo de verificaci칩n de integridad podr칤a ser vulnerable.

**El ataque**

1. Obtener la firma del nombre de usuario **administ** = **t**
2. Obtener la firma del nombre de usuario **rator\x00\x00\x00 XOR t** = **t'**
3. Establecer en la cookie el valor **administrator+t'** (**t'** ser치 una firma v치lida de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Si la cookie est치 cifrada usando ECB podr칤a ser vulnerable.\
Cuando inicias sesi칩n, la cookie que recibes tiene que ser siempre la misma.

**C칩mo detectar y atacar:**

Crea 2 usuarios con casi los mismos datos (nombre de usuario, contrase침a, correo electr칩nico, etc.) y trata de descubrir alg칰n patr칩n dentro de la cookie dada.

Crea un usuario llamado, por ejemplo, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" y verifica si hay alg칰n patr칩n en la cookie (como ECB cifra con la misma clave cada bloque, los mismos bytes cifrados podr칤an aparecer si el nombre de usuario est치 cifrado).

Deber칤a haber un patr칩n (con el tama침o de un bloque utilizado). Entonces, sabiendo c칩mo se cifran un mont칩n de "a", puedes crear un nombre de usuario: "a"\*(tama침o del bloque)+"admin". Luego, podr칤as eliminar el patr칩n cifrado de un bloque de "a" de la cookie. Y tendr치s la cookie del nombre de usuario "admin".

## Referencias

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
