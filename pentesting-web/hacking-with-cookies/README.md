# Cookies Hacking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Cookie Attributes

Cookies maj kilka atrybut贸w, kt贸re kontroluj ich zachowanie w przegldarce u偶ytkownika. Oto przegld tych atrybut贸w w bardziej pasywnej formie:

### Expires and Max-Age

Data wyganicia ciasteczka jest okrelona przez atrybut `Expires`. Z kolei atrybut `Max-age` definiuje czas w sekundach, po kt贸rym ciasteczko zostanie usunite. **Wybierz `Max-age`, poniewa偶 odzwierciedla to nowoczeniejsze praktyki.**

### Domain

Hosty, kt贸re maj otrzyma ciasteczko, s okrelone przez atrybut `Domain`. Domylnie jest to ustawione na hosta, kt贸ry wyda ciasteczko, nie obejmujc jego subdomen. Jednak gdy atrybut `Domain` jest wyra藕nie ustawiony, obejmuje r贸wnie偶 subdomeny. To sprawia, 偶e specyfikacja atrybutu `Domain` jest mniej restrykcyjn opcj, przydatn w scenariuszach, gdzie konieczne jest udostpnianie ciasteczek midzy subdomenami. Na przykad, ustawienie `Domain=mozilla.org` sprawia, 偶e ciasteczka s dostpne na jego subdomenach, takich jak `developer.mozilla.org`.

### Path

Atrybut `Path` wskazuje konkretn cie偶k URL, kt贸ra musi by obecna w 偶danym URL, aby nag贸wek `Cookie` zosta wysany. Atrybut ten traktuje znak `/` jako separator katalog贸w, co pozwala na dopasowania w podkatalogach.

### Ordering Rules

Gdy dwa ciasteczka maj t sam nazw, wyb贸r ciasteczka do wysania opiera si na:

* Ciasteczku pasujcym do najdu偶szej cie偶ki w 偶danym URL.
* Najnowszym ustawionym ciasteczku, jeli cie偶ki s identyczne.

### SameSite

* Atrybut `SameSite` okrela, czy ciasteczka s wysyane w 偶daniach pochodzcych z domen trzecich. Oferuje trzy ustawienia:
* **Strict**: Ogranicza wysyanie ciasteczka w 偶daniach z domen trzecich.
* **Lax**: Pozwala na wysyanie ciasteczka z 偶daniami GET inicjowanymi przez strony trzecie.
* **None**: Zezwala na wysyanie ciasteczka z dowolnej domeny trzeciej.

Pamitaj, 偶e podczas konfigurowania ciasteczek zrozumienie tych atrybut贸w mo偶e pom贸c zapewni, 偶e bd dziaa zgodnie z oczekiwaniami w r贸偶nych scenariuszach.

| **Request Type** | **Example Code**                   | **Cookies Sent When** |
| ---------------- | ---------------------------------- | --------------------- |
| Link             | \<a href="...">\</a>               | NotSet\*, Lax, None   |
| Prerender        | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None   |
| Form GET         | \<form method="GET" action="...">  | NotSet\*, Lax, None   |
| Form POST        | \<form method="POST" action="..."> | NotSet\*, None        |
| iframe           | \<iframe src="...">\</iframe>      | NotSet\*, None        |
| AJAX             | $.get("...")                       | NotSet\*, None        |
| Image            | \<img src="...">                   | NetSet\*, None        |

Tabela z [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) i nieco zmodyfikowana.\
Ciasteczko z atrybutem _**SameSite**_ **agodzi ataki CSRF**, gdzie potrzebna jest zalogowana sesja.

**\*Zauwa偶, 偶e od Chrome80 (lut/2019) domylne zachowanie ciasteczka bez atrybutu cookie samesite** **bdzie lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Zauwa偶, 偶e tymczasowo, po zastosowaniu tej zmiany, **ciasteczka bez polityki SameSite** **w Chrome bd** **traktowane jako None** przez **pierwsze 2 minuty, a nastpnie jako Lax dla g贸wnych 偶da POST midzy witrynami.**

## Cookies Flags

### HttpOnly

To uniemo偶liwia **klientowi** dostp do ciasteczka (np. za pomoc **Javascript**: `document.cookie`)

#### **Bypasses**

* Jeli strona **wysya ciasteczka jako odpowied藕** na 偶dania (na przykad na stronie **PHPinfo**), mo偶na wykorzysta XSS, aby wysa 偶danie do tej strony i **ukra ciasteczka** z odpowiedzi (sprawd藕 przykad w [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Mo偶na to obej za pomoc **TRACE** **HTTP** 偶da, poniewa偶 odpowied藕 z serwera (jeli ta metoda HTTP jest dostpna) odzwierciedli wysane ciasteczka. Ta technika nazywa si **Cross-Site Tracking**.
* Ta technika jest unikan przez **nowoczesne przegldarki, kt贸re nie pozwalaj na wysyanie 偶dania TRACE** z JS. Jednak w niekt贸rych oprogramowaniach znaleziono obejcia, takie jak wysyanie `\r\nTRACE` zamiast `TRACE` do IE6.0 SP2.
* Innym sposobem jest wykorzystanie luk zero-day w przegldarkach.
* Mo偶liwe jest **nadpisanie ciasteczek HttpOnly** poprzez przeprowadzenie ataku Cookie Jar overflow:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Mo偶liwe jest u偶ycie ataku [**Cookie Smuggling**](./#cookie-smuggling) do eksfiltracji tych ciasteczek.

### Secure

呕danie **wyle** ciasteczko tylko w 偶daniu HTTP, jeli 偶danie jest przesyane przez bezpieczny kana (zazwyczaj **HTTPS**).

## Cookies Prefixes

Ciasteczka z prefiksem `__Secure-` musz by ustawione wraz z flag `secure` z stron, kt贸re s zabezpieczone przez HTTPS.

Dla ciasteczek z prefiksem `__Host-` musi by spenionych kilka warunk贸w:

* Musz by ustawione z flag `secure`.
* Musz pochodzi z strony zabezpieczonej przez HTTPS.
* Zabrania si okrelania domeny, co uniemo偶liwia ich przesyanie do subdomen.
* cie偶ka dla tych ciasteczek musi by ustawiona na `/`.

Wa偶ne jest, aby zauwa偶y, 偶e ciasteczka z prefiksem `__Host-` nie mog by wysyane do superdomen ani subdomen. To ograniczenie pomaga w izolacji ciasteczek aplikacji. Dlatego stosowanie prefiksu `__Host-` dla wszystkich ciasteczek aplikacji mo偶na uzna za dobr praktyk w celu zwikszenia bezpieczestwa i izolacji.

### Overwriting cookies

Jednym z zabezpiecze ciasteczek z prefiksem `__Host-` jest zapobieganie ich nadpisywaniu z subdomen. Zapobiega to na przykad [**atakom Cookie Tossing**](cookie-tossing.md). W wykadzie [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg) ([**artyku**](https://www.usenix.org/system/files/usenixsecurity23-squarcina.pdf)) przedstawiono, 偶e mo偶liwe byo ustawienie ciasteczek z prefiksem \_\_HOST- z subdomeny, oszukujc parsera, na przykad dodajc "=" na pocztku lub na kocu...:

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Lub w PHP mo偶liwe byo dodanie **innych znak贸w na pocztku** nazwy ciasteczka, kt贸re miayby by **zastpione znakami podkrelenia**, co pozwalaoby na nadpisanie ciasteczek `__HOST-`:

<figure><img src="../../.gitbook/assets/image (7) (1).png" alt="" width="373"><figcaption></figcaption></figure>

## Cookies Attacks

Jeli niestandardowe ciasteczko zawiera wra偶liwe dane, sprawd藕 je (szczeg贸lnie jeli bierzesz udzia w CTF), poniewa偶 mo偶e by podatne.

### Decoding and Manipulating Cookies

Wra偶liwe dane osadzone w ciasteczkach powinny by zawsze dokadnie sprawdzane. Ciasteczka zakodowane w Base64 lub podobnych formatach mo偶na czsto dekodowa. Ta luka pozwala atakujcym na zmian zawartoci ciasteczka i podszywanie si pod innych u偶ytkownik贸w, kodujc ich zmodyfikowane dane z powrotem do ciasteczka.

### Session Hijacking

Ten atak polega na kradzie偶y ciasteczka u偶ytkownika, aby uzyska nieautoryzowany dostp do jego konta w aplikacji. U偶ywajc skradzionego ciasteczka, atakujcy mo偶e podszy si pod prawdziwego u偶ytkownika.

### Session Fixation

W tym scenariuszu atakujcy oszukuje ofiar, aby u偶ya konkretnego ciasteczka do logowania. Jeli aplikacja nie przypisuje nowego ciasteczka po logowaniu, atakujcy, posiadajcy oryginalne ciasteczko, mo偶e podszy si pod ofiar. Ta technika polega na tym, 偶e ofiara loguje si za pomoc ciasteczka dostarczonego przez atakujcego.

Jeli znalaze **XSS w subdomenie** lub **kontrolujesz subdomen**, przeczytaj:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Session Donation

Tutaj atakujcy przekonuje ofiar do u偶ycia ciasteczka sesji atakujcego. Ofiara, wierzc, 偶e jest zalogowana na swoje konto, niewiadomie wykonuje dziaania w kontekcie konta atakujcego.

Jeli znalaze **XSS w subdomenie** lub **kontrolujesz subdomen**, przeczytaj:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [JWT Cookies](../hacking-jwt-json-web-tokens.md)

Kliknij na poprzedni link, aby uzyska dostp do strony wyjaniajcej mo偶liwe luki w JWT.

JSON Web Tokens (JWT) u偶ywane w ciasteczkach mog r贸wnie偶 przedstawia luki. Aby uzyska szczeg贸owe informacje na temat potencjalnych luk i sposob贸w ich wykorzystania, zaleca si dostp do powizanego dokumentu dotyczcego hackowania JWT.

### Cross-Site Request Forgery (CSRF)

Ten atak zmusza zalogowanego u偶ytkownika do wykonywania niechcianych dziaa w aplikacji internetowej, w kt贸rej jest aktualnie uwierzytelniony. Atakujcy mog wykorzysta ciasteczka, kt贸re s automatycznie wysyane z ka偶dym 偶daniem do podatnej witryny.

### Empty Cookies

(Sprawd藕 dalsze szczeg贸y w [oryginalnych badaniach](https://blog.ankursundara.com/cookie-bugs/)) Przegldarki pozwalaj na tworzenie ciasteczek bez nazwy, co mo偶na wykaza za pomoc JavaScript w nastpujcy spos贸b:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
Wynik w nag贸wku cookie wysanym to `a=v1; test value; b=v2;`. Interesujce jest to, 偶e umo偶liwia to manipulacj cookie, jeli ustawione jest cookie o pustej nazwie, potencjalnie kontrolujc inne cookie, ustawiajc puste cookie na okrelon warto:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
To prowadzi do tego, 偶e przegldarka wysya nag贸wek cookie interpretowany przez ka偶dy serwer WWW jako cookie o nazwie `a` z wartoci `b`.

#### Bd Chrome: Problem z kodem zastpczym Unicode

W Chrome, jeli kod zastpczy Unicode jest czci ustawionego cookie, `document.cookie` staje si uszkodzone, zwracajc pusty cig w nastpstwie:
```js
document.cookie = "\ud800=meep";
```
To skutkuje tym, 偶e `document.cookie` zwraca pusty cig, co wskazuje na trwa korupcj.

#### Przemyt Ciasteczek z Powodu Problem贸w z Parsowaniem

(Zobacz dalsze szczeg贸y w [oryginalnych badaniach](https://blog.ankursundara.com/cookie-bugs/)) Kilka serwer贸w internetowych, w tym te z Javy (Jetty, TomCat, Undertow) i Pythona (Zope, cherrypy, web.py, aiohttp, bottle, webob), niewaciwie obsuguje cigi ciasteczek z powodu przestarzaego wsparcia dla RFC2965. Odczytuj podw贸jnie cytowan warto ciasteczka jako jedn warto, nawet jeli zawiera redniki, kt贸re normalnie powinny oddziela pary klucz-warto:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Luki w Iniekcji Ciasteczek

(Sprawd藕 szczeg贸y w [oryginalnych badaniach](https://blog.ankursundara.com/cookie-bugs/)) Nieprawidowe analizowanie ciasteczek przez serwery, szczeg贸lnie Undertow, Zope oraz te korzystajce z `http.cookie.SimpleCookie` i `http.cookie.BaseCookie` w Pythonie, stwarza mo偶liwoci atak贸w iniekcji ciasteczek. Te serwery nieprawidowo delimituj pocztek nowych ciasteczek, co pozwala atakujcym na faszowanie ciasteczek:

* Undertow oczekuje nowego ciasteczka natychmiast po wartoci w cudzysowie bez rednika.
* Zope szuka przecinka, aby rozpocz analizowanie nastpnego ciasteczka.
* Klasy ciasteczek Pythona zaczynaj analizowanie od znaku spacji.

Ta luka jest szczeg贸lnie niebezpieczna w aplikacjach internetowych opartych na ochronie CSRF opartej na ciasteczkach, poniewa偶 pozwala atakujcym na wstrzykiwanie faszywych ciasteczek z tokenami CSRF, co potencjalnie omija rodki bezpieczestwa. Problem jest zaostrzony przez obsug przez Pythona duplikat贸w nazw ciasteczek, gdzie ostatnie wystpienie nadpisuje wczeniejsze. Budzi to r贸wnie偶 obawy dotyczce ciasteczek `__Secure-` i `__Host-` w niebezpiecznych kontekstach i mo偶e prowadzi do obej autoryzacji, gdy ciasteczka s przekazywane do serwer贸w zaplecza podatnych na faszowanie.

### Dodatkowe Kontrole Ciasteczek Wra偶liwych

#### **Podstawowe kontrole**

* **ciasteczko** jest **takie samo** za ka偶dym razem, gdy **logujesz si**.
* Wyloguj si i spr贸buj u偶y tego samego ciasteczka.
* Spr贸buj zalogowa si z 2 urzdze (lub przegldarek) do tego samego konta, u偶ywajc tego samego ciasteczka.
* Sprawd藕, czy ciasteczko zawiera jakiekolwiek informacje i spr贸buj je zmodyfikowa.
* Spr贸buj utworzy kilka kont z prawie tym samym nazwiskiem i sprawd藕, czy mo偶esz dostrzec podobiestwa.
* Sprawd藕 opcj "**zapamitaj mnie**", jeli istnieje, aby zobaczy, jak dziaa. Jeli istnieje i mo偶e by podatna, zawsze u偶ywaj ciasteczka **zapamitaj mnie** bez 偶adnego innego ciasteczka.
* Sprawd藕, czy poprzednie ciasteczko dziaa nawet po zmianie hasa.

#### **Zaawansowane ataki na ciasteczka**

Jeli ciasteczko pozostaje takie samo (lub prawie) podczas logowania, prawdopodobnie oznacza to, 偶e ciasteczko jest zwizane z jakim polem twojego konta (prawdopodobnie nazwiskiem u偶ytkownika). Wtedy mo偶esz:

* Spr贸bowa utworzy wiele **kont** z bardzo **podobnymi** nazwiskami u偶ytkownik贸w i spr贸bowa **zgadn**, jak dziaa algorytm.
* Spr贸bowa **bruteforce'owa nazwisko u偶ytkownika**. Jeli ciasteczko zapisuje si tylko jako metoda uwierzytelniania dla twojego nazwiska u偶ytkownika, mo偶esz utworzy konto z nazwiskiem u偶ytkownika "**Bmin**" i **bruteforce'owa** ka偶dy pojedynczy **bit** swojego ciasteczka, poniewa偶 jedno z ciasteczek, kt贸re spr贸bujesz, bdzie nale偶ao do "**admin**".
* Spr贸buj **Padding** **Oracle** (mo偶esz odszyfrowa zawarto ciasteczka). U偶yj **padbuster**.

**Padding Oracle - Przykady Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster wykona kilka pr贸b i zapyta, kt贸ra z warunk贸w jest warunkiem bdu (tym, kt贸ry nie jest wa偶ny).

Nastpnie rozpocznie deszyfrowanie ciasteczka (mo偶e to potrwa kilka minut).

Jeli atak zosta pomylnie przeprowadzony, mo偶esz spr贸bowa zaszyfrowa cig wedug wasnego wyboru. Na przykad, jeli chcesz **zaszyfrowa** **user=administrator**.
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
To wykonanie da ci ciasteczko poprawnie zaszyfrowane i zakodowane z cigiem **user=administrator** wewntrz.

**CBC-MAC**

Mo偶e ciasteczko mogoby mie jak warto i mogoby by podpisane przy u偶yciu CBC. Wtedy integralno wartoci to podpis stworzony przy u偶yciu CBC z t sam wartoci. Poniewa偶 zaleca si u偶ycie jako IV wektora zerowego, ten typ sprawdzania integralnoci mo偶e by podatny.

**Atak**

1. Uzyskaj podpis nazwy u偶ytkownika **administ** = **t**
2. Uzyskaj podpis nazwy u偶ytkownika **rator\x00\x00\x00 XOR t** = **t'**
3. Ustaw w ciasteczku warto **administrator+t'** (**t'** bdzie wa偶nym podpisem **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Jeli ciasteczko jest szyfrowane przy u偶yciu ECB, mo偶e by podatne.\
Kiedy logujesz si, ciasteczko, kt贸re otrzymujesz, musi by zawsze takie samo.

**Jak wykry i zaatakowa:**

Utw贸rz 2 u偶ytkownik贸w z prawie tymi samymi danymi (nazwa u偶ytkownika, haso, e-mail itp.) i spr贸buj odkry jaki wz贸r w danym ciasteczku.

Utw贸rz u偶ytkownika o nazwie na przykad "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" i sprawd藕, czy w ciasteczku jest jaki wz贸r (poniewa偶 ECB szyfruje ka偶dy blok tym samym kluczem, te same zaszyfrowane bajty mog si pojawi, jeli nazwa u偶ytkownika jest szyfrowana).

Powinien by wz贸r (o rozmiarze u偶ywanego bloku). Zatem, wiedzc, jak jest zaszyfrowana masa "a", mo偶esz stworzy nazw u偶ytkownika: "a"\*(rozmiar bloku)+"admin". Nastpnie mo偶esz usun zaszyfrowany wz贸r bloku "a" z ciasteczka. I bdziesz mia ciasteczko dla nazwy u偶ytkownika "admin".

## Referencje

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
