# Piratage de Cookies

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menace proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Attributs des Cookies

### Expires & Max-Age

* `Expires` d√©finit une date d'expiration pour la suppression d'un cookie
* `Max-age` d√©finit le temps en secondes avant la suppression d'un cookie **(utilisez cela, nous ne sommes plus en 2009)**

### **Domaine**

L'attribut `Domain` sp√©cifie **quels h√¥tes peuvent recevoir un cookie**. S'il n'est pas sp√©cifi√©, l'attribut **par d√©faut** est l'**h√¥te lui-m√™me**, _**√† l'exclusion des sous-domaines**_. **Si `Domain` est sp√©cifi√©**, alors **les sous-domaines sont toujours inclus**. Par cons√©quent, sp√©cifier `Domain` est moins restrictif que l'omission. Cependant, cela peut √™tre utile lorsque les sous-domaines doivent partager des informations sur un utilisateur.

Par exemple, si vous d√©finissez `Domain=mozilla.org`, les cookies sont disponibles sur des sous-domaines tels que `developer.mozilla.org`. Mais si vous ne le faites pas, le cookie ne sera pas envoy√© aux sous-domaines.

Si un **sous-domaine** `sub.example.com` **d√©finit un cookie** avec l'attribut _domain_ de **`.example.com`**, il sera **envoy√©** avec les requ√™tes vers le **domaine parent**.

### **Chemin**

L'attribut `Path` indique un **chemin d'URL qui doit exister dans l'URL demand√©e pour envoyer l'en-t√™te `Cookie`**. Le caract√®re `%x2F` ("/") est consid√©r√© comme un s√©parateur de r√©pertoire, et les sous-r√©pertoires correspondent √©galement.

#### Ordre

Lorsque 2 cookies ont le **m√™me nom**, celui qui est envoy√© est :

* Celui avec le **chemin le plus long** correspondant au chemin de l'URL
* Le **plus r√©cent** si les deux ont le m√™me chemin

### SameSite

Cela indiquera au navigateur si le **cookie** peut √™tre envoy√© **√† partir d'autres domaines**. Il a 3 valeurs possibles :

* **Strict** : Le cookie ne sera pas envoy√© avec une requ√™te par des sites tiers.
* **Lax** : Le cookie sera envoy√© avec la requ√™te GET initi√©e par des sites tiers.
* **None** : Le cookie est envoy√© depuis n'importe quel domaine tiers.

| **Type de requ√™te** | **Code d'exemple**                  | **Cookies envoy√©s lorsque** |
| ------------------- | ---------------------------------- | --------------------------- |
| Lien                | \<a href="...">\</a>               | NotSet\*, Lax, None         |
| Pr√©chargement       | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None         |
| Formulaire GET      | \<form method="GET" action="...">  | NotSet\*, Lax, None         |
| Formulaire POST     | \<form method="POST" action="..."> | NotSet\*, None              |
| iframe              | \<iframe src="...">\</iframe>      | NotSet\*, None              |
| AJAX                | $.get("...")                       | NotSet\*, None              |
| Image               | \<img src="...">                   | NetSet\*, None              |

Tableau provenant de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) et l√©g√®rement modifi√©.\
Un cookie avec l'attribut _**SameSite**_ permettra de **mitiger les attaques CSRF** o√π une session connect√©e est n√©cessaire.

**\*Notez qu'√† partir de Chrome80 (f√©v/2019), le comportement par d√©faut d'un cookie sans attribut SameSite sera lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Notez que temporairement, apr√®s l'application de ce changement, les **cookies sans politique SameSite** dans Chrome seront **trait√©s comme None** pendant les **2 premi√®res minutes, puis comme Lax pour les requ√™tes POST inter-sites de premier niveau**.
## Drapeaux des cookies

### HttpOnly

Cela emp√™che le **client** d'acc√©der au cookie (via **Javascript** par exemple: `document.cookie`)

#### **Contournements**

* Si la page envoie les cookies en tant que r√©ponse d'une requ√™te (par exemple dans une page **PHPinfo**), il est possible d'exploiter la faille XSS pour envoyer une requ√™te √† cette page et **voler les cookies** de la r√©ponse (consultez un exemple sur [https://hackcommander.github.io/pentesting-article-1/)](https://hackcommander.github.io/pentesting-article-1/)
* Cela peut √™tre contourn√© avec des requ√™tes **TRACE** **HTTP** car la r√©ponse du serveur (si cette m√©thode HTTP est disponible) refl√©tera les cookies envoy√©s. Cette technique s'appelle le **suivi entre sites**.
* Cette technique est √©vit√©e par les **navigateurs modernes en n'autorisant pas l'envoi d'une requ√™te TRACE** depuis JS. Cependant, des contournements ont √©t√© trouv√©s dans des logiciels sp√©cifiques, comme l'envoi de `\r\nTRACE` au lieu de `TRACE` √† IE6.0 SP2.
* Une autre m√©thode consiste √† exploiter des vuln√©rabilit√©s zero/day des navigateurs.
* Il est possible de **remplacer les cookies HttpOnly** en effectuant une attaque de d√©bordement de Cookie Jar :

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Il est possible d'utiliser une attaque de [**smuggling de cookies**](./#cookie-smuggling) pour exfiltrer ces cookies.

### Secure

La requ√™te enverra le cookie **uniquement** si la requ√™te est transmise via un canal s√©curis√© (typiquement **HTTPS**).

## Pr√©fixes des cookies

Pr√©fixe **`__Secure-`** : doit √™tre d√©fini avec le drapeau `secure` √† partir d'une page s√©curis√©e (HTTPS).

Pr√©fixe **`__Host-`** : doit √™tre d√©fini avec le drapeau `secure`, doit provenir d'une page s√©curis√©e (HTTPS), ne doit pas avoir de domaine sp√©cifi√© (et donc, n'est pas envoy√© aux sous-domaines), et le chemin doit √™tre `/`.

Les cookies pr√©fix√©s par **`__Host-`** ne peuvent pas √™tre envoy√©s aux superdomaines (cookies des sous-domaines vers les domaines) ou aux sous-domaines (cookies des domaines vers les sous-domaines), donc, si vous souhaitez isoler les cookies de votre application, pr√©fixer tout avec `__Host-` n'est pas une mauvaise id√©e.

## Attaques des cookies

Si vous trouvez un type de cookie personnalis√© contenant des donn√©es sensibles (sessionID, nom d'utilisateur, e-mails, etc.), vous devriez certainement essayer de l'exploiter.

### D√©codage du cookie

Si le **cookie** utilise un **encodage de base** (comme Base64) ou similaire, vous pourrez peut-√™tre le **d√©coder**, **modifier** le **contenu** et **usurper** des utilisateurs arbitraires.

### D√©tournement de session

Vol d'un cookie et utilisation pour se faire passer pour l'utilisateur dans une application.

### Fixation de session

L'attaquant obtient un cookie √† partir d'une page web et envoie un lien √† la victime pour **se connecter en utilisant le m√™me cookie**. Si le cookie n'est pas modifi√© lorsqu'un utilisateur se connecte, cela peut √™tre utile car l'attaquant pourrait √™tre en mesure de se faire passer pour l'utilisateur gr√¢ce √† un cookie.

Si vous trouvez un **XSS dans un sous-domaine** ou que vous **contr√¥lez un sous-domaine**, lisez :

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Don de session

L'attaquant envoie sa propre session √† la victime. La victime verra qu'elle est d√©j√† connect√©e et supposera qu'elle est dans son compte, mais **les actions seront effectu√©es dans le compte de l'attaquant**.

Si vous trouvez un **XSS dans un sous-domaine** ou que vous **contr√¥lez un sous-domaine**, lisez :

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookie JWT](../hacking-jwt-json-web-tokens.md)

Cliquez sur le lien pr√©c√©dent pour acc√©der √† une page expliquant les failles possibles dans les JWT.

### Cookie vide

Les navigateurs autorisent un cookie avec un nom vide.
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // empty name
document.cookie = "b=v2"
```
Cela entra√Æne l'envoi de l'en-t√™te cookie suivant :
```
a=v1; test value; b=v2;
```
Plus int√©ressant encore, si vous disposez d'un vecteur qui vous permet d'une mani√®re ou d'une autre de **d√©finir le cookie vide**, vous pouvez **contr√¥ler n'importe quel autre cookie** :
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // this sets the empty cookie to a=b
```
Bien que, en interne dans le navigateur, cela soit d√©fini comme un cookie sans nom, cela se traduira par l'en-t√™te du cookie envoy√© :
```
a=b;
```
Cela signifie que chaque serveur web l'interpr√©tera comme le cookie `a` √©tant d√©fini avec la valeur `b`.

### Bug Chrome - corruption de document.cookie <a href="#chrome-bugdocumentcookie-corruption" id="chrome-bugdocumentcookie-corruption"></a>

Si un point de code de substitution Unicode est pr√©sent dans un cookie d√©fini, `document.cookie` sera corrompu de mani√®re permanente et renverra une cha√Æne vide.
```js
document.cookie
// "a=b;"
document.cookie = "\ud800=meep";
document.cookie
// ""
```
### Contrebande de cookies

Plusieurs serveurs web, y compris les serveurs Java Jetty, TomCat, Undertow, et le framework web Python Zope, ainsi que les serveurs/frameworks web Python tels que cherrypy, web.py, aiohttp server, bottle et webob, sont **incapables d'analyser correctement les cha√Ænes de cookies** en raison du support restant pour RFC2965, un m√©canisme de citation de cookies obsol√®te qui utilise RFC2616 pour la d√©finition d'une cha√Æne entre guillemets.

Plus pr√©cis√©ment, **ces serveurs continuent de lire une cha√Æne de cookies lorsqu'ils rencontrent une valeur de cookie entre guillemets doubles (dquoted), m√™me si un point-virgule est rencontr√©**. Cela pose probl√®me car **les points-virgules sont cens√©s s√©parer les paires cl√©-valeur** dans la cha√Æne de cookies.

Par exemple, si un **navigateur envoie trois cookies, RENDER\_TEXT, JSESSIONID,** et **ASDF:**
```basic
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
Ces serveurs les interpr√®tent comme faisant partie d'une **seule valeur de cookie** plut√¥t que de trois cookies distincts.

Cela entra√Æne un risque de s√©curit√© : si un attaquant obtient un acc√®s cross-site scripting (XSS), il peut utiliser cette faille pour **exfiltrer des cookies sensibles tels que les cookies HttpOnly**.

### Injection de cookie

De nombreux serveurs Web, dont Undertow de Java, Zope de Python et ceux utilisant http.cookie.SimpleCookie et http.cookie.BaseCookie de la biblioth√®que standard de Python, ont √©t√© trouv√©s pour **analyser incorrectement les cookies, en utilisant de mauvais d√©limiteurs pour commencer la prochaine paire nom/valeur de cookie**. Cela permet √† un attaquant de **fausser plusieurs cookies tout en ne contr√¥lant qu'une seule valeur de cookie**.

Dans le cas d'**Undertow**, il commence √† analyser le cookie suivant imm√©diatement apr√®s la **fin d'une valeur de cookie entre guillemets**, sans attendre un point-virgule :
```bash
LANGUAGE="en-us" CSRF_TOKEN="SPOOFED_VALUE"
```
**Zope** commence √† analyser le cookie suivant sur une **virgule** :
```bash
LANGUAGE=en-us,CSRF_TOKEN=SPOOFED_VALUE
```
Et **SimpleCookie de Python** et **BaseCookie** commencent imm√©diatement √† analyser le cookie suivant sur un caract√®re **espace** :
```
LANGUAGE=en-us CSRF_TOKEN=SPOOFED_VALUE
```
En cons√©quence, des serveurs tels que **cherrypy**, **web.py**, le serveur **aiohttp**, **bottle** et **webob** (Pyramid, TurboGears) sont tous vuln√©rables √† ce type d'attaque.

Ce probl√®me pr√©sente des **implications de s√©curit√©** importantes. Par exemple, si une application web utilise une **protection CSRF bas√©e sur les cookies**, un attaquant peut **injecter** un **cookie de jeton CSRF falsifi√©** pour contourner cette protection. De plus, le dernier cookie portant le m√™me nom dans les packages http.cookie de Python remplace tous les pr√©c√©dents, ce qui rend ce type d'attaque particuli√®rement facile.

De plus, le **falsification** des cookies **`__Secure-`** et **`__Host-`** peut √™tre exploit√©e dans un contexte non s√©curis√©. De plus, dans une configuration o√π les cookies sont transmis √† un serveur backend, une **injection de cookie pourrait entra√Æner des contournements d'autorisation** si le serveur backend est vuln√©rable √† la falsification mais que le serveur frontend ne l'est pas.

### V√©rifications suppl√©mentaires des cookies vuln√©rables

#### **V√©rifications de base**

* Le **cookie** est le **m√™me** √† chaque fois que vous **vous connectez**.
* D√©connectez-vous et essayez d'utiliser le m√™me cookie.
* Essayez de vous connecter avec 2 appareils (ou navigateurs) sur le m√™me compte en utilisant le m√™me cookie.
* V√©rifiez si le cookie contient des informations et essayez de le modifier.
* Essayez de cr√©er plusieurs comptes avec des noms d'utilisateur presque identiques et v√©rifiez s'il y a des similitudes.
* V√©rifiez l'option "**se souvenir de moi**" si elle existe pour voir comment elle fonctionne. Si elle existe et peut √™tre vuln√©rable, utilisez toujours le cookie de **se souvenir de moi** sans aucun autre cookie.
* V√©rifiez si le cookie pr√©c√©dent fonctionne m√™me apr√®s avoir chang√© le mot de passe.

#### **Attaques avanc√©es sur les cookies**

Si le cookie reste le m√™me (ou presque) lorsque vous vous connectez, cela signifie probablement que le cookie est li√© √† un champ de votre compte (probablement le nom d'utilisateur). Vous pouvez alors :

* Essayez de cr√©er de nombreux **comptes** avec des noms d'utilisateur tr√®s **similaires** et essayez de **deviner** comment fonctionne l'algorithme.
* Essayez de **forcer le nom d'utilisateur**. Si le cookie ne sert qu'√† l'authentification de votre nom d'utilisateur, vous pouvez cr√©er un compte avec le nom d'utilisateur "**Bmin**" et **forcer** chaque **bit** de votre cookie car l'un des cookies que vous essayerez sera celui appartenant √† "**admin**".
* Essayez **Padding Oracle** (vous pouvez d√©crypter le contenu du cookie). Utilisez **padbuster**.

**Padding Oracle - Exemples de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster effectuera plusieurs tentatives et vous demandera quelle condition est la condition d'erreur (celle qui n'est pas valide).

Ensuite, il commencera √† d√©crypter le cookie (cela peut prendre plusieurs minutes).

Si l'attaque a r√©ussi, vous pouvez essayer de chiffrer une cha√Æne de votre choix. Par exemple, si vous souhaitez **chiffrer** **user=administrateur**.
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Cette ex√©cution vous donnera le cookie correctement chiffr√© et encod√© avec la cha√Æne **user=administrator** √† l'int√©rieur.

**CBC-MAC**

Il est possible qu'un cookie ait une valeur et soit sign√© en utilisant CBC. Ainsi, l'int√©grit√© de la valeur est la signature cr√©√©e en utilisant CBC avec la m√™me valeur. Comme il est recommand√© d'utiliser un vecteur IV nul, ce type de v√©rification d'int√©grit√© peut √™tre vuln√©rable.

**L'attaque**

1. Obtenez la signature de l'utilisateur **administ** = **t**
2. Obtenez la signature de l'utilisateur **rator\x00\x00\x00 XOR t** = **t'**
3. D√©finissez dans le cookie la valeur **administrator+t'** (**t'** sera une signature valide de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Si le cookie est chiffr√© en utilisant ECB, il peut √™tre vuln√©rable.\
Lorsque vous vous connectez, le cookie que vous recevez doit toujours √™tre le m√™me.

**Comment d√©tecter et attaquer :**

Cr√©ez 2 utilisateurs avec des donn√©es presque identiques (nom d'utilisateur, mot de passe, e-mail, etc.) et essayez de d√©couvrir un certain sch√©ma √† l'int√©rieur du cookie donn√©.

Cr√©ez un utilisateur appel√© par exemple "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" et v√©rifiez s'il y a un sch√©ma dans le cookie (comme ECB chiffre avec la m√™me cl√© chaque bloc, les m√™mes octets chiffr√©s peuvent appara√Ætre si le nom d'utilisateur est chiffr√©).

Il devrait y avoir un sch√©ma (avec la taille d'un bloc utilis√©). Ainsi, en connaissant la fa√ßon dont un tas de "a" est chiffr√©, vous pouvez cr√©er un nom d'utilisateur : "a"\*(taille du bloc)+"admin". Ensuite, vous pouvez supprimer le sch√©ma chiffr√© d'un bloc de "a" du cookie. Et vous aurez le cookie de l'utilisateur "admin".

## R√©f√©rences

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
