# Cookies Hacking

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}


## Atributos de Cookies

Os cookies v√™m com v√°rios atributos que controlam seu comportamento no navegador do usu√°rio. Aqui est√° um resumo desses atributos em uma voz mais passiva:

### Expires e Max-Age

A data de expira√ß√£o de um cookie √© determinada pelo atributo `Expires`. Por outro lado, o atributo `Max-age` define o tempo em segundos at√© que um cookie seja exclu√≠do. **Opte por `Max-age`, pois reflete pr√°ticas mais modernas.**

### Domain

Os hosts que recebem um cookie s√£o especificados pelo atributo `Domain`. Por padr√£o, isso √© definido para o host que emitiu o cookie, n√£o incluindo seus subdom√≠nios. No entanto, quando o atributo `Domain` √© explicitamente definido, ele abrange subdom√≠nios tamb√©m. Isso torna a especifica√ß√£o do atributo `Domain` uma op√ß√£o menos restritiva, √∫til para cen√°rios onde o compartilhamento de cookies entre subdom√≠nios √© necess√°rio. Por exemplo, definir `Domain=mozilla.org` torna os cookies acess√≠veis em seus subdom√≠nios como `developer.mozilla.org`.

### Path

Um caminho de URL espec√≠fico que deve estar presente na URL solicitada para que o cabe√ßalho `Cookie` seja enviado √© indicado pelo atributo `Path`. Este atributo considera o caractere `/` como um separador de diret√≥rio, permitindo correspond√™ncias em subdiret√≥rios tamb√©m.

### Regras de Ordena√ß√£o

Quando dois cookies t√™m o mesmo nome, o escolhido para envio √© baseado em:

* O cookie que corresponde ao caminho mais longo na URL solicitada.
* O cookie definido mais recentemente se os caminhos forem id√™nticos.

### SameSite

* O atributo `SameSite` dita se os cookies s√£o enviados em solicita√ß√µes originadas de dom√≠nios de terceiros. Ele oferece tr√™s configura√ß√µes:
* **Strict**: Restringe o cookie de ser enviado em solicita√ß√µes de terceiros.
* **Lax**: Permite que o cookie seja enviado com solicita√ß√µes GET iniciadas por sites de terceiros.
* **None**: Permite que o cookie seja enviado de qualquer dom√≠nio de terceiros.

Lembre-se, ao configurar cookies, entender esses atributos pode ajudar a garantir que eles se comportem como esperado em diferentes cen√°rios.

| **Tipo de Solicita√ß√£o** | **C√≥digo de Exemplo**                   | **Cookies Enviados Quando** |
| ----------------------- | --------------------------------------- | ---------------------------- |
| Link                    | \<a href="...">\</a>                   | NotSet\*, Lax, None          |
| Prerender               | \<link rel="prerender" href=".."/>     | NotSet\*, Lax, None          |
| Formul√°rio GET          | \<form method="GET" action="...">      | NotSet\*, Lax, None          |
| Formul√°rio POST         | \<form method="POST" action="...">     | NotSet\*, None               |
| iframe                  | \<iframe src="...">\</iframe>           | NotSet\*, None               |
| AJAX                    | $.get("...")                            | NotSet\*, None               |
| Imagem                  | \<img src="...">                        | NetSet\*, None               |

Tabela de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) e ligeiramente modificada.\
Um cookie com o atributo _**SameSite**_ **mitigar√° ataques CSRF** onde uma sess√£o logada √© necess√°ria.

**\*Observe que a partir do Chrome80 (fev/2019) o comportamento padr√£o de um cookie sem um atributo SameSite** **ser√° lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Observe que temporariamente, ap√≥s aplicar essa mudan√ßa, os **cookies sem uma pol√≠tica SameSite** **no Chrome ser√£o** **tratados como None** durante os **primeiros 2 minutos e depois como Lax para solicita√ß√µes POST de n√≠vel superior entre sites.**

## Flags de Cookies

### HttpOnly

Isso evita que o **cliente** acesse o cookie (via **Javascript**, por exemplo: `document.cookie`)

#### **Bypasses**

* Se a p√°gina **estiver enviando os cookies como resposta** a uma solicita√ß√£o (por exemplo, em uma p√°gina **PHPinfo**), √© poss√≠vel abusar do XSS para enviar uma solicita√ß√£o a essa p√°gina e **roubar os cookies** da resposta (ver um exemplo em [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Isso pode ser contornado com solicita√ß√µes **TRACE** **HTTP**, pois a resposta do servidor (se esse m√©todo HTTP estiver dispon√≠vel) refletir√° os cookies enviados. Essa t√©cnica √© chamada de **Cross-Site Tracking**.
* Essa t√©cnica √© evitada por **navegadores modernos ao n√£o permitir o envio de uma solicita√ß√£o TRACE** a partir do JS. No entanto, alguns contornos para isso foram encontrados em softwares espec√≠ficos, como enviar `\r\nTRACE` em vez de `TRACE` para IE6.0 SP2.
* Outra maneira √© a explora√ß√£o de vulnerabilidades zero-day dos navegadores.
* √â poss√≠vel **sobrescrever cookies HttpOnly** realizando um ataque de transbordamento de Cookie Jar:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* √â poss√≠vel usar o ataque de [**Cookie Smuggling**](./#cookie-smuggling) para exfiltrar esses cookies.

### Secure

A solicita√ß√£o **somente** enviar√° o cookie em uma solicita√ß√£o HTTP se a solicita√ß√£o for transmitida por um canal seguro (tipicamente **HTTPS**).

## Prefixos de Cookies

Cookies prefixados com `__Secure-` devem ser definidos juntamente com a flag `secure` de p√°ginas que s√£o protegidas por HTTPS.

Para cookies prefixados com `__Host-`, v√°rias condi√ß√µes devem ser atendidas:

* Eles devem ser definidos com a flag `secure`.
* Eles devem se originar de uma p√°gina protegida por HTTPS.
* Eles s√£o proibidos de especificar um dom√≠nio, impedindo sua transmiss√£o para subdom√≠nios.
* O caminho para esses cookies deve ser definido como `/`.

√â importante notar que cookies prefixados com `__Host-` n√£o podem ser enviados para superdom√≠nios ou subdom√≠nios. Essa restri√ß√£o ajuda a isolar cookies de aplica√ß√£o. Assim, empregar o prefixo `__Host-` para todos os cookies de aplica√ß√£o pode ser considerado uma boa pr√°tica para aumentar a seguran√ßa e o isolamento.

### Sobrescrevendo cookies

Assim, uma das prote√ß√µes dos cookies prefixados com `__Host-` √© impedir que eles sejam sobrescritos a partir de subdom√≠nios. Prevenindo, por exemplo, [**ataques de Cookie Tossing**](cookie-tossing.md). Na palestra [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg) ([**artigo**](https://www.usenix.org/system/files/usenixsecurity23-squarcina.pdf)) √© apresentado que foi poss√≠vel definir cookies prefixados com \_\_HOST- a partir de subdom√≠nios, enganando o parser, por exemplo, adicionando "=" no in√≠cio ou no final...:

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

Ou em PHP, foi poss√≠vel adicionar **outros caracteres no in√≠cio** do nome do cookie que seriam **substitu√≠dos por caracteres de sublinhado**, permitindo sobrescrever cookies `__HOST-`:

<figure><img src="../../.gitbook/assets/image (7) (1).png" alt="" width="373"><figcaption></figcaption></figure>

## Ataques de Cookies

Se um cookie personalizado cont√©m dados sens√≠veis, verifique-o (especialmente se voc√™ estiver participando de um CTF), pois pode ser vulner√°vel.

### Decodificando e Manipulando Cookies

Dados sens√≠veis incorporados em cookies devem sempre ser examinados. Cookies codificados em Base64 ou formatos semelhantes podem frequentemente ser decodificados. Essa vulnerabilidade permite que atacantes alterem o conte√∫do do cookie e se fa√ßam passar por outros usu√°rios, codificando seus dados modificados de volta no cookie.

### Sequestro de Sess√£o

Esse ataque envolve roubar o cookie de um usu√°rio para obter acesso n√£o autorizado √† sua conta dentro de um aplicativo. Usando o cookie roubado, um atacante pode se passar pelo usu√°rio leg√≠timo.

### Fixa√ß√£o de Sess√£o

Nesse cen√°rio, um atacante engana uma v√≠tima para usar um cookie espec√≠fico para fazer login. Se o aplicativo n√£o atribuir um novo cookie ao fazer login, o atacante, possuindo o cookie original, pode se passar pela v√≠tima. Essa t√©cnica depende da v√≠tima fazer login com um cookie fornecido pelo atacante.

Se voc√™ encontrou um **XSS em um subdom√≠nio** ou **controla um subdom√≠nio**, leia:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Doa√ß√£o de Sess√£o

Aqui, o atacante convence a v√≠tima a usar o cookie de sess√£o do atacante. A v√≠tima, acreditando que est√° logada em sua pr√≥pria conta, realizar√° inadvertidamente a√ß√µes no contexto da conta do atacante.

Se voc√™ encontrou um **XSS em um subdom√≠nio** ou **controla um subdom√≠nio**, leia:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookies JWT](../hacking-jwt-json-web-tokens.md)

Clique no link anterior para acessar uma p√°gina explicando poss√≠veis falhas em JWT.

Tokens Web JSON (JWT) usados em cookies tamb√©m podem apresentar vulnerabilidades. Para informa√ß√µes detalhadas sobre poss√≠veis falhas e como explor√°-las, recomenda-se acessar o documento vinculado sobre hacking JWT.

### Cross-Site Request Forgery (CSRF)

Esse ataque for√ßa um usu√°rio logado a executar a√ß√µes indesejadas em uma aplica√ß√£o web na qual est√° atualmente autenticado. Atacantes podem explorar cookies que s√£o automaticamente enviados com cada solicita√ß√£o para o site vulner√°vel.

### Cookies Vazios

(Verifique mais detalhes na [pesquisa original](https://blog.ankursundara.com/cookie-bugs/)) Os navegadores permitem a cria√ß√£o de cookies sem um nome, o que pode ser demonstrado atrav√©s do JavaScript da seguinte forma:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
O resultado no cabe√ßalho de cookie enviado √© `a=v1; test value; b=v2;`. Intrigantemente, isso permite a manipula√ß√£o de cookies se um cookie com nome vazio for definido, potencialmente controlando outros cookies ao definir o cookie vazio para um valor espec√≠fico:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
Isso leva o navegador a enviar um cabe√ßalho de cookie interpretado por cada servidor web como um cookie chamado `a` com um valor `b`.

#### Bug do Chrome: Problema de C√≥digo de Substitui√ß√£o Unicode

No Chrome, se um c√≥digo de substitui√ß√£o Unicode fizer parte de um cookie definido, `document.cookie` fica corrompido, retornando uma string vazia posteriormente:
```js
document.cookie = "\ud800=meep";
```
Isso resulta em `document.cookie` retornando uma string vazia, indicando corrup√ß√£o permanente.

#### Cookie Smuggling Devido a Problemas de An√°lise

(Confira mais detalhes na [pesquisa original](https://blog.ankursundara.com/cookie-bugs/)) V√°rios servidores web, incluindo os de Java (Jetty, TomCat, Undertow) e Python (Zope, cherrypy, web.py, aiohttp, bottle, webob), manipulam incorretamente strings de cookies devido ao suporte desatualizado do RFC2965. Eles leem um valor de cookie entre aspas duplas como um √∫nico valor, mesmo que inclua ponto e v√≠rgulas, que normalmente deveriam separar pares chave-valor:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Vulnerabilidades de Inje√ß√£o de Cookies

(Check further details in the[original research](https://blog.ankursundara.com/cookie-bugs/)) A an√°lise incorreta de cookies pelos servidores, notavelmente Undertow, Zope e aqueles que usam `http.cookie.SimpleCookie` e `http.cookie.BaseCookie` do Python, cria oportunidades para ataques de inje√ß√£o de cookies. Esses servidores falham em delimitar corretamente o in√≠cio de novos cookies, permitindo que atacantes falsifiquem cookies:

* Undertow espera um novo cookie imediatamente ap√≥s um valor entre aspas sem um ponto e v√≠rgula.
* Zope procura uma v√≠rgula para come√ßar a analisar o pr√≥ximo cookie.
* As classes de cookies do Python come√ßam a analisar em um caractere de espa√ßo.

Essa vulnerabilidade √© particularmente perigosa em aplica√ß√µes web que dependem de prote√ß√£o CSRF baseada em cookies, pois permite que atacantes injetem cookies de CSRF-token falsificados, potencialmente contornando medidas de seguran√ßa. O problema √© agravado pelo tratamento de nomes de cookies duplicados pelo Python, onde a √∫ltima ocorr√™ncia substitui as anteriores. Tamb√©m levanta preocupa√ß√µes para cookies `__Secure-` e `__Host-` em contextos inseguros e pode levar a contornos de autoriza√ß√£o quando cookies s√£o passados para servidores back-end suscet√≠veis a falsifica√ß√£o.

### Verifica√ß√µes de Cookies Extra Vulner√°veis

#### **Verifica√ß√µes b√°sicas**

* O **cookie** √© o **mesmo** toda vez que voc√™ **faz login**.
* Fa√ßa logout e tente usar o mesmo cookie.
* Tente fazer login com 2 dispositivos (ou navegadores) na mesma conta usando o mesmo cookie.
* Verifique se o cookie cont√©m alguma informa√ß√£o e tente modific√°-lo.
* Tente criar v√°rias contas com nomes de usu√°rio quase iguais e verifique se consegue ver semelhan√ßas.
* Verifique a op√ß√£o "**lembrar-me**" se existir para ver como funciona. Se existir e puder ser vulner√°vel, sempre use o cookie de **lembrar-me** sem nenhum outro cookie.
* Verifique se o cookie anterior funciona mesmo ap√≥s voc√™ mudar a senha.

#### **Ataques avan√ßados a cookies**

Se o cookie permanecer o mesmo (ou quase) quando voc√™ faz login, isso provavelmente significa que o cookie est√° relacionado a algum campo da sua conta (provavelmente o nome de usu√°rio). Ent√£o voc√™ pode:

* Tentar criar muitas **contas** com nomes de usu√°rio muito **semelhantes** e tentar **adivinhar** como o algoritmo est√° funcionando.
* Tentar **for√ßar o nome de usu√°rio**. Se o cookie √© salvo apenas como um m√©todo de autentica√ß√£o para seu nome de usu√°rio, ent√£o voc√™ pode criar uma conta com o nome de usu√°rio "**Bmin**" e **for√ßar** cada √∫nico **bit** do seu cookie porque um dos cookies que voc√™ tentar√° ser√° o que pertence a "**admin**".
* Tentar **Padding** **Oracle** (voc√™ pode descriptografar o conte√∫do do cookie). Use **padbuster**.

**Padding Oracle - Exemplos de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster far√° v√°rias tentativas e perguntar√° qual condi√ß√£o √© a condi√ß√£o de erro (a que n√£o √© v√°lida).

Em seguida, come√ßar√° a descriptografar o cookie (pode levar v√°rios minutos)

Se o ataque for realizado com sucesso, voc√™ poder√° tentar criptografar uma string de sua escolha. Por exemplo, se voc√™ quiser **encrypt** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Esta execu√ß√£o lhe dar√° o cookie corretamente criptografado e codificado com a string **user=administrator** dentro.

**CBC-MAC**

Talvez um cookie possa ter algum valor e pode ser assinado usando CBC. Ent√£o, a integridade do valor √© a assinatura criada usando CBC com o mesmo valor. Como √© recomendado usar como IV um vetor nulo, esse tipo de verifica√ß√£o de integridade pode ser vulner√°vel.

**O ataque**

1. Obtenha a assinatura do nome de usu√°rio **administ** = **t**
2. Obtenha a assinatura do nome de usu√°rio **rator\x00\x00\x00 XOR t** = **t'**
3. Defina no cookie o valor **administrator+t'** (**t'** ser√° uma assinatura v√°lida de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Se o cookie for criptografado usando ECB, ele pode ser vulner√°vel.\
Quando voc√™ faz login, o cookie que voc√™ recebe deve ser sempre o mesmo.

**Como detectar e atacar:**

Crie 2 usu√°rios com dados quase id√™nticos (nome de usu√°rio, senha, e-mail, etc.) e tente descobrir algum padr√£o dentro do cookie fornecido.

Crie um usu√°rio chamado, por exemplo, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" e verifique se h√° algum padr√£o no cookie (como o ECB criptografa com a mesma chave cada bloco, os mesmos bytes criptografados podem aparecer se o nome de usu√°rio for criptografado).

Deve haver um padr√£o (com o tamanho de um bloco usado). Assim, sabendo como um monte de "a" √© criptografado, voc√™ pode criar um nome de usu√°rio: "a"\*(tamanho do bloco)+"admin". Ent√£o, voc√™ poderia deletar o padr√£o criptografado de um bloco de "a" do cookie. E voc√™ ter√° o cookie do nome de usu√°rio "admin".

## Refer√™ncias

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
