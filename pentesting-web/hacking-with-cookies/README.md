# Hakerski napad na kola캜i캖e

<details>

<summary><strong>Nau캜ite hakerski napad na AWS od po캜etka do kraja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Prona캠ite najva쬹ije ranjivosti kako biste ih br쬰 popravili. Intruder prati va코u povr코inu napada, pokre캖e proaktivne pretnje, pronalazi probleme u celokupnom tehnolo코kom skupu, od API-ja do veb aplikacija i sistemima u oblaku. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Atributi kola캜i캖a

Kola캜i캖i dolaze sa nekoliko atributa koji kontroli코u njihovo pona코anje u korisnikovom pregleda캜u. Evo pregleda ovih atributa u pasivnijem glasu:

### Iste캜e i Max-Age

Datum isteka kola캜i캖a odre캠uje atribut `Expires`. S druge strane, atribut `Max-age` defini코e vreme u sekundama do brisanja kola캜i캖a. **Preporu캜uje se kori코캖enje `Max-age` jer odra쬬va modernije prakse.**

### Domen

Domeni koji primaju kola캜i캖 su navedeni atributom `Domain`. Prema podrazumevanim pode코avanjima, to je postavljeno na domen koji je izdao kola캜i캖, ne uklju캜uju캖i njegove poddomene. Me캠utim, kada je eksplicitno postavljen atribut `Domain`, on obuhvata i poddomene. Ovo 캜ini postavljanje atributa `Domain` manje restriktivnom opcijom, korisnom za scenarije u kojima je deljenje kola캜i캖a izme캠u poddomena neophodno. Na primer, postavljanje `Domain=mozilla.org` omogu캖ava pristup kola캜i캖ima na njegovim poddomenima poput `developer.mozilla.org`.

### Putanja

Specifi캜na URL putanja koja mora biti prisutna u zahtevanom URL-u kako bi se poslao zaglavlje `Cookie` je nazna캜ena atributom `Path`. Ovaj atribut razmatra karakter `/` kao separator direktorijuma, omogu캖avaju캖i podudaranja i u poddirektorijumima.

### Pravila za redosled

Kada dva kola캜i캖a imaju isto ime, onaj koji se 코alje se odre캠uje na osnovu:
- Kola캜i캖 koji se podudara sa najdu쬺m putanjom u zahtevanom URL-u.
- Najskorije postavljen kola캜i캖 ako su putanje identi캜ne.

### SameSite

- Atribut `SameSite` odre캠uje da li se kola캜i캖i 코alju u zahtevima koji poti캜u sa domena tre캖e strane. Ima tri pode코avanja:
- **Strict**: Ograni캜ava slanje kola캜i캖a u zahtevima tre캖e strane.
- **Lax**: Omogu캖ava slanje kola캜i캖a sa GET zahtevima pokrenutim od strane veb lokacija tre캖e strane.
- **None**: Dozvoljava slanje kola캜i캖a sa bilo kog domena tre캖e strane.

Zapamtite, prilikom konfigurisanja kola캜i캖a, razumevanje ovih atributa mo쬰 pomo캖i da se osigura da se pona코aju onako kako se o캜ekuje u razli캜itim scenarijima.


| **Tip zahteva** | **Primer koda**                     | **Kola캜i캖i poslati kada** |
| --------------- | ---------------------------------- | ----------------------- |
| Link            | \<a href="...">\</a>               | NotSet\*, Lax, None     |
| Prerender       | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None     |
| Form GET        | \<form method="GET" action="...">  | NotSet\*, Lax, None     |
| Form POST       | \<form method="POST" action="..."> | NotSet\*, None          |
| iframe          | \<iframe src="...">\</iframe>      | NotSet\*, None          |
| AJAX            | $.get("...")                       | NotSet\*, None          |
| Slika           | \<img src="...">                   | NetSet\*, None          |

Tabela preuzeta sa [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) i blago izmenjena.\
Kola캜i캖 sa atributom _**SameSite**_ 캖e **smanjiti CSRF napade** gde je potrebna prijavljena sesija.

**\*Primetite da od Chrome80 (feb/2019) podrazumevano pona코anje kola캜i캖a bez atributa samesite** **캖e biti lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Primetite da 캖e privremeno, nakon primene ove promene, **kola캜i캖i bez SameSite politike** u Chrome-u biti **tretirani kao None** tokom **prvih 2 minuta, a zatim kao Lax za POST zahtev preko glavnog domena.**

## Zastavice kola캜i캖a

### HttpOnly

Ovo spre캜ava **klijenta** da pristupi kola캜i캖u (Na primer, putem **Javascript-a**: `document.cookie`)

#### **Bypass-ovi**

* Ako stranica **코alje kola캜i캖e kao odgovor** na zahtev (na primer, na **PHPinfo** stranici), mogu캖e je zloupotrebiti XSS da se po코alje zahtev ovoj stranici i **ukrade kola캜i캖e** iz odgovora (proverite primer na [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Ovo se mo쬰 zaobi캖i pomo캖u **TRACE** **HTTP** zahteva, jer 캖e odgovor sa servera (ako je ovaj HTTP metod dostupan) odra쬬vati poslate kola캜i캖e. Ova tehnika se naziva **Cross-Site Tracking**.
* Ovu tehniku moderni pregleda캜i izbegavaju tako 코to ne dozvoljavaju slanje TRACE zahteva iz JS-a. Me캠utim, neki zaobi캠i za ovo su prona캠eni u specifi캜nom softveru, kao 코to je slanje `\r\nTRACE` umesto `TRACE` na IE6.0 SP2.
* Drugi na캜in je iskori코캖avanje zero/day ranjivosti pregleda캜a.
* Mogu캖e je **prepisati HttpOnly kola캜i캖e** izvr코avanjem napada prelivanja Cookie Jar-a:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Mogu캖e je koristiti napad [**Cookie Smuggling**](./#cookie-smuggling) za izvla캜enje ovih kola캜i캖a

### Secure

Zahtev 캖e **samo** poslati kola캜i캖 u HTTP zahtevu samo ako je zahtev prenet preko sigurnog kanala (tipi캜no **HTTPS**).
## Prefiksi kola캜i캖a

Kola캜i캖i sa prefiksom `__Secure-` moraju biti postavljeni zajedno sa zastavicom `secure` na stranicama koje su obezbe캠ene putem HTTPS protokola.

Za kola캜i캖e sa prefiksom `__Host-`, moraju se ispuniti nekoliko uslova:
- Moraju biti postavljeni sa zastavicom `secure`.
- Moraju poticati sa stranice obezbe캠ene HTTPS protokolom.
- Zabranjeno je navo캠enje domena, 캜ime se spre캜ava njihovo slanje na poddomene.
- Putanja za ove kola캜i캖e mora biti postavljena na `/`.

Va쬹o je napomenuti da kola캜i캖i sa prefiksom `__Host-` nisu dozvoljeni da se 코alju superdomenima ili poddomenima. Ova restrikcija poma쬰 u izolaciji kola캜i캖a aplikacije. Stoga, kori코캖enje prefiksa `__Host-` za sve kola캜i캖e aplikacije mo쬰 se smatrati dobrom praksom za pobolj코anje sigurnosti i izolacije.

## Napadi na kola캜i캖e

Ako prilago캠eni kola캜i캖 sadr쬴 osetljive podatke, proverite ga (posebno ako igrate CTF), jer mo쬰 biti ranjiv.

### Dekodiranje i manipulacija kola캜i캖ima

Osetljivi podaci ugra캠eni u kola캜i캖e uvek treba pa쬷jivo pregledati. Kola캜i캖i kodirani u Base64 ili sli캜nim formatima 캜esto se mogu dekodirati. Ova ranjivost omogu캖ava napada캜ima da izmene sadr쬬j kola캜i캖a i preuzmu identitet drugih korisnika enkodiraju캖i svoje izmenjene podatke nazad u kola캜i캖.

### Hakovanje sesije

Ovaj napad uklju캜uje kra캠u korisni캜kog kola캜i캖a radi neovla코캖enog pristupa njihovom nalogu unutar aplikacije. Kori코캖enjem ukradenog kola캜i캖a, napada캜 mo쬰 sebe predstaviti kao legitimni korisnik.

### Fiksacija sesije

U ovom scenariju, napada캜 vara rtvu da koristi odre캠eni kola캜i캖 za prijavu. Ako aplikacija ne dodeli novi kola캜i캖 prilikom prijave, napada캜 koji poseduje originalni kola캜i캖 mo쬰 se predstaviti kao rtva. Ova tehnika se oslanja na to da rtva prijavi sa kola캜i캖em koji je obezbedio napada캜.

Ako ste prona코li **XSS u poddomenu** ili **kontroli코ete poddomen**, pro캜itajte:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Donacija sesije

Ovde napada캜 ubedi rtvu da koristi kola캜i캖 sesije napada캜a. 콯rtva, veruju캖i da je prijavljena na svoj nalog, nesvesno 캖e izvr코avati radnje u kontekstu naloga napada캜a.

Ako ste prona코li **XSS u poddomenu** ili **kontroli코ete poddomen**, pro캜itajte:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [JWT Kola캜i캖i](../hacking-jwt-json-web-tokens.md)

Kliknite na prethodni link da biste pristupili stranici koja obja코njava mogu캖e slabosti u JWT. 

JSON Web Tokens (JWT) koji se koriste u kola캜i캖ima tako캠e mogu imati ranjivosti. Za detaljne informacije o potencijalnim slabostima i na캜inima njihovog iskori코캖avanja, preporu캜uje se pristupanje povezanom dokumentu o hakovanju JWT.

### CSRF (Cross-Site Request Forgery)

Ovaj napad prisiljava prijavljenog korisnika da izvr코i ne쬰ljene radnje na veb aplikaciji na kojoj je trenutno prijavljen. Napada캜i mogu iskoristiti kola캜i캖e koji se automatski 코alju sa svakim zahtevom ka ranjivoj stranici.

### Prazni kola캜i캖i

(Pogledajte dalje detalje u [originalnom istra쬴vanju](https://blog.ankursundara.com/cookie-bugs/))
Preglednici dozvoljavaju kreiranje kola캜i캖a bez imena, 코to se mo쬰 demonstrirati putem JavaScript-a kako sledi:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
Rezultat u poslatom zaglavlju kola캜i캖a je `a=v1; test vrednost; b=v2;`. Zanimljivo je da ovo omogu캖ava manipulaciju kola캜i캖ima ako se postavi prazan kola캜i캖 sa imenom, potencijalno kontroli코u캖i druge kola캜i캖e postavljanjem praznog kola캜i캖a na odre캠enu vrednost:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
Ovo dovodi do toga da pregleda캜 코alje zaglavlje kola캜i캖a koje svaki veb server tuma캜i kao kola캜i캖 sa imenom `a` i vredno코캖u `b`.

#### Chrome gre코ka: Problem sa Unicode zamenskim kodnim ta캜kama

U Chrome-u, ako je Unicode zamenska kodna ta캜ka deo postavljenog kola캜i캖a, `document.cookie` postaje o코te캖en, vra캖aju캖i prazan string naknadno:
```js
document.cookie = "\ud800=meep";
```
Ovo rezultira da `document.cookie` ispisuje prazan string, 코to ukazuje na trajno o코te캖enje.

#### Cookie Smuggling zbog problema sa parsiranjem

(Proverite dodatne detalje u [originalnom istra쬴vanju](https://blog.ankursundara.com/cookie-bugs/))
Nekoliko web servera, uklju캜uju캖i one iz Java (Jetty, TomCat, Undertow) i Python (Zope, cherrypy, web.py, aiohttp, bottle, webob) okre캖u se cookie stringovima zbog zastarele podr코ke za RFC2965. Oni 캜itaju cookie vrednost u dvostrukim navodnicima kao jednu vrednost 캜ak i ako sadr쬴 ta캜ke-zareze, koje bi normalno trebale razdvajati parove klju캜-vrednost:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Vulnerabilnosti ubrizgavanja kola캜i캖a

(Proverite dodatne detalje u [originalnom istra쬴vanju](https://blog.ankursundara.com/cookie-bugs/))
Nekorektno parsiranje kola캜i캖a od strane servera, posebno Undertow, Zope i onih koji koriste Python-ove `http.cookie.SimpleCookie` i `http.cookie.BaseCookie`, stvara mogu캖nosti za napade ubrizgavanjem kola캜i캖a. Ovi serveri nepravilno ograni캜avaju po캜etak novih kola캜i캖a, omogu캖avaju캖i napada캜ima da la쬴raju kola캜i캖e:

- Undertow o캜ekuje novi kola캜i캖 odmah nakon navodnog vrednosti bez ta캜ke-zareza.
- Zope tra쬴 zarez kako bi zapo캜eo parsiranje slede캖eg kola캜i캖a.
- Python-ove klase kola캜i캖a zapo캜inju parsiranje na osnovu razmaka.

Ova ranjivost je posebno opasna u veb aplikacijama koje se oslanjaju na CSRF za코titu zasnovanu na kola캜i캖ima, jer omogu캖ava napada캜ima da ubrizgaju la쬴rane kola캜i캖e sa CSRF-tokenima, potencijalno zaobilaze캖i sigurnosne mere. Problem se pogor코ava Python-ovom obradom duplikata imena kola캜i캖a, gde poslednje pojavljivanje zamenjuje prethodna. Tako캠e izaziva zabrinutost za `__Secure-` i `__Host-` kola캜i캖e u nesigurnim kontekstima i mo쬰 dovesti do zaobila쬰nja autorizacije kada se kola캜i캖i prosle캠uju serverskoj strani koja je podlo쬹a la쬴ranju.

### Dodatne provere ranjivih kola캜i캖a

#### **Osnovne provere**

* **Kola캜i캖** je **uvek isti** prilikom **prijavljivanja**.
* Odjavite se i poku코ajte da koristite isti kola캜i캖.
* Poku코ajte da se prijavite sa 2 ure캠aja (ili pregleda캜a) na isti nalog koriste캖i isti kola캜i캖.
* Proverite da li kola캜i캖 sadr쬴 neke informacije i poku코ajte da ga izmenite.
* Poku코ajte da kreirate nekoliko naloga sa gotovo istim korisni캜kim imenom i proverite da li mo쬰te primetiti sli캜nosti.
* Proverite da li postoji opcija "**zapamti me**" i vidite kako funkcioni코e. Ako postoji i mo쬰 biti ranjiva, uvek koristite samo kola캜i캖 za **zapamti me** bez drugih kola캜i캖a.
* Proverite da li prethodni kola캜i캖 i dalje funkcioni코e 캜ak i nakon promene lozinke.

#### **Napredni napadi na kola캜i캖e**

Ako se kola캜i캖 ne menja (ili se malo menja) prilikom prijavljivanja, to verovatno zna캜i da je kola캜i캖 povezan sa nekim poljem va코eg naloga (verovatno korisni캜kim imenom). Tada mo쬰te:

* Poku코ajte da kreirate mnogo **naloga** sa vrlo **sli캜nim** korisni캜kim imenima i poku코ajte da **pretpostavite** kako algoritam funkcioni코e.
* Poku코ajte da **bruteforce-ujete korisni캜ko ime**. Ako kola캜i캖 캜uva samo autentifikacioni metod za va코e korisni캜ko ime, mo쬰te kreirati nalog sa korisni캜kim imenom "**Bmin**" i **bruteforce-ovati** svaki **bit** va코eg kola캜i캖a jer jedan od kola캜i캖a koji 캖ete poku코ati 캖e biti onaj koji pripada "**admin**".
* Poku코ajte **Padding Oracle** (mo쬰te de코ifrovati sadr쬬j kola캜i캖a). Koristite **padbuster**.

**Padding Oracle - Primeri padbuster-a**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster 캖e napraviti nekoliko poku코aja i pitati vas koja je uslovna gre코ka (onaj koji nije validan).

Zatim 캖e po캜eti de코ifrovanje kola캜i캖a (mo쬰 potrajati nekoliko minuta).

Ako je napad uspe코no izvr코en, mo쬰te poku코ati da 코ifrujete 쬰ljeni string. Na primer, ako 쬰lite da **코ifrujete** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Ova izvr코enja 캖e vam dati kola캜i캖 pravilno enkriptovan i kodiran sa stringom **user=administrator** unutra.

**CBC-MAC**

Mo쬯a kola캜i캖 mo쬰 imati neku vrednost i mo쬰 biti potpisan koriste캖i CBC. Zatim, celovitost vrednosti je potpis kreiran kori코캖enjem CBC sa istom vredno코캖u. Kako se preporu캜uje kori코캖enje nultog vektora kao IV, ovaj tip provere celovitosti mo쬰 biti ranjiv.

**Napad**

1. Dobijte potpis korisni캜kog imena **administ** = **t**
2. Dobijte potpis korisni캜kog imena **rator\x00\x00\x00 XOR t** = **t'**
3. Postavite u kola캜i캖u vrednost **administrator+t'** (**t'** 캖e biti validan potpis **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Ako je kola캜i캖 enkriptovan koriste캖i ECB, mo쬰 biti ranjiv.\
Kada se prijavite, kola캜i캖 koji dobijete mora uvek biti isti.

**Kako otkriti i napasti:**

Kreirajte 2 korisnika sa skoro istim podacima (korisni캜ko ime, lozinka, email, itd.) i poku코ajte otkriti neki obrazac unutar datog kola캜i캖a.

Kreirajte korisnika koji se zove na primer "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" i proverite da li postoji neki obrazac u kola캜i캖u (kako ECB enkriptuje sa istim klju캜em svaki blok, isti enkriptovani bajtovi mogu se pojaviti ako je korisni캜ko ime enkriptovano).

Treba da postoji obrazac (veli캜ine kori코캖enog bloka). Dakle, znaju캖i kako su enkriptovani nizovi "a", mo쬰te kreirati korisni캜ko ime: "a"\*(veli캜ina bloka)+"admin". Zatim, mo쬰te izbrisati enkriptovani obrazac bloka "a" iz kola캜i캖a. Ima캖ete kola캜i캖 korisni캜kog imena "admin".

## Reference

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Prona캠ite najva쬹ije ranjivosti kako biste ih br쬰 popravili. Intruder prati va코u povr코inu napada, pokre캖e proaktivne pretnje, pronalazi probleme u celokupnom tehnolo코kom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
