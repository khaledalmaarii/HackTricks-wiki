# Piratage des Cookies

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

**Groupe de s√©curit√© Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Attributs des Cookies

Les cookies sont accompagn√©s de plusieurs attributs qui contr√¥lent leur comportement dans le navigateur de l'utilisateur. Voici un aper√ßu de ces attributs de mani√®re plus passive :

### Expires et Max-Age

La date d'expiration d'un cookie est d√©termin√©e par l'attribut `Expires`. En revanche, l'attribut `Max-age` d√©finit le temps en secondes avant qu'un cookie ne soit supprim√©. **Optez pour `Max-age` car il refl√®te des pratiques plus modernes.**

### Domaine

Les h√¥tes recevant un cookie sont sp√©cifi√©s par l'attribut `Domain`. Par d√©faut, cela est d√©fini sur l'h√¥te qui a √©mis le cookie, sans inclure ses sous-domaines. Cependant, lorsque l'attribut `Domain` est explicitement d√©fini, il englobe √©galement les sous-domaines. Cela rend la sp√©cification de l'attribut `Domain` moins restrictive, utile pour les sc√©narios o√π le partage de cookies entre les sous-domaines est n√©cessaire. Par exemple, en d√©finissant `Domain=mozilla.org`, les cookies sont accessibles sur ses sous-domaines comme `developer.mozilla.org`.

### Chemin

Un chemin d'URL sp√©cifique qui doit √™tre pr√©sent dans l'URL demand√©e pour que l'en-t√™te `Cookie` soit envoy√© est indiqu√© par l'attribut `Path`. Cet attribut consid√®re le caract√®re `/` comme un s√©parateur de r√©pertoire, permettant des correspondances dans les sous-r√©pertoires √©galement.

### R√®gles de classement

Lorsque deux cookies portent le m√™me nom, celui choisi pour l'envoi est bas√© sur :

* Le cookie correspondant au chemin le plus long dans l'URL demand√©e.
* Le cookie le plus r√©cemment d√©fini si les chemins sont identiques.

### SameSite

* L'attribut `SameSite` dicte si les cookies sont envoy√©s sur des requ√™tes provenant de domaines tiers. Il offre trois param√®tres :
* **Strict** : Restreint l'envoi du cookie sur des requ√™tes tierces.
* **Lax** : Autorise l'envoi du cookie avec des requ√™tes GET initi√©es par des sites tiers.
* **None** : Autorise l'envoi du cookie depuis n'importe quel domaine tiers.

N'oubliez pas que lors de la configuration des cookies, la compr√©hension de ces attributs peut aider √† garantir qu'ils se comportent comme pr√©vu dans diff√©rents sc√©narios.

| **Type de Requ√™te** | **Code Exemple**                   | **Cookies Envoy√©s Lorsque** |
| ------------------- | ---------------------------------- | -------------------------- |
| Lien                | \<a href="...">\</a>               | NotSet\*, Lax, None        |
| Pr√©-chargement      | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None        |
| Formulaire GET      | \<form method="GET" action="...">  | NotSet\*, Lax, None        |
| Formulaire POST     | \<form method="POST" action="..."> | NotSet\*, None             |
| iframe              | \<iframe src="...">\</iframe>      | NotSet\*, None             |
| AJAX                | $.get("...")                       | NotSet\*, None             |
| Image               | \<img src="...">                   | NetSet\*, None             |

Tableau de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) et l√©g√®rement modifi√©.\
Un cookie avec l'attribut _**SameSite**_ aidera √† **att√©nuer les attaques CSRF** o√π une session connect√©e est n√©cessaire.

**\*Notez qu'√† partir de Chrome80 (f√©v/2019), le comportement par d√©faut d'un cookie sans attribut SameSite** **sera lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Notez temporairement, apr√®s l'application de ce changement, les **cookies sans politique SameSite** **dans Chrome seront trait√©s comme None** pendant les **2 premi√®res minutes, puis comme Lax pour les requ√™tes POST intersites de niveau sup√©rieur.**

## Drapeaux des Cookies

### HttpOnly

Cela emp√™che le **client** d'acc√©der au cookie (via **Javascript** par exemple : `document.cookie`)

#### **Contournements**

* Si la page **envoie les cookies en r√©ponse** √† une requ√™te (par exemple dans une page **PHPinfo**), il est possible d'exploiter la XSS pour envoyer une requ√™te √† cette page et **voler les cookies** de la r√©ponse (consultez un exemple dans [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Cela pourrait √™tre contourn√© avec des requ√™tes **HTTP TRACE** car la r√©ponse du serveur (si cette m√©thode HTTP est disponible) refl√©tera les cookies envoy√©s. Cette technique est appel√©e **Suivi intersites**.
* Cette technique est √©vit√©e par les **navigateurs modernes en ne permettant pas l'envoi d'une requ√™te TRACE** depuis JS. Cependant, certains contournements √† cela ont √©t√© trouv√©s dans des logiciels sp√©cifiques comme l'envoi de `\r\nTRACE` au lieu de `TRACE` √† IE6.0 SP2.
* Une autre m√©thode est l'exploitation de vuln√©rabilit√©s zero/day des navigateurs.
* Il est possible de **remplacer les cookies HttpOnly** en effectuant une attaque de d√©bordement de Cookie Jar :

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Il est possible d'utiliser une attaque [**Cookie Smuggling**](./#cookie-smuggling) pour exfiltrer ces cookies

### Secure

La requ√™te enverra le cookie **uniquement** dans une requ√™te HTTP si la requ√™te est transmise sur un canal s√©curis√© (typiquement **HTTPS**).

## Pr√©fixes des Cookies

Les cookies pr√©fix√©s par `__Secure-` doivent √™tre d√©finis avec le drapeau `secure` sur les pages s√©curis√©es par HTTPS.

Pour les cookies pr√©fix√©s par `__Host-`, plusieurs conditions doivent √™tre remplies :

* Ils doivent √™tre d√©finis avec le drapeau `secure`.
* Ils doivent provenir d'une page s√©curis√©e par HTTPS.
* Ils sont interdits de sp√©cifier un domaine, emp√™chant leur transmission aux sous-domaines.
* Le chemin de ces cookies doit √™tre d√©fini sur `/`.

Il est important de noter que les cookies pr√©fix√©s par `__Host-` ne sont pas autoris√©s √† √™tre envoy√©s aux superdomaines ou aux sous-domaines. Cette restriction aide √† isoler les cookies d'application. Ainsi, l'utilisation du pr√©fixe `__Host-` pour tous les cookies d'application peut √™tre consid√©r√©e comme une bonne pratique pour renforcer la s√©curit√© et l'isolation.
### √âcrasement des cookies

Ainsi, l'une des protections des cookies pr√©fix√©s par `__Host-` est d'emp√™cher leur √©crasement par les sous-domaines. Emp√™chant par exemple les [**attaques de Cookie Tossing**](cookie-tossing.md). Dans la pr√©sentation [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg) ([**article**](https://www.usenix.org/system/files/usenixsecurity23-squarcina.pdf)) il est pr√©sent√© qu'il √©tait possible de d√©finir des cookies pr√©fix√©s par \_\_HOST- depuis un sous-domaine, en trompant l'analyseur, par exemple, en ajoutant "=" au d√©but ou au d√©but et √† la fin...:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Ou en PHP il √©tait possible d'ajouter **d'autres caract√®res au d√©but** du nom du cookie qui allaient √™tre **remplac√©s par des caract√®res de soulignement**, permettant d'√©craser les cookies `__HOST-`:

<figure><img src="../../.gitbook/assets/image (1).png" alt="" width="373"><figcaption></figcaption></figure>

## Attaques de Cookies

Si un cookie personnalis√© contient des donn√©es sensibles, v√©rifiez-le (surtout si vous participez √† un CTF), car il pourrait √™tre vuln√©rable.

### D√©codage et Manipulation des Cookies

Les donn√©es sensibles int√©gr√©es dans les cookies doivent toujours √™tre examin√©es. Les cookies encod√©s en Base64 ou des formats similaires peuvent souvent √™tre d√©cod√©s. Cette vuln√©rabilit√© permet aux attaquants de modifier le contenu du cookie et d'usurper d'autres utilisateurs en encodant leurs donn√©es modifi√©es dans le cookie.

### D√©tournement de Session

Cette attaque consiste √† voler le cookie d'un utilisateur pour acc√©der de mani√®re non autoris√©e √† son compte au sein d'une application. En utilisant le cookie vol√©, un attaquant peut usurper l'utilisateur l√©gitime.

### Fixation de Session

Dans ce sc√©nario, un attaquant trompe une victime pour utiliser un cookie sp√©cifique pour se connecter. Si l'application n'attribue pas un nouveau cookie lors de la connexion, l'attaquant, poss√©dant le cookie d'origine, peut usurper la victime. Cette technique repose sur la victime se connectant avec un cookie fourni par l'attaquant.

Si vous trouvez un **XSS dans un sous-domaine** ou que vous **contr√¥lez un sous-domaine**, lisez :

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Donation de Session

Ici, l'attaquant convainc la victime d'utiliser le cookie de session de l'attaquant. La victime, croyant √™tre connect√©e √† son propre compte, effectuera involontairement des actions dans le contexte du compte de l'attaquant.

Si vous trouvez un **XSS dans un sous-domaine** ou que vous **contr√¥lez un sous-domaine**, lisez :

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookies JWT](../hacking-jwt-json-web-tokens.md)

Cliquez sur le lien pr√©c√©dent pour acc√©der √† une page expliquant les failles possibles dans les JWT.

Les JSON Web Tokens (JWT) utilis√©s dans les cookies peuvent √©galement pr√©senter des vuln√©rabilit√©s. Pour des informations approfondies sur les failles potentielles et comment les exploiter, il est recommand√© d'acc√©der au document li√© sur le piratage des JWT.

### Forgery de Requ√™te Cross-Site (CSRF)

Cette attaque force un utilisateur connect√© √† ex√©cuter des actions non d√©sir√©es sur une application web √† laquelle il est actuellement authentifi√©. Les attaquants peuvent exploiter les cookies qui sont automatiquement envoy√©s avec chaque requ√™te vers le site vuln√©rable.

### Cookies Vides

(V√©rifiez les d√©tails suppl√©mentaires dans la [recherche originale](https://blog.ankursundara.com/cookie-bugs/)) Les navigateurs permettent la cr√©ation de cookies sans nom, ce qui peut √™tre d√©montr√© via JavaScript comme suit:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
Le r√©sultat dans l'en-t√™te cookie envoy√© est `a=v1; test value; b=v2;`. De mani√®re intrigante, cela permet la manipulation des cookies si un cookie avec un nom vide est d√©fini, contr√¥lant potentiellement d'autres cookies en d√©finissant le cookie vide √† une valeur sp√©cifique:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
Cela conduit le navigateur √† envoyer un en-t√™te de cookie interpr√©t√© par chaque serveur web comme un cookie nomm√© `a` avec une valeur `b`.

#### Bug Chrome : Probl√®me de point de code de substitution Unicode

Dans Chrome, si un point de code de substitution Unicode fait partie d'un cookie d√©fini, `document.cookie` devient corrompu, renvoyant ensuite une cha√Æne vide :
```js
document.cookie = "\ud800=meep";
```
Cela se traduit par `document.cookie` produisant une cha√Æne vide, indiquant une corruption permanente.

#### Contrebande de cookies en raison de probl√®mes d'analyse

(V√©rifiez plus de d√©tails dans la [recherche originale](https://blog.ankursundara.com/cookie-bugs/)) Plusieurs serveurs web, y compris ceux de Java (Jetty, TomCat, Undertow) et Python (Zope, cherrypy, web.py, aiohttp, bottle, webob), g√®rent mal les cha√Ænes de cookies en raison d'un support obsol√®te de RFC2965. Ils lisent une valeur de cookie entre guillemets doubles comme une seule valeur m√™me si elle inclut des points-virgules, qui devraient normalement s√©parer les paires cl√©-valeur:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Vuln√©rabilit√©s d'injection de cookies

(V√©rifiez les d√©tails suppl√©mentaires dans la [recherche originale](https://blog.ankursundara.com/cookie-bugs/)) L'analyse incorrecte des cookies par les serveurs, notamment Undertow, Zope et ceux utilisant `http.cookie.SimpleCookie` et `http.cookie.BaseCookie` de Python, cr√©e des opportunit√©s pour des attaques d'injection de cookies. Ces serveurs ne parviennent pas √† d√©limiter correctement le d√©but de nouveaux cookies, permettant aux attaquants de falsifier des cookies :

* Undertow attend un nouveau cookie imm√©diatement apr√®s une valeur entre guillemets sans point-virgule.
* Zope recherche une virgule pour commencer l'analyse du cookie suivant.
* Les classes de cookies de Python commencent l'analyse sur un caract√®re d'espace.

Cette vuln√©rabilit√© est particuli√®rement dangereuse dans les applications web reposant sur une protection CSRF bas√©e sur les cookies, car elle permet aux attaquants d'injecter des cookies de jeton CSRF falsifi√©s, contournant potentiellement les mesures de s√©curit√©. Le probl√®me est exacerb√© par la gestion des noms de cookies en double par Python, o√π la derni√®re occurrence remplace les pr√©c√©dentes. Il soul√®ve √©galement des pr√©occupations pour les cookies `__Secure-` et `__Host-` dans des contextes non s√©curis√©s et pourrait entra√Æner des contournements d'autorisation lorsque les cookies sont transmis √† des serveurs back-end susceptibles de falsification.

### V√©rifications suppl√©mentaires des cookies vuln√©rables

#### **V√©rifications de base**

* Le **cookie** est le **m√™me** √† chaque fois que vous **vous connectez**.
* D√©connectez-vous et essayez d'utiliser le m√™me cookie.
* Essayez de vous connecter avec 2 appareils (ou navigateurs) sur le m√™me compte en utilisant le m√™me cookie.
* V√©rifiez si le cookie contient des informations et essayez de le modifier.
* Essayez de cr√©er plusieurs comptes avec des noms d'utilisateur presque identiques et v√©rifiez s'il y a des similitudes.
* V√©rifiez l'option "**se souvenir de moi**" si elle existe pour voir comment elle fonctionne. Si elle existe et peut √™tre vuln√©rable, utilisez toujours le cookie de **se souvenir de moi** sans aucun autre cookie.
* V√©rifiez si le cookie pr√©c√©dent fonctionne m√™me apr√®s avoir chang√© le mot de passe.

#### **Attaques de cookies avanc√©es**

Si le cookie reste le m√™me (ou presque) lorsque vous vous connectez, cela signifie probablement que le cookie est li√© √† un champ de votre compte (probablement le nom d'utilisateur). Ensuite, vous pouvez :

* Essayez de cr√©er beaucoup de **comptes** avec des noms d'utilisateur tr√®s **similaires** et essayez de **deviner** comment fonctionne l'algorithme.
* Essayez de **forcer le nom d'utilisateur**. Si le cookie ne sauvegarde que comme m√©thode d'authentification pour votre nom d'utilisateur, vous pouvez cr√©er un compte avec le nom d'utilisateur "**Bmin**" et **forcer** chaque **bit** de votre cookie car l'un des cookies que vous essayerez appartiendra √† "**admin**".
* Essayez **Padding Oracle** (vous pouvez d√©crypter le contenu du cookie). Utilisez **padbuster**.

**Padding Oracle - Exemples de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster fera plusieurs tentatives et vous demandera quelle condition est la condition d'erreur (celle qui n'est pas valide).

Ensuite, il commencera √† d√©crypter le cookie (cela peut prendre plusieurs minutes).

Si l'attaque a r√©ussi, vous pourriez essayer de crypter une cha√Æne de votre choix. Par exemple, si vous vouliez **crypter** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Cette ex√©cution vous donnera le cookie correctement chiffr√© et encod√© avec la cha√Æne **user=administrator** √† l'int√©rieur.

**CBC-MAC**

Peut-√™tre qu'un cookie pourrait avoir une certaine valeur et √™tre sign√© en utilisant le CBC. Ensuite, l'int√©grit√© de la valeur est la signature cr√©√©e en utilisant le CBC avec la m√™me valeur. Comme il est recommand√© d'utiliser un vecteur nul comme IV, ce type de v√©rification d'int√©grit√© pourrait √™tre vuln√©rable.

**L'attaque**

1. Obtenir la signature du nom d'utilisateur **administ** = **t**
2. Obtenir la signature du nom d'utilisateur **rator\x00\x00\x00 XOR t** = **t'**
3. D√©finir dans le cookie la valeur **administrator+t'** (**t'** sera une signature valide de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Si le cookie est chiffr√© en utilisant ECB, il pourrait √™tre vuln√©rable.\
Lorsque vous vous connectez, le cookie que vous recevez doit √™tre toujours le m√™me.

**Comment d√©tecter et attaquer :**

Cr√©ez 2 utilisateurs avec des donn√©es presque identiques (nom d'utilisateur, mot de passe, e-mail, etc.) et essayez de d√©couvrir un certain motif √† l'int√©rieur du cookie donn√©.

Cr√©ez un utilisateur appel√© par exemple "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" et v√©rifiez s'il y a un motif dans le cookie (comme ECB chiffre avec la m√™me cl√© chaque bloc, les m√™mes octets chiffr√©s pourraient appara√Ætre si le nom d'utilisateur est chiffr√©).

Il devrait y avoir un motif (avec la taille d'un bloc utilis√©). Ainsi, en sachant comment un tas de "a" est chiffr√©, vous pouvez cr√©er un nom d'utilisateur : "a"\*(taille du bloc)+"admin". Ensuite, vous pourriez supprimer le motif chiffr√© d'un bloc de "a" du cookie. Et vous aurez le cookie du nom d'utilisateur "admin".

## R√©f√©rences

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
