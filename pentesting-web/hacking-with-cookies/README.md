# Cookies Hacking

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}


## Cookie å±æ€§

Cookies å…·æœ‰å¤šä¸ªå±æ€§ï¼Œæ§åˆ¶å®ƒä»¬åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­çš„è¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯è¿™äº›å±æ€§çš„æ¦‚è¿°ï¼š

### è¿‡æœŸå’Œæœ€å¤§å¹´é¾„

Cookie çš„è¿‡æœŸæ—¥æœŸç”± `Expires` å±æ€§å†³å®šã€‚ç›¸åï¼Œ`Max-age` å±æ€§å®šä¹‰äº†åœ¨åˆ é™¤ Cookie ä¹‹å‰çš„ç§’æ•°ã€‚**é€‰æ‹© `Max-age`ï¼Œå› ä¸ºå®ƒåæ˜ äº†æ›´ç°ä»£çš„åšæ³•ã€‚**

### åŸŸ

æ¥æ”¶ Cookie çš„ä¸»æœºç”± `Domain` å±æ€§æŒ‡å®šã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™è®¾ç½®ä¸ºå‘å‡º Cookie çš„ä¸»æœºï¼Œä¸åŒ…æ‹¬å…¶å­åŸŸã€‚ç„¶è€Œï¼Œå½“ `Domain` å±æ€§è¢«æ˜¾å¼è®¾ç½®æ—¶ï¼Œå®ƒä¹ŸåŒ…æ‹¬å­åŸŸã€‚è¿™ä½¿å¾— `Domain` å±æ€§çš„æŒ‡å®šæˆä¸ºä¸€ä¸ªä¸é‚£ä¹ˆä¸¥æ ¼çš„é€‰é¡¹ï¼Œé€‚ç”¨äºéœ€è¦è·¨å­åŸŸå…±äº« Cookie çš„åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œè®¾ç½® `Domain=mozilla.org` ä½¿å¾—åœ¨å…¶å­åŸŸå¦‚ `developer.mozilla.org` ä¸Šå¯ä»¥è®¿é—® Cookieã€‚

### è·¯å¾„

`Path` å±æ€§æŒ‡ç¤ºå¿…é¡»åœ¨è¯·æ±‚çš„ URL ä¸­å­˜åœ¨çš„ç‰¹å®š URL è·¯å¾„ï¼Œä»¥ä¾¿å‘é€ `Cookie` å¤´ã€‚æ­¤å±æ€§å°† `/` å­—ç¬¦è§†ä¸ºç›®å½•åˆ†éš”ç¬¦ï¼Œå…è®¸åœ¨å­ç›®å½•ä¸­åŒ¹é…ã€‚

### æ’åºè§„åˆ™

å½“ä¸¤ä¸ª Cookie å…·æœ‰ç›¸åŒåç§°æ—¶ï¼Œé€‰æ‹©å‘é€çš„ Cookie åŸºäºï¼š

* ä¸è¯·æ±‚çš„ URL ä¸­æœ€é•¿è·¯å¾„åŒ¹é…çš„ Cookieã€‚
* å¦‚æœè·¯å¾„ç›¸åŒï¼Œåˆ™é€‰æ‹©æœ€è¿‘è®¾ç½®çš„ Cookieã€‚

### SameSite

* `SameSite` å±æ€§å†³å®šæ˜¯å¦åœ¨æ¥è‡ªç¬¬ä¸‰æ–¹åŸŸçš„è¯·æ±‚ä¸­å‘é€ Cookieã€‚å®ƒæä¾›ä¸‰ç§è®¾ç½®ï¼š
* **Strict**: é™åˆ¶ Cookie åœ¨ç¬¬ä¸‰æ–¹è¯·æ±‚ä¸­å‘é€ã€‚
* **Lax**: å…è®¸ Cookie ä¸ç”±ç¬¬ä¸‰æ–¹ç½‘ç«™å‘èµ·çš„ GET è¯·æ±‚ä¸€èµ·å‘é€ã€‚
* **None**: å…è®¸ Cookie ä»ä»»ä½•ç¬¬ä¸‰æ–¹åŸŸå‘é€ã€‚

è¯·è®°ä½ï¼Œåœ¨é…ç½® Cookie æ—¶ï¼Œç†è§£è¿™äº›å±æ€§å¯ä»¥å¸®åŠ©ç¡®ä¿å®ƒä»¬åœ¨ä¸åŒåœºæ™¯ä¸­æŒ‰é¢„æœŸè¡Œä¸ºã€‚

| **è¯·æ±‚ç±»å‹** | **ç¤ºä¾‹ä»£ç **                   | **å‘é€ Cookie çš„æ¡ä»¶** |
| -------------- | ------------------------------ | --------------------- |
| é“¾æ¥           | \<a href="...">\</a>          | NotSet\*, Lax, None   |
| é¢„æ¸²æŸ“        | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None   |
| è¡¨å• GET      | \<form method="GET" action="...">  | NotSet\*, Lax, None   |
| è¡¨å• POST     | \<form method="POST" action="..."> | NotSet\*, None        |
| iframe         | \<iframe src="...">\</iframe>  | NotSet\*, None        |
| AJAX           | $.get("...")                   | NotSet\*, None        |
| å›¾ç‰‡          | \<img src="...">               | NetSet\*, None        |

è¡¨æ ¼æ¥è‡ª [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) å¹¶ç¨ä½œä¿®æ”¹ã€‚\
å…·æœ‰ _**SameSite**_ å±æ€§çš„ Cookie å°† **å‡è½» CSRF æ”»å‡»**ï¼Œå…¶ä¸­éœ€è¦ç™»å½•ä¼šè¯ã€‚

**\*è¯·æ³¨æ„ï¼Œä» Chrome80ï¼ˆ2019å¹´2æœˆï¼‰å¼€å§‹ï¼Œæœªè®¾ç½® Cookie SameSite å±æ€§çš„ Cookie çš„é»˜è®¤è¡Œä¸ºå°†æ˜¯ Lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
è¯·æ³¨æ„ï¼Œä¸´æ—¶æƒ…å†µä¸‹ï¼Œåœ¨åº”ç”¨æ­¤æ›´æ”¹åï¼Œ**æ²¡æœ‰ SameSite** **ç­–ç•¥çš„ Cookie åœ¨ Chrome ä¸­å°†è¢«** **è§†ä¸º None**ï¼Œåœ¨ **å‰ 2 åˆ†é’Ÿå†…ï¼Œç„¶ååœ¨é¡¶çº§è·¨ç«™ç‚¹ POST è¯·æ±‚ä¸­è§†ä¸º Lax**ã€‚

## Cookies æ ‡å¿—

### HttpOnly

è¿™é¿å…äº† **å®¢æˆ·ç«¯** è®¿é—® Cookieï¼ˆä¾‹å¦‚é€šè¿‡ **Javascript**: `document.cookie`ï¼‰

#### **ç»•è¿‡**

* å¦‚æœé¡µé¢ **å°† Cookie ä½œä¸ºè¯·æ±‚çš„å“åº”å‘é€**ï¼ˆä¾‹å¦‚åœ¨ **PHPinfo** é¡µé¢ä¸­ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨ XSS å‘é€è¯·æ±‚åˆ°æ­¤é¡µé¢å¹¶ **çªƒå–å“åº”ä¸­çš„ Cookie**ï¼ˆè¯·æŸ¥çœ‹ç¤ºä¾‹ [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/)ï¼‰ã€‚
* è¿™å¯ä»¥é€šè¿‡ **TRACE** **HTTP** è¯·æ±‚ç»•è¿‡ï¼Œå› ä¸ºæœåŠ¡å™¨çš„å“åº”å°†åæ˜ å‘é€çš„ Cookieï¼ˆå¦‚æœæ­¤ HTTP æ–¹æ³•å¯ç”¨ï¼‰ã€‚æ­¤æŠ€æœ¯ç§°ä¸º **è·¨ç«™ç‚¹è·Ÿè¸ª**ã€‚
* ç°ä»£æµè§ˆå™¨é€šè¿‡ä¸å…è®¸ä» JS å‘é€ TRACE è¯·æ±‚æ¥é¿å…æ­¤æŠ€æœ¯ã€‚ç„¶è€Œï¼Œåœ¨ç‰¹å®šè½¯ä»¶ä¸­å‘ç°äº†ä¸€äº›ç»•è¿‡æ–¹æ³•ï¼Œä¾‹å¦‚å‘ IE6.0 SP2 å‘é€ `\r\nTRACE` è€Œä¸æ˜¯ `TRACE`ã€‚
* å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨æµè§ˆå™¨çš„é›¶æ—¥æ¼æ´ã€‚
* å¯ä»¥é€šè¿‡æ‰§è¡Œ Cookie Jar æº¢å‡ºæ”»å‡»æ¥ **è¦†ç›– HttpOnly Cookie**ï¼š

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* å¯ä»¥ä½¿ç”¨ [**Cookie Smuggling**](./#cookie-smuggling) æ”»å‡»æ¥å¤–æ³„è¿™äº› Cookie

### Secure

è¯·æ±‚å°† **ä»…** åœ¨é€šè¿‡å®‰å…¨é€šé“ï¼ˆé€šå¸¸æ˜¯ **HTTPS**ï¼‰ä¼ è¾“æ—¶å‘é€ Cookieã€‚

## Cookies å‰ç¼€

ä»¥ `__Secure-` å¼€å¤´çš„ Cookie å¿…é¡»ä¸æ¥è‡ª HTTPS çš„é¡µé¢ä¸€èµ·è®¾ç½® `secure` æ ‡å¿—ã€‚

å¯¹äºä»¥ `__Host-` å¼€å¤´çš„ Cookieï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š

* å¿…é¡»è®¾ç½® `secure` æ ‡å¿—ã€‚
* å¿…é¡»æ¥è‡ªç”± HTTPS ä¿æŠ¤çš„é¡µé¢ã€‚
* ç¦æ­¢æŒ‡å®šåŸŸï¼Œé˜²æ­¢å…¶ä¼ è¾“åˆ°å­åŸŸã€‚
* è¿™äº› Cookie çš„è·¯å¾„å¿…é¡»è®¾ç½®ä¸º `/`ã€‚

é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œä»¥ `__Host-` å¼€å¤´çš„ Cookie ä¸å…è®¸å‘é€åˆ°è¶…çº§åŸŸæˆ–å­åŸŸã€‚æ­¤é™åˆ¶æœ‰åŠ©äºéš”ç¦»åº”ç”¨ç¨‹åº Cookieã€‚å› æ­¤ï¼Œä½¿ç”¨ `__Host-` å‰ç¼€ä¸ºæ‰€æœ‰åº”ç”¨ç¨‹åº Cookie æ˜¯å¢å¼ºå®‰å…¨æ€§å’Œéš”ç¦»æ€§çš„è‰¯å¥½åšæ³•ã€‚

### è¦†ç›– Cookie

å› æ­¤ï¼Œ`__Host-` å‰ç¼€ Cookie çš„ä¿æŠ¤ä¹‹ä¸€æ˜¯é˜²æ­¢å®ƒä»¬è¢«å­åŸŸè¦†ç›–ã€‚ä¾‹å¦‚ï¼Œé˜²æ­¢ [**Cookie Tossing æ”»å‡»**](cookie-tossing.md)ã€‚åœ¨æ¼”è®² [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg) ([**è®ºæ–‡**](https://www.usenix.org/system/files/usenixsecurity23-squarcina.pdf)) ä¸­ï¼Œå±•ç¤ºäº†å¯ä»¥é€šè¿‡æ¬ºéª—è§£æå™¨ä»å­åŸŸè®¾ç½® __HOST- å‰ç¼€çš„ Cookieï¼Œä¾‹å¦‚ï¼Œåœ¨å¼€å¤´æˆ–ç»“å°¾æ·»åŠ  "="ï¼š

<figure><img src="../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

æˆ–è€…åœ¨ PHP ä¸­ï¼Œå¯ä»¥åœ¨ Cookie åç§°çš„ **å¼€å¤´æ·»åŠ å…¶ä»–å­—ç¬¦**ï¼Œè¿™äº›å­—ç¬¦å°†è¢« **æ›¿æ¢ä¸ºä¸‹åˆ’çº¿**ï¼Œå…è®¸è¦†ç›– `__HOST-` Cookieï¼š

<figure><img src="../../.gitbook/assets/image (7) (1).png" alt="" width="373"><figcaption></figcaption></figure>

## Cookies æ”»å‡»

å¦‚æœè‡ªå®šä¹‰ Cookie åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥å®ƒï¼ˆç‰¹åˆ«æ˜¯å¦‚æœæ‚¨æ­£åœ¨è¿›è¡Œ CTFï¼‰ï¼Œå› ä¸ºå®ƒå¯èƒ½å­˜åœ¨æ¼æ´ã€‚

### è§£ç å’Œæ“çºµ Cookies

åµŒå…¥ Cookie çš„æ•æ„Ÿæ•°æ®åº”å§‹ç»ˆå—åˆ°å®¡æŸ¥ã€‚ä»¥ Base64 æˆ–ç±»ä¼¼æ ¼å¼ç¼–ç çš„ Cookie é€šå¸¸å¯ä»¥è¢«è§£ç ã€‚è¿™ç§æ¼æ´å…è®¸æ”»å‡»è€…æ›´æ”¹ Cookie çš„å†…å®¹ï¼Œå¹¶é€šè¿‡å°†å…¶ä¿®æ”¹åçš„æ•°æ®é‡æ–°ç¼–ç å› Cookie æ¥å†’å……å…¶ä»–ç”¨æˆ·ã€‚

### ä¼šè¯åŠ«æŒ

æ­¤æ”»å‡»æ¶‰åŠçªƒå–ç”¨æˆ·çš„ Cookieï¼Œä»¥è·å¾—å¯¹å…¶åœ¨åº”ç”¨ç¨‹åºä¸­çš„å¸æˆ·çš„æœªæˆæƒè®¿é—®ã€‚é€šè¿‡ä½¿ç”¨è¢«ç›—çš„ Cookieï¼Œæ”»å‡»è€…å¯ä»¥å†’å……åˆæ³•ç”¨æˆ·ã€‚

### ä¼šè¯å›ºå®š

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…è¯±ä½¿å—å®³è€…ä½¿ç”¨ç‰¹å®šçš„ Cookie ç™»å½•ã€‚å¦‚æœåº”ç”¨ç¨‹åºåœ¨ç™»å½•æ—¶ä¸åˆ†é…æ–° Cookieï¼Œæ”»å‡»è€…å°±å¯ä»¥ä½¿ç”¨åŸå§‹ Cookie å†’å……å—å®³è€…ã€‚æ­¤æŠ€æœ¯ä¾èµ–äºå—å®³è€…ä½¿ç”¨æ”»å‡»è€…æä¾›çš„ Cookie ç™»å½•ã€‚

å¦‚æœæ‚¨åœ¨ **å­åŸŸä¸­å‘ç°äº† XSS** æˆ–æ‚¨ **æ§åˆ¶ä¸€ä¸ªå­åŸŸ**ï¼Œè¯·é˜…è¯»ï¼š

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### ä¼šè¯æèµ 

åœ¨è¿™é‡Œï¼Œæ”»å‡»è€…è¯´æœå—å®³è€…ä½¿ç”¨æ”»å‡»è€…çš„ä¼šè¯ Cookieã€‚å—å®³è€…ç›¸ä¿¡ä»–ä»¬å·²ç™»å½•è‡ªå·±çš„å¸æˆ·ï¼Œå°†æ— æ„ä¸­åœ¨æ”»å‡»è€…çš„å¸æˆ·ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œæ“ä½œã€‚

å¦‚æœæ‚¨åœ¨ **å­åŸŸä¸­å‘ç°äº† XSS** æˆ–æ‚¨ **æ§åˆ¶ä¸€ä¸ªå­åŸŸ**ï¼Œè¯·é˜…è¯»ï¼š

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [JWT Cookies](../hacking-jwt-json-web-tokens.md)

ç‚¹å‡»ä¸Šé¢çš„é“¾æ¥è®¿é—®è§£é‡Š JWT å¯èƒ½å­˜åœ¨ç¼ºé™·çš„é¡µé¢ã€‚

ç”¨äº Cookie çš„ JSON Web Tokens (JWT) ä¹Ÿå¯èƒ½å­˜åœ¨æ¼æ´ã€‚æœ‰å…³æ½œåœ¨ç¼ºé™·åŠå…¶åˆ©ç”¨æ–¹å¼çš„è¯¦ç»†ä¿¡æ¯ï¼Œå»ºè®®è®¿é—®æœ‰å…³é»‘å®¢ JWT çš„é“¾æ¥æ–‡æ¡£ã€‚

### è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF)

æ­¤æ”»å‡»è¿«ä½¿å·²ç™»å½•ç”¨æˆ·åœ¨ä»–ä»¬å½“å‰å·²è®¤è¯çš„ Web åº”ç”¨ç¨‹åºä¸Šæ‰§è¡Œä¸å¿…è¦çš„æ“ä½œã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è‡ªåŠ¨éšæ¯ä¸ªè¯·æ±‚å‘é€åˆ°æ˜“å—æ”»å‡»ç«™ç‚¹çš„ Cookieã€‚

### ç©º Cookie

ï¼ˆè¯·æŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://blog.ankursundara.com/cookie-bugs/)ä¸­çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼‰æµè§ˆå™¨å…è®¸åˆ›å»ºæ²¡æœ‰åç§°çš„ Cookieï¼Œè¿™å¯ä»¥é€šè¿‡ JavaScript è¿›è¡Œæ¼”ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
ç»“æœåœ¨å‘é€çš„ cookie å¤´ä¸­æ˜¯ `a=v1; test value; b=v2;`ã€‚æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœè®¾ç½®äº†ä¸€ä¸ªç©ºåç§°çš„ cookieï¼Œè¿™å…è®¸å¯¹ cookies è¿›è¡Œæ“æ§ï¼Œé€šè¿‡å°†ç©º cookie è®¾ç½®ä¸ºç‰¹å®šå€¼ï¼Œå¯èƒ½æ§åˆ¶å…¶ä»– cookiesï¼š
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
è¿™å¯¼è‡´æµè§ˆå™¨å‘é€ä¸€ä¸ª cookie å¤´ï¼Œæ¯ä¸ª web æœåŠ¡å™¨å°†å…¶è§£é‡Šä¸ºåä¸º `a`ï¼Œå€¼ä¸º `b` çš„ cookieã€‚

#### Chrome Bug: Unicode Surrogate Codepoint Issue

åœ¨ Chrome ä¸­ï¼Œå¦‚æœ Unicode ä»£ç†ä»£ç ç‚¹æ˜¯è®¾ç½®çš„ cookie çš„ä¸€éƒ¨åˆ†ï¼Œ`document.cookie` å°†å˜å¾—æŸåï¼Œéšåè¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼š
```js
document.cookie = "\ud800=meep";
```
è¿™å¯¼è‡´ `document.cookie` è¾“å‡ºä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œè¡¨æ˜æ°¸ä¹…æ€§æŸåã€‚

#### ç”±äºè§£æé—®é¢˜å¯¼è‡´çš„ Cookie èµ°ç§

ï¼ˆæŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://blog.ankursundara.com/cookie-bugs/)çš„æ›´å¤šç»†èŠ‚ï¼‰åŒ…æ‹¬ Javaï¼ˆJetty, TomCat, Undertowï¼‰å’Œ Pythonï¼ˆZope, cherrypy, web.py, aiohttp, bottle, webobï¼‰åœ¨å†…çš„å¤šä¸ªç½‘ç»œæœåŠ¡å™¨ï¼Œç”±äºå¯¹è¿‡æ—¶çš„ RFC2965 æ”¯æŒï¼Œé”™è¯¯å¤„ç† cookie å­—ç¬¦ä¸²ã€‚å®ƒä»¬å°†åŒå¼•å·æ‹¬èµ·æ¥çš„ cookie å€¼è§†ä¸ºå•ä¸ªå€¼ï¼Œå³ä½¿å®ƒåŒ…å«åˆ†å·ï¼Œè€Œåˆ†å·é€šå¸¸åº”åˆ†éš”é”®å€¼å¯¹ï¼š
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Cookie Injection Vulnerabilities

(æŸ¥çœ‹[åŸå§‹ç ”ç©¶](https://blog.ankursundara.com/cookie-bugs/)çš„æ›´å¤šç»†èŠ‚) æœåŠ¡å™¨å¯¹ cookies çš„é”™è¯¯è§£æï¼Œç‰¹åˆ«æ˜¯ Undertowã€Zope ä»¥åŠä½¿ç”¨ Python çš„ `http.cookie.SimpleCookie` å’Œ `http.cookie.BaseCookie` çš„æœåŠ¡å™¨ï¼Œåˆ›é€ äº† cookie æ³¨å…¥æ”»å‡»çš„æœºä¼šã€‚è¿™äº›æœåŠ¡å™¨æœªèƒ½æ­£ç¡®åˆ†éš”æ–° cookie çš„å¼€å§‹ï¼Œå…è®¸æ”»å‡»è€…ä¼ªé€  cookiesï¼š

* Undertow æœŸæœ›åœ¨å¸¦å¼•å·çš„å€¼åç«‹å³å‡ºç°æ–° cookieï¼Œè€Œä¸éœ€è¦åˆ†å·ã€‚
* Zope å¯»æ‰¾é€—å·ä»¥å¼€å§‹è§£æä¸‹ä¸€ä¸ª cookieã€‚
* Python çš„ cookie ç±»åœ¨ç©ºæ ¼å­—ç¬¦ä¸Šå¼€å§‹è§£æã€‚

è¿™ç§æ¼æ´åœ¨ä¾èµ–åŸºäº cookie çš„ CSRF ä¿æŠ¤çš„ web åº”ç”¨ç¨‹åºä¸­å°¤å…¶å±é™©ï¼Œå› ä¸ºå®ƒå…è®¸æ”»å‡»è€…æ³¨å…¥ä¼ªé€ çš„ CSRF-token cookiesï¼Œå¯èƒ½ç»•è¿‡å®‰å…¨æªæ–½ã€‚è¿™ä¸ªé—®é¢˜å›  Python å¯¹é‡å¤ cookie åç§°çš„å¤„ç†è€ŒåŠ å‰§ï¼Œæœ€åä¸€ä¸ªå‡ºç°çš„åç§°ä¼šè¦†ç›–ä¹‹å‰çš„åç§°ã€‚å®ƒè¿˜å¼•å‘äº†å¯¹ä¸å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ `__Secure-` å’Œ `__Host-` cookies çš„æ‹…å¿§ï¼Œå¹¶å¯èƒ½å¯¼è‡´åœ¨å°† cookies ä¼ é€’ç»™æ˜“å—ä¼ªé€ æ”»å‡»çš„åç«¯æœåŠ¡å™¨æ—¶ç»•è¿‡æˆæƒã€‚

### Extra Vulnerable Cookies Checks

#### **Basic checks**

* **cookie** æ¯æ¬¡ **ç™»å½•** æ—¶éƒ½æ˜¯ **ç›¸åŒ** çš„ã€‚
* ç™»å‡ºå¹¶å°è¯•ä½¿ç”¨ç›¸åŒçš„ cookieã€‚
* å°è¯•ç”¨ 2 ä¸ªè®¾å¤‡ï¼ˆæˆ–æµè§ˆå™¨ï¼‰ä½¿ç”¨ç›¸åŒçš„ cookie ç™»å½•åŒä¸€è´¦æˆ·ã€‚
* æ£€æŸ¥ cookie ä¸­æ˜¯å¦æœ‰ä»»ä½•ä¿¡æ¯å¹¶å°è¯•ä¿®æ”¹å®ƒã€‚
* å°è¯•åˆ›å»ºå¤šä¸ªå‡ ä¹ç›¸åŒç”¨æˆ·åçš„è´¦æˆ·å¹¶æ£€æŸ¥æ˜¯å¦å¯ä»¥çœ‹åˆ°ç›¸ä¼¼ä¹‹å¤„ã€‚
* æ£€æŸ¥æ˜¯å¦å­˜åœ¨ "**è®°ä½æˆ‘**" é€‰é¡¹ä»¥æŸ¥çœ‹å…¶å·¥ä½œåŸç†ã€‚å¦‚æœå­˜åœ¨å¹¶å¯èƒ½å­˜åœ¨æ¼æ´ï¼Œå§‹ç»ˆä½¿ç”¨ **è®°ä½æˆ‘** çš„ cookieï¼Œè€Œä¸ä½¿ç”¨å…¶ä»– cookieã€‚
* æ£€æŸ¥å³ä½¿åœ¨æ›´æ”¹å¯†ç åï¼Œä¹‹å‰çš„ cookie æ˜¯å¦ä»ç„¶æœ‰æ•ˆã€‚

#### **Advanced cookies attacks**

å¦‚æœåœ¨ç™»å½•æ—¶ cookie ä¿æŒç›¸åŒï¼ˆæˆ–å‡ ä¹ç›¸åŒï¼‰ï¼Œè¿™å¯èƒ½æ„å‘³ç€ cookie ä¸æ‚¨è´¦æˆ·çš„æŸä¸ªå­—æ®µï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·åï¼‰ç›¸å…³ã€‚ç„¶åæ‚¨å¯ä»¥ï¼š

* å°è¯•åˆ›å»ºè®¸å¤šç”¨æˆ·åéå¸¸ **ç›¸ä¼¼** çš„ **è´¦æˆ·** å¹¶å°è¯• **çŒœæµ‹** ç®—æ³•çš„å·¥ä½œåŸç†ã€‚
* å°è¯• **æš´åŠ›ç ´è§£ç”¨æˆ·å**ã€‚å¦‚æœ cookie ä»…ä½œä¸ºæ‚¨ç”¨æˆ·åçš„èº«ä»½éªŒè¯æ–¹æ³•ä¿å­˜ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·åä¸º "**Bmin**" çš„è´¦æˆ·ï¼Œå¹¶ **æš´åŠ›ç ´è§£** æ‚¨çš„ cookie çš„æ¯ä¸€ä¸ª **ä½**ï¼Œå› ä¸ºæ‚¨å°è¯•çš„å…¶ä¸­ä¸€ä¸ª cookie å°†å±äº "**admin**"ã€‚
* å°è¯• **Padding** **Oracle**ï¼ˆæ‚¨å¯ä»¥è§£å¯† cookie çš„å†…å®¹ï¼‰ã€‚ä½¿ç”¨ **padbuster**ã€‚

**Padding Oracle - Padbuster examples**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster å°†è¿›è¡Œå¤šæ¬¡å°è¯•ï¼Œå¹¶ä¼šè¯¢é—®æ‚¨å“ªä¸ªæ¡ä»¶æ˜¯é”™è¯¯æ¡ä»¶ï¼ˆå³æ— æ•ˆçš„æ¡ä»¶ï¼‰ã€‚

ç„¶åå®ƒå°†å¼€å§‹è§£å¯† cookieï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰

å¦‚æœæ”»å‡»æˆåŠŸæ‰§è¡Œï¼Œåˆ™æ‚¨å¯ä»¥å°è¯•åŠ å¯†æ‚¨é€‰æ‹©çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æƒ³è¦ **encrypt** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
è¿™ä¸ªæ‰§è¡Œå°†ç»™ä½ æ­£ç¡®åŠ å¯†å’Œç¼–ç çš„cookieï¼Œå…¶ä¸­åŒ…å«å­—ç¬¦ä¸²**user=administrator**ã€‚

**CBC-MAC**

ä¹Ÿè®¸ä¸€ä¸ªcookieå¯ä»¥æœ‰ä¸€äº›å€¼ï¼Œå¹¶å¯ä»¥ä½¿ç”¨CBCè¿›è¡Œç­¾åã€‚ç„¶åï¼Œå€¼çš„å®Œæ•´æ€§æ˜¯ä½¿ç”¨ç›¸åŒå€¼çš„CBCåˆ›å»ºçš„ç­¾åã€‚ç”±äºå»ºè®®ä½¿ç”¨ç©ºå‘é‡ä½œä¸ºIVï¼Œè¿™ç§å®Œæ•´æ€§æ£€æŸ¥å¯èƒ½ä¼šå—åˆ°æ”»å‡»ã€‚

**æ”»å‡»**

1. è·å–ç”¨æˆ·å**administ**çš„ç­¾å = **t**
2. è·å–ç”¨æˆ·å**rator\x00\x00\x00 XOR t**çš„ç­¾å = **t'**
3. åœ¨cookieä¸­è®¾ç½®å€¼**administrator+t'**ï¼ˆ**t'**å°†æ˜¯**(rator\x00\x00\x00 XOR t) XOR t**çš„æœ‰æ•ˆç­¾å = **rator\x00\x00\x00**ï¼‰

**ECB**

å¦‚æœcookieä½¿ç”¨ECBåŠ å¯†ï¼Œåˆ™å¯èƒ½ä¼šå—åˆ°æ”»å‡»ã€‚\
å½“ä½ ç™»å½•æ—¶ï¼Œæ”¶åˆ°çš„cookieå¿…é¡»å§‹ç»ˆç›¸åŒã€‚

**å¦‚ä½•æ£€æµ‹å’Œæ”»å‡»ï¼š**

åˆ›å»ºä¸¤ä¸ªå‡ ä¹ç›¸åŒæ•°æ®çš„ç”¨æˆ·ï¼ˆç”¨æˆ·åã€å¯†ç ã€ç”µå­é‚®ä»¶ç­‰ï¼‰ï¼Œå¹¶å°è¯•å‘ç°ç»™å®šcookieä¸­çš„æŸäº›æ¨¡å¼ã€‚

åˆ›å»ºä¸€ä¸ªåä¸ºâ€œaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaâ€çš„ç”¨æˆ·ï¼Œå¹¶æ£€æŸ¥cookieä¸­æ˜¯å¦æœ‰ä»»ä½•æ¨¡å¼ï¼ˆç”±äºECBä½¿ç”¨ç›¸åŒçš„å¯†é’¥åŠ å¯†æ¯ä¸ªå—ï¼Œå¦‚æœç”¨æˆ·åè¢«åŠ å¯†ï¼Œåˆ™ç›¸åŒçš„åŠ å¯†å­—èŠ‚å¯èƒ½ä¼šå‡ºç°ï¼‰ã€‚

åº”è¯¥æœ‰ä¸€ä¸ªæ¨¡å¼ï¼ˆä¸ä½¿ç”¨çš„å—çš„å¤§å°ç›¸åŒï¼‰ã€‚å› æ­¤ï¼ŒçŸ¥é“ä¸€å †â€œaâ€æ˜¯å¦‚ä½•åŠ å¯†çš„ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·åï¼šâ€œaâ€*(å—çš„å¤§å°)+â€œadminâ€ã€‚ç„¶åï¼Œä½ å¯ä»¥ä»cookieä¸­åˆ é™¤ä¸€ä¸ªå—çš„â€œaâ€çš„åŠ å¯†æ¨¡å¼ã€‚ä½ å°†æ‹¥æœ‰ç”¨æˆ·åâ€œadminâ€çš„cookieã€‚

## å‚è€ƒæ–‡çŒ®

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)


{% hint style="success" %}
å­¦ä¹ å’Œå®è·µAWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µGCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒHackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**telegramç¾¤ç»„**](https://t.me/peass)æˆ–**åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubåº“æäº¤PRåˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
