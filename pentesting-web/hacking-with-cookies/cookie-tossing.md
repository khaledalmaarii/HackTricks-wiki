# Cookie Tossing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Description

Ako napadaÄ moÅ¾e **kontrolisati poddomen ili domen kompanije ili pronaÄ‘e XSS u poddomeni**, moÄ‡i Ä‡e da izvede ovaj napad.

Kao Å¡to je navedeno u sekciji Hacking Cookies, kada se **kolaÄiÄ‡ postavi na domen (specifikujuÄ‡i ga), koristiÄ‡e se u domenu i poddomenima.**

{% hint style="danger" %}
Stoga, **napadaÄ Ä‡e moÄ‡i da postavi specifiÄan kolaÄiÄ‡ na domen i poddomene tako Å¡to Ä‡e uraditi neÅ¡to poput** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Ovo moÅ¾e biti opasno jer napadaÄ moÅ¾e:

* **Fiksirati kolaÄiÄ‡ Å¾rtve na napadaÄevom nalogu** tako da, ako korisnik ne primeti, **izvrÅ¡i radnje na napadaÄevom nalogu** i napadaÄ moÅ¾e dobiti neke zanimljive informacije (proveriti istoriju pretraga korisnika na platformi, Å¾rtva moÅ¾e postaviti svoju kreditnu karticu na nalogu...)
* Ako se **kolaÄiÄ‡ ne menja nakon prijavljivanja**, napadaÄ moÅ¾e samo **fiksirati kolaÄiÄ‡ (session-fixation)**, Äekati da se Å¾rtva prijavi i zatim **iskoristiti taj kolaÄiÄ‡ da se prijavi kao Å¾rtva**.
* Ponekad, Äak i ako se kolaÄiÄ‡i sesije menjaju, napadaÄ koristi prethodni i takoÄ‘e Ä‡e dobiti novi.
* Ako **kolaÄiÄ‡ postavlja neku poÄetnu vrednost** (kao u flask-u gde **kolaÄiÄ‡** moÅ¾e **postaviti** **CSRF token** sesije i ova vrednost Ä‡e se odrÅ¾ati nakon Å¡to se Å¾rtva prijavi), **napadaÄ moÅ¾e postaviti ovu poznatu vrednost i zatim je zloupotrebiti** (u tom scenariju, napadaÄ moÅ¾e naterati korisnika da izvrÅ¡i CSRF zahtev jer zna CSRF token).
* BaÅ¡ kao Å¡to postavlja vrednost, napadaÄ bi takoÄ‘e mogao dobiti neautentifikovani kolaÄiÄ‡ generisan od strane servera, dobiti CSRF token iz njega i iskoristiti ga.

### Cookie Order

Kada pregledaÄ primi dva kolaÄiÄ‡a sa istim imenom **delimiÄno utiÄuÄ‡i na istu oblast** (domen, poddomeni i putanja), **pregledaÄ Ä‡e poslati obe vrednosti kolaÄiÄ‡a** kada su obe vaÅ¾eÄ‡e za zahtev.

U zavisnosti od toga ko ima **najspecifiÄniju putanju** ili koji je **najstariji**, pregledaÄ Ä‡e **prvo postaviti vrednost kolaÄiÄ‡a** a zatim vrednost drugog kao u: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

VeÄ‡ina **vĞµĞ± ÑĞ°Ñ˜Ñ‚Ğ¾Ğ²Ğ° Ñ›Ğµ ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ ÑĞ°Ğ¼Ğ¾ Ğ¿Ñ€Ğ²Ñƒ Ğ²Ñ€ĞµĞ´Ğ½Ğ¾ÑÑ‚**. Ğ—Ğ°Ñ‚Ğ¸Ğ¼, Ğ°ĞºĞ¾ Ğ½Ğ°Ğ¿Ğ°Ğ´Ğ°Ñ‡ Ğ¶ĞµĞ»Ğ¸ Ğ´Ğ° Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸ ĞºĞ¾Ğ»Ğ°Ñ‡Ğ¸Ñ›, Ğ±Ğ¾Ñ™Ğµ Ñ˜Ğµ Ğ´Ğ° Ğ³Ğ° Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸ Ğ¿Ñ€Ğµ Ğ½ĞµĞ³Ğ¾ ÑˆÑ‚Ğ¾ Ğ±ÑƒĞ´Ğµ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ñ™ĞµĞ½ Ğ´Ñ€ÑƒĞ³Ğ¸ Ğ¸Ğ»Ğ¸ da ga postavi sa specifiÄnijom putanjom.

{% hint style="warning" %}
Å taviÅ¡e, sposobnost da **postavite kolaÄiÄ‡ na specifiÄniju putanju** je veoma zanimljiva jer Ä‡ete moÄ‡i da naterate **Å¾rtvu da radi sa svojim kolaÄiÄ‡em osim u specifiÄnoj putanji gde Ä‡e zlonamerni kolaÄiÄ‡ biti poslat pre**.
{% endhint %}

### Protection Bypass

MoguÄ‡a zaÅ¡tita protiv ovog napada bi bila da **web server ne prihvata zahteve sa dva kolaÄiÄ‡a sa istim imenom, ali sa dva razliÄita vrednosti**.

Da bi zaobiÅ¡ao scenario u kojem napadaÄ postavlja kolaÄiÄ‡ nakon Å¡to je Å¾rtvi veÄ‡ dodeljen kolaÄiÄ‡, napadaÄ bi mogao izazvati **kolaÄiÄ‡ prelivanje** i zatim, kada se **legitiman kolaÄiÄ‡ obriÅ¡e, postaviti zlonamerni**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

JoÅ¡ jedan koristan **zaobilazni put** mogao bi biti da **URL kodira ime kolaÄiÄ‡a** jer neka zaÅ¡tita proverava 2 kolaÄiÄ‡a sa istim imenom u zahtevu, a zatim server dekodira imena kolaÄiÄ‡a.

### Cookie Bomb

Napad Cookie Tossing se takoÄ‘e moÅ¾e koristiti za izvoÄ‘enje **Cookie Bomb** napada:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Defense**s**

#### **Koristite prefiks `__Host` u imenu kolaÄiÄ‡a**

* Ako ime kolaÄiÄ‡a ima ovaj prefiks, **biÄ‡e prihvaÄ‡eno** u Set-Cookie direktivi samo ako je oznaÄeno kao Secure, poslato sa sigurnog izvora, ne ukljuÄuje atribut Domen i ima atribut Putanja postavljen na /
* **Ovo spreÄava poddomene da primoraju kolaÄiÄ‡ na vrÅ¡ni domen jer se ovi kolaÄiÄ‡i mogu smatrati "zakljuÄanim na domen"**

### References

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
