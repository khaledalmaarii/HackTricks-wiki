# Cookie Tossing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Opis

JeÅ›li atakujÄ…cy moÅ¼e **kontrolowaÄ‡ subdomenÄ™ lub domenÄ™ firmy lub znajdzie XSS w subdomenie**, bÄ™dzie w stanie przeprowadziÄ‡ ten atak.

Jak wskazano w sekcji Hacking Cookies, gdy **ciasteczko jest ustawione na domenÄ™ (okreÅ›lajÄ…c jÄ…), bÄ™dzie uÅ¼ywane w domenie i subdomenach.**

{% hint style="danger" %}
Dlatego **atakujÄ…cy bÄ™dzie mÃ³gÅ‚ ustawiÄ‡ na domenie i subdomenach konkretne ciasteczko, robiÄ…c coÅ› takiego jak** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

To moÅ¼e byÄ‡ niebezpieczne, poniewaÅ¼ atakujÄ…cy moÅ¼e byÄ‡ w stanie:

* **ZafiksowaÄ‡ ciasteczko ofiary na konto atakujÄ…cego**, wiÄ™c jeÅ›li uÅ¼ytkownik nie zauwaÅ¼y, **wykona dziaÅ‚ania na koncie atakujÄ…cego**, a atakujÄ…cy moÅ¼e uzyskaÄ‡ interesujÄ…ce informacje (sprawdziÄ‡ historiÄ™ wyszukiwaÅ„ uÅ¼ytkownika na platformie, ofiara moÅ¼e ustawiÄ‡ swojÄ… kartÄ™ kredytowÄ… na koncie...)
* JeÅ›li **ciasteczko nie zmienia siÄ™ po zalogowaniu**, atakujÄ…cy moÅ¼e po prostu **zafiksowaÄ‡ ciasteczko (session-fixation)**, poczekaÄ‡, aÅ¼ ofiara siÄ™ zaloguje, a nastÄ™pnie **uÅ¼yÄ‡ tego ciasteczka, aby zalogowaÄ‡ siÄ™ jako ofiara**.
* Czasami, nawet jeÅ›li ciasteczka sesji siÄ™ zmieniajÄ…, atakujÄ…cy uÅ¼ywa poprzedniego i rÃ³wnieÅ¼ otrzyma nowe.
* JeÅ›li **ciasteczko ustawia jakÄ…Å› wartoÅ›Ä‡ poczÄ…tkowÄ…** (jak w flask, gdzie **ciasteczko** moÅ¼e **ustawiÄ‡** **token CSRF** sesji i ta wartoÅ›Ä‡ bÄ™dzie utrzymywana po zalogowaniu ofiary), **atakujÄ…cy moÅ¼e ustawiÄ‡ tÄ™ znanÄ… wartoÅ›Ä‡, a nastÄ™pnie jÄ… wykorzystaÄ‡** (w tym scenariuszu atakujÄ…cy moÅ¼e zmusiÄ‡ uÅ¼ytkownika do wykonania Å¼Ä…dania CSRF, poniewaÅ¼ zna token CSRF).
* Tak samo jak ustawienie wartoÅ›ci, atakujÄ…cy mÃ³gÅ‚by rÃ³wnieÅ¼ uzyskaÄ‡ nieautoryzowane ciasteczko generowane przez serwer, uzyskaÄ‡ z niego token CSRF i go uÅ¼yÄ‡.

### KolejnoÅ›Ä‡ Ciasteczek

Gdy przeglÄ…darka otrzymuje dwa ciasteczka o tej samej nazwie **czÄ™Å›ciowo wpÅ‚ywajÄ…ce na ten sam zakres** (domena, subdomeny i Å›cieÅ¼ka), **przeglÄ…darka wyÅ›le obie wartoÅ›ci ciasteczka**, gdy obie sÄ… waÅ¼ne dla Å¼Ä…dania.

W zaleÅ¼noÅ›ci od tego, kto ma **najbardziej specyficznÄ… Å›cieÅ¼kÄ™** lub ktÃ³re z nich jest **najstarsze**, przeglÄ…darka **ustawi wartoÅ›Ä‡ ciasteczka najpierw**, a nastÄ™pnie wartoÅ›Ä‡ drugiego, jak w: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

WiÄ™kszoÅ›Ä‡ **stron internetowych uÅ¼yje tylko pierwszej wartoÅ›ci**. Dlatego, jeÅ›li atakujÄ…cy chce ustawiÄ‡ ciasteczko, lepiej ustawiÄ‡ je przed ustawieniem innego lub ustawiÄ‡ je z bardziej specyficznÄ… Å›cieÅ¼kÄ….

{% hint style="warning" %}
Co wiÄ™cej, moÅ¼liwoÅ›Ä‡ **ustawienia ciasteczka w bardziej specyficznej Å›cieÅ¼ce** jest bardzo interesujÄ…ca, poniewaÅ¼ bÄ™dziesz mÃ³gÅ‚ sprawiÄ‡, Å¼e **ofiara bÄ™dzie pracowaÄ‡ ze swoim ciasteczkiem, z wyjÄ…tkiem specyficznej Å›cieÅ¼ki, gdzie ustawione zostanie zÅ‚oÅ›liwe ciasteczko**.
{% endhint %}

### OminiÄ™cie Ochrony

MoÅ¼liwÄ… ochronÄ… przed tym atakiem byÅ‚oby to, Å¼e **serwer WWW nie zaakceptuje Å¼Ä…daÅ„ z dwoma ciasteczkami o tej samej nazwie, ale z dwiema rÃ³Å¼nymi wartoÅ›ciami**.

Aby obejÅ›Ä‡ scenariusz, w ktÃ³rym atakujÄ…cy ustawia ciasteczko po tym, jak ofiara juÅ¼ otrzymaÅ‚a ciasteczko, atakujÄ…cy mÃ³gÅ‚by spowodowaÄ‡ **przepeÅ‚nienie ciasteczka**, a nastÄ™pnie, gdy **legitne ciasteczko zostanie usuniÄ™te, ustawiÄ‡ zÅ‚oÅ›liwe**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Innym uÅ¼ytecznym **ominiÄ™ciem** mogÅ‚oby byÄ‡ **zakodowanie URL nazwy ciasteczka**, poniewaÅ¼ niektÃ³re zabezpieczenia sprawdzajÄ… dwa ciasteczka o tej samej nazwie w Å¼Ä…daniu, a nastÄ™pnie serwer dekoduje nazwy ciasteczek.

### Bombardowanie Ciasteczek

Atak Cookie Tossing moÅ¼e byÄ‡ rÃ³wnieÅ¼ uÅ¼yty do przeprowadzenia ataku **Cookie Bomb**:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Ochrona

#### **UÅ¼yj prefiksu `__Host` w nazwie ciasteczka**

* JeÅ›li nazwa ciasteczka ma ten prefiks, **zostanie zaakceptowana** w dyrektywie Set-Cookie tylko wtedy, gdy jest oznaczona jako Secure, zostaÅ‚a wysÅ‚ana z bezpiecznego ÅºrÃ³dÅ‚a, nie zawiera atrybutu Domain i ma ustawiony atrybut Path na /
* **To zapobiega subdomenom wymuszajÄ…cym ciasteczko na domenÄ™ gÅ‚Ã³wnÄ…, poniewaÅ¼ te ciasteczka mogÄ… byÄ‡ postrzegane jako "zablokowane na domenie"**

### Referencje

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
