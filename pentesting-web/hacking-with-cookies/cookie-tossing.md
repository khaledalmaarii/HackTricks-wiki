# Cookie Tossing

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>

### Opis

JeÅ›li atakujÄ…cy moÅ¼e **kontrolowaÄ‡ subdomenÄ™ lub domenÄ™ firmy lub znajdzie XSS w subdomenie**, bÄ™dzie mÃ³gÅ‚ przeprowadziÄ‡ ten atak.

Jak wskazano w sekcji Hacking Cookies, gdy **cookie jest ustawione dla domeny (specyfikujÄ…c jÄ…), bÄ™dzie uÅ¼ywane w domenie i subdomenach.**

{% hint style="danger" %}
Dlatego **atakujÄ…cy bÄ™dzie mÃ³gÅ‚ ustawiÄ‡ dla domeny i subdomen okreÅ›lone cookie, wykonujÄ…c coÅ› w rodzaju** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

MoÅ¼e to byÄ‡ niebezpieczne, poniewaÅ¼ atakujÄ…cy moÅ¼e:

* **ZafiksowaÄ‡ cookie ofiary na konto atakujÄ…cego**, wiÄ™c jeÅ›li uÅ¼ytkownik tego nie zauwaÅ¼y, **wykona czynnoÅ›ci na koncie atakujÄ…cego**, a atakujÄ…cy moÅ¼e uzyskaÄ‡ pewne interesujÄ…ce informacje (sprawdÅº historiÄ™ wyszukiwaÅ„ uÅ¼ytkownika na platformie, ofiara moÅ¼e podaÄ‡ swÃ³j numer karty kredytowej w koncie...)
* JeÅ›li **cookie nie zmienia siÄ™ po zalogowaniu**, atakujÄ…cy moÅ¼e po prostu **zafiksowaÄ‡ cookie (session-fixation)**, poczekaÄ‡ aÅ¼ ofiara siÄ™ zaloguje, a nastÄ™pnie **uÅ¼yÄ‡ tego cookie do zalogowania siÄ™ jako ofiara**.
* Czasami, nawet jeÅ›li cookie sesji siÄ™ zmienia, atakujÄ…cy moÅ¼e uÅ¼yÄ‡ poprzedniego i otrzyma rÃ³wnieÅ¼ nowy.
* JeÅ›li **cookie ustawia jakÄ…Å› poczÄ…tkowÄ… wartoÅ›Ä‡** (jak w przypadku flask, gdzie **cookie** moÅ¼e **ustawiÄ‡** token **CSRF** sesji, a ta wartoÅ›Ä‡ bÄ™dzie utrzymywana po zalogowaniu ofiary), **atakujÄ…cy moÅ¼e ustawiÄ‡ tÄ™ znanÄ… wartoÅ›Ä‡, a nastÄ™pnie z niej skorzystaÄ‡** (w takim scenariuszu atakujÄ…cy moÅ¼e sprawiÄ‡, Å¼e uÅ¼ytkownik wyÅ›le Å¼Ä…danie CSRF, poniewaÅ¼ zna token CSRF).
* Podobnie jak ustawianie wartoÅ›ci, atakujÄ…cy mÃ³gÅ‚by rÃ³wnieÅ¼ uzyskaÄ‡ nieuwierzytelnione cookie wygenerowane przez serwer, pobraÄ‡ z niego token CSRF i go uÅ¼yÄ‡.

### KolejnoÅ›Ä‡ Cookie

Gdy przeglÄ…darka otrzymuje dwa pliki cookie o tej samej nazwie **czÄ™Å›ciowo wpÅ‚ywajÄ…ce na ten sam zakres** (domena, subdomeny i Å›cieÅ¼ka), **przeglÄ…darka wyÅ›le obie wartoÅ›ci cookie**, gdy obie sÄ… waÅ¼ne dla Å¼Ä…dania.

W zaleÅ¼noÅ›ci od tego, kto ma **najbardziej specyficznÄ… Å›cieÅ¼kÄ™** lub ktÃ³ry jest **starszy**, przeglÄ…darka **ustawi najpierw wartoÅ›Ä‡ cookie**, a nastÄ™pnie wartoÅ›Ä‡ drugiego, jak w: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

WiÄ™kszoÅ›Ä‡ **stron internetowych uÅ¼yje tylko pierwszej wartoÅ›ci**. Dlatego, jeÅ›li atakujÄ…cy chce ustawiÄ‡ cookie, lepiej je ustawiÄ‡ przed ustawieniem innego lub ustawiÄ‡ je z bardziej specyficznÄ… Å›cieÅ¼kÄ….

{% hint style="warning" %}
Co wiÄ™cej, moÅ¼liwoÅ›Ä‡ **ustawienia cookie w bardziej specyficznej Å›cieÅ¼ce** jest bardzo interesujÄ…ca, poniewaÅ¼ pozwala to **ofiary pracowaÄ‡ z jej cookie, z wyjÄ…tkiem konkretnej Å›cieÅ¼ki, gdzie ustawione zostanie zÅ‚oÅ›liwe cookie**.
{% endhint %}

### OminiÄ™cie Ochrony

MoÅ¼liwÄ… ochronÄ… przed tym atakiem byÅ‚oby to, Å¼e **serwer sieciowy nie akceptuje Å¼Ä…daÅ„ z dwoma plikami cookie o tej samej nazwie, ale dwiema rÃ³Å¼nymi wartoÅ›ciami**.

Aby ominÄ…Ä‡ scenariusz, w ktÃ³rym atakujÄ…cy ustawia cookie po tym, jak ofiara juÅ¼ otrzymaÅ‚a cookie, atakujÄ…cy mÃ³gÅ‚by spowodowaÄ‡ **przepeÅ‚nienie pliku cookie**, a nastÄ™pnie, gdy **legitymacyjne cookie zostanie usuniÄ™te, ustawiÄ‡ zÅ‚oÅ›liwe**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Innym przydatnym **sposobem ominiÄ™cia** mogÅ‚oby byÄ‡ **kodowanie URL nazwy pliku cookie**, poniewaÅ¼ niektÃ³re zabezpieczenia sprawdzajÄ…, czy w Å¼Ä…daniu sÄ… 2 pliki cookie o tej samej nazwie, a nastÄ™pnie serwer zdekoduje nazwy plikÃ³w cookie.

### Bomba Cookie

Atak Cookie Tossing moÅ¼e rÃ³wnieÅ¼ byÄ‡ wykorzystany do przeprowadzenia ataku **Cookie Bomb**:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Obrona

#### **UÅ¼yj prefiksu `__Host` w nazwie pliku cookie**

* JeÅ›li nazwa pliku cookie ma ten prefiks, **bÄ™dzie akceptowana tylko** w dyrektywie Set-Cookie, jeÅ›li jest oznaczona jako Secure, zostaÅ‚a wysÅ‚ana z bezpiecznego ÅºrÃ³dÅ‚a, nie zawiera atrybutu Domain i ma ustawiony atrybut Path na /
* **Zapobiega to subdomenom wymuszajÄ…cym cookie na domenÄ™ apex, poniewaÅ¼ te pliki cookie mogÄ… byÄ‡ postrzegane jako "zablokowane dla domeny"**

### Referencje

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
