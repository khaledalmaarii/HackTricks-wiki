# Cookie Tossing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Description

Si un attaquant peut **contr√¥ler un sous-domaine ou le domaine d'une entreprise ou trouve un XSS dans un sous-domaine**, il sera capable d'effectuer cette attaque.

Comme indiqu√© dans la section Hacking des Cookies, lorsqu'un **cookie est d√©fini pour un domaine (en le sp√©cifiant), il sera utilis√© dans le domaine et les sous-domaines.**

{% hint style="danger" %}
Par cons√©quent, **un attaquant pourra d√©finir pour le domaine et les sous-domaines un cookie sp√©cifique en faisant quelque chose comme** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Cela peut √™tre dangereux car l'attaquant peut √™tre capable de :

* **Fixer le cookie de la victime au compte de l'attaquant** donc si l'utilisateur ne s'en rend pas compte, **il effectuera les actions dans le compte de l'attaquant** et l'attaquant peut obtenir des informations int√©ressantes (v√©rifier l'historique des recherches de l'utilisateur sur la plateforme, la victime peut avoir enregistr√© sa carte de cr√©dit dans le compte...)
* Si le **cookie ne change pas apr√®s la connexion**, l'attaquant peut simplement **fixer un cookie (session-fixation)**, attendre que la victime se connecte et ensuite **utiliser ce cookie pour se connecter en tant que victime**.
* Parfois, m√™me si les cookies de session changent, l'attaquant utilise l'ancien et il recevra √©galement le nouveau.
* Si le **cookie d√©finit une valeur initiale** (comme dans flask o√π le **cookie** peut **d√©finir** le **token CSRF** de la session et cette valeur sera maintenue apr√®s que la victime se soit connect√©e), l'**attaquant peut d√©finir cette valeur connue et ensuite en abuser** (dans ce sc√©nario, l'attaquant peut alors faire en sorte que l'utilisateur effectue une requ√™te CSRF car il conna√Æt le token CSRF).
* Tout comme d√©finir la valeur, l'attaquant pourrait √©galement obtenir un cookie non authentifi√© g√©n√©r√© par le serveur, obtenir le token CSRF √† partir de celui-ci et l'utiliser.

### Cookie Order

Lorsqu'un navigateur re√ßoit deux cookies avec le m√™me nom **affectant partiellement le m√™me champ** (domaine, sous-domaines et chemin), le **navigateur enverra les deux valeurs du cookie** lorsque les deux sont valides pour la requ√™te.

Selon qui a **le chemin le plus sp√©cifique** ou lequel est le **plus ancien**, le navigateur **d√©finira d'abord la valeur du cookie** puis la valeur de l'autre comme dans : `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

La plupart des **sites web n'utiliseront que la premi√®re valeur**. Donc, si un attaquant veut d√©finir un cookie, il est pr√©f√©rable de le d√©finir avant qu'un autre ne soit d√©fini ou de le d√©finir avec un chemin plus sp√©cifique.

{% hint style="warning" %}
De plus, la capacit√© √† **d√©finir un cookie dans un chemin plus sp√©cifique** est tr√®s int√©ressante car vous pourrez faire en sorte que la **victime travaille avec son cookie sauf dans le chemin sp√©cifique o√π le cookie malveillant sera envoy√© en premier**.
{% endhint %}

### Protection Bypass

Une protection possible contre cette attaque serait que le **serveur web n'accepte pas les requ√™tes avec deux cookies ayant le m√™me nom mais deux valeurs diff√©rentes**.

Pour contourner le sc√©nario o√π l'attaquant d√©finit un cookie apr√®s que la victime ait d√©j√† re√ßu le cookie, l'attaquant pourrait provoquer un **d√©bordement de cookie** et ensuite, une fois que le **cookie l√©gitime est supprim√©, d√©finir le malveillant**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Un autre **bypass** utile pourrait √™tre de **coder en URL le nom du cookie** car certaines protections v√©rifient 2 cookies avec le m√™me nom dans une requ√™te et ensuite le serveur d√©codera les noms des cookies.

### Cookie Bomb

Une attaque de Cookie Tossing peut √©galement √™tre utilis√©e pour effectuer une attaque de **Cookie Bomb** :

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Defense**s**

#### **Utiliser le pr√©fixe `__Host` dans le nom du cookie**

* Si un nom de cookie a ce pr√©fixe, il **ne sera accept√©** dans une directive Set-Cookie que s'il est marqu√© Secure, a √©t√© envoy√© depuis une origine s√©curis√©e, n'inclut pas d'attribut Domain, et a l'attribut Path d√©fini sur /
* **Cela emp√™che les sous-domaines de forcer un cookie vers le domaine principal puisque ces cookies peuvent √™tre consid√©r√©s comme "verrouill√©s au domaine"**

### References

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
