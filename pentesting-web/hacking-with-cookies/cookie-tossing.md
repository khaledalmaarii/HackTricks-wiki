# Cookie Tossing

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

### Beschreibung

Wenn ein Angreifer **eine Subdomain oder die Domain eines Unternehmens kontrollieren kann oder ein XSS in einer Subdomain findet**, wird er in der Lage sein, diesen Angriff durchzuf√ºhren.

Wie im Abschnitt √ºber Cookies Hacking angegeben, wenn ein **Cookie auf eine Domain gesetzt wird (unter Angabe)**, wird es in der Domain und den Subdomains verwendet.

{% hint style="danger" %}
Daher **wird ein Angreifer in der Lage sein, ein spezifisches Cookie f√ºr die Domain und Subdomains zu setzen, indem er etwas wie** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Dies kann gef√§hrlich sein, da der Angreifer m√∂glicherweise in der Lage ist:

* **Das Cookie des Opfers auf das Konto des Angreifers zu fixieren**, sodass, wenn der Benutzer es nicht bemerkt, **er die Aktionen im Konto des Angreifers ausf√ºhrt** und der Angreifer m√∂glicherweise einige interessante Informationen erh√§lt (√ºberpr√ºfen der Suchhistorie des Benutzers auf der Plattform, das Opfer k√∂nnte seine Kreditkarte im Konto hinterlegen...)
* Wenn das **Cookie sich nach dem Login nicht √§ndert**, k√∂nnte der Angreifer einfach **ein Cookie fixieren (Session-Fixierung)**, warten, bis das Opfer sich einloggt, und dann **dieses Cookie verwenden, um sich als das Opfer einzuloggen**.
* Manchmal, selbst wenn sich die Session-Cookies √§ndern, verwendet der Angreifer das vorherige und erh√§lt auch das neue.
* Wenn das **Cookie einen bestimmten Anfangswert setzt** (wie in Flask, wo das **Cookie** den **CSRF-Token** der Session **setzen** kann und dieser Wert nach dem Login des Opfers beibehalten wird), kann der **Angreifer diesen bekannten Wert setzen und dann missbrauchen** (in diesem Szenario k√∂nnte der Angreifer dann den Benutzer dazu bringen, eine CSRF-Anfrage auszuf√ºhren, da er den CSRF-Token kennt).
* Genau wie das Setzen des Wertes k√∂nnte der Angreifer auch ein nicht authentifiziertes Cookie generieren, das vom Server erstellt wurde, den CSRF-Token daraus erhalten und ihn verwenden.

### Cookie-Reihenfolge

Wenn ein Browser zwei Cookies mit demselben Namen **teilweise denselben Geltungsbereich** (Domain, Subdomains und Pfad) betreffen, wird der **Browser beide Werte des Cookies senden**, wenn beide f√ºr die Anfrage g√ºltig sind.

Je nachdem, wer **den spezifischeren Pfad hat** oder welches das **√§ltere ist**, wird der Browser **zuerst den Wert des Cookies setzen** und dann den Wert des anderen wie in: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

Die meisten **Websites verwenden nur den ersten Wert**. Wenn ein Angreifer also ein Cookie setzen m√∂chte, ist es besser, es zu setzen, bevor ein anderes gesetzt wird, oder es mit einem spezifischeren Pfad zu setzen.

{% hint style="warning" %}
Dar√ºber hinaus ist die F√§higkeit, **ein Cookie in einem spezifischeren Pfad zu setzen**, sehr interessant, da du es dem **Opfer erm√∂glichen kannst, mit seinem Cookie zu arbeiten, au√üer im spezifischen Pfad, wo das b√∂sartige Cookie zuvor gesetzt wurde**.
{% endhint %}

### Schutzumgehung

M√∂glicher Schutz gegen diesen Angriff w√§re, dass der **Webserver keine Anfragen mit zwei Cookies mit demselben Namen, aber zwei unterschiedlichen Werten akzeptiert**.

Um das Szenario zu umgehen, in dem der Angreifer ein Cookie setzt, nachdem das Opfer bereits das Cookie erhalten hat, k√∂nnte der Angreifer einen **Cookie-Overflow** verursachen und dann, sobald das **legitime Cookie gel√∂scht ist, das b√∂sartige setzen**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Eine weitere n√ºtzliche **Umgehung** k√∂nnte sein, **den Namen des Cookies URL-zu kodieren**, da einige Schutzma√ünahmen nach 2 Cookies mit demselben Namen in einer Anfrage suchen und der Server dann die Namen der Cookies dekodiert.

### Cookie-Bombe

Ein Cookie Tossing-Angriff kann auch verwendet werden, um einen **Cookie-Bomben**-Angriff durchzuf√ºhren:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Verteidigungen

#### **Verwende das Pr√§fix `__Host` im Cookie-Namen**

* Wenn ein Cookie-Name dieses Pr√§fix hat, **wird es nur akzeptiert**, wenn es in einer Set-Cookie-Direktive als sicher markiert ist, von einem sicheren Ursprung gesendet wurde, kein Domain-Attribut enth√§lt und das Path-Attribut auf / gesetzt ist.
* **Dies verhindert, dass Subdomains ein Cookie auf die Hauptdomain zwingen, da diese Cookies als "domain-locked" angesehen werden k√∂nnen.**

### Referenzen

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
