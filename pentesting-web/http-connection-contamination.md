# Contamination de connexion HTTP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Les navigateurs Web utilisent la [**cohÃ©rence de connexion HTTP**](https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing), qui leur permet de **rÃ©utiliser** une seule **connexion HTTP/2+** pour les demandes allant Ã  **diffÃ©rents sites Web**, Ã  condition que les sites **se rÃ©solvent Ã  la mÃªme adresse IP** et utilisent un certificat TLS valide pour les deux noms d'hÃ´te.

Le **routage de la premiÃ¨re demande** est un comportement de proxy inverse dangereux oÃ¹ le **proxy analyse la premiÃ¨re demande** sur une connexion pour dÃ©terminer **quel backend** y acheminer, puis **envoie** toutes les **demandes suivantes** sur cette connexion au **mÃªme backend**.

**La cohÃ©rence de connexion et le routage de la premiÃ¨re demande ne fonctionnent pas bien ensemble**. Par exemple, imaginez que secure.example.com et wordpress.example.com sont tous deux derriÃ¨re un proxy inverse utilisant un certificat valide pour \*.example.com :
```shell-session
$ nslookup wordpress.example.com
52.16.179.7 // reverse proxy that supports HTTP/2 and does first-request routing

$ nslookup secure.example.com
52.16.179.7 // same reverse proxy

$ openssl s_client -connect x.portswigger-labs.net:443
subject=/CN=*.example.com // wildcard TLS certificate
```
Si un navigateur tente d'envoyer une demande Ã  **wordpress.example.com** suivie de **secure.example.com**, la fusion de la connexion du navigateur forcera **les deux demandes Ã  utiliser une seule connexion** vers le frontal. Le routage de la premiÃ¨re demande entraÃ®nera la **demande de secure.example.com Ã©tant incorrectement routÃ©e vers le backend de WordPress**. Cela signifie que si vous trouvez une [XSS](https://portswigger.net/web-security/cross-site-scripting) sur wordpress.example.com, vous pouvez l'utiliser pour compromettre secure.example.com !
```javascript
// create HTTP/2+ connection
fetch('https://wordpress.example.com/', {credentials: 'include'})

// connection coalescing will force this down the same connection...
// ...leading to the front-end misrouting it to WordPress
// the browser thinks our injected JS is coming from secure.example.com
// exposing saved passwords, cookies, etc.
location='https://secure.example.com/plugin/x?q=<script>stealPasswords()'
```
Vous pouvez **explorer la coalescence de connexion par vous-mÃªme** en utilisant le **graphique de chronologie sous l'onglet RÃ©seau des outils de dÃ©veloppement de Chrome** (ou en utilisant WireShark si vous Ãªtes masochiste). Ã‰mettez des paires de requÃªtes en utilisant fetch() et voyez si le graphique montre le temps passÃ© sur la Â«connexion initialeÂ» pour la deuxiÃ¨me requÃªte, et si la colonne ID de connexion correspond: 

{% code overflow="wrap" %}
```javascript
fetch('//sub1.hackxor.net/', {mode: 'no-cors', credentials: 'include'}).then(()=>{ fetch('//sub2.hackxor.net/', {mode: 'no-cors', credentials: 'include'}) })
```
{% endcode %}

<figure><img src="../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

Je n'ai pas investi le temps nÃ©cessaire pour explorer cette menace en profondeur ou la scanner dans la nature car je crois qu'elle est actuellement rare pour deux raisons. PremiÃ¨rement, le routage de la premiÃ¨re requÃªte est relativement rare et la complexitÃ© de la mise en Å“uvre de HTTP/2 signifie qu'il n'y a qu'un petit nombre de serveurs HTTP/2 uniques par rapport Ã  HTTP/1.1. DeuxiÃ¨mement, la coalescence de connexion signifie que les serveurs HTTP/2 effectuant le routage de la premiÃ¨re requÃªte peuvent occasionnellement se casser pour les visiteurs lÃ©gitimes, de sorte que les propriÃ©taires peuvent finir par corriger la vulnÃ©rabilitÃ© sans encouragement de l'attaquant.

Cela dit, ce n'est pas tout Ã  fait une mauvaise nouvelle pour les attaquants. **HTTP/3 propose** [**de supprimer l'exigence de correspondance d'adresse IP**](https://www.rfc-editor.org/rfc/rfc9114.html#name-connection-reuse)**, ce qui exposera tout le monde avec une interface frontale qui utilise le routage de la premiÃ¨re requÃªte et dispose d'un certificat valide pour plusieurs hÃ´tes**.

Cela crÃ©e Ã©galement un deuxiÃ¨me risque qui n'est pas liÃ© au routage de la premiÃ¨re requÃªte - cela signifie qu'un **serveur compromis avec un certificat gÃ©nÃ©rique ne nÃ©cessite plus d'exploitation MITM**. En effet, cela augmente considÃ©rablement le nombre d'acteurs malveillants qui pourraient en profiter.

Pour Ã©viter ces risques avant qu'ils ne deviennent une rÃ©alitÃ©, assurez-vous que vos serveurs proxy inverses ne rÃ©alisent pas le routage de la premiÃ¨re requÃªte. Vous pouvez tester cela manuellement dans Repeater en activant la rÃ©utilisation de connexion HTTP/1 et HTTP/2, et Ã©galement le scanner en utilisant l'attaque 'Connection-State' dans [HTTP Request Smuggler](https://github.com/PortSwigger/http-request-smuggler). De plus, sachez que bien que les certificats TLS gÃ©nÃ©riques n'aient jamais Ã©tÃ© idÃ©aux, HTTP/3 signifie qu'un serveur compromis avec un certificat gÃ©nÃ©rique peut maintenant Ãªtre utilisÃ© pour attaquer des domaines frÃ¨res sans MITM actif.

Ces nouvelles menaces continuent la tendance actuelle de l'infrastructure web Ã  descendre dans un enchevÃªtrement complexe oÃ¹ une faiblesse sur un site individuel a de nombreux effets secondaires non Ã©vidents sur la sÃ©curitÃ© du systÃ¨me global. Il sera intÃ©ressant de voir comment ces risques se joueront en pratique.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
