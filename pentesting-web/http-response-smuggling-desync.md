# HTTP Odgovor Smugling / Desinkronizacija

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Tehnika ovog posta je preuzeta iz videa:** [**https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s**](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

## Desinhronizacija Reda HTTP Zahteva

Prvo, ova tehnika **zloupotrebljava ranjivost HTTP zahteva za smugling**, tako da morate znati 코ta je to:

**Glavna** **razlika** izme캠u ove tehnike i obi캜nog HTTP zahteva za smugling je 코to **umesto** **napadanja** **zahteva** **rtve dodavanjem prefiksa**, mi 캖emo **procuriti ili modifikovati odgovor koji rtva prima**. Ovo se posti쬰 tako 코to, umesto slanja 1 zahteva i pola za zloupotrebu HTTP zahteva za smugling, **코aljemo 2 potpuna zahteva za desinhronizaciju redova odgovora posrednika**.

Ovo je zato 코to 캖emo biti u mogu캖nosti da **desinhronizujemo red odgovora** tako da **odgovor** sa **legitimnog zahteva** **rtve bude poslat napada캜u**, ili **ubacivanjem sadr쬬ja kontrolisanog od strane napada캜a u odgovor rtvi**.

### Desinhronizacija HTTP Pipelina

HTTP/1.1 omogu캖ava da se zatra쬰 **razli캜iti resursi bez 캜ekanja na prethodne**. Stoga, ako postoji **posrednik** u **sredini**, posao posrednika je da **odr쬬va sinhronizovan odgovaraju캖i par zahteva poslatih backendu i odgovora koji dolaze od njega**.

Me캠utim, postoji problem desinhronizacije redova odgovora. Ako napada캜 po코alje napad za smugling HTTP odgovora i odgovori na **po캜etni zahtev i prokrijum캜aren** budu odgovoreni odmah, prokrijum캜areni odgovor ne캖e biti uba캜en unutar reda odgovora rtve ve캖 캖e **biti odba캜en kao gre코ka**.

![](<../.gitbook/assets/image (633).png>)

Stoga je potrebno da **prokrijum캜areni zahtev** **traje du쬰 da se obradi** unutar serverske strane. Stoga, do trenutka kada se prokrijum캜areni zahtev obradi, komunikacija sa napada캜em 캖e biti zavr코ena.

Ukoliko u ovoj specifi캜noj situaciji **rtva po코alje zahtev** i **prokrijum캜areni zahtev bude odgovoren pre** legitimnog zahteva, **prokrijum캜areni odgovor 캖e biti poslat rtvi**. Stoga, napada캜 캖e **kontrolisati zahtev "izvr코en" od strane rtve**.

Osim toga, ako **napada캜 zatim izvr코i zahtev** i **legitimni odgovor** na **rtvin** zahtev bude **odgovoren** **pre** napada캜evog zahteva. **Odgovor rtvi 캖e biti poslat napada캜u**, **ukradu캖i** odgovor rtvi (koji mo쬰 sadr쬬ti na primer zaglavlje **Set-Cookie**).

![](<../.gitbook/assets/image (1020).png>)

![](<../.gitbook/assets/image (719).png>)

### Vi코estruke Ugnje쬯ene Injekcije

Jo코 jedna **interesantna razlika** sa obi캜nim **HTTP zahtevom za smugling** je da, u obi캜nom napadu za smugling, **cilj** je **modifikovati po캜etak zahteva rtve** tako da izvr코i neo캜ekivanu akciju. U **napadu za smuglingu HTTP odgovora**, po코to **코aljete kompletne zahteve**, mo쬰te **ubaciti u jedan payload desetine odgovora** koji 캖e **desinhronizovati desetine korisnika** koji 캖e **primiti** **ubacene** **odgovore**.

Osim 코to mo쬰te **jednostavnije distribuirati desetine eksploatacija** me캠u legitimnim korisnicima, ovo tako캠e mo쬰 biti kori코캖eno za izazivanje **DoS** na serveru.

### Organizacija Eksploatacije

Kao 코to je obja코njeno ranije, da biste zloupotrebili ovu tehniku, potrebno je da **prva prokrijum캜arena poruka** u serveru **traje dugo da se obradi**.

Ovaj **zahtev koji traje dugo** je dovoljan ako 쬰limo samo da **poku코amo ukrasti odgovor rtve**. Ali ako 쬰lite izvr코iti slo쬰niju eksploataciju, ovo 캖e biti zajedni캜ka struktura za eksploataciju.

Prvo **po캜etni** zahtev zloupotrebljavaju캖i **HTTP** **zahtev** **za smugling**, zatim **zahtev koji traje dugo** i zatim **1 ili vi코e zahteva za payload** 캜iji 캖e odgovori biti poslati rtvama.

## Zloupotreba Desinhronizacije Reda HTTP Odgovora

### Hvatanje zahteva drugih korisnika <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Kao i sa poznatim payloadima za HTTP zahtev za smugling, mo쬰te **ukrasti zahtev rtve** sa jednom va쬹om razlikom: U ovom slu캜aju vam je potrebno samo da **poslati sadr쬬j bude reflektovan u odgovoru**, **nije potrebno trajno skladi코tenje**.

Prvo, napada캜 코alje payload koji sadr쬴 **zavr코ni POST zahtev sa reflektovanim parametrom** na kraju i velikim Content-Length

![](<../.gitbook/assets/image (1053).png>)

Zatim, kada je **po캜etni zahtev** (plavi) **obradjen** i **dok** se **spori** zahtev obra캠uje (쬿ti) **slede캖i zahtev koji sti쬰 od rtve** 캖e biti **dodat u red odmah posle reflektovanog parametra**:

![](<../.gitbook/assets/image (794).png>)

Zatim, **rtva** 캖e **primiti** **odgovor na spor** zahtev i ako u me캠uvremenu **napada캜 po코alje jo코 jedan zahtev**, **odgovor na zahtev sa reflektovanim sadr쬬jem 캖e biti poslat njemu**.

## Desinhronizacija Odgovora

Do ovog trenutka, nau캜ili smo kako zloupotrebiti napade HTTP zahteva za smugling da **kontroli코emo** **zahtev** **캜iji** **odgovor** **klijent** **treba da** **primi** i kako mo쬰te zatim **ukrasti odgovor koji je bio namenjen rtvi**.

Ali jo코 uvek je mogu캖e **desinhronizovati jo코 vi코e** odgovora.

Postoje interesantni zahtevi poput **HEAD** zahteva koji su specifi캜ni da nemaju **bilo kakav sadr쬬j unutar tela odgovora** i koji bi (mora) **sadr쬬ti Content-Length** zahteva kao **da je to GET zahtev**.

Stoga, ako napada캜 **ubaci** **HEAD** zahtev, kao na ovim slikama:

![](<../.gitbook/assets/image (1107).png>)

Onda, **kada plavi bude odgovoren napada캜u**, slede캖i zahtev rtve 캖e biti uba캜en u red:

![](<../.gitbook/assets/image (999).png>)

Zatim, **rtva** 캖e **primiti** **odgovor** na **HEAD** zahtev, koji 캖e **sadr쬬ti Content-Length ali nikakav sadr쬬j**. Stoga, posrednik **ne캖e poslati ovaj odgovor** rtvi, ve캖 캖e **캜ekati** na neki **sadr쬬j**, koji 캖e zapravo biti **odgovor na 쬿ti zahtev** (tako캠e uba캜en od strane napada캜a):

![](<../.gitbook/assets/image (735).png>)
### Konfuzija sadr쬬ja

Slede캖i prethodni primer, znaju캖i da mo쬰te **kontrolisati telo** zahteva 캜iji 캖e odgovor primiti rtva i da **HEAD** **odgovor** obi캜no sadr쬴 u zaglavljima **Content-Type i Content-Length**, mo쬰te **poslati zahtev kao 코to je slede캖i** da biste izazvali XSS u rtvi, a da stranica nije ranjiva na XSS:

![](<../.gitbook/assets/image (688).png>)

### Trovanje ke코a

Zloupotrebom prethodno komentisanog napada na konfuziju sadr쬬ja odgovora desinhronizacije, **ako ke코 캜uva odgovor na zahtev koji je izvr코ila rtva i ovaj odgovor je uba캜en koji izaziva XSS, tada je ke코 zara쬰n**.

Zlonamerni zahtev koji sadr쬴 XSS payload:

![](<../.gitbook/assets/image (614).png>)

Zlonamerni odgovor rtvi koji sadr쬴 zaglavlje koje ukazuje ke코u da sa캜uva odgovor:

![](<../.gitbook/assets/image (566).png>)

{% hint style="warning" %}
Imajte na umu da u ovom slu캜aju ako je **"rtva" napada캜** on mo쬰 sada izvr코iti **trovanje ke코a na proizvoljnim URL-ovima** jer mo쬰 **kontrolisati URL koji 캖e biti ke코iran** sa zlonamernim odgovorom.
{% endhint %}

### Prevara ke코a veb stranica

Ovaj napad je sli캜an prethodnom, ali **umesto ubacivanja payloada unutar ke코a, napada캜 캖e ke코irati informacije rtve unutar ke코a:**

![](<../.gitbook/assets/image (991).png>)

### Podela odgovora

Cilj ovog napada je ponovo zloupotreba **desinhronizacije odgovora** kako bi se **naterao proxy da po코alje odgovor koji je 100% generisao napada캜**.

Da bi postigao ovo, napada캜 mora prona캖i krajnju ta캜ku veb aplikacije koja **reflektuje neke vrednosti unutar odgovora** i **znati du쬴nu sadr쬬ja HEAD odgovora**.

Posla캖e **eksploataciju** kao:

![](<../.gitbook/assets/image (911).png>)

Nakon 코to se prvi zahtev re코i i po코alje nazad napada캜u, **zahtev rtve se dodaje u red**:

![](<../.gitbook/assets/image (737).png>)

콯rtva 캖e kao odgovor primiti **HEAD odgovor + sadr쬬j odgovora drugog zahteva (koji sadr쬴 deo reflektovanih podataka):**

![](<../.gitbook/assets/image (356).png>)

Me캠utim, primetite kako je **reflektovani podatak imao veli캜inu u skladu sa Content-Length** odgovora **HEAD** koji je **generisao validan HTTP odgovor u redu odgovora**.

Stoga, **naredni zahtev drugog rtve** 캖e **primiti** kao **odgovor ne코to potpuno kreirano od strane napada캜a**. Po코to je odgovor potpuno kreiran od strane napada캜a, on tako캠e mo쬰 **naterati proxy da ke코ira odgovor**.
