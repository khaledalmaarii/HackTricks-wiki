# HTTP Response Smuggling / Desync

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

**Technika tej publikacji zostaÅ‚a zaczerpniÄ™ta z wideo:** [**https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s**](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

## Desynchronizacja Kolejki Å»Ä…daÅ„ HTTP

Po pierwsze, ta technika **wykorzystuje podatnoÅ›Ä‡ na DesynchronizacjÄ™ Å»Ä…daÅ„ HTTP**, wiÄ™c musisz wiedzieÄ‡, co to jest:

**GÅ‚Ã³wnÄ… rÃ³Å¼nicÄ…** miÄ™dzy tÄ… technikÄ… a zwykÅ‚ym DesynchronizacjÄ… Å»Ä…daÅ„ HTTP jest to, Å¼e **zamiast atakowaÄ‡ Å¼Ä…danie ofiary, dodajÄ…c do niego prefiks**, bÄ™dziemy **ujawniaÄ‡ lub modyfikowaÄ‡ odpowiedÅº, ktÃ³rÄ… otrzymuje ofiara**. Robimy to, wysyÅ‚ajÄ…c **2 kompletnie rÃ³Å¼ne Å¼Ä…dania, aby desynchronizowaÄ‡ kolejkÄ™ odpowiedzi proxy**.

PoniewaÅ¼ bÄ™dziemy w stanie **desynchronizowaÄ‡ kolejkÄ™ odpowiedzi**, odpowiedÅº z **legitymalnego Å¼Ä…dania ofiary zostanie wysÅ‚ana do atakujÄ…cego**, lub przez **wstrzykniÄ™cie kontrolowanej treÅ›ci atakujÄ…cego w odpowiedÅº do ofiary**.

### Desynchronizacja Potoku HTTP

HTTP/1.1 pozwala na **Å¼Ä…danie rÃ³Å¼nych zasobÃ³w bez koniecznoÅ›ci oczekiwania na poprzednie**. Dlatego, jeÅ›li jest **proxy** poÅ›rodku, to zadaniem proxy jest **utrzymywanie zsynchronizowanego dopasowania wysÅ‚anych Å¼Ä…daÅ„ do backendu i odpowiedzi z niego**.

JednakÅ¼e, istnieje problem desynchronizacji kolejki odpowiedzi. JeÅ›li atakujÄ…cy wysyÅ‚a atak Desynchronizacji Odpowiedzi HTTP i odpowiedzi na **poczÄ…tkowe Å¼Ä…danie i to podszyte sÄ… odpowiedziane natychmiast**, odpowiedÅº podszyta nie zostanie wstawiona do kolejki odpowiedzi ofiary, ale **po prostu zostanie odrzucona jako bÅ‚Ä…d**.

![](<../.gitbook/assets/image (630).png>)

Dlatego konieczne jest, aby **podszyte Å¼Ä…danie zajÄ™Å‚o wiÄ™cej czasu na przetworzenie** w serwerze backendowym. Dlatego, gdy podszyte Å¼Ä…danie zostanie przetworzone, komunikacja z atakujÄ…cym bÄ™dzie zakoÅ„czona.

JeÅ›li w tej konkretnej sytuacji **ofiara wysÅ‚aÅ‚a Å¼Ä…danie** i **podszyte Å¼Ä…danie zostanie odpowiedziane przed** prawidÅ‚owym Å¼Ä…daniem, **podszyta odpowiedÅº zostanie wysÅ‚ana do ofiary**. W rezultacie atakujÄ…cy bÄ™dzie **kontrolowaÄ‡ Å¼Ä…danie "wykonane" przez ofiarÄ™**.

Co wiÄ™cej, jeÅ›li **atakujÄ…cy wykonuje Å¼Ä…danie** i **legitymacyjna odpowiedÅº** na **Å¼Ä…danie ofiary jest odpowiedziana** **przed** Å¼Ä…daniem atakujÄ…cego. **OdpowiedÅº do ofiary zostanie wysÅ‚ana do atakujÄ…cego**, **kradnÄ…c** odpowiedÅº dla ofiary (ktÃ³ra moÅ¼e zawieraÄ‡ na przykÅ‚ad nagÅ‚Ã³wek **Set-Cookie**).

![](<../.gitbook/assets/image (1017).png>)

![](<../.gitbook/assets/image (716).png>)

### Wielokrotne ZagnieÅ¼dÅ¼one WstrzykniÄ™cia

InnÄ… **ciekawÄ… rÃ³Å¼nicÄ…** w porÃ³wnaniu z zwykÅ‚ym **DesynchronizacjÄ… Å»Ä…daÅ„ HTTP** jest to, Å¼e w zwykÅ‚ym ataku desynchronizacji Å¼Ä…daÅ„ HTTP, **celem** jest **modyfikacja poczÄ…tku Å¼Ä…dania ofiary**, aby wykonaÅ‚a ona nieoczekiwane dziaÅ‚anie. W ataku **Desynchronizacji Odpowiedzi HTTP**, wysyÅ‚ajÄ…c peÅ‚ne Å¼Ä…dania, moÅ¼na **wstrzyknÄ…Ä‡ w jednym Å‚adunku dziesiÄ…tki odpowiedzi**, ktÃ³re bÄ™dÄ… **desynchronizowaÄ‡ dziesiÄ…tki uÅ¼ytkownikÃ³w**, ktÃ³rzy bÄ™dÄ… **odbieraÄ‡** **wstrzykniÄ™te odpowiedzi**.

OprÃ³cz moÅ¼liwoÅ›ci **Å‚atwiejszego rozprowadzania dziesiÄ…tek exploitÃ³w** wÅ›rÃ³d prawidÅ‚owych uÅ¼ytkownikÃ³w, moÅ¼na to rÃ³wnieÅ¼ wykorzystaÄ‡ do spowodowania **DoS** na serwerze.

### Organizacja Exploitu

Jak wyjaÅ›niono wczeÅ›niej, aby wykorzystaÄ‡ tÄ™ technikÄ™, konieczne jest, aby **pierwsza podszyta wiadomoÅ›Ä‡** do serwera **zajmowaÅ‚a duÅ¼o czasu na przetworzenie**.

Ten **czasochÅ‚onny Å¼Ä…danie jest wystarczajÄ…cy**, jeÅ›li chcemy **sprÃ³bowaÄ‡ ukraÅ›Ä‡ odpowiedÅº ofiary**. Ale jeÅ›li chcesz przeprowadziÄ‡ bardziej zÅ‚oÅ¼ony exploit, to bÄ™dzie to powszechna struktura dla exploitu.

Po pierwsze **poczÄ…tkowe** Å¼Ä…danie wykorzystujÄ…ce **DesynchronizacjÄ™ Å»Ä…daÅ„ HTTP**, nastÄ™pnie **czasochÅ‚onne Å¼Ä…danie**, a nastÄ™pnie **1 lub wiÄ™cej Å¼Ä…daÅ„ Å‚adunkowych**, ktÃ³rych odpowiedzi zostanÄ… wysÅ‚ane do ofiar.

## Wykorzystanie Desynchronizacji Kolejki Odpowiedzi HTTP

### Przechwytywanie Å¼Ä…daÅ„ innych uÅ¼ytkownikÃ³w <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Podobnie jak w przypadku znanych Å‚adunkÃ³w Desynchronizacji Å»Ä…daÅ„ HTTP, moÅ¼esz **ukraÅ›Ä‡ Å¼Ä…danie ofiary** z jednÄ… waÅ¼nÄ… rÃ³Å¼nicÄ…: W tym przypadku potrzebujesz, aby **wysÅ‚ana treÅ›Ä‡ zostaÅ‚a odzwierciedlona w odpowiedzi**, **nie jest wymagane trwaÅ‚e przechowywanie**.

Najpierw atakujÄ…cy wysyÅ‚a Å‚adunek zawierajÄ…cy **ostateczne Å¼Ä…danie POST z odzwierciedlonym parametrem** na koÅ„cu i duÅ¼ym Content-Length

![](<../.gitbook/assets/image (1050).png>)

NastÄ™pnie, gdy **poczÄ…tkowe Å¼Ä…danie** (niebieskie) zostaÅ‚o **przetworzone** i **podczas** gdy **Å›piÄ…ce** jest przetwarzane (Å¼Ã³Å‚te), **nastÄ™pne Å¼Ä…danie, ktÃ³re przychodzi od ofiary**, zostanie **dodane do kolejki zaraz po odzwierciedlonym parametrze**:

![](<../.gitbook/assets/image (791).png>)

NastÄ™pnie **ofiara** otrzyma **odpowiedÅº na Å¼Ä…danie Å›piÄ…ce** i jeÅ›li w miÄ™dzyczasie **atakujÄ…cy wysÅ‚aÅ‚ kolejne Å¼Ä…danie**, **odpowiedÅº z Å¼Ä…dania odzwierciedlonej treÅ›ci zostanie wysÅ‚ana do niego**.

## Desynchronizacja Odpowiedzi

Do tej pory nauczyliÅ›my siÄ™ wykorzystywaÄ‡ ataki Desynchronizacji Å»Ä…daÅ„ HTTP do **kontroli** **Å¼Ä…dania**, **na ktÃ³re** **odpowiedÅº** **otrzyma** **klient** i jak moÅ¼na wtedy **ukraÅ›Ä‡ odpowiedÅº, ktÃ³ra byÅ‚a przeznaczona dla ofiary**.

Ale nadal moÅ¼na **jeszcze bardziej desynchronizowaÄ‡ odpowiedzi**.

IstniejÄ… interesujÄ…ce Å¼Ä…dania, takie jak Å¼Ä…danie **HEAD**, ktÃ³re sÄ… okreÅ›lone jako nieposiadajÄ…ce **Å¼adnej zawartoÅ›ci w ciele odpowiedzi** i ktÃ³re powinny (muszÄ…) **zawieraÄ‡ Content-Length** Å¼Ä…dania, jak **gdyby to byÅ‚o Å¼Ä…danie GET**.

Dlatego, jeÅ›li atakujÄ…cy **wstrzykuje** Å¼Ä…danie **HEAD**, jak na tych obrazach:

![](<../.gitbook/assets/image (1104).png>)

NastÄ™pnie, **gdy niebieskie zostanie odpowiedziane atakujÄ…cemu**, nastÄ™pne Å¼Ä…danie ofiary zostanie wprowadzone do kolejki:

![](<../.gitbook/assets/image (996).png>)

NastÄ™pnie **ofiara** otrzyma **odpowiedÅº** z **Å¼Ä…dania HEAD**, ktÃ³ra **bÄ™dzie zawieraÄ‡ Content-Length, ale w ogÃ³le nie bÄ™dzie zawieraÄ‡ treÅ›ci**. Dlatego, proxy **nie wyÅ›le tej odpowiedzi** do ofiary, ale bÄ™dzie **czekaÄ‡** na **jakÄ…Å› treÅ›Ä‡**, ktÃ³ra faktycznie bÄ™dzie **odpowiedziÄ… na Å¼Ä…danie Å¼Ã³Å‚te** (rÃ³wnieÅ¼ wstrzykniÄ™te przez atakujÄ…cego):

![](<../.gitbook/assets/image (732).png>)
### Zamieszanie w treÅ›ci

W oparciu o poprzedni przykÅ‚ad, majÄ…c Å›wiadomoÅ›Ä‡, Å¼e moÅ¼na **kontrolowaÄ‡ treÅ›Ä‡** Å¼Ä…dania, ktÃ³rego odpowiedÅº otrzyma ofiara, a **odpowiedÅº HEAD** zazwyczaj zawiera w nagÅ‚Ã³wkach **Content-Type i Content-Length**, moÅ¼na **wysÅ‚aÄ‡ Å¼Ä…danie takie jak to poniÅ¼ej**, aby **wywoÅ‚aÄ‡ XSS** u ofiary, nawet jeÅ›li strona nie jest podatna na XSS:

![](<../.gitbook/assets/image (685).png>)

### Zatrucie pamiÄ™ci podrÄ™cznej

WykorzystujÄ…c wczeÅ›niej omawiany atak zamieszania treÅ›ci odpowiedzi desynchronizacji, **jeÅ›li pamiÄ™Ä‡ podrÄ™czna przechowuje odpowiedÅº na Å¼Ä…danie wykonane przez ofiarÄ™, a ta odpowiedÅº jest wstrzykniÄ™ta i powoduje XSS, to pamiÄ™Ä‡ podrÄ™czna jest zatruta**.

ZÅ‚oÅ›liwe Å¼Ä…danie zawierajÄ…ce Å‚adunek XSS:

![](<../.gitbook/assets/image (611).png>)

ZÅ‚oÅ›liwa odpowiedÅº dla ofiary zawierajÄ…ca nagÅ‚Ã³wek wskazujÄ…cy pamiÄ™ci podrÄ™cznej, aby przechowywaÅ‚a odpowiedÅº:

![](<../.gitbook/assets/image (563).png>)

{% hint style="warning" %}
ZauwaÅ¼, Å¼e w tym przypadku jeÅ›li **"ofiara" jest atakujÄ…cym**, moÅ¼e teraz przeprowadziÄ‡ **zatrucie pamiÄ™ci podrÄ™cznej w dowolnych adresach URL**, poniewaÅ¼ moÅ¼e **kontrolowaÄ‡ adres URL, ktÃ³ry zostanie zapisany w pamiÄ™ci podrÄ™cznej** za pomocÄ… zÅ‚oÅ›liwej odpowiedzi.
{% endhint %}

### Oszustwo pamiÄ™ci podrÄ™cznej sieci Web

Ten atak jest podobny do poprzedniego, ale **zamiast wstrzykiwaÄ‡ Å‚adunek do pamiÄ™ci podrÄ™cznej, atakujÄ…cy bÄ™dzie przechowywaÅ‚ informacje ofiary w pamiÄ™ci podrÄ™cznej:**

![](<../.gitbook/assets/image (988).png>)

### PodziaÅ‚ odpowiedzi

Celem tego ataku jest ponowne wykorzystanie **desynchronizacji odpowiedzi** w celu **przekazania przez proxy odpowiedzi w 100% wygenerowanej przez atakujÄ…cego**.

Aby osiÄ…gnÄ…Ä‡ ten cel, atakujÄ…cy musi znaleÅºÄ‡ punkt koÅ„cowy aplikacji internetowej, ktÃ³ry **odzwierciedla pewne wartoÅ›ci w odpowiedzi** i **znaÄ‡ dÅ‚ugoÅ›Ä‡ treÅ›ci odpowiedzi HEAD**.

WyÅ›le **exploit** tak jak:

![](<../.gitbook/assets/image (908).png>)

Po rozwiÄ…zaniu i odesÅ‚aniu pierwszego Å¼Ä…dania do atakujÄ…cego, **Å¼Ä…danie ofiary zostaje dodane do kolejki**:

![](<../.gitbook/assets/image (734).png>)

Ofiara otrzyma jako odpowiedÅº **odpowiedÅº HEAD + treÅ›Ä‡ odpowiedzi drugiego Å¼Ä…dania (zawierajÄ…ca czÄ™Å›Ä‡ odzwierciedlonych danych):**

![](<../.gitbook/assets/image (353).png>)

ZauwaÅ¼ jednak, Å¼e **odzwierciedlone dane miaÅ‚y rozmiar zgodny z Content-Length** odpowiedzi **HEAD**, co **wygenerowaÅ‚o poprawnÄ… odpowiedÅº HTTP w kolejce odpowiedzi**.

Dlatego **nastÄ™pne Å¼Ä…danie drugiej ofiary** otrzyma jako **odpowiedÅº coÅ› caÅ‚kowicie spreparowanego przez atakujÄ…cego**. PoniewaÅ¼ odpowiedÅº jest caÅ‚kowicie spreparowana przez atakujÄ…cego, moÅ¼e on rÃ³wnieÅ¼ **spowodowaÄ‡, Å¼e proxy przechowa odpowiedÅº**.
