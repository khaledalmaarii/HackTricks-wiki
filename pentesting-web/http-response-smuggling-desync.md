# HTTP Response Smuggling / Desync

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Tehnika ovog posta je preuzeta iz videa:** [**https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s**](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

## HTTP Request Queue Desynchronisation

Prvo, ova tehnika **zloupotrebljava HTTP Request Smuggling ranjivost**, tako da treba da znate 코ta je to:

**Glavna** **razlika** izme캠u ove tehnike i uobi캜ajenog HTTP Request smuggling-a je to 코to **umesto** da **napadamo** **zahtev** **rtve** **dodavanjem prefiksa**, mi 캖emo **ukrasti ili izmeniti odgovor koji rtva prima**. To se posti쬰 tako 코to, umesto da po코aljemo 1 zahtev i po da zloupotrebimo HTTP Request smuggling, **po코aljemo 2 potpuna zahteva da desinkronizujemo redosled odgovora proksija**.

To je zato 코to 캖emo mo캖i da **desinkronizujemo redosled odgovora** tako da **odgovor** iz **legitimnog** **zahteva** **rtve bude poslat napada캜u**, ili tako 코to 캖emo **ubaciti sadr쬬j pod kontrolom napada캜a u odgovor rtvi**.

### HTTP Pipeline Desync

HTTP/1.1 omogu캖ava da se tra쬰 **razli캜iti resursi bez potrebe da se 캜eka na prethodne**. Stoga, ako postoji **proksi** u **sredini**, zadatak proksija je da **odr쬴 sinhronizovanu podudarnost zahteva poslatih ka backend-u i odgovora koji dolaze iz njega**.

Me캠utim, postoji problem sa desinkronizacijom redosleda odgovora. Ako napada캜 po코alje HTTP Response smuggling napad i odgovori na **po캜etni zahtev i smugglovani zahtev budu odmah poslati**, smugglovani odgovor ne캖e biti umetnut u redosled odgovora rtve, ve캖 캖e **biti odbijen kao gre코ka**.

![](<../.gitbook/assets/image (633).png>)

Stoga, potrebno je da **smugglovani** **zahtev** **traje du쬰 da bude obra캠en** unutar backend servera. Tako da, dok se smugglovani zahtev obra캠uje, komunikacija sa napada캜em 캖e biti zavr코ena.

Ako u ovoj specifi캜noj situaciji **rtva po코alje zahtev** i **smugglovani zahtev bude odgovoreno pre** legitimnog zahteva, **smugglovani odgovor 캖e biti poslat rtvi**. Tako da 캖e napada캜 **kontrolisati zahtev "izvr코en" od strane rtve**.

맚avi코e, ako **napada캜 zatim izvr코i zahtev** i **legitimni odgovor** na **zahtev rtve** bude **odgovoren** **pre** napada캜evog zahteva. **Odgovor rtvi 캖e biti poslat napada캜u**, **kradu캖i** odgovor rtvi (koji mo쬰 sadr쬬ti, na primer, zaglavlje **Set-Cookie**).

![](<../.gitbook/assets/image (1020).png>)

![](<../.gitbook/assets/image (719).png>)

### Multiple Nested Injections

Jo코 jedna **zanimljiva razlika** sa uobi캜ajenim **HTTP Request Smuggling** je to 코to, u uobi캜ajenom smugglovanju, **cilj** je da se **izmeni po캜etak zahteva rtve** tako da izvr코i neo캜ekivanu akciju. U **HTTP Response smuggling napadu**, po코to 코aljete **pune zahteve**, mo쬰te **ubaciti u jedan payload desetine odgovora** koji 캖e **desinkronizovati desetine korisnika** koji 캖e **primati** **ubacene** **odgovore**.

Pored toga 코to mo쬰te **lak코e distribuirati desetine eksploita** me캠u legitimnim korisnicima, ovo se tako캠e mo쬰 koristiti za izazivanje **DoS** na serveru.

### Exploit Organisation

Kao 코to je ranije obja코njeno, da biste zloupotrebili ovu tehniku, potrebno je da **prva smugglovana poruka** unutar servera **zahteva puno vremena da bude obra캠ena**.

Ovaj **zahtev koji zahteva vreme** je dovoljan ako samo 쬰lite da **poku코ate da ukradete odgovor rtve.** Ali ako 쬰lite da izvr코ite slo쬰niji exploit, ovo 캖e biti uobi캜ajena struktura za exploit.

Prvo, **po캜etni** zahtev koji zloupotrebljava **HTTP** **Request** **smuggling**, zatim **zahtev koji zahteva vreme** i zatim **1 ili vi코e payload zahteva** 캜iji 캖e odgovori biti poslati rtvama.

## Abusing HTTP Response Queue Desynchronisation

### Capturing other users' requests <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Kao i sa poznatim payload-ima HTTP Request Smuggling-a, mo쬰te **ukrasti zahtev rtve** sa jednom va쬹om razlikom: U ovom slu캜aju vam je samo potrebno da **sadr쬬j bude reflektovan u odgovoru**, **nije potrebno trajno skladi코tenje**.

Prvo, napada캜 코alje payload koji sadr쬴 **kona캜ni POST zahtev sa reflektovanim parametrom** na kraju i velikim Content-Length.

![](<../.gitbook/assets/image (1053).png>)

Zatim, kada je **po캜etni zahtev** (plavi) bio **obra캠en** i **dok** se **spori** obra캠uje (쬿ti), **slede캖i zahtev koji dolazi od rtve** 캖e biti **dodato u redosled odmah nakon reflektovanog parametra**:

![](<../.gitbook/assets/image (794).png>)

Zatim, **rtva** 캖e **primiti** **odgovor na spori** zahtev i ako u me캠uvremenu **napada캜** **po코alje** **jo코 jedan** **zahtev**, **odgovor iz zahteva reflektovanog sadr쬬ja 캖e biti poslat njemu**.

## Response Desynchronisation

Do ovog trenutka, nau캜ili smo kako da zloupotrebimo HTTP Request Smuggling napade da **kontroli코emo** **zahtev** **캜iji** **odgovor** 캖e **klijent** **primiti** i kako mo쬰te zatim **ukrasti odgovor koji je bio namenjen rtvi**.

Ali je jo코 uvek mogu캖e **desinkronizovati jo코** vi코e odgovore.

Postoje zanimljivi zahtevi kao 코to je **HEAD** zahtev koji su specificirani da nemaju **nikakav sadr쬬j unutar tela odgovora** i koji bi trebali (moraju) **sadr쬬ti Content-Length** zahteva kao **da je to GET zahtev**.

Stoga, ako napada캜 **ubaci** **HEAD** zahtev, kao u ovim slikama:

![](<../.gitbook/assets/image (1107).png>)

Zatim, **kada plavi zahtev bude odgovoreno napada캜u**, slede캖i zahtev rtve 캖e biti uveden u redosled:

![](<../.gitbook/assets/image (999).png>)

Zatim, **rtva** 캖e **primiti** **odgovor** iz **HEAD** zahteva, koji 캖e **sadr쬬ti Content-Length ali nikakav sadr쬬j**. Stoga, proksi **ne캖e poslati ovaj odgovor** rtvi, ve캖 캖e **캜ekati** na neki **sadr쬬j**, koji 캖e zapravo biti **odgovor na 쬿ti zahtev** (tako캠e uba캜en od strane napada캜a):

![](<../.gitbook/assets/image (735).png>)

### Content Confusion

Prate캖i prethodni primer, znaju캖i da mo쬰te **kontrolisati telo** zahteva 캜iji odgovor 캖e primiti rtva i da **HEAD** **odgovor** obi캜no sadr쬴 u svojim zaglavljima **Content-Type i Content-Length**, mo쬰te **poslati zahtev kao 코to je slede캖i** da **uzrokujete XSS** kod rtve bez da stranica bude ranjiva na XSS:

![](<../.gitbook/assets/image (688).png>)

### Cache Poisoning

Zloupotrebljavaju캖i prethodno komentarisani odgovor desinkronizacije Content Confusion napad, **ako ke코 skladi코ti odgovor na zahtev izvr코en od strane rtve i ovaj odgovor je uba캜en izazivaju캖i XSS, tada je ke코 otrovan**.

Maliciozni zahtev koji sadr쬴 XSS payload:

![](<../.gitbook/assets/image (614).png>)

Maliciozni odgovor rtvi koji sadr쬴 zaglavlje koje ukazuje ke코u da skladi코ti odgovor:

![](<../.gitbook/assets/image (566).png>)

{% hint style="warning" %}
Napomena da u ovom slu캜aju ako je **"rtva" napada캜**, on sada mo쬰 izvr코iti **ke코 otrovanje na proizvoljnim URL-ovima** jer mo쬰 **kontrolisati URL koji 캖e biti ke코iran** sa malicioznim odgovorom.
{% endhint %}

### Web Cache Deception

Ovaj napad je sli캜an prethodnom, ali **umesto da ubacuje payload unutar ke코a, napada캜 캖e ke코irati informacije o rtvi unutar ke코a:**

![](<../.gitbook/assets/image (991).png>)

### Response Splitting

**Cilj** ovog napada je ponovo zloupotreba **odgovora** **desinkronizacije** kako bi se **proksi naterao da po코alje 100% napada캜em generisan odgovor**.

Da bi to postigao, napada캜 treba da prona캠e krajnju ta캜ku web aplikacije koja **reflektuje neke vrednosti unutar odgovora** i **zna sadr쬬j du쬴ne HEAD odgovora**.

On 캖e poslati **eksploit** kao:

![](<../.gitbook/assets/image (911).png>)

Nakon 코to je prvi zahtev re코en i poslat nazad napada캜u, **zahtev rtve se dodaje u redosled**:

![](<../.gitbook/assets/image (737).png>)

콯rtva 캖e primiti kao odgovor **HEAD odgovor + sadr쬬j odgovora drugog zahteva (sadr쬴 deo reflektovanih podataka):**

![](<../.gitbook/assets/image (356).png>)

Me캠utim, obratite pa쬹ju kako su **reflektovani podaci imali veli캜inu prema Content-Length** **HEAD** odgovora koji je **generisao validan HTTP odgovor u redosledu odgovora**.

Stoga, **slede캖i zahtev drugog rtve** 캖e **primiti** kao **odgovor ne코to potpuno kreirano od strane napada캜a**. Kako je odgovor potpuno kreiran od strane napada캜a, on tako캠e mo쬰 **naterati proksi da ke코ira odgovor**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
