# HTTP Response Smuggling / Desync

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriÃ³w GitHub**.

</details>

**Technika opisana w tym poÅ›cie zostaÅ‚a zaczerpniÄ™ta z filmu: [https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)**


## Desynchronizacja kolejki Å¼Ä…daÅ„ HTTP

Przede wszystkim, ta technika **wykorzystuje podatnoÅ›Ä‡ na HTTP Request Smuggling**, wiÄ™c musisz wiedzieÄ‡, czym jest:

**GÅ‚Ã³wna** **rÃ³Å¼nica** miÄ™dzy tÄ… technikÄ… a zwykÅ‚ym HTTP Request smuggling polega na tym, Å¼e **zamiast atakowaÄ‡ Å¼Ä…danie ofiary, dodajÄ…c do niego prefiks**, bÄ™dziemy **ujawniaÄ‡ lub modyfikowaÄ‡ odpowiedÅº, ktÃ³rÄ… otrzymuje ofiara**. Robimy to, wysyÅ‚ajÄ…c nie 1,5 Å¼Ä…dania, jak w przypadku wykorzystania HTTP Request smuggling, ale **2 peÅ‚ne Å¼Ä…dania, aby dezynchronizowaÄ‡ kolejkÄ™ odpowiedzi proxy**.

Dzieje siÄ™ tak, poniewaÅ¼ bÄ™dziemy w stanie **dezynchronizowaÄ‡ kolejkÄ™ odpowiedzi**, dziÄ™ki czemu **odpowiedÅº** na **legitymacyjne Å¼Ä…danie ofiary zostanie wysÅ‚ana do atakujÄ…cego**, lub przez **wstrzykniÄ™cie kontrolowanej przez atakujÄ…cego zawartoÅ›ci w odpowiedÅº dla ofiary**.

### Desynchronizacja potoku HTTP

HTTP/1.1 pozwala na **Å¼Ä…danie rÃ³Å¼nych zasobÃ³w bez koniecznoÅ›ci oczekiwania na poprzednie**. Dlatego, jeÅ›li jest **proxy** po **Å›rodku**, to zadaniem proxy jest **utrzymywanie zsynchronizowanego dopasowania wysÅ‚anych Å¼Ä…daÅ„ do backendu i odpowiedzi z niego**.

Jednak istnieje problem dezynchronizacji kolejki odpowiedzi. JeÅ›li atakujÄ…cy wyÅ›le atak HTTP Response smuggling i odpowiedzi na **poczÄ…tkowe Å¼Ä…danie i wstrzykniÄ™te Å¼Ä…danie zostanÄ… natychmiast odpowiedziane**, wstrzykniÄ™ta odpowiedÅº nie zostanie wstawiona do kolejki odpowiedzi ofiary, ale zostanie **po prostu odrzucona jako bÅ‚Ä…d**.

![](<../.gitbook/assets/image (635) (1) (1) (1).png>)

Dlatego konieczne jest, aby **wstrzykniÄ™te** **Å¼Ä…danie zajÄ™Å‚o wiÄ™cej czasu na przetworzenie** w serwerze backendowym. DziÄ™ki temu, gdy wstrzykniÄ™te Å¼Ä…danie zostanie przetworzone, komunikacja z atakujÄ…cym zostanie zakoÅ„czona.

JeÅ›li w tej konkretnej sytuacji **ofiara wysÅ‚aÅ‚a Å¼Ä…danie**, a **wstrzykniÄ™te Å¼Ä…danie zostanie odpowiedziane przed** legitymacyjnym Å¼Ä…daniem, **wstrzykniÄ™ta odpowiedÅº zostanie wysÅ‚ana do ofiary**. W ten sposÃ³b atakujÄ…cy **kontroluje Å¼Ä…danie "wykonane" przez ofiarÄ™**.

Ponadto, jeÅ›li **atakujÄ…cy wykonuje Å¼Ä…danie**, a **legitymacyjna odpowiedÅº** na **Å¼Ä…danie ofiary** jest **odpowiadana przed** Å¼Ä…daniem atakujÄ…cego, **odpowiedÅº dla ofiary zostanie wysÅ‚ana do atakujÄ…cego**, **kradnÄ…c** odpowiedÅº dla ofiary (ktÃ³ra moÅ¼e zawieraÄ‡ na przykÅ‚ad nagÅ‚Ã³wek **Set-Cookie**).

![](<../.gitbook/assets/image (658) (1).png>)

![](<../.gitbook/assets/image (655) (1) (1) (1).png>)

### Wielokrotne zagnieÅ¼dÅ¼one wstrzykniÄ™cia

InnÄ… **ciekawÄ… rÃ³Å¼nicÄ…** w porÃ³wnaniu do zwykÅ‚ego **HTTP Request Smuggling** jest to, Å¼e w przypadku zwykÅ‚ego ataku smugglingowego celem jest **modyfikacja poczÄ…tku Å¼Ä…dania ofiary**, aby wykonaÅ‚o ono nieoczekiwane dziaÅ‚anie. W przypadku ataku **HTTP Response smuggling**, wysyÅ‚asz peÅ‚ne Å¼Ä…dania, wiÄ™c moÅ¼esz **wstrzyknÄ…Ä‡ w jednym payloadzie dziesiÄ…tki odpowiedzi**, ktÃ³re bÄ™dÄ… **dezynchronizowaÄ‡ dziesiÄ…tki uÅ¼ytkownikÃ³w**, ktÃ³rzy bÄ™dÄ… **odbieraÄ‡** **wstrzykniÄ™te odpowiedzi**.

OprÃ³cz moÅ¼liwoÅ›ci **Å‚atwiejszego rozpowszechniania dziesiÄ…tek exploitÃ³w** wÅ›rÃ³d prawowitych uÅ¼ytkownikÃ³w, moÅ¼na to rÃ³wnieÅ¼ wykorzystaÄ‡ do spowodowania **DoS** na serwerze.

### Organizacja exploitu

Jak wyjaÅ›niono wczeÅ›niej, aby wykorzystaÄ‡ tÄ™ technikÄ™, konieczne jest, aby **pierwsza wstrzykniÄ™ta wiadomoÅ›Ä‡** do serwera **zajmowaÅ‚a duÅ¼o czasu na przetworzenie**.

To **Å¼Ä…danie czasochÅ‚onne wystarczy**, jeÅ›li chcemy tylko **sprÃ³bowaÄ‡ ukraÅ›Ä‡ odpowiedÅº ofiary**. Ale jeÅ›li chcesz przeprowadziÄ‡ bardziej zÅ‚oÅ¼ony exploit, to bÄ™dzie to powszechna struktura dla exploitu.

Najpierw **poczÄ…tkowe** Å¼Ä…danie wykorzystujÄ…ce **HTTP Request smuggling**, nastÄ™pnie **Å¼Ä…danie czasochÅ‚onne** i nastÄ™pnie **1 lub wiÄ™cej Å¼Ä…daÅ„ payloadowych**, ktÃ³rych odpowiedzi zostanÄ… wysÅ‚ane do ofiar.

## Wykorzystywanie dezynchronizacji kolejki odpowiedzi HTTP

### Przechwytywanie Å¼Ä…daÅ„ innych uÅ¼ytkownikÃ³w <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Podobnie jak w przypadku znanych payloadÃ³w HTTP Request Smuggling, moÅ¼esz **ukraÅ›Ä‡ Å¼Ä…danie ofiary** z jednÄ… waÅ¼nÄ… rÃ³Å¼nicÄ…: w tym przypadku potrzebujesz, aby **wysÅ‚ana zawartoÅ›Ä‡ zostaÅ‚a odzwierciedlona w odpowiedzi**, **nie jest potrzebne trwaÅ‚e przechowywanie**.

Najpierw atakujÄ…cy wysyÅ‚a payload zawierajÄ…cy **ostateczne Å¼Ä…danie POST z odzwierciedlonym parametrem** na koÅ„cu i duÅ¼Ä… wartoÅ›Ä‡ Content-Length

![](<../.gitbook/assets/image (625).png>)

NastÄ™pnie, gdy **poczÄ…tkowe Å¼Ä…danie** (niebieskie) zostanie **przetworzone**, a **czasochÅ‚onne Å¼Ä…danie** (Å¼Ã³Å‚te) jest przetwarzane, **nastÄ™pne Å¼Ä…danie, ktÃ³re przychodzi od ofiary**, zostanie **dodane do kolejki tuÅ¼ po odzwierciedlonym parametrze**:

![](<../.gitbook/assets/image (634) (1).png>)

NastÄ™pnie, **ofiara** otrzyma **odpowiedÅº na Å¼Ä…danie czasochÅ‚onne** i jeÅ›li w miÄ™dzyczasie **atakujÄ…cy wyÅ›le kolejne Å¼Ä…danie**, **odpowiedÅº na Å¼
### Zamieszanie treÅ›ci

KontrolujÄ…c treÅ›Ä‡ Å¼Ä…dania, ktÃ³rego odpowiedÅº otrzyma ofiara, i wiedzÄ…c, Å¼e odpowiedÅº typu HEAD zwykle zawiera w nagÅ‚Ã³wkach typ zawartoÅ›ci (Content-Type) i dÅ‚ugoÅ›Ä‡ zawartoÅ›ci (Content-Length), moÅ¼na wysÅ‚aÄ‡ Å¼Ä…danie takie jak poniÅ¼sze, aby spowodowaÄ‡ XSS w ofierze, nawet jeÅ›li strona nie jest podatna na XSS:

![](<../.gitbook/assets/image (654) (1) (1) (1) (1).png>)

### Zatrucie pamiÄ™ci podrÄ™cznej

WykorzystujÄ…c wczeÅ›niej omawiany atak dezynchronizacji odpowiedzi Content Confusion, jeÅ›li pamiÄ™Ä‡ podrÄ™czna przechowuje odpowiedÅº na Å¼Ä…danie wykonane przez ofiarÄ™, a ta odpowiedÅº jest wstrzykniÄ™ta i powoduje XSS, to pamiÄ™Ä‡ podrÄ™czna jest zatruta.

ZÅ‚oÅ›liwe Å¼Ä…danie zawierajÄ…ce Å‚adunek XSS:

![](<../.gitbook/assets/image (644) (1).png>)

ZÅ‚oÅ›liwa odpowiedÅº dla ofiary, ktÃ³ra zawiera nagÅ‚Ã³wek wskazujÄ…cy pamiÄ™ci podrÄ™cznej, aby przechowaÄ‡ odpowiedÅº:

![](<../.gitbook/assets/image (629) (1).png>)

{% hint style="warning" %}
ZauwaÅ¼, Å¼e w tym przypadku, jeÅ›li "ofiara" jest atakujÄ…cym, moÅ¼e teraz przeprowadzaÄ‡ zatrucie pamiÄ™ci podrÄ™cznej w dowolnych adresach URL, poniewaÅ¼ moÅ¼e kontrolowaÄ‡ URL, ktÃ³ry zostanie zapisany w pamiÄ™ci podrÄ™cznej wraz z zÅ‚oÅ›liwÄ… odpowiedziÄ….
{% endhint %}

### Oszustwo pamiÄ™ci podrÄ™cznej sieci Web

Ten atak jest podobny do poprzedniego, ale zamiast wstrzykiwaÄ‡ Å‚adunek do pamiÄ™ci podrÄ™cznej, atakujÄ…cy bÄ™dzie przechowywaÅ‚ informacje ofiary w pamiÄ™ci podrÄ™cznej:

![](<../.gitbook/assets/image (643) (1) (1).png>)

### PodziaÅ‚ odpowiedzi

Celem tego ataku jest ponowne wykorzystanie dezynchronizacji odpowiedzi w celu spowodowania, Å¼e serwer proxy wyÅ›le odpowiedÅº w 100% wygenerowanÄ… przez atakujÄ…cego.

Aby to osiÄ…gnÄ…Ä‡, atakujÄ…cy musi znaleÅºÄ‡ punkt koÅ„cowy aplikacji internetowej, ktÃ³ry odbija pewne wartoÅ›ci w odpowiedzi i zna dÅ‚ugoÅ›Ä‡ zawartoÅ›ci odpowiedzi typu HEAD.

WyÅ›le on zÅ‚oÅ›liwe Å¼Ä…danie, takie jak:

![](<../.gitbook/assets/image (649) (1) (1) (1).png>)

Po rozwiÄ…zaniu i odesÅ‚aniu pierwszego Å¼Ä…dania do atakujÄ…cego, Å¼Ä…danie ofiary zostaje dodane do kolejki:

![](<../.gitbook/assets/image (661) (1) (1) (1).png>)

Ofiara otrzyma jako odpowiedÅº odpowiedÅº typu HEAD + zawartoÅ›Ä‡ odpowiedzi drugiego Å¼Ä…dania (zawierajÄ…cÄ… czÄ™Å›Ä‡ odbijanych danych):

![](<../.gitbook/assets/image (633) (1).png>)

ZauwaÅ¼ jednak, Å¼e odbite dane miaÅ‚y rozmiar zgodny z dÅ‚ugoÅ›ciÄ… zawartoÅ›ci odpowiedzi HEAD, co spowodowaÅ‚o wygenerowanie poprawnej odpowiedzi HTTP w kolejce odpowiedzi.

Dlatego nastÄ™pne Å¼Ä…danie drugiej ofiary otrzyma jako odpowiedÅº coÅ›, co zostaÅ‚o caÅ‚kowicie spreparowane przez atakujÄ…cego. PoniewaÅ¼ odpowiedÅº jest caÅ‚kowicie spreparowana przez atakujÄ…cego, moÅ¼e on rÃ³wnieÅ¼ spowodowaÄ‡ zapisanie odpowiedzi w pamiÄ™ci podrÄ™cznej serwera proxy.


<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
