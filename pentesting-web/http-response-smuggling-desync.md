# HTTP Response Smuggling / Desync

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Tehnika ovog posta je preuzeta iz videa: [https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)**


## Desinhronizacija reda HTTP zahteva

Prvo, ova tehnika **zloupotrebljava ranjivost HTTP Request Smuggling**, pa morate znati 코ta je to:

**Glavna** **razlika** izme캠u ove tehnike i uobi캜ajenog HTTP Request smuggling-a je ta 코to umesto **napada** **zahteva** **rtve dodavanjem prefiksa**, mi 캖emo **procuriti ili izmeniti odgovor koji rtva prima**. To se posti쬰 tako 코to, umesto slanja 1 zahteva i pola za zloupotrebu HTTP Request smuggling-a, **코aljemo 2 potpuna zahteva da bismo desinhronizovali red odgovora proxy-ja**.

To je zato 코to 캖emo biti u mogu캖nosti da **desinhronizujemo red odgovora**, tako da **odgovor** na **legitimni zahtev rtve bude poslat napada캜u**, ili da se **ubaci sadr쬬j pod kontrolom napada캜a u odgovor rtvi**.

### Desinhronizacija HTTP Pipeline-a

HTTP/1.1 omogu캖ava da se **zahtevaju razli캜iti resursi bez 캜ekanja na prethodne**. Dakle, ako postoji **proxy** na **sredini**, zadatak proxy-ja je da **odr쬬va sinhronizovanu vezu izme캠u zahteva poslatih backend-u i odgovora koji dolaze od njega**.

Me캠utim, postoji problem desinhronizacije reda odgovora. Ako napada캜 po코alje napad HTTP Response smuggling-a i odgovori na **po캜etni zahtev i prokrijum캜areni zahtev budu odgovoreni odmah**, prokrijum캜areni odgovor ne캖e biti uba캜en u red odgovora rtve, ve캖 캖e **biti odba캜en kao gre코ka**.

![](<../.gitbook/assets/image (635) (1) (1) (1).png>)

Zato je potrebno da **prokrijum캜areni** **zahtev** **traje du쬰 vreme da bi bio obra캠en** na backend serveru. Dakle, do trenutka kada se prokrijum캜areni zahtev obradi, komunikacija sa napada캜em 캖e biti zavr코ena.

Ako u ovoj specifi캜noj situaciji **rtva po코alje zahtev** i **prokrijum캜areni zahtev bude odgovoren pre** legitimnog zahteva, **prokrijum캜areni odgovor 캖e biti poslat rtvi**. Dakle, napada캜 캖e **kontrolisati zahtev "izvr코en" od strane rtve**.

Osim toga, ako **napada캜 zatim izvr코i zahtev** i **legitimni odgovor** na **zahtev rtve bude odgovoren pre** napada캜evog zahteva. **Odgovor na rtvu 캖e biti poslat napada캜u**, **ukraden** odgovor rtvi (koji mo쬰 sadr쬬ti na primer zaglavlje **Set-Cookie**).

![](<../.gitbook/assets/image (658) (1).png>)

![](<../.gitbook/assets/image (655) (1) (1) (1).png>)

### Vi코estruke ugnje쬯ene injekcije

Jo코 jedna **interesantna razlika** u odnosu na uobi캜ajeni **HTTP Request Smuggling** je ta 코to, kod uobi캜ajenog smuggling napada, **cilj** je **izmeniti po캜etak zahteva rtve** kako bi izvr코ila neo캜ekivanu radnju. Kod **HTTP Response smuggling napada**, po코to 코aljete potpune zahteve, mo쬰te **ubaciti u jedan payload desetine odgovora** koji 캖e **desinhronizovati desetine korisnika** koji 캖e **primiti** **ubacene** **odgovore**.

Osim 코to mo쬰te **lak코e distribuirati desetine eksploatacija** me캠u legitimnim korisnicima, ovo tako캠e mo쬰 biti kori코캖eno za izazivanje **DoS** napada na server.

### Organizacija eksploatacije

Kao 코to je obja코njeno ranije, da biste zloupotrebili ovu tehniku, potrebno je da **prva prokrijum캜arena poruka** u serveru **zahteva dosta vremena za obradu**.

Ovaj **zahtev koji tro코i vreme je dovoljan** ako samo 쬰limo da **poku코amo ukrasti odgovor rtve**. Ali ako 쬰lite da izvr코ite slo쬰niju eksploataciju, ovo 캖e biti uobi캜ajena struktura za eksploataciju.

Prvo **po캜etni** zahtev koji zloupotrebljava **HTTP Request smuggling**, zatim **zahtev koji tro코i vreme**, a zatim **1 ili vi코e zahteva sa payload-om** 캜iji 캖e odgovori biti poslati rtvama.

## Zloupotreba desinhronizacije reda HTTP odgovora

### Snimanje zahteva drugih korisnika <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Kao i sa poznatim payload-ima za HTTP Request Smuggling, mo쬰te **ukrasti zahtev rtve** sa jednom va쬹om razlikom: U ovom slu캜aju vam je potrebno samo **poslati sadr쬬j koji 캖e se odraziti u odgovoru**, **nije potrebno trajno skladi코tenje**.

Prvo, napada캜 코alje payload koji sadr쬴 **zavr코ni POST zahtev sa odra쬰nim parametrom** na kraju i velikom Content-Length vredno코캖u

![](<../.gitbook/assets/image (625).png>)

Zatim, jednom kada je **po캜etni zahtev** (plavi) **obra캠en**, a **dok** se **zahtev koji tro코i vreme** (쬿ti) **obra캠uje**, **slede캖i zahtev koji stigne od rtve** 캖e biti **dodat u red odmah nakon odra쬰nog parametra**:

![](<../.gitbook/assets/image (634) (1).png>)

Zatim, **rtva** 캖e **primiti odgovor na zahtev koji tro코i vreme**, i ako u me캠uvremenu **napada캜 po코alje jo코 jedan zahtev**, **odgovor na zahtev sa
### Konfuzija sadr쬬ja

Slede캖i prethodni primer, znaju캖i da mo쬰te **kontrolisati telo** zahteva 캜iji 캖e odgovor primiti rtva i da **HEAD** **odgovor** obi캜no sadr쬴 u zaglavljima **Content-Type i Content-Length**, mo쬰te **poslati zahtev kao 코to je slede캖i** da izazovete XSS u rtvi, 캜ak i ako stranica nije ranjiva na XSS:

![](<../.gitbook/assets/image (654) (1) (1) (1) (1).png>)

### Trovanje ke코a

Zloupotrebom prethodno komentarisane napada캜ke desinhronizacije odgovora, ako ke코 캜uva odgovor na zahtev koji je izvr코ila rtva, a taj odgovor je uba캜en i izaziva XSS, tada je ke코 otrovan.

Zlonamerni zahtev koji sadr쬴 XSS payload:

![](<../.gitbook/assets/image (644) (1).png>)

Zlonamerni odgovor rtvi koji sadr쬴 zaglavlje koje ukazuje ke코u da sa캜uva odgovor:

![](<../.gitbook/assets/image (629) (1).png>)

{% hint style="warning" %}
Imajte na umu da u ovom slu캜aju, ako je **"rtva" napada캜**, sada mo쬰 izvr코iti **trovanje ke코a na proizvoljnim URL-ovima**, jer mo쬰 **kontrolisati URL koji 캖e biti ke코iran** sa zlonamernim odgovorom.
{% endhint %}

### Prevara veb ke코a

Ovaj napad je sli캜an prethodnom, ali **umesto ubacivanja payloada u ke코, napada캜 캖e ke코irati informacije rtve unutar ke코a**:

![](<../.gitbook/assets/image (643) (1) (1).png>)

### Podela odgovora

Cilj ovog napada je ponovo zloupotreba **desinhronizacije odgovora** kako bi se **naterao proxy da po코alje odgovor koji je 100% generisan od strane napada캜a**.

Da bi to postigao, napada캜 mora prona캖i krajnju ta캜ku veb aplikacije koja **reflektuje neke vrednosti unutar odgovora** i **znati du쬴nu sadr쬬ja HEAD odgovora**.

Posla캖e **eksploataciju** kao 코to je:

![](<../.gitbook/assets/image (649) (1) (1) (1).png>)

Nakon 코to se prvi zahtev re코i i po코alje nazad napada캜u, **zahtev rtve se dodaje u red**:

![](<../.gitbook/assets/image (661) (1) (1) (1).png>)

콯rtva 캖e kao odgovor primiti **HEAD odgovor + sadr쬬j odgovora drugog zahteva (koji sadr쬴 deo reflektovanih podataka):**

![](<../.gitbook/assets/image (633) (1).png>)

Me캠utim, obratite pa쬹ju kako su **reflektovani podaci imali veli캜inu u skladu sa Content-Length** odgovora **HEAD** koji je **generisao validan HTTP odgovor u redu odgovora**.

Stoga, **naredni zahtev drugog rtve** 캖e **primiti** kao **odgovor ne코to potpuno kreirano od strane napada캜a**. Po코to je odgovor potpuno kreiran od strane napada캜a, on tako캠e mo쬰 **ke코irati odgovor proxy servera**.


<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **ogla코avanje va코e kompanije u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
