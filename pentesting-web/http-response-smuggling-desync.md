# HTTP Response Smuggling / Desync

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}

**Technika opisana w tym poÅ›cie zostaÅ‚a zaczerpniÄ™ta z wideo:** [**https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s**](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

## Desynchronizacja kolejki Å¼Ä…daÅ„ HTTP

Przede wszystkim, ta technika **wykorzystuje lukÄ™ w HTTP Request Smuggling**, wiÄ™c musisz wiedzieÄ‡, co to jest:

**GÅ‚Ã³wna** **rÃ³Å¼nica** miÄ™dzy tÄ… technikÄ… a powszechnym HTTP Request smuggling polega na tym, Å¼e **zamiast** **atakowaÄ‡** **Å¼Ä…danie** **ofiary** **poprzez dodanie prefiksu**, zamierzamy **wyciekowaÄ‡ lub modyfikowaÄ‡ odpowiedÅº, ktÃ³rÄ… otrzymuje ofiara**. Robimy to, zamiast wysyÅ‚aÄ‡ 1,5 Å¼Ä…dania, aby wykorzystaÄ‡ HTTP Request smuggling, **wysyÅ‚amy 2 peÅ‚ne Å¼Ä…dania, aby zdesynchronizowaÄ‡ kolejkÄ™ odpowiedzi proxy**.

Dzieje siÄ™ tak, poniewaÅ¼ bÄ™dziemy w stanie **zdesynchronizowaÄ‡ kolejkÄ™ odpowiedzi**, tak aby **odpowiedÅº** z **legitnego** **Å¼Ä…dania** **ofiary zostaÅ‚a wysÅ‚ana do atakujÄ…cego**, lub poprzez **wstrzykniÄ™cie treÅ›ci kontrolowanej przez atakujÄ…cego w odpowiedzi do ofiary**.

### Desynchronizacja potoku HTTP

HTTP/1.1 pozwala na Å¼Ä…danie **rÃ³Å¼nych zasobÃ³w bez koniecznoÅ›ci czekania na poprzednie**. Dlatego, jeÅ›li w **Å›rodku** znajduje siÄ™ **proxy**, to zadaniem proxy jest **utrzymanie zsynchronizowanego dopasowania wysÅ‚anych Å¼Ä…daÅ„ do backendu i odpowiedzi z niego**.

JednakÅ¼e, istnieje problem z desynchronizacjÄ… kolejki odpowiedzi. JeÅ›li atakujÄ…cy wyÅ›le atak HTTP Response smuggling i odpowiedzi na **poczÄ…tkowe Å¼Ä…danie oraz smuggled one sÄ… natychmiastowo odpowiadane**, odpowiedÅº smuggled nie zostanie wstawiona do kolejki odpowiedzi ofiary, ale **zostanie po prostu odrzucona jako bÅ‚Ä…d**.

![](<../.gitbook/assets/image (633).png>)

Dlatego konieczne jest, aby **smuggled** **Å¼Ä…danie** **zajmowaÅ‚o wiÄ™cej czasu na przetworzenie** w serwerze backendowym. W zwiÄ…zku z tym, w momencie, gdy smuggled Å¼Ä…danie jest przetwarzane, komunikacja z atakujÄ…cym bÄ™dzie zakoÅ„czona.

JeÅ›li w tej konkretnej sytuacji **ofiara wysÅ‚aÅ‚a Å¼Ä…danie** i **smuggled Å¼Ä…danie jest odpowiadane przed** legitnym Å¼Ä…daniem, **odpowiedÅº smuggled zostanie wysÅ‚ana do ofiary**. W zwiÄ…zku z tym atakujÄ…cy bÄ™dzie **kontrolowaÅ‚ Å¼Ä…danie "wykonane" przez ofiarÄ™**.

Co wiÄ™cej, jeÅ›li **atakujÄ…cy nastÄ™pnie wykona Å¼Ä…danie** i **legitna odpowiedÅº** na **Å¼Ä…danie ofiary** jest **odpowiadana** **przed** Å¼Ä…daniem atakujÄ…cego. **OdpowiedÅº dla ofiary zostanie wysÅ‚ana do atakujÄ…cego**, **kradnÄ…c** odpowiedÅº dla ofiary (ktÃ³ra moÅ¼e zawieraÄ‡ na przykÅ‚ad nagÅ‚Ã³wek **Set-Cookie**).

![](<../.gitbook/assets/image (1020).png>)

![](<../.gitbook/assets/image (719).png>)

### Wiele zagnieÅ¼dÅ¼onych wstrzykniÄ™Ä‡

InnÄ… **interesujÄ…cÄ… rÃ³Å¼nicÄ…** w porÃ³wnaniu do powszechnego **HTTP Request Smuggling** jest to, Å¼e w powszechnym ataku smuggling, **celem** jest **zmodyfikowanie poczÄ…tku Å¼Ä…dania ofiary**, aby wykonaÅ‚o nieoczekiwanÄ… akcjÄ™. W **ataku HTTP Response smuggling**, poniewaÅ¼ **wysyÅ‚asz peÅ‚ne Å¼Ä…dania**, moÅ¼esz **wstrzyknÄ…Ä‡ w jednym Å‚adunku dziesiÄ…tki odpowiedzi**, ktÃ³re bÄ™dÄ… **zdesynchronizowaÄ‡ dziesiÄ…tki uÅ¼ytkownikÃ³w**, ktÃ³rzy bÄ™dÄ… **otrzymywaÄ‡** **wstrzykniÄ™te** **odpowiedzi**.

OprÃ³cz moÅ¼liwoÅ›ci **Å‚atwiejszego rozprzestrzenienia dziesiÄ…tek exploitÃ³w** wÅ›rÃ³d legitnych uÅ¼ytkownikÃ³w, moÅ¼e to rÃ³wnieÅ¼ byÄ‡ uÅ¼yte do spowodowania **DoS** na serwerze.

### Organizacja exploitÃ³w

Jak wczeÅ›niej wyjaÅ›niono, aby wykorzystaÄ‡ tÄ™ technikÄ™, konieczne jest, aby **pierwsza smuggled wiadomoÅ›Ä‡** w serwerze **wymagaÅ‚a duÅ¼o czasu na przetworzenie**.

To **czasochÅ‚onne Å¼Ä…danie jest wystarczajÄ…ce**, jeÅ›li chcemy tylko **sprÃ³bowaÄ‡ ukraÅ›Ä‡ odpowiedÅº ofiary**. Ale jeÅ›li chcesz przeprowadziÄ‡ bardziej zÅ‚oÅ¼ony exploit, to bÄ™dzie to wspÃ³lna struktura dla exploita.

Przede wszystkim **poczÄ…tkowe** Å¼Ä…danie wykorzystujÄ…ce **HTTP** **Request** **smuggling**, nastÄ™pnie **czasochÅ‚onne Å¼Ä…danie** i potem **1 lub wiÄ™cej Å¼Ä…daÅ„ Å‚adunkowych**, ktÃ³rych odpowiedzi bÄ™dÄ… wysyÅ‚ane do ofiar.

## Wykorzystywanie desynchronizacji kolejki odpowiedzi HTTP

### Przechwytywanie Å¼Ä…daÅ„ innych uÅ¼ytkownikÃ³w <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Podobnie jak w przypadku znanych Å‚adunkÃ³w HTTP Request Smuggling, moÅ¼esz **ukraÅ›Ä‡ Å¼Ä…danie ofiary** z jednÄ… waÅ¼nÄ… rÃ³Å¼nicÄ…: W tym przypadku potrzebujesz tylko, aby **wysÅ‚ana treÅ›Ä‡ zostaÅ‚a odzwierciedlona w odpowiedzi**, **nie jest potrzebne trwaÅ‚e przechowywanie**.

Najpierw atakujÄ…cy wysyÅ‚a Å‚adunek zawierajÄ…cy **ostateczne Å¼Ä…danie POST z odzwierciedlonym parametrem** na koÅ„cu i duÅ¼ym Content-Length.

![](<../.gitbook/assets/image (1053).png>)

NastÄ™pnie, gdy **poczÄ…tkowe Å¼Ä…danie** (niebieskie) zostaÅ‚o **przetworzone** i **podczas** gdy **Å›piÄ…ce** jest przetwarzane (Å¼Ã³Å‚te), **nastÄ™pne Å¼Ä…danie, ktÃ³re przychodzi od ofiary**, zostanie **dodane do kolejki tuÅ¼ po odzwierciedlonym parametrze**:

![](<../.gitbook/assets/image (794).png>)

NastÄ™pnie **ofiara** otrzyma **odpowiedÅº** na **Å›piÄ…ce** Å¼Ä…danie, a jeÅ›li w miÄ™dzyczasie **atakujÄ…cy** **wysÅ‚aÅ‚** **kolejne** **Å¼Ä…danie**, **odpowiedÅº z Å¼Ä…dania odzwierciedlonej treÅ›ci zostanie mu wysÅ‚ana**.

## Desynchronizacja odpowiedzi

Do tego momentu nauczyliÅ›my siÄ™, jak wykorzystywaÄ‡ ataki HTTP Request Smuggling, aby **kontrolowaÄ‡** **Å¼Ä…danie**, **ktÃ³rego** **odpowiedÅº** **klient** ma **otrzymaÄ‡** i jak moÅ¼na nastÄ™pnie **ukraÅ›Ä‡ odpowiedÅº, ktÃ³ra byÅ‚a przeznaczona dla ofiary**.

Ale nadal moÅ¼liwe jest **jeszcze wiÄ™ksze zdesynchronizowanie** odpowiedzi.

IstniejÄ… interesujÄ…ce Å¼Ä…dania, takie jak **Å¼Ä…danie HEAD**, ktÃ³re sÄ… okreÅ›lone, aby nie miaÅ‚y **Å¼adnej treÅ›ci w ciele odpowiedzi** i ktÃ³re powinny (muszÄ…) **zawieraÄ‡ Content-Length** Å¼Ä…dania, jak **gdyby to byÅ‚o Å¼Ä…danie GET**.

Dlatego, jeÅ›li atakujÄ…cy **wstrzyknie** **Å¼Ä…danie HEAD**, jak na tych obrazkach:

![](<../.gitbook/assets/image (1107).png>)

NastÄ™pnie, **gdy niebieskie zostanie odpowiedziane atakujÄ…cemu**, nastÄ™pne Å¼Ä…danie ofiary zostanie wprowadzone do kolejki:

![](<../.gitbook/assets/image (999).png>)

NastÄ™pnie **ofiara** otrzyma **odpowiedÅº** z **Å¼Ä…dania HEAD**, ktÃ³re **bÄ™dzie zawieraÄ‡ Content-Length, ale Å¼adnej treÅ›ci**. Dlatego proxy **nie wyÅ›le tej odpowiedzi** do ofiary, ale **czeka** na jakÄ…Å› **treÅ›Ä‡**, ktÃ³ra w rzeczywistoÅ›ci bÄ™dzie **odpowiedziÄ… na Å¼Ã³Å‚te Å¼Ä…danie** (rÃ³wnieÅ¼ wstrzykniÄ™te przez atakujÄ…cego):

![](<../.gitbook/assets/image (735).png>)

### Zamieszanie treÅ›ci

PodÄ…Å¼ajÄ…c za poprzednim przykÅ‚adem, wiedzÄ…c, Å¼e moÅ¼esz **kontrolowaÄ‡ ciaÅ‚o** Å¼Ä…dania, ktÃ³rego odpowiedÅº ma otrzymaÄ‡ ofiara i Å¼e **odpowiedÅº HEAD** zazwyczaj zawiera w swoich nagÅ‚Ã³wkach **Content-Type i Content-Length**, moÅ¼esz **wysÅ‚aÄ‡ Å¼Ä…danie jak poniÅ¼sze**, aby **spowodowaÄ‡ XSS** u ofiary, nawet jeÅ›li strona nie jest podatna na XSS:

![](<../.gitbook/assets/image (688).png>)

### Zatrucie pamiÄ™ci podrÄ™cznej

WykorzystujÄ…c wczeÅ›niej omÃ³wionÄ… desynchronizacjÄ™ odpowiedzi ataku Zamieszanie treÅ›ci, **jeÅ›li pamiÄ™Ä‡ podrÄ™czna przechowuje odpowiedÅº na Å¼Ä…danie wykonane przez ofiarÄ™, a ta odpowiedÅº jest wstrzykniÄ™ta, powodujÄ…c XSS, to pamiÄ™Ä‡ podrÄ™czna jest zatruta**.

ZÅ‚oÅ›liwe Å¼Ä…danie zawierajÄ…ce Å‚adunek XSS:

![](<../.gitbook/assets/image (614).png>)

ZÅ‚oÅ›liwa odpowiedÅº dla ofiary, ktÃ³ra zawiera nagÅ‚Ã³wek wskazujÄ…cy pamiÄ™ci podrÄ™cznej, aby przechowaÄ‡ odpowiedÅº:

![](<../.gitbook/assets/image (566).png>)

{% hint style="warning" %}
ZauwaÅ¼, Å¼e w tym przypadku, jeÅ›li **"ofiara" jest atakujÄ…cym**, moÅ¼e teraz przeprowadziÄ‡ **zatrucie pamiÄ™ci podrÄ™cznej w dowolnych adresach URL**, poniewaÅ¼ moÅ¼e **kontrolowaÄ‡ adres URL, ktÃ³ry ma byÄ‡ przechowywany** z zÅ‚oÅ›liwÄ… odpowiedziÄ….
{% endhint %}

### Oszustwo pamiÄ™ci podrÄ™cznej w sieci

Ten atak jest podobny do poprzedniego, ale **zamiast wstrzykiwaÄ‡ Å‚adunek do pamiÄ™ci podrÄ™cznej, atakujÄ…cy bÄ™dzie przechowywaÅ‚ informacje ofiary w pamiÄ™ci podrÄ™cznej:**

![](<../.gitbook/assets/image (991).png>)

### Rozdzielanie odpowiedzi

**Celem** tego ataku jest ponowne wykorzystanie **desynchronizacji** **odpowiedzi**, aby **sprawiÄ‡, Å¼e proxy wyÅ›le 100% odpowiedÅº wygenerowanÄ… przez atakujÄ…cego**.

Aby to osiÄ…gnÄ…Ä‡, atakujÄ…cy musi znaleÅºÄ‡ punkt koÅ„cowy aplikacji webowej, ktÃ³ry **odzwierciedla pewne wartoÅ›ci w odpowiedzi** i **zna dÅ‚ugoÅ›Ä‡ treÅ›ci odpowiedzi HEAD**.

WyÅ›le **exploit** jak:

![](<../.gitbook/assets/image (911).png>)

Po tym, jak pierwsze Å¼Ä…danie zostanie rozwiÄ…zane i odesÅ‚ane do atakujÄ…cego, **Å¼Ä…danie ofiary zostanie dodane do kolejki**:

![](<../.gitbook/assets/image (737).png>)

Ofiara otrzyma jako odpowiedÅº **odpowiedÅº HEAD + treÅ›Ä‡ odpowiedzi drugiego Å¼Ä…dania (zawierajÄ…cÄ… czÄ™Å›Ä‡ odzwierciedlonych danych):**

![](<../.gitbook/assets/image (356).png>)

JednakÅ¼e, zauwaÅ¼, jak **odzwierciedlone dane miaÅ‚y rozmiar zgodny z Content-Length** odpowiedzi **HEAD**, co **wygenerowaÅ‚o waÅ¼nÄ… odpowiedÅº HTTP w kolejce odpowiedzi**.

Dlatego **nastÄ™pne Å¼Ä…danie drugiej ofiary** bÄ™dzie **otrzymywaÄ‡** jako **odpowiedÅº coÅ› caÅ‚kowicie stworzonego przez atakujÄ…cego**. PoniewaÅ¼ odpowiedÅº jest caÅ‚kowicie stworzona przez atakujÄ…cego, moÅ¼e rÃ³wnieÅ¼ **sprawiÄ‡, Å¼e proxy przechowa odpowiedÅº**.

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
