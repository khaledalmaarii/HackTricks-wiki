# OAuth za preuzimanje naloga

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodi캜nu PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Osnovne informacije <a href="#d4a8" id="d4a8"></a>

OAuth nudi razli캜ite verzije, sa osnovnim informacijama dostupnim na [OAuth 2.0 dokumentaciji](https://oauth.net/2/). Ova diskusija se uglavnom fokusira na 코iroko kori코캖eni [OAuth 2.0 tip dozvole autorizacije](https://oauth.net/2/grant-types/authorization-code/), pru쬬ju캖i **okvir za autorizaciju koji omogu캖ava aplikaciji pristup ili izvr코avanje radnji na korisni캜kom nalogu u drugoj aplikaciji** (autorizacioni server).

Pretpostavimo hipoteti캜ki sajt _**https://primer.com**_, dizajniran da **prika쬰 sve va코e postove na dru코tvenim mre쬬ma**, uklju캜uju캖i privatne. Da bi se to postiglo, koristi se OAuth 2.0. _https://primer.com_ 캖e zatra쬴ti va코u dozvolu da **pristupi va코im postovima na dru코tvenim mre쬬ma**. Kao rezultat toga, pojavi캖e se ekran saglasnosti na _https://dru코tvenamre쬬.com_, koji opisuje **dozvole koje se tra쬰 i razvojni programer koji tra쬴 dozvolu**. Nakon va코e autorizacije, _https://primer.com_ dobija mogu캖nost da **pristupi va코im postovima u va코e ime**.

Va쬹o je razumeti slede캖e komponente unutar OAuth 2.0 okvira:

- **vlasnik resursa**: Vi, kao **korisnik/entitet**, autorizujete pristup va코em resursu, poput va코ih postova na dru코tvenim mre쬬ma.
- **server resursa**: Server koji **upravlja autentifikovanim zahtevima** nakon 코to je aplikacija obezbedila `pristupni token` u ime `vlasnika resursa`, npr. **https://dru코tvenamre쬬.com**.
- **klijentska aplikacija**: Aplikacija koja tra쬴 autorizaciju od `vlasnika resursa`, poput **https://primer.com**.
- **autorizacioni server**: Server koji izdaje `pristupne tokene` `klijentskoj aplikaciji` nakon uspe코ne autentifikacije `vlasnika resursa` i obezbe캠ivanja autorizacije, npr. **https://dru코tvenamre쬬.com**.
- **client\_id**: Javni, jedinstveni identifikator aplikacije.
- **client\_secret:** Poverljiv klju캜, poznat samo aplikaciji i autorizacionom serveru, kori코캖en za generisanje `pristupnih tokena`.
- **response\_type**: Vrednost koja specificira **tip tokena koji se zahteva**, poput `koda`.
- **scope**: **Nivo pristupa** koji `klijentska aplikacija` zahteva od `vlasnika resursa`.
- **redirect\_uri**: **URL na koji se korisnik preusmerava nakon autorizacije**. Ovo obi캜no mora biti uskla캠eno sa unapred registrovanim URL-om za preusmeravanje.
- **state**: Parametar za **odr쬬vanje podataka tokom preusmeravanja korisnika ka i od autorizacionog servera**. Njegova jedinstvenost je klju캜na za slu쬰nje kao **mehanizam za코tite od CSRF-a**.
- **grant\_type**: Parametar koji ukazuje **tip dozvole i tip tokena koji 캖e biti vra캖en**.
- **code**: Kod autorizacije od `autorizacionog servera`, kori코캖en zajedno sa `client_id` i `client_secret` od strane klijentske aplikacije za dobijanje `pristupnog tokena`.
- **access\_token**: **Token koji klijentska aplikacija koristi za API zahteve** u ime `vlasnika resursa`.
- **refresh\_token**: Omogu캖ava aplikaciji da **dobije novi `pristupni token` bez ponovnog tra쬰nja od korisnika**.

### Tok

**Stvarni OAuth tok** odvija se na slede캖i na캜in:

1. Idete na [https://primer.com](https://primer.com) i izaberete dugme "Integri코i sa dru코tvenim mre쬬ma".
2. Sajt zatim 코alje zahtev na [https://dru코tvenamre쬬.com](https://dru코tvenamre쬬.com) tra쬰캖i va코u autorizaciju da dozvolite aplikaciji https://primer.com pristup va코im postovima. Zahtev je struktuiran kao:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Zatim vam se prikazuje stranica saglasnosti.

4. Nakon va코eg odobrenja, dru코tveni medijum 코alje odgovor na `redirect_uri` sa parametrima `code` i `state`:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com koristi ovaj `code`, zajedno sa svojim `client_id` i `client_secret`, kako bi napravio serverski zahtev za dobijanje `access_token` u va코e ime, omogu캖avaju캖i pristup dozvolama koje ste odobrili:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Na kraju, proces se zavr코ava kada https://example.com koristi va코 `access_token` da bi napravio API poziv ka dru코tvenim medijima kako bi pristupio

## Ranjivosti <a href="#323a" id="323a"></a>

### Otvoreni redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri` je klju캜an za sigurnost u OAuth i OpenID implementacijama, jer usmerava gde se 코alju osetljivi podaci, poput autorizacionih kodova, nakon autorizacije. Ako nije ispravno konfigurisan, mo쬰 omogu캖iti napada캜ima da preusmere ove zahteve ka zlonamernim serverima, omogu캖avaju캖i preuzimanje naloga.

Tehnike eksploatacije variraju na osnovu logike validacije autorizacionog servera. Mogu se kretati od stroge provere putanje do prihvatanja bilo kog URL-a unutar odre캠ene domene ili poddirektorijuma. 캛este metode eksploatacije uklju캜uju otvorene redirekcije, prolazak kroz putanje, eksploataciju slabe regexe i HTML ubacivanje radi kra캠e tokena.

Pored `redirect_uri`, i drugi OAuth i OpenID parametri poput `client_uri`, `policy_uri`, `tos_uri` i `initiate_login_uri` su podlo쬹i napadima preusmeravanja. Ovi parametri su opcioni i podr코ka za njih varira me캠u serverima.

Za one koji ciljaju OpenID server, endpoint otkri캖a (`**.well-known/openid-configuration**`) 캜esto navodi va쬹e detalje konfiguracije poput `registration_endpoint`, `request_uri_parameter_supported` i "`require_request_uri_registration`. Ovi detalji mogu pomo캖i u identifikaciji endpointa za registraciju i drugih specifi캜nosti konfiguracije servera.

### XSS u implementaciji redirekcije <a href="#bda5" id="bda5"></a>

Kako je navedeno u ovom izve코taju o nagradama za otkrivanje gre코aka [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html) mogu캖e je da se **URL redirekcije odra쬬va u odgovoru** servera nakon 코to korisnik autentifikuje, 코to ga 캜ini **ranjivim na XSS**. Mogu캖i payload za testiranje:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Nepravilno rukovanje stanjem parametra <a href="#bda5" id="bda5"></a>

U implementacijama OAuth-a, zloupotreba ili izostavljanje **`state` parametra** mo쬰 zna캜ajno pove캖ati rizik od napada **Cross-Site Request Forgery (CSRF)**. Ova ranjivost se javlja kada se `state` parametar ili **ne koristi, koristi kao stati캜ka vrednost ili nije pravilno validiran**, omogu캖avaju캖i napada캜ima da zaobi캠u za코titu od CSRF napada.

Napada캜i mogu iskoristiti ovo presretanjem procesa autorizacije kako bi povezali svoj nalog sa rtvinim nalogom, 코to mo쬰 dovesti do potencijalnog **preuzimanja naloga**. Ovo je posebno kriti캜no u aplikacijama gde se OAuth koristi u svrhe **autentikacije**.

Primeri ove ranjivosti su dokumentovani u razli캜itim **CTF izazovima** i **platformama za hakovanje**, isti캜u캖i njene prakti캜ne implikacije. Problem se tako캠e pro코iruje na integracije sa uslugama tre캖ih strana poput **Slack**, **Stripe** i **PayPal**, gde napada캜i mogu preusmeriti obave코tenja ili uplate na svoje naloge.

Pravilno rukovanje i validacija **`state` parametra** su klju캜ni za za코titu od CSRF napada i obezbe캠ivanje sigurnosti OAuth protoka.

### Pre Preuzimanja Naloga <a href="#ebe4" id="ebe4"></a>

1. **Bez Verifikacije Emaila Prilikom Kreiranja Naloga**: Napada캜i mogu preventivno kreirati nalog koriste캖i email rtve. Ako rtva kasnije koristi uslugu tre캖e strane za prijavu, aplikacija mo쬰 nenamerno povezati ovaj nalog tre캖e strane sa prethodno kreiranim nalogom napada캜a, 코to dovodi do neovla코캖enog pristupa.

2. **Iskori코캖avanje Blage Verifikacije Emaila u OAuth-u**: Napada캜i mogu iskoristiti OAuth usluge koje ne verifikuju emaile registracijom na njihovoj usluzi, a zatim promeniti email naloga u email rtve. Ovaj metod tako캠e nosi rizik neovla코캖enog pristupa nalogu, sli캜no kao u prvom scenariju, ali kroz drugi vektor napada.

### Otkrivanje Tajni <a href="#e177" id="e177"></a>

Identifikacija i za코tita tajnih OAuth parametara su klju캜ni. Dok se **`client_id`** mo쬰 bezbedno otkriti, otkrivanje **`client_secret`** predstavlja zna캜ajne rizike. Ako je `client_secret` kompromitovan, napada캜i mogu iskoristiti identitet i poverenje aplikacije da **ukradu korisni캜ke `access_token`-e** i privatne informacije.

캛esta ranjivost se javlja kada aplikacije gre코kom rukuju razmenom autorizacionog `koda` za `access_token` na strani klijenta umesto na serverskoj strani. Ova gre코ka dovodi do izlaganja `client_secret`, omogu캖avaju캖i napada캜ima da generi코u `access_token`-e pod maskom aplikacije. Osim toga, kroz socijalno in쬰njerstvo, napada캜i bi mogli da eskaliraju privilegije dodavanjem dodatnih opsega autorizacije u OAuth autorizaciju, dalje iskori코캖avaju캖i poveren statusa aplikacije.

### Bruteforce Tajnog Klijenta

Mo쬰te poku코ati **bruteforce-ovati tajni_klijent** pru쬬oca usluge sa identitet provajderom kako biste poku코ali da ukradete naloge.\
Zahtev za BF mo쬰 izgledati sli캜no:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header otkriva kod + stanje

Kada klijent dobije **kod i stanje**, ako je **reflektovan unutar Referer zaglavlja** prilikom prelaska na drugu stranicu, onda je ranjiv.

### Pristupni token sa캜uvan u istoriji pretra쬴va캜a

Idite na **istoriju pretra쬴va캜a i proverite da li je pristupni token sa캜uvan tamo**.

### Ve캜ni autorizacioni kod

**Autorizacioni kod bi trebao da 쬴vi samo neko vreme kako bi se ograni캜io prozor vremena u kojem napada캜 mo쬰 da ga ukrade i koristi**.

### Autorizacioni/Osvje쬬vaju캖i token nije vezan za klijenta

Ako mo쬰te dobiti **autorizacioni kod i koristiti ga sa drugim klijentom, onda mo쬰te preuzeti kontrolu nad drugim nalozima**.

### Sre캖ni putovi, XSS, Iframe-ovi & Post poruke za otkrivanje koda & vrednosti stanja

**[Proverite ovaj post](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)**

### AWS Cognito <a href="#bda5" id="bda5"></a>

U ovom izve코taju o otkrivanju gre코aka: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) mo쬰te videti da **token** koji **AWS Cognito** vra캖a korisniku mo쬰 imati **dovoljno dozvola da prepi코e korisni캜ke podatke**. Stoga, ako mo쬰te **promeniti korisni캜ki email za drugi korisni캜ki email**, mo쬯a 캖ete mo캖i **preuzeti** druge naloge.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Za vi코e detalja o tome kako zloupotrebiti AWS Cognito proverite:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Zloupotreba tokena drugih aplikacija <a href="#bda5" id="bda5"></a>

Kao 코to je [**pomenuto u ovom tekstu**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), OAuth protoci koji o캜ekuju da prime **token** (a ne kod) mogu biti ranjivi ako ne provere da li token pripada aplikaciji.

To je zato 코to bi **napada캜** mogao kreirati **aplikaciju koja podr쬬va OAuth i prijaviti se putem Facebook-a** (na primer) u svojoj sopstvenoj aplikaciji. Zatim, kada se rtva prijavi putem Facebook-a u **napada캜evu aplikaciju**, napada캜 bi mogao dobiti **OAuth token korisnika dat njegovoj aplikaciji i koristiti ga za prijavu u OAuth aplikaciju rtve koriste캖i token korisnika rtve**.

{% hint style="danger" %}
Stoga, ako napada캜 uspe da natera korisnika da pristupi svojoj OAuth aplikaciji, bi캖e u mogu캖nosti da preuzme kontrolu nad nalogom rtve u aplikacijama koje o캜ekuju token i ne proveravaju da li je token dodeljen njihovom app ID-u.
{% endhint %}

### Dva linka & kola캜i캖 <a href="#bda5" id="bda5"></a>

Prema [**ovom tekstu**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), bilo je mogu캖e naterati rtvu da otvori stranicu sa **returnUrl** koja vodi ka napada캜evom hostu. Ove informacije bi bile **sa캜uvane u kola캜i캖u (RU)** i u **kasnijem koraku** **prompt** 캖e **pitati** **korisnika** da li 쬰li da dozvoli pristup tom napada캜evom hostu.

Da bi se zaobi코ao ovaj prompt, bilo je mogu캖e otvoriti karticu kako bi se pokrenuo **Oauth protokol** koji bi postavio ovaj RU kola캜i캖 koriste캖i **returnUrl**, zatvoriti karticu pre nego 코to se poka쬰 prompt, i otvoriti novu karticu bez te vrednosti. Tada, **prompt ne캖e obavestiti o napada캜evom hostu**, ali 캖e kola캜i캖 biti postavljen na njega, tako da 캖e **token biti poslat napada캜evom hostu** u preusmeravanju.

### Parametri SSRF-a <a href="#bda5" id="bda5"></a>

**[Proverite ovaj istra쬴va캜ki rad](https://portswigger.net/research/hidden-oauth-attack-vectors) za dalje detalje o ovoj tehnici.**

Dinami캜ka registracija klijenata u OAuth-u slu쬴 kao manje o캜igledan, ali klju캜an vektor za ranjivosti bezbednosti, posebno za **Server-Side Request Forgery (SSRF)** napade. Ovaj endpoint omogu캖ava OAuth serverima da primaju detalje o klijentskim aplikacijama, uklju캜uju캖i osetljive URL-ove koji bi mogli biti iskori코캖eni.

**Klju캜ne ta캜ke:**

- **Dinami캜ka registracija klijenata** 캜esto je mapirana na `/register` i prihvata detalje poput `client_name`, `client_secret`, `redirect_uris`, i URL-ove za logoe ili JSON Web Key Sets (JWKs) putem POST zahteva.
- Ova funkcionalnost se pridr쬬va specifikacija navedenih u **RFC7591** i **OpenID Connect Registration 1.0**, koje uklju캜uju parametre koji su potencijalno ranjivi na SSRF.
- Proces registracije mo쬰 nenamerno izlo쬴ti servere SSRF-u na nekoliko na캜ina:
- **`logo_uri`**: URL za logo klijentske aplikacije koji mo쬰 biti preuzet od strane servera, pokre캖u캖i SSRF ili dovode캖i do XSS-a ako se URL nepravilno obradi.
- **`jwks_uri`**: URL do JWK dokumenta klijenta, koji ako je zlonamerno oblikovan, mo쬰 naterati server da vr코i odlazne zahteve ka serveru pod kontrolom napada캜a.
- **`sector_identifier_uri`**: Referenca na JSON niz `redirect_uris`, koje server mo쬰 preuzeti, stvaraju캖i priliku za SSRF.
- **`request_uris`**: Navodi dozvoljene URI-je zahteva za klijenta, koje mogu biti iskori코캖ene ako server preuzme ove URI-je na po캜etku procesa autorizacije.

**Strategija eksploatacije:**

- SSRF mo쬰 biti pokrenut registracijom novog klijenta sa zlonamernim URL-ovima u parametrima poput `logo_uri`, `jwks_uri`, ili `sector_identifier_uri`.
- Iako direktna eksploatacija putem `request_uris` mo쬰 biti umanjena kontrolama bele liste, obezbe캠ivanje prethodno registrovanog, napada캜em kontrolisanog `request_uri`-ja mo쬰 olak코ati SSRF tokom faze autorizacije.

## Trke uslova pru쬬laca OAuth-a

Ako je platforma koju testirate pru쬬lac OAuth-a [**pro캜itajte ovo da biste testirali mogu캖e trke uslova**](race-condition.md).

## Reference

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)


<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
