# OAuth to Account takeover

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Basic Information <a href="#d4a8" id="d4a8"></a>

OAuth propose plusieurs versions, avec des informations fondamentales accessibles dans la [documentation OAuth 2.0](https://oauth.net/2/). Cette discussion se concentre principalement sur le [type de subvention de code d'autorisation OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/), fournissant un **cadre d'autorisation qui permet √† une application d'acc√©der ou d'effectuer des actions sur le compte d'un utilisateur dans une autre application** (le serveur d'autorisation).

Consid√©rez un site web hypoth√©tique _**https://example.com**_, con√ßu pour **afficher tous vos posts sur les r√©seaux sociaux**, y compris les priv√©s. Pour ce faire, OAuth 2.0 est utilis√©. _https://example.com_ demandera votre permission pour **acc√©der √† vos posts sur les r√©seaux sociaux**. Par cons√©quent, un √©cran de consentement appara√Ætra sur _https://socialmedia.com_, d√©crivant les **permissions demand√©es et le d√©veloppeur faisant la demande**. Apr√®s votre autorisation, _https://example.com_ obtient la capacit√© d'**acc√©der √† vos posts en votre nom**.

Il est essentiel de comprendre les composants suivants dans le cadre OAuth 2.0 :

* **resource owner** : Vous, en tant que **utilisateur/entit√©**, autorisez l'acc√®s √† votre ressource, comme vos posts sur les r√©seaux sociaux.
* **resource server** : Le **serveur g√©rant les demandes authentifi√©es** apr√®s que l'application a s√©curis√© un `access token` au nom du `resource owner`, par exemple, **https://socialmedia.com**.
* **client application** : L'**application demandant l'autorisation** du `resource owner`, comme **https://example.com**.
* **authorization server** : Le **serveur qui √©met des `access tokens`** √† l'`client application` apr√®s l'authentification r√©ussie du `resource owner` et la s√©curisation de l'autorisation, par exemple, **https://socialmedia.com**.
* **client\_id** : Un identifiant public et unique pour l'application.
* **client\_secret:** Une cl√© confidentielle, connue uniquement de l'application et du serveur d'autorisation, utilis√©e pour g√©n√©rer des `access_tokens`.
* **response\_type** : Une valeur sp√©cifiant **le type de token demand√©**, comme `code`.
* **scope** : Le **niveau d'acc√®s** que l'`client application` demande au `resource owner`.
* **redirect\_uri** : L'**URL vers laquelle l'utilisateur est redirig√© apr√®s l'autorisation**. Cela doit g√©n√©ralement correspondre √† l'URL de redirection pr√©enregistr√©e.
* **state** : Un param√®tre pour **maintenir des donn√©es lors de la redirection de l'utilisateur vers et depuis le serveur d'autorisation**. Son unicit√© est cruciale pour servir de **m√©canisme de protection CSRF**.
* **grant\_type** : Un param√®tre indiquant **le type de subvention et le type de token √† retourner**.
* **code** : Le code d'autorisation du `authorization server`, utilis√© en tandem avec `client_id` et `client_secret` par l'application cliente pour acqu√©rir un `access_token`.
* **access\_token** : Le **token que l'application cliente utilise pour les requ√™tes API** au nom du `resource owner`.
* **refresh\_token** : Permet √† l'application de **obtenir un nouveau `access_token` sans redemander √† l'utilisateur**.

### Flow

Le **flux OAuth r√©el** se d√©roule comme suit :

1. Vous naviguez vers [https://example.com](https://example.com) et s√©lectionnez le bouton ‚ÄúInt√©grer avec les r√©seaux sociaux‚Äù.
2. Le site envoie ensuite une demande √† [https://socialmedia.com](https://socialmedia.com) demandant votre autorisation pour permettre √† l'application de https://example.com d'acc√©der √† vos posts. La demande est structur√©e comme :
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Vous √™tes ensuite pr√©sent√© avec une page de consentement.  
4. Suite √† votre approbation, les r√©seaux sociaux envoient une r√©ponse √† l'`redirect_uri` avec les param√®tres `code` et `state` :
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com utilise ce `code`, avec son `client_id` et `client_secret`, pour effectuer une requ√™te c√¥t√© serveur afin d'obtenir un `access_token` en votre nom, permettant l'acc√®s aux autorisations auxquelles vous avez consenti :
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Enfin, le processus se termine lorsque https://example.com utilise votre `access_token` pour effectuer un appel API √† Social Media pour acc√©der

## Vuln√©rabilit√©s <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

Le `redirect_uri` est crucial pour la s√©curit√© dans les impl√©mentations OAuth et OpenID, car il dirige o√π les donn√©es sensibles, comme les codes d'autorisation, sont envoy√©es apr√®s l'autorisation. S'il est mal configur√©, cela pourrait permettre aux attaquants de rediriger ces demandes vers des serveurs malveillants, permettant ainsi la prise de contr√¥le de compte.

Les techniques d'exploitation varient en fonction de la logique de validation du serveur d'autorisation. Elles peuvent aller d'une correspondance stricte des chemins √† l'acceptation de n'importe quelle URL dans le domaine ou le sous-r√©pertoire sp√©cifi√©. Les m√©thodes d'exploitation courantes incluent les redirections ouvertes, le parcours de chemin, l'exploitation de regex faibles et l'injection HTML pour le vol de jetons.

En plus de `redirect_uri`, d'autres param√®tres OAuth et OpenID comme `client_uri`, `policy_uri`, `tos_uri` et `initiate_login_uri` sont √©galement susceptibles aux attaques de redirection. Ces param√®tres sont optionnels et leur support varie selon les serveurs.

Pour ceux qui ciblent un serveur OpenID, le point de d√©couverte (`**.well-known/openid-configuration**`) liste souvent des d√©tails de configuration pr√©cieux comme `registration_endpoint`, `request_uri_parameter_supported`, et "`require_request_uri_registration`. Ces d√©tails peuvent aider √† identifier le point de terminaison d'enregistrement et d'autres sp√©cificit√©s de configuration du serveur.

### XSS dans l'impl√©mentation de redirection <a href="#bda5" id="bda5"></a>

Comme mentionn√© dans ce rapport de bug bounty [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), il pourrait √™tre possible que l'**URL de redirection soit refl√©t√©e dans la r√©ponse** du serveur apr√®s que l'utilisateur s'authentifie, √©tant **vuln√©rable √† XSS**. Charge utile possible √† tester :
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Mauvaise gestion du param√®tre d'√©tat <a href="#bda5" id="bda5"></a>

Dans les impl√©mentations OAuth, l'utilisation abusive ou l'omission du **`state` parameter** peut consid√©rablement augmenter le risque d'attaques de **Cross-Site Request Forgery (CSRF)**. Cette vuln√©rabilit√© survient lorsque le param√®tre `state` est soit **non utilis√©, utilis√© comme une valeur statique, ou mal valid√©**, permettant aux attaquants de contourner les protections CSRF.

Les attaquants peuvent exploiter cela en interceptant le processus d'autorisation pour lier leur compte √† celui d'une victime, ce qui peut entra√Æner des **prises de contr√¥le de compte** potentielles. Cela est particuli√®rement critique dans les applications o√π OAuth est utilis√© √† des fins **d'authentification**.

Des exemples concrets de cette vuln√©rabilit√© ont √©t√© document√©s dans divers **d√©fis CTF** et **plateformes de hacking**, mettant en √©vidence ses implications pratiques. Le probl√®me s'√©tend √©galement aux int√©grations avec des services tiers comme **Slack**, **Stripe**, et **PayPal**, o√π les attaquants peuvent rediriger des notifications ou des paiements vers leurs comptes.

Une gestion et une validation appropri√©es du **`state` parameter** sont cruciales pour se prot√©ger contre le CSRF et s√©curiser le flux OAuth.

### Pr√© Prise de Contr√¥le de Compte <a href="#ebe4" id="ebe4"></a>

1. **Sans V√©rification d'Email lors de la Cr√©ation de Compte** : Les attaquants peuvent cr√©er pr√©ventivement un compte en utilisant l'email de la victime. Si la victime utilise ensuite un service tiers pour se connecter, l'application pourrait involontairement lier ce compte tiers au compte pr√©-cr√©√© de l'attaquant, entra√Ænant un acc√®s non autoris√©.
2. **Exploitation d'une V√©rification d'Email OAuth Laxiste** : Les attaquants peuvent exploiter des services OAuth qui ne v√©rifient pas les emails en s'inscrivant √† leur service puis en changeant l'email du compte pour celui de la victime. Cette m√©thode pr√©sente √©galement un risque d'acc√®s non autoris√© au compte, semblable au premier sc√©nario mais par un vecteur d'attaque diff√©rent.

### Divulgation de Secrets <a href="#e177" id="e177"></a>

Identifier et prot√©ger les param√®tres secrets OAuth est crucial. Bien que le **`client_id`** puisse √™tre divulgu√© en toute s√©curit√©, r√©v√©ler le **`client_secret`** pose des risques significatifs. Si le `client_secret` est compromis, les attaquants peuvent exploiter l'identit√© et la confiance de l'application pour **voler des `access_tokens` d'utilisateur** et des informations priv√©es.

Une vuln√©rabilit√© courante survient lorsque les applications g√®rent par erreur l'√©change du `code` d'autorisation contre un `access_token` c√¥t√© client plut√¥t que c√¥t√© serveur. Cette erreur conduit √† l'exposition du `client_secret`, permettant aux attaquants de g√©n√©rer des `access_tokens` sous le couvert de l'application. De plus, par le biais d'ing√©nierie sociale, les attaquants pourraient √©lever leurs privil√®ges en ajoutant des scopes suppl√©mentaires √† l'autorisation OAuth, exploitant davantage le statut de confiance de l'application.

### Bruteforce du Secret Client

Vous pouvez essayer de **bruteforcer le client\_secret** d'un fournisseur de services avec le fournisseur d'identit√© afin d'essayer de voler des comptes.\
La requ√™te pour le BF peut ressembler √† :
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### En-t√™te Referer fuyant le Code + √âtat

Une fois que le client a le **code et l'√©tat**, s'ils sont **r√©fl√©chis dans l'en-t√™te Referer** lorsqu'il navigue vers une autre page, alors il est vuln√©rable.

### Jeton d'Acc√®s Stock√© dans l'Historique du Navigateur

Allez dans **l'historique du navigateur et v√©rifiez si le jeton d'acc√®s y est enregistr√©**.

### Code d'Autorisation √âternel

Le **code d'autorisation ne devrait vivre que pendant un certain temps pour limiter la fen√™tre temporelle o√π un attaquant peut le voler et l'utiliser**.

### Jeton d'Autorisation/Rafra√Æchissement non li√© au client

Si vous pouvez obtenir le **code d'autorisation et l'utiliser avec un client diff√©rent, alors vous pouvez prendre le contr√¥le d'autres comptes**.

### Chemins Heureux, XSS, Iframes & Messages Post pour fuir les valeurs de code & d'√©tat

[**V√©rifiez ce post**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

Dans ce rapport de bug bounty : [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) vous pouvez voir que le **jeton** que **AWS Cognito** renvoie √† l'utilisateur pourrait avoir **suffisamment de permissions pour √©craser les donn√©es de l'utilisateur**. Par cons√©quent, si vous pouvez **changer l'email de l'utilisateur pour un autre email d'utilisateur**, vous pourriez √™tre en mesure de **prendre le contr√¥le** d'autres comptes.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Pour plus d'informations d√©taill√©es sur la fa√ßon d'abuser d'AWS cognito, consultez :

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abuser des tokens d'autres applications <a href="#bda5" id="bda5"></a>

Comme [**mentionn√© dans cet article**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), les flux OAuth qui s'attendent √† recevoir le **token** (et non un code) pourraient √™tre vuln√©rables s'ils ne v√©rifient pas que le token appartient √† l'application.

Ceci est d√ª au fait qu'un **attaquant** pourrait cr√©er une **application supportant OAuth et se connecter avec Facebook** (par exemple) dans sa propre application. Ensuite, une fois qu'une victime se connecte avec Facebook dans l'**application de l'attaquant**, l'attaquant pourrait obtenir le **token OAuth de l'utilisateur donn√© √† son application, et l'utiliser pour se connecter dans l'application OAuth de la victime en utilisant le token utilisateur de la victime**.

{% hint style="danger" %}
Par cons√©quent, si l'attaquant parvient √† faire acc√©der l'utilisateur √† sa propre application OAuth, il sera en mesure de prendre le contr√¥le du compte de la victime dans les applications qui s'attendent √† un token et ne v√©rifient pas si le token a √©t√© accord√© √† leur ID d'application.
{% endhint %}

### Deux liens & cookie <a href="#bda5" id="bda5"></a>

Selon [**cet article**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), il √©tait possible de faire ouvrir √† une victime une page avec un **returnUrl** pointant vers l'h√¥te de l'attaquant. Cette info serait **stock√©e dans un cookie (RU)** et √† une **√©tape ult√©rieure**, le **prompt** demandera √† l'**utilisateur** s'il souhaite donner acc√®s √† cet h√¥te de l'attaquant.

Pour contourner ce prompt, il √©tait possible d'ouvrir un onglet pour initier le **flux Oauth** qui d√©finirait ce cookie RU en utilisant le **returnUrl**, de fermer l'onglet avant que le prompt ne soit affich√©, et d'ouvrir un nouvel onglet sans cette valeur. Ensuite, le **prompt n'informera pas sur l'h√¥te de l'attaquant**, mais le cookie serait d√©fini pour cela, donc le **token sera envoy√© √† l'h√¥te de l'attaquant** lors de la redirection.

### Contournement de l'interaction du prompt <a href="#bda5" id="bda5"></a>

Comme expliqu√© dans [**cette vid√©o**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), certaines impl√©mentations OAuth permettent d'indiquer le param√®tre **`prompt`** GET comme None (**`&prompt=none`**) pour **emp√™cher les utilisateurs d'√™tre invit√©s √† confirmer** l'acc√®s donn√© dans un prompt sur le web s'ils sont d√©j√† connect√©s √† la plateforme.

### response\_mode

Comme [**expliqu√© dans cette vid√©o**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), il pourrait √™tre possible d'indiquer le param√®tre **`response_mode`** pour indiquer o√π vous souhaitez que le code soit fourni dans l'URL finale :

* `response_mode=query` -> Le code est fourni √† l'int√©rieur d'un param√®tre GET : `?code=2397rf3gu93f`
* `response_mode=fragment` -> Le code est fourni √† l'int√©rieur du param√®tre de fragment d'URL `#code=2397rf3gu93f`
* `response_mode=form_post` -> Le code est fourni √† l'int√©rieur d'un formulaire POST avec un input appel√© `code` et la valeur
* `response_mode=web_message` -> Le code est envoy√© dans un message post : `window.opener.postMessage({"code": "asdasdasd...`

### Param√®tres SSRFs <a href="#bda5" id="bda5"></a>

[**Consultez cette recherche**](https://portswigger.net/research/hidden-oauth-attack-vectors) **Pour plus de d√©tails sur cette technique.**

L'enregistrement dynamique de clients dans OAuth sert de vecteur moins √©vident mais critique pour les vuln√©rabilit√©s de s√©curit√©, sp√©cifiquement pour les attaques de **Server-Side Request Forgery (SSRF)**. Ce point de terminaison permet aux serveurs OAuth de recevoir des d√©tails sur les applications clientes, y compris des URL sensibles qui pourraient √™tre exploit√©es.

**Points cl√©s :**

* **L'enregistrement dynamique de clients** est souvent mapp√© √† `/register` et accepte des d√©tails comme `client_name`, `client_secret`, `redirect_uris`, et des URL pour des logos ou des ensembles de cl√©s JSON Web (JWKs) via des requ√™tes POST.
* Cette fonctionnalit√© respecte les sp√©cifications √©nonc√©es dans **RFC7591** et **OpenID Connect Registration 1.0**, qui incluent des param√®tres potentiellement vuln√©rables aux SSRF.
* Le processus d'enregistrement peut involontairement exposer les serveurs aux SSRF de plusieurs mani√®res :
* **`logo_uri`** : Une URL pour le logo de l'application cliente qui pourrait √™tre r√©cup√©r√©e par le serveur, d√©clenchant un SSRF ou menant √† un XSS si l'URL est mal g√©r√©e.
* **`jwks_uri`** : Une URL vers le document JWK du client, qui si elle est malicieusement con√ßue, peut amener le serveur √† effectuer des requ√™tes sortantes vers un serveur contr√¥l√© par un attaquant.
* **`sector_identifier_uri`** : Fait r√©f√©rence √† un tableau JSON de `redirect_uris`, que le serveur pourrait r√©cup√©rer, cr√©ant une opportunit√© de SSRF.
* **`request_uris`** : √ânum√®re les URI de requ√™te autoris√©es pour le client, qui peuvent √™tre exploit√©es si le serveur r√©cup√®re ces URI au d√©but du processus d'autorisation.

**Strat√©gie d'exploitation :**

* Le SSRF peut √™tre d√©clench√© en enregistrant un nouveau client avec des URL malveillantes dans des param√®tres comme `logo_uri`, `jwks_uri`, ou `sector_identifier_uri`.
* Bien que l'exploitation directe via `request_uris` puisse √™tre att√©nu√©e par des contr√¥les de liste blanche, fournir un `request_uri` pr√©enregistr√© et contr√¥l√© par un attaquant peut faciliter le SSRF pendant la phase d'autorisation.

## Conditions de course des fournisseurs OAuth

Si la plateforme que vous testez est un fournisseur OAuth [**lisez ceci pour tester les √©ventuelles conditions de course**](race-condition.md).

## R√©f√©rences

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}
