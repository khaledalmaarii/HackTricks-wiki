# OAuth para Tomada de Conta

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Informa√ß√µes B√°sicas <a href="#d4a8" id="d4a8"></a>

OAuth oferece v√°rias vers√µes, com insights fundamentais acess√≠veis na [documenta√ß√£o do OAuth 2.0](https://oauth.net/2/). Esta discuss√£o centra-se principalmente no amplamente utilizado [tipo de concess√£o de c√≥digo de autoriza√ß√£o do OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/), fornecendo um **quadro de autoriza√ß√£o que permite que um aplicativo acesse ou execute a√ß√µes na conta de um usu√°rio em outro aplicativo** (o servidor de autoriza√ß√£o).

Considere um site hipot√©tico _**https://example.com**_, projetado para **exibir todas as suas postagens em redes sociais**, incluindo as privadas. Para alcan√ßar isso, o OAuth 2.0 √© empregado. _https://example.com_ solicitar√° sua permiss√£o para **acessar suas postagens em redes sociais**. Consequentemente, uma tela de consentimento aparecer√° em _https://socialmedia.com_, delineando as **permiss√µes solicitadas e o desenvolvedor que faz a solicita√ß√£o**. Ap√≥s sua autoriza√ß√£o, _https://example.com_ ganha a capacidade de **acessar suas postagens em seu nome**.

√â essencial compreender os seguintes componentes dentro do quadro do OAuth 2.0:

* **propriet√°rio do recurso**: Voc√™, como o **usu√°rio/entidade**, autoriza o acesso ao seu recurso, como suas postagens em redes sociais.
* **servidor de recursos**: O **servidor que gerencia solicita√ß√µes autenticadas** ap√≥s o aplicativo ter obtido um `access token` em nome do `propriet√°rio do recurso`, por exemplo, **https://socialmedia.com**.
* **aplicativo cliente**: O **aplicativo que busca autoriza√ß√£o** do `propriet√°rio do recurso`, como **https://example.com**.
* **servidor de autoriza√ß√£o**: O **servidor que emite `access tokens`** para o `aplicativo cliente` ap√≥s a autentica√ß√£o bem-sucedida do `propriet√°rio do recurso` e a obten√ß√£o de autoriza√ß√£o, por exemplo, **https://socialmedia.com**.
* **client\_id**: Um identificador p√∫blico e √∫nico para o aplicativo.
* **client\_secret:** Uma chave confidencial, conhecida apenas pelo aplicativo e pelo servidor de autoriza√ß√£o, usada para gerar `access_tokens`.
* **response\_type**: Um valor que especifica **o tipo de token solicitado**, como `code`.
* **scope**: O **n√≠vel de acesso** que o `aplicativo cliente` est√° solicitando do `propriet√°rio do recurso`.
* **redirect\_uri**: A **URL para a qual o usu√°rio √© redirecionado ap√≥s a autoriza√ß√£o**. Isso geralmente deve estar alinhado com a URL de redirecionamento pr√©-registrada.
* **state**: Um par√¢metro para **manter dados durante a redire√ß√£o do usu√°rio para e do servidor de autoriza√ß√£o**. Sua singularidade √© cr√≠tica para servir como um **mecanismo de prote√ß√£o CSRF**.
* **grant\_type**: Um par√¢metro que indica **o tipo de concess√£o e o tipo de token a ser retornado**.
* **code**: O c√≥digo de autoriza√ß√£o do `servidor de autoriza√ß√£o`, usado em conjunto com `client_id` e `client_secret` pelo aplicativo cliente para adquirir um `access_token`.
* **access\_token**: O **token que o aplicativo cliente usa para solicita√ß√µes de API** em nome do `propriet√°rio do recurso`.
* **refresh\_token**: Permite que o aplicativo **obtenha um novo `access_token` sem solicitar novamente ao usu√°rio**.

### Fluxo

O **fluxo real do OAuth** prossegue da seguinte forma:

1. Voc√™ navega at√© [https://example.com](https://example.com) e seleciona o bot√£o ‚ÄúIntegrar com Redes Sociais‚Äù.
2. O site ent√£o envia uma solicita√ß√£o para [https://socialmedia.com](https://socialmedia.com) pedindo sua autoriza√ß√£o para permitir que o aplicativo de https://example.com acesse suas postagens. A solicita√ß√£o √© estruturada como:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Voc√™ √© ent√£o apresentado a uma p√°gina de consentimento.  
4. Ap√≥s sua aprova√ß√£o, a Rede Social envia uma resposta para o `redirect_uri` com os par√¢metros `code` e `state`:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com utiliza este `code`, juntamente com seu `client_id` e `client_secret`, para fazer uma solicita√ß√£o do lado do servidor para obter um `access_token` em seu nome, permitindo o acesso √†s permiss√µes que voc√™ consentiu:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Finalmente, o processo conclui-se quando https://example.com utiliza seu `access_token` para fazer uma chamada de API para a M√≠dia Social para acessar

## Vulnerabilidades <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

O `redirect_uri` √© crucial para a seguran√ßa em implementa√ß√µes de OAuth e OpenID, pois direciona para onde dados sens√≠veis, como c√≥digos de autoriza√ß√£o, s√£o enviados ap√≥s a autoriza√ß√£o. Se mal configurado, pode permitir que atacantes redirecionem essas solicita√ß√µes para servidores maliciosos, possibilitando a tomada de conta.

As t√©cnicas de explora√ß√£o variam com base na l√≥gica de valida√ß√£o do servidor de autoriza√ß√£o. Elas podem variar desde correspond√™ncia estrita de caminho at√© aceitar qualquer URL dentro do dom√≠nio ou subdiret√≥rio especificado. M√©todos comuns de explora√ß√£o incluem redirecionamentos abertos, travessia de caminho, explora√ß√£o de regex fracas e inje√ß√£o de HTML para roubo de token.

Al√©m do `redirect_uri`, outros par√¢metros de OAuth e OpenID, como `client_uri`, `policy_uri`, `tos_uri` e `initiate_login_uri`, tamb√©m s√£o suscet√≠veis a ataques de redirecionamento. Esses par√¢metros s√£o opcionais e seu suporte varia entre os servidores.

Para aqueles que visam um servidor OpenID, o endpoint de descoberta (`**.well-known/openid-configuration**`) frequentemente lista detalhes de configura√ß√£o valiosos, como `registration_endpoint`, `request_uri_parameter_supported` e "`require_request_uri_registration`. Esses detalhes podem ajudar a identificar o endpoint de registro e outras especificidades de configura√ß√£o do servidor.

### XSS na implementa√ß√£o de redirecionamento <a href="#bda5" id="bda5"></a>

Como mencionado neste relat√≥rio de bug bounty [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), pode ser poss√≠vel que a **URL de redirecionamento esteja sendo refletida na resposta** do servidor ap√≥s o usu√°rio se autenticar, sendo **vulner√°vel a XSS**. Payload poss√≠vel para testar:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Manipula√ß√£o inadequada do par√¢metro de estado <a href="#bda5" id="bda5"></a>

Em implementa√ß√µes de OAuth, o uso indevido ou a omiss√£o do **`state` parameter** pode aumentar significativamente o risco de ataques de **Cross-Site Request Forgery (CSRF)**. Essa vulnerabilidade surge quando o par√¢metro `state` √© **n√£o utilizado, utilizado como um valor est√°tico ou n√£o validado corretamente**, permitindo que atacantes contornem as prote√ß√µes contra CSRF.

Os atacantes podem explorar isso interceptando o processo de autoriza√ß√£o para vincular sua conta √† conta de uma v√≠tima, levando a poss√≠veis **account takeovers**. Isso √© especialmente cr√≠tico em aplica√ß√µes onde o OAuth √© usado para **fins de autentica√ß√£o**.

Exemplos do mundo real dessa vulnerabilidade foram documentados em v√°rios **CTF challenges** e **hacking platforms**, destacando suas implica√ß√µes pr√°ticas. O problema tamb√©m se estende a integra√ß√µes com servi√ßos de terceiros como **Slack**, **Stripe** e **PayPal**, onde os atacantes podem redirecionar notifica√ß√µes ou pagamentos para suas contas.

O manuseio e a valida√ß√£o adequados do **`state` parameter** s√£o cruciais para proteger contra CSRF e garantir o fluxo do OAuth.

### Pre Account Takeover <a href="#ebe4" id="ebe4"></a>

1. **Sem Verifica√ß√£o de Email na Cria√ß√£o da Conta**: Os atacantes podem criar proativamente uma conta usando o email da v√≠tima. Se a v√≠tima usar posteriormente um servi√ßo de terceiros para login, a aplica√ß√£o pode inadvertidamente vincular essa conta de terceiros √† conta pr√©-criada do atacante, levando ao acesso n√£o autorizado.
2. **Explorando a Verifica√ß√£o de Email Lax do OAuth**: Os atacantes podem explorar servi√ßos de OAuth que n√£o verificam emails registrando-se com seu servi√ßo e, em seguida, alterando o email da conta para o da v√≠tima. Esse m√©todo tamb√©m arrisca o acesso n√£o autorizado √† conta, semelhante ao primeiro cen√°rio, mas atrav√©s de um vetor de ataque diferente.

### Divulga√ß√£o de Segredos <a href="#e177" id="e177"></a>

Identificar e proteger par√¢metros secretos do OAuth √© crucial. Enquanto o **`client_id`** pode ser divulgado com seguran√ßa, revelar o **`client_secret`** apresenta riscos significativos. Se o `client_secret` for comprometido, os atacantes podem explorar a identidade e a confian√ßa da aplica√ß√£o para **roubar `access_tokens` de usu√°rios** e informa√ß√µes privadas.

Uma vulnerabilidade comum surge quando as aplica√ß√µes manipulam erroneamente a troca do `code` de autoriza√ß√£o por um `access_token` no lado do cliente em vez do lado do servidor. Esse erro leva √† exposi√ß√£o do `client_secret`, permitindo que os atacantes gerem `access_tokens` sob a apar√™ncia da aplica√ß√£o. Al√©m disso, por meio de engenharia social, os atacantes poderiam escalar privil√©gios adicionando escopos adicionais √† autoriza√ß√£o do OAuth, explorando ainda mais o status de confian√ßa da aplica√ß√£o.

### Client Secret Bruteforce

Voc√™ pode tentar **bruteforce o client\_secret** de um provedor de servi√ßos com o provedor de identidade para tentar roubar contas.\
A solicita√ß√£o para BF pode parecer semelhante a:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header leaking Code + State

Uma vez que o cliente tenha o **code and state**, se estiver **refletido dentro do cabe√ßalho Referer** quando ele navega para uma p√°gina diferente, ent√£o est√° vulner√°vel.

### Access Token Stored in Browser History

V√° para o **hist√≥rico do navegador e verifique se o access token est√° salvo l√°**.

### Everlasting Authorization Code

O **authorization code deve viver apenas por algum tempo para limitar a janela de tempo onde um atacante pode roub√°-lo e us√°-lo**.

### Authorization/Refresh Token not bound to client

Se voc√™ conseguir obter o **authorization code e us√°-lo com um cliente diferente, ent√£o voc√™ pode assumir outras contas**.

### Happy Paths, XSS, Iframes & Post Messages to leak code & state values

[**Check this post**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

Neste relat√≥rio de bug bounty: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) voc√™ pode ver que o **token** que **AWS Cognito** devolve ao usu√°rio pode ter **permiss√µes suficientes para sobrescrever os dados do usu√°rio**. Portanto, se voc√™ puder **mudar o email do usu√°rio para um email de usu√°rio diferente**, pode ser capaz de **assumir** outras contas.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Para mais informa√ß√µes detalhadas sobre como abusar do AWS cognito, consulte:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abusando de tokens de outros aplicativos <a href="#bda5" id="bda5"></a>

Como [**mencionado neste artigo**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), fluxos de OAuth que esperam receber o **token** (e n√£o um c√≥digo) podem ser vulner√°veis se n√£o verificarem se o token pertence ao aplicativo.

Isso ocorre porque um **atacante** poderia criar um **aplicativo que suporta OAuth e login com Facebook** (por exemplo) em seu pr√≥prio aplicativo. Ent√£o, uma vez que uma v√≠tima fa√ßa login com Facebook no **aplicativo do atacante**, o atacante poderia obter o **token OAuth do usu√°rio dado ao seu aplicativo e us√°-lo para fazer login no aplicativo OAuth da v√≠tima usando o token do usu√°rio da v√≠tima**.

{% hint style="danger" %}
Portanto, se o atacante conseguir fazer com que o usu√°rio acesse seu pr√≥prio aplicativo OAuth, ele poder√° assumir a conta da v√≠tima em aplicativos que esperam um token e n√£o est√£o verificando se o token foi concedido ao ID do seu aplicativo.
{% endhint %}

### Dois links & cookie <a href="#bda5" id="bda5"></a>

De acordo com [**este artigo**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), era poss√≠vel fazer com que uma v√≠tima abrisse uma p√°gina com um **returnUrl** apontando para o host do atacante. Essa informa√ß√£o seria **armazenada em um cookie (RU)** e em um **passo posterior** o **prompt** **perguntaria** ao **usu√°rio** se ele deseja conceder acesso a esse host do atacante.

Para contornar esse prompt, era poss√≠vel abrir uma aba para iniciar o **fluxo OAuth** que configuraria esse cookie RU usando o **returnUrl**, fechar a aba antes que o prompt fosse exibido e abrir uma nova aba sem esse valor. Assim, o **prompt n√£o informar√° sobre o host do atacante**, mas o cookie seria configurado para ele, ent√£o o **token ser√° enviado para o host do atacante** na redire√ß√£o.

### Bypass de Intera√ß√£o do Prompt <a href="#bda5" id="bda5"></a>

Como explicado em [**este v√≠deo**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), algumas implementa√ß√µes de OAuth permitem indicar o par√¢metro **`prompt`** GET como None (**`&prompt=none`**) para **evitar que os usu√°rios sejam solicitados a confirmar** o acesso concedido em um prompt na web se j√° estiverem logados na plataforma.

### response\_mode

Como [**explicado neste v√≠deo**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), pode ser poss√≠vel indicar o par√¢metro **`response_mode`** para indicar onde voc√™ deseja que o c√≥digo seja fornecido na URL final:

* `response_mode=query` -> O c√≥digo √© fornecido dentro de um par√¢metro GET: `?code=2397rf3gu93f`
* `response_mode=fragment` -> O c√≥digo √© fornecido dentro do par√¢metro de fragmento da URL `#code=2397rf3gu93f`
* `response_mode=form_post` -> O c√≥digo √© fornecido dentro de um formul√°rio POST com um input chamado `code` e o valor
* `response_mode=web_message` -> O c√≥digo √© enviado em uma mensagem post: `window.opener.postMessage({"code": "asdasdasd...`

### Par√¢metros SSRFs <a href="#bda5" id="bda5"></a>

[**Verifique esta pesquisa**](https://portswigger.net/research/hidden-oauth-attack-vectors) **Para mais detalhes sobre esta t√©cnica.**

O Registro Din√¢mico de Clientes em OAuth serve como um vetor menos √≥bvio, mas cr√≠tico, para vulnerabilidades de seguran√ßa, especificamente para ataques de **Server-Side Request Forgery (SSRF)**. Este endpoint permite que servidores OAuth recebam detalhes sobre aplicativos clientes, incluindo URLs sens√≠veis que podem ser exploradas.

**Pontos Chave:**

* **Registro Din√¢mico de Clientes** √© frequentemente mapeado para `/register` e aceita detalhes como `client_name`, `client_secret`, `redirect_uris` e URLs para logotipos ou Conjuntos de Chaves Web JSON (JWKs) via requisi√ß√µes POST.
* Este recurso adere √†s especifica√ß√µes estabelecidas em **RFC7591** e **OpenID Connect Registration 1.0**, que incluem par√¢metros potencialmente vulner√°veis a SSRF.
* O processo de registro pode inadvertidamente expor servidores a SSRF de v√°rias maneiras:
* **`logo_uri`**: Uma URL para o logotipo do aplicativo cliente que pode ser buscada pelo servidor, acionando SSRF ou levando a XSS se a URL for mal manipulada.
* **`jwks_uri`**: Uma URL para o documento JWK do cliente, que se for maliciosamente elaborado, pode fazer com que o servidor fa√ßa requisi√ß√µes externas para um servidor controlado pelo atacante.
* **`sector_identifier_uri`**: Referencia um array JSON de `redirect_uris`, que o servidor pode buscar, criando uma oportunidade de SSRF.
* **`request_uris`**: Lista as URIs de solicita√ß√£o permitidas para o cliente, que podem ser exploradas se o servidor buscar essas URIs no in√≠cio do processo de autoriza√ß√£o.

**Estrat√©gia de Explora√ß√£o:**

* SSRF pode ser acionado registrando um novo cliente com URLs maliciosas em par√¢metros como `logo_uri`, `jwks_uri` ou `sector_identifier_uri`.
* Embora a explora√ß√£o direta via `request_uris` possa ser mitigada por controles de lista branca, fornecer um `request_uri` pr√©-registrado e controlado pelo atacante pode facilitar SSRF durante a fase de autoriza√ß√£o.

## Condi√ß√µes de Corrida dos provedores OAuth

Se a plataforma que voc√™ est√° testando √© um provedor OAuth [**leia isso para testar poss√≠veis Condi√ß√µes de Corrida**](race-condition.md).

## Refer√™ncias

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
