# OAuth to Account takeover

<details>

<summary><strong>NauÄite AWS hakovanje od poÄetnika do eksperta sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini da podrÅ¾ite HackTricks:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**PRETPLATNIÄŒKE PLANOVE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFTs**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove podnoÅ¡enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Osnovne Informacije <a href="#d4a8" id="d4a8"></a>

OAuth nudi razliÄite verzije, sa osnovnim uvidima dostupnim na [OAuth 2.0 dokumentaciji](https://oauth.net/2/). Ova diskusija se prvenstveno fokusira na Å¡iroko koriÅ¡Ä‡eni [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/), pruÅ¾ajuÄ‡i **okvir za autorizaciju koji omoguÄ‡ava aplikaciji da pristupi ili izvrÅ¡i radnje na korisniÄkom nalogu u drugoj aplikaciji** (server za autorizaciju).

Razmotrite hipotetiÄki sajt _**https://example.com**_, dizajniran da **prikaÅ¾e sve vaÅ¡e objave na druÅ¡tvenim mreÅ¾ama**, ukljuÄujuÄ‡i privatne. Da bi to postigao, koristi se OAuth 2.0. _https://example.com_ Ä‡e zatraÅ¾iti vaÅ¡u dozvolu da **pristupi vaÅ¡im objavama na druÅ¡tvenim mreÅ¾ama**. Kao rezultat toga, pojaviÄ‡e se ekran za saglasnost na _https://socialmedia.com_, navodeÄ‡i **dozvole koje se traÅ¾e i programera koji podnosi zahtev**. Nakon vaÅ¡e autorizacije, _https://example.com_ dobija moguÄ‡nost da **pristupi vaÅ¡im objavama u vaÅ¡e ime**.

VaÅ¾no je razumeti sledeÄ‡e komponente u okviru OAuth 2.0:

* **resource owner**: Vi, kao **korisnik/entitet**, dajete dozvolu za pristup vaÅ¡em resursu, kao Å¡to su vaÅ¡e objave na druÅ¡tvenim mreÅ¾ama.
* **resource server**: **Server koji upravlja autentifikovanim zahtevima** nakon Å¡to aplikacija dobije `access token` u ime `resource owner`, npr. **https://socialmedia.com**.
* **client application**: **Aplikacija koja traÅ¾i autorizaciju** od `resource owner`, kao Å¡to je **https://example.com**.
* **authorization server**: **Server koji izdaje `access tokens`** `client application` nakon uspeÅ¡ne autentifikacije `resource owner` i dobijanja autorizacije, npr. **https://socialmedia.com**.
* **client\_id**: Javni, jedinstveni identifikator za aplikaciju.
* **client\_secret:** Tajni kljuÄ, poznat samo aplikaciji i serveru za autorizaciju, koriÅ¡Ä‡en za generisanje `access_tokens`.
* **response\_type**: Vrednost koja specificira **tip tokena koji se traÅ¾i**, kao Å¡to je `code`.
* **scope**: **Nivo pristupa** koji `client application` traÅ¾i od `resource owner`.
* **redirect\_uri**: **URL na koji se korisnik preusmerava nakon autorizacije**. Ovo obiÄno mora da se poklapa sa unapred registrovanim URL-om za preusmeravanje.
* **state**: Parametar za **odrÅ¾avanje podataka tokom preusmeravanja korisnika na i sa servera za autorizaciju**. Njegova jedinstvenost je kljuÄna za sluÅ¾enje kao **CSRF zaÅ¡titni mehanizam**.
* **grant\_type**: Parametar koji oznaÄava **tip granta i tip tokena koji Ä‡e biti vraÄ‡en**.
* **code**: Autorizacioni kod sa `authorization server`, koriÅ¡Ä‡en zajedno sa `client_id` i `client_secret` od strane client application za dobijanje `access_token`.
* **access\_token**: **Token koji client application koristi za API zahteve** u ime `resource owner`.
* **refresh\_token**: OmoguÄ‡ava aplikaciji da **dobije novi `access_token` bez ponovnog traÅ¾enja od korisnika**.

### Tok

**Stvarni OAuth tok** se odvija na sledeÄ‡i naÄin:

1. Vi poseÄ‡ujete [https://example.com](https://example.com) i birate dugme â€œIntegrate with Social Mediaâ€.
2. Sajt zatim Å¡alje zahtev na [https://socialmedia.com](https://socialmedia.com) traÅ¾eÄ‡i vaÅ¡u autorizaciju da aplikacija https://example.com pristupi vaÅ¡im objavama. Zahtev je strukturiran kao:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Zatim vam se prikazuje stranica za saglasnost.
4. Nakon vaÅ¡eg odobrenja, Social Media Å¡alje odgovor na `redirect_uri` sa `code` i `state` parametrima:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com koristi ovaj `code`, zajedno sa `client_id` i `client_secret`, da napravi server-side zahtev kako bi dobio `access_token` u vaÅ¡e ime, omoguÄ‡avajuÄ‡i pristup dozvolama na koje ste pristali:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. KonaÄno, proces se zavrÅ¡ava kada https://example.com koristi vaÅ¡ `access_token` da napravi API poziv ka Social Media za pristup

## Ranljivosti <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri` je kljuÄan za sigurnost u OAuth i OpenID implementacijama, jer usmerava gde se Å¡alju osetljivi podaci, kao Å¡to su autorizacioni kodovi, nakon autorizacije. Ako je pogreÅ¡no konfigurisan, moÅ¾e omoguÄ‡iti napadaÄima da preusmere ove zahteve ka zlonamernim serverima, omoguÄ‡avajuÄ‡i preuzimanje naloga.

Tehnike eksploatacije variraju u zavisnosti od logike validacije autorizacionog servera. Mogu se kretati od striktnih podudaranja putanja do prihvatanja bilo kog URL-a unutar specificiranog domena ili poddirektorijuma. UobiÄajene metode eksploatacije ukljuÄuju otvorene preusmeravanja, putanje zaobilaska, eksploataciju slabih regex-a i HTML injekciju za kraÄ‘u tokena.

Pored `redirect_uri`, drugi OAuth i OpenID parametri kao Å¡to su `client_uri`, `policy_uri`, `tos_uri` i `initiate_login_uri` su takoÄ‘e podloÅ¾ni napadima preusmeravanja. Ovi parametri su opcioni i njihova podrÅ¡ka varira meÄ‘u serverima.

Za one koji ciljaju OpenID server, discovery endpoint (`**.well-known/openid-configuration**`) Äesto navodi vredne detalje konfiguracije kao Å¡to su `registration_endpoint`, `request_uri_parameter_supported` i "`require_request_uri_registration`. Ovi detalji mogu pomoÄ‡i u identifikaciji registration endpoint-a i drugih specifiÄnosti konfiguracije servera.

### XSS u implementaciji preusmeravanja <a href="#bda5" id="bda5"></a>

Kao Å¡to je pomenuto u ovom bug bounty izveÅ¡taju [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html) moguÄ‡e je da se preusmeravanje **URL-a reflektuje u odgovoru** servera nakon Å¡to se korisnik autentifikuje, Å¡to je **ranjivo na XSS**. MoguÄ‡i payload za testiranje:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Nepravilno rukovanje state parametrom <a href="#bda5" id="bda5"></a>

U OAuth implementacijama, zloupotreba ili izostavljanje **`state` parametra** moÅ¾e znaÄajno poveÄ‡ati rizik od **Cross-Site Request Forgery (CSRF)** napada. Ova ranjivost se javlja kada se `state` parametar **ne koristi, koristi kao statiÄka vrednost ili se ne validira pravilno**, omoguÄ‡avajuÄ‡i napadaÄima da zaobiÄ‘u CSRF zaÅ¡tite.

NapadaÄi mogu iskoristiti ovo presretanjem autorizacionog procesa kako bi povezali svoj nalog sa nalogom Å¾rtve, Å¡to moÅ¾e dovesti do potencijalnog **preuzimanja naloga**. Ovo je posebno kritiÄno u aplikacijama gde se OAuth koristi za **autentifikaciju**.

Primeri ove ranjivosti u stvarnom svetu dokumentovani su u raznim **CTF izazovima** i **hakerskim platformama**, istiÄuÄ‡i njene praktiÄne implikacije. Problem se takoÄ‘e proteÅ¾e na integracije sa uslugama treÄ‡ih strana kao Å¡to su **Slack**, **Stripe** i **PayPal**, gde napadaÄi mogu preusmeriti obaveÅ¡tenja ili uplate na svoje naloge.

Pravilno rukovanje i validacija **`state` parametra** su kljuÄni za zaÅ¡titu od CSRF i osiguranje OAuth toka.

### Preuzimanje naloga pre kreiranja <a href="#ebe4" id="ebe4"></a>

1. **Bez verifikacije emaila prilikom kreiranja naloga**: NapadaÄi mogu unapred kreirati nalog koristeÄ‡i email Å¾rtve. Ako Å¾rtva kasnije koristi uslugu treÄ‡e strane za prijavu, aplikacija moÅ¾e nenamerno povezati ovaj nalog treÄ‡e strane sa unapred kreiranim nalogom napadaÄa, Å¡to dovodi do neovlaÅ¡Ä‡enog pristupa.
2. **IskoriÅ¡Ä‡avanje slabe verifikacije emaila u OAuth-u**: NapadaÄi mogu iskoristiti OAuth usluge koje ne verifikuju emailove tako Å¡to Ä‡e se registrovati sa svojom uslugom, a zatim promeniti email naloga na email Å¾rtve. Ova metoda sliÄna je prvoj situaciji, ali kroz drugaÄiji vektor napada.

### OtkriÄ‡e tajni <a href="#e177" id="e177"></a>

Identifikacija i zaÅ¡tita tajnih OAuth parametara je kljuÄna. Dok se **`client_id`** moÅ¾e bezbedno otkriti, otkrivanje **`client_secret`** predstavlja znaÄajan rizik. Ako je `client_secret` kompromitovan, napadaÄi mogu iskoristiti identitet i poverenje aplikacije da **ukradu korisniÄke `access_tokens`** i privatne informacije.

UobiÄajena ranjivost se javlja kada aplikacije greÅ¡kom rukovode razmenom autorizacionog `code` za `access_token` na klijentskoj strani umesto na serverskoj strani. Ova greÅ¡ka dovodi do izlaganja `client_secret`, omoguÄ‡avajuÄ‡i napadaÄima da generiÅ¡u `access_tokens` pod maskom aplikacije. Å taviÅ¡e, kroz socijalni inÅ¾enjering, napadaÄi mogu eskalirati privilegije dodavanjem dodatnih opsega OAuth autorizaciji, dodatno eksploatiÅ¡uÄ‡i poverenje aplikacije.

### Bruteforce client secreta

MoÅ¾ete pokuÅ¡ati da **bruteforce client\_secret** provajdera usluga sa identitet provajderom kako biste pokuÅ¡ali da ukradete naloge.\
Zahtev za BF moÅ¾e izgledati sliÄno:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header leaking Code + State

Kada klijent ima **code i state**, ako su **reflektovani unutar Referer header-a** kada preÄ‘e na drugu stranicu, onda je ranjiv.

### Access Token Stored in Browser History

Idite u **istoriju pretraÅ¾ivaÄa i proverite da li je access token saÄuvan tamo**.

### Everlasting Authorization Code

**Authorization code treba da traje samo odreÄ‘eno vreme kako bi se ograniÄio vremenski prozor u kojem napadaÄ moÅ¾e da ga ukrade i iskoristi**.

### Authorization/Refresh Token not bound to client

Ako moÅ¾ete dobiti **authorization code i koristiti ga sa drugim klijentom, onda moÅ¾ete preuzeti druge naloge**.

### Happy Paths, XSS, Iframes & Post Messages to leak code & state values

[**Pogledajte ovaj post**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

U ovom bug bounty izveÅ¡taju: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) moÅ¾ete videti da **token** koji **AWS Cognito** vraÄ‡a korisniku moÅ¾e imati **dovoljno dozvola da prepiÅ¡e korisniÄke podatke**. Dakle, ako moÅ¾ete **promeniti korisniÄki email na drugi korisniÄki email**, moÅ¾da Ä‡ete moÄ‡i **preuzeti** druge naloge.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Za detaljnije informacije o tome kako zloupotrebiti AWS cognito pogledajte:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Zloupotreba tokena drugih aplikacija <a href="#bda5" id="bda5"></a>

Kao Å¡to je [**pomenuto u ovom Älanku**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), OAuth tokovi koji oÄekuju da prime **token** (a ne kod) mogu biti ranjivi ako ne proveravaju da li token pripada aplikaciji.

To je zato Å¡to **napadaÄ** moÅ¾e kreirati **aplikaciju koja podrÅ¾ava OAuth i prijaviti se sa Facebook-om** (na primer) u svojoj aplikaciji. Zatim, kada se Å¾rtva prijavi sa Facebook-om u **napadaÄevoj aplikaciji**, napadaÄ moÅ¾e dobiti **OAuth token korisnika dodeljen njegovoj aplikaciji i koristiti ga za prijavu u OAuth aplikaciju Å¾rtve koristeÄ‡i token korisnika Å¾rtve**.

{% hint style="danger" %}
Dakle, ako napadaÄ uspe da korisnik pristupi njegovoj OAuth aplikaciji, moÄ‡i Ä‡e da preuzme nalog Å¾rtve u aplikacijama koje oÄekuju token i ne proveravaju da li je token dodeljen njihovom ID-u aplikacije.
{% endhint %}

### Dva linka i kolaÄiÄ‡ <a href="#bda5" id="bda5"></a>

Prema [**ovom Älanku**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), bilo je moguÄ‡e naterati Å¾rtvu da otvori stranicu sa **returnUrl** koji pokazuje na napadaÄev host. Ova informacija bi bila **saÄuvana u kolaÄiÄ‡u (RU)** i u **kasnijem koraku** **prompt** Ä‡e **pitati** **korisnika** da li Å¾eli da da pristup tom napadaÄevom hostu.

Da bi se zaobiÅ¡ao ovaj prompt, bilo je moguÄ‡e otvoriti tab da se pokrene **Oauth tok** koji bi postavio ovaj RU kolaÄiÄ‡ koristeÄ‡i **returnUrl**, zatvoriti tab pre nego Å¡to se prompt prikaÅ¾e, i otvoriti novi tab bez te vrednosti. Zatim, **prompt neÄ‡e informisati o napadaÄevom hostu**, ali Ä‡e kolaÄiÄ‡ biti postavljen na njega, tako da Ä‡e **token biti poslat na napadaÄev host** u preusmeravanju.

### ZaobilaÅ¾enje interakcije sa promptom <a href="#bda5" id="bda5"></a>

Kao Å¡to je objaÅ¡njeno u [**ovom videu**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), neke OAuth implementacije omoguÄ‡avaju da se navede **`prompt`** GET parametar kao None (**`&prompt=none`**) da **spreÄe korisnike da budu pitani za potvrdu** datog pristupa u promptu na webu ako su veÄ‡ prijavljeni na platformu.

### response\_mode

Kao Å¡to je [**objaÅ¡njeno u ovom videu**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), moguÄ‡e je navesti parametar **`response_mode`** da se naznaÄi gde Å¾elite da kod bude dostavljen u finalnom URL-u:

* `response_mode=query` -> Kod je dostavljen unutar GET parametra: `?code=2397rf3gu93f`
* `response_mode=fragment` -> Kod je dostavljen unutar fragment parametra URL-a `#code=2397rf3gu93f`
* `response_mode=form_post` -> Kod je dostavljen unutar POST forme sa inputom nazvanim `code` i vrednoÅ¡Ä‡u
* `response_mode=web_message` -> Kod je poslat u post poruci: `window.opener.postMessage({"code": "asdasdasd...`

### SSRF parametri <a href="#bda5" id="bda5"></a>

[**Pogledajte ovo istraÅ¾ivanje**](https://portswigger.net/research/hidden-oauth-attack-vectors) **za dodatne detalje o ovoj tehnici.**

DinamiÄka registracija klijenata u OAuth sluÅ¾i kao manje oÄigledan, ali kritiÄan vektor za sigurnosne ranjivosti, posebno za **Server-Side Request Forgery (SSRF)** napade. Ovaj endpoint omoguÄ‡ava OAuth serverima da prime detalje o klijentskim aplikacijama, ukljuÄujuÄ‡i osetljive URL-ove koji mogu biti zloupotrebljeni.

**KljuÄne taÄke:**

* **DinamiÄka registracija klijenata** je Äesto mapirana na `/register` i prihvata detalje kao Å¡to su `client_name`, `client_secret`, `redirect_uris`, i URL-ove za logotipe ili JSON Web Key Sets (JWKs) putem POST zahteva.
* Ova funkcija se pridrÅ¾ava specifikacija navedenih u **RFC7591** i **OpenID Connect Registration 1.0**, koje ukljuÄuju parametre potencijalno ranjive na SSRF.
* Proces registracije moÅ¾e nenamerno izloÅ¾iti servere SSRF-u na nekoliko naÄina:
* **`logo_uri`**: URL za logotip klijentske aplikacije koji server moÅ¾e preuzeti, pokreÄ‡uÄ‡i SSRF ili dovodeÄ‡i do XSS ako se URL neadekvatno obradi.
* **`jwks_uri`**: URL do JWK dokumenta klijenta, koji ako je zlonamerno kreiran, moÅ¾e uzrokovati da server izvrÅ¡i izlazne zahteve ka serveru pod kontrolom napadaÄa.
* **`sector_identifier_uri`**: ReferiÅ¡e se na JSON niz `redirect_uris`, koji server moÅ¾e preuzeti, stvarajuÄ‡i SSRF priliku.
* **`request_uris`**: Navodi dozvoljene URI zahteve za klijenta, koji mogu biti zloupotrebljeni ako server preuzima ove URI-je na poÄetku autorizacionog procesa.

**Strategija eksploatacije:**

* SSRF moÅ¾e biti pokrenut registracijom novog klijenta sa zlonamernim URL-ovima u parametrima kao Å¡to su `logo_uri`, `jwks_uri`, ili `sector_identifier_uri`.
* Dok direktna eksploatacija putem `request_uris` moÅ¾e biti ublaÅ¾ena kontrolama bele liste, snabdevanje unapred registrovanim, napadaÄem kontrolisanim `request_uri` moÅ¾e olakÅ¡ati SSRF tokom faze autorizacije.

## OAuth provajderi Uslovi trke

Ako platforma koju testirate je OAuth provajder [**proÄitajte ovo da testirate moguÄ‡e Uslove trke**](race-condition.md).

## Reference

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>NauÄite AWS hakovanje od poÄetnika do eksperta sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini da podrÅ¾ite HackTricks:

* Ako Å¾elite da vidite vaÅ¡u **kompaniju reklamiranu u HackTricks** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**PRETPLATNE PLANOVE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite vaÅ¡e hakovanje trikove podnoÅ¡enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
