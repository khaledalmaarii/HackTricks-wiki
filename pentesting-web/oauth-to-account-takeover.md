# OAuth za preuzimanje naloga

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije <a href="#d4a8" id="d4a8"></a>

OAuth nudi razli캜ite verzije, sa osnovnim informacijama dostupnim na [OAuth 2.0 dokumentaciji](https://oauth.net/2/). Ova diskusija se uglavnom fokusira na 코iroko kori코캖eni [OAuth 2.0 grant tip autorizacije](https://oauth.net/2/grant-types/authorization-code/), pru쬬ju캖i **okvir za autorizaciju koji omogu캖ava aplikaciji pristup ili izvr코avanje radnji na korisni캜kom nalogu u drugoj aplikaciji** (autorizacioni server).

Razmotrimo hipoteti캜ki veb sajt _**https://example.com**_, dizajniran da **prika쬰 sve va코e objave na dru코tvenim mre쬬ma**, uklju캜uju캖i privatne. Da bi se to postiglo, koristi se OAuth 2.0. _https://example.com_ 캖e zatra쬴ti va코u dozvolu da **pristupi va코im objavama na dru코tvenim mre쬬ma**. Kao rezultat toga, pojavi캖e se ekran za saglasnost na _https://socialmedia.com_, koji prikazuje **dozvole koje se tra쬰 i razvojnog programera koji je podneo zahtev**. Nakon va코e autorizacije, _https://example.com_ dobija mogu캖nost da **pristupa va코im objavama u va코e ime**.

Va쬹o je razumeti slede캖e komponente unutar OAuth 2.0 okvira:

- **vlasnik resursa**: Vi, kao **korisnik/entitet**, autorizujete pristup va코em resursu, kao 코to su objave na va코em dru코tvenom mre쬹om nalogu.
- **server resursa**: **Server koji upravlja autentifikovanim zahtevima** nakon 코to je aplikacija obezbedila `access token` u ime `vlasnika resursa`, npr. **https://socialmedia.com**.
- **klijentska aplikacija**: **Aplikacija koja tra쬴 autorizaciju** od `vlasnika resursa`, kao 코to je **https://example.com**.
- **autorizacioni server**: **Server koji izdaje `access tokene`** `klijentskoj aplikaciji` nakon uspe코ne autentifikacije `vlasnika resursa` i obezbe캠ivanja autorizacije, npr. **https://socialmedia.com**.
- **client\_id**: Javni, jedinstveni identifikator aplikacije.
- **client\_secret:** Poverljivi klju캜, poznat samo aplikaciji i autorizacionom serveru, koji se koristi za generisanje `access tokena`.
- **response\_type**: Vrednost koja odre캠uje **tip tra쬰nog tokena**, kao 코to je `code`.
- **scope**: **Nivo pristupa** koji `klijentska aplikacija` tra쬴 od `vlasnika resursa`.
- **redirect\_uri**: **URL na koji korisnik biva preusmeren nakon autorizacije**. Ovo obi캜no mora biti u skladu sa prethodno registrovanim preusmerenim URL-om.
- **state**: Parametar za **캜uvanje podataka tokom preusmeravanja korisnika ka i od autorizacionog servera**. Njegova jedinstvenost je klju캜na za slu쬰nje kao **mehanizam za코tite od CSRF napada**.
- **grant\_type**: Parametar koji ukazuje **tip granta i tip tokena koji 캖e biti vra캖en**.
- **code**: Autorizacioni kod sa `autorizacionog servera`, koji se koristi zajedno sa `client_id` i `client_secret` od strane klijentske aplikacije za dobijanje `access_tokena`.
- **access\_token**: Token koji klijentska aplikacija koristi za API zahteve u ime `vlasnika resursa`.
- **refresh\_token**: Omogu캖ava aplikaciji da **dobije novi `access_token` bez ponovnog tra쬰nja dozvole od korisnika**.

### Tok

**Stvarni OAuth tok** se odvija na slede캖i na캜in:

1. Posetite [https://example.com](https://example.com) i izaberite dugme "Integri코i sa dru코tvenim mre쬬ma".
2. Sajt zatim 코alje zahtev na [https://socialmedia.com](https://socialmedia.com) tra쬰캖i va코u autorizaciju da dozvoli aplikaciji https://example.com pristup va코im objavama. Zahtev je strukturiran kao:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Zatim vam se prikazuje stranica za davanje pristanka.

4. Nakon 코to odobrite, dru코tvena mre쬬 코alje odgovor na `redirect_uri` sa parametrima `code` i `state`:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com koristi ovaj `code`, zajedno sa svojim `client_id` i `client_secret`, da bi napravio serverski zahtev za dobijanje `access_token`-a u va코e ime, omogu캖avaju캖i pristup dozvolama na koje ste pristali:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Na kraju, proces se zavr코ava kada https://example.com koristi va코 `access_token` da bi napravio API poziv ka dru코tvenim medijima kako bi pristupio.

## Ranjivosti <a href="#323a" id="323a"></a>

### Otvoreni redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri` je klju캜an za sigurnost u OAuth i OpenID implementacijama, jer usmerava gde se 코alju osetljivi podaci, poput autorizacionih kodova, nakon autorizacije. Ako je konfigurisan na pogre코an na캜in, mo쬰 omogu캖iti napada캜ima da preusmere ove zahteve na zlonamerne servere, omogu캖avaju캖i preuzimanje naloga.

Tehnike eksploatacije variraju u zavisnosti od logike validacije autorizacionog servera. One mogu i캖i od stroge provere putanje do prihvatanja bilo koje URL adrese unutar odre캠ene domene ili poddirektorijuma. Uobi캜ajene metode eksploatacije uklju캜uju otvorene preusmere, pretragu putanja, iskori코캖avanje slabih regularnih izraza i HTML ubacivanje radi kra캠e tokena.

Osim `redirect_uri`, i drugi OAuth i OpenID parametri poput `client_uri`, `policy_uri`, `tos_uri` i `initiate_login_uri` su podlo쬹i napadima preusmeravanja. Ovi parametri su opcioni i podr코ka za njih varira me캠u serverima.

Za one koji ciljaju OpenID server, endpoint otkrivanja (`**.well-known/openid-configuration**`) 캜esto sadr쬴 vredne konfiguracione detalje poput `registration_endpoint`, `request_uri_parameter_supported` i "`require_request_uri_registration`. Ovi detalji mogu pomo캖i u identifikaciji endpointa za registraciju i drugih specifi캜nosti konfiguracije servera.

### XSS u implementaciji preusmeravanja <a href="#bda5" id="bda5"></a>

Kao 코to je pomenuto u ovom izve코taju o nagradi za otkrivanje gre코aka [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), mogu캖e je da se **URL preusmeravanja reflektuje u odgovoru** servera nakon 코to korisnik autentifikuje, 코to ga 캜ini **ranjivim na XSS**. Mogu캖i payload za testiranje:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Nepravilno rukovanje parametrom stanja <a href="#bda5" id="bda5"></a>

U implementacijama OAuth-a, zloupotreba ili izostavljanje **parametra stanja** mo쬰 zna캜ajno pove캖ati rizik od napada **Cross-Site Request Forgery (CSRF)**. Ova ranjivost se javlja kada se parametar `state` ili **ne koristi, koristi kao stati캜ka vrednost ili nije pravilno validiran**, 코to omogu캖ava napada캜ima da zaobi캠u CSRF za코titu.

Napada캜i mogu iskoristiti ovo tako 코to presre캖u proces autorizacije kako bi povezali svoj nalog sa rtvinim nalogom, 코to mo쬰 dovesti do potencijalnog **preuzimanja naloga**. Ovo je posebno kriti캜no u aplikacijama gde se OAuth koristi u **svrhu autentifikacije**.

Primeri ove ranjivosti su dokumentovani u raznim **CTF izazovima** i **hakerskim platformama**, 코to isti캜e njene prakti캜ne implikacije. Ovaj problem tako캠e se odnosi na integracije sa uslugama tre캖ih strana poput **Slack**, **Stripe** i **PayPal**, gde napada캜i mogu preusmeriti obave코tenja ili uplate na svoje naloge.

Pravilno rukovanje i validacija **parametra stanja** su klju캜ni za za코titu od CSRF i obezbe캠ivanje sigurnosti OAuth protoka.

### Preuzimanje naloga pre preuzimanja <a href="#ebe4" id="ebe4"></a>

1. **Bez provere e-po코te prilikom kreiranja naloga**: Napada캜i mogu unapred kreirati nalog koriste캖i e-po코tu rtve. Ako rtva kasnije koristi uslugu tre캖e strane za prijavu, aplikacija mo쬰 nenamerno povezati ovaj nalog tre캖e strane sa unapred kreiranim nalogom napada캜a, 코to dovodi do neovla코캖enog pristupa.

2. **Iskori코캖avanje slabih provjera e-po코te u OAuth-u**: Napada캜i mogu iskoristiti OAuth usluge koje ne proveravaju e-po코tu tako 코to se registruju sa svojom uslugom, a zatim promene e-po코tu naloga na rtvinu. Ovaj metod tako캠e predstavlja rizik od neovla코캖enog pristupa nalogu, sli캜no kao i prvi scenario, ali kroz drugi vektor napada.

### Otkrivanje tajni <a href="#e177" id="e177"></a>

Identifikacija i za코tita tajnih OAuth parametara su klju캜ni. Dok se **`client_id`** mo쬰 bezbedno otkriti, otkrivanje **`client_secret`** predstavlja zna캜ajan rizik. Ako `client_secret` bude kompromitovan, napada캜i mogu iskoristiti identitet i poverenje aplikacije kako bi **ukrali korisni캜ke `access_tokens`** i privatne informacije.

캛esta ranjivost se javlja kada aplikacije gre코kom rukuju razmenom autorizacijskog `koda` za `access_token` na strani klijenta umesto na strani servera. Ova gre코ka dovodi do otkrivanja `client_secret`, omogu캖avaju캖i napada캜ima da generi코u `access_token` pod la쬹im identitetom aplikacije. Osim toga, kroz socijalno in쬰njerstvo, napada캜i mogu pove캖ati privilegije dodavanjem dodatnih opsega autorizacije OAuth-a, dalje iskori코캖avaju캖i poveren status aplikacije.

### Brute force napad na tajni klijenta

Mo쬰te poku코ati **brute force napadom na tajnu klijenta** pru쬬telja usluga sa identifikacionim pru쬬teljem kako biste poku코ali da ukradete naloge.\
Zahtev za BF mo쬰 izgledati sli캜no:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header otkriva kod + stanje

Kada klijent dobije **kod i stanje**, ako se **reflektuje unutar Referer zaglavlja** kada prelazi na drugu stranicu, onda je ranjiv.

### Pristupni token sa캜uvan u istoriji pretra쬴va캜a

Idite na **istoriju pretra쬴va캜a i proverite da li je pristupni token sa캜uvan tamo**.

### Ve캜ni autorizacioni kod

**Autorizacioni kod treba da 쬴vi samo odre캠eno vreme kako bi se ograni캜io vremenski prozor u kojem napada캜 mo쬰 da ga ukrade i koristi**.

### Autorizacioni/Osvje쬬vaju캖i token nije vezan za klijenta

Ako mo쬰te dobiti **autorizacioni kod i koristiti ga sa drugim klijentom, onda mo쬰te preuzeti druge naloge**.

### Sre캖ni putovi, XSS, Iframe i Post poruke za otkrivanje vrednosti koda i stanja

**[Proverite ovaj post](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)**

### AWS Cognito <a href="#bda5" id="bda5"></a>

U ovom izve코taju o otkrivanju gre코aka: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) mo쬰te videti da **token** koji **AWS Cognito** vra캖a korisniku mo쬰 imati **dovoljno dozvola za prebrisavanje korisni캜kih podataka**. Stoga, ako mo쬰te **promeniti e-po코tu korisnika za drugu e-po코tu korisnika**, mo쬯a 캖ete mo캖i **preuzeti** druge naloge.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Za vi코e detalja o tome kako zloupotrebiti AWS Cognito, pogledajte:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Zloupotreba tokena drugih aplikacija <a href="#bda5" id="bda5"></a>

Kao 코to je [**pomenuto u ovom 캜lanku**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), OAuth tokovi koji o캜ekuju da prime **token** (a ne kod) mogu biti ranjivi ako ne provere da li token pripada aplikaciji.

To je zato 코to **napada캜** mo쬰 kreirati **aplikaciju koja podr쬬va OAuth i prijaviti se putem Facebook-a** (na primer) u svojoj sopstvenoj aplikaciji. Zatim, kada rtva se prijavi putem Facebook-a u **napada캜evu aplikaciju**, napada캜 mo쬰 dobiti **OAuth token korisnika koji je dat njegovoj aplikaciji i koristiti ga za prijavu u OAuth aplikaciju rtve koriste캖i token korisnika rtve**.

{% hint style="danger" %}
Dakle, ako napada캜 uspe da navede korisnika da pristupi njegovoj sopstvenoj OAuth aplikaciji, on 캖e mo캖i preuzeti kontrolu nad rtvinim nalogom u aplikacijama koje o캜ekuju token i ne proveravaju da li je token dodeljen njihovom ID-u aplikacije.
{% endhint %}

### Dva linka i kola캜i캖 <a href="#bda5" id="bda5"></a>

Prema [**ovom 캜lanku**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), bilo je mogu캖e naterati rtvu da otvori stranicu sa **returnUrl** koji pokazuje na napada캜evu host. Ove informacije bi bile **sa캜uvane u kola캜i캖u (RU)**, a u **kasnijem koraku** **prompt** 캖e **pitati** korisnika da li 쬰li da pru쬴 pristup napada캜evom hostu.

Da bi se zaobi코ao ovaj prompt, bilo je mogu캖e otvoriti karticu kako bi se pokrenuo **Oauth tok** koji bi postavio ovaj RU kola캜i캖 koriste캖i **returnUrl**, zatvoriti karticu pre nego 코to se prika쬰 prompt, i otvoriti novu karticu bez te vrednosti. Tada, **prompt ne캖e obavestiti o napada캜evom hostu**, ali 캖e kola캜i캖 biti postavljen na njega, tako da 캖e **token biti poslat napada캜evom hostu** u preusmeravanju.

### Parametri SSRF-a <a href="#bda5" id="bda5"></a>

**[Proverite ovu istra쬴va캜ku studiju](https://portswigger.net/research/hidden-oauth-attack-vectors) za dalje detalje o ovoj tehnici.**

Dinami캜ka registracija klijenta u OAuth-u slu쬴 kao manje o캜igledan, ali klju캜ni vektor za ranjivosti bezbednosti, posebno za napade **Server-Side Request Forgery (SSRF)**. Ova ta캜ka omogu캖ava OAuth serverima da primaju detalje o klijentskim aplikacijama, uklju캜uju캖i osetljive URL-ove koji mogu biti iskori코캖eni.

**Klju캜ne ta캜ke:**

- **Dinami캜ka registracija klijenta** 캜esto je mapirana na `/register` i prihvata detalje poput `client_name`, `client_secret`, `redirect_uris` i URL-ove za logoe ili JSON Web Key Sets (JWKs) putem POST zahteva.
- Ova funkcionalnost se pridr쬬va specifikacija navedenih u **RFC7591** i **OpenID Connect Registration 1.0**, koje uklju캜uju parametre koji su potencijalno ranjivi na SSRF.
- Proces registracije mo쬰 nenamerno izlo쬴ti servere SSRF na nekoliko na캜ina:
- **`logo_uri`**: URL za logo klijentske aplikacije koji mo쬰 biti preuzet od strane servera, pokre캖u캖i SSRF ili dovode캖i do XSS-a ako URL nije pravilno obra캠en.
- **`jwks_uri`**: URL do JWK dokumenta klijenta, koji ako je zlonamerno oblikovan, mo쬰 naterati server da izvr코i odlazne zahteve ka serveru pod kontrolom napada캜a.
- **`sector_identifier_uri`**: Referenca na JSON niz `redirect_uris`, koje server mo쬰 preuzeti, stvaraju캖i mogu캖nost za SSRF.
- **`request_uris`**: Navodi dozvoljene URI-je zahteva za klijenta, koje mogu biti iskori코캖ene ako server preuzima ove URI-je na po캜etku procesa autorizacije.

**Strategija iskori코캖avanja:**

- SSRF se mo쬰 pokrenuti registracijom novog klijenta sa zlonamernim URL-ovima u parametrima poput `logo_uri`, `jwks_uri` ili `sector_identifier_uri`.
- Iako se direktno iskori코캖avanje putem `request_uris` mo쬰 umanjiti kontrolama bele liste, obezbe캠ivanje prethodno registrovanog, napada캜em kontrolisanog `request_uri` mo쬰 olak코ati SSRF tokom faze autorizacije.

## Trke uslova OAuth provajdera

Ako je platforma koju testirate OAuth provajder, [**pro캜itajte ovo da biste testirali mogu캖e trke uslova**](race-condition.md).

## Reference

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini da podr쬴te HackTricks:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
