# OAuth to Account takeover

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Basic Information <a href="#d4a8" id="d4a8"></a>

OAuth æä¾›äº†å„ç§ç‰ˆæœ¬ï¼ŒåŸºç¡€ä¿¡æ¯å¯ä»¥åœ¨ [OAuth 2.0 documentation](https://oauth.net/2/) ä¸­æ‰¾åˆ°ã€‚æœ¬è®¨è®ºä¸»è¦é›†ä¸­åœ¨å¹¿æ³›ä½¿ç”¨çš„ [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/) ä¸Šï¼Œæä¾›äº†ä¸€ä¸ª**æˆæƒæ¡†æ¶ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè®¿é—®æˆ–åœ¨å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ˆæˆæƒæœåŠ¡å™¨ï¼‰ä¸Šçš„ç”¨æˆ·è´¦æˆ·ä¸Šæ‰§è¡Œæ“ä½œ**ã€‚

è€ƒè™‘ä¸€ä¸ªå‡è®¾çš„ç½‘ç«™ _**https://example.com**_ï¼Œæ—¨åœ¨**å±•ç¤ºä½ æ‰€æœ‰çš„ç¤¾äº¤åª’ä½“å¸–å­**ï¼ŒåŒ…æ‹¬ç§äººå¸–å­ã€‚ä¸ºå®ç°è¿™ä¸€ç‚¹ï¼Œä½¿ç”¨äº† OAuth 2.0ã€‚_https://example.com_ å°†è¯·æ±‚ä½ **è®¿é—®ä½ çš„ç¤¾äº¤åª’ä½“å¸–å­**çš„æƒé™ã€‚å› æ­¤ï¼Œåœ¨ _https://socialmedia.com_ ä¸Šä¼šå‡ºç°ä¸€ä¸ªåŒæ„å±å¹•ï¼Œæ¦‚è¿°**è¯·æ±‚çš„æƒé™å’Œå‘å‡ºè¯·æ±‚çš„å¼€å‘è€…**ã€‚åœ¨ä½ æˆæƒåï¼Œ_https://example.com_ å°†èƒ½å¤Ÿ**ä»£è¡¨ä½ è®¿é—®ä½ çš„å¸–å­**ã€‚

ç†è§£ OAuth 2.0 æ¡†æ¶ä¸­çš„ä»¥ä¸‹ç»„ä»¶æ˜¯è‡³å…³é‡è¦çš„ï¼š

* **resource owner**: ä½ ï¼Œä½œä¸º**ç”¨æˆ·/å®ä½“**ï¼Œæˆæƒè®¿é—®ä½ çš„èµ„æºï¼Œå¦‚ä½ çš„ç¤¾äº¤åª’ä½“è´¦æˆ·å¸–å­ã€‚
* **resource server**: **ç®¡ç†ç»è¿‡èº«ä»½éªŒè¯çš„è¯·æ±‚çš„æœåŠ¡å™¨**ï¼Œåœ¨åº”ç”¨ç¨‹åºä»£è¡¨ `resource owner` è·å¾— `access token` åï¼Œä¾‹å¦‚ **https://socialmedia.com**ã€‚
* **client application**: **å¯»æ±‚ `resource owner` æˆæƒçš„åº”ç”¨ç¨‹åº**ï¼Œå¦‚ **https://example.com**ã€‚
* **authorization server**: **åœ¨æˆåŠŸéªŒè¯ `resource owner` å¹¶è·å¾—æˆæƒåå‘ `client application` å‘æ”¾ `access tokens` çš„æœåŠ¡å™¨**ï¼Œä¾‹å¦‚ **https://socialmedia.com**ã€‚
* **client\_id**: åº”ç”¨ç¨‹åºçš„å…¬å…±ã€å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
* **client\_secret:** ä»…åº”ç”¨ç¨‹åºå’ŒæˆæƒæœåŠ¡å™¨çŸ¥é“çš„æœºå¯†å¯†é’¥ï¼Œç”¨äºç”Ÿæˆ `access_tokens`ã€‚
* **response\_type**: æŒ‡å®š**è¯·æ±‚çš„ä»¤ç‰Œç±»å‹**çš„å€¼ï¼Œå¦‚ `code`ã€‚
* **scope**: `client application` è¯·æ±‚çš„**è®¿é—®çº§åˆ«**ã€‚
* **redirect\_uri**: **ç”¨æˆ·æˆæƒåé‡å®šå‘çš„ URL**ã€‚é€šå¸¸å¿…é¡»ä¸é¢„æ³¨å†Œçš„é‡å®šå‘ URL ä¸€è‡´ã€‚
* **state**: ä¸€ä¸ªå‚æ•°ï¼Œç”¨äº**åœ¨ç”¨æˆ·é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨å’Œä»æˆæƒæœåŠ¡å™¨è¿”å›æ—¶ä¿æŒæ•°æ®**ã€‚å…¶å”¯ä¸€æ€§å¯¹äºä½œä¸º**CSRF ä¿æŠ¤æœºåˆ¶**è‡³å…³é‡è¦ã€‚
* **grant\_type**: æŒ‡ç¤º**æˆæƒç±»å‹å’Œè¿”å›çš„ä»¤ç‰Œç±»å‹**çš„å‚æ•°ã€‚
* **code**: æ¥è‡ª `authorization server` çš„æˆæƒä»£ç ï¼Œ`client application` ä½¿ç”¨ `client_id` å’Œ `client_secret` ä¸ä¹‹é…åˆä»¥è·å– `access_token`ã€‚
* **access\_token**: **client application ä»£è¡¨ `resource owner` è¿›è¡Œ API è¯·æ±‚æ—¶ä½¿ç”¨çš„ä»¤ç‰Œ**ã€‚
* **refresh\_token**: ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿ**åœ¨ä¸é‡æ–°æç¤ºç”¨æˆ·çš„æƒ…å†µä¸‹è·å–æ–°çš„ `access_token`**ã€‚

### Flow

**å®é™…çš„ OAuth æµç¨‹**å¦‚ä¸‹ï¼š

1. ä½ å¯¼èˆªåˆ° [https://example.com](https://example.com) å¹¶é€‰æ‹©â€œä¸ç¤¾äº¤åª’ä½“é›†æˆâ€æŒ‰é’®ã€‚
2. è¯¥ç½‘ç«™ç„¶åå‘ [https://socialmedia.com](https://socialmedia.com) å‘é€è¯·æ±‚ï¼Œè¦æ±‚ä½ æˆæƒ https://example.com çš„åº”ç”¨ç¨‹åºè®¿é—®ä½ çš„å¸–å­ã€‚è¯·æ±‚çš„ç»“æ„å¦‚ä¸‹ï¼š
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. ç„¶åä¼šå‡ºç°ä¸€ä¸ªåŒæ„é¡µé¢ã€‚
4. åœ¨æ‚¨æ‰¹å‡†åï¼ŒSocial Media ä¼šå°†å¸¦æœ‰ `code` å’Œ `state` å‚æ•°çš„å“åº”å‘é€åˆ° `redirect_uri`ï¼š
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com åˆ©ç”¨è¿™ä¸ª `code`ï¼Œè¿åŒå®ƒçš„ `client_id` å’Œ `client_secret`ï¼Œå‘èµ·ä¸€ä¸ªæœåŠ¡å™¨ç«¯è¯·æ±‚ä»¥è·å–ä¸€ä¸ª `access_token`ï¼Œä»è€Œä»£è¡¨ä½ è®¿é—®ä½ åŒæ„çš„æƒé™ï¼š
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. æœ€åï¼Œhttps://example.com ä½¿ç”¨ä½ çš„ `access_token` å‘ Social Media å‘èµ· API è°ƒç”¨ä»¥è®¿é—®

## æ¼æ´ <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri` åœ¨ OAuth å’Œ OpenID å®ç°ä¸­å¯¹å®‰å…¨æ€§è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒæŒ‡ç¤ºæˆæƒåå°†æ•æ„Ÿæ•°æ®ï¼ˆå¦‚æˆæƒä»£ç ï¼‰å‘é€åˆ°å“ªé‡Œã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½å…è®¸æ”»å‡»è€…å°†è¿™äº›è¯·æ±‚é‡å®šå‘åˆ°æ¶æ„æœåŠ¡å™¨ï¼Œä»è€Œå®ç°è´¦æˆ·æ¥ç®¡ã€‚

åˆ©ç”¨æŠ€æœ¯å› æˆæƒæœåŠ¡å™¨çš„éªŒè¯é€»è¾‘è€Œå¼‚ã€‚å®ƒä»¬å¯ä»¥ä»ä¸¥æ ¼çš„è·¯å¾„åŒ¹é…åˆ°æ¥å—æŒ‡å®šåŸŸæˆ–å­ç›®å½•å†…çš„ä»»ä½• URLã€‚å¸¸è§çš„åˆ©ç”¨æ–¹æ³•åŒ…æ‹¬å¼€æ”¾é‡å®šå‘ã€è·¯å¾„éå†ã€åˆ©ç”¨å¼±æ­£åˆ™è¡¨è¾¾å¼å’Œ HTML æ³¨å…¥ä»¥çªƒå–ä»¤ç‰Œã€‚

é™¤äº† `redirect_uri`ï¼Œå…¶ä»– OAuth å’Œ OpenID å‚æ•°å¦‚ `client_uri`ã€`policy_uri`ã€`tos_uri` å’Œ `initiate_login_uri` ä¹Ÿå®¹æ˜“å—åˆ°é‡å®šå‘æ”»å‡»ã€‚è¿™äº›å‚æ•°æ˜¯å¯é€‰çš„ï¼Œå®ƒä»¬çš„æ”¯æŒåœ¨å„æœåŠ¡å™¨ä¹‹é—´æœ‰æ‰€ä¸åŒã€‚

å¯¹äºé‚£äº›é’ˆå¯¹ OpenID æœåŠ¡å™¨çš„äººæ¥è¯´ï¼Œå‘ç°ç«¯ç‚¹ï¼ˆ`**.well-known/openid-configuration**`ï¼‰é€šå¸¸åˆ—å‡ºæœ‰ä»·å€¼çš„é…ç½®ç»†èŠ‚ï¼Œå¦‚ `registration_endpoint`ã€`request_uri_parameter_supported` å’Œ `require_request_uri_registration`ã€‚è¿™äº›ç»†èŠ‚æœ‰åŠ©äºè¯†åˆ«æ³¨å†Œç«¯ç‚¹å’ŒæœåŠ¡å™¨çš„å…¶ä»–é…ç½®ç»†èŠ‚ã€‚

### XSS in redirect implementation <a href="#bda5" id="bda5"></a>

æ­£å¦‚è¿™ä¸ªæ¼æ´èµé‡‘æŠ¥å‘Šä¸­æåˆ°çš„ [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html)ï¼Œå¯èƒ½å­˜åœ¨é‡å®šå‘ **URL åœ¨ç”¨æˆ·è®¤è¯åè¢«åæ˜ åœ¨æœåŠ¡å™¨å“åº”ä¸­**ï¼Œä»è€Œ **æ˜“å— XSS æ”»å‡»**ã€‚å¯èƒ½çš„æµ‹è¯•æœ‰æ•ˆè½½è·ï¼š
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - ä¸å½“å¤„ç† state å‚æ•° <a href="#bda5" id="bda5"></a>

åœ¨ OAuth å®ç°ä¸­ï¼Œ**`state` å‚æ•°**çš„è¯¯ç”¨æˆ–çœç•¥ä¼šæ˜¾è‘—å¢åŠ **è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF)** æ”»å‡»çš„é£é™©ã€‚å½“ `state` å‚æ•°**æœªä½¿ç”¨ã€ä½¿ç”¨é™æ€å€¼æˆ–æœªæ­£ç¡®éªŒè¯**æ—¶ï¼Œä¼šå¯¼è‡´æ”»å‡»è€…ç»•è¿‡ CSRF ä¿æŠ¤ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡æ‹¦æˆªæˆæƒè¿‡ç¨‹ï¼Œå°†ä»–ä»¬çš„è´¦æˆ·ä¸å—å®³è€…çš„è´¦æˆ·é“¾æ¥ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„**è´¦æˆ·æ¥ç®¡**ã€‚è¿™åœ¨ä½¿ç”¨ OAuth è¿›è¡Œ**èº«ä»½éªŒè¯**çš„åº”ç”¨ç¨‹åºä¸­å°¤ä¸ºå…³é”®ã€‚

åœ¨å„ç§**CTF æŒ‘æˆ˜**å’Œ**é»‘å®¢å¹³å°**ä¸­ï¼Œå·²ç»è®°å½•äº†è¿™ç§æ¼æ´çš„å®é™…ä¾‹å­ï¼Œçªæ˜¾äº†å…¶å®é™…å½±å“ã€‚è¯¥é—®é¢˜è¿˜æ‰©å±•åˆ°ä¸ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚ **Slack**ã€**Stripe** å’Œ **PayPal**ï¼‰çš„é›†æˆï¼Œæ”»å‡»è€…å¯ä»¥å°†é€šçŸ¥æˆ–ä»˜æ¬¾é‡å®šå‘åˆ°ä»–ä»¬çš„è´¦æˆ·ã€‚

æ­£ç¡®å¤„ç†å’ŒéªŒè¯**`state` å‚æ•°**å¯¹äºé˜²èŒƒ CSRF å’Œä¿æŠ¤ OAuth æµç¨‹è‡³å…³é‡è¦ã€‚

### é¢„è´¦æˆ·æ¥ç®¡ <a href="#ebe4" id="ebe4"></a>

1. **åœ¨åˆ›å»ºè´¦æˆ·æ—¶æ²¡æœ‰ç”µå­é‚®ä»¶éªŒè¯**ï¼šæ”»å‡»è€…å¯ä»¥é¢„å…ˆä½¿ç”¨å—å®³è€…çš„ç”µå­é‚®ä»¶åˆ›å»ºè´¦æˆ·ã€‚å¦‚æœå—å®³è€…ç¨åä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ç™»å½•ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šæ— æ„ä¸­å°†æ­¤ç¬¬ä¸‰æ–¹è´¦æˆ·é“¾æ¥åˆ°æ”»å‡»è€…é¢„å…ˆåˆ›å»ºçš„è´¦æˆ·ï¼Œä»è€Œå¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚
2. **åˆ©ç”¨æ¾æ•£çš„ OAuth ç”µå­é‚®ä»¶éªŒè¯**ï¼šæ”»å‡»è€…å¯èƒ½åˆ©ç”¨ä¸éªŒè¯ç”µå­é‚®ä»¶çš„ OAuth æœåŠ¡ï¼Œé€šè¿‡æ³¨å†Œä»–ä»¬çš„æœåŠ¡ï¼Œç„¶åå°†è´¦æˆ·ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºå—å®³è€…çš„ã€‚è¿™ç§æ–¹æ³•åŒæ ·å­˜åœ¨æœªç»æˆæƒçš„è´¦æˆ·è®¿é—®é£é™©ï¼Œç±»ä¼¼äºç¬¬ä¸€ç§æƒ…å†µï¼Œä½†é€šè¿‡ä¸åŒçš„æ”»å‡»å‘é‡ã€‚

### ç§˜å¯†æ³„éœ² <a href="#e177" id="e177"></a>

è¯†åˆ«å’Œä¿æŠ¤ç§˜å¯†çš„ OAuth å‚æ•°è‡³å…³é‡è¦ã€‚è™½ç„¶**`client_id`**å¯ä»¥å®‰å…¨å…¬å¼€ï¼Œä½†æ³„éœ²**`client_secret`**ä¼šå¸¦æ¥é‡å¤§é£é™©ã€‚å¦‚æœ `client_secret` è¢«æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨åº”ç”¨ç¨‹åºçš„èº«ä»½å’Œä¿¡ä»»æ¥**çªƒå–ç”¨æˆ· `access_tokens`** å’Œç§äººä¿¡æ¯ã€‚

å¸¸è§çš„æ¼æ´å‡ºç°åœ¨åº”ç”¨ç¨‹åºé”™è¯¯åœ°åœ¨å®¢æˆ·ç«¯è€Œä¸æ˜¯æœåŠ¡å™¨ç«¯å¤„ç†æˆæƒ `code` æ¢å– `access_token` çš„è¿‡ç¨‹ä¸­ã€‚è¿™ç§é”™è¯¯å¯¼è‡´ `client_secret` çš„æš´éœ²ï¼Œä½¿æ”»å‡»è€…èƒ½å¤Ÿä»¥åº”ç”¨ç¨‹åºçš„åä¹‰ç”Ÿæˆ `access_tokens`ã€‚æ­¤å¤–ï¼Œé€šè¿‡ç¤¾ä¼šå·¥ç¨‹ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ·»åŠ é¢å¤–çš„èŒƒå›´æ¥æå‡ OAuth æˆæƒçš„æƒé™ï¼Œè¿›ä¸€æ­¥åˆ©ç”¨åº”ç”¨ç¨‹åºçš„ä¿¡ä»»çŠ¶æ€ã€‚

### Client Secret æš´åŠ›ç ´è§£

ä½ å¯ä»¥å°è¯•å¯¹æœåŠ¡æä¾›å•†çš„ **client\_secret** è¿›è¡Œæš´åŠ›ç ´è§£ï¼Œä»¥å°è¯•çªƒå–è´¦æˆ·ã€‚\
æš´åŠ›ç ´è§£è¯·æ±‚å¯èƒ½ç±»ä¼¼äºï¼š
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header æ³„éœ² Code å’Œ State

ä¸€æ—¦å®¢æˆ·ç«¯è·å¾—äº† **code å’Œ state**ï¼Œå¦‚æœå®ƒä»¬åœ¨æµè§ˆåˆ°ä¸åŒé¡µé¢æ—¶è¢« **åæ˜ åœ¨ Referer header ä¸­**ï¼Œé‚£ä¹ˆå®ƒæ˜¯è„†å¼±çš„ã€‚

### è®¿é—®ä»¤ç‰Œå­˜å‚¨åœ¨æµè§ˆå™¨å†å²è®°å½•ä¸­

æŸ¥çœ‹ **æµè§ˆå™¨å†å²è®°å½•å¹¶æ£€æŸ¥è®¿é—®ä»¤ç‰Œæ˜¯å¦ä¿å­˜åœ¨å…¶ä¸­**ã€‚

### æ°¸ä¹…æˆæƒç 

**æˆæƒç åº”è¯¥åªå­˜åœ¨ä¸€æ®µæ—¶é—´ï¼Œä»¥é™åˆ¶æ”»å‡»è€…çªƒå–å’Œä½¿ç”¨å®ƒçš„æ—¶é—´çª—å£**ã€‚

### æˆæƒ/åˆ·æ–°ä»¤ç‰Œæœªç»‘å®šåˆ°å®¢æˆ·ç«¯

å¦‚æœä½ èƒ½è·å¾— **æˆæƒç å¹¶ä½¿ç”¨ä¸åŒçš„å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆä½ å¯ä»¥æ¥ç®¡å…¶ä»–è´¦æˆ·**ã€‚

### Happy Paths, XSS, Iframes å’Œ Post Messages æ³„éœ² code å’Œ state å€¼

[**æŸ¥çœ‹è¿™ç¯‡æ–‡ç« **](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

åœ¨è¿™ä¸ªæ¼æ´èµé‡‘æŠ¥å‘Šä¸­ï¼š[**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) ä½ å¯ä»¥çœ‹åˆ° **AWS Cognito** è¿”å›ç»™ç”¨æˆ·çš„ **ä»¤ç‰Œ** å¯èƒ½å…·æœ‰ **è¶³å¤Ÿçš„æƒé™æ¥è¦†ç›–ç”¨æˆ·æ•°æ®**ã€‚å› æ­¤ï¼Œå¦‚æœä½ èƒ½ **å°†ç”¨æˆ·é‚®ç®±æ›´æ”¹ä¸ºå…¶ä»–ç”¨æˆ·çš„é‚®ç®±**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿ **æ¥ç®¡** å…¶ä»–è´¦æˆ·ã€‚
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
æœ‰å…³å¦‚ä½•æ»¥ç”¨ AWS cognito çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### æ»¥ç”¨å…¶ä»–åº”ç”¨ç¨‹åºçš„ä»¤ç‰Œ <a href="#bda5" id="bda5"></a>

å¦‚[**è¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts)ï¼Œå¦‚æœ OAuth æµç¨‹æœŸæœ›æ¥æ”¶**ä»¤ç‰Œ**ï¼ˆè€Œä¸æ˜¯ä»£ç ï¼‰ï¼Œå¹¶ä¸”ä¸æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦å±äºè¯¥åº”ç”¨ç¨‹åºï¼Œåˆ™å¯èƒ½å­˜åœ¨æ¼æ´ã€‚

è¿™æ˜¯å› ä¸º**æ”»å‡»è€…**å¯ä»¥åˆ›å»ºä¸€ä¸ª**æ”¯æŒ OAuth å¹¶ä½¿ç”¨ Facebook ç™»å½•**çš„**åº”ç”¨ç¨‹åº**ï¼ˆä¾‹å¦‚ï¼‰ã€‚ç„¶åï¼Œä¸€æ—¦å—å®³è€…åœ¨**æ”»å‡»è€…çš„åº”ç”¨ç¨‹åº**ä¸­ä½¿ç”¨ Facebook ç™»å½•ï¼Œæ”»å‡»è€…å°±å¯ä»¥è·å–**ç”¨æˆ·æˆäºˆå…¶åº”ç”¨ç¨‹åºçš„ OAuth ä»¤ç‰Œï¼Œå¹¶ä½¿ç”¨è¯¥ä»¤ç‰Œç™»å½•å—å®³è€…çš„ OAuth åº”ç”¨ç¨‹åº**ã€‚

{% hint style="danger" %}
å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…è®¾æ³•è®©ç”¨æˆ·è®¿é—®å…¶è‡ªå·±çš„ OAuth åº”ç”¨ç¨‹åºï¼Œä»–å°†èƒ½å¤Ÿæ¥ç®¡é‚£äº›æœŸæœ›ä»¤ç‰Œä¸”ä¸æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æˆäºˆå…¶åº”ç”¨ç¨‹åº ID çš„åº”ç”¨ç¨‹åºä¸­çš„å—å®³è€…è´¦æˆ·ã€‚
{% endhint %}

### ä¸¤ä¸ªé“¾æ¥å’Œ cookie <a href="#bda5" id="bda5"></a>

æ ¹æ®[**è¿™ç¯‡æ–‡ç« **](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f)ï¼Œå¯ä»¥è®©å—å®³è€…æ‰“å¼€ä¸€ä¸ªå¸¦æœ‰æŒ‡å‘æ”»å‡»è€…ä¸»æœºçš„**returnUrl**çš„é¡µé¢ã€‚æ­¤ä¿¡æ¯å°†**å­˜å‚¨åœ¨ cookie (RU) ä¸­**ï¼Œå¹¶ä¸”åœ¨**åç»­æ­¥éª¤**ä¸­ï¼Œ**æç¤º**å°†**è¯¢é—®**ç”¨æˆ·æ˜¯å¦æ„¿æ„æˆäºˆè¯¥æ”»å‡»è€…ä¸»æœºè®¿é—®æƒé™ã€‚

ä¸ºäº†ç»•è¿‡æ­¤æç¤ºï¼Œå¯ä»¥æ‰“å¼€ä¸€ä¸ªæ ‡ç­¾é¡µä»¥å¯åŠ¨**Oauth æµç¨‹**ï¼Œè¯¥æµç¨‹å°†ä½¿ç”¨**returnUrl**è®¾ç½®æ­¤ RU cookieï¼Œåœ¨æ˜¾ç¤ºæç¤ºä¹‹å‰å…³é—­æ ‡ç­¾é¡µï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªæ²¡æœ‰è¯¥å€¼çš„æ–°æ ‡ç­¾é¡µã€‚ç„¶åï¼Œ**æç¤ºä¸ä¼šé€šçŸ¥æ”»å‡»è€…çš„ä¸»æœº**ï¼Œä½† cookie å°†è®¾ç½®ä¸ºå®ƒï¼Œå› æ­¤**ä»¤ç‰Œå°†åœ¨é‡å®šå‘ä¸­å‘é€åˆ°æ”»å‡»è€…çš„ä¸»æœº**ã€‚

### æç¤ºäº¤äº’ç»•è¿‡ <a href="#bda5" id="bda5"></a>

å¦‚[**æ­¤è§†é¢‘**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q)ä¸­æ‰€è¿°ï¼Œä¸€äº› OAuth å®ç°å…è®¸æŒ‡ç¤º**`prompt`** GET å‚æ•°ä¸º None (**`&prompt=none`**)ï¼Œä»¥**é˜²æ­¢ç”¨æˆ·åœ¨ç½‘ç»œæç¤ºä¸­è¢«è¦æ±‚ç¡®è®¤**å·²æˆäºˆçš„è®¿é—®æƒé™ï¼Œå¦‚æœä»–ä»¬å·²ç»ç™»å½•å¹³å°ã€‚

### response\_mode

å¦‚[**æ­¤è§†é¢‘**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q)ä¸­æ‰€è¿°ï¼Œå¯ä»¥æŒ‡ç¤ºå‚æ•°**`response_mode`**ä»¥æŒ‡ç¤ºå¸Œæœ›ä»£ç åœ¨æœ€ç»ˆ URL ä¸­æä¾›çš„ä½ç½®ï¼š

* `response_mode=query` -> ä»£ç åœ¨ GET å‚æ•°ä¸­æä¾›ï¼š`?code=2397rf3gu93f`
* `response_mode=fragment` -> ä»£ç åœ¨ URL ç‰‡æ®µå‚æ•°ä¸­æä¾› `#code=2397rf3gu93f`
* `response_mode=form_post` -> ä»£ç åœ¨å¸¦æœ‰åä¸º `code` çš„è¾“å…¥å’Œå€¼çš„ POST è¡¨å•ä¸­æä¾›
* `response_mode=web_message` -> ä»£ç åœ¨ post æ¶ˆæ¯ä¸­å‘é€ï¼š`window.opener.postMessage({"code": "asdasdasd...`

### SSRFs å‚æ•° <a href="#bda5" id="bda5"></a>

[**æŸ¥çœ‹æ­¤ç ”ç©¶**](https://portswigger.net/research/hidden-oauth-attack-vectors) **äº†è§£æ­¤æŠ€æœ¯çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚**

OAuth ä¸­çš„åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œæ˜¯å®‰å…¨æ¼æ´çš„ä¸€ä¸ªä¸å¤ªæ˜æ˜¾ä½†è‡³å…³é‡è¦çš„å‘é‡ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹**æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€  (SSRF)** æ”»å‡»ã€‚æ­¤ç«¯ç‚¹å…è®¸ OAuth æœåŠ¡å™¨æ¥æ”¶æœ‰å…³å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯èƒ½è¢«åˆ©ç”¨çš„æ•æ„Ÿ URLã€‚

**å…³é”®ç‚¹ï¼š**

* **åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ**é€šå¸¸æ˜ å°„åˆ° `/register` å¹¶æ¥å— `client_name`ã€`client_secret`ã€`redirect_uris` å’Œç”¨äºå¾½æ ‡æˆ– JSON Web Key Sets (JWKs) çš„ URL ç­‰è¯¦ç»†ä¿¡æ¯ï¼Œé€šè¿‡ POST è¯·æ±‚ã€‚
* æ­¤åŠŸèƒ½éµå¾ª **RFC7591** å’Œ **OpenID Connect Registration 1.0** ä¸­è§„å®šçš„è§„èŒƒï¼Œè¿™äº›è§„èŒƒåŒ…æ‹¬å¯èƒ½æ˜“å— SSRF æ”»å‡»çš„å‚æ•°ã€‚
* æ³¨å†Œè¿‡ç¨‹å¯èƒ½ä¼šåœ¨å¤šç§æ–¹å¼ä¸‹æ— æ„ä¸­æš´éœ²æœåŠ¡å™¨ä»¥è¿›è¡Œ SSRF æ”»å‡»ï¼š
* **`logo_uri`**ï¼šå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå¾½æ ‡çš„ URLï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè·å–è¯¥ URLï¼Œä»è€Œè§¦å‘ SSRF æˆ–åœ¨ URL å¤„ç†ä¸å½“æ—¶å¯¼è‡´ XSSã€‚
* **`jwks_uri`**ï¼šå®¢æˆ·ç«¯çš„ JWK æ–‡æ¡£çš„ URLï¼Œå¦‚æœæ¶æ„æ„é€ ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨å‘æ”»å‡»è€…æ§åˆ¶çš„æœåŠ¡å™¨å‘å‡ºå‡ºç«™è¯·æ±‚ã€‚
* **`sector_identifier_uri`**ï¼šå¼•ç”¨ `redirect_uris` çš„ JSON æ•°ç»„ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè·å–è¯¥æ•°ç»„ï¼Œä»è€Œåˆ›å»º SSRF æœºä¼šã€‚
* **`request_uris`**ï¼šåˆ—å‡ºå®¢æˆ·ç«¯çš„å…è®¸è¯·æ±‚ URIï¼Œå¦‚æœæœåŠ¡å™¨åœ¨æˆæƒè¿‡ç¨‹å¼€å§‹æ—¶è·å–è¿™äº› URIï¼Œåˆ™å¯èƒ½è¢«åˆ©ç”¨ã€‚

**åˆ©ç”¨ç­–ç•¥ï¼š**

* å¯ä»¥é€šè¿‡åœ¨ `logo_uri`ã€`jwks_uri` æˆ– `sector_identifier_uri` ç­‰å‚æ•°ä¸­æ³¨å†Œå¸¦æœ‰æ¶æ„ URL çš„æ–°å®¢æˆ·ç«¯æ¥è§¦å‘ SSRFã€‚
* è™½ç„¶é€šè¿‡ `request_uris` çš„ç›´æ¥åˆ©ç”¨å¯èƒ½ä¼šè¢«ç™½åå•æ§åˆ¶æ‰€ç¼“è§£ï¼Œä½†åœ¨æˆæƒé˜¶æ®µæä¾›é¢„å…ˆæ³¨å†Œçš„ã€æ”»å‡»è€…æ§åˆ¶çš„ `request_uri` å¯ä»¥ä¿ƒè¿› SSRFã€‚

## OAuth æä¾›è€…ç«æ€æ¡ä»¶

å¦‚æœæ‚¨æ­£åœ¨æµ‹è¯•çš„å¹³å°æ˜¯ OAuth æä¾›è€…ï¼Œè¯·[**é˜…è¯»æ­¤å†…å®¹ä»¥æµ‹è¯•å¯èƒ½çš„ç«æ€æ¡ä»¶**](race-condition.md)ã€‚

## å‚è€ƒèµ„æ–™

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ HackTricks ä¸­**å®£ä¼ æ‚¨çš„å…¬å¸**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å‘¨è¾¹**](https://peass.creator-spring.com)
* å‘ç°[**The PEASS Family**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live) **ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
