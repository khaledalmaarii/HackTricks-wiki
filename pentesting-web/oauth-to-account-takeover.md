# OAuth to Account takeover

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Basic Information <a href="#d4a8" id="d4a8"></a>

OAuth offers various versions, with foundational insights accessible at [OAuth 2.0 documentation](https://oauth.net/2/). This discussion primarily centers on the widely used [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/), providing an **authorization framework that enables an application to access or perform actions on a user's account in another application** (the authorization server).

ê°€ìƒì˜ ì›¹ì‚¬ì´íŠ¸ _**https://example.com**_ì„ ìƒê°í•´ë³´ì„¸ìš”. ì´ ì‚¬ì´íŠ¸ëŠ” **ëª¨ë“  ì†Œì…œ ë¯¸ë””ì–´ ê²Œì‹œë¬¼ì„ ë³´ì—¬ì£¼ëŠ” ê²ƒ**ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ OAuth 2.0ì´ ì‚¬ìš©ë©ë‹ˆë‹¤. _https://example.com_ì€ **ì†Œì…œ ë¯¸ë””ì–´ ê²Œì‹œë¬¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì„ ìš”ì²­í•  ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ _https://socialmedia.com_ì—ì„œ **ìš”ì²­ëœ ê¶Œí•œê³¼ ìš”ì²­ì„ í•˜ëŠ” ê°œë°œì**ë¥¼ ì„¤ëª…í•˜ëŠ” ë™ì˜ í™”ë©´ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ìŠ¹ì¸í•˜ë©´ _https://example.com_ì€ **ì‚¬ìš©ìë¥¼ ëŒ€ì‹ í•˜ì—¬ ê²Œì‹œë¬¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ**ì„ ì–»ê²Œ ë©ë‹ˆë‹¤.

OAuth 2.0 í”„ë ˆì„ì›Œí¬ ë‚´ì—ì„œ ë‹¤ìŒ êµ¬ì„± ìš”ì†Œë¥¼ ì´í•´í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤:

* **resource owner**: **ì‚¬ìš©ì/ì—”í‹°í‹°**ë¡œì„œ ìì‹ ì˜ ë¦¬ì†ŒìŠ¤(ì˜ˆ: ì†Œì…œ ë¯¸ë””ì–´ ê³„ì • ê²Œì‹œë¬¼)ì— ëŒ€í•œ ì ‘ê·¼ì„ ìŠ¹ì¸í•˜ëŠ” ì‚¬ëŒ.
* **resource server**: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ `access token`ì„ í™•ë³´í•œ í›„ **ì¸ì¦ëœ ìš”ì²­ì„ ê´€ë¦¬í•˜ëŠ” ì„œë²„**, ì˜ˆ: **https://socialmedia.com**.
* **client application**: `resource owner`ë¡œë¶€í„° **ìŠ¹ì¸ì„ ìš”ì²­í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜**, ì˜ˆ: **https://example.com**.
* **authorization server**: `resource owner`ì˜ ì„±ê³µì ì¸ ì¸ì¦ê³¼ ìŠ¹ì¸ì„ ë°›ì€ í›„ `client application`ì— **`access tokens`ì„ ë°œê¸‰í•˜ëŠ” ì„œë²„**, ì˜ˆ: **https://socialmedia.com**.
* **client\_id**: ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê³µê°œì ì´ê³  ê³ ìœ í•œ ì‹ë³„ì.
* **client\_secret:** ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ì¸ì¦ ì„œë²„ë§Œ ì•Œê³  ìˆëŠ” ë¹„ë°€ í‚¤ë¡œ, `access_tokens`ì„ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©ë¨.
* **response\_type**: **ìš”ì²­ëœ í† í°ì˜ ìœ í˜•**ì„ ì§€ì •í•˜ëŠ” ê°’, ì˜ˆ: `code`.
* **scope**: `client application`ì´ `resource owner`ë¡œë¶€í„° ìš”ì²­í•˜ëŠ” **ì ‘ê·¼ ìˆ˜ì¤€**.
* **redirect\_uri**: **ìŠ¹ì¸ í›„ ì‚¬ìš©ìê°€ ë¦¬ë””ë ‰ì…˜ë˜ëŠ” URL**. ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ì „ ë“±ë¡ëœ ë¦¬ë””ë ‰ì…˜ URLê³¼ ì¼ì¹˜í•´ì•¼ í•¨.
* **state**: ì‚¬ìš©ìê°€ ì¸ì¦ ì„œë²„ë¡œë¶€í„° ë¦¬ë””ë ‰ì…˜ë  ë•Œ **ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ë§¤ê°œë³€ìˆ˜**. **CSRF ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜**ìœ¼ë¡œì„œì˜ ê³ ìœ ì„±ì´ ì¤‘ìš”í•¨.
* **grant\_type**: **ìŠ¹ì¸ ìœ í˜•ê³¼ ë°˜í™˜ë  í† í° ìœ í˜•**ì„ ë‚˜íƒ€ë‚´ëŠ” ë§¤ê°œë³€ìˆ˜.
* **code**: `authorization server`ë¡œë¶€í„° ë°›ì€ ìŠ¹ì¸ ì½”ë“œë¡œ, `client_id` ë° `client_secret`ê³¼ í•¨ê»˜ `access_token`ì„ ì–»ê¸° ìœ„í•´ ì‚¬ìš©ë¨.
* **access\_token**: `client application`ì´ `resource owner`ë¥¼ ëŒ€ì‹ í•˜ì—¬ API ìš”ì²­ì— ì‚¬ìš©í•˜ëŠ” **í† í°**.
* **refresh\_token**: ì• í”Œë¦¬ì¼€ì´ì…˜ì´ **ì‚¬ìš©ìë¥¼ ë‹¤ì‹œ í”„ë¡¬í”„íŠ¸í•˜ì§€ ì•Šê³  ìƒˆë¡œìš´ `access_token`ì„ ì–»ì„ ìˆ˜ ìˆê²Œ í•¨**.

### Flow

**ì‹¤ì œ OAuth íë¦„**ì€ ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ë©ë‹ˆë‹¤:

1. ì‚¬ìš©ìëŠ” [https://example.com](https://example.com)ìœ¼ë¡œ ì´ë™í•˜ì—¬ â€œì†Œì…œ ë¯¸ë””ì–´ì™€ í†µí•©â€ ë²„íŠ¼ì„ ì„ íƒí•©ë‹ˆë‹¤.
2. ì‚¬ì´íŠ¸ëŠ” [https://socialmedia.com](https://socialmedia.com)ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚´ì–´ https://example.comì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‚¬ìš©ìì˜ ê²Œì‹œë¬¼ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ìŠ¹ì¸ ìš”ì²­ì„ í•©ë‹ˆë‹¤. ìš”ì²­ì€ ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë©ë‹ˆë‹¤:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. ê·¸ëŸ¬ë©´ ë™ì˜ í˜ì´ì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.
4. ìŠ¹ì¸ì„ ì™„ë£Œí•˜ë©´, Social MediaëŠ” `code`ì™€ `state` ë§¤ê°œë³€ìˆ˜ë¥¼ í¬í•¨í•œ ì‘ë‹µì„ `redirect_uri`ë¡œ ë³´ëƒ…ë‹ˆë‹¤:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com ì€(ëŠ”) ì´ `code`ë¥¼ `client_id` ë° `client_secret`ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ì„œë²„ ì¸¡ ìš”ì²­ì„ í†µí•´ `access_token`ì„ ëŒ€ì‹  íšë“í•˜ê³ , ê·€í•˜ê°€ ë™ì˜í•œ ê¶Œí•œì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Finally, the process concludes as https://example.com employs your `access_token` to make an API call to Social Media to access

## Vulnerabilities <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri`ëŠ” OAuth ë° OpenID êµ¬í˜„ì—ì„œ ë³´ì•ˆì— ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. ì´ëŠ” ìŠ¹ì¸ í›„ì— ì¸ì¦ ì½”ë“œì™€ ê°™ì€ ë¯¼ê°í•œ ë°ì´í„°ê°€ ì „ì†¡ë˜ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì‹œí•©ë‹ˆë‹¤. ì˜ëª» êµ¬ì„±ë˜ë©´ ê³µê²©ìê°€ ì´ëŸ¬í•œ ìš”ì²­ì„ ì•…ì„± ì„œë²„ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ì—¬ ê³„ì • íƒˆì·¨ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³µê²© ê¸°ë²•ì€ ì¸ì¦ ì„œë²„ì˜ ê²€ì¦ ë…¼ë¦¬ì— ë”°ë¼ ë‹¤ë¦…ë‹ˆë‹¤. ì—„ê²©í•œ ê²½ë¡œ ì¼ì¹˜ì—ì„œë¶€í„° ì§€ì •ëœ ë„ë©”ì¸ ë˜ëŠ” í•˜ìœ„ ë””ë ‰í† ë¦¬ ë‚´ì˜ ëª¨ë“  URLì„ ìˆ˜ë½í•˜ëŠ” ê²ƒê¹Œì§€ ë‹¤ì–‘í•©ë‹ˆë‹¤. ì¼ë°˜ì ì¸ ê³µê²© ë°©ë²•ì—ëŠ” ì—´ë¦° ë¦¬ë””ë ‰ì…˜, ê²½ë¡œ íƒìƒ‰, ì•½í•œ ì •ê·œ í‘œí˜„ì‹ ì•…ìš©, í† í° ë„ë‚œì„ ìœ„í•œ HTML ì‚½ì… ë“±ì´ í¬í•¨ë©ë‹ˆë‹¤.

`redirect_uri` ì™¸ì—ë„ `client_uri`, `policy_uri`, `tos_uri`, `initiate_login_uri`ì™€ ê°™ì€ ë‹¤ë¥¸ OAuth ë° OpenID ë§¤ê°œë³€ìˆ˜ë„ ë¦¬ë””ë ‰ì…˜ ê³µê²©ì— ì·¨ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë§¤ê°œë³€ìˆ˜ëŠ” ì„ íƒ ì‚¬í•­ì´ë©° ì„œë²„ë§ˆë‹¤ ì§€ì›ì´ ë‹¤ë¦…ë‹ˆë‹¤.

OpenID ì„œë²„ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ê²½ìš°, ë°œê²¬ ì—”ë“œí¬ì¸íŠ¸(`**.well-known/openid-configuration**`)ëŠ” `registration_endpoint`, `request_uri_parameter_supported`, "`require_request_uri_registration`ì™€ ê°™ì€ ìœ ìš©í•œ êµ¬ì„± ì„¸ë¶€ ì •ë³´ë¥¼ ë‚˜ì—´í•˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ì„¸ë¶€ ì •ë³´ëŠ” ë“±ë¡ ì—”ë“œí¬ì¸íŠ¸ ë° ì„œë²„ì˜ ë‹¤ë¥¸ êµ¬ì„± ì„¸ë¶€ ì •ë³´ë¥¼ ì‹ë³„í•˜ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### XSS in redirect implementation <a href="#bda5" id="bda5"></a>

ì´ ë²„ê·¸ ë°”ìš´í‹° ë³´ê³ ì„œ [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html)ì—ì„œ ì–¸ê¸‰ëœ ë°”ì™€ ê°™ì´, ì‚¬ìš©ìê°€ ì¸ì¦í•œ í›„ ì„œë²„ì˜ ì‘ë‹µì— ë¦¬ë””ë ‰ì…˜ **URLì´ ë°˜ì˜**ë˜ì–´ **XSSì— ì·¨ì•½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥í•œ í˜ì´ë¡œë“œ:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Improper handling of state parameter <a href="#bda5" id="bda5"></a>

OAuth êµ¬í˜„ì—ì„œ **`state` parameter**ì˜ ì˜¤ìš© ë˜ëŠ” ìƒëµì€ **Cross-Site Request Forgery (CSRF)** ê³µê²©ì˜ ìœ„í—˜ì„ í¬ê²Œ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ `state` parameterê°€ **ì‚¬ìš©ë˜ì§€ ì•Šê±°ë‚˜, ì •ì  ê°’ìœ¼ë¡œ ì‚¬ìš©ë˜ê±°ë‚˜, ì œëŒ€ë¡œ ê²€ì¦ë˜ì§€ ì•Šì„ ë•Œ** ë°œìƒí•˜ì—¬ ê³µê²©ìê°€ CSRF ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

ê³µê²©ìëŠ” ì´ë¥¼ ì•…ìš©í•˜ì—¬ ì¸ì¦ ê³¼ì •ì„ ê°€ë¡œì±„ì–´ ìì‹ ì˜ ê³„ì •ì„ í”¼í•´ìì˜ ê³„ì •ê³¼ ì—°ê²°ì‹œí‚¬ ìˆ˜ ìˆìœ¼ë©°, ì´ëŠ” ì ì¬ì ì¸ **ê³„ì • íƒˆì·¨**ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” OAuthê°€ **ì¸ì¦ ëª©ì ìœ¼ë¡œ** ì‚¬ìš©ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ íŠ¹íˆ ì¤‘ìš”í•©ë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì˜ ì‹¤ì œ ì‚¬ë¡€ëŠ” ë‹¤ì–‘í•œ **CTF ì±Œë¦°ì§€**ì™€ **í•´í‚¹ í”Œë«í¼**ì—ì„œ ë¬¸ì„œí™”ë˜ì–´ ìˆìœ¼ë©°, ê·¸ ì‹¤ì§ˆì ì¸ ì˜í–¥ì„ ê°•ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ë¬¸ì œëŠ” **Slack**, **Stripe**, **PayPal**ê³¼ ê°™ì€ íƒ€ì‚¬ ì„œë¹„ìŠ¤ì™€ì˜ í†µí•©ì—ë„ í™•ì¥ë˜ì–´, ê³µê²©ìê°€ ì•Œë¦¼ì´ë‚˜ ê²°ì œë¥¼ ìì‹ ì˜ ê³„ì •ìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**`state` parameter**ì˜ ì ì ˆí•œ ì²˜ë¦¬ì™€ ê²€ì¦ì€ CSRFë¥¼ ë°©ì§€í•˜ê³  OAuth íë¦„ì„ ë³´í˜¸í•˜ëŠ” ë° ì¤‘ìš”í•©ë‹ˆë‹¤.

### Pre Account Takeover <a href="#ebe4" id="ebe4"></a>

1. **ê³„ì • ìƒì„± ì‹œ ì´ë©”ì¼ ê²€ì¦ ì—†ìŒ**: ê³µê²©ìëŠ” í”¼í•´ìì˜ ì´ë©”ì¼ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ì „ì— ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”¼í•´ìê°€ ë‚˜ì¤‘ì— íƒ€ì‚¬ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì´ íƒ€ì‚¬ ê³„ì •ì„ ê³µê²©ìê°€ ì‚¬ì „ì— ìƒì„±í•œ ê³„ì •ê³¼ ì—°ê²°í•˜ì—¬ ë¬´ë‹¨ ì ‘ê·¼ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. **ëŠìŠ¨í•œ OAuth ì´ë©”ì¼ ê²€ì¦ ì•…ìš©**: ê³µê²©ìëŠ” ì´ë©”ì¼ì„ ê²€ì¦í•˜ì§€ ì•ŠëŠ” OAuth ì„œë¹„ìŠ¤ë¥¼ ì•…ìš©í•˜ì—¬ ìì‹ ì˜ ì„œë¹„ìŠ¤ì— ë“±ë¡í•œ í›„ ê³„ì • ì´ë©”ì¼ì„ í”¼í•´ìì˜ ì´ë©”ì¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì€ ì²« ë²ˆì§¸ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìœ ì‚¬í•˜ì§€ë§Œ ë‹¤ë¥¸ ê³µê²© ë²¡í„°ë¥¼ í†µí•´ ë¬´ë‹¨ ê³„ì • ì ‘ê·¼ ìœ„í—˜ì„ ì´ˆë˜í•©ë‹ˆë‹¤.

### Disclosure of Secrets <a href="#e177" id="e177"></a>

ë¹„ë°€ OAuth íŒŒë¼ë¯¸í„°ë¥¼ ì‹ë³„í•˜ê³  ë³´í˜¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. **`client_id`**ëŠ” ì•ˆì „í•˜ê²Œ ê³µê°œë  ìˆ˜ ìˆì§€ë§Œ, **`client_secret`**ì„ ê³µê°œí•˜ëŠ” ê²ƒì€ í° ìœ„í—˜ì„ ì´ˆë˜í•©ë‹ˆë‹¤. `client_secret`ì´ ìœ ì¶œë˜ë©´ ê³µê²©ìëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹ ì›ê³¼ ì‹ ë¢°ë¥¼ ì•…ìš©í•˜ì—¬ **ì‚¬ìš©ì `access_tokens`** ë° ê°œì¸ ì •ë³´ë¥¼ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¼ë°˜ì ì¸ ì·¨ì•½ì ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¸ì¦ `code`ë¥¼ `access_token`ìœ¼ë¡œ êµí™˜í•˜ëŠ” ê³¼ì •ì„ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì²˜ë¦¬í•  ë•Œ ë°œìƒí•©ë‹ˆë‹¤. ì´ ì‹¤ìˆ˜ëŠ” `client_secret`ì˜ ë…¸ì¶œë¡œ ì´ì–´ì ¸ ê³µê²©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°€ì¥í•˜ì—¬ `access_tokens`ë¥¼ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ë˜í•œ, ì‚¬íšŒ ê³µí•™ì„ í†µí•´ ê³µê²©ìëŠ” OAuth ì¸ì¦ì— ì¶”ê°€ ë²”ìœ„ë¥¼ ì¶”ê°€í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì‹ ë¢° ìƒíƒœë¥¼ ë”ìš± ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Client Secret Bruteforce

ì„œë¹„ìŠ¤ ì œê³µìì˜ **client\_secret**ì„ ì‹ ì› ì œê³µìì™€ í•¨ê»˜ **bruteforce**í•˜ì—¬ ê³„ì •ì„ íƒˆì·¨í•˜ë ¤ê³  ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
BF ìš”ì²­ì€ ë‹¤ìŒê³¼ ìœ ì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header leaking Code + State

í´ë¼ì´ì–¸íŠ¸ê°€ **codeì™€ state**ë¥¼ ê°€ì§€ê³  ìˆì„ ë•Œ, **Referer í—¤ë”ì— ë°˜ì˜**ë˜ì–´ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™í•  ë•Œ ë…¸ì¶œëœë‹¤ë©´ ì·¨ì•½í•©ë‹ˆë‹¤.

### Access Token Stored in Browser History

**ë¸Œë¼ìš°ì € ê¸°ë¡ì„ í™•ì¸í•˜ì—¬ access tokenì´ ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸**í•©ë‹ˆë‹¤.

### Everlasting Authorization Code

**ì¸ì¦ ì½”ë“œëŠ” ì¼ì • ì‹œê°„ ë™ì•ˆë§Œ ìœ íš¨í•´ì•¼ í•˜ë©°, ì´ë¥¼ í†µí•´ ê³µê²©ìê°€ ì´ë¥¼ í›”ì³ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì‹œê°„ ì°½ì„ ì œí•œí•´ì•¼ í•©ë‹ˆë‹¤**.

### Authorization/Refresh Token not bound to client

**ì¸ì¦ ì½”ë“œë¥¼ ì–»ê³  ì´ë¥¼ ë‹¤ë¥¸ í´ë¼ì´ì–¸íŠ¸ì™€ í•¨ê»˜ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ë©´ ë‹¤ë¥¸ ê³„ì •ì„ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

### Happy Paths, XSS, Iframes & Post Messages to leak code & state values

[**ì´ ê²Œì‹œë¬¼ í™•ì¸**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

ì´ ë²„ê·¸ ë°”ìš´í‹° ë³´ê³ ì„œì—ì„œ: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) **AWS Cognito**ê°€ ì‚¬ìš©ìì—ê²Œ ë°˜í™˜í•˜ëŠ” **í† í°**ì´ **ì‚¬ìš©ì ë°ì´í„°ë¥¼ ë®ì–´ì“¸ ìˆ˜ ìˆëŠ” ì¶©ë¶„í•œ ê¶Œí•œì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ**ì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, **ì‚¬ìš©ì ì´ë©”ì¼ì„ ë‹¤ë¥¸ ì‚¬ìš©ì ì´ë©”ì¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆë‹¤ë©´**, ë‹¤ë¥¸ ê³„ì •ì„ **íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
For more detailed info about how to abuse AWS cognito check:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abusing other Apps tokens <a href="#bda5" id="bda5"></a>

[**ì´ ê¸€**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts)ì—ì„œ ì–¸ê¸‰ëœ ê²ƒì²˜ëŸ¼, **í† í°**(ì½”ë“œê°€ ì•„ë‹Œ)ì„ ë°›ëŠ” ê²ƒì„ ê¸°ëŒ€í•˜ëŠ” OAuth íë¦„ì€ í† í°ì´ ì•±ì— ì†í•˜ëŠ”ì§€ í™•ì¸í•˜ì§€ ì•Šìœ¼ë©´ ì·¨ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” **ê³µê²©ì**ê°€ **OAuthë¥¼ ì§€ì›í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìƒì„±í•˜ê³  Facebookìœ¼ë¡œ ë¡œê·¸ì¸**(ì˜ˆë¥¼ ë“¤ì–´)í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, í”¼í•´ìê°€ **ê³µê²©ìì˜ ì• í”Œë¦¬ì¼€ì´ì…˜**ì—ì„œ Facebookìœ¼ë¡œ ë¡œê·¸ì¸í•˜ë©´, ê³µê²©ìëŠ” **ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬ëœ OAuth í† í°ì„ ì–»ì–´ í”¼í•´ìì˜ OAuth ì• í”Œë¦¬ì¼€ì´ì…˜ì— í”¼í•´ìì˜ ì‚¬ìš©ì í† í°ìœ¼ë¡œ ë¡œê·¸ì¸**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

{% hint style="danger" %}
ë”°ë¼ì„œ, ê³µê²©ìê°€ ì‚¬ìš©ìê°€ ìì‹ ì˜ OAuth ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì ‘ê·¼í•˜ë„ë¡ í•  ìˆ˜ ìˆë‹¤ë©´, í† í°ì„ ê¸°ëŒ€í•˜ê³  í† í°ì´ ìì‹ ì˜ ì•± IDì— ë¶€ì—¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì§€ ì•ŠëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í”¼í•´ìì˜ ê³„ì •ì„ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### Two links & cookie <a href="#bda5" id="bda5"></a>

[**ì´ ê¸€**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f)ì— ë”°ë¥´ë©´, í”¼í•´ìê°€ **returnUrl**ì´ ê³µê²©ìì˜ í˜¸ìŠ¤íŠ¸ë¥¼ ê°€ë¦¬í‚¤ëŠ” í˜ì´ì§€ë¥¼ ì—´ë„ë¡ í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ ì •ë³´ëŠ” **ì¿ í‚¤(RU)**ì— ì €ì¥ë˜ê³  **ë‚˜ì¤‘ ë‹¨ê³„**ì—ì„œ **í”„ë¡¬í”„íŠ¸**ê°€ **ì‚¬ìš©ì**ì—ê²Œ ê³µê²©ìì˜ í˜¸ìŠ¤íŠ¸ì— ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í• ì§€ ë¬»ìŠµë‹ˆë‹¤.

ì´ í”„ë¡¬í”„íŠ¸ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´, **Oauth íë¦„**ì„ ì‹œì‘í•˜ëŠ” íƒ­ì„ ì—´ì–´ ì´ RU ì¿ í‚¤ë¥¼ **returnUrl**ì„ ì‚¬ìš©í•˜ì—¬ ì„¤ì •í•˜ê³ , í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë˜ê¸° ì „ì— íƒ­ì„ ë‹«ê³ , ê·¸ ê°’ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìƒˆ íƒ­ì„ ì—½ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ **í”„ë¡¬í”„íŠ¸ëŠ” ê³µê²©ìì˜ í˜¸ìŠ¤íŠ¸ì— ëŒ€í•´ ì•Œë¦¬ì§€ ì•Šì§€ë§Œ**, ì¿ í‚¤ëŠ” ì„¤ì •ë˜ì–´ **í† í°ì´ ë¦¬ë””ë ‰ì…˜ì—ì„œ ê³µê²©ìì˜ í˜¸ìŠ¤íŠ¸ë¡œ ì „ì†¡**ë©ë‹ˆë‹¤.

### Prompt Interaction Bypass <a href="#bda5" id="bda5"></a>

[**ì´ ë¹„ë””ì˜¤**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q)ì—ì„œ ì„¤ëª…ëœ ê²ƒì²˜ëŸ¼, ì¼ë¶€ OAuth êµ¬í˜„ì—ì„œëŠ” **`prompt`** GET ë§¤ê°œë³€ìˆ˜ë¥¼ None(**`&prompt=none`**)ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ **ì‚¬ìš©ìê°€ ì´ë¯¸ í”Œë«í¼ì— ë¡œê·¸ì¸ë˜ì–´ ìˆëŠ” ê²½ìš° í”„ë¡¬í”„íŠ¸ì—ì„œ ì£¼ì–´ì§„ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•˜ì§€ ì•Šë„ë¡** í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### response\_mode

[**ì´ ë¹„ë””ì˜¤**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q)ì—ì„œ ì„¤ëª…ëœ ê²ƒì²˜ëŸ¼, ìµœì¢… URLì—ì„œ ì½”ë“œë¥¼ ì œê³µí•  ìœ„ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ **`response_mode`** ë§¤ê°œë³€ìˆ˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* `response_mode=query` -> ì½”ë“œëŠ” GET ë§¤ê°œë³€ìˆ˜ ë‚´ì— ì œê³µë©ë‹ˆë‹¤: `?code=2397rf3gu93f`
* `response_mode=fragment` -> ì½”ë“œëŠ” URL í”„ë˜ê·¸ë¨¼íŠ¸ ë§¤ê°œë³€ìˆ˜ ë‚´ì— ì œê³µë©ë‹ˆë‹¤: `#code=2397rf3gu93f`
* `response_mode=form_post` -> ì½”ë“œëŠ” `code`ë¼ëŠ” ì…ë ¥ê³¼ ê°’ì´ ìˆëŠ” POST í¼ ë‚´ì— ì œê³µë©ë‹ˆë‹¤
* `response_mode=web_message` -> ì½”ë“œëŠ” post ë©”ì‹œì§€ë¡œ ì „ì†¡ë©ë‹ˆë‹¤: `window.opener.postMessage({"code": "asdasdasd...`

### SSRFs parameters <a href="#bda5" id="bda5"></a>

[**ì´ ì—°êµ¬**](https://portswigger.net/research/hidden-oauth-attack-vectors)ë¥¼ **ìì„¸íˆ í™•ì¸í•˜ì‹­ì‹œì˜¤.**

OAuthì˜ ë™ì  í´ë¼ì´ì–¸íŠ¸ ë“±ë¡ì€ **ì„œë²„ ì¸¡ ìš”ì²­ ìœ„ì¡°(SSRF)** ê³µê²©ì— ëŒ€í•œ ì¤‘ìš”í•œ ë²¡í„°ë¡œ ì‘ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì—”ë“œí¬ì¸íŠ¸ëŠ” OAuth ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ì„¸ë¶€ ì •ë³´ë¥¼ ìˆ˜ì‹ í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

**í•µì‹¬ í¬ì¸íŠ¸:**

* **ë™ì  í´ë¼ì´ì–¸íŠ¸ ë“±ë¡**ì€ ì¢…ì¢… `/register`ì— ë§¤í•‘ë˜ë©°, POST ìš”ì²­ì„ í†µí•´ `client_name`, `client_secret`, `redirect_uris`, ë¡œê³  ë˜ëŠ” JSON Web Key Sets(JWKs)ì˜ URLê³¼ ê°™ì€ ì„¸ë¶€ ì •ë³´ë¥¼ ìˆ˜ë½í•©ë‹ˆë‹¤.
* ì´ ê¸°ëŠ¥ì€ **RFC7591** ë° **OpenID Connect Registration 1.0**ì˜ ì‚¬ì–‘ì„ ë”°ë¥´ë©°, SSRFì— ì·¨ì•½í•  ìˆ˜ ìˆëŠ” ë§¤ê°œë³€ìˆ˜ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
* ë“±ë¡ í”„ë¡œì„¸ìŠ¤ëŠ” ì—¬ëŸ¬ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì„œë²„ë¥¼ SSRFì— ë…¸ì¶œì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
* **`logo_uri`**: ì„œë²„ê°€ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê³ ì˜ URLë¡œ, SSRFë¥¼ ìœ ë°œí•˜ê±°ë‚˜ URLì´ ì˜ëª» ì²˜ë¦¬ë˜ë©´ XSSë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`jwks_uri`**: í´ë¼ì´ì–¸íŠ¸ì˜ JWK ë¬¸ì„œì˜ URLë¡œ, ì•…ì˜ì ìœ¼ë¡œ ì¡°ì‘ëœ ê²½ìš° ì„œë²„ê°€ ê³µê²©ìê°€ ì œì–´í•˜ëŠ” ì„œë²„ë¡œ ì•„ì›ƒë°”ìš´ë“œ ìš”ì²­ì„ í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **`sector_identifier_uri`**: ì„œë²„ê°€ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” `redirect_uris`ì˜ JSON ë°°ì—´ì„ ì°¸ì¡°í•˜ì—¬ SSRF ê¸°íšŒë¥¼ ë§Œë“­ë‹ˆë‹¤.
* **`request_uris`**: í´ë¼ì´ì–¸íŠ¸ì— í—ˆìš©ëœ ìš”ì²­ URI ëª©ë¡ìœ¼ë¡œ, ì„œë²„ê°€ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì‹œ ì´ëŸ¬í•œ URIë¥¼ ê°€ì ¸ì˜¤ë©´ ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ê³µê²© ì „ëµ:**

* `logo_uri`, `jwks_uri`, ë˜ëŠ” `sector_identifier_uri`ì™€ ê°™ì€ ë§¤ê°œë³€ìˆ˜ì— ì•…ì˜ì ì¸ URLì„ í¬í•¨í•˜ì—¬ ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ë¥¼ ë“±ë¡í•¨ìœ¼ë¡œì¨ SSRFë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `request_uris`ë¥¼ í†µí•œ ì§ì ‘ì ì¸ ì•…ìš©ì€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì œì–´ë¡œ ì™„í™”ë  ìˆ˜ ìˆì§€ë§Œ, ì‚¬ì „ ë“±ë¡ëœ ê³µê²©ìê°€ ì œì–´í•˜ëŠ” `request_uri`ë¥¼ ì œê³µí•˜ì—¬ ì¸ì¦ ë‹¨ê³„ì—ì„œ SSRFë¥¼ ì´‰ì§„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## OAuth providers Race Conditions

í…ŒìŠ¤íŠ¸ ì¤‘ì¸ í”Œë«í¼ì´ OAuth ì œê³µìì¸ ê²½ìš° [**ì´ ë¬¸ì„œë¥¼ ì½ê³  ê°€ëŠ¥í•œ Race Conditionsì„ í…ŒìŠ¤íŠ¸í•˜ì‹­ì‹œì˜¤**](race-condition.md).

## References

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
