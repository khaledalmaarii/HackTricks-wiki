# OAuth åˆ°è´¦æˆ·æ¥ç®¡

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## åŸºæœ¬ä¿¡æ¯ <a href="#d4a8" id="d4a8"></a>

OAuth æä¾›å¤šç§ç‰ˆæœ¬ï¼ŒåŸºç¡€ä¿¡æ¯å¯åœ¨ [OAuth 2.0 æ–‡æ¡£](https://oauth.net/2/) ä¸­è·å–ã€‚æœ¬è®¨è®ºä¸»è¦é›†ä¸­åœ¨å¹¿æ³›ä½¿ç”¨çš„ [OAuth 2.0 æˆæƒç æˆæƒç±»å‹](https://oauth.net/2/grant-types/authorization-code/)ï¼Œæä¾›ä¸€ä¸ª **æˆæƒæ¡†æ¶ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿè®¿é—®æˆ–åœ¨å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­æ‰§è¡Œç”¨æˆ·è´¦æˆ·çš„æ“ä½œ**ï¼ˆæˆæƒæœåŠ¡å™¨ï¼‰ã€‚

è€ƒè™‘ä¸€ä¸ªå‡è®¾çš„ç½‘ç«™ _**https://example.com**_ï¼Œæ—¨åœ¨ **å±•ç¤ºæ‚¨æ‰€æœ‰çš„ç¤¾äº¤åª’ä½“å¸–å­**ï¼ŒåŒ…æ‹¬ç§äººå¸–å­ã€‚ä¸ºæ­¤ï¼Œé‡‡ç”¨ OAuth 2.0ã€‚_https://example.com_ å°†è¯·æ±‚æ‚¨çš„æƒé™ä»¥ **è®¿é—®æ‚¨çš„ç¤¾äº¤åª’ä½“å¸–å­**ã€‚å› æ­¤ï¼Œ_https://socialmedia.com_ ä¸Šä¼šå‡ºç°ä¸€ä¸ªåŒæ„å±å¹•ï¼Œæ¦‚è¿° **è¯·æ±‚çš„æƒé™å’Œå‘èµ·è¯·æ±‚çš„å¼€å‘è€…**ã€‚åœ¨æ‚¨æˆæƒåï¼Œ_https://example.com_ è·å¾— **ä»£è¡¨æ‚¨è®¿é—®æ‚¨çš„å¸–å­** çš„èƒ½åŠ›ã€‚

ç†è§£ OAuth 2.0 æ¡†æ¶ä¸­çš„ä»¥ä¸‹ç»„ä»¶è‡³å…³é‡è¦ï¼š

* **èµ„æºæ‹¥æœ‰è€…**ï¼šæ‚¨ï¼Œä½œä¸º **ç”¨æˆ·/å®ä½“**ï¼Œæˆæƒè®¿é—®æ‚¨çš„èµ„æºï¼Œä¾‹å¦‚æ‚¨çš„ç¤¾äº¤åª’ä½“è´¦æˆ·å¸–å­ã€‚
* **èµ„æºæœåŠ¡å™¨**ï¼šåœ¨åº”ç”¨ç¨‹åºä¸º `èµ„æºæ‹¥æœ‰è€…` è·å– `è®¿é—®ä»¤ç‰Œ` åï¼Œ**ç®¡ç†ç»è¿‡èº«ä»½éªŒè¯è¯·æ±‚çš„æœåŠ¡å™¨**ï¼Œä¾‹å¦‚ **https://socialmedia.com**ã€‚
* **å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº**ï¼š**å‘ `èµ„æºæ‹¥æœ‰è€…` è¯·æ±‚æˆæƒçš„åº”ç”¨ç¨‹åº**ï¼Œä¾‹å¦‚ **https://example.com**ã€‚
* **æˆæƒæœåŠ¡å™¨**ï¼šåœ¨æˆåŠŸéªŒè¯ `èµ„æºæ‹¥æœ‰è€…` å¹¶è·å¾—æˆæƒåï¼Œ**å‘ `å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº` å‘æ”¾ `è®¿é—®ä»¤ç‰Œ` çš„æœåŠ¡å™¨**ï¼Œä¾‹å¦‚ **https://socialmedia.com**ã€‚
* **client\_id**ï¼šåº”ç”¨ç¨‹åºçš„å…¬å…±å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
* **client\_secret**ï¼šä»…åº”ç”¨ç¨‹åºå’ŒæˆæƒæœåŠ¡å™¨çŸ¥é“çš„æœºå¯†å¯†é’¥ï¼Œç”¨äºç”Ÿæˆ `è®¿é—®ä»¤ç‰Œ`ã€‚
* **response\_type**ï¼šæŒ‡å®š **è¯·æ±‚çš„ä»¤ç‰Œç±»å‹** çš„å€¼ï¼Œä¾‹å¦‚ `code`ã€‚
* **scope**ï¼š`å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº` è¯·æ±‚çš„ **è®¿é—®çº§åˆ«**ã€‚
* **redirect\_uri**ï¼šç”¨æˆ·åœ¨æˆæƒåè¢«é‡å®šå‘çš„ **URL**ã€‚è¿™é€šå¸¸å¿…é¡»ä¸é¢„æ³¨å†Œçš„é‡å®šå‘ URL ä¸€è‡´ã€‚
* **state**ï¼šä¸€ä¸ªå‚æ•°ï¼Œç”¨äº **åœ¨ç”¨æˆ·é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨åŠè¿”å›æ—¶ç»´æŠ¤æ•°æ®**ã€‚å…¶å”¯ä¸€æ€§å¯¹äºä½œä¸º **CSRF ä¿æŠ¤æœºåˆ¶** è‡³å…³é‡è¦ã€‚
* **grant\_type**ï¼šæŒ‡ç¤º **æˆæƒç±»å‹å’Œè¦è¿”å›çš„ä»¤ç‰Œç±»å‹** çš„å‚æ•°ã€‚
* **code**ï¼šæ¥è‡ª `æˆæƒæœåŠ¡å™¨` çš„æˆæƒç ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸ `client_id` å’Œ `client_secret` ä¸€èµ·ä½¿ç”¨ä»¥è·å– `è®¿é—®ä»¤ç‰Œ`ã€‚
* **access\_token**ï¼šå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä»£è¡¨ `èµ„æºæ‹¥æœ‰è€…` ç”¨äº API è¯·æ±‚çš„ **ä»¤ç‰Œ**ã€‚
* **refresh\_token**ï¼šä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿ **åœ¨ä¸é‡æ–°æç¤ºç”¨æˆ·çš„æƒ…å†µä¸‹è·å–æ–°çš„ `è®¿é—®ä»¤ç‰Œ`**ã€‚

### æµç¨‹

**å®é™…çš„ OAuth æµç¨‹**å¦‚ä¸‹ï¼š

1. æ‚¨å¯¼èˆªåˆ° [https://example.com](https://example.com) å¹¶é€‰æ‹©â€œä¸ç¤¾äº¤åª’ä½“é›†æˆâ€æŒ‰é’®ã€‚
2. ç„¶åè¯¥ç½‘ç«™å‘ [https://socialmedia.com](https://socialmedia.com) å‘é€è¯·æ±‚ï¼Œè¯·æ±‚æ‚¨çš„æˆæƒä»¥è®© https://example.com çš„åº”ç”¨ç¨‹åºè®¿é—®æ‚¨çš„å¸–å­ã€‚è¯·æ±‚çš„ç»“æ„ä¸ºï¼š
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. ç„¶åæ‚¨å°†çœ‹åˆ°ä¸€ä¸ªåŒæ„é¡µé¢ã€‚  
4. åœ¨æ‚¨æ‰¹å‡†åï¼Œç¤¾äº¤åª’ä½“ä¼šå‘ `redirect_uri` å‘é€ä¸€ä¸ªåŒ…å« `code` å’Œ `state` å‚æ•°çš„å“åº”ï¼š
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com åˆ©ç”¨è¿™ä¸ª `code`ï¼Œè¿åŒå®ƒçš„ `client_id` å’Œ `client_secret`ï¼Œå‘èµ·æœåŠ¡å™¨ç«¯è¯·æ±‚ä»¥ä»£è¡¨æ‚¨è·å– `access_token`ï¼Œä»è€Œè®¿é—®æ‚¨åŒæ„çš„æƒé™ï¼š
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. æœ€åï¼Œè¿‡ç¨‹ç»“æŸæ—¶ï¼Œhttps://example.com ä½¿ç”¨ä½ çš„ `access_token` å‘ç¤¾äº¤åª’ä½“å‘èµ· API è°ƒç”¨ä»¥è®¿é—®

## Vulnerabilities <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri` å¯¹äº OAuth å’Œ OpenID å®ç°çš„å®‰å…¨æ€§è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒæŒ‡ç¤ºåœ¨æˆæƒåæ•æ„Ÿæ•°æ®ï¼ˆå¦‚æˆæƒä»£ç ï¼‰å‘é€åˆ°ä½•å¤„ã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šå…è®¸æ”»å‡»è€…å°†è¿™äº›è¯·æ±‚é‡å®šå‘åˆ°æ¶æ„æœåŠ¡å™¨ï¼Œä»è€Œå®ç°è´¦æˆ·æ¥ç®¡ã€‚

åˆ©ç”¨æŠ€æœ¯æ ¹æ®æˆæƒæœåŠ¡å™¨çš„éªŒè¯é€»è¾‘è€Œå¼‚ã€‚å®ƒä»¬å¯ä»¥ä»ä¸¥æ ¼çš„è·¯å¾„åŒ¹é…åˆ°æ¥å—æŒ‡å®šåŸŸæˆ–å­ç›®å½•å†…çš„ä»»ä½• URLã€‚å¸¸è§çš„åˆ©ç”¨æ–¹æ³•åŒ…æ‹¬å¼€æ”¾é‡å®šå‘ã€è·¯å¾„éå†ã€åˆ©ç”¨å¼±æ­£åˆ™è¡¨è¾¾å¼å’Œ HTML æ³¨å…¥è¿›è¡Œä»¤ç‰Œçªƒå–ã€‚

é™¤äº† `redirect_uri`ï¼Œå…¶ä»– OAuth å’Œ OpenID å‚æ•°å¦‚ `client_uri`ã€`policy_uri`ã€`tos_uri` å’Œ `initiate_login_uri` ä¹Ÿå®¹æ˜“å—åˆ°é‡å®šå‘æ”»å‡»ã€‚è¿™äº›å‚æ•°æ˜¯å¯é€‰çš„ï¼Œå…¶æ”¯æŒåœ¨ä¸åŒæœåŠ¡å™¨ä¹‹é—´æœ‰æ‰€ä¸åŒã€‚

å¯¹äºé‚£äº›é’ˆå¯¹ OpenID æœåŠ¡å™¨çš„æ”»å‡»è€…ï¼Œå‘ç°ç«¯ç‚¹ï¼ˆ`**.well-known/openid-configuration**`ï¼‰é€šå¸¸åˆ—å‡ºæœ‰ä»·å€¼çš„é…ç½®ç»†èŠ‚ï¼Œå¦‚ `registration_endpoint`ã€`request_uri_parameter_supported` å’Œ "`require_request_uri_registration`ã€‚è¿™äº›ç»†èŠ‚å¯ä»¥å¸®åŠ©è¯†åˆ«æ³¨å†Œç«¯ç‚¹å’ŒæœåŠ¡å™¨çš„å…¶ä»–é…ç½®ç»†èŠ‚ã€‚

### XSS in redirect implementation <a href="#bda5" id="bda5"></a>

æ­£å¦‚åœ¨è¿™ä¸ªæ¼æ´èµé‡‘æŠ¥å‘Šä¸­æåˆ°çš„ [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html)ï¼Œé‡å®šå‘ **URL å¯èƒ½åœ¨ç”¨æˆ·è®¤è¯åè¢«åå°„åœ¨æœåŠ¡å™¨çš„å“åº”ä¸­**ï¼Œå› æ­¤ **å®¹æ˜“å—åˆ° XSS æ”»å‡»**ã€‚å¯ä»¥æµ‹è¯•çš„æœ‰æ•ˆè½½è·ï¼š
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Improper handling of state parameter <a href="#bda5" id="bda5"></a>

åœ¨OAuthå®ç°ä¸­ï¼Œ**`state`å‚æ•°**çš„è¯¯ç”¨æˆ–é—æ¼ä¼šæ˜¾è‘—å¢åŠ **è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰**æ”»å‡»çš„é£é™©ã€‚å½“`state`å‚æ•°**æœªä½¿ç”¨ã€ä½œä¸ºé™æ€å€¼ä½¿ç”¨æˆ–æœªæ­£ç¡®éªŒè¯**æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥ç»•è¿‡CSRFä¿æŠ¤ï¼Œä»è€Œäº§ç”Ÿæ­¤æ¼æ´ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡æ‹¦æˆªæˆæƒè¿‡ç¨‹ï¼Œå°†ä»–ä»¬çš„è´¦æˆ·ä¸å—å®³è€…çš„è´¦æˆ·å…³è”ï¼Œä»è€Œå¯¼è‡´æ½œåœ¨çš„**è´¦æˆ·æ¥ç®¡**ã€‚åœ¨ä½¿ç”¨OAuthè¿›è¡Œ**èº«ä»½éªŒè¯**çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™ä¸€ç‚¹å°¤å…¶å…³é”®ã€‚

åœ¨å„ç§**CTFæŒ‘æˆ˜**å’Œ**é»‘å®¢å¹³å°**ä¸­è®°å½•äº†æ­¤æ¼æ´çš„çœŸå®æ¡ˆä¾‹ï¼Œçªæ˜¾äº†å…¶å®é™…å½±å“ã€‚è¯¥é—®é¢˜è¿˜æ‰©å±•åˆ°ä¸ç¬¬ä¸‰æ–¹æœåŠ¡çš„é›†æˆï¼Œå¦‚**Slack**ã€**Stripe**å’Œ**PayPal**ï¼Œæ”»å‡»è€…å¯ä»¥å°†é€šçŸ¥æˆ–ä»˜æ¬¾é‡å®šå‘åˆ°ä»–ä»¬çš„è´¦æˆ·ã€‚

æ­£ç¡®å¤„ç†å’ŒéªŒè¯**`state`å‚æ•°**å¯¹äºé˜²èŒƒCSRFå’Œä¿æŠ¤OAuthæµç¨‹è‡³å…³é‡è¦ã€‚

### Pre Account Takeover <a href="#ebe4" id="ebe4"></a>

1. **åœ¨è´¦æˆ·åˆ›å»ºæ—¶æœªè¿›è¡Œç”µå­é‚®ä»¶éªŒè¯**ï¼šæ”»å‡»è€…å¯ä»¥é¢„å…ˆä½¿ç”¨å—å®³è€…çš„ç”µå­é‚®ä»¶åˆ›å»ºè´¦æˆ·ã€‚å¦‚æœå—å®³è€…ç¨åä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ç™»å½•ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šä¸ç»æ„åœ°å°†æ­¤ç¬¬ä¸‰æ–¹è´¦æˆ·é“¾æ¥åˆ°æ”»å‡»è€…é¢„å…ˆåˆ›å»ºçš„è´¦æˆ·ï¼Œä»è€Œå¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚
2. **åˆ©ç”¨å®½æ¾çš„OAuthç”µå­é‚®ä»¶éªŒè¯**ï¼šæ”»å‡»è€…å¯èƒ½ä¼šåˆ©ç”¨ä¸éªŒè¯ç”µå­é‚®ä»¶çš„OAuthæœåŠ¡ï¼Œé€šè¿‡æ³¨å†Œå…¶æœåŠ¡å¹¶å°†è´¦æˆ·ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºå—å®³è€…çš„ç”µå­é‚®ä»¶æ¥è¿›è¡Œæ”»å‡»ã€‚è¿™ç§æ–¹æ³•åŒæ ·å­˜åœ¨æœªç»æˆæƒçš„è´¦æˆ·è®¿é—®é£é™©ï¼Œç±»ä¼¼äºç¬¬ä¸€ç§æƒ…å†µï¼Œä½†é€šè¿‡ä¸åŒçš„æ”»å‡»å‘é‡ã€‚

### Disclosure of Secrets <a href="#e177" id="e177"></a>

è¯†åˆ«å’Œä¿æŠ¤ç§˜å¯†çš„OAuthå‚æ•°è‡³å…³é‡è¦ã€‚è™½ç„¶**`client_id`**å¯ä»¥å®‰å…¨æŠ«éœ²ï¼Œä½†æ³„éœ²**`client_secret`**ä¼šå¸¦æ¥é‡å¤§é£é™©ã€‚å¦‚æœ`client_secret`è¢«æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨åº”ç”¨ç¨‹åºçš„èº«ä»½å’Œä¿¡ä»»æ¥**çªƒå–ç”¨æˆ·çš„`access_tokens`**å’Œç§äººä¿¡æ¯ã€‚

ä¸€ä¸ªå¸¸è§çš„æ¼æ´å‡ºç°åœ¨åº”ç”¨ç¨‹åºé”™è¯¯åœ°åœ¨å®¢æˆ·ç«¯è€Œä¸æ˜¯æœåŠ¡å™¨ç«¯å¤„ç†æˆæƒ`code`ä¸`access_token`çš„äº¤æ¢æ—¶ã€‚è¿™ä¸ªé”™è¯¯å¯¼è‡´`client_secret`çš„æš´éœ²ï¼Œä½¿æ”»å‡»è€…èƒ½å¤Ÿä»¥åº”ç”¨ç¨‹åºçš„åä¹‰ç”Ÿæˆ`access_tokens`ã€‚æ­¤å¤–ï¼Œé€šè¿‡ç¤¾ä¼šå·¥ç¨‹å­¦ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‘OAuthæˆæƒæ·»åŠ é¢å¤–çš„èŒƒå›´æ¥æå‡æƒé™ï¼Œè¿›ä¸€æ­¥åˆ©ç”¨åº”ç”¨ç¨‹åºçš„ä¿¡ä»»çŠ¶æ€ã€‚

### Client Secret Bruteforce

æ‚¨å¯ä»¥å°è¯•**æš´åŠ›ç ´è§£æœåŠ¡æä¾›å•†çš„client\_secret**ä¸èº«ä»½æä¾›è€…ï¼Œä»¥è¯•å›¾çªƒå–è´¦æˆ·ã€‚\
æš´åŠ›ç ´è§£çš„è¯·æ±‚å¯èƒ½ç±»ä¼¼äºï¼š
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header leaking Code + State

ä¸€æ—¦å®¢æˆ·ç«¯æ‹¥æœ‰äº† **code å’Œ state**ï¼Œå¦‚æœå®ƒä»¬åœ¨æµè§ˆåˆ°ä¸åŒé¡µé¢æ—¶ **åæ˜ åœ¨ Referer å¤´ä¸­**ï¼Œé‚£ä¹ˆå®ƒå°±å­˜åœ¨æ¼æ´ã€‚

### Access Token Stored in Browser History

å‰å¾€ **æµè§ˆå™¨å†å²è®°å½•å¹¶æ£€æŸ¥è®¿é—®ä»¤ç‰Œæ˜¯å¦ä¿å­˜åœ¨å…¶ä¸­**ã€‚

### Everlasting Authorization Code

**æˆæƒä»£ç åº”è¯¥åªå­˜åœ¨ä¸€æ®µæ—¶é—´ï¼Œä»¥é™åˆ¶æ”»å‡»è€…å¯ä»¥çªƒå–å’Œä½¿ç”¨å®ƒçš„æ—¶é—´çª—å£**ã€‚

### Authorization/Refresh Token not bound to client

å¦‚æœä½ å¯ä»¥è·å– **æˆæƒä»£ç å¹¶åœ¨ä¸åŒçš„å®¢æˆ·ç«¯ä¸Šä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆä½ å¯ä»¥æ¥ç®¡å…¶ä»–è´¦æˆ·**ã€‚

### Happy Paths, XSS, Iframes & Post Messages to leak code & state values

[**æŸ¥çœ‹æ­¤å¸–å­**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

åœ¨è¿™ä¸ªæ¼æ´èµé‡‘æŠ¥å‘Šä¸­ï¼š[**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) ä½ å¯ä»¥çœ‹åˆ° **AWS Cognito** è¿”å›ç»™ç”¨æˆ·çš„ **ä»¤ç‰Œ** å¯èƒ½å…·æœ‰ **è¶³å¤Ÿçš„æƒé™æ¥è¦†ç›–ç”¨æˆ·æ•°æ®**ã€‚å› æ­¤ï¼Œå¦‚æœä½ å¯ä»¥ **å°†ç”¨æˆ·ç”µå­é‚®ä»¶æ›´æ”¹ä¸ºå…¶ä»–ç”¨æˆ·ç”µå­é‚®ä»¶**ï¼Œä½ å¯èƒ½èƒ½å¤Ÿ **æ¥ç®¡** å…¶ä»–è´¦æˆ·ã€‚
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
For more detailed info about how to abuse AWS cognito check:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abusing other Apps tokens <a href="#bda5" id="bda5"></a>

æ­£å¦‚[**åœ¨è¿™ç¯‡æ–‡ç« ä¸­æåˆ°çš„**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts)ï¼ŒæœŸæœ›æ¥æ”¶**token**ï¼ˆè€Œä¸æ˜¯ä»£ç ï¼‰çš„OAuthæµç¨‹å¯èƒ½ä¼šå—åˆ°æ”»å‡»ï¼Œå¦‚æœå®ƒä»¬æ²¡æœ‰æ£€æŸ¥tokenæ˜¯å¦å±äºè¯¥åº”ç”¨ç¨‹åºã€‚

è¿™æ˜¯å› ä¸º**æ”»å‡»è€…**å¯ä»¥åœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ª**æ”¯æŒOAuthå¹¶ä½¿ç”¨Facebookç™»å½•çš„åº”ç”¨**ï¼ˆä¾‹å¦‚ï¼‰ã€‚ç„¶åï¼Œä¸€æ—¦å—å®³è€…åœ¨**æ”»å‡»è€…çš„åº”ç”¨ç¨‹åº**ä¸­ä½¿ç”¨Facebookç™»å½•ï¼Œæ”»å‡»è€…å°±å¯ä»¥è·å–**åˆ†é…ç»™å…¶åº”ç”¨ç¨‹åºçš„ç”¨æˆ·çš„OAuth tokenï¼Œå¹¶ä½¿ç”¨è¯¥tokenåœ¨å—å®³è€…çš„OAuthåº”ç”¨ç¨‹åºä¸­ç™»å½•**ã€‚

{% hint style="danger" %}
å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…è®¾æ³•è®©ç”¨æˆ·è®¿é—®è‡ªå·±çš„OAuthåº”ç”¨ç¨‹åºï¼Œä»–å°†èƒ½å¤Ÿåœ¨æœŸæœ›tokenä¸”æœªæ£€æŸ¥tokenæ˜¯å¦æˆäºˆå…¶åº”ç”¨IDçš„åº”ç”¨ç¨‹åºä¸­æ¥ç®¡å—å®³è€…çš„è´¦æˆ·ã€‚
{% endhint %}

### Two links & cookie <a href="#bda5" id="bda5"></a>

æ ¹æ®[**è¿™ç¯‡æ–‡ç« **](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f)ï¼Œå¯ä»¥è®©å—å®³è€…æ‰“å¼€ä¸€ä¸ªæŒ‡å‘æ”»å‡»è€…ä¸»æœºçš„**returnUrl**é¡µé¢ã€‚æ­¤ä¿¡æ¯å°†è¢«**å­˜å‚¨åœ¨cookieï¼ˆRUï¼‰**ä¸­ï¼Œåœ¨**åç»­æ­¥éª¤**ä¸­ï¼Œ**æç¤º**å°†**è¯¢é—®**ç”¨æˆ·æ˜¯å¦å¸Œæœ›æˆäºˆå¯¹è¯¥æ”»å‡»è€…ä¸»æœºçš„è®¿é—®æƒé™ã€‚

ä¸ºäº†ç»•è¿‡æ­¤æç¤ºï¼Œå¯ä»¥æ‰“å¼€ä¸€ä¸ªé€‰é¡¹å¡ä»¥å¯åŠ¨**Oauthæµç¨‹**ï¼Œè¯¥æµç¨‹å°†ä½¿ç”¨**returnUrl**è®¾ç½®æ­¤RU cookieï¼Œåœ¨æç¤ºæ˜¾ç¤ºä¹‹å‰å…³é—­é€‰é¡¹å¡ï¼Œç„¶åæ‰“å¼€ä¸€ä¸ªæ²¡æœ‰è¯¥å€¼çš„æ–°é€‰é¡¹å¡ã€‚ç„¶åï¼Œ**æç¤ºä¸ä¼šé€šçŸ¥æ”»å‡»è€…çš„ä¸»æœº**ï¼Œä½†cookieå°†è¢«è®¾ç½®ä¸ºå®ƒï¼Œå› æ­¤**tokenå°†åœ¨é‡å®šå‘ä¸­å‘é€åˆ°æ”»å‡»è€…çš„ä¸»æœº**ã€‚

### Prompt Interaction Bypass <a href="#bda5" id="bda5"></a>

æ­£å¦‚[**åœ¨è¿™æ®µè§†é¢‘ä¸­è§£é‡Šçš„**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q)ï¼Œä¸€äº›OAuthå®ç°å…è®¸å°†**`prompt`** GETå‚æ•°æŒ‡ç¤ºä¸ºNoneï¼ˆ**`&prompt=none`**ï¼‰ï¼Œä»¥**é˜²æ­¢ç”¨æˆ·åœ¨å·²ç™»å½•å¹³å°æ—¶è¢«è¦æ±‚ç¡®è®¤**æ‰€æˆäºˆçš„è®¿é—®æƒé™ã€‚

### response\_mode

æ­£å¦‚[**åœ¨è¿™æ®µè§†é¢‘ä¸­è§£é‡Šçš„**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q)ï¼Œå¯èƒ½å¯ä»¥æŒ‡ç¤ºå‚æ•°**`response_mode`**ä»¥æŒ‡ç¤ºå¸Œæœ›åœ¨æœ€ç»ˆURLä¸­æä¾›ä»£ç çš„ä½ç½®ï¼š

* `response_mode=query` -> ä»£ç åœ¨GETå‚æ•°ä¸­æä¾›ï¼š`?code=2397rf3gu93f`
* `response_mode=fragment` -> ä»£ç åœ¨URLç‰‡æ®µå‚æ•°ä¸­æä¾›`#code=2397rf3gu93f`
* `response_mode=form_post` -> ä»£ç åœ¨ä¸€ä¸ªåä¸º`code`çš„POSTè¡¨å•ä¸­çš„è¾“å…¥ä¸­æä¾›
* `response_mode=web_message` -> ä»£ç é€šè¿‡postæ¶ˆæ¯å‘é€ï¼š`window.opener.postMessage({"code": "asdasdasd...`

### SSRFs parameters <a href="#bda5" id="bda5"></a>

[**æŸ¥çœ‹è¿™é¡¹ç ”ç©¶**](https://portswigger.net/research/hidden-oauth-attack-vectors) **ä»¥è·å–æ­¤æŠ€æœ¯çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚**

OAuthä¸­çš„åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œä½œä¸ºä¸€ä¸ªä¸å¤ªæ˜æ˜¾ä½†å…³é”®çš„å®‰å…¨æ¼æ´å‘é‡ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹**æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰**æ”»å‡»ã€‚æ­¤ç«¯ç‚¹å…è®¸OAuthæœåŠ¡å™¨æ¥æ”¶æœ‰å…³å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯èƒ½è¢«åˆ©ç”¨çš„æ•æ„ŸURLã€‚

**å…³é”®ç‚¹ï¼š**

* **åŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ**é€šå¸¸æ˜ å°„åˆ°`/register`ï¼Œå¹¶æ¥å—å¦‚`client_name`ã€`client_secret`ã€`redirect_uris`å’Œé€šè¿‡POSTè¯·æ±‚çš„logoæˆ–JSON Web Key Setsï¼ˆJWKsï¼‰URLç­‰è¯¦ç»†ä¿¡æ¯ã€‚
* æ­¤åŠŸèƒ½éµå¾ª**RFC7591**å’Œ**OpenID Connect Registration 1.0**ä¸­åˆ—å‡ºçš„è§„èŒƒï¼Œå…¶ä¸­åŒ…æ‹¬å¯èƒ½å¯¹SSRFæ˜“å—æ”»å‡»çš„å‚æ•°ã€‚
* æ³¨å†Œè¿‡ç¨‹å¯èƒ½ä¼šä»¥å¤šç§æ–¹å¼æ— æ„ä¸­ä½¿æœåŠ¡å™¨æš´éœ²äºSSRFï¼š
* **`logo_uri`**ï¼šå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºlogoçš„URLï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè·å–è¯¥URLï¼Œä»è€Œè§¦å‘SSRFæˆ–å¯¼è‡´XSSï¼ˆå¦‚æœURLå¤„ç†ä¸å½“ï¼‰ã€‚
* **`jwks_uri`**ï¼šå®¢æˆ·ç«¯JWKæ–‡æ¡£çš„URLï¼Œå¦‚æœæ¶æ„æ„é€ ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å™¨å‘æ”»å‡»è€…æ§åˆ¶çš„æœåŠ¡å™¨å‘å‡ºå¤–éƒ¨è¯·æ±‚ã€‚
* **`sector_identifier_uri`**ï¼šå¼•ç”¨`redirect_uris`çš„JSONæ•°ç»„ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šè·å–ï¼Œä»è€Œåˆ›å»ºSSRFæœºä¼šã€‚
* **`request_uris`**ï¼šåˆ—å‡ºå®¢æˆ·ç«¯å…è®¸çš„è¯·æ±‚URIï¼Œå¦‚æœæœåŠ¡å™¨åœ¨æˆæƒè¿‡ç¨‹å¼€å§‹æ—¶è·å–è¿™äº›URIï¼Œåˆ™å¯èƒ½è¢«åˆ©ç”¨ã€‚

**åˆ©ç”¨ç­–ç•¥ï¼š**

* é€šè¿‡åœ¨`logo_uri`ã€`jwks_uri`æˆ–`sector_identifier_uri`ç­‰å‚æ•°ä¸­æ³¨å†Œå¸¦æœ‰æ¶æ„URLçš„æ–°å®¢æˆ·ç«¯ï¼Œå¯ä»¥è§¦å‘SSRFã€‚
* å°½ç®¡é€šè¿‡ç™½åå•æ§åˆ¶å¯èƒ½ä¼šå‡è½»ç›´æ¥é€šè¿‡`request_uris`çš„åˆ©ç”¨ï¼Œä½†æä¾›ä¸€ä¸ªé¢„å…ˆæ³¨å†Œçš„ã€æ”»å‡»è€…æ§åˆ¶çš„`request_uri`å¯ä»¥åœ¨æˆæƒé˜¶æ®µä¿ƒè¿›SSRFã€‚

## OAuth providers Race Conditions

å¦‚æœæ‚¨æ­£åœ¨æµ‹è¯•çš„å¹³å°æ˜¯OAuthæä¾›è€…[**è¯·é˜…è¯»æ­¤æ–‡ä»¥æµ‹è¯•å¯èƒ½çš„ç«äº‰æ¡ä»¶**](race-condition.md)ã€‚

## References

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
