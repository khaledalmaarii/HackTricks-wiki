# OAuth to Account takeover

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Basic Information <a href="#d4a8" id="d4a8"></a>

OAuth nudi razliÄite verzije, sa osnovnim uvidima dostupnim na [OAuth 2.0 documentation](https://oauth.net/2/). Ova diskusija se prvenstveno fokusira na Å¡iroko koriÅ¡Ä‡eni [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/), pruÅ¾ajuÄ‡i **okvir autorizacije koji omoguÄ‡ava aplikaciji da pristupi ili izvrÅ¡i radnje na korisniÄkom nalogu u drugoj aplikaciji** (server za autorizaciju).

Zamislite hipotetiÄku veb stranicu _**https://example.com**_, dizajniranu da **prikaÅ¾e sve vaÅ¡e objave na druÅ¡tvenim mreÅ¾ama**, ukljuÄujuÄ‡i privatne. Da bi to postigla, koristi se OAuth 2.0. _https://example.com_ Ä‡e zatraÅ¾iti vaÅ¡u dozvolu da **pristupi vaÅ¡im objavama na druÅ¡tvenim mreÅ¾ama**. Kao rezultat toga, na _https://socialmedia.com_ Ä‡e se pojaviti ekran za saglasnost, koji Ä‡e prikazati **dozvole koje se traÅ¾e i programera koji podnosi zahtev**. Nakon vaÅ¡e autorizacije, _https://example.com_ dobija moguÄ‡nost da **pristupi vaÅ¡im objavama u vaÅ¡e ime**.

VaÅ¾no je razumeti sledeÄ‡e komponente unutar OAuth 2.0 okvira:

* **resource owner**: Vi, kao **korisnik/entitet**, autorizujete pristup vaÅ¡em resursu, kao Å¡to su objave na vaÅ¡em nalogu na druÅ¡tvenim mreÅ¾ama.
* **resource server**: **server koji upravlja autentifikovanim zahtevima** nakon Å¡to je aplikacija obezbedila `access token` u ime `resource owner`, npr. **https://socialmedia.com**.
* **client application**: **aplikacija koja traÅ¾i autorizaciju** od `resource owner`, kao Å¡to je **https://example.com**.
* **authorization server**: **server koji izdaje `access tokens`** `client application` nakon uspeÅ¡ne autentifikacije `resource owner` i obezbeÄ‘ivanja autorizacije, npr. **https://socialmedia.com**.
* **client\_id**: Javni, jedinstveni identifikator za aplikaciju.
* **client\_secret:** Tajni kljuÄ, poznat samo aplikaciji i serveru za autorizaciju, koji se koristi za generisanje `access_tokens`.
* **response\_type**: Vrednost koja specificira **tip tokena koji se traÅ¾i**, kao Å¡to je `code`.
* **scope**: **nivo pristupa** koji `client application` traÅ¾i od `resource owner`.
* **redirect\_uri**: **URL na koji se korisnik preusmerava nakon autorizacije**. Ovo obiÄno mora biti u skladu sa unapred registrovanim URL-om za preusmeravanje.
* **state**: Parametar za **odrÅ¾avanje podataka tokom preusmeravanja korisnika ka i sa servera za autorizaciju**. Njegova jedinstvenost je kljuÄna za sluÅ¾enje kao **mehanizam zaÅ¡tite od CSRF**.
* **grant\_type**: Parametar koji oznaÄava **tip granta i tip tokena koji Ä‡e biti vraÄ‡en**.
* **code**: Autorizacioni kod sa `authorization server`, koji se koristi zajedno sa `client_id` i `client_secret` od strane klijentske aplikacije za dobijanje `access_token`.
* **access\_token**: **token koji klijentska aplikacija koristi za API zahteve** u ime `resource owner`.
* **refresh\_token**: OmoguÄ‡ava aplikaciji da **dobije novi `access_token` bez ponovnog traÅ¾enja od korisnika**.

### Flow

**Aktuelni OAuth tok** se odvija na sledeÄ‡i naÄin:

1. Idete na [https://example.com](https://example.com) i birate dugme â€œIntegrate with Social Mediaâ€.
2. Sajt zatim Å¡alje zahtev na [https://socialmedia.com](https://socialmedia.com) traÅ¾eÄ‡i vaÅ¡u autorizaciju da aplikacija https://example.com pristupi vaÅ¡im objavama. Zahtev je strukturiran kao:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Zatim se prikazuje stranica za pristanak.  
4. Nakon vaÅ¡eg odobrenja, Social Media Å¡alje odgovor na `redirect_uri` sa `code` i `state` parametrima:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com koristi ovaj `code`, zajedno sa svojim `client_id` i `client_secret`, da izvrÅ¡i zahtev sa servera kako bi dobio `access_token` u vaÅ¡e ime, omoguÄ‡avajuÄ‡i pristup dozvolama na koje ste pristali:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Na kraju, proces se zavrÅ¡ava kada https://example.com koristi vaÅ¡ `access_token` za API poziv ka druÅ¡tvenim mreÅ¾ama kako bi pristupio

## Ranljivosti <a href="#id-323a" id="id-323a"></a>

### Otvoreni redirect\_uri <a href="#cc36" id="cc36"></a>

`redirect_uri` je kljuÄan za bezbednost u OAuth i OpenID implementacijama, jer usmerava gde se osetljivi podaci, poput autorizacionih kodova, Å¡alju nakon autorizacije. Ako je pogreÅ¡no konfigurisano, moÅ¾e omoguÄ‡iti napadaÄima da preusmere ove zahteve na zlonamerne servere, omoguÄ‡avajuÄ‡i preuzimanje naloga.

Tehnike eksploatacije variraju u zavisnosti od logike validacije autorizacionog servera. Mogu se kretati od stroge provere putanje do prihvatanja bilo kog URL-a unutar specificirane domene ili poddirektorijuma. UobiÄajene metode eksploatacije ukljuÄuju otvorene redirekcije, prelazak putanje, iskoriÅ¡Ä‡avanje slabih regex-a i HTML injekciju za kraÄ‘u tokena.

Pored `redirect_uri`, drugi OAuth i OpenID parametri kao Å¡to su `client_uri`, `policy_uri`, `tos_uri` i `initiate_login_uri` su takoÄ‘e podloÅ¾ni napadima preusmeravanja. Ovi parametri su opcioni i njihova podrÅ¡ka varira meÄ‘u serverima.

Za one koji ciljaju OpenID server, krajnja taÄka otkrivanja (`**.well-known/openid-configuration**`) Äesto navodi vredne detalje o konfiguraciji kao Å¡to su `registration_endpoint`, `request_uri_parameter_supported` i "`require_request_uri_registration`. Ovi detalji mogu pomoÄ‡i u identifikaciji krajnje taÄke registracije i drugih specifiÄnosti konfiguracije servera.

### XSS u implementaciji preusmeravanja <a href="#bda5" id="bda5"></a>

Kao Å¡to je pomenuto u ovom izveÅ¡taju o nagradama za greÅ¡ke [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), moÅ¾e biti moguÄ‡e da se **URL preusmeravanja odraÅ¾ava u odgovoru** servera nakon Å¡to se korisnik autentifikuje, Å¡to ga Äini **ranjivim na XSS**. MoguÄ‡i payload za testiranje:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Nepravilno rukovanje parametrom stanja <a href="#bda5" id="bda5"></a>

U OAuth implementacijama, zloupotreba ili izostavljanje **`state` parametra** moÅ¾e znaÄajno poveÄ‡ati rizik od **Cross-Site Request Forgery (CSRF)** napada. Ova ranjivost nastaje kada se `state` parametar ili **ne koristi, koristi kao statiÄka vrednost, ili se nevalidira pravilno**, omoguÄ‡avajuÄ‡i napadaÄima da zaobiÄ‘u CSRF zaÅ¡titu.

NapadaÄi mogu iskoristiti ovo presreÄ‡uÄ‡i proces autorizacije kako bi povezali svoj nalog sa nalogom Å¾rtve, Å¡to moÅ¾e dovesti do potencijalnih **preuzimanja naloga**. Ovo je posebno kritiÄno u aplikacijama gde se OAuth koristi za **autentifikacione svrhe**.

Primeri iz stvarnog sveta ove ranjivosti dokumentovani su u raznim **CTF izazovima** i **hacking platformama**, istiÄuÄ‡i njene praktiÄne implikacije. Problem se takoÄ‘e proÅ¡iruje na integracije sa uslugama treÄ‡ih strana kao Å¡to su **Slack**, **Stripe**, i **PayPal**, gde napadaÄi mogu preusmeriti obaveÅ¡tenja ili uplate na svoje naloge.

Pravilno rukovanje i validacija **`state` parametra** su kljuÄni za zaÅ¡titu od CSRF i osiguranje OAuth toka.

### Preuzimanje naloga <a href="#ebe4" id="ebe4"></a>

1. **Bez verifikacije e-poÅ¡te prilikom kreiranja naloga**: NapadaÄi mogu unapred kreirati nalog koristeÄ‡i e-poÅ¡tu Å¾rtve. Ako Å¾rtva kasnije koristi uslugu treÄ‡e strane za prijavu, aplikacija moÅ¾e nenamerno povezati ovaj nalog treÄ‡e strane sa napadaÄevim unapred kreiranim nalogom, Å¡to dovodi do neovlaÅ¡Ä‡enog pristupa.
2. **IskoriÅ¡Ä‡avanje labave verifikacije e-poÅ¡te u OAuth-u**: NapadaÄi mogu iskoristiti OAuth usluge koje ne verifikuju e-poÅ¡tu tako Å¡to se registruju sa svojom uslugom, a zatim menjaju e-poÅ¡tu naloga na onu Å¾rtve. Ova metoda takoÄ‘e nosi rizik od neovlaÅ¡Ä‡enog pristupa nalogu, sliÄno prvom scenariju, ali kroz drugaÄiji napadaÄki vektor.

### OtkriÄ‡e tajni <a href="#e177" id="e177"></a>

Identifikacija i zaÅ¡tita tajnih OAuth parametara je kljuÄna. Dok se **`client_id`** moÅ¾e bezbedno otkriti, otkrivanje **`client_secret`** nosi znaÄajne rizike. Ako je `client_secret` kompromitovan, napadaÄi mogu iskoristiti identitet i poverenje aplikacije da **ukradu korisniÄke `access_tokens`** i privatne informacije.

UobiÄajena ranjivost nastaje kada aplikacije greÅ¡kom rukovode razmenom autorizacionog `code` za `access_token` na klijentskoj strani umesto na serverskoj strani. Ova greÅ¡ka dovodi do izlaganja `client_secret`, omoguÄ‡avajuÄ‡i napadaÄima da generiÅ¡u `access_tokens` pod krinkom aplikacije. Å taviÅ¡e, kroz socijalno inÅ¾enjerstvo, napadaÄi bi mogli eskalirati privilegije dodavanjem dodatnih opsega u OAuth autorizaciju, dodatno iskoriÅ¡Ä‡avajuÄ‡i povereni status aplikacije.

### Bruteforce klijent tajne

MoÅ¾ete pokuÅ¡ati da **bruteforce-ujete client\_secret** provajdera usluga sa identitetskim provajderom kako biste pokuÅ¡ali da ukradete naloge.\
Zahtev za BF moÅ¾e izgledati sliÄno:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header leaking Code + State

Kada klijent ima **code i state**, ako je **reflektovan unutar Referer header-a** kada pretraÅ¾uje drugu stranicu, onda je ranjiv.

### Access Token Stored in Browser History

Idite na **istoriju pretraÅ¾ivaÄa i proverite da li je access token saÄuvan tamo**.

### Everlasting Authorization Code

**Authorization code bi trebao da Å¾ivi samo neko vreme kako bi se ograniÄio vremenski prozor u kojem napadaÄ moÅ¾e da ga ukrade i koristi**.

### Authorization/Refresh Token not bound to client

Ako moÅ¾ete da dobijete **authorization code i koristite ga sa razliÄitim klijentom, onda moÅ¾ete preuzeti druge naloge**.

### Happy Paths, XSS, Iframes & Post Messages to leak code & state values

[**Check this post**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

U ovom izveÅ¡taju o bug bounty: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) moÅ¾ete videti da **token** koji **AWS Cognito** vraÄ‡a korisniku moÅ¾e imati **dovoljno dozvola da prepiÅ¡e korisniÄke podatke**. Stoga, ako moÅ¾ete **promeniti korisniÄki email za drugi korisniÄki email**, moÅ¾da Ä‡ete moÄ‡i da **preuzmete** druge naloge.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
For more detailed info about how to abuse AWS cognito check:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abusing other Apps tokens <a href="#bda5" id="bda5"></a>

Kao Å¡to je [**spomenuto u ovom izveÅ¡taju**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), OAuth tokovi koji oÄekuju da prime **token** (a ne kod) mogu biti ranjivi ako ne provere da li token pripada aplikaciji.

To je zato Å¡to bi **napadaÄ** mogao da kreira **aplikaciju koja podrÅ¾ava OAuth i prijavi se putem Facebook-a** (na primer) u svojoj aplikaciji. Zatim, kada Å¾rtva prijavi putem Facebook-a u **napadaÄevoj aplikaciji**, napadaÄ bi mogao da dobije **OAuth token korisnika dodeljen njegovoj aplikaciji i iskoristi ga za prijavu u Å¾rtvin OAuth aplikaciju koristeÄ‡i Å¾rtvin korisniÄki token**.

{% hint style="danger" %}
Stoga, ako napadaÄ uspe da dobije pristup korisniku svojoj OAuth aplikaciji, moÄ‡i Ä‡e da preuzme Å¾rtvin nalog u aplikacijama koje oÄekuju token i ne provere da li je token dodeljen njihovom ID-u aplikacije.
{% endhint %}

### Two links & cookie <a href="#bda5" id="bda5"></a>

Prema [**ovom izveÅ¡taju**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), bilo je moguÄ‡e naterati Å¾rtvu da otvori stranicu sa **returnUrl** koja pokazuje na napadaÄev host. Ove informacije bi bile **smeÅ¡tene u kolaÄiÄ‡u (RU)**, a u **kasnijem koraku** **prompt** Ä‡e **pitati** **korisnika** da li Å¾eli da da pristup tom napadaÄevom hostu.

Da bi se zaobiÅ¡ao ovaj prompt, bilo je moguÄ‡e otvoriti tab za iniciranje **Oauth toka** koji bi postavio ovaj RU kolaÄiÄ‡ koristeÄ‡i **returnUrl**, zatvoriti tab pre nego Å¡to se prompt prikaÅ¾e, i otvoriti novi tab bez te vrednosti. Tada **prompt neÄ‡e obavestiti o napadaÄevom hostu**, ali bi kolaÄiÄ‡ bio postavljen na njega, tako da Ä‡e **token biti poslat na napadaÄev host** u redirekciji.

### Prompt Interaction Bypass <a href="#bda5" id="bda5"></a>

Kao Å¡to je objaÅ¡njeno u [**ovom videu**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), neke OAuth implementacije omoguÄ‡avaju da se GET parametar **`prompt`** oznaÄi kao None (**`&prompt=none`**) kako bi se **spreÄilo da korisnici budu pitani da potvrde** dodeljeni pristup u promptu na vebu ako su veÄ‡ prijavljeni na platformu.

### response\_mode

Kao Å¡to je [**objaÅ¡njeno u ovom videu**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), moÅ¾e biti moguÄ‡e oznaÄiti parametar **`response_mode`** da se naznaÄi gde Å¾elite da kod bude dostavljen u finalnom URL-u:

* `response_mode=query` -> Kod se pruÅ¾a unutar GET parametra: `?code=2397rf3gu93f`
* `response_mode=fragment` -> Kod se pruÅ¾a unutar URL fragment parametra `#code=2397rf3gu93f`
* `response_mode=form_post` -> Kod se pruÅ¾a unutar POST forme sa inputom nazvanim `code` i vrednoÅ¡Ä‡u
* `response_mode=web_message` -> Kod se Å¡alje u post poruci: `window.opener.postMessage({"code": "asdasdasd...`

### SSRFs parameters <a href="#bda5" id="bda5"></a>

[**Pogledajte ovo istraÅ¾ivanje**](https://portswigger.net/research/hidden-oauth-attack-vectors) **Za daljnje detalje o ovoj tehnici.**

DinamiÄka registracija klijenata u OAuth sluÅ¾i kao manje oÄigledan, ali kritiÄan vektor za sigurnosne ranjivosti, posebno za **Server-Side Request Forgery (SSRF)** napade. Ova taÄka omoguÄ‡ava OAuth serverima da prime detalje o klijentskim aplikacijama, ukljuÄujuÄ‡i osetljive URL-ove koji bi mogli biti iskoriÅ¡Ä‡eni.

**KljuÄne taÄke:**

* **DinamiÄka registracija klijenata** se Äesto mapira na `/register` i prihvata detalje kao Å¡to su `client_name`, `client_secret`, `redirect_uris`, i URL-ove za logotipe ili JSON Web Key Sets (JWKs) putem POST zahteva.
* Ova funkcija se pridrÅ¾ava specifikacija postavljenih u **RFC7591** i **OpenID Connect Registration 1.0**, koje ukljuÄuju parametre koji su potencijalno ranjivi na SSRF.
* Proces registracije moÅ¾e nenamerno izloÅ¾iti servere SSRF na nekoliko naÄina:
* **`logo_uri`**: URL za logo klijentske aplikacije koji bi server mogao da preuzme, pokreÄ‡uÄ‡i SSRF ili dovodeÄ‡i do XSS ako se URL pogreÅ¡no obradi.
* **`jwks_uri`**: URL do klijentovog JWK dokumenta, koji, ako je zlonamerno kreiran, moÅ¾e uzrokovati da server izvrÅ¡i izlazne zahteve ka serveru pod kontrolom napadaÄa.
* **`sector_identifier_uri`**: UpuÄ‡uje na JSON niz `redirect_uris`, koji server moÅ¾e preuzeti, stvarajuÄ‡i priliku za SSRF.
* **`request_uris`**: Navodi dozvoljene URI zahteve za klijenta, koji se mogu iskoristiti ako server preuzme ove URI na poÄetku procesa autorizacije.

**Strategija eksploatacije:**

* SSRF se moÅ¾e pokrenuti registracijom novog klijenta sa zlonamernim URL-ovima u parametrima kao Å¡to su `logo_uri`, `jwks_uri`, ili `sector_identifier_uri`.
* Dok direktna eksploatacija putem `request_uris` moÅ¾e biti ublaÅ¾ena kontrolama na beloj listi, pruÅ¾anje unapred registrovanog, napadaÄem kontrolisanog `request_uri` moÅ¾e olakÅ¡ati SSRF tokom faze autorizacije.

## OAuth providers Race Conditions

Ako je platforma koju testirate OAuth provajder [**proÄitajte ovo da testirate moguÄ‡e Race Conditions**](race-condition.md).

## References

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
