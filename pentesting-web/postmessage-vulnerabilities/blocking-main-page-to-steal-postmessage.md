# Bloqueando a p√°gina principal para roubar postmessage

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Ganhar RCs com Iframes

De acordo com este [**writeup do Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), os blobs de documentos criados a partir de origens nulas s√£o isolados para benef√≠cios de seguran√ßa, o que significa que se voc√™ manter ocupada a p√°gina principal, a p√°gina do iframe ser√° executada.

Basicamente, nesse desafio um **iframe isolado √© executado** e logo **ap√≥s** ele ser **carregado** a p√°gina **pai** vai **enviar uma mensagem post** com a **flag**.\
No entanto, essa comunica√ß√£o postmessage √© **vulner√°vel a XSS** (o **iframe** pode executar c√≥digo JS).

Portanto, o objetivo do atacante √© **permitir que a p√°gina pai crie o iframe**, mas **antes** de permitir que a **p√°gina pai envie os dados sens√≠veis (flag)**, **mantenha-a ocupada** e envie o **payload para o iframe**. Enquanto a **p√°gina pai est√° ocupada**, o **iframe executa o payload** que ser√° algum JS que ir√° ouvir a **mensagem postmessage da p√°gina pai e vazar a flag**.\
Finalmente, o iframe executou o payload e a p√°gina pai deixa de estar ocupada, ent√£o ela envia a flag e o payload a vaza.

Mas como voc√™ poderia fazer a p√°gina pai **ficar ocupada logo ap√≥s gerar o iframe e apenas enquanto espera o iframe estar pronto para enviar os dados sens√≠veis?** Basicamente, voc√™ precisa encontrar uma **a√ß√£o ass√≠ncrona** que voc√™ poderia fazer a p√°gina pai **executar**. Por exemplo, nesse desafio a p√°gina pai estava **ouvindo** as **postmessages** assim:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
Portanto, era poss√≠vel enviar um **n√∫mero inteiro grande em uma postmessage** que ser√° **convertido em string** nessa compara√ß√£o, o que levar√° algum tempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
E para ser preciso e **enviar** aquele **postmessage** logo **ap√≥s** o **iframe** ser criado, mas **antes** de estar **pronto** para receber os dados do pai, voc√™ precisar√° **brincar com os milissegundos de um `setTimeout`**.
