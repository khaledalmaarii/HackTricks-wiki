# Blocking main page to steal postmessage

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Winning RCs with Iframes

Zgodnie z tym [**opisem Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710) dokumenty blob utworzone z null origins s izolowane dla korzyci bezpieczestwa, co oznacza, 偶e jeli utrzymasz g贸wn stron zajt, strona iframe zostanie wykonana.

W zasadzie w tym wyzwaniu **izolowany iframe jest wykonywany** i tu偶 **po** jego **zaadowaniu** strona **rodzicielska** **wyle** wiadomo **post** z **flag**.\
Jednak ta komunikacja postmessage jest **vulnerable to XSS** (**iframe** mo偶e wykonywa kod JS).

Dlatego celem atakujcego jest **sprawi, aby rodzic utworzy iframe**, ale **przed** tym, jak **rodzic** **wyle** wra偶liwe dane (**flag**), **utrzyma go zajtym** i wysa **adunek do iframe**. Gdy **rodzic jest zajty**, **iframe wykonuje adunek**, kt贸ry bdzie jakim JS, kt贸ry bdzie nasuchiwa na **wiadomo postmessage rodzica i wycieknie flag**.\
Na koniec, iframe wykona adunek, a strona rodzicielska przestaje by zajta, wic wysya flag, a adunek j wycieka.

Ale jak mo偶esz sprawi, aby rodzic by **zajty tu偶 po tym, jak wygenerowa iframe i tylko podczas gdy czeka na gotowo iframe do wysania wra偶liwych danych?** W zasadzie musisz znale藕 **asynchroniczn** **akcj**, kt贸r mo偶esz sprawi, aby rodzic **wykona**. Na przykad, w tym wyzwaniu rodzic **nasuchiwa** na **postmessages** w ten spos贸b:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
wic mo偶liwe byo wysanie **du偶ej liczby cakowitej w postmessage**, kt贸ra zostanie **przekonwertowana na cig** w tym por贸wnaniu, co zajmie troch czasu:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Aby by precyzyjnym i **wysa** ten **postmessage** tu偶 **po** utworzeniu **iframe**, ale **przed** tym, jak bdzie **gotowy** do odbioru danych od rodzica, bdziesz musia **bawi si milisekundami w `setTimeout`**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
