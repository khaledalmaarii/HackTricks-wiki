# Bloqueando la p치gina principal para robar postmessage

{% hint style="success" %}
Aprende y practica AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}

## Ganando RCs con Iframes

Seg칰n este [**escrito de Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710), los blobs de documentos creados desde or칤genes nulos est치n aislados por beneficios de seguridad, lo que significa que si mantienes ocupada la p치gina principal, la p치gina del iframe se va a ejecutar.

B치sicamente, en ese desaf칤o se **ejecuta un iframe aislado** y justo **despu칠s** de que se **cargue**, la **p치gina padre** va a **enviar un post** mensaje con la **bandera**.\
Sin embargo, esa comunicaci칩n de postmessage es **vulnerable a XSS** (el **iframe** puede ejecutar c칩digo JS).

Por lo tanto, el objetivo del atacante es **dejar que la p치gina padre cree el iframe**, pero **antes** de que la **p치gina padre** **env칤e** los datos sensibles (**bandera**) **mantenerla ocupada** y enviar el **payload al iframe**. Mientras la **p치gina padre est치 ocupada**, el **iframe ejecuta el payload** que ser치 alg칰n JS que escuchar치 el **mensaje postmessage de la p치gina padre y filtrar치 la bandera**.\
Finalmente, el iframe ha ejecutado el payload y la p치gina padre deja de estar ocupada, por lo que env칤a la bandera y el payload la filtra.

Pero, 쯖칩mo podr칤as hacer que la p치gina padre est칠 **ocupada justo despu칠s de generar el iframe y solo mientras espera que el iframe est칠 listo para enviar los datos sensibles?** B치sicamente, necesitas encontrar una **acci칩n** **as칤ncrona** que puedas hacer que la p치gina padre **ejecute**. Por ejemplo, en ese desaf칤o, la p치gina padre estaba **escuchando** los **postmessages** de esta manera:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
as칤 que era posible enviar un **big integer en un postmessage** que ser치 **convertido a string** en esa comparaci칩n, lo que tomar치 algo de tiempo:
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Y para ser preciso y **enviar** ese **postmessage** justo **despu칠s** de que se crea el **iframe** pero **antes** de que est칠 **listo** para recibir los datos del padre, necesitar치s **jugar con los milisegundos de un `setTimeout`**.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
