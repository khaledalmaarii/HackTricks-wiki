# ä»£ç† / WAF é˜²æŠ¤ç»•è¿‡

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## ä½¿ç”¨è·¯å¾„åæ“çºµç»•è¿‡ Nginx ACL è§„åˆ™ <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

æŠ€æœ¯æ¥è‡ª[è¿™é¡¹ç ”ç©¶](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)ã€‚

Nginx è§„åˆ™ç¤ºä¾‹ï¼š
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
ä¸ºäº†é˜²æ­¢ç»•è¿‡ï¼ŒNginxåœ¨æ£€æŸ¥ä¹‹å‰æ‰§è¡Œè·¯å¾„è§„èŒƒåŒ–ã€‚ç„¶è€Œï¼Œå¦‚æœåç«¯æœåŠ¡å™¨æ‰§è¡Œä¸åŒçš„è§„èŒƒåŒ–ï¼ˆåˆ é™¤Nginxä¸åˆ é™¤çš„å­—ç¬¦ï¼‰ï¼Œå¯èƒ½ä¼šç»•è¿‡æ­¤é˜²å¾¡ã€‚

### **NodeJS - Express**

| Nginxç‰ˆæœ¬ | **Node.jsç»•è¿‡å­—ç¬¦** |
| ------------- | ----------------------------- |
| 1.22.0        | `\xA0`                        |
| 1.21.6        | `\xA0`                        |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`        |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`        |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`        |

### **Flask**

| Nginxç‰ˆæœ¬ | **Flaskç»•è¿‡å­—ç¬¦**                                    |
| ------------- | -------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                 |
| 1.21.6        | `\x85`, `\xA0`                                                 |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginxç‰ˆæœ¬ | **Spring Bootç»•è¿‡å­—ç¬¦** |
| ------------- | --------------------------------- |
| 1.22.0        | `;`                               |
| 1.21.6        | `;`                               |
| 1.20.2        | `\x09`, `;`                       |
| 1.18.0        | `\x09`, `;`                       |
| 1.16.1        | `\x09`, `;`                       |

### **PHP-FPM**

Nginx FPMé…ç½®ï¼š
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx è¢«é…ç½®ä¸ºé˜»æ­¢è®¿é—® `/admin.php`ï¼Œä½†å¯ä»¥é€šè¿‡è®¿é—® `/admin.php/index.php` æ¥ç»•è¿‡æ­¤é™åˆ¶ã€‚

### å¦‚ä½•é¢„é˜²
```plaintext
location ~* ^/admin {
deny all;
}
```
## ç»•è¿‡ Mod å®‰å…¨è§„åˆ™ <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### è·¯å¾„æ··æ·†

[**åœ¨è¿™ç¯‡æ–‡ç« ä¸­**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)è§£é‡Šäº† ModSecurity v3ï¼ˆç›´åˆ°3.0.12ç‰ˆæœ¬ï¼‰**ä¸æ­£ç¡®åœ°å®ç°äº†`REQUEST_FILENAME`**å˜é‡ï¼Œè¯¥å˜é‡åº”è¯¥åŒ…å«è®¿é—®çš„è·¯å¾„ï¼ˆç›´åˆ°å‚æ•°çš„å¼€å¤´ï¼‰ã€‚è¿™æ˜¯å› ä¸ºå®ƒæ‰§è¡Œäº†URLè§£ç ä»¥è·å–è·¯å¾„ã€‚\
å› æ­¤ï¼Œåœ¨ mod å®‰å…¨ä¸­ï¼Œåƒ`http://example.com/foo%3f';alert(1);foo=`è¿™æ ·çš„è¯·æ±‚å°†å‡å®šè·¯å¾„åªæ˜¯`/foo`ï¼Œå› ä¸º`%3f`è¢«è½¬æ¢ä¸º`?`ç»“æŸäº† URL è·¯å¾„ï¼Œä½†å®é™…ä¸ŠæœåŠ¡å™¨æ”¶åˆ°çš„è·¯å¾„å°†æ˜¯`/foo%3f';alert(1);foo=`ã€‚

å˜é‡`REQUEST_BASENAME`å’Œ`PATH_INFO`ä¹Ÿå—åˆ°äº†è¿™ä¸ª bug çš„å½±å“ã€‚

åœ¨ Mod å®‰å…¨çš„ç¬¬2ç‰ˆä¸­ä¹Ÿå‘ç”Ÿäº†ç±»ä¼¼çš„æƒ…å†µï¼Œå…è®¸ç»•è¿‡é˜²æ­¢ç”¨æˆ·è®¿é—®ä¸å¤‡ä»½æ–‡ä»¶ç›¸å…³çš„ç‰¹å®šæ‰©å±•åæ–‡ä»¶ï¼ˆå¦‚`.bak`ï¼‰çš„ä¿æŠ¤ï¼Œåªéœ€å‘é€ç‚¹ URL ç¼–ç ä¸º`%2e`ï¼Œä¾‹å¦‚ï¼š`https://example.com/backup%2ebak`ã€‚

## ç»•è¿‡ AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### æ ¼å¼é”™è¯¯çš„æ ‡å¤´

[è¿™é¡¹ç ”ç©¶](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)æåˆ°ï¼Œå¯ä»¥é€šè¿‡å‘é€ä¸€ä¸ª AWS æ— æ³•æ­£ç¡®è§£æä½†åç«¯æœåŠ¡å™¨å¯ä»¥è§£æçš„â€œæ ¼å¼é”™è¯¯â€æ ‡å¤´æ¥ç»•è¿‡åº”ç”¨äº HTTP æ ‡å¤´çš„ AWS WAF è§„åˆ™ã€‚

ä¾‹å¦‚ï¼Œå‘é€ä»¥ä¸‹å¸¦æœ‰ SQL æ³¨å…¥çš„è¯·æ±‚æ ‡å¤´ X-Queryï¼š
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
åœ¨è¿‡å»ï¼Œå¯ä»¥ç»•è¿‡ AWS WAFï¼Œå› ä¸ºå®ƒæ— æ³•ç†è§£ä¸‹ä¸€è¡Œæ˜¯æ ‡å¤´å€¼çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ NODEJS æœåŠ¡å™¨å¯ä»¥ï¼ˆå·²ä¿®å¤ï¼‰ã€‚

## å‚è€ƒ

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)


<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
