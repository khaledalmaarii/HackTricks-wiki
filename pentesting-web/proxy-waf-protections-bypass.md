# í”„ë¡ì‹œ / WAF ë³´í˜¸ ìš°íšŒ

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ **ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°**!</summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## ê²½ë¡œ ì´ë¦„ ì¡°ì‘ì„ í†µí•œ Nginx ACL ê·œì¹™ ìš°íšŒ <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

ê¸°ìˆ  [ì´ ì—°êµ¬ì—ì„œ](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Nginx ê·œì¹™ ì˜ˆì‹œ:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
### **NodeJS - Express**

| Nginx Version | **Node.js Bypass Characters** |
| ------------- | ----------------------------- |
| 1.22.0        | `\xA0`                        |
| 1.21.6        | `\xA0`                        |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`        |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`        |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`        |

### **Flask**

| Nginx Version | **Flask Bypass Characters**                                    |
| ------------- | -------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                 |
| 1.21.6        | `\x85`, `\xA0`                                                 |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx Version | **Spring Boot Bypass Characters** |
| ------------- | --------------------------------- |
| 1.22.0        | `;`                               |
| 1.21.6        | `;`                               |
| 1.20.2        | `\x09`, `;`                       |
| 1.18.0        | `\x09`, `;`                       |
| 1.16.1        | `\x09`, `;`                       |

### **PHP-FPM**

Nginx FPM configuration:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
NginxëŠ” `/admin.php`ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì°¨ë‹¨í•˜ë„ë¡ êµ¬ì„±ë˜ì–´ ìˆì§€ë§Œ, `/admin.php/index.php`ì— ì•¡ì„¸ìŠ¤í•˜ì—¬ ì´ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë°©ì§€ ë°©ë²•
```plaintext
location ~* ^/admin {
deny all;
}
```
## Mod Security ê·œì¹™ ìš°íšŒ <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### ê²½ë¡œ í˜¼ë€

[**ì´ ê²Œì‹œë¬¼**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)ì—ì„œëŠ” ModSecurity v3 (3.0.12 ë²„ì „ê¹Œì§€)ì´ `REQUEST_FILENAME` ë³€ìˆ˜ë¥¼ ë¶€ì ì ˆí•˜ê²Œ êµ¬í˜„í•˜ì—¬ ì•¡ì„¸ìŠ¤ëœ ê²½ë¡œë¥¼ í¬í•¨í•´ì•¼ í–ˆì§€ë§Œ (ë§¤ê°œë³€ìˆ˜ ì‹œì‘ê¹Œì§€), ì´ ë³€ìˆ˜ê°€ URL ë””ì½”ë“œë¥¼ ìˆ˜í–‰í•˜ì—¬ ê²½ë¡œë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ì‹¤ì œë¡œëŠ” `/foo%3f';alert(1);foo=`ì™€ ê°™ì€ ìš”ì²­ì€ mod securityì—ì„œ ê²½ë¡œê°€ `/foo`ë¡œ ê°€ì •ë  ê²ƒì´ì§€ë§Œ `%3f`ê°€ URL ê²½ë¡œë¥¼ ëë‚´ëŠ” `?`ë¡œ ë³€í™˜ë˜ë¯€ë¡œ ì„œë²„ê°€ ë°›ê²Œ ë  ì‹¤ì œ ê²½ë¡œëŠ” `/foo%3f';alert(1);foo=`ê°€ ë©ë‹ˆë‹¤.

ë³€ìˆ˜ `REQUEST_BASENAME` ë° `PATH_INFO`ë„ ì´ ë²„ê·¸ì˜ ì˜í–¥ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.

Mod Securityì˜ 2 ë²„ì „ì—ì„œë„ ë°±ì—… íŒŒì¼ê³¼ ê´€ë ¨ëœ íŠ¹ì • í™•ì¥ìë¥¼ ê°€ì§„ íŒŒì¼ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ë³´í˜¸ë¥¼ ìš°íšŒí•  ìˆ˜ ìˆì—ˆë˜ ë²„ê·¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `.bak`ì™€ ê°™ì€ ë°±ì—… íŒŒì¼ê³¼ ê´€ë ¨ëœ íŠ¹ì • í™•ì¥ìë¥¼ ê°€ì§„ íŒŒì¼ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ë³´í˜¸ë¥¼ ìš°íšŒí•˜ê¸° ìœ„í•´ ë‹¨ìˆœíˆ ì ì„ URL ì¸ì½”ë”©ëœ `%2e`ë¡œ ë³´ë‚´ëŠ” ê²ƒì´ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `https://example.com/backup%2ebak`.

## AWS WAF ACL ìš°íšŒ <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### í˜•ì‹ì´ ì˜ëª»ëœ í—¤ë”

[ì´ ì—°êµ¬](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)ëŠ” AWS WAF ê·œì¹™ì„ ìš°íšŒí•  ìˆ˜ ìˆëŠ” ë°©ë²•ìœ¼ë¡œ HTTP í—¤ë”ì— ì ìš©ëœ AWS WAF ê·œì¹™ì„ ìš°íšŒí•  ìˆ˜ ìˆì—ˆë˜ "í˜•ì‹ì´ ì˜ëª»ëœ" í—¤ë”ë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ ê°€ëŠ¥í–ˆë‹¤ê³  ì–¸ê¸‰í•©ë‹ˆë‹¤. ì´ í—¤ë”ëŠ” AWSì—ì„œ ì˜¬ë°”ë¥´ê²Œ êµ¬ë¬¸ ë¶„ì„ë˜ì§€ ì•Šì•˜ì§€ë§Œ ë°±ì—”ë“œ ì„œë²„ì—ì„œëŠ” ì˜¬ë°”ë¥´ê²Œ êµ¬ë¬¸ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ìš”ì²­ì„ SQL ì¸ì ì…˜ì„ í¬í•¨í•œ í—¤ë” X-Queryë¡œ ë³´ë‚´ëŠ” ê²ƒ:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
AWS WAFë¥¼ ìš°íšŒí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í–ˆì—ˆëŠ”ë°, ì´ëŠ” AWS WAFê°€ í—¤ë” ê°’ì˜ ë‹¤ìŒ ì¤„ì´ í•´ë‹¹ ê°’ì˜ ì¼ë¶€ë¼ëŠ” ê²ƒì„ ì´í•´í•˜ì§€ ëª»í–ˆê¸° ë•Œë¬¸ì´ì—ˆìŠµë‹ˆë‹¤. ë°˜ë©´ NODEJS ì„œë²„ëŠ” ì´ë¥¼ ì´í•´í–ˆì—ˆìŠµë‹ˆë‹¤ (í•´ë‹¹ ë¬¸ì œëŠ” ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤).

## ì°¸ê³  ìë£Œ

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)


<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>ì œë¡œë¶€í„° AWS í•´í‚¹ì„ ì „ë¬¸ê°€ë¡œ í•™ìŠµí•˜ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ì™€ í•¨ê»˜!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜**íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.**

</details>
