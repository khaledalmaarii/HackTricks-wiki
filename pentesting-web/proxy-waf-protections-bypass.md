# Bypass zabezpieczeÅ„ Proxy / WAF

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Bypass reguÅ‚ ACL Nginx za pomocÄ… manipulacji Å›cieÅ¼kÄ… <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

Techniki [z tej publikacji](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

PrzykÅ‚ad reguÅ‚y Nginx:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
### **NodeJS - Express**

| Wersja Nginx | **Znaki Bypass Node.js** |
| ------------- | ----------------------------- |
| 1.22.0        | `\xA0`                        |
| 1.21.6        | `\xA0`                        |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`        |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`        |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`        |

### **Flask**

| Wersja Nginx | **Znaki Bypass Flask**                                    |
| ------------- | -------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                 |
| 1.21.6        | `\x85`, `\xA0`                                                 |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Wersja Nginx | **Znaki Bypass Spring Boot** |
| ------------- | --------------------------------- |
| 1.22.0        | `;`                               |
| 1.21.6        | `;`                               |
| 1.20.2        | `\x09`, `;`                       |
| 1.18.0        | `\x09`, `;`                       |
| 1.16.1        | `\x09`, `;`                       |

### **PHP-FPM**

Konfiguracja Nginx FPM:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx jest skonfigurowany tak, aby blokowaÄ‡ dostÄ™p do `/admin.php`, ale moÅ¼na to obejÅ›Ä‡, uzyskujÄ…c dostÄ™p do `/admin.php/index.php`.

### Jak zapobiec
```plaintext
location ~* ^/admin {
deny all;
}
```
## OminiÄ™cie reguÅ‚ Mod Security <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Zagubienie Å›cieÅ¼ki

[W tym poÅ›cie](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) wyjaÅ›niono, Å¼e ModSecurity v3 (do wersji 3.0.12) **nieprawidÅ‚owo zaimplementowaÅ‚ zmiennÄ… `REQUEST_FILENAME`**, ktÃ³ra miaÅ‚a zawieraÄ‡ Å›cieÅ¼kÄ™ dostÄ™pu (do poczÄ…tku parametrÃ³w). Spowodowane to byÅ‚o dekodowaniem adresu URL w celu uzyskania Å›cieÅ¼ki.\
Dlatego teÅ¼, Å¼Ä…danie takie jak `http://example.com/foo%3f';alert(1);foo=` w mod security bÄ™dzie zakÅ‚adaÄ‡, Å¼e Å›cieÅ¼kÄ… jest tylko `/foo`, poniewaÅ¼ `%3f` jest zamieniane na `?` koÅ„czÄ…c Å›cieÅ¼kÄ™ URL, ale faktyczna Å›cieÅ¼ka, ktÃ³rÄ… otrzyma serwer, bÄ™dzie `/foo%3f';alert(1);foo=`.

Zmienne `REQUEST_BASENAME` i `PATH_INFO` rÃ³wnieÅ¼ byÅ‚y dotkniÄ™te tym bÅ‚Ä™dem.

CoÅ› podobnego miaÅ‚o miejsce w wersji 2 Mod Security, co pozwalaÅ‚o ominÄ…Ä‡ zabezpieczenie uniemoÅ¼liwiajÄ…ce uÅ¼ytkownikowi dostÄ™p do plikÃ³w z okreÅ›lonymi rozszerzeniami zwiÄ…zanymi z plikami kopii zapasowych (takimi jak `.bak`) po prostu wysyÅ‚ajÄ…c zakodowany kropkÄ™ URL w `%2e`, na przykÅ‚ad: `https://example.com/backup%2ebak`.

## OminiÄ™cie AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### ZnieksztaÅ‚cony NagÅ‚Ã³wek

[W tej analizie](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) wspomniano, Å¼e byÅ‚o moÅ¼liwe ominiÄ™cie reguÅ‚ AWS WAF stosowanych do nagÅ‚Ã³wkÃ³w HTTP poprzez wysÅ‚anie "znieksztaÅ‚conego" nagÅ‚Ã³wka, ktÃ³ry nie byÅ‚ poprawnie analizowany przez AWS, ale byÅ‚ przez serwer backendowy.

Na przykÅ‚ad, wysyÅ‚ajÄ…c nastÄ™pujÄ…ce Å¼Ä…danie z wstrzykniÄ™ciem SQL w nagÅ‚Ã³wku X-Query:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
ByÅ‚o moÅ¼liwe obejÅ›cie AWS WAF, poniewaÅ¼ nie rozumiaÅ‚, Å¼e nastÄ™pna linia jest czÄ™Å›ciÄ… wartoÅ›ci nagÅ‚Ã³wka, podczas gdy serwer NODEJS tak (to zostaÅ‚o naprawione).

## OdnoÅ›niki

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)


<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
