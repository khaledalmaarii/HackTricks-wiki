# Wycig warunkowy

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
U偶yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby atwo tworzy i **automatyzowa przepywy pracy** przy u偶yciu najbardziej zaawansowanych narzdzi spoecznociowych na wiecie.\
Otrzymaj dostp ju偶 dzi:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

{% hint style="warning" %}
Aby uzyska gbokie zrozumienie tej techniki, sprawd藕 oryginalne zgoszenie na stronie [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## Wzmacnianie atak贸w wycigowych

G贸wn przeszkod w wykorzystaniu wycigowych warunk贸w jest upewnienie si, 偶e wiele 偶da jest obsugiwanych jednoczenie, z **bardzo ma r贸偶nic w czasie ich przetwarzania - idealnie poni偶ej 1 ms**.

Oto kilka technik synchronizacji 偶da:

#### Atak pojedynczego pakietu HTTP/2 kontra synchronizacja ostatniego bajtu HTTP/1.1

- **HTTP/2**: Obsuguje wysyanie dw贸ch 偶da przez jedno poczenie TCP, zmniejszajc wpyw fluktuacji sieciowej. Jednak z powodu r贸偶nic po stronie serwera, dwie 偶dania mog nie wystarczy do sp贸jnego wykorzystania wycigowych warunk贸w.
- **HTTP/1.1 'Synchronizacja ostatniego bajtu'**: Umo偶liwia wczeniejsze wysanie wikszoci czci 20-30 偶da, z zatrzymaniem maego fragmentu, kt贸ry jest nastpnie wysyany razem, osigajc jednoczesne dotarcie do serwera.

**Przygotowanie do synchronizacji ostatniego bajtu** obejmuje:
1. Wysanie nag贸wk贸w i danych ciaa bez zakoczenia strumienia.
2. Pauza przez 100 ms po pocztkowym wysaniu.
3. Wyczenie TCP_NODELAY w celu wykorzystania algorytmu Nagle'a do partycjonowania kocowych ramek.
4. Pingowanie w celu rozgrzania poczenia.

Nastpne wysanie zatrzymanych ramek powinno skutkowa ich dotarciem w jednym pakiecie, co mo偶na zweryfikowa za pomoc Wiresharka. Ta metoda nie dotyczy plik贸w statycznych, kt贸re zazwyczaj nie s zaanga偶owane w ataki RC.

### Dostosowanie do architektury serwera

Zrozumienie architektury docelowego serwera jest kluczowe. Serwery front-endowe mog kierowa 偶dania w r贸偶ny spos贸b, co wpywa na czasowanie. Wstpne rozgrzewanie poczenia po stronie serwera poprzez nieistotne 偶dania mo偶e znormalizowa czasowanie 偶da.

#### Obsuga blokady opartej na sesji

Frameworki takie jak PHP obsuguj 偶dania szeregowo wedug sesji, co potencjalnie utrudnia wykrycie podatnoci. Wykorzystanie r贸偶nych token贸w sesji dla ka偶dego 偶dania mo偶e obej ten problem.

#### Przezwyci偶anie limit贸w czstotliwoci lub zasob贸w

Jeli rozgrzewanie poczenia jest nieskuteczne, celowe wywoanie op贸藕nie limit贸w czstotliwoci lub zasob贸w serwer贸w WWW poprzez zalewanie faszywymi 偶daniami mo偶e uatwi atak pojedynczego pakietu, wywoujc op贸藕nienie po stronie serwera sprzyjajce wycigowym warunkom.


## Przykady atak贸w

* **Tubo Intruder - atak pojedynczego pakietu HTTP2 (1 punkt kocowy)**: Mo偶esz wysa 偶danie do **Turbo Intruder** (`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`), mo偶esz zmieni warto, kt贸r chcesz przeprowadzi atak brute force dla **`%s`** jak w `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s`, a nastpnie wybra **`examples/race-single-packer-attack.py`** z listy rozwijanej:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Jeli zamierzasz **wysa r贸偶ne wartoci**, mo偶esz zmodyfikowa kod na taki, kt贸ry korzysta z listy hase z schowka:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Jeli strona internetowa nie obsuguje HTTP2 (tylko HTTP1.1), u偶yj `Engine.THREADED` lub `Engine.BURP` zamiast `Engine.BURP2`.
{% endhint %}

* **Tubo Intruder - atak jednopakietowy HTTP2 (wiele punkt贸w kocowych)**: Jeli musisz wysa 偶danie do jednego punktu kocowego, a nastpnie wiele 偶da do innych punkt贸w kocowych, aby wywoa RCE, mo偶esz zmodyfikowa skrypt `race-single-packet-attack.py` na co takiego:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Jest r贸wnie偶 dostpny w **Repeaterze** za pomoc nowej opcji '**Wysyaj grup r贸wnolegle**' w Burp Suite.
* Dla **limit-overrun** mo偶na po prostu doda **t sam prob 50 razy** do grupy.
* Dla **rozgrzewania poczenia** mo偶na na **pocztku grupy** doda kilka **prob** do niezmiennego elementu serwera internetowego.
* Aby **op贸藕ni** proces **midzy** przetwarzaniem **jednej proby a drug** w dw贸ch krokach podstanu, mo偶na **doda dodatkowe proby midzy** tymi dwoma probami.
* Dla wielopunktowego RC mo偶na zacz wysya **prob**, kt贸ra **przechodzi do ukrytego stanu**, a nastpnie **50 prob** zaraz po niej, kt贸re **wykorzystuj ukryty stan**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Surowy BF

Przed poprzednimi badaniami u偶ywano tych adunk贸w, kt贸re po prostu pr贸boway wysa pakiety tak szybko, jak to mo偶liwe, aby spowodowa RC.

* **Repeater:** Sprawd藕 przykady z poprzedniej sekcji.
* **Intruder**: Wylij **prob** do **Intrudera**, ustaw **liczb wtk贸w** na **30** w menu **Opcje**, wybierz jako adunek **Puste adunki** i wygeneruj **30**.
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**

Python - asyncio to biblioteka do asynchronicznego programowania w jzyku Python. Pozwala na tworzenie efektywnych i skalowalnych aplikacji, kt贸re wykorzystuj asynchroniczne operacje wejcia/wyjcia. Biblioteka asyncio dostarcza mechanizmy do obsugi zdarze, takich jak wywoania zwrotne (callbacks) i korutyny (coroutines), kt贸re umo偶liwiaj r贸wnolege wykonywanie wielu zada.

Aby rozpocz korzystanie z asyncio, nale偶y zaimportowa modu `asyncio`. Nastpnie mo偶na zdefiniowa funkcje korutynowe przy u偶yciu sowa kluczowego `async` przed definicj funkcji. Funkcje korutynowe mog by wywoywane za pomoc funkcji `await`, co pozwala na oczekiwanie na zakoczenie innej korutyny bez blokowania wykonywania innych zada.

Przykad u偶ycia asyncio w Pythonie:

```python
import asyncio

async def hello():
    print("Hello")
    await asyncio.sleep(1)
    print("World")

async def main():
    await asyncio.gather(hello(), hello(), hello())

asyncio.run(main())
```

W powy偶szym przykadzie definiujemy dwie funkcje korutynowe: `hello()` i `main()`. Funkcja `hello()` wypisuje "Hello", czeka przez 1 sekund przy u偶yciu `asyncio.sleep(1)`, a nastpnie wypisuje "World". Funkcja `main()` u偶ywa funkcji `asyncio.gather()` do r贸wnoczesnego wywoania trzech instancji funkcji `hello()`. Wywoanie `asyncio.run(main())` uruchamia program i wykonuje wszystkie korutyny.

Dziki bibliotece asyncio w Pythonie mo偶na atwo tworzy asynchroniczne programy, kt贸re s wydajne i skalowalne.
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **Metodologia RC**

### Limit przekroczenia / TOCTOU

To najprostszy rodzaj wycig贸wki, w kt贸rym wystpuj podatnoci w miejscach, kt贸re ograniczaj liczb razy, jak mo偶na wykona dan czynno. Na przykad u偶ywanie tego samego kodu rabatowego kilka razy w sklepie internetowym. Bardzo atwy przykad mo偶na znale藕 w [**tym raporcie**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) lub w [**tym bdzie**](https://hackerone.com/reports/759247)**.**

Istnieje wiele wariant贸w tego rodzaju ataku, w tym:

* Wielokrotne wykorzystanie karty podarunkowej
* Wielokrotne ocenianie produktu
* Wypacanie lub transferowanie got贸wki przekraczajcej saldo konta
* Ponowne wykorzystanie jednego rozwizania CAPTCHA
* Ominicie limitu szybkoci anty-brute-force

### **Ukryte podstany**

Wykorzystywanie zo偶onych wycig贸wek czsto wi偶e si z korzystaniem z kr贸tkotrwaych okazji do interakcji z ukrytymi lub **niezamierzonymi podstanami maszyny**. Oto jak do tego podej:

1. **Identyfikacja potencjalnych ukrytych podstan贸w**
- Zacznij od zlokalizowania punkt贸w kocowych, kt贸re modyfikuj lub oddziauj na krytyczne dane, takie jak profile u偶ytkownik贸w lub procesy resetowania hasa. Skup si na:
- **Przechowywanie**: Preferuj punkty kocowe, kt贸re manipuluj danymi przechowywanymi po stronie serwera, w przeciwiestwie do tych obsugujcych dane po stronie klienta.
- **Dziaanie**: Szukaj operacji, kt贸re zmieniaj istniejce dane, poniewa偶 s bardziej podatne na tworzenie warunk贸w podatnych na atak w por贸wnaniu do tych, kt贸re dodaj nowe dane.
- **Kluczowanie**: Udane ataki zwykle obejmuj operacje kluczowane tym samym identyfikatorem, np. nazw u偶ytkownika lub tokenem resetowania.

2. **Pierwsze sondowanie**
- Przetestuj zidentyfikowane punkty kocowe za pomoc atak贸w wycig贸wkowych, obserwujc wszelkie odstpstwa od oczekiwanych wynik贸w. Nieoczekiwane odpowiedzi lub zmiany w zachowaniu aplikacji mog wskazywa na podatno.

3. **Wykazanie podatnoci**
- Ogranicz atak do minimalnej liczby 偶da potrzebnych do wykorzystania podatnoci, czsto tylko dw贸ch. Ten krok mo偶e wymaga wielokrotnych pr贸b lub automatyzacji ze wzgldu na precyzyjne wymagania czasowe.

### Ataki zale偶ne od czasu

Precyzja w czasie 偶da mo偶e ujawni podatnoci, zwaszcza gdy do generowania token贸w bezpieczestwa u偶ywane s przewidywalne metody, takie jak znaczniki czasowe. Na przykad generowanie token贸w resetowania hasa na podstawie znacznik贸w czasowych mo偶e umo偶liwi uzyskanie identycznych token贸w dla r贸wnoczesnych 偶da.

**Aby wykorzysta:**
- U偶yj precyzyjnego czasowania, takiego jak atak jednopakietowy, aby wysa r贸wnoczesne 偶dania resetowania hasa. Identyczne tokeny wskazuj na podatno.

**Przykad:**
- Popro o dwa tokeny resetowania hasa w tym samym czasie i por贸wnaj je. Pasujce tokeny sugeruj wadliwe generowanie token贸w.

**Sprawd藕 ten [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities), aby to wypr贸bowa.**


## Studia przypadk贸w ukrytych podstan贸w

### Patno i dodanie przedmiotu

Sprawd藕 ten [**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation), aby zobaczy, jak **zapaci** w sklepie i **doda dodatkowy** przedmiot, za kt贸ry **nie trzeba paci**.

### Potwierdzanie innych adres贸w e-mail

Idea polega na **zweryfikowaniu adresu e-mail i jednoczesnej zmianie go na inny**, aby sprawdzi, czy platforma weryfikuje nowy adres.

### Zmiana adresu e-mail na 2 adresy oparte na plikach cookie

Wedug [**tego badania**](https://portswigger.net/research/smashing-the-state-machine) Gitlab by podatny na przejcie w ten spos贸b, poniewa偶 m贸g **wysa** **token weryfikacyjny e-maila jednego adresu e-mailowego na inny adres e-mailowy**.

**Sprawd藕 ten [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint), aby to wypr贸bowa.**

### Ukryte stany bazy danych / Ominicie potwierdzenia

Jeli do **dodania informacji** do **bazy danych** u偶ywane s **2 r贸偶ne zapisy**, istnieje may okres czasu, w kt贸rym **tylko pierwsze dane zostay zapisane** w bazie danych. Na przykad, podczas tworzenia u偶ytkownika **nazwa u偶ytkownika** i **haso** mog zosta **zapisane**, a nastpnie zapisywany jest **token** do potwierdzenia nowo utworzonego konta. Oznacza to, 偶e przez kr贸tki czas **token do potwierdzenia konta jest pusty**.

Dlatego **rejestrujc konto i wysyajc kilka 偶da z pustym tokenem** (`token=` lub `token[]=` lub inna wariacja), aby natychmiast potwierdzi konto, mo偶na potwierdzi konto, kt贸rego e-mailem nie kontrolujesz.

**Sprawd藕 ten [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction), aby to wypr贸bowa.**

### Ominicie 2FA

Poni偶szy pseudokod jest podatny na wycig贸wk, poniewa偶 przez bardzo kr贸tki czas **2FA nie jest wymagane**, podczas gdy tworzona jest sesja:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### Wieczysta trwao OAuth2

Istnieje kilka [**dostawc贸w OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Usugi te umo偶liwiaj tworzenie aplikacji i uwierzytelnianie u偶ytkownik贸w zarejestrowanych w dostawcy. Aby to zrobi, **klient** musi **udzieli pozwolenia Twojej aplikacji** na dostp do niekt贸rych danych wewntrz dostawcy OAuth.\
Wic do tej pory to tylko zwyke logowanie za pomoc Google/LinkedIn/GitHub... gdzie pojawia si strona informujca: "_Aplikacja \<InsertCoolName> chce uzyska dostp do Twoich informacji, czy chcesz jej to zezwoli?_"

#### Wycig warunkowy w `authorization_code`

**Problem** pojawia si, gdy **zaakceptujesz** i automatycznie zostanie wysany **`authorization_code`** do zoliwej aplikacji. Nastpnie ta aplikacja wykorzystuje wycig warunkowy w dostawcy usugi OAuth, aby wygenerowa wicej ni偶 jedno AT/RT (_Authentication Token/Refresh Token_) na podstawie **`authorization_code`** dla Twojego konta. W zasadzie wykorzysta fakt, 偶e zezwolie aplikacji na dostp do swoich danych, aby **utworzy kilka kont**. Jeli przestaniesz zezwala aplikacji na dostp do swoich danych, jedna para AT/RT zostanie usunita, ale pozostae bd wci偶 wa偶ne.

#### Wycig warunkowy w `Refresh Token`

Po uzyskaniu **wa偶nego RT** mo偶esz spr贸bowa go wykorzysta do wygenerowania kilku AT/RT, nawet jeli u偶ytkownik anuluje uprawnienia dla zoliwej aplikacji do dostpu do swoich danych, **kilka RT wci偶 bdzie wa偶nych**.

## **RC w WebSockets**

W [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) znajdziesz PoC w jzyku Java, kt贸ry wysya wiadomoci websocket w **trybie r贸wnolegym**, aby wykorzysta **wycigi warunkowe r贸wnie偶 w WebSockets**.

## Odwoania

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
U偶yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby atwo tworzy i **automatyzowa zadania** przy u偶yciu najbardziej zaawansowanych narzdzi spoecznociowych na wiecie.\
Zdobd藕 dostp ju偶 dzi:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
