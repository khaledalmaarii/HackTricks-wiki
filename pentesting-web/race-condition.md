# Condition de course

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour cr√©er et automatiser facilement des flux de travail aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Exploitation de la condition de course

Le principal probl√®me de l'exploitation des conditions de course est que vous avez besoin que les requ√™tes soient trait√©es en parall√®le avec une tr√®s courte diff√©rence de temps (g√©n√©ralement >1ms). Dans la section suivante, diff√©rentes solutions sont propos√©es pour rendre cela possible.

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### Attaque √† un seul paquet

HTTP2 permet d'envoyer **2 requ√™tes dans une seule connexion TCP** (alors que dans HTTP/1.1, elles doivent √™tre s√©quentielles).\
L'utilisation d'un seul paquet TCP √©limine compl√®tement l'effet du jitter du r√©seau, il y a donc clairement un potentiel pour les attaques de condition de course. Cependant, **deux requ√™tes ne suffisent pas pour une attaque de course fiable** gr√¢ce au **jitter c√¥t√© serveur** - variations du temps de traitement des requ√™tes de l'application caus√©es par des variables incontr√¥lables telles que la contention du CPU.

Mais, en utilisant la technique '**last-byte sync**' d'HTTP/1.1, il est possible d'envoyer pr√©alablement la majeure partie des donn√©es en retenant un petit fragment de chaque requ√™te, puis de 'compl√©ter' **20 √† 30 requ√™tes avec un seul paquet TCP**.

Pour **envoyer pr√©alablement la majeure partie de chaque requ√™te** :

- Si la requ√™te n'a pas de corps, envoyez tous les en-t√™tes, mais ne d√©finissez pas le drapeau END\_STREAM. Retenez un cadre de donn√©es vide avec le drapeau END\_STREAM d√©fini.
- Si la requ√™te a un corps, envoyez les en-t√™tes et toutes les donn√©es du corps sauf le dernier octet. Retenez un cadre de donn√©es contenant le dernier octet.

Ensuite, **pr√©parez-vous √† envoyer les trames finales** :

- Attendez 100 ms pour vous assurer que les trames initiales ont √©t√© envoy√©es.
- Assurez-vous que TCP\_NODELAY est d√©sactiv√© - il est crucial que l'algorithme de Nagle regroupe les trames finales.
- Envoyez un paquet ping pour r√©chauffer la connexion locale. Si vous ne le faites pas, la pile r√©seau du syst√®me d'exploitation placera la premi√®re trame finale dans un paquet s√©par√©.

Enfin, envoyez les trames retenues. Vous devriez pouvoir v√©rifier qu'elles sont arriv√©es dans un seul paquet en utilisant Wireshark.

{% hint style="info" %}
Notez que cela **ne fonctionne pas pour les fichiers statiques** sur certains serveurs, mais les fichiers statiques ne sont pas pertinents pour les attaques de condition de course. Mais les fichiers statiques sont sans importance pour les attaques de RC.
{% endhint %}

En utilisant cette technique, vous pouvez faire en sorte que 20 √† 30 requ√™tes arrivent simultan√©ment sur le serveur - ind√©pendamment du jitter du r√©seau :

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**Adaptation √† l'architecture cible**

Il est important de noter que de nombreuses applications se trouvent derri√®re un serveur frontal, et ceux-ci peuvent d√©cider de transf√©rer certaines requ√™tes sur des connexions existantes vers l'arri√®re-plan, et de cr√©er de nouvelles connexions pour d'autres.

Par cons√©quent, il est important de ne pas attribuer des d√©lais de requ√™te incoh√©rents au comportement de l'application, tel que des m√©canismes de verrouillage qui n'autorisent qu'un seul thread √† acc√©der √† une ressource √† la fois. De plus, le routage des requ√™tes c√¥t√© frontal est souvent effectu√© sur une base de connexion, vous pouvez donc lisser le d√©lai des requ√™tes en effectuant un r√©chauffement de connexion c√¥t√© serveur - **envoyer quelques requ√™tes insignifiantes sur votre connexion avant de lancer l'attaque**.

Notez que **PHP verrouille sur l'identifiant de session par d√©faut**, vous devez donc utiliser une **session distincte pour chaque requ√™te** de votre lot, sinon elles seront trait√©es s√©quentiellement.

{% hint style="warning" %}
Pour plus d'informations sur cette technique, consultez le rapport original sur [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

#### Exemples

Vous pouvez consulter un exemple simple sur la fa√ßon d'utiliser cela dans Turbo Intruder sur [https://github.com/PortSwigger/turbo-intruder/blob/master/resources/examples/race-single-packet-attack.py](https://github.com/PortSwigger/turbo-intruder/blob/master/resources/examples/race-single-packet-attack.py).

Il est √©galement disponible dans **Repeater** via la nouvelle option '**Envoyer le groupe en parall√®le**' dans Burp Suite.
### BF brut

Avant les recherches pr√©c√©dentes, voici quelques charges utiles utilis√©es qui tentaient simplement d'envoyer les paquets aussi rapidement que possible pour provoquer une RC.

* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**

La biblioth√®que `asyncio` de Python est utilis√©e pour √©crire du code asynchrone de mani√®re concurrente. Elle permet d'ex√©cuter des t√¢ches en parall√®le, ce qui est particuli√®rement utile pour les op√©rations d'entr√©e/sortie (I/O) intensives, telles que les appels r√©seau.

L'asynchronisme est bas√© sur le concept de coroutines, qui sont des fonctions sp√©ciales pouvant √™tre suspendues et reprises ult√©rieurement. Cela permet d'√©viter les blocages et d'optimiser l'utilisation des ressources.

`asyncio` fournit √©galement des primitives pour g√©rer les √©v√©nements, les boucles d'√©v√©nements et les t√¢ches. Les √©v√©nements sont des objets qui se produisent lorsqu'une op√©ration asynchrone est termin√©e, tandis que les boucles d'√©v√©nements sont responsables de l'ex√©cution des coroutines et de la gestion des √©v√©nements.

Pour utiliser `asyncio`, vous devez d√©finir des coroutines en utilisant le mot-cl√© `async` et les ex√©cuter dans une boucle d'√©v√©nements √† l'aide de la fonction `run_until_complete`. Vous pouvez √©galement utiliser des mots-cl√©s tels que `await` pour suspendre l'ex√©cution d'une coroutine jusqu'√† ce qu'une op√©ration asynchrone soit termin√©e.

Voici un exemple simple d'utilisation de `asyncio` pour effectuer une requ√™te HTTP asynchrone :

```python
import asyncio
import aiohttp

async def fetch(url):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.text()

async def main():
    url = "https://example.com"
    response = await fetch(url)
    print(response)

loop = asyncio.get_event_loop()
loop.run_until_complete(main())
```

Dans cet exemple, la fonction `fetch` est une coroutine qui utilise la biblioth√®que `aiohttp` pour effectuer une requ√™te HTTP asynchrone. La fonction `main` est √©galement une coroutine qui appelle `fetch` et attend la r√©ponse.

En ex√©cutant ce code, vous pouvez effectuer une requ√™te HTTP asynchrone et afficher la r√©ponse. Cela permet d'√©conomiser du temps en √©vitant les attentes inutiles lors de l'ex√©cution de t√¢ches I/O intensives.

`asyncio` est un outil puissant pour √©crire du code asynchrone en Python, ce qui peut √™tre tr√®s utile dans le domaine du piratage √©thique pour effectuer des op√©rations de mani√®re efficace et rapide.
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
* **Intrus**: Envoyez la **requ√™te** √† **Intruder**, d√©finissez le **nombre de threads** sur **30** dans le menu **Options**, s√©lectionnez les **charges utiles nulles** et g√©n√©rez-en **30**.

## **M√©thodologie RC**

## **Impacts de RC**

### D√©passement de limite

Il s'agit du type le plus basique de race condition o√π des **vuln√©rabilit√©s** apparaissent dans des endroits qui **limitent le nombre de fois o√π vous pouvez effectuer une action**. Par exemple, utiliser plusieurs fois le m√™me code de r√©duction dans une boutique en ligne. Un exemple tr√®s simple peut √™tre trouv√© dans [**ce rapport**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) ou dans [**ce bogue**](https://hackerone.com/reports/759247)**.**

### **Sous-√©tats cach√©s**

Les RC les plus complexes exploiteront des **sous-√©tats dans l'√©tat de la machine** qui pourraient permettre √† un attaquant d'**abuser des √©tats auxquels il n'√©tait jamais cens√© avoir acc√®s**, mais il existe une **petite fen√™tre** pour que l'attaquant y acc√®de.

1. **Pr√©dire les sous-√©tats cach√©s et int√©ressants potentiels**

La premi√®re √©tape consiste √† identifier tous les points d'extr√©mit√© qui √©crivent ou lisent des donn√©es √† partir de celui-ci, puis utilisent ces donn√©es pour quelque chose d'important. Par exemple, les utilisateurs peuvent √™tre stock√©s dans une table de base de donn√©es modifi√©e par l'enregistrement, les modifications de profil, l'initiation de la r√©initialisation du mot de passe et l'ach√®vement de la r√©initialisation du mot de passe.

Nous pouvons utiliser trois questions cl√©s pour exclure les points d'extr√©mit√© qui sont peu susceptibles de provoquer des collisions. Pour chaque objet et les points d'extr√©mit√© associ√©s, demandez-vous :

**1) Comment l'√©tat est-il stock√© ?**

Les donn√©es stock√©es dans une structure de donn√©es c√¥t√© serveur persistante sont id√©ales pour l'exploitation. Certains points d'extr√©mit√© stockent leur √©tat enti√®rement c√¥t√© client, comme les r√©initialisations de mot de passe qui fonctionnent en envoyant un JWT par e-mail - ceux-ci peuvent √™tre ignor√©s en toute s√©curit√©.

Les applications stockent souvent certains √©tats dans la session utilisateur. Ils sont souvent quelque peu prot√©g√©s contre les sous-√©tats - nous en parlerons plus tard.

**2) Est-ce que nous modifions ou ajoutons ?**

Les op√©rations qui modifient des donn√©es existantes (comme le changement de l'adresse e-mail principale d'un compte) ont un potentiel de collision important, tandis que les actions qui ajoutent simplement des donn√©es existantes (comme l'ajout d'une adresse e-mail suppl√©mentaire) sont peu susceptibles d'√™tre vuln√©rables √† autre chose qu'√† des attaques de d√©passement de limite.

**3) Sur quoi l'op√©ration est-elle bas√©e ?**

La plupart des points d'extr√©mit√© fonctionnent sur un enregistrement sp√©cifique, qui est recherch√© √† l'aide d'une "cl√©", telle qu'un nom d'utilisateur, un jeton de r√©initialisation de mot de passe ou un nom de fichier. Pour une attaque r√©ussie, nous avons besoin de deux op√©rations qui utilisent la m√™me cl√©. Par exemple, imaginez deux impl√©mentations plausibles de r√©initialisation de mot de passe :

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

2. **Recherche d'indices**

√Ä ce stade, il est temps de **lancer des attaques RC** sur les points d'extr√©mit√© potentiellement int√©ressants pour essayer de trouver des r√©sultats inattendus par rapport aux r√©sultats habituels. **Toute d√©viation de la r√©ponse attendue**, telle qu'un changement dans une ou plusieurs r√©ponses, ou un effet de second ordre comme des contenus d'e-mail diff√©rents ou un changement visible dans votre session, pourrait √™tre un indice indiquant un probl√®me.

3. **Prouver le concept**

La derni√®re √©tape consiste √† **prouver le concept et √† le transformer en une attaque viable**.

Lorsque vous envoyez un lot de requ√™tes, vous pouvez constater qu'une paire de requ√™tes initiales d√©clenche un √©tat final vuln√©rable, mais que les requ√™tes ult√©rieures l'√©crasent/invalident et que l'√©tat final n'est pas exploitable. Dans ce sc√©nario, vous voudrez √©liminer toutes les requ√™tes inutiles - deux devraient suffire pour exploiter la plupart des vuln√©rabilit√©s. Cependant, passer √† deux requ√™tes rendra l'attaque plus sensible au timing, vous devrez donc peut-√™tre r√©essayer l'attaque plusieurs fois ou l'automatiser.

## √âtudes de cas sur les sous-√©tats cach√©s

### Payer et ajouter un article

[**Consultez ce laboratoire**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) pour voir comment **payer** dans un magasin et **ajouter un article suppl√©mentaire** pour lequel vous n'aurez pas besoin de payer.

### Confirmer d'autres e-mails

L'id√©e est de **v√©rifier une adresse e-mail et de la changer en m√™me temps** pour savoir si la plateforme v√©rifie la nouvelle adresse modifi√©e.

### Changer l'e-mail en 2 adresses e-mail

Selon [**cet article**](https://portswigger.net/research/smashing-the-state-machine), Gitlab √©tait vuln√©rable √† une prise de contr√¥le de cette mani√®re car il pourrait **envoyer le jeton de v√©rification d'e-mail d'une adresse e-mail √† l'autre adresse e-mail**.

### Persistance √©ternelle d'OAuth2

Il existe plusieurs [**fournisseurs OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Ces services vous permettront de cr√©er une application et d'authentifier les utilisateurs enregistr√©s par le fournisseur. Pour ce faire, le **client** devra **autoriser votre application** √† acc√©der √† certaines de leurs donn√©es √† l'int√©rieur du **fournisseur OAuth**.\
Jusqu'√† pr√©sent, il s'agit simplement d'une connexion classique avec Google/LinkedIn/GitHub... o√π vous √™tes invit√© avec une page disant : "_L'application \<InsertCoolName> souhaite acc√©der √† vos informations, voulez-vous l'autoriser ?_"

#### Race Condition dans `authorization_code`

Le **probl√®me** survient lorsque vous **l'acceptez** et envoie automatiquement un **`authorization_code`** √† l'application malveillante. Ensuite, cette **application exploite une race condition dans le fournisseur de services OAuth pour g√©n√©rer plus d'un AT/RT** (_Authentication Token/Refresh Token_) √† partir de l'**`authorization_code`** pour votre compte. Fondamentalement, elle exploitera le fait que vous avez accept√© l'application pour acc√©der √† vos donn√©es afin de **cr√©er plusieurs comptes**. Ensuite, si vous **arr√™tez d'autoriser l'application √† acc√©der √† vos donn√©es, une paire d'AT/RT sera supprim√©e, mais les autres resteront valides**.

#### Race Condition dans `Refresh Token`

Une fois que vous avez **obtenu un RT valide**, vous pouvez essayer de **l'exploiter pour g√©n√©rer plusieurs AT/RT** et m√™me si l'utilisateur annule les autorisations pour l'application malveillante d'acc√©der √† ses donn√©es, **plusieurs RT resteront valides**.

## R√©f√©rences

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PRs au** [**d√©p√¥t hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**d√©p√¥t hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour cr√©er et **automatiser facilement des flux de travail** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Obtenez un acc√®s d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
