# Condition de course

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour cr√©er facilement et **automatiser des flux de travail** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Exploitation de la condition de course

Le principal probl√®me de l'exploitation des conditions de course est que vous avez besoin que les requ√™tes soient trait√©es en parall√®le avec une tr√®s petite diff√©rence de temps (g√©n√©ralement >1ms). Dans la section suivante, diff√©rentes solutions sont propos√©es pour rendre cela possible.

<figure><img src="../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

### Attaque √† un seul paquet (HTTP/2) / Synchronisation du dernier octet (HTTP/1.1)

HTTP2 permet d'envoyer **2 requ√™tes dans une seule connexion TCP** (alors que dans HTTP/1.1, elles doivent √™tre s√©quentielles).\
L'utilisation d'un seul paquet TCP √©limine compl√®tement l'effet du jitter du r√©seau, ce qui ouvre clairement la voie aux attaques par condition de course. Cependant, **deux requ√™tes ne suffisent pas pour une attaque de course fiable** gr√¢ce au **jitter c√¥t√© serveur** - les variations du temps de traitement des requ√™tes de l'application caus√©es par des variables incontr√¥lables telles que la contention du processeur.

Mais, en utilisant la technique de '**synchronisation du dernier octet**' d'HTTP/1.1, il est possible d'envoyer pr√©alablement la majeure partie des donn√©es en retenant un petit fragment de chaque requ√™te, puis de 'compl√©ter' **20 √† 30 requ√™tes avec un seul paquet TCP**.

Pour **envoyer pr√©alablement la majeure partie de chaque requ√™te** :

- Si la requ√™te n'a pas de corps, envoyez tous les en-t√™tes, mais ne d√©finissez pas le drapeau END\_STREAM. Retenez un cadre de donn√©es vide avec le drapeau END\_STREAM d√©fini.
- Si la requ√™te a un corps, envoyez les en-t√™tes et toutes les donn√©es du corps sauf le dernier octet. Retenez un cadre de donn√©es contenant le dernier octet.

Ensuite, **pr√©parez-vous √† envoyer les trames finales** :

- Attendez 100 ms pour vous assurer que les trames initiales ont √©t√© envoy√©es.
- Assurez-vous que TCP\_NODELAY est d√©sactiv√© - il est crucial que l'algorithme de Nagle regroupe les trames finales.
- Envoyez un paquet ping pour r√©chauffer la connexion locale. Si vous ne le faites pas, la pile r√©seau du syst√®me d'exploitation placera la premi√®re trame finale dans un paquet s√©par√©.

Enfin, envoyez les trames retenues. Vous devriez pouvoir v√©rifier qu'elles sont arriv√©es dans un seul paquet en utilisant Wireshark.

{% hint style="info" %}
Notez que cela **ne fonctionne pas pour les fichiers statiques** sur certains serveurs, mais les fichiers statiques ne sont pas pertinents pour les attaques par condition de course. Mais les fichiers statiques sont sans importance pour les attaques RC.
{% endhint %}

En utilisant cette technique, vous pouvez faire en sorte que 20 √† 30 requ√™tes arrivent simultan√©ment sur le serveur - ind√©pendamment du jitter du r√©seau :

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Adaptation √† l'architecture cible**

Il est important de noter que de nombreuses applications se trouvent derri√®re un serveur frontal, et celui-ci peut d√©cider de transf√©rer certaines requ√™tes sur des connexions existantes vers l'arri√®re-plan, et de cr√©er de nouvelles connexions pour d'autres.

Par cons√©quent, il est important de ne pas attribuer des d√©lais de requ√™te incoh√©rents au comportement de l'application, tel que des m√©canismes de verrouillage qui n'autorisent qu'un seul thread √† acc√©der √† une ressource √† la fois. De plus, le routage des requ√™tes c√¥t√© frontal est souvent effectu√© sur une base de connexion, vous pouvez donc lisser le d√©lai des requ√™tes en effectuant un pr√©chauffage de la connexion c√¥t√© serveur - **envoyer quelques requ√™tes insignifiantes sur votre connexion avant de lancer l'attaque** (il s'agit simplement d'envoyer plusieurs requ√™tes avant de commencer l'attaque proprement dite).

#### M√©canismes de verrouillage bas√©s sur la session <a href="#session-based-locking-mechanisms" id="session-based-locking-mechanisms"></a>

Certains frameworks tentent de pr√©venir la corruption accidentelle des donn√©es en utilisant une forme de **verrouillage de requ√™te**. Par exemple, le module de gestionnaire de session natif de **PHP ne traite qu'une seule requ√™te par session √† la fois**.

Il est extr√™mement important de rep√©rer ce type de comportement, car il peut masquer des vuln√©rabilit√©s facilement exploitables. Si vous remarquez que toutes vos requ√™tes sont trait√©es s√©quentiellement, essayez de les envoyer chacune avec un jeton de session diff√©rent.
#### **Abus des limites de taux ou de ressources**

Si le r√©chauffement de la connexion ne fait aucune diff√©rence, il existe diff√©rentes solutions √† ce probl√®me.

En utilisant Turbo Intruder, vous pouvez introduire un l√©ger d√©lai c√¥t√© client. Cependant, comme cela implique de diviser vos requ√™tes d'attaque r√©elles en plusieurs paquets TCP, vous ne pourrez pas utiliser la technique d'attaque en un seul paquet. Par cons√©quent, sur des cibles √† forte gigue, l'attaque est peu susceptible de fonctionner de mani√®re fiable, quel que soit le d√©lai que vous d√©finissez.

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Au lieu de cela, vous pouvez r√©soudre ce probl√®me en abusant d'une fonctionnalit√© de s√©curit√© courante.

Les serveurs Web retardent souvent le traitement des requ√™tes s'il en est envoy√© trop rapidement. En envoyant un grand nombre de requ√™tes factices pour d√©clencher intentionnellement la limite de taux ou de ressources, vous pouvez provoquer un d√©lai appropri√© c√¥t√© serveur. Cela rend l'attaque en un seul paquet viable m√™me lorsque l'ex√©cution retard√©e est n√©cessaire.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Pour plus d'informations sur cette technique, consultez le rapport original sur [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

#### Exemples d'attaque

* **Tubo Intruder - Attaque en un seul paquet HTTP2 (1 point d'extr√©mit√©)**: Vous pouvez envoyer la requ√™te √† **Turbo intruder** (`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`), vous pouvez modifier dans la requ√™te la valeur que vous souhaitez forcer pour **`%s`** comme dans `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s` puis s√©lectionnez **`examples/race-single-packer-attack.py`** dans la liste d√©roulante:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si vous allez **envoyer diff√©rentes valeurs**, vous pouvez modifier le code avec celui-ci qui utilise une liste de mots depuis le presse-papiers:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Si le site web ne prend pas en charge HTTP2 (seulement HTTP1.1), utilisez `Engine.THREADED` ou `Engine.BURP` √† la place de `Engine.BURP2`.
{% endhint %}

* **Tubo Intruder - Attaque √† un seul paquet HTTP2 (Plusieurs points d'extr√©mit√©)**: Si vous avez besoin d'envoyer une requ√™te √† un point d'extr√©mit√©, puis plusieurs √† d'autres points d'extr√©mit√© pour d√©clencher l'ex√©cution de code √† distance (RCE), vous pouvez modifier le script `race-single-packet-attack.py` comme suit:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Il est √©galement disponible dans **Repeater** via la nouvelle option '**Envoyer le groupe en parall√®le**' dans Burp Suite.
* Pour **d√©passer la limite**, vous pouvez simplement ajouter la **m√™me requ√™te 50 fois** dans le groupe.
* Pour **chauffer la connexion**, vous pouvez **ajouter** au **d√©but** du **groupe** quelques **requ√™tes** vers une partie non statique du serveur web.
* Pour **retarder** le processus **entre** le traitement **d'une requ√™te et d'une autre** en deux √©tapes de sous-√©tats, vous pouvez **ajouter des requ√™tes suppl√©mentaires entre** les deux requ√™tes.
* Pour un RC √† **multi-point d'extr√©mit√©**, vous pouvez commencer par envoyer la **requ√™te** qui **va vers l'√©tat cach√©** puis **50 requ√™tes** juste apr√®s qui **exploitent l'√©tat cach√©**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### BF brut

Avant les recherches pr√©c√©dentes, voici quelques charges utiles utilis√©es qui tentaient simplement d'envoyer les paquets aussi rapidement que possible pour provoquer un RC.

* **Repeater:** Consultez les exemples de la section pr√©c√©dente.
* **Intruder**: Envoyez la **requ√™te** √† **Intruder**, d√©finissez le **nombre de threads** sur **30** dans le menu **Options**, s√©lectionnez comme charge utile **Null payloads** et g√©n√©rez **30**.
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**

La biblioth√®que `asyncio` de Python est utilis√©e pour √©crire du code asynchrone de mani√®re concurrente. Elle permet d'ex√©cuter des t√¢ches en parall√®le, ce qui est particuli√®rement utile pour les op√©rations d'entr√©e/sortie (I/O) intensives, telles que les requ√™tes r√©seau.

L'approche asynchrone de `asyncio` repose sur des coroutines, qui sont des fonctions sp√©ciales pouvant √™tre suspendues et reprises ult√©rieurement. Cela permet d'√©viter les blocages et d'optimiser l'utilisation des ressources.

Pour utiliser `asyncio`, vous devez d√©finir des coroutines en utilisant le mot-cl√© `async` et les ex√©cuter √† l'aide de la boucle d'√©v√©nements `asyncio`. Vous pouvez √©galement utiliser des objets `Future` pour repr√©senter des r√©sultats futurs et des t√¢ches `Task` pour g√©rer l'ex√©cution des coroutines.

Voici un exemple simple d'utilisation de `asyncio` pour effectuer une requ√™te HTTP asynchrone :

```python
import asyncio
import aiohttp

async def fetch(url):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.text()

async def main():
    url = "https://example.com"
    response = await fetch(url)
    print(response)

loop = asyncio.get_event_loop()
loop.run_until_complete(main())
```

Dans cet exemple, la fonction `fetch` est une coroutine qui utilise la biblioth√®que `aiohttp` pour effectuer une requ√™te HTTP asynchrone. La fonction `main` est √©galement une coroutine qui appelle `fetch` et attend la r√©ponse.

En ex√©cutant le programme, vous verrez que la requ√™te est effectu√©e de mani√®re asynchrone, ce qui permet d'optimiser les performances en √©vitant les temps d'attente inutiles.

`asyncio` est un outil puissant pour √©crire du code asynchrone en Python, et il est largement utilis√© dans le d√©veloppement web, les applications r√©seau et d'autres domaines o√π la concurrence est essentielle.
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **M√©thodologie RC**

### D√©passement de limite / TOCTOU

Il s'agit du type le plus basique de condition de concurrence o√π des **vuln√©rabilit√©s** apparaissent dans des endroits qui **limitent le nombre de fois o√π vous pouvez effectuer une action**. Par exemple, utiliser plusieurs fois le m√™me code de r√©duction dans une boutique en ligne. Un exemple tr√®s simple peut √™tre trouv√© dans [**ce rapport**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) ou dans [**ce bogue**](https://hackerone.com/reports/759247)**.**

Il existe de nombreuses variations de ce type d'attaque, notamment :

* Utiliser plusieurs fois une carte-cadeau
* Noter un produit plusieurs fois
* Retirer ou transf√©rer de l'argent en exc√©dent de votre solde de compte
* R√©utiliser une solution CAPTCHA unique
* Contourner une limite de taux anti-brute-force

### **Sous-√©tats cach√©s**

Les RC les plus complexes exploiteront des **sous-√©tats dans l'√©tat de la machine** qui pourraient permettre √† un attaquant d'**abuser** d'√©tats auxquels il n'√©tait **jamais cens√© avoir acc√®s**, mais il existe une **petite fen√™tre** pour que l'attaquant y acc√®de.

1. **Pr√©dire les sous-√©tats cach√©s et int√©ressants potentiels**

La premi√®re √©tape consiste √† identifier tous les points d'extr√©mit√© qui √©crivent ou lisent des donn√©es √† partir de ceux-ci, puis utilisent ces donn√©es pour quelque chose d'important. Par exemple, les utilisateurs peuvent √™tre stock√©s dans une table de base de donn√©es qui est modifi√©e lors de l'inscription, de la modification du profil, de l'initiation de la r√©initialisation du mot de passe et de la finalisation de la r√©initialisation du mot de passe.

Nous pouvons utiliser trois questions cl√©s pour exclure les points d'extr√©mit√© qui sont peu susceptibles de provoquer des collisions. Pour chaque objet et les points d'extr√©mit√© associ√©s, demandez-vous :

* **Comment l'√©tat est-il stock√© ?**

Les donn√©es stock√©es dans une structure de donn√©es c√¥t√© serveur persistante sont id√©ales pour l'exploitation. Certains points d'extr√©mit√© stockent leur √©tat enti√®rement c√¥t√© client, comme les r√©initialisations de mot de passe qui fonctionnent en envoyant un JWT par e-mail - ceux-ci peuvent √™tre ignor√©s en toute s√©curit√©.

Les applications stockent souvent certains √©tats dans la session utilisateur. Ceux-ci sont souvent quelque peu prot√©g√©s contre les sous-√©tats - nous en parlerons plus tard.

* **Effectuons-nous une modification ou un ajout ?**

Les op√©rations qui modifient des donn√©es existantes (comme le changement de l'adresse e-mail principale d'un compte) ont un potentiel de collision important, tandis que les actions qui se contentent d'ajouter des donn√©es existantes (comme l'ajout d'une adresse e-mail suppl√©mentaire) sont peu susceptibles d'√™tre vuln√©rables √† autre chose que des attaques de d√©passement de limite.

* **Sur quoi l'op√©ration est-elle bas√©e ?**

La plupart des points d'extr√©mit√© fonctionnent sur un enregistrement sp√©cifique, qui est recherch√© √† l'aide d'une "cl√©", telle qu'un nom d'utilisateur, un jeton de r√©initialisation de mot de passe ou un nom de fichier. Pour une attaque r√©ussie, nous avons besoin de deux op√©rations qui utilisent la m√™me cl√©. Par exemple, imaginez deux impl√©mentations plausibles de r√©initialisation de mot de passe :

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

2. **Rechercher des indices**

√Ä ce stade, il est temps de **lancer des attaques RC** sur les points d'extr√©mit√© potentiellement int√©ressants pour essayer de trouver des r√©sultats inattendus par rapport aux r√©sultats r√©guliers. **Toute d√©viation de la r√©ponse attendue**, telle qu'un changement dans une ou plusieurs r√©ponses, ou un effet de second ordre tel que des contenus d'e-mail diff√©rents ou un changement visible dans votre session, pourrait √™tre un indice indiquant un probl√®me.

3. **Prouver le concept**

La derni√®re √©tape consiste √† **prouver le concept et √† le transformer en une attaque viable**.

Lorsque vous envoyez un lot de requ√™tes, vous pouvez constater qu'une paire de requ√™tes initiale d√©clenche un √©tat final vuln√©rable, mais que les requ√™tes ult√©rieures l'√©crasent/invalident et que l'√©tat final n'est pas exploitable. Dans ce sc√©nario, vous voudrez √©liminer toutes les requ√™tes inutiles - deux devraient suffire pour exploiter la plupart des vuln√©rabilit√©s. Cependant, passer √† deux requ√™tes rendra l'attaque plus sensible au timing, vous devrez donc peut-√™tre r√©essayer l'attaque plusieurs fois ou l'automatiser.

### Attaques sensibles au temps

Parfois, vous ne trouverez peut-√™tre pas de conditions de concurrence, mais les **techniques de livraison de requ√™tes avec une synchronisation pr√©cise** peuvent toujours r√©v√©ler la pr√©sence d'autres vuln√©rabilit√©s.

Un exemple est lorsque des **horodatages haute r√©solution sont utilis√©s au lieu de cha√Ænes al√©atoires cryptographiquement** s√©curis√©es pour g√©n√©rer des jetons de s√©curit√©.

Consid√©rez un **jeton de r√©initialisation de mot de passe qui n'est al√©atoire qu'√† l'aide d'un horodatage**. Dans ce cas, il pourrait √™tre possible de **d√©clencher deux r√©initialisations de mot de passe pour deux utilisateurs diff√©rents**, qui utilisent tous deux le **m√™me jeton**. Il vous suffit de synchroniser les requ√™tes de mani√®re √† ce qu'elles g√©n√®rent le m√™me horodatage.

{% hint style="warning" %}
Pour confirmer par exemple la situation pr√©c√©dente, vous pourriez simplement demander **2 jetons de r√©initialisation de mot de passe en m√™me temps** (en utilisant une attaque √† paquet unique) et v√©rifier s'ils sont **identiques**.
{% endhint %}

Consultez l'[**exemple dans ce laboratoire**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities).

## √âtudes de cas sur les sous-√©tats cach√©s

### Payer et ajouter un article

[**Consultez ce laboratoire**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) pour voir comment **payer** dans un magasin et **ajouter un article suppl√©mentaire** pour lequel vous n'aurez pas besoin de payer.

### Confirmer d'autres e-mails

L'id√©e est de **v√©rifier une adresse e-mail et de la changer en une autre en m√™me temps** pour savoir si la plateforme v√©rifie la nouvelle adresse modifi√©e.

### Changer l'e-mail en 2 adresses e-mail bas√©es sur les cookies

Selon [**cet article**](https://portswigger.net/research/smashing-the-state-machine), Gitlab √©tait vuln√©rable √† une prise de contr√¥le de cette mani√®re car il pourrait **envoyer** le **jeton de v√©rification d'e-mail d'un e-mail √† l'autre**.

Vous pouvez √©galement consulter [**ce laboratoire**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) pour en savoir plus √† ce sujet.

### √âtats cach√©s de la base de donn√©es / Contournement de confirmation

Si **2 √©critures diff√©rentes** sont utilis√©es pour **ajouter** des **informations** dans une **base de donn√©es**, il existe une petite p√©riode de temps o√π **seules les premi√®res donn√©es ont √©t√© √©crites** dans la base de donn√©es. Par exemple, lors de la cr√©ation d'un utilisateur, le **nom d'utilisateur** et le **mot de passe** peuvent √™tre **√©crits**, puis le jeton pour confirmer le compte nouvellement cr√©√© est √©crit. Cela signifie que pendant un court laps de temps, le **jeton pour confirmer un compte est nul**.

Par cons√©quent, **enregistrer un compte et envoyer plusieurs requ√™tes avec un jeton vide** (`token=` ou `token[]=` ou toute autre variation) pour confirmer le compte imm√©diatement pourrait permettre de confirmer un compte dont vous ne contr√¥lez pas l'e-mail.

Consultez [**ce laboratoire**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) pour voir un exemple.

### Contourner l'authentification √† deux facteurs (2FA)

Le pseudo-code suivant montre comment un site web pourrait √™tre vuln√©rable √† une variation de cette attaque bas√©e sur la concurrence :
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
Comme vous pouvez le voir, il s'agit en fait d'une **s√©quence en plusieurs √©tapes dans le cadre d'une seule requ√™te**. Plus important encore, elle passe par un sous-√©tat dans lequel l'utilisateur dispose temporairement d'une session valide connect√©e, **mais o√π la MFA n'est pas encore appliqu√©e**. Un attaquant pourrait potentiellement exploiter cela en envoyant une demande de connexion ainsi qu'une demande vers un point de terminaison sensible et authentifi√©.

### Persistance √©ternelle d'OAuth2

Il existe plusieurs [**fournisseurs OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Ces services vous permettent de cr√©er une application et d'authentifier les utilisateurs enregistr√©s aupr√®s du fournisseur. Pour ce faire, le **client** devra **autoriser votre application** √† acc√©der √† certaines de leurs donn√©es √† l'int√©rieur du **fournisseur OAuth**.\
Jusqu'ici, il s'agit simplement d'une connexion classique avec Google/LinkedIn/GitHub... o√π vous √™tes invit√© avec une page disant : "_L'application \<InsertCoolName> souhaite acc√©der √† vos informations, voulez-vous l'autoriser ?_"

#### Race Condition dans `authorization_code`

Le **probl√®me** survient lorsque vous **l'acceptez** et envoyez automatiquement un **`authorization_code`** √† l'application malveillante. Ensuite, cette **application exploite une Race Condition dans le fournisseur de services OAuth pour g√©n√©rer plus d'un AT/RT** (_Authentication Token/Refresh Token_) √† partir du **`authorization_code`** pour votre compte. Fondamentalement, elle exploitera le fait que vous avez accept√© l'application pour acc√©der √† vos donn√©es afin de **cr√©er plusieurs comptes**. Ensuite, si vous **arr√™tez d'autoriser l'application √† acc√©der √† vos donn√©es, une paire AT/RT sera supprim√©e, mais les autres resteront valides**.

#### Race Condition dans `Refresh Token`

Une fois que vous avez **obtenu un RT valide**, vous pouvez essayer de **l'exploiter pour g√©n√©rer plusieurs AT/RT** et m√™me si l'utilisateur annule les autorisations pour l'application malveillante d'acc√©der √† ses donn√©es, **plusieurs RT resteront valides**.

## **RC dans les WebSockets**

Dans [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC), vous pouvez trouver un PoC en Java pour envoyer des messages WebSocket en **parall√®le** afin d'exploiter **√©galement les Race Conditions dans les WebSockets**.

## R√©f√©rences

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs.
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com).
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour cr√©er et automatiser facilement des workflows aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
