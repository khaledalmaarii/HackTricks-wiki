{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML √úbersicht

**Security Assertion Markup Language (SAML)** erm√∂glicht es Identit√§tsanbietern (IdP), Autorisierungsanmeldeinformationen an Dienstanbieter (SP) zu senden, was Single Sign-On (SSO) erleichtert. Dieser Ansatz vereinfacht die Verwaltung mehrerer Anmeldungen, indem ein einzelnes Set von Anmeldeinformationen √ºber mehrere Websites hinweg verwendet werden kann. Es nutzt XML f√ºr die standardisierte Kommunikation zwischen IdPs und SPs und verkn√ºpft die Authentifizierung der Benutzeridentit√§t mit der Dienstautorisierung.

## Vergleich zwischen SAML und OAuth

- **SAML** ist darauf ausgelegt, Unternehmen mehr Kontrolle √ºber die Sicherheit von SSO-Anmeldungen zu geben.
- **OAuth** ist darauf ausgelegt, mobilfreundlicher zu sein, verwendet JSON und ist eine gemeinsame Anstrengung von Unternehmen wie Google und Twitter.

# SAML Authentifizierungsfluss

**F√ºr weitere Details siehe den vollst√§ndigen Beitrag von [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Dies ist eine Zusammenfassung:

Der SAML-Authentifizierungsprozess umfasst mehrere Schritte, wie im Schema dargestellt:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Zugriffsversuch auf Ressource**: Der Benutzer versucht, auf eine gesch√ºtzte Ressource zuzugreifen.
2. **SAML-Anforderungs-Generierung**: Der SP erkennt den Benutzer nicht und generiert eine SAML-Anforderung.
3. **Weiterleitung zum IdP**: Der Benutzer wird zum IdP weitergeleitet, wobei die SAML-Anforderung durch den Browser des Benutzers geleitet wird.
4. **IdP erh√§lt Anfrage**: Der IdP erh√§lt die SAML-Anforderung.
5. **Authentifizierung beim IdP**: Der IdP authentifiziert den Benutzer.
6. **Benutzerg√ºltigkeit**: Der IdP validiert die Legitimit√§t des Benutzers, um auf die angeforderte Ressource zuzugreifen.
7. **SAML-Antworterstellung**: Der IdP generiert eine SAML-Antwort, die notwendige Aussagen enth√§lt.
8. **Weiterleitung zur ACS-URL des SP**: Der Benutzer wird zur Assertion Consumer Service (ACS)-URL des SP weitergeleitet.
9. **Validierung der SAML-Antwort**: Die ACS validiert die SAML-Antwort.
10. **Zugriff auf Ressource gew√§hrt**: Der Zugriff auf die urspr√ºnglich angeforderte Ressource wird gew√§hrt.

# SAML-Anforderungsbeispiel

Betrachten Sie das Szenario, in dem ein Benutzer Zugriff auf eine sichere Ressource unter [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/) anfordert. Der SP erkennt das Fehlen einer Authentifizierung und generiert eine SAML-Anforderung:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Der rohe SAML-Antrag sieht folgenderma√üen aus:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: Gibt an, wohin der IdP die SAML-Antwort nach der Authentifizierung senden soll.
- **Destination**: Die Adresse des IdP, an die die Anfrage gesendet wird.
- **ProtocolBinding**: Definiert die √úbertragungsmethode von SAML-Protokollnachrichten.
- **saml:Issuer**: Identifiziert die Entit√§t, die die Anfrage initiiert hat.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: Dieser Abschnitt, eine XML-Signatur, gew√§hrleistet die Integrit√§t und Authentizit√§t des Ausstellers der Assertion. Die SAML-Antwort im Beispiel enth√§lt zwei `ds:Signature`-Elemente, eines f√ºr die Nachricht und das andere f√ºr die Assertion.
- **saml:Assertion**: Dieser Teil enth√§lt Informationen √ºber die Identit√§t des Benutzers und m√∂glicherweise andere Attribute.
- **saml:Subject**: Es gibt das Hauptsubjekt aller Aussagen in der Assertion an.
- **saml:StatusCode**: Stellt den Status der Operation als Antwort auf die entsprechende Anfrage dar.
- **saml:Conditions**: Enth√§lt Bedingungen wie die G√ºltigkeitsdauer der Assertion und den angegebenen Service Provider.
- **saml:AuthnStatement**: Best√§tigt, dass der IdP das Subjekt der Assertion authentifiziert hat.
- **saml:AttributeStatement**: Enth√§lt Attribute, die das Subjekt der Assertion beschreiben.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML-Signaturen sind vielseitig und k√∂nnen einen gesamten XML-Baum oder spezifische Elemente darin signieren. Sie k√∂nnen auf jedes XML-Objekt angewendet werden, nicht nur auf Antwort-Elemente. Below are the key types of XML Signatures:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Jedes `Reference`-Element kennzeichnet eine spezifische Ressource, die signiert wird, identifizierbar durch das URI-Attribut.

### Arten von XML-Signaturen

1. **Eingebettete Signatur**: Diese Art von Signatur ist ein Nachkomme der Ressource, die sie signiert, was bedeutet, dass die Signatur innerhalb derselben XML-Struktur wie der signierte Inhalt enthalten ist.

Beispiel:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

In einer eingebetteten Signatur gibt das `ds:Transform`-Element an, dass sie durch den `enveloped-signature`-Algorithmus eingebettet ist.

2. **Umh√ºllende Signatur**: Im Gegensatz zu eingebetteten Signaturen umh√ºllen umh√ºllende Signaturen die Ressource, die signiert wird.

Beispiel:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Getrennte Signatur**: Diese Art ist von dem Inhalt, den sie signiert, getrennt. Die Signatur und der Inhalt existieren unabh√§ngig, aber eine Verbindung zwischen beiden wird aufrechterhalten.

Beispiel:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

Zusammenfassend bieten XML-Signaturen flexible M√∂glichkeiten zur Sicherung von XML-Dokumenten, wobei jeder Typ unterschiedliche strukturelle und sicherheitstechnische Bed√ºrfnisse erf√ºllt.


## Referenzen
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
