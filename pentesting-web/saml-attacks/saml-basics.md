{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML ê°œìš”

**Security Assertion Markup Language (SAML)**ëŠ” ì„œë¹„ìŠ¤ ì œê³µì(SP)ì—ê²Œ ê¶Œí•œ ë¶€ì—¬ ìê²© ì¦ëª…ì„ ì „ì†¡í•˜ê¸° ìœ„í•´ ì•„ì´ë´í‹°í‹° ì œê³µì(IdP)ë¥¼ í™œìš©í•  ìˆ˜ ìˆê²Œ í•˜ì—¬ ë‹¨ì¼ ë¡œê·¸ì¸(SSO)ì„ ì´‰ì§„í•©ë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ì—¬ëŸ¬ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ë‹¨ì¼ ìê²© ì¦ëª…ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì—¬ ì—¬ëŸ¬ ë¡œê·¸ì¸ ê´€ë¦¬ë¥¼ ê°„ì†Œí™”í•©ë‹ˆë‹¤. SAMLì€ IdPì™€ SP ê°„ì˜ í‘œì¤€í™”ëœ í†µì‹ ì„ ìœ„í•´ XMLì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ì ì•„ì´ë´í‹°í‹°ì˜ ì¸ì¦ê³¼ ì„œë¹„ìŠ¤ ê¶Œí•œ ë¶€ì—¬ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.

## SAMLê³¼ OAuth ë¹„êµ

- **SAML**ì€ ê¸°ì—…ì´ SSO ë¡œê·¸ì¸ ë³´ì•ˆì„ ë³´ë‹¤ ì˜ ì œì–´í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
- **OAuth**ëŠ” ëª¨ë°”ì¼ ì¹œí™”ì ìœ¼ë¡œ ì„¤ê³„ë˜ì—ˆìœ¼ë©°, JSONì„ ì‚¬ìš©í•˜ê³  Google ë° Twitterì™€ ê°™ì€ íšŒì‚¬ì˜ í˜‘ë ¥ìœ¼ë¡œ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤.

# SAML ì¸ì¦ íë¦„

**ìì„¸í•œ ë‚´ìš©ì€ [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)ì˜ ì „ì²´ ê²Œì‹œë¬¼ì„ í™•ì¸í•˜ì„¸ìš”.** ë‹¤ìŒì€ ìš”ì•½ì…ë‹ˆë‹¤:

SAML ì¸ì¦ í”„ë¡œì„¸ìŠ¤ëŠ” ì—¬ëŸ¬ ë‹¨ê³„ë¥¼ í¬í•¨í•˜ë©°, ì´ëŠ” ìŠ¤í‚¤ë§ˆì— ì„¤ëª…ë˜ì–´ ìˆìŠµë‹ˆë‹¤:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ ì‹œë„**: ì‚¬ìš©ìê°€ ë³´í˜¸ëœ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•˜ë ¤ê³  í•©ë‹ˆë‹¤.
2. **SAML ìš”ì²­ ìƒì„±**: SPëŠ” ì‚¬ìš©ìë¥¼ ì¸ì‹í•˜ì§€ ëª»í•˜ê³  SAML ìš”ì²­ì„ ìƒì„±í•©ë‹ˆë‹¤.
3. **IdPë¡œ ë¦¬ë””ë ‰ì…˜**: ì‚¬ìš©ìëŠ” IdPë¡œ ë¦¬ë””ë ‰ì…˜ë˜ë©°, SAML ìš”ì²­ì€ ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ì „ë‹¬ë©ë‹ˆë‹¤.
4. **IdPê°€ ìš”ì²­ ìˆ˜ì‹ **: IdPëŠ” SAML ìš”ì²­ì„ ìˆ˜ì‹ í•©ë‹ˆë‹¤.
5. **IdPì—ì„œ ì¸ì¦**: IdPëŠ” ì‚¬ìš©ìë¥¼ ì¸ì¦í•©ë‹ˆë‹¤.
6. **ì‚¬ìš©ì ê²€ì¦**: IdPëŠ” ìš”ì²­ëœ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì‚¬ìš©ìì˜ ì •ë‹¹ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.
7. **SAML ì‘ë‹µ ìƒì„±**: IdPëŠ” í•„ìš”í•œ ì£¼ì¥ì„ í¬í•¨í•œ SAML ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
8. **SPì˜ ACS URLë¡œ ë¦¬ë””ë ‰ì…˜**: ì‚¬ìš©ìëŠ” SPì˜ Assertion Consumer Service (ACS) URLë¡œ ë¦¬ë””ë ‰ì…˜ë©ë‹ˆë‹¤.
9. **SAML ì‘ë‹µ ê²€ì¦**: ACSëŠ” SAML ì‘ë‹µì„ ê²€ì¦í•©ë‹ˆë‹¤.
10. **ë¦¬ì†ŒìŠ¤ ì ‘ê·¼ í—ˆìš©**: ì²˜ìŒ ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ì´ í—ˆìš©ë©ë‹ˆë‹¤.

# SAML ìš”ì²­ ì˜ˆì‹œ

ì‚¬ìš©ìê°€ [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/)ì—ì„œ ë³´ì•ˆ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ì„ ìš”ì²­í•˜ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê³ ë ¤í•´ ë³´ì„¸ìš”. SPëŠ” ì¸ì¦ì´ ì—†ìŒì„ ì¸ì‹í•˜ê³  SAML ìš”ì²­ì„ ìƒì„±í•©ë‹ˆë‹¤:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
ì›ì‹œ SAML ìš”ì²­ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: IdPê°€ ì¸ì¦ í›„ SAML ì‘ë‹µì„ ë³´ë‚¼ ìœ„ì¹˜ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
- **Destination**: ìš”ì²­ì´ ì „ì†¡ë˜ëŠ” IdPì˜ ì£¼ì†Œì…ë‹ˆë‹¤.
- **ProtocolBinding**: SAML í”„ë¡œí† ì½œ ë©”ì‹œì§€ì˜ ì „ì†¡ ë°©ë²•ì„ ì •ì˜í•©ë‹ˆë‹¤.
- **saml:Issuer**: ìš”ì²­ì„ ì‹œì‘í•œ ì—”í„°í‹°ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: ì´ ì„¹ì…˜ì€ XML ì„œëª…ìœ¼ë¡œ, ì–´ì„¤ì…˜ ë°œí–‰ìì˜ ë¬´ê²°ì„±ê³¼ ì§„ìœ„ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤. ì˜ˆì œì˜ SAML ì‘ë‹µì—ëŠ” ë©”ì‹œì§€ìš©ê³¼ ì–´ì„¤ì…˜ìš© ë‘ ê°œì˜ `ds:Signature` ìš”ì†Œê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- **saml:Assertion**: ì´ ë¶€ë¶„ì€ ì‚¬ìš©ìì˜ ì‹ ì› ë° ê¸°íƒ€ ì†ì„±ì— ëŒ€í•œ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
- **saml:Subject**: ì–´ì„¤ì…˜ì˜ ëª¨ë“  ì§„ìˆ ì˜ ì£¼ì²´ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
- **saml:StatusCode**: í•´ë‹¹ ìš”ì²­ì— ëŒ€í•œ ì‘ì—…ì˜ ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
- **saml:Conditions**: ì–´ì„¤ì…˜ì˜ ìœ íš¨ì„± íƒ€ì´ë° ë° ì§€ì •ëœ ì„œë¹„ìŠ¤ ì œê³µìì™€ ê°™ì€ ì¡°ê±´ì„ ìì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
- **saml:AuthnStatement**: IdPê°€ ì–´ì„¤ì…˜ì˜ ì£¼ì²´ë¥¼ ì¸ì¦í–ˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
- **saml:AttributeStatement**: ì–´ì„¤ì…˜ì˜ ì£¼ì²´ë¥¼ ì„¤ëª…í•˜ëŠ” ì†ì„±ì„ í¬í•¨í•©ë‹ˆë‹¤.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML Signatures are versatile, capable of signing an entire XML tree or specific elements within it. They can be applied to any XML Object, not just Response elements. Below are the key types of XML Signatures:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
ê° `Reference` ìš”ì†ŒëŠ” URI ì†ì„±ìœ¼ë¡œ ì‹ë³„ ê°€ëŠ¥í•œ ì„œëª…ëœ íŠ¹ì • ë¦¬ì†ŒìŠ¤ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

### XML ì„œëª…ì˜ ìœ í˜•

1. **Enveloped Signature**: ì´ ìœ í˜•ì˜ ì„œëª…ì€ ì„œëª…í•˜ëŠ” ë¦¬ì†ŒìŠ¤ì˜ ìì†ìœ¼ë¡œ, ì„œëª…ì´ ì„œëª…ëœ ì½˜í…ì¸ ì™€ ë™ì¼í•œ XML êµ¬ì¡° ë‚´ì— í¬í•¨ë˜ì–´ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

ì˜ˆì‹œ:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

enveloped ì„œëª…ì—ì„œ `ds:Transform` ìš”ì†ŒëŠ” `enveloped-signature` ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ envelopedë˜ì—ˆìŒì„ ì§€ì •í•©ë‹ˆë‹¤.

2. **Enveloping Signature**: enveloped ì„œëª…ê³¼ ëŒ€ì¡°ì ìœ¼ë¡œ, enveloping ì„œëª…ì€ ì„œëª…ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ê°ìŒ‰ë‹ˆë‹¤.

ì˜ˆì‹œ:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Detached Signature**: ì´ ìœ í˜•ì€ ì„œëª…í•˜ëŠ” ì½˜í…ì¸ ì™€ ë¶„ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì„œëª…ê³¼ ì½˜í…ì¸ ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì¡´ì¬í•˜ì§€ë§Œ, ë‘ ì‚¬ì´ì˜ ë§í¬ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.

ì˜ˆì‹œ:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

ê²°ë¡ ì ìœ¼ë¡œ, XML ì„œëª…ì€ XML ë¬¸ì„œë¥¼ ë³´í˜¸í•˜ëŠ” ìœ ì—°í•œ ë°©ë²•ì„ ì œê³µí•˜ë©°, ê° ìœ í˜•ì€ ì„œë¡œ ë‹¤ë¥¸ êµ¬ì¡°ì  ë° ë³´ì•ˆ ìš”êµ¬ë¥¼ ì¶©ì¡±í•©ë‹ˆë‹¤.


## References
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
