{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML Genel BakÄ±ÅŸ

**Security Assertion Markup Language (SAML)**, kimlik saÄŸlayÄ±cÄ±larÄ±nÄ±n (IdP) hizmet saÄŸlayÄ±cÄ±larÄ±na (SP) yetkilendirme kimlik bilgilerini gÃ¶ndermesine olanak tanÄ±r ve tek oturum aÃ§ma (SSO) iÅŸlemini kolaylaÅŸtÄ±rÄ±r. Bu yaklaÅŸÄ±m, bir dizi kimlik bilgisi kullanarak birden fazla web sitesinde oturum aÃ§mayÄ± yÃ¶netmeyi basitleÅŸtirir. IdP'ler ve SP'ler arasÄ±nda standartlaÅŸtÄ±rÄ±lmÄ±ÅŸ iletiÅŸim iÃ§in XML kullanÄ±r ve kullanÄ±cÄ± kimliÄŸinin doÄŸrulanmasÄ±nÄ± hizmet yetkilendirmesi ile iliÅŸkilendirir.

## SAML ve OAuth ArasÄ±ndaki KarÅŸÄ±laÅŸtÄ±rma

- **SAML**, iÅŸletmelere SSO oturum aÃ§ma gÃ¼venliÄŸi Ã¼zerinde daha fazla kontrol saÄŸlamak iÃ§in tasarlanmÄ±ÅŸtÄ±r.
- **OAuth**, daha mobil dostu olacak ÅŸekilde tasarlanmÄ±ÅŸ, JSON kullanÄ±r ve Google ve Twitter gibi ÅŸirketlerin ortak Ã§abasÄ±dÄ±r.

# SAML Kimlik DoÄŸrulama AkÄ±ÅŸÄ±

**Daha fazla ayrÄ±ntÄ± iÃ§in [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/) adresindeki tam gÃ¶nderiyi kontrol edin.** Bu bir Ã¶zet:

SAML kimlik doÄŸrulama sÃ¼reci, ÅŸemada gÃ¶sterildiÄŸi gibi birkaÃ§ adÄ±m iÃ§erir:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **KaynaÄŸa EriÅŸim Denemesi**: KullanÄ±cÄ± korumalÄ± bir kaynaÄŸa eriÅŸmeye Ã§alÄ±ÅŸÄ±r.
2. **SAML Ä°steÄŸi OluÅŸturma**: SP, kullanÄ±cÄ±yÄ± tanÄ±maz ve bir SAML Ä°steÄŸi oluÅŸturur.
3. **IdP'ye YÃ¶nlendirme**: KullanÄ±cÄ±, SAML Ä°steÄŸi kullanÄ±cÄ±nÄ±n tarayÄ±cÄ±sÄ±ndan geÃ§erek IdP'ye yÃ¶nlendirilir.
4. **IdP Ä°steÄŸi AlÄ±r**: IdP, SAML Ä°steÄŸini alÄ±r.
5. **IdP'de Kimlik DoÄŸrulama**: IdP, kullanÄ±cÄ±yÄ± kimlik doÄŸrular.
6. **KullanÄ±cÄ± DoÄŸrulamasÄ±**: IdP, kullanÄ±cÄ±nÄ±n talep edilen kaynaÄŸa eriÅŸim yetkisini doÄŸrular.
7. **SAML YanÄ±tÄ± OluÅŸturma**: IdP, gerekli beyanlarÄ± iÃ§eren bir SAML YanÄ±tÄ± oluÅŸturur.
8. **SP'nin ACS URL'sine YÃ¶nlendirme**: KullanÄ±cÄ±, SP'nin Beyan TÃ¼ketim Servisi (ACS) URL'sine yÃ¶nlendirilir.
9. **SAML YanÄ±tÄ± DoÄŸrulama**: ACS, SAML YanÄ±tÄ±nÄ± doÄŸrular.
10. **KaynaÄŸa EriÅŸim Verildi**: Ä°lk talep edilen kaynaÄŸa eriÅŸim verilir.

# SAML Ä°steÄŸi Ã–rneÄŸi

Bir kullanÄ±cÄ±nÄ±n [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/) adresindeki gÃ¼venli bir kaynaÄŸa eriÅŸim talep ettiÄŸi senaryoyu dÃ¼ÅŸÃ¼nÃ¼n. SP, kimlik doÄŸrulamanÄ±n eksikliÄŸini tespit eder ve bir SAML Ä°steÄŸi oluÅŸturur:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Ham SAML Ä°steÄŸi ÅŸu ÅŸekilde gÃ¶rÃ¼nÃ¼r:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: IdP'nin kimlik doÄŸrulama sonrasÄ± SAML YanÄ±tÄ±nÄ± gÃ¶ndermesi gereken yeri belirtir.
- **Destination**: Talebin gÃ¶nderildiÄŸi IdP'nin adresi.
- **ProtocolBinding**: SAML protokol mesajlarÄ±nÄ±n iletim yÃ¶ntemini tanÄ±mlar.
- **saml:Issuer**: Talebi baÅŸlatan varlÄ±ÄŸÄ± tanÄ±mlar.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: Bu bÃ¶lÃ¼m, bir XML Ä°mzasÄ±dÄ±r ve beyanÄ±n vericisinin bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ ve doÄŸruluÄŸunu saÄŸlar. Ã–rnekteki SAML yanÄ±tÄ±, bir mesaj iÃ§in ve diÄŸeri beyan iÃ§in olmak Ã¼zere iki `ds:Signature` Ã¶ÄŸesi iÃ§erir.
- **saml:Assertion**: Bu kÄ±sÄ±m, kullanÄ±cÄ±nÄ±n kimliÄŸi ve muhtemelen diÄŸer nitelikler hakkÄ±nda bilgi tutar.
- **saml:Subject**: Beyandaki tÃ¼m ifadelerin ana konusunu belirtir.
- **saml:StatusCode**: Ä°lgili talebe yanÄ±t olarak iÅŸlemin durumunu temsil eder.
- **saml:Conditions**: BeyanÄ±n geÃ§erlilik sÃ¼resi ve belirtilen Hizmet SaÄŸlayÄ±cÄ± gibi koÅŸullarÄ± detaylandÄ±rÄ±r.
- **saml:AuthnStatement**: IdP'nin BeyanÄ±n konusunu kimlik doÄŸruladÄ±ÄŸÄ±nÄ± onaylar.
- **saml:AttributeStatement**: BeyanÄ±n konusunu tanÄ±mlayan nitelikleri iÃ§erir.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML Ä°mzalarÄ± Ã§ok yÃ¶nlÃ¼dÃ¼r, bir XML aÄŸacÄ±nÄ± veya iÃ§indeki belirli Ã¶ÄŸeleri imzalamak iÃ§in kullanÄ±labilirler. Herhangi bir XML Nesnesine, yalnÄ±zca YanÄ±t Ã¶ÄŸelerine deÄŸil, uygulanabilirler. AÅŸaÄŸÄ±da XML Ä°mzalarÄ±nÄ±n ana tÃ¼rleri bulunmaktadÄ±r:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Her `Reference` elementi, URI niteliÄŸi ile tanÄ±mlanabilen, imzalanan belirli bir kaynaÄŸÄ± belirtir.

### XML Ä°mzalarÄ±nÄ±n TÃ¼rleri

1. **Enveloped Signature**: Bu tÃ¼r imza, imzaladÄ±ÄŸÄ± kaynaÄŸÄ±n bir alt kÃ¼mesidir, yani imza, imzalanan iÃ§erikle aynÄ± XML yapÄ±sÄ± iÃ§inde yer alÄ±r.

Ã–rnek:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

Enveloped signature'da, `ds:Transform` elementi, imzanÄ±n `enveloped-signature` algoritmasÄ± ile sarÄ±ldÄ±ÄŸÄ±nÄ± belirtir.

2. **Enveloping Signature**: Enveloped signature'larÄ±n aksine, enveloping signature'lar imzalanan kaynaÄŸÄ± sarar.

Ã–rnek:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Detached Signature**: Bu tÃ¼r, imzaladÄ±ÄŸÄ± iÃ§erikten ayrÄ±dÄ±r. Ä°mza ve iÃ§erik baÄŸÄ±msÄ±z olarak var olur, ancak ikisi arasÄ±nda bir baÄŸlantÄ± korunur.

Ã–rnek:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

SonuÃ§ olarak, XML Ä°mzalarÄ±, XML belgelerini gÃ¼vence altÄ±na almak iÃ§in esnek yollar sunar; her tÃ¼r, farklÄ± yapÄ±sal ve gÃ¼venlik ihtiyaÃ§larÄ±nÄ± karÅŸÄ±lar.


## References
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
