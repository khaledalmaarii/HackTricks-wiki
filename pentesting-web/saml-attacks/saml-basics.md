{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


# SAML Overview

**Security Assertion Markup Language (SAML)** umo偶liwia wykorzystanie dostawc贸w to偶samoci (IdP) do przesyania powiadcze autoryzacyjnych do dostawc贸w usug (SP), co uatwia jednolity dostp (SSO). To podejcie upraszcza zarzdzanie wieloma logowaniami, pozwalajc na u偶ycie jednego zestawu powiadcze na wielu stronach internetowych. Wykorzystuje XML do standaryzowanej komunikacji midzy IdP a SP, czc uwierzytelnienie to偶samoci u偶ytkownika z autoryzacj usugi.

## Comparison between SAML and OAuth

- **SAML** jest dostosowany do zapewnienia przedsibiorstwom wikszej kontroli nad bezpieczestwem logowania SSO.
- **OAuth** jest zaprojektowany z myl o wikszej przyjaznoci dla urzdze mobilnych, u偶ywa JSON i jest wsp贸lnym wysikiem firm takich jak Google i Twitter.

# SAML Authentication Flow

**For further details check the full post from [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. This is a summary:

Proces uwierzytelniania SAML obejmuje kilka krok贸w, jak pokazano w schemacie:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Pr贸ba dostpu do zasobu**: U偶ytkownik pr贸buje uzyska dostp do chronionego zasobu.
2. **Generowanie 偶dania SAML**: SP nie rozpoznaje u偶ytkownika i generuje 偶danie SAML.
3. **Przekierowanie do IdP**: U偶ytkownik jest przekierowywany do IdP, a 偶danie SAML przechodzi przez przegldark u偶ytkownika.
4. **IdP odbiera 偶danie**: IdP odbiera 偶danie SAML.
5. **Uwierzytelnienie w IdP**: IdP uwierzytelnia u偶ytkownika.
6. **Walidacja u偶ytkownika**: IdP weryfikuje legalno u偶ytkownika do uzyskania dostpu do 偶danego zasobu.
7. **Tworzenie odpowiedzi SAML**: IdP generuje odpowied藕 SAML zawierajc niezbdne asercje.
8. **Przekierowanie do URL ACS SP**: U偶ytkownik jest przekierowywany do URL usugi konsumpcji asercji (ACS) SP.
9. **Walidacja odpowiedzi SAML**: ACS weryfikuje odpowied藕 SAML.
10. **Dostp do zasobu przyznany**: Przyznano dostp do pocztkowo 偶danego zasobu.

# SAML Request Example

Rozwa偶my scenariusz, w kt贸rym u偶ytkownik 偶da dostpu do zabezpieczonego zasobu na [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). SP identyfikuje brak uwierzytelnienia i generuje 偶danie SAML:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Surowe 偶danie SAML wyglda tak:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Key elements of this request include:
- **AssertionConsumerServiceURL**: Okrela, gdzie IdP powinien wysa SAML Response po uwierzytelnieniu.
- **Destination**: Adres IdP, do kt贸rego wysyane jest 偶danie.
- **ProtocolBinding**: Definiuje metod przesyania wiadomoci protokou SAML.
- **saml:Issuer**: Identyfikuje podmiot, kt贸ry zainicjowa 偶danie.

Following the SAML Request generation, the SP responds with a **302 redirect**, directing the browser to the IdP with the SAML Request encoded in the HTTP response's **Location** header. The **RelayState** parameter maintains the state information throughout the transaction, ensuring the SP recognizes the initial resource request upon receiving the SAML Response. The **SAMLRequest** parameter is a compressed and encoded version of the raw XML snippet, utilizing Deflate compression and base64 encoding.


# SAML Response Example

You can find a [full SAML response here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). The key components of the response include:

- **ds:Signature**: Ta sekcja, bdca podpisem XML, zapewnia integralno i autentyczno wystawcy asercji. Odpowied藕 SAML w przykadzie zawiera dwa elementy `ds:Signature`, jeden dla wiadomoci, a drugi dla asercji.
- **saml:Assertion**: Ta cz zawiera informacje o to偶samoci u偶ytkownika i ewentualnie inne atrybuty.
- **saml:Subject**: Okrela g贸wny podmiot wszystkich stwierdze w asercji.
- **saml:StatusCode**: Reprezentuje status operacji w odpowiedzi na odpowiadajce 偶danie.
- **saml:Conditions**: Szczeg贸y dotyczce warunk贸w, takich jak czas wa偶noci Asercji i okrelony Dostawca Usug.
- **saml:AuthnStatement**: Potwierdza, 偶e IdP uwierzytelni podmiot Asercji.
- **saml:AttributeStatement**: Zawiera atrybuty opisujce podmiot Asercji.

Following the SAML Response, the process includes a 302 redirect from the IdP. This leads to a POST request to the Service Provider's Assertion Consumer Service (ACS) URL. The POST request includes `RelayState` and `SAMLResponse` parameters. The ACS is responsible for processing and validating the SAML Response.

After the POST request is received and the SAML Response is validated, access is granted to the protected resource initially requested by the user. This is illustrated with a `GET` request to the `/secure/` endpoint and a `200 OK` response, indicating successful access to the resource.


# XML Signatures

XML Signatures are versatile, capable of signing an entire XML tree or specific elements within it. They can be applied to any XML Object, not just Response elements. Below are the key types of XML Signatures:

### Basic Structure of XML Signature
An XML Signature consists of essential elements as shown:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Ka偶dy element `Reference` oznacza konkretny zas贸b, kt贸ry jest podpisywany, identyfikowalny za pomoc atrybutu URI.

### Typy podpis贸w XML

1. **Podpis osadzony**: Ten typ podpisu jest potomkiem zasobu, kt贸ry podpisuje, co oznacza, 偶e podpis jest zawarty w tej samej strukturze XML co podpisana tre.

Przykad:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

W podpisie osadzonym element `ds:Transform` okrela, 偶e jest on osadzony za pomoc algorytmu `enveloped-signature`.

2. **Podpis otaczajcy**: W przeciwiestwie do podpis贸w osadzonych, podpisy otaczajce owijaj zas贸b, kt贸ry jest podpisywany.

Przykad:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Podpis oddzielony**: Ten typ jest oddzielony od treci, kt贸r podpisuje. Podpis i tre istniej niezale偶nie, ale utrzymywany jest midzy nimi link.

Przykad:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

Podsumowujc, podpisy XML oferuj elastyczne sposoby zabezpieczania dokument贸w XML, z ka偶dym typem speniajcym r贸偶ne potrzeby strukturalne i bezpieczestwa.


## Odniesienia
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
