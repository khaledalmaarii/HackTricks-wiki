# MySQL File priv to SSRF/RCE

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

**To jest podsumowanie technik MySQL/MariaDB/Percona z [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

### Server-Side Request Forgery (SSRF) za pomoc funkcji SQL

W badaniach nad SQL Out of Band data exfiltration, funkcja `LOAD_FILE()` jest powszechnie stosowana do inicjowania 偶da sieciowych. Funkcja ta jest jednak ograniczona przez system operacyjny, na kt贸rym dziaa, oraz konfiguracje uruchamiania bazy danych.

Globalna zmienna `secure_file_priv`, jeli nie jest ustawiona, domylnie wskazuje na `/var/lib/mysql-files/`, ograniczajc dostp do plik贸w tylko do tego katalogu, chyba 偶e zostanie ustawiona na pusty cig (`""`). Ta zmiana wymaga modyfikacji w pliku konfiguracyjnym bazy danych lub parametrach uruchamiania.

Jeli `secure_file_priv` jest wyczona (`""`), a odpowiednie uprawnienia do plik贸w i `file_priv` s przyznane, pliki spoza wyznaczonego katalogu mog by odczytywane. Niemniej jednak, zdolno tych funkcji do wykonywania wywoa sieciowych jest w du偶ej mierze uzale偶niona od systemu operacyjnego. W systemach Windows wywoania sieciowe do cie偶ek UNC s mo偶liwe dziki zrozumieniu konwencji nazewnictwa UNC przez system operacyjny, co mo偶e prowadzi do wycieku hashy NTLMv2.

Metoda SSRF jest ograniczona do portu TCP 445 i nie pozwala na modyfikacj numeru portu, chocia偶 mo偶e by u偶ywana do uzyskiwania dostpu do udzia贸w z penymi uprawnieniami do odczytu i, jak pokazano w wczeniejszych badaniach, do kradzie偶y hashy w celu dalszej eksploatacji.

### Zdalne Wykonanie Kodu (RCE) za pomoc Funkcji U偶ytkownika (UDF)

Bazy danych MySQL oferuj mo偶liwo u偶ycia Funkcji U偶ytkownika (UDF) z zewntrznych plik贸w bibliotecznych. Jeli te biblioteki s dostpne w okrelonych katalogach lub w `$PATH` systemu, mog by wywoywane z poziomu MySQL.

Technika ta pozwala na wykonywanie 偶da sieciowych/HTTP za pomoc UDF, pod warunkiem spenienia kilku warunk贸w, w tym dostpu do zapisu do `@@plugin_dir`, `file_priv` ustawionego na `Y` oraz wyczenia `secure_file_priv`.

Na przykad, biblioteka `lib_mysqludf_sys` lub inne biblioteki UDF umo偶liwiajce 偶dania HTTP mog by zaadowane w celu wykonania SSRF. Biblioteki musz by przeniesione na serwer, co mo偶na osign poprzez kodowanie hex lub base64 zawartoci biblioteki, a nastpnie zapisanie jej w odpowiednim katalogu.

Proces ten r贸偶ni si, jeli `@@plugin_dir` nie jest zapisywalny, szczeg贸lnie dla wersji MySQL powy偶ej `v5.0.67`. W takich przypadkach nale偶y u偶y alternatywnych cie偶ek, kt贸re s zapisywalne.

Automatyzacja tych proces贸w mo偶e by uatwiona przez narzdzia takie jak SQLMap, kt贸re wspieraj wstrzykiwanie UDF, a w przypadku lepych wstrzykni SQL mog by wykorzystywane techniki przekierowywania wyjcia lub smugglingu 偶da DNS.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
