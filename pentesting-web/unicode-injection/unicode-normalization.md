# Normaliza√ß√£o Unicode

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

**Este √© um resumo de:** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/). Confira para mais detalhes (imagens retiradas de l√°).

## Compreendendo Unicode e Normaliza√ß√£o

A normaliza√ß√£o Unicode √© um processo que garante que diferentes representa√ß√µes bin√°rias de caracteres sejam padronizadas para o mesmo valor bin√°rio. Este processo √© crucial ao lidar com strings em programa√ß√£o e processamento de dados. O padr√£o Unicode define dois tipos de equival√™ncia de caracteres:

1. **Equival√™ncia Can√¥nica**: Caracteres s√£o considerados canonicamente equivalentes se t√™m a mesma apar√™ncia e significado quando impressos ou exibidos.
2. **Equival√™ncia de Compatibilidade**: Uma forma mais fraca de equival√™ncia onde caracteres podem representar o mesmo caractere abstrato, mas podem ser exibidos de maneira diferente.

Existem **quatro algoritmos de normaliza√ß√£o Unicode**: NFC, NFD, NFKC e NFKD. Cada algoritmo emprega t√©cnicas de normaliza√ß√£o can√¥nica e de compatibilidade de maneira diferente. Para uma compreens√£o mais aprofundada, voc√™ pode explorar essas t√©cnicas em [Unicode.org](https://unicode.org/).

### Pontos Chave sobre Codifica√ß√£o Unicode

Compreender a codifica√ß√£o Unicode √© fundamental, especialmente ao lidar com problemas de interoperabilidade entre diferentes sistemas ou idiomas. Aqui est√£o os principais pontos:

* **Pontos de C√≥digo e Caracteres**: No Unicode, cada caractere ou s√≠mbolo √© atribu√≠do a um valor num√©rico conhecido como "ponto de c√≥digo".
* **Representa√ß√£o em Bytes**: O ponto de c√≥digo (ou caractere) √© representado por um ou mais bytes na mem√≥ria. Por exemplo, caracteres LATIN-1 (comuns em pa√≠ses de l√≠ngua inglesa) s√£o representados usando um byte. No entanto, idiomas com um conjunto maior de caracteres precisam de mais bytes para representa√ß√£o.
* **Codifica√ß√£o**: Este termo refere-se a como os caracteres s√£o transformados em uma s√©rie de bytes. UTF-8 √© um padr√£o de codifica√ß√£o prevalente onde caracteres ASCII s√£o representados usando um byte, e at√© quatro bytes para outros caracteres.
* **Processamento de Dados**: Sistemas que processam dados devem estar cientes da codifica√ß√£o utilizada para converter corretamente o fluxo de bytes em caracteres.
* **Variantes de UTF**: Al√©m do UTF-8, existem outros padr√µes de codifica√ß√£o como UTF-16 (usando um m√≠nimo de 2 bytes, at√© 4) e UTF-32 (usando 4 bytes para todos os caracteres).

√â crucial compreender esses conceitos para lidar efetivamente e mitigar potenciais problemas decorrentes da complexidade do Unicode e seus v√°rios m√©todos de codifica√ß√£o.

Um exemplo de como o Unicode normaliza dois bytes diferentes representando o mesmo caractere:
```python
unicodedata.normalize("NFKD","chloe\u0301") == unicodedata.normalize("NFKD", "chlo\u00e9")
```
**Uma lista de caracteres equivalentes em Unicode pode ser encontrada aqui:** [https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) e [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### Descoberta

Se voc√™ conseguir encontrar dentro de um webapp um valor que est√° sendo retornado, voc√™ pode tentar enviar **‚ÄòKELVIN SIGN‚Äô (U+0212A)** que **normaliza para "K"** (voc√™ pode envi√°-lo como `%e2%84%aa`). **Se um "K" for retornado**, ent√£o, algum tipo de **normaliza√ß√£o Unicode** est√° sendo realizada.

Outro **exemplo**: `%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` ap√≥s **unicode** √© `Leonishan`.

## **Exemplos Vulner√°veis**

### **Bypass de filtro de SQL Injection**

Imagine uma p√°gina da web que est√° usando o caractere `'` para criar consultas SQL com a entrada do usu√°rio. Esta web, como uma medida de seguran√ßa, **deleta** todas as ocorr√™ncias do caractere **`'`** da entrada do usu√°rio, mas **ap√≥s essa dele√ß√£o** e **antes da cria√ß√£o** da consulta, ela **normaliza** usando **Unicode** a entrada do usu√°rio.

Ent√£o, um usu√°rio malicioso poderia inserir um caractere Unicode diferente equivalente a `' (0x27)` como `%ef%bc%87`, quando a entrada for normalizada, uma aspa simples √© criada e uma **vulnerabilidade de SQL Injection** aparece:

![https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/](<../../.gitbook/assets/image (702).png>)

**Alguns caracteres Unicode interessantes**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### sqlmap template

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS (Cross Site Scripting)

Voc√™ pode usar um dos seguintes caracteres para enganar o webapp e explorar um XSS:

![https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/](<../../.gitbook/assets/image (312) (2).png>)

Observe que, por exemplo, o primeiro caractere Unicode proposto pode ser enviado como: `%e2%89%ae` ou como `%u226e`

![https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/](<../../.gitbook/assets/image (215) (1) (1).png>)

### Fuzzing Regexes

Quando o backend est√° **verificando a entrada do usu√°rio com uma regex**, pode ser poss√≠vel que a **entrada** esteja sendo **normalizada** para a **regex**, mas **n√£o** para onde est√° sendo **usada**. Por exemplo, em um Open Redirect ou SSRF, a regex pode estar **normalizando a URL enviada**, mas depois **acessando-a como est√°**.

A ferramenta [**recollapse**](https://github.com/0xacb/recollapse) \*\*\*\* permite **gerar varia√ß√µes da entrada** para fuzzar o backend. Para mais informa√ß√µes, consulte o **github** e este [**post**](https://0xacb.com/2022/11/21/recollapse/).

## References

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
