# Normalizaci√≥n de Unicode

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}

**Este es un resumen de:** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/). Consulta para m√°s detalles (im√°genes tomadas de all√≠).

## Entendiendo Unicode y Normalizaci√≥n

La normalizaci√≥n de Unicode es un proceso que asegura que diferentes representaciones binarias de caracteres se estandaricen al mismo valor binario. Este proceso es crucial al tratar con cadenas en programaci√≥n y procesamiento de datos. El est√°ndar Unicode define dos tipos de equivalencia de caracteres:

1. **Equivalencia Can√≥nica**: Los caracteres se consideran can√≥nicamente equivalentes si tienen la misma apariencia y significado cuando se imprimen o se muestran.
2. **Equivalencia de Compatibilidad**: Una forma m√°s d√©bil de equivalencia donde los caracteres pueden representar el mismo car√°cter abstracto pero pueden mostrarse de manera diferente.

Hay **cuatro algoritmos de normalizaci√≥n de Unicode**: NFC, NFD, NFKC y NFKD. Cada algoritmo emplea t√©cnicas de normalizaci√≥n can√≥nica y de compatibilidad de manera diferente. Para una comprensi√≥n m√°s profunda, puedes explorar estas t√©cnicas en [Unicode.org](https://unicode.org/).

### Puntos Clave sobre la Codificaci√≥n Unicode

Entender la codificaci√≥n Unicode es fundamental, especialmente al tratar con problemas de interoperabilidad entre diferentes sistemas o lenguajes. Aqu√≠ est√°n los puntos principales:

* **Puntos de C√≥digo y Caracteres**: En Unicode, a cada car√°cter o s√≠mbolo se le asigna un valor num√©rico conocido como "punto de c√≥digo".
* **Representaci√≥n en Bytes**: El punto de c√≥digo (o car√°cter) se representa por uno o m√°s bytes en memoria. Por ejemplo, los caracteres LATIN-1 (comunes en pa√≠ses de habla inglesa) se representan utilizando un byte. Sin embargo, los idiomas con un conjunto m√°s grande de caracteres necesitan m√°s bytes para su representaci√≥n.
* **Codificaci√≥n**: Este t√©rmino se refiere a c√≥mo los caracteres se transforman en una serie de bytes. UTF-8 es un est√°ndar de codificaci√≥n prevalente donde los caracteres ASCII se representan utilizando un byte, y hasta cuatro bytes para otros caracteres.
* **Procesamiento de Datos**: Los sistemas que procesan datos deben ser conscientes de la codificaci√≥n utilizada para convertir correctamente el flujo de bytes en caracteres.
* **Variantes de UTF**: Adem√°s de UTF-8, hay otros est√°ndares de codificaci√≥n como UTF-16 (que utiliza un m√≠nimo de 2 bytes, hasta 4) y UTF-32 (que utiliza 4 bytes para todos los caracteres).

Es crucial comprender estos conceptos para manejar y mitigar eficazmente los problemas potenciales que surgen de la complejidad de Unicode y sus diversos m√©todos de codificaci√≥n.

Un ejemplo de c√≥mo Unicode normaliza dos bytes diferentes que representan el mismo car√°cter:
```python
unicodedata.normalize("NFKD","chloe\u0301") == unicodedata.normalize("NFKD", "chlo\u00e9")
```
**Una lista de caracteres equivalentes en Unicode se puede encontrar aqu√≠:** [https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) y [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### Descubriendo

Si puedes encontrar dentro de una webapp un valor que se est√° devolviendo, podr√≠as intentar enviar **‚ÄòKELVIN SIGN‚Äô (U+0212A)** que **se normaliza a "K"** (puedes enviarlo como `%e2%84%aa`). **Si se devuelve una "K"**, entonces, se est√° realizando alg√∫n tipo de **normalizaci√≥n de Unicode**.

Otro **ejemplo**: `%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` despu√©s de **unicode** es `Leonishan`.

## **Ejemplos Vulnerables**

### **Bypass de filtro de inyecci√≥n SQL**

Imagina una p√°gina web que est√° utilizando el car√°cter `'` para crear consultas SQL con la entrada del usuario. Esta web, como medida de seguridad, **elimina** todas las ocurrencias del car√°cter **`'`** de la entrada del usuario, pero **despu√©s de esa eliminaci√≥n** y **antes de la creaci√≥n** de la consulta, **normaliza** usando **Unicode** la entrada del usuario.

Entonces, un usuario malicioso podr√≠a insertar un car√°cter Unicode diferente equivalente a `' (0x27)` como `%ef%bc%87`, cuando la entrada se normaliza, se crea una comilla simple y aparece una **vulnerabilidad de SQLInjection**:

![https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/](<../../.gitbook/assets/image (702).png>)

**Algunos caracteres Unicode interesantes**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### plantilla de sqlmap

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS (Cross Site Scripting)

Puedes usar uno de los siguientes caracteres para enga√±ar a la webapp y explotar un XSS:

![https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/](<../../.gitbook/assets/image (312) (2).png>)

Ten en cuenta que, por ejemplo, el primer car√°cter Unicode propuesto se puede enviar como: `%e2%89%ae` o como `%u226e`

![https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/](<../../.gitbook/assets/image (215) (1) (1).png>)

### Fuzzing Regexes

Cuando el backend est√° **verificando la entrada del usuario con una regex**, puede ser posible que la **entrada** est√© siendo **normalizada** para la **regex** pero **no** para donde se est√° **usando**. Por ejemplo, en un Open Redirect o SSRF, la regex podr√≠a estar **normalizando la URL enviada** pero luego **accediendo a ella tal como est√°**.

La herramienta [**recollapse**](https://github.com/0xacb/recollapse) \*\*\*\* permite **generar variaciones de la entrada** para fuzzear el backend. Para m√°s informaci√≥n, consulta el **github** y este [**post**](https://0xacb.com/2022/11/21/recollapse/).

## Referencias

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci√≥n**](https://github.com/sponsors/carlospolop)!
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos de github.

</details>
{% endhint %}
