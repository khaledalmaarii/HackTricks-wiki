# DOM XSS

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## DOM Ranljivosti

DOM ranljivosti se javljaju kada se podaci iz izvora pod kontrolom napada캜a (kao 코to su `location.search`, `document.referrer` ili `document.cookie`) nesigurno prenose u **sinks**. Sinks su funkcije ili objekti (npr., `eval()`, `document.body.innerHTML`) koji mogu izvr코iti ili prikazati 코tetne sadr쬬je ako dobiju zlonamerne podatke.

* **Izvori** su ulazi koje napada캜i mogu manipulisati, uklju캜uju캖i URL-ove, kola캜i캖e i web poruke.
* **Sinks** su potencijalno opasne ta캜ke gde zlonamerni podaci mogu dovesti do negativnih efekata, kao 코to je izvr코avanje skripti.

Rizik nastaje kada podaci teku od izvora do sinka bez pravilne validacije ili sanitacije, omogu캖avaju캖i napade poput XSS-a.

{% hint style="info" %}
**Mo쬰te prona캖i a쬿riraniju listu izvora i sinkova na** [**https://github.com/wisec/domxsswiki/wiki**](https://github.com/wisec/domxsswiki/wiki)
{% endhint %}

**Uobi캜ajeni izvori:**
```javascript
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```
**Uobi캜ajeni Sinks:**

| [**Open Redirect**](dom-xss.md#open-redirect)                                    | [**Javascript Injection**](dom-xss.md#javascript-injection)                         | [**DOM-data manipulation**](dom-xss.md#dom-data-manipulation) | **jQuery**                                                             |
| -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `location`                                                                       | `eval()`                                                                            | `scriptElement.src`                                           | `add()`                                                                |
| `location.host`                                                                  | `Function() constructor`                                                            | `scriptElement.text`                                          | `after()`                                                              |
| `location.hostname`                                                              | `setTimeout()`                                                                      | `scriptElement.textContent`                                   | `append()`                                                             |
| `location.href`                                                                  | `setInterval()`                                                                     | `scriptElement.innerText`                                     | `animate()`                                                            |
| `location.pathname`                                                              | `setImmediate()`                                                                    | `someDOMElement.setAttribute()`                               | `insertAfter()`                                                        |
| `location.search`                                                                | `execCommand()`                                                                     | `someDOMElement.search`                                       | `insertBefore()`                                                       |
| `location.protocol`                                                              | `execScript()`                                                                      | `someDOMElement.text`                                         | `before()`                                                             |
| `location.assign()`                                                              | `msSetImmediate()`                                                                  | `someDOMElement.textContent`                                  | `html()`                                                               |
| `location.replace()`                                                             | `range.createContextualFragment()`                                                  | `someDOMElement.innerText`                                    | `prepend()`                                                            |
| `open()`                                                                         | `crypto.generateCRMFRequest()`                                                      | `someDOMElement.outerText`                                    | `replaceAll()`                                                         |
| `domElem.srcdoc`                                                                 | **\`\`**[**Local file-path manipulation**](dom-xss.md#local-file-path-manipulation) | `someDOMElement.value`                                        | `replaceWith()`                                                        |
| `XMLHttpRequest.open()`                                                          | `FileReader.readAsArrayBuffer()`                                                    | `someDOMElement.name`                                         | `wrap()`                                                               |
| `XMLHttpRequest.send()`                                                          | `FileReader.readAsBinaryString()`                                                   | `someDOMElement.target`                                       | `wrapInner()`                                                          |
| `jQuery.ajax()`                                                                  | `FileReader.readAsDataURL()`                                                        | `someDOMElement.method`                                       | `wrapAll()`                                                            |
| `$.ajax()`                                                                       | `FileReader.readAsText()`                                                           | `someDOMElement.type`                                         | `has()`                                                                |
| **\`\`**[**Ajax request manipulation**](dom-xss.md#ajax-request-manipulation)    | `FileReader.readAsFile()`                                                           | `someDOMElement.backgroundImage`                              | `constructor()`                                                        |
| `XMLHttpRequest.setRequestHeader()`                                              | `FileReader.root.getFile()`                                                         | `someDOMElement.cssText`                                      | `init()`                                                               |
| `XMLHttpRequest.open()`                                                          | `FileReader.root.getFile()`                                                         | `someDOMElement.codebase`                                     | `index()`                                                              |
| `XMLHttpRequest.send()`                                                          | [**Link manipulation**](dom-xss.md#link-manipulation)                               | `someDOMElement.innerHTML`                                    | `jQuery.parseHTML()`                                                   |
| `jQuery.globalEval()`                                                            | `someDOMElement.href`                                                               | `someDOMElement.outerHTML`                                    | `$.parseHTML()`                                                        |
| `$.globalEval()`                                                                 | `someDOMElement.src`                                                                | `someDOMElement.insertAdjacentHTML`                           | [**Client-side JSON injection**](dom-xss.md#client-side-sql-injection) |
| **\`\`**[**HTML5-storage manipulation**](dom-xss.md#html-5-storage-manipulation) | `someDOMElement.action`                                                             | `someDOMElement.onevent`                                      | `JSON.parse()`                                                         |
| `sessionStorage.setItem()`                                                       | [**XPath injection**](dom-xss.md#xpath-injection)                                   | `document.write()`                                            | `jQuery.parseJSON()`                                                   |
| `localStorage.setItem()`                                                         | `document.evaluate()`                                                               | `document.writeln()`                                          | `$.parseJSON()`                                                        |
| **``**[**`Denial of Service`**](dom-xss.md#denial-of-service)**``**              | `someDOMElement.evaluate()`                                                         | `document.title`                                              | **\`\`**[**Cookie manipulation**](dom-xss.md#cookie-manipulation)      |
| `requestFileSystem()`                                                            | **\`\`**[**Document-domain manipulation**](dom-xss.md#document-domain-manipulation) | `document.implementation.createHTMLDocument()`                | `document.cookie`                                                      |
| `RegExp()`                                                                       | `document.domain`                                                                   | `history.pushState()`                                         | [**WebSocket-URL poisoning**](dom-xss.md#websocket-url-poisoning)      |
| [**Client-Side SQl injection**](dom-xss.md#client-side-sql-injection)            | [**Web-message manipulation**](dom-xss.md#web-message-manipulation)                 | `history.replaceState()`                                      | `WebSocket`                                                            |
| `executeSql()`                                                                   | `postMessage()`                                                                     | \`\`                                                          | \`\`                                                                   |

**`innerHTML`** sink ne prihvata `script` elemente u bilo kojem modernom pretra쬴va캜u, niti 캖e `svg onload` doga캠aji biti aktivirani. To zna캜i da 캖ete morati koristiti alternativne elemente kao 코to su `img` ili `iframe`.

Ova vrsta XSS-a je verovatno **najte쬬 za pronala쬰nje**, jer morate pogledati unutar JS koda, videti da li **koristi** neki objekat 캜ija **vrednost kontrolirate**, i u tom slu캜aju, videti da li postoji **bilo koji na캜in da se zloupotrebi** za izvr코avanje proizvoljnog JS-a.

## Alati za pronala쬰nje

* [https://github.com/mozilla/eslint-plugin-no-unsanitized](https://github.com/mozilla/eslint-plugin-no-unsanitized)
* Ekstenzija za pretra쬴va캜 za proveru svih podataka koji dolaze do potencijalnog sinka: [https://github.com/kevin-mizu/domloggerpp](https://github.com/kevin-mizu/domloggerpp)

## Primeri

### Open Redirect

Sa: [https://portswigger.net/web-security/dom-based/open-redirection](https://portswigger.net/web-security/dom-based/open-redirection)

**Ranljivosti otvorenog preusmeravanja u DOM-u** se javljaju kada skripta pi코e podatke, koje napada캜 mo쬰 kontrolisati, u sinku sposobnom da inicira navigaciju izme캠u domena.

Klju캜no je razumeti da je izvr코avanje proizvoljnog koda, kao 코to je **`javascript:alert(1)`**, mogu캖e ako imate kontrolu nad po캜etkom URL-a gde se preusmeravanje de코ava.

Sinks:
```javascript
location
location.host
location.hostname
location.href
location.pathname
location.search
location.protocol
location.assign()
location.replace()
open()
domElem.srcdoc
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.ajax()
$.ajax()
```
### Manipulacija kola캜i캖ima

From: [https://portswigger.net/web-security/dom-based/cookie-manipulation](https://portswigger.net/web-security/dom-based/cookie-manipulation)

DOM-bazirane ranjivosti manipulacije kola캜i캖ima se javljaju kada skripta uklju캜uje podatke, koje mo쬰 kontrolisati napada캜, u vrednost kola캜i캖a. Ova ranjivost mo쬰 dovesti do neo캜ekivanog pona코anja veb stranice ako se kola캜i캖 koristi unutar sajta. Pored toga, mo쬰 se iskoristiti za izvo캠enje napada fiksacije sesije ako je kola캜i캖 uklju캜en u pra캖enje korisni캜kih sesija. Primarni odvod povezan sa ovom ranjivo코캖u je:

Sinks:
```javascript
document.cookie
```
### JavaScript Injection

From: [https://portswigger.net/web-security/dom-based/javascript-injection](https://portswigger.net/web-security/dom-based/javascript-injection)

DOM-bazirane ranjivosti za injekciju JavaScript-a nastaju kada skripta izvr코ava podatke, koje mo쬰 kontrolisati napada캜, kao JavaScript kod.

Sinks:
```javascript
eval()
Function() constructor
setTimeout()
setInterval()
setImmediate()
execCommand()
execScript()
msSetImmediate()
range.createContextualFragment()
crypto.generateCRMFRequest()
```
### Manipulacija dokument-domenom

From: [https://portswigger.net/web-security/dom-based/document-domain-manipulation](https://portswigger.net/web-security/dom-based/document-domain-manipulation)

**Ranljivosti manipulacije dokument-domenom** se javljaju kada skripta postavlja `document.domain` svojstvo koriste캖i podatke koje napada캜 mo쬰 kontrolisati.

Svojstvo `document.domain` igra **klju캜nu ulogu** u **sprovodjenju** **politike iste porekla** od strane pregleda캜a. Kada dve stranice iz razli캜itih porekla postave svoj `document.domain` na **istu vrednost**, mogu da komuniciraju bez ograni캜enja. Iako pregleda캜i name캖u odre캠ene **ograni캜enja** na vrednosti koje se mogu dodeliti `document.domain`, spre캜avaju캖i dodeljivanje potpuno nepovezanih vrednosti stvarnom poreklu stranice, postoje izuzeci. Obi캜no, pregleda캜i dozvoljavaju kori코캖enje **de캜ijih** ili **roditeljskih domena**.

Sinks:
```javascript
document.domain
```
### WebSocket-URL poisoning

From: [https://portswigger.net/web-security/dom-based/websocket-url-poisoning](https://portswigger.net/web-security/dom-based/websocket-url-poisoning)

**WebSocket-URL poisoning** se de코ava kada skripta koristi **kontrolisane podatke kao ciljni URL** za WebSocket vezu.

Sinks:

`WebSocket` konstruktor mo쬰 dovesti do ranjivosti WebSocket-URL poisoning.

### Link manipulation

From: [https://portswigger.net/web-security/dom-based/link-manipulation](https://portswigger.net/web-security/dom-based/link-manipulation)

**DOM-based link-manipulation vulnerabilities** nastaju kada skripta pi코e **podatke koje kontroli코e napada캜 u navigacioni cilj** unutar trenutne stranice, kao 코to su klikabilna veza ili URL za slanje forme.

Sinks:
```javascript
someDOMElement.href
someDOMElement.src
someDOMElement.action
```
### Manipulacija Ajax zahtevima

From: [https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation](https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation)

**Ranljivosti manipulacije Ajax zahtevima** nastaju kada skripta upisuje **podatke koje kontroli코e napada캜 u Ajax zahtev** koji se izdaje koriste캖i `XmlHttpRequest` objekat.

Sinks:
```javascript
XMLHttpRequest.setRequestHeader()
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.globalEval()
$.globalEval()
```
### Manipulacija lokalnim putanjama datoteka

From: [https://portswigger.net/web-security/dom-based/local-file-path-manipulation](https://portswigger.net/web-security/dom-based/local-file-path-manipulation)

**Ranljivosti manipulacije lokalnim putanjama datoteka** nastaju kada skripta prosledi **podatke koje kontroli코e napada캜 API-ju za rukovanje datotekama** kao `filename` parametar. Ovu ranljivost mo쬰 iskoristiti napada캜 da konstrui코e URL koji, ako ga poseti drugi korisnik, mo쬰 dovesti do **otvaranja ili pisanja proizvoljne lokalne datoteke u korisnikovom pretra쬴va캜u**.

Sinks:
```javascript
FileReader.readAsArrayBuffer()
FileReader.readAsBinaryString()
FileReader.readAsDataURL()
FileReader.readAsText()
FileReader.readAsFile()
FileReader.root.getFile()
FileReader.root.getFile()
```
### Klijentska SQL injekcija

From: [https://portswigger.net/web-security/dom-based/client-side-sql-injection](https://portswigger.net/web-security/dom-based/client-side-sql-injection)

**Ranljivosti SQL injekcije na klijentskoj strani** se javljaju kada skripta uklju캜uje **podatke koje kontroli코e napada캜 u SQL upit na klijentskoj strani na nesiguran na캜in**.

Sinks:
```javascript
executeSql()
```
### HTML5-storage manipulation

From: [https://portswigger.net/web-security/dom-based/html5-storage-manipulation](https://portswigger.net/web-security/dom-based/html5-storage-manipulation)

**HTML5-storage manipulation vulnerabilities** nastaju kada skripta **sme코ta podatke koje napada캜 mo쬰 kontrolisati u HTML5 skladi코te web pretra쬴va캜a** (`localStorage` ili `sessionStorage`). Iako ova akcija nije inherentno sigurnosna ranjivost, postaje problemati캜na ako aplikacija kasnije **캜ita sme코tene podatke i obra캠uje ih na nesiguran na캜in**. Ovo bi moglo omogu캖iti napada캜u da iskoristi mehanizam skladi코tenja za izvo캠enje drugih DOM-baziranih napada, kao 코to su cross-site scripting i JavaScript injekcija.

Sinks:
```javascript
sessionStorage.setItem()
localStorage.setItem()
```
### XPath injekcija

From: [https://portswigger.net/web-security/dom-based/client-side-xpath-injection](https://portswigger.net/web-security/dom-based/client-side-xpath-injection)

**DOM-bazirane XPath-injekcione ranjivosti** se javljaju kada skripta uklju캜uje **podatke koje kontroli코e napada캜 u XPath upit**.

Sinks:
```javascript
document.evaluate()
someDOMElement.evaluate()
```
### Klijentska JSON injekcija

From: [https://portswigger.net/web-security/dom-based/client-side-json-injection](https://portswigger.net/web-security/dom-based/client-side-json-injection)

**DOM-bazirane JSON-injekcione ranjivosti** se javljaju kada skripta uklju캜uje **podatke koje kontroli코e napada캜 u string koji se parsira kao JSON struktura podataka i zatim obra캠uje od strane aplikacije**.

Sinks:
```javascript
JSON.parse()
jQuery.parseJSON()
$.parseJSON()
```
### Web-message manipulation

From: [https://portswigger.net/web-security/dom-based/web-message-manipulation](https://portswigger.net/web-security/dom-based/web-message-manipulation)

**Web-message ranjivosti** nastaju kada skripta 코alje **podatke koje kontroli코e napada캜 kao web poruku drugom dokumentu** unutar pregleda캜a. **Primer** ranjive manipulacije web porukama mo쬰 se na캖i na [PortSwigger-ovoj Akademiji za web bezbednost](https://portswigger.net/web-security/dom-based/controlling-the-web-message-source).

Sinks:

Metoda `postMessage()` za slanje web poruka mo쬰 dovesti do ranjivosti ako slu코alac doga캠aja za primanje poruka obra캠uje dolazne podatke na nesiguran na캜in.

### DOM-data manipulation

From: [https://portswigger.net/web-security/dom-based/dom-data-manipulation](https://portswigger.net/web-security/dom-based/dom-data-manipulation)

**Ranjivosti manipulacije DOM podacima** nastaju kada skripta pi코e **podatke koje kontroli코e napada캜 u polje unutar DOM-a** koje se koristi unutar vidljivog UI-a ili klijentske logike. Ovu ranjivost mo쬰 iskoristiti napada캜 da konstruira URL koji, ako ga poseti drugi korisnik, mo쬰 promeniti izgled ili pona코anje klijentskog UI-a.

Sinks:
```javascript
scriptElement.src
scriptElement.text
scriptElement.textContent
scriptElement.innerText
someDOMElement.setAttribute()
someDOMElement.search
someDOMElement.text
someDOMElement.textContent
someDOMElement.innerText
someDOMElement.outerText
someDOMElement.value
someDOMElement.name
someDOMElement.target
someDOMElement.method
someDOMElement.type
someDOMElement.backgroundImage
someDOMElement.cssText
someDOMElement.codebase
document.title
document.implementation.createHTMLDocument()
history.pushState()
history.replaceState()
```
### Denial of Service

From: [https://portswigger.net/web-security/dom-based/denial-of-service](https://portswigger.net/web-security/dom-based/denial-of-service)

**DOM-bazirane ranjivosti za uskra캖ivanje usluge** se javljaju kada skripta prenosi **podatke koje kontroli코e napada캜 na nesiguran na캜in do problemati캜nog platformskog API-ja**. Ovo uklju캜uje API-je koji, kada se pozovu, mogu dovesti do toga da korisni캜ki ra캜unar tro코i **prekomerne koli캜ine CPU-a ili prostora na disku**. Takve ranjivosti mogu imati zna캜ajne nuspojave, kao 코to je ograni캜avanje funkcionalnosti veb sajta od strane pregleda캜a odbijanjem poku코aja 캜uvanja podataka u `localStorage` ili prekidanje zauzetih skripti.

Sinks:
```javascript
requestFileSystem()
RegExp()
```
## Dom Clobbering

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
