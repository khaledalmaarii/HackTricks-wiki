# DOM XSS

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## DOM Vulnerabilities

Vulnerabilities DOM wystpuj, gdy dane z kontrolowanych przez atakujcego **藕r贸de** (takich jak `location.search`, `document.referrer` lub `document.cookie`) s niebezpiecznie przekazywane do **sink贸w**. Sinki to funkcje lub obiekty (np. `eval()`, `document.body.innerHTML`), kt贸re mog wykonywa lub renderowa szkodliw tre, jeli otrzymaj zoliwe dane.

* **殴r贸da** to dane wejciowe, kt贸re mog by manipulowane przez atakujcych, w tym URL-e, ciasteczka i wiadomoci internetowe.
* **Sinki** to potencjalnie niebezpieczne punkty kocowe, w kt贸rych zoliwe dane mog prowadzi do negatywnych skutk贸w, takich jak wykonanie skryptu.

Ryzyko pojawia si, gdy dane przepywaj z 藕r贸da do sinka bez odpowiedniej walidacji lub sanitacji, co umo偶liwia ataki takie jak XSS.

{% hint style="info" %}
**Mo偶esz znale藕 bardziej aktualn list 藕r贸de i sink贸w w** [**https://github.com/wisec/domxsswiki/wiki**](https://github.com/wisec/domxsswiki/wiki)
{% endhint %}

**Common sources:**
```javascript
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```
**Common Sinks:**

| [**Open Redirect**](dom-xss.md#open-redirect)                                    | [**Javascript Injection**](dom-xss.md#javascript-injection)                         | [**DOM-data manipulation**](dom-xss.md#dom-data-manipulation) | **jQuery**                                                             |
| -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `location`                                                                       | `eval()`                                                                            | `scriptElement.src`                                           | `add()`                                                                |
| `location.host`                                                                  | `Function() constructor`                                                            | `scriptElement.text`                                          | `after()`                                                              |
| `location.hostname`                                                              | `setTimeout()`                                                                      | `scriptElement.textContent`                                   | `append()`                                                             |
| `location.href`                                                                  | `setInterval()`                                                                     | `scriptElement.innerText`                                     | `animate()`                                                            |
| `location.pathname`                                                              | `setImmediate()`                                                                    | `someDOMElement.setAttribute()`                               | `insertAfter()`                                                        |
| `location.search`                                                                | `execCommand()`                                                                     | `someDOMElement.search`                                       | `insertBefore()`                                                       |
| `location.protocol`                                                              | `execScript()`                                                                      | `someDOMElement.text`                                         | `before()`                                                             |
| `location.assign()`                                                              | `msSetImmediate()`                                                                  | `someDOMElement.textContent`                                  | `html()`                                                               |
| `location.replace()`                                                             | `range.createContextualFragment()`                                                  | `someDOMElement.innerText`                                    | `prepend()`                                                            |
| `open()`                                                                         | `crypto.generateCRMFRequest()`                                                      | `someDOMElement.outerText`                                    | `replaceAll()`                                                         |
| `domElem.srcdoc`                                                                 | **\`\`**[**Local file-path manipulation**](dom-xss.md#local-file-path-manipulation) | `someDOMElement.value`                                        | `replaceWith()`                                                        |
| `XMLHttpRequest.open()`                                                          | `FileReader.readAsArrayBuffer()`                                                    | `someDOMElement.name`                                         | `wrap()`                                                               |
| `XMLHttpRequest.send()`                                                          | `FileReader.readAsBinaryString()`                                                   | `someDOMElement.target`                                       | `wrapInner()`                                                          |
| `jQuery.ajax()`                                                                  | `FileReader.readAsDataURL()`                                                        | `someDOMElement.method`                                       | `wrapAll()`                                                            |
| `$.ajax()`                                                                       | `FileReader.readAsText()`                                                           | `someDOMElement.type`                                         | `has()`                                                                |
| **\`\`**[**Ajax request manipulation**](dom-xss.md#ajax-request-manipulation)    | `FileReader.readAsFile()`                                                           | `someDOMElement.backgroundImage`                              | `constructor()`                                                        |
| `XMLHttpRequest.setRequestHeader()`                                              | `FileReader.root.getFile()`                                                         | `someDOMElement.cssText`                                      | `init()`                                                               |
| `XMLHttpRequest.open()`                                                          | `FileReader.root.getFile()`                                                         | `someDOMElement.codebase`                                     | `index()`                                                              |
| `XMLHttpRequest.send()`                                                          | [**Link manipulation**](dom-xss.md#link-manipulation)                               | `someDOMElement.innerHTML`                                    | `jQuery.parseHTML()`                                                   |
| `jQuery.globalEval()`                                                            | `someDOMElement.href`                                                               | `someDOMElement.outerHTML`                                    | `$.parseHTML()`                                                        |
| `$.globalEval()`                                                                 | `someDOMElement.src`                                                                | `someDOMElement.insertAdjacentHTML`                           | [**Client-side JSON injection**](dom-xss.md#client-side-sql-injection) |
| **\`\`**[**HTML5-storage manipulation**](dom-xss.md#html-5-storage-manipulation) | `someDOMElement.action`                                                             | `someDOMElement.onevent`                                      | `JSON.parse()`                                                         |
| `sessionStorage.setItem()`                                                       | [**XPath injection**](dom-xss.md#xpath-injection)                                   | `document.write()`                                            | `jQuery.parseJSON()`                                                   |
| `localStorage.setItem()`                                                         | `document.evaluate()`                                                               | `document.writeln()`                                          | `$.parseJSON()`                                                        |
| **``**[**`Denial of Service`**](dom-xss.md#denial-of-service)**``**              | `someDOMElement.evaluate()`                                                         | `document.title`                                              | **\`\`**[**Cookie manipulation**](dom-xss.md#cookie-manipulation)      |
| `requestFileSystem()`                                                            | **\`\`**[**Document-domain manipulation**](dom-xss.md#document-domain-manipulation) | `document.implementation.createHTMLDocument()`                | `document.cookie`                                                      |
| `RegExp()`                                                                       | `document.domain`                                                                   | `history.pushState()`                                         | [**WebSocket-URL poisoning**](dom-xss.md#websocket-url-poisoning)      |
| [**Client-Side SQl injection**](dom-xss.md#client-side-sql-injection)            | [**Web-message manipulation**](dom-xss.md#web-message-manipulation)                 | `history.replaceState()`                                      | `WebSocket`                                                            |
| `executeSql()`                                                                   | `postMessage()`                                                                     | \`\`                                                          | \`\`                                                                   |

The **`innerHTML`** sink doesn't accept `script` elements on any modern browser, nor will `svg onload` events fire. This means you will need to use alternative elements like `img` or `iframe`.

This kind of XSS is probably the **hardest to find**, as you need to look inside the JS code, see if it's **using** any object whose **value you control**, and in that case, see if there is **any way to abuse** it to execute arbitrary JS.

## Tools to find them

* [https://github.com/mozilla/eslint-plugin-no-unsanitized](https://github.com/mozilla/eslint-plugin-no-unsanitized)
* Browser extension to check every data taht reaches a potential sink: [https://github.com/kevin-mizu/domloggerpp](https://github.com/kevin-mizu/domloggerpp)

## Examples

### Open Redirect

From: [https://portswigger.net/web-security/dom-based/open-redirection](https://portswigger.net/web-security/dom-based/open-redirection)

**Luki na otwarty przekierowanie w DOM** wystpuj, gdy skrypt zapisuje dane, kt贸rymi mo偶e sterowa atakujcy, do zlewu zdolnego do inicjowania nawigacji midzy domenami.

Wa偶ne jest, aby zrozumie, 偶e wykonanie dowolnego kodu, takiego jak **`javascript:alert(1)`**, jest mo偶liwe, jeli masz kontrol nad pocztkiem URL, w kt贸rym wystpuje przekierowanie.

Sinks:
```javascript
location
location.host
location.hostname
location.href
location.pathname
location.search
location.protocol
location.assign()
location.replace()
open()
domElem.srcdoc
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.ajax()
$.ajax()
```
### Manipulacja ciasteczkami

From: [https://portswigger.net/web-security/dom-based/cookie-manipulation](https://portswigger.net/web-security/dom-based/cookie-manipulation)

Luki w manipulacji ciasteczkami oparte na DOM wystpuj, gdy skrypt wcza dane, kt贸re mog by kontrolowane przez atakujcego, do wartoci ciasteczka. Ta luka mo偶e prowadzi do nieoczekiwanego zachowania strony internetowej, jeli ciasteczko jest wykorzystywane w obrbie witryny. Dodatkowo, mo偶e by wykorzystana do przeprowadzenia ataku na utrzymanie sesji, jeli ciasteczko jest zaanga偶owane w ledzenie sesji u偶ytkownika. G贸wnym miejscem docelowym zwizanym z t luk jest:

Sinks:
```javascript
document.cookie
```
### Wstrzykiwanie JavaScript

From: [https://portswigger.net/web-security/dom-based/javascript-injection](https://portswigger.net/web-security/dom-based/javascript-injection)

Luki w zabezpieczeniach zwizane z wstrzykiwaniem JavaScript w oparciu o DOM powstaj, gdy skrypt wykonuje dane, kt贸re mog by kontrolowane przez atakujcego, jako kod JavaScript.

Sinks:
```javascript
eval()
Function() constructor
setTimeout()
setInterval()
setImmediate()
execCommand()
execScript()
msSetImmediate()
range.createContextualFragment()
crypto.generateCRMFRequest()
```
### Manipulacja dokumentem-domen

From: [https://portswigger.net/web-security/dom-based/document-domain-manipulation](https://portswigger.net/web-security/dom-based/document-domain-manipulation)

**Wra偶liwoci na manipulacj dokumentem-domen** wystpuj, gdy skrypt ustawia waciwo `document.domain` przy u偶yciu danych, kt贸rymi mo偶e kontrolowa atakujcy.

Waciwo `document.domain` odgrywa **kluczow rol** w **egzekwowaniu** **polityki tego samego pochodzenia** przez przegldarki. Gdy dwie strony z r贸偶nych pochodze ustawiaj swoj `document.domain` na **t sam warto**, mog wchodzi w interakcje bez ogranicze. Chocia偶 przegldarki nakadaj pewne **ograniczenia** na wartoci przypisywane do `document.domain`, zapobiegajc przypisaniu cakowicie niepowizanych wartoci do rzeczywistego pochodzenia strony, istniej wyjtki. Zazwyczaj przegldarki zezwalaj na u偶ycie **domen** **dzieci** lub **rodzic贸w**.

Sinks:
```javascript
document.domain
```
### WebSocket-URL poisoning

From: [https://portswigger.net/web-security/dom-based/websocket-url-poisoning](https://portswigger.net/web-security/dom-based/websocket-url-poisoning)

**WebSocket-URL poisoning** wystpuje, gdy skrypt wykorzystuje **kontrolowane dane jako docelowy URL** dla poczenia WebSocket.

Sinks:

Konstruktor `WebSocket` mo偶e prowadzi do podatnoci na WebSocket-URL poisoning.

### Link manipulation

From: [https://portswigger.net/web-security/dom-based/link-manipulation](https://portswigger.net/web-security/dom-based/link-manipulation)

**Podatnoci na manipulacj linkami w DOM** powstaj, gdy skrypt zapisuje **dane kontrolowane przez atakujcego do celu nawigacji** w bie偶cej stronie, takie jak klikalny link lub URL przesyania formularza.

Sinks:
```javascript
someDOMElement.href
someDOMElement.src
someDOMElement.action
```
### Manipulacja 偶daniami Ajax

From: [https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation](https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation)

**Luki w manipulacji 偶daniami Ajax** powstaj, gdy skrypt zapisuje **dane kontrolowane przez atakujcego w 偶daniu Ajax**, kt贸re jest wydawane za pomoc obiektu `XmlHttpRequest`.

Sinks:
```javascript
XMLHttpRequest.setRequestHeader()
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.globalEval()
$.globalEval()
```
### Manipulacja lokaln cie偶k pliku

From: [https://portswigger.net/web-security/dom-based/local-file-path-manipulation](https://portswigger.net/web-security/dom-based/local-file-path-manipulation)

**Luki w manipulacji lokaln cie偶k pliku** powstaj, gdy skrypt przekazuje **dane kontrolowane przez atakujcego do API obsugi plik贸w** jako parametr `filename`. Ta luka mo偶e by wykorzystana przez atakujcego do skonstruowania URL, kt贸ry, jeli zostanie odwiedzony przez innego u偶ytkownika, mo偶e prowadzi do **otwarcia lub zapisania dowolnego lokalnego pliku w przegldarce u偶ytkownika**.

Sinks:
```javascript
FileReader.readAsArrayBuffer()
FileReader.readAsBinaryString()
FileReader.readAsDataURL()
FileReader.readAsText()
FileReader.readAsFile()
FileReader.root.getFile()
FileReader.root.getFile()
```
### Client-Side SQl injection

From: [https://portswigger.net/web-security/dom-based/client-side-sql-injection](https://portswigger.net/web-security/dom-based/client-side-sql-injection)

**Wra偶liwoci na SQL-injection po stronie klienta** wystpuj, gdy skrypt wcza **dane kontrolowane przez atakujcego do zapytania SQL po stronie klienta w niebezpieczny spos贸b**.

Sinks:
```javascript
executeSql()
```
### Manipulacja pamici HTML5

From: [https://portswigger.net/web-security/dom-based/html5-storage-manipulation](https://portswigger.net/web-security/dom-based/html5-storage-manipulation)

**Wra偶liwoci na manipulacj pamici HTML5** pojawiaj si, gdy skrypt **przechowuje dane kontrolowane przez atakujcego w pamici HTML5 przegldarki internetowej** (`localStorage` lub `sessionStorage`). Chocia偶 ta akcja nie jest z natury luk w zabezpieczeniach, staje si problematyczna, jeli aplikacja nastpnie **odczytuje przechowywane dane i przetwarza je w spos贸b niebezpieczny**. Mo偶e to pozwoli atakujcemu na wykorzystanie mechanizmu pamici do przeprowadzenia innych atak贸w opartych na DOM, takich jak cross-site scripting i wstrzykiwanie JavaScript.

Sinks:
```javascript
sessionStorage.setItem()
localStorage.setItem()
```
### XPath injection

From: [https://portswigger.net/web-security/dom-based/client-side-xpath-injection](https://portswigger.net/web-security/dom-based/client-side-xpath-injection)

**Wra偶liwoci na wstrzykiwanie XPath oparte na DOM** wystpuj, gdy skrypt wcza **dane kontrolowane przez atakujcego do zapytania XPath**.

Sinks:
```javascript
document.evaluate()
someDOMElement.evaluate()
```
### Wstrzykiwanie JSON po stronie klienta

From: [https://portswigger.net/web-security/dom-based/client-side-json-injection](https://portswigger.net/web-security/dom-based/client-side-json-injection)

**Luki w wstrzykiwaniu JSON opartym na DOM** wystpuj, gdy skrypt wcza **dane kontrolowane przez atakujcego do cigu, kt贸ry jest analizowany jako struktura danych JSON, a nastpnie przetwarzany przez aplikacj**.

Sinks:
```javascript
JSON.parse()
jQuery.parseJSON()
$.parseJSON()
```
### Manipulacja wiadomociami w sieci

Z: [https://portswigger.net/web-security/dom-based/web-message-manipulation](https://portswigger.net/web-security/dom-based/web-message-manipulation)

**Luki w wiadomociach sieciowych** powstaj, gdy skrypt wysya **dane kontrolowane przez atakujcego jako wiadomo sieciow do innego dokumentu** w przegldarce. **Przykad** podatnej manipulacji wiadomociami sieciowymi mo偶na znale藕 w [Akademii Bezpieczestwa Sieci PortSwigger](https://portswigger.net/web-security/dom-based/controlling-the-web-message-source).

Sinks:

Metoda `postMessage()` do wysyania wiadomoci sieciowych mo偶e prowadzi do luk, jeli nasuchujcy zdarzenia do odbierania wiadomoci obsuguje przychodzce dane w niebezpieczny spos贸b.

### Manipulacja danymi DOM

Z: [https://portswigger.net/web-security/dom-based/dom-data-manipulation](https://portswigger.net/web-security/dom-based/dom-data-manipulation)

**Luki w manipulacji danymi DOM** powstaj, gdy skrypt zapisuje **dane kontrolowane przez atakujcego do pola w DOM** wykorzystywanego w widocznym interfejsie u偶ytkownika lub logice po stronie klienta. Ta luka mo偶e by wykorzystana przez atakujcego do skonstruowania URL, kt贸ry, jeli zostanie odwiedzony przez innego u偶ytkownika, mo偶e zmieni wygld lub zachowanie interfejsu u偶ytkownika po stronie klienta.

Sinks:
```javascript
scriptElement.src
scriptElement.text
scriptElement.textContent
scriptElement.innerText
someDOMElement.setAttribute()
someDOMElement.search
someDOMElement.text
someDOMElement.textContent
someDOMElement.innerText
someDOMElement.outerText
someDOMElement.value
someDOMElement.name
someDOMElement.target
someDOMElement.method
someDOMElement.type
someDOMElement.backgroundImage
someDOMElement.cssText
someDOMElement.codebase
document.title
document.implementation.createHTMLDocument()
history.pushState()
history.replaceState()
```
### Denial of Service

From: [https://portswigger.net/web-security/dom-based/denial-of-service](https://portswigger.net/web-security/dom-based/denial-of-service)

**Luki typu denial-of-service oparte na DOM** wystpuj, gdy skrypt przekazuje **dane kontrolowane przez atakujcego w spos贸b niebezpieczny do problematycznego API platformy**. Obejmuje to API, kt贸re, gdy s wywoywane, mog spowodowa, 偶e komputer u偶ytkownika zu偶yje **nadmierne iloci CPU lub miejsca na dysku**. Takie luki mog mie znaczce skutki uboczne, takie jak ograniczenie funkcjonalnoci strony przez przegldark poprzez odrzucenie pr贸b przechowywania danych w `localStorage` lub zakoczenie zajtych skrypt贸w.

Sinks:
```javascript
requestFileSystem()
RegExp()
```
## Dom Clobbering

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
