# DOM XSS

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy swoj **firm reklamowan w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Podatnoci DOM

Podatnoci DOM wystpuj, gdy dane z kontrolowanych przez atakujcego **藕r贸de** (takich jak `location.search`, `document.referrer` lub `document.cookie`) s niebezpiecznie przekazywane do **uj**. Ujcia to funkcje lub obiekty (np. `eval()`, `document.body.innerHTML`), kt贸re mog wykonywa lub renderowa szkodliwe treci, jeli otrzymaj zoliwe dane.

- **殴r贸da** to dane wejciowe, kt贸re mog by manipulowane przez atakujcych, w tym adresy URL, pliki cookie i wiadomoci internetowe.
- **Ujcia** to potencjalnie niebezpieczne punkty kocowe, w kt贸rych zoliwe dane mog prowadzi do niekorzystnych skutk贸w, takich jak wykonanie skryptu.

Ryzyko pojawia si, gdy dane przepywaj z 藕r贸da do ujcia bez odpowiedniej walidacji lub oczyszczania, umo偶liwiajc ataki typu XSS.

{% hint style="info" %}
**Mo偶esz znale藕 bardziej aktualn list 藕r贸de i uj na stronie** [**https://github.com/wisec/domxsswiki/wiki**](https://github.com/wisec/domxsswiki/wiki)
{% endhint %}

**Wsp贸lne 藕r贸da:**
```javascript
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```
**Wsp贸lne 藕r贸da:**

| [**Przekierowanie otwarte**](dom-xss.md#open-redirect)                                    | [**Wstrzykiwanie JavaScript**](dom-xss.md#javascript-injection)                         | [**Manipulacja danymi DOM**](dom-xss.md#dom-data-manipulation) | **jQuery**                                                             |
| -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `location`                                                                       | `eval()`                                                                            | `scriptElement.src`                                           | `add()`                                                                |
| `location.host`                                                                  | `Function() constructor`                                                            | `scriptElement.text`                                          | `after()`                                                              |
| `location.hostname`                                                              | `setTimeout()`                                                                      | `scriptElement.textContent`                                   | `append()`                                                             |
| `location.href`                                                                  | `setInterval()`                                                                     | `scriptElement.innerText`                                     | `animate()`                                                            |
| `location.pathname`                                                              | `setImmediate()`                                                                    | `someDOMElement.setAttribute()`                               | `insertAfter()`                                                        |
| `location.search`                                                                | `execCommand()`                                                                     | `someDOMElement.search`                                       | `insertBefore()`                                                       |
| `location.protocol`                                                              | `execScript()`                                                                      | `someDOMElement.text`                                         | `before()`                                                             |
| `location.assign()`                                                              | `msSetImmediate()`                                                                  | `someDOMElement.textContent`                                  | `html()`                                                               |
| `location.replace()`                                                             | `range.createContextualFragment()`                                                  | `someDOMElement.innerText`                                    | `prepend()`                                                            |
| `open()`                                                                         | `crypto.generateCRMFRequest()`                                                      | `someDOMElement.outerText`                                    | `replaceAll()`                                                         |
| `domElem.srcdoc`                                                                 | **\`\`**[**Manipulacja lokaln cie偶k pliku**](dom-xss.md#local-file-path-manipulation) | `someDOMElement.value`                                        | `replaceWith()`                                                        |
| `XMLHttpRequest.open()`                                                          | `FileReader.readAsArrayBuffer()`                                                    | `someDOMElement.name`                                         | `wrap()`                                                               |
| `XMLHttpRequest.send()`                                                          | `FileReader.readAsBinaryString()`                                                   | `someDOMElement.target`                                       | `wrapInner()`                                                          |
| `jQuery.ajax()`                                                                  | `FileReader.readAsDataURL()`                                                        | `someDOMElement.method`                                       | `wrapAll()`                                                            |
| `$.ajax()`                                                                       | `FileReader.readAsText()`                                                           | `someDOMElement.type`                                         | `has()`                                                                |
| **\`\`**[**Manipulacja 偶daniem Ajax**](dom-xss.md#ajax-request-manipulation)    | `FileReader.readAsFile()`                                                           | `someDOMElement.backgroundImage`                              | `constructor()`                                                        |
| `XMLHttpRequest.setRequestHeader()`                                              | `FileReader.root.getFile()`                                                         | `someDOMElement.cssText`                                      | `init()`                                                               |
| `XMLHttpRequest.open()`                                                          | `FileReader.root.getFile()`                                                         | `someDOMElement.codebase`                                     | `index()`                                                              |
| `XMLHttpRequest.send()`                                                          | [**Manipulacja linkiem**](dom-xss.md#link-manipulation)                               | `someDOMElement.innerHTML`                                    | `jQuery.parseHTML()`                                                   |
| `jQuery.globalEval()`                                                            | `someDOMElement.href`                                                               | `someDOMElement.outerHTML`                                    | `$.parseHTML()`                                                        |
| `$.globalEval()`                                                                 | `someDOMElement.src`                                                                | `someDOMElement.insertAdjacentHTML`                           | [**Wstrzykiwanie JSON po stronie klienta**](dom-xss.md#client-side-sql-injection) |
| **\`\`**[**Manipulacja magazynem HTML5**](dom-xss.md#html-5-storage-manipulation) | `someDOMElement.action`                                                             | `someDOMElement.onevent`                                      | `JSON.parse()`                                                         |
| `sessionStorage.setItem()`                                                       | [**Wstrzykiwanie XPath**](dom-xss.md#xpath-injection)                                   | `document.write()`                                            | `jQuery.parseJSON()`                                                   |
| `localStorage.setItem()`                                                         | `document.evaluate()`                                                               | `document.writeln()`                                          | `$.parseJSON()`                                                        |
| **``**[**`Odmowa usugi`**](dom-xss.md#denial-of-service)**``**              | `someDOMElement.evaluate()`                                                         | `document.title`                                              | **\`\`**[**Manipulacja ciasteczkiem**](dom-xss.md#cookie-manipulation)      |
| `requestFileSystem()`                                                            | **\`\`**[**Manipulacja domen dokumentu**](dom-xss.md#document-domain-manipulation) | `document.implementation.createHTMLDocument()`                | `document.cookie`                                                      |
| `RegExp()`                                                                       | `document.domain`                                                                   | `history.pushState()`                                         | [**Zatrucie adresu URL WebSocket**](dom-xss.md#websocket-url-poisoning)      |
| [**Wstrzykiwanie SQL po stronie klienta**](dom-xss.md#client-side-sql-injection)            | [**Manipulacja wiadomoci sieciow**](dom-xss.md#web-message-manipulation)                 | `history.replaceState()`                                      | `WebSocket`                                                            |
| `executeSql()`                                                                   | `postMessage()`                                                                     | \`\`                                                          | \`\`                                                                   |

**Zlew `innerHTML`** nie akceptuje element贸w `script` w 偶adnej nowoczesnej przegldarce, ani nie zostan uruchomione zdarzenia `svg onload`. Oznacza to, 偶e bdziesz musia u偶y alternatywnych element贸w, takich jak `img` lub `iframe`.

Ten rodzaj XSS jest prawdopodobnie **najtrudniejszy do znalezienia**, poniewa偶 musisz przejrze kod JS, sprawdzi, czy **u偶ywa** jakiego obiektu, kt贸rego **warto kontrolujesz**, a w takim przypadku sprawdzi, czy istnieje **jaki spos贸b na wykorzystanie** go do wykonania dowolnego kodu JS.

## Narzdzia do ich znalezienia

* [https://github.com/mozilla/eslint-plugin-no-unsanitized](https://github.com/mozilla/eslint-plugin-no-unsanitized)

## Przykady

### Przekierowanie otwarte

殴r贸do: [https://portswigger.net/web-security/dom-based/open-redirection](https://portswigger.net/web-security/dom-based/open-redirection)

**Podatnoci na otwarte przekierowanie w DOM** wystpuj, gdy skrypt zapisuje dane, kt贸re atakujcy mo偶e kontrolowa, do zlewu zdolnego do inicjowania nawigacji midzy domenami.

Nale偶y zrozumie, 偶e wykonanie dowolnego kodu, takiego jak **`javascript:alert(1)`**, jest mo偶liwe, jeli masz kontrol nad pocztkiem adresu URL, w kt贸rym nastpuje przekierowanie.

Zlewy:
```javascript
location
location.host
location.hostname
location.href
location.pathname
location.search
location.protocol
location.assign()
location.replace()
open()
domElem.srcdoc
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.ajax()
$.ajax()
```
### Manipulacja plikami cookie

Z: [https://portswigger.net/web-security/dom-based/cookie-manipulation](https://portswigger.net/web-security/dom-based/cookie-manipulation)

Podatnoci zwizane z manipulacj plik贸w cookie w oparciu o DOM wystpuj, gdy skrypt wcza dane, kt贸re mog by kontrolowane przez atakujcego, do wartoci pliku cookie. Ta podatno mo偶e prowadzi do nieoczekiwanego zachowania strony internetowej, jeli plik cookie jest wykorzystywany w obrbie witryny. Ponadto, mo偶e by wykorzystana do przeprowadzenia ataku na ustalanie sesji, jeli plik cookie jest wykorzystywany do ledzenia sesji u偶ytkownika. G贸wnym miejscem, zwizanym z t podatnoci, jest:

Miejsca podatne (Sinks):
```javascript
document.cookie
```
### Wstrzykiwanie JavaScriptu

殴r贸do: [https://portswigger.net/web-security/dom-based/javascript-injection](https://portswigger.net/web-security/dom-based/javascript-injection)

Podatnoci na wstrzykiwanie JavaScriptu oparte na DOM (ang. DOM-based JavaScript injection) powstaj, gdy skrypt uruchamia dane, kt贸re mog by kontrolowane przez atakujcego, jako kod JavaScript.

Sinks:
```javascript
eval()
Function() constructor
setTimeout()
setInterval()
setImmediate()
execCommand()
execScript()
msSetImmediate()
range.createContextualFragment()
crypto.generateCRMFRequest()
```
### Manipulacja document-domain

殴r贸do: [https://portswigger.net/web-security/dom-based/document-domain-manipulation](https://portswigger.net/web-security/dom-based/document-domain-manipulation)

Podatnoci zwizane z manipulacj `document.domain` wystpuj, gdy skrypt ustawia waciwo `document.domain` przy u偶yciu danych, kt贸re atakujcy mo偶e kontrolowa.

Waciwo `document.domain` odgrywa **kluczow rol** w **egzekwowaniu** polityki **same-origin** przez przegldarki. Gdy dwie strony pochodzce z r贸偶nych 藕r贸de ustawiaj swoje `document.domain` na **tak sam warto**, mog one wsp贸dziaa bez ogranicze. Chocia偶 przegldarki narzucaj pewne **ograniczenia** na wartoci przypisywane do `document.domain`, uniemo偶liwiajc przypisanie cakowicie niepowizanych wartoci do rzeczywistego pochodzenia strony, istniej wyjtki. Zazwyczaj przegldarki pozwalaj na u偶ycie **dziecicych** lub **nadrzdnych domen**.

Sinks:
```javascript
document.domain
```
### Zatrucie adresu URL WebSocket

殴r贸do: [https://portswigger.net/web-security/dom-based/websocket-url-poisoning](https://portswigger.net/web-security/dom-based/websocket-url-poisoning)

**Zatrucie adresu URL WebSocket** wystpuje, gdy skrypt wykorzystuje **dane kontrolowalne jako docelowy adres URL** dla poczenia WebSocket.

Sinks:

Konstruktor `WebSocket` mo偶e prowadzi do podatnoci na zatrucie adresu URL WebSocket.

### Manipulacja linkiem

殴r贸do: [https://portswigger.net/web-security/dom-based/link-manipulation](https://portswigger.net/web-security/dom-based/link-manipulation)

**Podatnoci na manipulacj linkiem w oparciu o DOM** pojawiaj si, gdy skrypt zapisuje **dane kontrolowane przez atakujcego jako cel nawigacji** w bie偶cej stronie, takie jak klikalny link lub adres URL przesyania formularza.

Sinks:
```javascript
someDOMElement.href
someDOMElement.src
someDOMElement.action
```
### Manipulacja 偶daniem Ajax

殴r贸do: [https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation](https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation)

**Podatnoci na manipulacj 偶daniem Ajax** pojawiaj si, gdy skrypt zapisuje **dane kontrolowane przez atakujcego do 偶dania Ajax**, kt贸re jest wysyane za pomoc obiektu `XmlHttpRequest`.

Sinks:
```javascript
XMLHttpRequest.setRequestHeader()
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.globalEval()
$.globalEval()
```
### Manipulacja lokaln cie偶k pliku

殴r贸do: [https://portswigger.net/web-security/dom-based/local-file-path-manipulation](https://portswigger.net/web-security/dom-based/local-file-path-manipulation)

**Podatnoci na manipulacj lokaln cie偶k pliku** pojawiaj si, gdy skrypt przekazuje **dane kontrolowane przez atakujcego do interfejsu API obsugujcego pliki** jako parametr `filename`. Ta podatno mo偶e zosta wykorzystana przez atakujcego do skonstruowania adresu URL, kt贸ry, jeli odwiedzi go inny u偶ytkownik, mo偶e spowodowa, 偶e **przegldarka u偶ytkownika otworzy lub zapisze dowolny lokalny plik**.

Sinks:
```javascript
FileReader.readAsArrayBuffer()
FileReader.readAsBinaryString()
FileReader.readAsDataURL()
FileReader.readAsText()
FileReader.readAsFile()
FileReader.root.getFile()
FileReader.root.getFile()
```
### Wstrzykiwanie SQL po stronie klienta

Z: [https://portswigger.net/web-security/dom-based/client-side-sql-injection](https://portswigger.net/web-security/dom-based/client-side-sql-injection)

**Wstrzykiwanie SQL po stronie klienta** wystpuje, gdy skrypt w niebezpieczny spos贸b **wcza dane kontrolowane przez atakujcego do zapytania SQL po stronie klienta**.

Sinks:
```javascript
executeSql()
```
### Manipulacja HTML5-storage

Z: [https://portswigger.net/web-security/dom-based/html5-storage-manipulation](https://portswigger.net/web-security/dom-based/html5-storage-manipulation)

**Podatnoci zwizane z manipulacj HTML5-storage** pojawiaj si, gdy skrypt **przechowuje dane kontrolowane przez atakujcego w pamici HTML5 przegldarki** (`localStorage` lub `sessionStorage`). Cho samo przechowywanie danych nie jest bezporednio podatnoci bezpieczestwa, staje si problematyczne, jeli aplikacja nastpnie **odczytuje przechowywane dane i przetwarza je w spos贸b niebezpieczny**. Mo偶e to umo偶liwi atakujcemu wykorzystanie mechanizmu przechowywania do przeprowadzenia innych atak贸w opartych na DOM, takich jak cross-site scripting i wstrzykiwanie JavaScriptu.

Ujcia:
```javascript
sessionStorage.setItem()
localStorage.setItem()
```
### Wstrzyknicie XPath

殴r贸do: [https://portswigger.net/web-security/dom-based/client-side-xpath-injection](https://portswigger.net/web-security/dom-based/client-side-xpath-injection)

**Podatnoci na wstrzyknicie XPath w oparciu o DOM** wystpuj, gdy skrypt zawiera **dane kontrolowane przez atakujcego w zapytaniu XPath**.

Sinks:
```javascript
document.evaluate()
someDOMElement.evaluate()
```
### Wstrzykiwanie JSON po stronie klienta

殴r贸do: [https://portswigger.net/web-security/dom-based/client-side-json-injection](https://portswigger.net/web-security/dom-based/client-side-json-injection)

**Podatnoci na wstrzykiwanie JSON po stronie DOM** wystpuj, gdy skrypt zawiera **dane kontrolowane przez atakujcego w cigu znak贸w, kt贸re s parsowane jako struktura danych JSON, a nastpnie przetwarzane przez aplikacj**.

Sinks:
```javascript
JSON.parse()
jQuery.parseJSON()
$.parseJSON()
```
### Manipulacja wiadomociami internetowymi

Z: [https://portswigger.net/web-security/dom-based/web-message-manipulation](https://portswigger.net/web-security/dom-based/web-message-manipulation)

**Podatnoci zwizane z wiadomociami internetowymi** pojawiaj si, gdy skrypt wysya **dane kontrolowane przez atakujcego jako wiadomo internetow do innego dokumentu** w przegldarce. Przykad podatnoci zwizanej z manipulacj wiadomociami internetowymi mo偶na znale藕 w [Akademii Bezpieczestwa Sieciowego PortSwigger](https://portswigger.net/web-security/dom-based/controlling-the-web-message-source).

Miejsca podatne:

Metoda `postMessage()` do wysyania wiadomoci internetowych mo偶e prowadzi do podatnoci, jeli nasuchiwacz zdarze do odbierania wiadomoci obsuguje przychodzce dane w spos贸b niebezpieczny.

### Manipulacja danymi DOM

Z: [https://portswigger.net/web-security/dom-based/dom-data-manipulation](https://portswigger.net/web-security/dom-based/dom-data-manipulation)

**Podatnoci zwizane z manipulacj danymi DOM** pojawiaj si, gdy skrypt zapisuje **dane kontrolowane przez atakujcego w polu wewntrz DOM**, kt贸re jest wykorzystywane w widocznym interfejsie u偶ytkownika lub logice po stronie klienta. Atakujcy mo偶e wykorzysta t podatno, aby skonstruowa adres URL, kt贸ry, jeli odwiedzony przez innego u偶ytkownika, mo偶e zmieni wygld lub zachowanie interfejsu po stronie klienta.

Miejsca podatne:
```javascript
scriptElement.src
scriptElement.text
scriptElement.textContent
scriptElement.innerText
someDOMElement.setAttribute()
someDOMElement.search
someDOMElement.text
someDOMElement.textContent
someDOMElement.innerText
someDOMElement.outerText
someDOMElement.value
someDOMElement.name
someDOMElement.target
someDOMElement.method
someDOMElement.type
someDOMElement.backgroundImage
someDOMElement.cssText
someDOMElement.codebase
document.title
document.implementation.createHTMLDocument()
history.pushState()
history.replaceState()
```
### Usuga niedostpna

殴r贸do: [https://portswigger.net/web-security/dom-based/denial-of-service](https://portswigger.net/web-security/dom-based/denial-of-service)

**Podatnoci na usug niedostpn oparte na DOM** wystpuj, gdy skrypt przekazuje **dane kontrolowane przez atakujcego w spos贸b niebezpieczny do problematycznego interfejsu API**. Dotyczy to interfejs贸w API, kt贸re, gdy s wywoywane, mog spowodowa, 偶e komputer u偶ytkownika zu偶yje **nadmiern ilo zasob贸w procesora lub miejsca na dysku**. Takie podatnoci mog mie powa偶ne skutki uboczne, takie jak ograniczenie funkcjonalnoci strony internetowej przez przegldark poprzez odrzucanie pr贸b przechowywania danych w `localStorage` lub zatrzymywanie zajtych skrypt贸w.

Odbiorniki:
```javascript
requestFileSystem()
RegExp()
```
## Dom Clobbering

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy, jak Twoja **firma jest reklamowana w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium** [**hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
