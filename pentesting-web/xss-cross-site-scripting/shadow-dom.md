# Shadow DOM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybersÃ©curitÃ©** ? Voulez-vous voir votre **entreprise annoncÃ©e dans HackTricks** ? ou voulez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Shadow DOM fait partie de la suite de fonctionnalitÃ©s [Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components), qui vise Ã  permettre aux dÃ©veloppeurs JS de crÃ©er des Ã©lÃ©ments personnalisÃ©s rÃ©utilisables avec leur fonctionnalitÃ© encapsulÃ©e loin du reste du code du site web.

Essentiellement, vous pouvez utiliser le Shadow DOM pour **isoler le HTML et le CSS de votre composant du reste de la page web**. Par exemple, si vous crÃ©ez des identifiants d'Ã©lÃ©ments dans un Shadow DOM, ils **ne seront pas en conflit avec les identifiants d'Ã©lÃ©ments dans le DOM parent**. Tous les sÃ©lecteurs CSS que vous utilisez dans votre Shadow DOM s'appliqueront uniquement dans le Shadow DOM et non dans le DOM parent, et tous les sÃ©lecteurs que vous utilisez dans le parent ne pÃ©nÃ©treront pas dans le Shadow DOM.
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
Normalement, lorsque vous attachez un **shadow DOM "ouvert" Ã  un Ã©lÃ©ment**, vous pouvez obtenir une rÃ©fÃ©rence au shadow DOM avec **`$element.shadowRoot`**. Cependant, si le shadow DOM est attachÃ© en mode **"fermÃ©"**, vous **ne pouvez pas obtenir de rÃ©fÃ©rence** de cette maniÃ¨re. MÃªme aprÃ¨s avoir lu toute la documentation des dÃ©veloppeurs que j'ai pu trouver, je ne suis toujours pas tout Ã  fait clair sur le but du mode fermÃ©. [Selon Google](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> Il existe une autre variante de shadow DOM appelÃ©e mode "fermÃ©". Lorsque vous crÃ©ez un arbre de shadow fermÃ©, **le JavaScript externe ne pourra pas accÃ©der au DOM interne de votre composant**. C'est similaire au fonctionnement des Ã©lÃ©ments natifs tels que `<video>`. JavaScript ne peut pas accÃ©der au shadow DOM de `<video>` car le navigateur l'implÃ©mente en utilisant un shadow root en mode fermÃ©.

Cependant, ils prÃ©cisent Ã©galement:

> Les shadow roots fermÃ©s ne sont pas trÃ¨s utiles. Certains dÃ©veloppeurs considÃ©reront le mode fermÃ© comme une **fonctionnalitÃ© de sÃ©curitÃ© artificielle**. Mais soyons clairs, ce n'est **pas** une fonctionnalitÃ© de sÃ©curitÃ©.

## AccÃ©der au Shadow DOM

### window.find() et les sÃ©lections de texte <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

La fonction **`window.find("texte_recherchÃ©")` pÃ©nÃ¨tre Ã  l'intÃ©rieur d'un shadow DOM**. Cette fonction a essentiellement la mÃªme fonctionnalitÃ© que ctrl-F sur une page web.

Il est possible d'appeler **`document.execCommand("SelectAll")`** pour Ã©tendre la sÃ©lection autant que possible, puis d'appeler **`window.getSelection()`** pour **retourner le contenu** du texte sÃ©lectionnÃ© Ã  l'intÃ©rieur du shadow DOM.

Dans **firefox**, vous pouvez utiliser `getSelection()` qui renvoie un objet [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection), oÃ¹ `anchorElement` est une **rÃ©fÃ©rence Ã  un Ã©lÃ©ment dans le shadow DOM**. Ainsi, nous pouvons exfiltrer le contenu du shadow DOM de la maniÃ¨re suivante:
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
Mais cela ne fonctionne pas dans Chromium.

### contenteditable ou injection CSS <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

Une faÃ§on dont nous pourrions interagir avec le shadow DOM est si nous avons une **injection HTML ou JS Ã  l'intÃ©rieur de celui-ci**. Il existe des situations intÃ©ressantes oÃ¹ vous pouvez obtenir une injection dans un shadow DOM oÃ¹ vous ne pourriez pas le faire sur une page normale avec crossorigin.

Un exemple est si vous avez des **Ã©lÃ©ments avec l'attribut `contenteditable`**. Il s'agit d'un attribut HTML obsolÃ¨te et peu utilisÃ© qui dÃ©clare que le **contenu de cet Ã©lÃ©ment peut Ãªtre modifiÃ© par l'utilisateur**. Nous pouvons utiliser des sÃ©lections ainsi que l'API **`document.execCommand`** pour interagir avec un Ã©lÃ©ment contenteditable et obtenir une injection HTML !
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
Peut-Ãªtre encore plus intÃ©ressant, **`contenteditable`** peut Ãªtre dÃ©clarÃ© sur n'importe quel Ã©lÃ©ment dans chromium en appliquant une propriÃ©tÃ© CSS obsolÃ¨te : `-webkit-user-modify:read-write`

Cela nous permet de **Ã©lever une injection CSS/style en une injection HTML**, en ajoutant la propriÃ©tÃ© CSS Ã  un Ã©lÃ©ment, puis en utilisant la commande `insertHTML`.

## CTF

Consultez cette solution oÃ¹ cette technique a Ã©tÃ© utilisÃ©e comme dÃ©fi CTF : [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## RÃ©fÃ©rences

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* Vous travaillez dans une **entreprise de cybersÃ©curitÃ©** ? Vous souhaitez voir votre **entreprise annoncÃ©e dans HackTricks** ? ou souhaitez-vous avoir accÃ¨s Ã  la **derniÃ¨re version de PEASS ou tÃ©lÃ©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* DÃ©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
