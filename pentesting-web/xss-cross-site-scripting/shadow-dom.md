# Shadow DOM

<details>

<summary><strong>ä»é›¶åˆ°è‹±é›„å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ **HackTricksä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½HackTricksçš„PDF**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹çš„PEASS & HackTrickså•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„[**NFTsç³»åˆ—**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegramç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

Shadow DOMæ˜¯[Webç»„ä»¶](https://developer.mozilla.org/en-US/docs/Web/Web\_Components)åŠŸèƒ½å¥—ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œæ—¨åœ¨å…è®¸JSå¼€å‘è€…åˆ›å»ºå…·æœ‰å°è£…åŠŸèƒ½çš„å¯å¤ç”¨è‡ªå®šä¹‰å…ƒç´ ï¼Œä¸ç½‘ç«™ä»£ç çš„å…¶ä½™éƒ¨åˆ†éš”ç¦»ã€‚

æœ¬è´¨ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨Shadow DOMæ¥**éš”ç¦»ä½ çš„ç»„ä»¶çš„HTMLå’ŒCSSï¼Œä½¿å…¶ä¸ç½‘é¡µçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨shadow DOMä¸­åˆ›å»ºå…ƒç´ IDï¼Œå®ƒä»¬**ä¸ä¼šä¸çˆ¶DOMä¸­çš„å…ƒç´ IDå†²çª**ã€‚ä½ åœ¨shadow DOMä¸­ä½¿ç”¨çš„ä»»ä½•CSSé€‰æ‹©å™¨åªä¼šåº”ç”¨äºshadow DOMå†…éƒ¨ï¼Œè€Œä¸ä¼šå½±å“åˆ°çˆ¶DOMï¼Œä½ åœ¨çˆ¶DOMä¸­ä½¿ç”¨çš„ä»»ä½•é€‰æ‹©å™¨ä¹Ÿä¸ä¼šæ¸—é€åˆ°shadow DOMå†…éƒ¨ã€‚
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
é€šå¸¸ï¼Œå½“ä½ å°†ä¸€ä¸ª**"open" å½±å­ DOM é™„åŠ åˆ°ä¸€ä¸ªå…ƒç´ ä¸Š**æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡ **`$element.shadowRoot`** è·å–åˆ°å½±å­ DOM çš„å¼•ç”¨ã€‚ç„¶è€Œï¼Œå¦‚æœå½±å­ DOM æ˜¯ä»¥**"closed"** æ¨¡å¼é™„åŠ çš„ï¼Œä½ **æ— æ³•**é€šè¿‡è¿™ç§æ–¹å¼è·å¾—å®ƒçš„å¼•ç”¨ã€‚å³ä½¿æˆ‘é˜…è¯»äº†æˆ‘èƒ½æ‰¾åˆ°çš„æ‰€æœ‰å¼€å‘è€…æ–‡æ¡£ï¼Œæˆ‘å¯¹ closed æ¨¡å¼çš„ç›®çš„ä»ç„¶æœ‰äº›ä¸æ¸…æ¥šã€‚[æ ¹æ® Google çš„è¯´æ³•](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> å½±å­ DOM è¿˜æœ‰å¦ä¸€ç§å«åš "closed" æ¨¡å¼çš„å½¢å¼ã€‚å½“ä½ åˆ›å»ºä¸€ä¸ª**closed** å½±å­æ ‘æ—¶ï¼Œ**å¤–éƒ¨çš„ JavaScript å°†æ— æ³•è®¿é—®ä½ ç»„ä»¶çš„å†…éƒ¨ DOM**ã€‚è¿™å’Œåƒ `<video>` è¿™æ ·çš„åŸç”Ÿå…ƒç´ çš„å·¥ä½œæ–¹å¼ç±»ä¼¼ã€‚JavaScript æ— æ³•è®¿é—® `<video>` çš„å½±å­ DOMï¼Œå› ä¸ºæµè§ˆå™¨æ˜¯ç”¨ closed-mode å½±å­æ ¹æ¥å®ç°çš„ã€‚

ç„¶è€Œï¼Œä»–ä»¬ä¹ŸæŒ‡å‡ºï¼š

> Closed å½±å­æ ¹å¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨ã€‚ä¸€äº›å¼€å‘è€…ä¼šå°† closed æ¨¡å¼è§†ä¸ºä¸€ä¸ª**äººä¸ºçš„å®‰å…¨ç‰¹æ€§**ã€‚ä½†è®©æˆ‘ä»¬æ˜ç¡®ä¸€ç‚¹ï¼Œå®ƒ**ä¸æ˜¯**ä¸€ä¸ªå®‰å…¨ç‰¹æ€§ã€‚

## è®¿é—®å½±å­ DOM

### window.find() å’Œæ–‡æœ¬é€‰æ‹© <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

å‡½æ•° **`window.find("search_text")` èƒ½å¤Ÿç©¿é€å½±å­ DOM**ã€‚è¿™ä¸ªå‡½æ•°å®é™…ä¸Šå…·æœ‰ä¸ç½‘é¡µä¸Šçš„ ctrl-F ç›¸åŒçš„åŠŸèƒ½ã€‚

å¯ä»¥è°ƒç”¨ **`document.execCommand("SelectAll")`** å°½å¯èƒ½åœ°æ‰©å¤§é€‰æ‹©èŒƒå›´ï¼Œç„¶åè°ƒç”¨ **`window.getSelection()`** æ¥**è¿”å›**å½±å­ DOM å†…æ‰€é€‰æ–‡æœ¬çš„**å†…å®¹**ã€‚

åœ¨ **firefox** ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `getSelection()`ï¼Œå®ƒè¿”å›ä¸€ä¸ª [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection) å¯¹è±¡ï¼Œå…¶ä¸­ `anchorElement` æ˜¯**å½±å­ DOM ä¸­å…ƒç´ çš„å¼•ç”¨**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æ³„éœ²å½±å­ DOM çš„å†…å®¹ï¼š
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
ä½†è¿™åœ¨Chromiumä¸­ä¸èµ·ä½œç”¨ã€‚

### å¯ç¼–è¾‘å†…å®¹æˆ–CSSæ³¨å…¥ <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

æˆ‘ä»¬å¯èƒ½ä¸shadow DOMäº¤äº’çš„ä¸€ç§æ–¹å¼æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å…¶ä¸­æœ‰**HTMLæˆ–JSæ³¨å…¥**ã€‚åœ¨æŸäº›æœ‰è¶£çš„æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åœ¨shadow DOMä¸­è·å¾—æ³¨å…¥ï¼Œè€Œåœ¨æ™®é€šçš„crossoriginé¡µé¢ä¸Šåˆ™æ— æ³•åšåˆ°ã€‚

ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œå¦‚æœä½ æœ‰ä»»ä½•å¸¦æœ‰`contenteditable`å±æ€§çš„**å…ƒç´ **ã€‚è¿™æ˜¯ä¸€ä¸ªå·²å¼ƒç”¨ä¸”å¾ˆå°‘ä½¿ç”¨çš„HTMLå±æ€§ï¼Œå®ƒå£°æ˜äº†**è¯¥å…ƒç´ çš„å†…å®¹å¯ç”±ç”¨æˆ·ç¼–è¾‘**ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€‰æ‹©ä¸**`document.execCommand`** APIæ¥ä¸å¯ç¼–è¾‘å†…å®¹çš„å…ƒç´ äº¤äº’å¹¶è·å¾—HTMLæ³¨å…¥ï¼
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
æˆ–è®¸æ›´æœ‰è¶£çš„æ˜¯ï¼Œ**`contenteditable`** å¯ä»¥é€šè¿‡åº”ç”¨ä¸€ä¸ªå·²å¼ƒç”¨çš„ **CSS å±æ€§ï¼š`-webkit-user-modify:read-write`** åœ¨ chromium ä¸­çš„ä»»ä½•å…ƒç´ ä¸Šå£°æ˜ã€‚

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡å‘å…ƒç´ æ·»åŠ  CSS å±æ€§ï¼Œç„¶åä½¿ç”¨ `insertHTML` å‘½ä»¤ï¼Œå°† **CSS/æ ·å¼æ³¨å…¥æå‡ä¸º HTML æ³¨å…¥**ã€‚

## CTF

æŸ¥çœ‹è¿™ç¯‡ writeupï¼Œå…¶ä¸­ä½¿ç”¨äº†è¿™é¡¹æŠ€æœ¯ä½œä¸º CTF æŒ‘æˆ˜ï¼š[https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## å‚è€ƒèµ„æ–™

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æ”»å‡»ç›´åˆ°æˆä¸ºä¸“å®¶ï¼Œé€šè¿‡</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS çº¢é˜Ÿä¸“å®¶)</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœä½ æƒ³åœ¨ **HackTricks ä¸­çœ‹åˆ°ä½ çš„å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ HackTricks çš„ PDF**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* å‘ç° [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬ç‹¬å®¶çš„ [**NFT é›†åˆ**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨ **Twitter** ğŸ¦ ä¸Š **å…³æ³¨** æˆ‘ [**@carlospolopm**](https://twitter.com/carlospolopm)**ã€‚**
* **é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
