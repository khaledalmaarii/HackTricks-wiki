# Shadow DOM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de seguranÃ§a cibernÃ©tica**? VocÃª quer ver sua **empresa anunciada no HackTricks**? ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## InformaÃ§Ãµes BÃ¡sicas

Shadow DOM faz parte do conjunto de recursos [Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components), que tem como objetivo permitir que desenvolvedores JS criem elementos personalizados reutilizÃ¡veis com sua funcionalidade encapsulada longe do restante do cÃ³digo do site.

Essencialmente, vocÃª pode usar o Shadow DOM para **isolar o HTML e o CSS do seu componente do restante da pÃ¡gina da web**. Por exemplo, se vocÃª criar IDs de elementos em um shadow DOM, eles **nÃ£o entrarÃ£o em conflito com IDs de elementos no DOM pai**. Quaisquer seletores CSS que vocÃª utilizar no seu shadow DOM serÃ£o aplicados apenas dentro do shadow DOM e nÃ£o ao DOM pai, e quaisquer seletores que vocÃª utilizar no pai nÃ£o penetrarÃ£o no shadow DOM.
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
Normalmente, quando vocÃª anexa um **shadow DOM "aberto" a um elemento**, vocÃª pode obter uma referÃªncia ao shadow DOM com **`$element.shadowRoot`**. No entanto, se o shadow DOM estiver anexado em modo **"fechado"**, vocÃª **nÃ£o pode obter uma referÃªncia** dessa maneira. Mesmo depois de ler toda a documentaÃ§Ã£o do desenvolvedor que pude encontrar, ainda estou um pouco confuso sobre o propÃ³sito do modo fechado. [De acordo com o Google](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> Existe outra variaÃ§Ã£o do shadow DOM chamada modo "fechado". Quando vocÃª cria uma Ã¡rvore de sombra fechada, o JavaScript externo nÃ£o poderÃ¡ acessar o DOM interno do seu componente. Isso Ã© semelhante ao funcionamento de elementos nativos como `<video>`. O JavaScript nÃ£o pode acessar o shadow DOM de `<video>` porque o navegador o implementa usando uma raiz de sombra em modo fechado.

No entanto, eles tambÃ©m afirmam:

> As raÃ­zes de sombra fechadas nÃ£o sÃ£o muito Ãºteis. Alguns desenvolvedores veem o modo fechado como um recurso de seguranÃ§a **artificial**. Mas vamos ser claros, isso **nÃ£o** Ã© um recurso de seguranÃ§a.

## Acessando o Shadow DOM

### window.find() e seleÃ§Ãµes de texto <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

A funÃ§Ã£o **`window.find("texto_de_pesquisa")` penetra dentro de um shadow DOM**. Essa funÃ§Ã£o tem efetivamente a mesma funcionalidade que ctrl-F em uma pÃ¡gina da web.

Ã‰ possÃ­vel chamar **`document.execCommand("SelectAll")`** para expandir a seleÃ§Ã£o o **mÃ¡ximo possÃ­vel** e, em seguida, chamar **`window.getSelection()`** para **retornar o conteÃºdo** do texto selecionado dentro do shadow DOM.

No **firefox**, vocÃª pode usar `getSelection()`, que retorna um objeto [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection), onde `anchorElement` Ã© uma **referÃªncia a um elemento no shadow DOM**. Portanto, podemos exfiltrar o conteÃºdo do shadow DOM da seguinte maneira:
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
Mas isso nÃ£o funciona no Chromium.

### contenteditable ou injeÃ§Ã£o de CSS <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

Uma maneira pela qual podemos interagir com o shadow DOM Ã© se tivermos uma **injeÃ§Ã£o de HTML ou JS dentro dele**. Existem algumas situaÃ§Ãµes interessantes em que vocÃª pode obter uma injeÃ§Ã£o dentro de um shadow DOM onde nÃ£o seria possÃ­vel em uma pÃ¡gina normal com crossorigin.

Um exemplo disso Ã© se vocÃª tiver quaisquer **elementos com o atributo `contenteditable`**. Este Ã© um atributo HTML obsoleto e pouco utilizado que declara que o **conteÃºdo desse elemento pode ser editado pelo usuÃ¡rio**. Podemos usar seleÃ§Ãµes juntamente com a API **`document.execCommand`** para interagir com um elemento contenteditable e obter uma injeÃ§Ã£o de HTML!
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
Talvez ainda mais interessante, **`contenteditable`** pode ser declarado em qualquer elemento no chromium aplicando uma propriedade CSS obsoleta: `-webkit-user-modify:read-write`

Isso nos permite **elevar uma injeÃ§Ã£o de CSS/style para uma injeÃ§Ã£o de HTML**, adicionando a propriedade CSS a um elemento e, em seguida, utilizando o comando `insertHTML`.

## CTF

Verifique este writeup onde essa tÃ©cnica foi usada como um desafio CTF: [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## ReferÃªncias

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* VocÃª trabalha em uma **empresa de ciberseguranÃ§a**? VocÃª quer ver sua **empresa anunciada no HackTricks**? Ou vocÃª quer ter acesso Ã  **Ãºltima versÃ£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A FamÃ­lia PEASS**](https://opensea.io/collection/the-peass-family), nossa coleÃ§Ã£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**repositÃ³rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositÃ³rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
