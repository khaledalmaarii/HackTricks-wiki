# Shadow DOM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€ä¸ª**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿä½ æƒ³åœ¨HackTricksä¸­çœ‹åˆ°ä½ çš„**å…¬å¸å¹¿å‘Š**å—ï¼Ÿæˆ–è€…ä½ æƒ³è·å¾—**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½HackTricksçš„PDF**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å¾—[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–è€…**å…³æ³¨**æˆ‘åœ¨**Twitter**ä¸Šçš„[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>

## åŸºæœ¬ä¿¡æ¯

Shadow DOMæ˜¯[Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components)åŠŸèƒ½å¥—ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œæ—¨åœ¨å…è®¸JSå¼€å‘äººå‘˜åˆ›å»ºå…·æœ‰å°è£…åŠŸèƒ½çš„å¯é‡ç”¨è‡ªå®šä¹‰å…ƒç´ ï¼Œä½¿å…¶ä¸ç½‘ç«™å…¶ä»–ä»£ç éš”ç¦»å¼€æ¥ã€‚

åŸºæœ¬ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨Shadow DOMæ¥**å°†ç»„ä»¶çš„HTMLå’ŒCSSä¸ç½‘é¡µçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»å¼€æ¥**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨Shadow DOMä¸­åˆ›å»ºå…ƒç´ IDï¼Œå®ƒä»¬**ä¸ä¼šä¸çˆ¶DOMä¸­çš„å…ƒç´ IDå†²çª**ã€‚ä½ åœ¨Shadow DOMä¸­ä½¿ç”¨çš„ä»»ä½•CSSé€‰æ‹©å™¨åªä¼šåº”ç”¨äºShadow DOMï¼Œè€Œä¸ä¼šåº”ç”¨äºçˆ¶DOMï¼Œè€Œä½ åœ¨çˆ¶DOMä¸­ä½¿ç”¨çš„é€‰æ‹©å™¨ä¸ä¼šç©¿é€åˆ°Shadow DOMä¸­ã€‚
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ä½ å°†ä¸€ä¸ª**"open"çš„shadow DOMé™„åŠ åˆ°ä¸€ä¸ªå…ƒç´ ä¸Š**æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨**`$element.shadowRoot`**æ¥è·å–å¯¹shadow DOMçš„å¼•ç”¨ã€‚ç„¶è€Œï¼Œå¦‚æœshadow DOMä»¥**"closed"**æ¨¡å¼é™„åŠ ï¼Œä½ å°±**æ— æ³•é€šè¿‡è¿™ç§æ–¹å¼è·å–å¯¹å®ƒçš„å¼•ç”¨**ã€‚å³ä½¿é˜…è¯»äº†æˆ‘èƒ½æ‰¾åˆ°çš„æ‰€æœ‰å¼€å‘è€…æ–‡æ¡£ï¼Œæˆ‘å¯¹closedæ¨¡å¼çš„ç›®çš„ä»ç„¶æœ‰äº›ä¸æ¸…æ¥šã€‚[æ ¹æ®Googleçš„è¯´æ³•](https://developers.google.com/web/fundamentals/web-components/shadowdom)ï¼š

> è¿˜æœ‰ä¸€ç§å«åš"closed"æ¨¡å¼çš„shadow DOMã€‚å½“ä½ åˆ›å»ºä¸€ä¸ª**closed**çš„shadow treeæ—¶ï¼Œ**å¤–éƒ¨çš„JavaScriptæ— æ³•è®¿é—®ä½ ç»„ä»¶çš„å†…éƒ¨DOM**ã€‚è¿™ç±»ä¼¼äº`<video>`ç­‰åŸç”Ÿå…ƒç´ çš„å·¥ä½œæ–¹å¼ã€‚JavaScriptæ— æ³•è®¿é—®`<video>`çš„shadow DOMï¼Œå› ä¸ºæµè§ˆå™¨ä½¿ç”¨äº†ä¸€ä¸ªclosed-modeçš„shadow rootæ¥å®ç°å®ƒã€‚

ç„¶è€Œï¼Œä»–ä»¬ä¹ŸæŒ‡å‡ºï¼š

> closed shadow rootså¹¶ä¸æ˜¯éå¸¸æœ‰ç”¨ã€‚ä¸€äº›å¼€å‘è€…å¯èƒ½ä¼šå°†closedæ¨¡å¼è§†ä¸ºä¸€ç§**äººä¸ºçš„å®‰å…¨ç‰¹æ€§**ã€‚ä½†æ˜¯ï¼Œè®©æˆ‘ä»¬æ˜ç¡®ä¸€ç‚¹ï¼Œå®ƒ**ä¸æ˜¯**ä¸€ç§å®‰å…¨ç‰¹æ€§ã€‚

## è®¿é—®Shadow DOM

### window.find()å’Œæ–‡æœ¬é€‰æ‹© <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

å‡½æ•°**`window.find("search_text")`å¯ä»¥ç©¿é€shadow DOM**ã€‚è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½ä¸ç½‘é¡µä¸Šçš„ctrl-Fç›¸åŒã€‚

å¯ä»¥è°ƒç”¨**`document.execCommand("SelectAll")`**æ¥æ‰©å±•é€‰æ‹©ï¼Œå°½å¯èƒ½åœ°é€‰æ‹©**æ›´å¤šå†…å®¹**ï¼Œç„¶åè°ƒç”¨**`window.getSelection()`**æ¥**è¿”å›**åœ¨shadow DOMä¸­æ‰€é€‰æ–‡æœ¬çš„å†…å®¹ã€‚

åœ¨**firefox**ä¸­ï¼Œå¯ä»¥ä½¿ç”¨`getSelection()`è¿”å›ä¸€ä¸ª[Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection)å¯¹è±¡ï¼Œå…¶ä¸­`anchorElement`æ˜¯å¯¹shadow DOMä¸­å…ƒç´ çš„**å¼•ç”¨**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼æ³„éœ²shadow DOMçš„å†…å®¹ï¼š
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
ä½†æ˜¯è¿™åœ¨Chromiumä¸­ä¸èµ·ä½œç”¨ã€‚

### contenteditableæˆ–CSSæ³¨å…¥ <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

æˆ‘ä»¬å¯èƒ½èƒ½å¤Ÿä¸å½±å­DOMè¿›è¡Œäº¤äº’çš„ä¸€ç§æ–¹å¼æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å…¶ä¸­æœ‰ä¸€ä¸ª**HTMLæˆ–JSæ³¨å…¥**ã€‚æœ‰ä¸€äº›æœ‰è¶£çš„æƒ…å†µï¼Œæ‚¨å¯ä»¥åœ¨å½±å­DOMä¸­è·å¾—æ³¨å…¥ï¼Œåœ¨æ™®é€šçš„è·¨æºé¡µé¢ä¸Šæ— æ³•è·å¾—ã€‚

ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œå¦‚æœæ‚¨æœ‰ä»»ä½•å¸¦æœ‰`contenteditable`å±æ€§çš„å…ƒç´ ã€‚è¿™æ˜¯ä¸€ä¸ªå·²å¼ƒç”¨ä¸”å¾ˆå°‘ä½¿ç”¨çš„HTMLå±æ€§ï¼Œå®ƒå£°æ˜äº†è¯¥å…ƒç´ çš„å†…å®¹å¯ä¾›ç”¨æˆ·ç¼–è¾‘ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é€‰æ‹©å™¨ä»¥åŠ**`document.execCommand`** APIä¸contenteditableå…ƒç´ è¿›è¡Œäº¤äº’å¹¶è·å¾—HTMLæ³¨å…¥ï¼
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
æˆ–è®¸æ›´æœ‰è¶£çš„æ˜¯ï¼Œå¯ä»¥é€šè¿‡åº”ç”¨å·²å¼ƒç”¨çš„CSSå±æ€§`-webkit-user-modify:read-write`åœ¨Chromiumä¸­å¯¹ä»»ä½•å…ƒç´ å£°æ˜`contenteditable`ã€‚

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†CSS/styleæ³¨å…¥æå‡ä¸ºHTMLæ³¨å…¥ï¼Œé€šè¿‡å°†CSSå±æ€§æ·»åŠ åˆ°å…ƒç´ ä¸­ï¼Œç„¶ååˆ©ç”¨`insertHTML`å‘½ä»¤ã€‚

## CTF

æŸ¥çœ‹æ­¤æŠ€æœ¯åœ¨CTFæŒ‘æˆ˜ä¸­çš„ä½¿ç”¨æƒ…å†µï¼š[https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## å‚è€ƒèµ„æ–™

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>â˜ï¸ HackTricks Cloud â˜ï¸</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ğŸ¦ Twitter ğŸ¦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ğŸ™ï¸ Twitch ğŸ™ï¸</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ğŸ¥ Youtube ğŸ¥</strong></a></summary>

* ä½ åœ¨ä¸€å®¶**ç½‘ç»œå®‰å…¨å…¬å¸**å·¥ä½œå—ï¼Ÿæƒ³è¦åœ¨HackTricksä¸­**å®£ä¼ ä½ çš„å…¬å¸**å—ï¼Ÿæˆ–è€…æƒ³è¦è·å–**PEASSçš„æœ€æ–°ç‰ˆæœ¬æˆ–ä¸‹è½½PDFæ ¼å¼çš„HackTricks**å—ï¼Ÿè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* å‘ç°æˆ‘ä»¬çš„ç‹¬å®¶[**NFTæ”¶è—å“**](https://opensea.io/collection/the-peass-family)â€”â€”[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* è·å–[**å®˜æ–¹PEASSå’ŒHackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* **åŠ å…¥**[**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f)æˆ–[**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass)ï¼Œæˆ–åœ¨**Twitter**ä¸Š**å…³æ³¨**æˆ‘[**ğŸ¦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ã€‚**
* **é€šè¿‡å‘**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **å’Œ**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **æäº¤PRæ¥åˆ†äº«ä½ çš„é»‘å®¢æŠ€å·§ã€‚**

</details>
