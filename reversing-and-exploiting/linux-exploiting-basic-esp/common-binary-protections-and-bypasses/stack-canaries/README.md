# Stack Canaries

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **StackGuard et StackShield**

**StackGuard** ins√®re une valeur sp√©ciale connue sous le nom de **canary** avant le **EIP (Extended Instruction Pointer)**, sp√©cifiquement `0x000aff0d` (repr√©sentant null, newline, EOF, carriage return) pour se prot√©ger contre les d√©bordements de tampon. Cependant, des fonctions comme `recv()`, `memcpy()`, `read()`, et `bcopy()` restent vuln√©rables, et cela ne prot√®ge pas le **EBP (Base Pointer)**.

**StackShield** adopte une approche plus sophistiqu√©e que StackGuard en maintenant une **Global Return Stack**, qui stocke toutes les adresses de retour (**EIPs**). Cette configuration garantit qu'un d√©bordement ne cause pas de dommages, car elle permet une comparaison entre les adresses de retour stock√©es et r√©elles pour d√©tecter les occurrences de d√©bordement. De plus, StackShield peut v√©rifier l'adresse de retour par rapport √† une valeur limite pour d√©tecter si le **EIP** pointe en dehors de l'espace de donn√©es attendu. Cependant, cette protection peut √™tre contourn√©e par des techniques comme Return-to-libc, ROP (Return-Oriented Programming), ou ret2ret, indiquant que StackShield ne prot√®ge √©galement pas les variables locales.

## **Stack Smash Protector (ProPolice) `-fstack-protector`:**

Ce m√©canisme place un **canary** avant le **EBP**, et r√©organise les variables locales pour positionner les tampons √† des adresses m√©moire plus √©lev√©es, les emp√™chant d'√©craser d'autres variables. Il copie √©galement en toute s√©curit√© les arguments pass√©s sur la pile au-dessus des variables locales et utilise ces copies comme arguments. Cependant, il ne prot√®ge pas les tableaux de moins de 8 √©l√©ments ou les tampons dans une structure utilisateur.

Le **canary** est un nombre al√©atoire d√©riv√© de `/dev/urandom` ou d'une valeur par d√©faut de `0xff0a0000`. Il est stock√© dans **TLS (Thread Local Storage)**, permettant aux espaces m√©moire partag√©s entre les threads d'avoir des variables globales ou statiques sp√©cifiques au thread. Ces variables sont initialement copi√©es √† partir du processus parent, et les processus enfants peuvent modifier leurs donn√©es sans affecter le parent ou les fr√®res et s≈ìurs. N√©anmoins, si un **`fork()` est utilis√© sans cr√©er un nouveau canary, tous les processus (parent et enfants) partagent le m√™me canary**, ce qui le rend vuln√©rable. Sur l'architecture **i386**, le canary est stock√© √† `gs:0x14`, et sur **x86\_64**, √† `fs:0x28`.

Cette protection locale identifie les fonctions avec des tampons vuln√©rables aux attaques et injecte du code au d√©but de ces fonctions pour placer le canary, et √† la fin pour v√©rifier son int√©grit√©.

Lorsqu'un serveur web utilise `fork()`, il permet une attaque par force brute pour deviner le canary octet par octet. Cependant, l'utilisation de `execve()` apr√®s `fork()` √©crase l'espace m√©moire, annulant l'attaque. `vfork()` permet au processus enfant de s'ex√©cuter sans duplication jusqu'√† ce qu'il tente d'√©crire, moment auquel un duplicata est cr√©√©, offrant une approche diff√©rente pour la cr√©ation de processus et la gestion de la m√©moire.

### Longueurs

Dans les binaires `x64`, le cookie canary est un **`0x8`** byte qword. Les **sept premiers octets sont al√©atoires** et le dernier octet est un **octet nul.**

Dans les binaires `x86`, le cookie canary est un **`0x4`** byte dword. Les **trois premiers octets sont al√©atoires** et le dernier octet est un **octet nul.**

{% hint style="danger" %}
L'octet de poids faible des deux canaries est un octet nul car il sera le premier dans la pile venant d'adresses inf√©rieures et donc **les fonctions qui lisent des cha√Ænes s'arr√™teront avant de le lire**.
{% endhint %}

## Bypasses

**Fuir le canary** puis l'√©craser (par exemple, d√©bordement de tampon) avec sa propre valeur.

* Si le **canary est fork√© dans des processus enfants**, il pourrait √™tre possible de **brute-forcer** un octet √† la fois :

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* S'il y a une **fuite int√©ressante ou une vuln√©rabilit√© de lecture arbitraire** dans le binaire, il pourrait √™tre possible de le fuir :

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **√âcraser les pointeurs stock√©s sur la pile**

La pile vuln√©rable √† un d√©bordement de pile pourrait **contenir des adresses vers des cha√Ænes ou des fonctions qui peuvent √™tre √©cras√©es** afin d'exploiter la vuln√©rabilit√© sans avoir besoin d'atteindre le canary de la pile. V√©rifiez :

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **Modifier √† la fois le canary ma√Ætre et le canary de thread**

Un d√©bordement de tampon dans une fonction thread√©e prot√©g√©e par un canary peut √™tre utilis√© pour modifier le canary ma√Ætre du thread. En cons√©quence, l'att√©nuation est inutile car la v√©rification est effectu√©e avec deux canaries qui sont les m√™mes (bien que modifi√©s).

* **Modifier l'entr√©e GOT de `__stack_chk_fail`**

Si le binaire a un Partial RELRO, alors vous pouvez utiliser une √©criture arbitraire pour modifier l'entr√©e GOT de `__stack_chk_fail` pour √™tre une fonction factice qui ne bloque pas le programme si le canary est modifi√©.

## R√©f√©rences

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* 64 bits, pas de PIE, nx, modifier le canary de thread et ma√Ætre.
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
* 64 bits, pas de PIE, nx, primitive write-what-where. Modifier l'entr√©e GOT de `__stack_chk_fail`.

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
