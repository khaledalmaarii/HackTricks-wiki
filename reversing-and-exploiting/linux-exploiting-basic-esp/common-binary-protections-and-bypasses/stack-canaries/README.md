# Stack Canaries

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## **StackGuard ve StackShield**

**StackGuard**, aÅŸÄ±rÄ± taÅŸmalarÄ± Ã¶nlemek iÃ§in **EIP (GeniÅŸletilmiÅŸ Komut Ä°ÅŸaretÃ§isi)**'den Ã¶nce Ã¶zel bir deÄŸer olan **canary**'yi ekler, Ã¶zellikle `0x000aff0d` (null, newline, EOF, carriage return'Ã¼ temsil eder). Ancak, `recv()`, `memcpy()`, `read()` ve `bcopy()` gibi iÅŸlevler savunmasÄ±z kalÄ±r ve **EBP (Taban Ä°ÅŸaretÃ§isi)**'yi korumaz.

**StackShield**, StackGuard'dan daha sofistike bir yaklaÅŸÄ±m benimseyerek **Global Return Stack**'i korur, tÃ¼m dÃ¶nÃ¼ÅŸ adreslerini (**EIP'ler**) depolayan bir yapÄ±dÄ±r. Bu kurulum, herhangi bir taÅŸmanÄ±n zarar vermemesini saÄŸlar, Ã§Ã¼nkÃ¼ depolanan ve gerÃ§ek dÃ¶nÃ¼ÅŸ adresleri arasÄ±nda karÅŸÄ±laÅŸtÄ±rma yaparak taÅŸma olaylarÄ±nÄ± tespit etmeyi saÄŸlar. AyrÄ±ca, StackShield, **EIP**'nin beklenen veri alanÄ±nÄ±n dÄ±ÅŸÄ±na iÅŸaret ettiÄŸini tespit etmek iÃ§in dÃ¶nÃ¼ÅŸ adresini bir sÄ±nÄ±r deÄŸeriyle karÅŸÄ±laÅŸtÄ±rabilir. Bununla birlikte, Return-to-libc, ROP (Return-Oriented Programming) veya ret2ret gibi tekniklerle bu koruma atlatÄ±labilir, bu da StackShield'Ä±n yerel deÄŸiÅŸkenleri korumadÄ±ÄŸÄ±nÄ± gÃ¶sterir.

## **Stack Smash Koruyucu (ProPolice) `-fstack-protector`:**

Bu mekanizma, **EBP**'den Ã¶nce bir **canary** yerleÅŸtirir ve yerel deÄŸiÅŸkenleri yeniden dÃ¼zenleyerek tamponlarÄ± daha yÃ¼ksek bellek adreslerine yerleÅŸtirir, bÃ¶ylece diÄŸer deÄŸiÅŸkenleri Ã¼zerine yazmalarÄ±nÄ± Ã¶nler. AyrÄ±ca, yÄ±ÄŸÄ±n Ã¼zerinden geÃ§irilen argÃ¼manlarÄ± gÃ¼venli bir ÅŸekilde kopyalar ve bu kopyalarÄ± argÃ¼manlar olarak kullanÄ±r. Bununla birlikte, 8'den az Ã¶ÄŸeye sahip dizileri veya kullanÄ±cÄ±nÄ±n yapÄ±sÄ±ndaki tamponlarÄ± korumaz.

**Canary**, `/dev/urandom`'dan tÃ¼retilen rastgele bir sayÄ± veya varsayÄ±lan bir deÄŸer olan `0xff0a0000`'den gelir. **TLS (Ä°ÅŸ ParÃ§acÄ±ÄŸÄ± Yerel Depolama)**'da saklanÄ±r ve iÅŸ parÃ§acÄ±klarÄ± arasÄ±nda paylaÅŸÄ±lan bellek alanlarÄ±nÄ±n iÅŸ parÃ§acÄ±ÄŸÄ± Ã¶zgÃ¼ genel veya statik deÄŸiÅŸkenlere sahip olmasÄ±na izin verir. Bu deÄŸiÅŸkenler baÅŸlangÄ±Ã§ta ebeveyn sÃ¼reÃ§ten kopyalanÄ±r ve Ã§ocuk sÃ¼reÃ§ler verilerini deÄŸiÅŸtirebilir ancak ebeveyni veya kardeÅŸleri etkilemez. Bununla birlikte, **`fork()` kullanÄ±larak yeni bir canary oluÅŸturulmadan kullanÄ±ldÄ±ÄŸÄ±nda, tÃ¼m sÃ¼reÃ§ler (ebeveyn ve Ã§ocuklar) aynÄ± canary'yi paylaÅŸÄ±r**, bu da onu savunmasÄ±z hale getirir. **i386** mimarisinde canary, `gs:0x14` adresinde saklanÄ±r ve **x86\_64**'te `fs:0x28` adresinde saklanÄ±r.

Bu yerel koruma, saldÄ±rÄ±lara aÃ§Ä±k tamponlara sahip iÅŸlevleri tanÄ±mlar ve bu iÅŸlevlerin baÅŸÄ±na canary yerleÅŸtirmek iÃ§in kod enjekte eder ve bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ doÄŸrulamak iÃ§in bu iÅŸlevlerin sonuna kod enjekte eder.

Bir web sunucusu `fork()` kullandÄ±ÄŸÄ±nda, canary'yi byte byte tahmin etmek iÃ§in bir brute-force saldÄ±rÄ±sÄ±nÄ± etkinleÅŸtirir. Ancak, `fork()`'ten sonra `execve()` kullanarak hafÄ±za alanÄ±nÄ± Ã¼zerine yazarsanÄ±z, saldÄ±rÄ±yÄ± geÃ§ersiz kÄ±labilirsiniz. `vfork()`, Ã§ocuk sÃ¼recin yazmaya Ã§alÄ±ÅŸana kadar Ã§oÄŸaltÄ±lmadan Ã§alÄ±ÅŸmasÄ±na izin verir, bu noktada bir kopya oluÅŸturulur, farklÄ± bir iÅŸlem oluÅŸturma ve bellek iÅŸleme yaklaÅŸÄ±mÄ± sunar.

### Uzunluklar

`x64` ikili dosyalarÄ±nda, canary Ã§erezi bir **`0x8`** bayt qword'dÃ¼r. **Ä°lk yedi bayt rastgele** ve son bayt bir **null bayttÄ±r**.

`x86` ikili dosyalarÄ±nda, canary Ã§erezi bir **`0x4`** bayt dword'dÃ¼r. **Ä°lk Ã¼Ã§ bayt rastgele** ve son bayt bir **null bayttÄ±r**.

{% hint style="danger" %}
Her iki canary'nin de en anlamlÄ± baytÄ± bir null bayttÄ±r Ã§Ã¼nkÃ¼ daha dÃ¼ÅŸÃ¼k adreslerden gelen yÄ±ÄŸÄ±ndan ilk olacak ve bu nedenle **dizeleri okuyan iÅŸlevler onu okumadan duracak**.
{% endhint %}

## Atlatmalar

**Canary'yi sÄ±zdÄ±rmak** ve ardÄ±ndan (Ã¶rneÄŸin tampon taÅŸmasÄ±) kendi deÄŸeriyle Ã¼zerine yazmak.

* **Ã‡ocuk sÃ¼reÃ§lerde canary Ã§atallanÄ±yorsa**, bir byte'Ä± bir seferde **brute-force** etmek mÃ¼mkÃ¼n olabilir:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Ä°kili dosyada ilginÃ§ bir **sÄ±zÄ±ntÄ± veya keyfi okuma aÃ§Ä±ÄŸÄ±** varsa, sÄ±zdÄ±rmak mÃ¼mkÃ¼n olabilir:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **YÄ±ÄŸÄ±n Ã¼zerindeki saklanan iÅŸaretÃ§ileri Ã¼zerine yazma**

YÄ±ÄŸÄ±n, bir yÄ±ÄŸÄ±n taÅŸmasÄ± iÃ§in savunmasÄ±z olabilir ve bu, yÄ±ÄŸÄ±n canary'ye ulaÅŸmadan zafiyeti sÃ¶mÃ¼rmek iÃ§in Ã¼zerine yazÄ±labilecek dize veya iÅŸlev adresleri iÃ§erebilir. Kontrol edin:

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

## Referanslar

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong> ile!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
