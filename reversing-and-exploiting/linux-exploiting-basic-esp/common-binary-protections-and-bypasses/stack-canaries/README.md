# Ochrona stosu

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## **StackGuard i StackShield**

**StackGuard** wstawia specjalnÄ… wartoÅ›Ä‡ znanÄ… jako **kanarka** przed **EIP (Extended Instruction Pointer)**, konkretnie `0x000aff0d` (reprezentujÄ…cÄ… null, znak nowej linii, EOF, powrÃ³t karetki) w celu ochrony przed przepeÅ‚nieniem bufora. Jednak funkcje takie jak `recv()`, `memcpy()`, `read()` i `bcopy()` pozostajÄ… podatne, a takÅ¼e nie chroni **EBP (Base Pointer)**.

**StackShield** stosuje bardziej zaawansowane podejÅ›cie niÅ¼ StackGuard, utrzymujÄ…c **Globalny Stos Powrotu**, ktÃ³ry przechowuje wszystkie adresy powrotu (**EIP**). Ten ukÅ‚ad zapewnia, Å¼e przepeÅ‚nienie nie powoduje szkÃ³d, poniewaÅ¼ umoÅ¼liwia porÃ³wnanie przechowywanych i rzeczywistych adresÃ³w powrotu w celu wykrycia wystÄ…pienia przepeÅ‚nienia. Dodatkowo, StackShield moÅ¼e sprawdziÄ‡ adres powrotu wzglÄ™dem wartoÅ›ci granicznej, aby wykryÄ‡, czy **EIP** wskazuje poza oczekiwanÄ… przestrzeÅ„ danych. Jednak ta ochrona moÅ¼e byÄ‡ obejÅ›cia za pomocÄ… technik takich jak Return-to-libc, ROP (Return-Oriented Programming) lub ret2ret, co wskazuje, Å¼e StackShield rÃ³wnieÅ¼ nie chroni zmiennych lokalnych.

## **Protector Stack Smash (ProPolice) `-fstack-protector`:**

Ten mechanizm umieszcza **kanarkÄ™** przed **EBP** i przestawia zmienne lokalne tak, aby bufory znajdowaÅ‚y siÄ™ na wyÅ¼szych adresach pamiÄ™ci, uniemoÅ¼liwiajÄ…c nadpisywanie innych zmiennych. Bezpiecznie kopiuje rÃ³wnieÅ¼ argumenty przekazane na stosie powyÅ¼ej zmiennych lokalnych i uÅ¼ywa tych kopii jako argumentÃ³w. Jednak nie chroni tablic o mniej niÅ¼ 8 elementach ani buforÃ³w w strukturze uÅ¼ytkownika.

**Kanarka** to losowa liczba pochodzÄ…ca z `/dev/urandom` lub domyÅ›lna wartoÅ›Ä‡ `0xff0a0000`. Jest przechowywana w **TLS (Thread Local Storage)**, co pozwala na wspÃ³Å‚dzielone przestrzenie pamiÄ™ci miÄ™dzy wÄ…tkami, aby miaÅ‚y wÄ…tkowo specyficzne zmienne globalne lub statyczne. Te zmienne sÄ… poczÄ…tkowo kopiowane z procesu nadrzÄ™dnego, a procesy potomne mogÄ… zmieniaÄ‡ swoje dane bez wpÅ‚ywu na proces nadrzÄ™dny lub rodzeÅ„stwo. Niemniej jednak, jeÅ›li uÅ¼ywane jest **`fork()` bez tworzenia nowej kanarki, wszystkie procesy (rodzic i dzieci) dzielÄ… tÄ™ samÄ… kanarkÄ™**, co czyni jÄ… podatnÄ…. Na architekturze **i386**, kanarka jest przechowywana pod adresem `gs:0x14`, a na **x86\_64** pod adresem `fs:0x28`.

Ta lokalna ochrona identyfikuje funkcje z buforami podatnymi na ataki i wstrzykuje kod na poczÄ…tku tych funkcji, aby umieÅ›ciÄ‡ kanarkÄ™, a na koÅ„cu weryfikuje jej integralnoÅ›Ä‡.

Gdy serwer WWW uÅ¼ywa `fork()`, umoÅ¼liwia atak brute-force w celu odgadniÄ™cia kanarki bajt po bajcie. Jednak uÅ¼ycie `execve()` po `fork()` nadpisuje przestrzeÅ„ pamiÄ™ci, uniewaÅ¼niajÄ…c atak. `vfork()` pozwala procesowi potomnemu wykonywaÄ‡ siÄ™ bez duplikacji, dopÃ³ki nie sprÃ³buje zapisaÄ‡, wtedy tworzony jest duplikat, oferujÄ…c inny sposÃ³b tworzenia procesÃ³w i zarzÄ…dzania pamiÄ™ciÄ….

## OminiÄ™cia

**Ujawnienie kanarki** a nastÄ™pnie nadpisanie jej (np. przepeÅ‚nienie bufora) jej wÅ‚asnÄ… wartoÅ›ciÄ….

* JeÅ›li **kanarka jest klonowana w procesach potomnych**, moÅ¼e byÄ‡ moÅ¼liwe **brute-force'owanie** jej po jednym bajcie:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* JeÅ›li istnieje jakaÅ› interesujÄ…ca luka wycieku w binarnym pliku, moÅ¼e byÄ‡ moÅ¼liwe jej wyciek:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
