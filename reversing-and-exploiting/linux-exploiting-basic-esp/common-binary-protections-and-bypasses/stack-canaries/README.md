# Stack Canaries

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **StackGuard and StackShield**

**StackGuard** ã¯ã€ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‹ã‚‰ä¿è­·ã™ã‚‹ãŸã‚ã«ã€**EIP (Extended Instruction Pointer)** ã®å‰ã«ç‰¹åˆ¥ãªå€¤ã§ã‚ã‚‹ **canary** ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ `0x000aff0d`ï¼ˆãƒŒãƒ«ã€æ”¹è¡Œã€EOFã€ã‚­ãƒ£ãƒªãƒƒã‚¸ãƒªã‚¿ãƒ¼ãƒ³ã‚’è¡¨ã™ï¼‰ã§ã™ã€‚ã—ã‹ã—ã€`recv()`ã€`memcpy()`ã€`read()`ã€ãŠã‚ˆã³ `bcopy()` ã®ã‚ˆã†ãªé–¢æ•°ã¯ä¾ç„¶ã¨ã—ã¦è„†å¼±ã§ã‚ã‚Šã€**EBP (Base Pointer)** ã‚’ä¿è­·ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

**StackShield** ã¯ã€ã™ã¹ã¦ã®æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ (**EIPs**) ã‚’ä¿å­˜ã™ã‚‹ **Global Return Stack** ã‚’ç¶­æŒã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€StackGuard ã‚ˆã‚Šã‚‚æ´—ç·´ã•ã‚ŒãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚Šã¾ã™ã€‚ã“ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã‚ˆã‚Šã€ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å®³ã‚’åŠã¼ã•ãªã„ã“ã¨ãŒä¿è¨¼ã•ã‚Œã€ä¿å­˜ã•ã‚ŒãŸæˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã¨å®Ÿéš›ã®æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¯”è¼ƒã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã®ç™ºç”Ÿã‚’æ¤œå‡ºã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€StackShield ã¯ã€**EIP** ãŒæœŸå¾…ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ç©ºé–“ã®å¤–ã‚’æŒ‡ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã«ã€æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¢ƒç•Œå€¤ã¨ç…§åˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã“ã®ä¿è­·ã¯ã€Return-to-libcã€ROP (Return-Oriented Programming)ã€ã¾ãŸã¯ ret2ret ã®ã‚ˆã†ãªæŠ€è¡“ã«ã‚ˆã£ã¦å›é¿å¯èƒ½ã§ã‚ã‚Šã€StackShield ã‚‚ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’ä¿è­·ã—ã¦ã„ãªã„ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

## **Stack Smash Protector (ProPolice) `-fstack-protector`:**

ã“ã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¯ã€**EBP** ã®å‰ã« **canary** ã‚’é…ç½®ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚’å†é…ç½®ã—ã¦ãƒãƒƒãƒ•ã‚¡ã‚’ã‚ˆã‚Šé«˜ã„ãƒ¡ãƒ¢ãƒªã‚¢ãƒ‰ãƒ¬ã‚¹ã«é…ç½®ã—ã€ä»–ã®å¤‰æ•°ã‚’ä¸Šæ›¸ãã§ããªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ã¾ãŸã€ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã®ä¸Šã«ã‚¹ã‚¿ãƒƒã‚¯ã§æ¸¡ã•ã‚ŒãŸå¼•æ•°ã‚’å®‰å…¨ã«ã‚³ãƒ”ãƒ¼ã—ã€ã“ã‚Œã‚‰ã®ã‚³ãƒ”ãƒ¼ã‚’å¼•æ•°ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚ã—ã‹ã—ã€8 è¦ç´ æœªæº€ã®é…åˆ—ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§‹é€ å†…ã®ãƒãƒƒãƒ•ã‚¡ã¯ä¿è­·ã•ã‚Œã¾ã›ã‚“ã€‚

**canary** ã¯ã€`/dev/urandom` ã‹ã‚‰æ´¾ç”Ÿã—ãŸãƒ©ãƒ³ãƒ€ãƒ ãªæ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ `0xff0a0000` ã§ã™ã€‚ã“ã‚Œã¯ **TLS (Thread Local Storage)** ã«ä¿å­˜ã•ã‚Œã€ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§ã‚¹ãƒ¬ãƒƒãƒ‰å›ºæœ‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¾ãŸã¯é™çš„å¤‰æ•°ã‚’æŒã¤å…±æœ‰ãƒ¡ãƒ¢ãƒªç©ºé–“ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å¤‰æ•°ã¯æœ€åˆã«è¦ªãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã•ã‚Œã€å­ãƒ—ãƒ­ã‚»ã‚¹ã¯è¦ªã‚„å…„å¼Ÿã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ãªããƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ã—ã‹ã—ã€**`fork()` ã‚’ä½¿ç”¨ã—ã¦æ–°ã—ã„ canary ã‚’ä½œæˆã—ãªã„å ´åˆã€ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆè¦ªã¨å­ï¼‰ã¯åŒã˜ canary ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã€è„†å¼±ã«ãªã‚Šã¾ã™**ã€‚**i386** ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€canary ã¯ `gs:0x14` ã«ä¿å­˜ã•ã‚Œã€**x86\_64** ã§ã¯ `fs:0x28` ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

ã“ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿è­·ã¯ã€æ”»æ’ƒã«è„†å¼±ãªãƒãƒƒãƒ•ã‚¡ã‚’æŒã¤é–¢æ•°ã‚’ç‰¹å®šã—ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã®å…ˆé ­ã«ã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥ã—ã¦ canary ã‚’é…ç½®ã—ã€æœ«å°¾ã§ãã®æ•´åˆæ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚

ã‚¦ã‚§ãƒ–ã‚µãƒ¼ãƒãƒ¼ãŒ `fork()` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€canary ãƒã‚¤ãƒˆã‚’ãƒã‚¤ãƒˆå˜ä½ã§æ¨æ¸¬ã™ã‚‹ãŸã‚ã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã—ã‹ã—ã€`fork()` ã®å¾Œã« `execve()` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªç©ºé–“ãŒä¸Šæ›¸ãã•ã‚Œã€æ”»æ’ƒãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚`vfork()` ã¯ã€å­ãƒ—ãƒ­ã‚»ã‚¹ãŒæ›¸ãè¾¼ã¿ã‚’è©¦ã¿ã‚‹ã¾ã§è¤‡è£½ãªã—ã§å®Ÿè¡Œã§ãã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚»ã‚¹ä½œæˆã¨ãƒ¡ãƒ¢ãƒªå‡¦ç†ã«ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æä¾›ã—ã¾ã™ã€‚

### Lengths

`x64` ãƒã‚¤ãƒŠãƒªã§ã¯ã€canary ã‚¯ãƒƒã‚­ãƒ¼ã¯ **`0x8`** ãƒã‚¤ãƒˆã® qword ã§ã™ã€‚æœ€åˆã® 7 ãƒã‚¤ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã§ã€æœ€å¾Œã®ãƒã‚¤ãƒˆã¯ **ãƒŒãƒ«ãƒã‚¤ãƒˆ** ã§ã™ã€‚

`x86` ãƒã‚¤ãƒŠãƒªã§ã¯ã€canary ã‚¯ãƒƒã‚­ãƒ¼ã¯ **`0x4`** ãƒã‚¤ãƒˆã® dword ã§ã™ã€‚æœ€åˆã® 3 ãƒã‚¤ãƒˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã§ã€æœ€å¾Œã®ãƒã‚¤ãƒˆã¯ **ãƒŒãƒ«ãƒã‚¤ãƒˆ** ã§ã™ã€‚

{% hint style="danger" %}
ä¸¡æ–¹ã® canary ã®æœ€ä¸‹ä½ãƒã‚¤ãƒˆã¯ãƒŒãƒ«ãƒã‚¤ãƒˆã§ã™ã€‚ãªãœãªã‚‰ã€ãã‚Œã¯ã‚¹ã‚¿ãƒƒã‚¯ã®æœ€åˆã«æ¥ã‚‹ãŸã‚ã€**æ–‡å­—åˆ—ã‚’èª­ã¿å–ã‚‹é–¢æ•°ã¯ãã‚Œã‚’èª­ã¿å–ã‚‹å‰ã«åœæ­¢ã—ã¾ã™**ã€‚
{% endhint %}

## Bypasses

**canary ã‚’æ¼æ´©ã•ã›**ã€ãã®å¾Œè‡ªåˆ†ã®å€¤ã§ä¸Šæ›¸ãã—ã¾ã™ï¼ˆä¾‹ï¼šãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ï¼‰ã€‚

* **canary ãŒå­ãƒ—ãƒ­ã‚»ã‚¹ã§ãƒ•ã‚©ãƒ¼ã‚¯ã•ã‚Œã‚‹å ´åˆ**ã€1 ãƒã‚¤ãƒˆãšã¤ **ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹** ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* ãƒã‚¤ãƒŠãƒªã«èˆˆå‘³æ·±ã„ **æ¼æ´©ã¾ãŸã¯ä»»æ„ã®èª­ã¿å–ã‚Šè„†å¼±æ€§** ãŒã‚ã‚‹å ´åˆã€æ¼æ´©ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼š

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

* **ã‚¹ã‚¿ãƒƒã‚¯ã«ä¿å­˜ã•ã‚ŒãŸãƒã‚¤ãƒ³ã‚¿ã‚’ä¸Šæ›¸ãã™ã‚‹**

ã‚¹ã‚¿ãƒƒã‚¯ã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«è„†å¼±ã§ã‚ã‚Šã€**ä¸Šæ›¸ãå¯èƒ½ãªæ–‡å­—åˆ—ã‚„é–¢æ•°ã¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™**ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€canary ã«åˆ°é”ã™ã‚‹ã“ã¨ãªãè„†å¼±æ€§ã‚’æ‚ªç”¨ã§ãã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ï¼š

{% content-ref url="../../stack-overflow/pointer-redirecting.md" %}
[pointer-redirecting.md](../../stack-overflow/pointer-redirecting.md)
{% endcontent-ref %}

* **ãƒã‚¹ã‚¿ãƒ¼ã¨ã‚¹ãƒ¬ãƒƒãƒ‰ã® canary ã®ä¸¡æ–¹ã‚’å¤‰æ›´ã™ã‚‹**

canary ã§ä¿è­·ã•ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰é–¢æ•°ã®ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒã‚¹ã‚¿ãƒ¼ canary ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚ãã®çµæœã€ãƒã‚§ãƒƒã‚¯ãŒåŒã˜ï¼ˆãŸã ã—å¤‰æ›´ã•ã‚ŒãŸï¼‰2 ã¤ã® canary ã§ä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ç·©å’Œç­–ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

* **`__stack_chk_fail` ã® GOT ã‚¨ãƒ³ãƒˆãƒªã‚’å¤‰æ›´ã™ã‚‹**

ãƒã‚¤ãƒŠãƒªã« Partial RELRO ãŒã‚ã‚‹å ´åˆã€ä»»æ„ã®æ›¸ãè¾¼ã¿ã‚’ä½¿ç”¨ã—ã¦ `__stack_chk_fail` ã® GOT ã‚¨ãƒ³ãƒˆãƒªã‚’ã€canary ãŒå¤‰æ›´ã•ã‚Œã¦ã‚‚ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ãƒ€ãƒŸãƒ¼é–¢æ•°ã«å¤‰æ›´ã§ãã¾ã™ã€‚

## References

* [https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html](https://guyinatuxedo.github.io/7.1-mitigation\_canary/index.html)
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* 64 ãƒ“ãƒƒãƒˆã€PIE ãªã—ã€nxã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãƒã‚¹ã‚¿ãƒ¼ canary ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
* [https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/](https://7rocky.github.io/en/ctf/other/securinets-ctf/scrambler/)
* 64 ãƒ“ãƒƒãƒˆã€PIE ãªã—ã€nxã€write-what-where ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã€‚`__stack_chk_fail` ã® GOT ã‚¨ãƒ³ãƒˆãƒªã‚’å¤‰æ›´ã—ã¾ã™ã€‚

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
