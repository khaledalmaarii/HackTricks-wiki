# ASLR

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

**åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰**æ˜¯æ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸€ç§å®‰å…¨æŠ€æœ¯ï¼Œç”¨äº**éšæœºåŒ–ç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºè¿›ç¨‹ä½¿ç”¨çš„å†…å­˜åœ°å€**ã€‚é€šè¿‡è¿™æ ·åšï¼Œå®ƒæ˜¾è‘—å¢åŠ äº†æ”»å‡»è€…é¢„æµ‹ç‰¹å®šè¿›ç¨‹å’Œæ•°æ®ä½ç½®ï¼ˆå¦‚å †æ ˆã€å †å’Œåº“ï¼‰çš„éš¾åº¦ï¼Œä»è€Œå‡è½»äº†æŸäº›ç±»å‹çš„åˆ©ç”¨ï¼Œç‰¹åˆ«æ˜¯ç¼“å†²åŒºæº¢å‡ºã€‚

### **æ£€æŸ¥ASLRçŠ¶æ€**

è¦åœ¨Linuxç³»ç»Ÿä¸Š**æ£€æŸ¥**ASLRçŠ¶æ€ï¼Œå¯ä»¥ä»`/proc/sys/kernel/randomize_va_space`æ–‡ä»¶ä¸­è¯»å–å€¼ã€‚å­˜å‚¨åœ¨æ­¤æ–‡ä»¶ä¸­çš„å€¼ç¡®å®šåº”ç”¨çš„ASLRç±»å‹ï¼š

* **0**ï¼šæ— éšæœºåŒ–ã€‚ä¸€åˆ‡éƒ½æ˜¯é™æ€çš„ã€‚
* **1**ï¼šä¿å®ˆéšæœºåŒ–ã€‚å…±äº«åº“ã€å †æ ˆã€mmap()ã€VDSOé¡µé¢è¢«éšæœºåŒ–ã€‚
* **2**ï¼šå®Œå…¨éšæœºåŒ–ã€‚é™¤äº†ä¿å®ˆéšæœºåŒ–éšæœºåŒ–çš„å…ƒç´ å¤–ï¼Œé€šè¿‡`brk()`ç®¡ç†çš„å†…å­˜ä¹Ÿè¢«éšæœºåŒ–ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ASLRçŠ¶æ€ï¼š
```bash
bashCopy codecat /proc/sys/kernel/randomize_va_space
```
### **ç¦ç”¨ ASLR**

è¦**ç¦ç”¨** ASLRï¼Œæ‚¨éœ€è¦å°† `/proc/sys/kernel/randomize_va_space` çš„å€¼è®¾ç½®ä¸º **0**ã€‚é€šå¸¸ä¸å»ºè®®åœ¨æµ‹è¯•æˆ–è°ƒè¯•åœºæ™¯ä¹‹å¤–ç¦ç”¨ ASLRã€‚ä»¥ä¸‹æ˜¯ç¦ç”¨æ–¹æ³•ï¼š
```bash
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
```
æ‚¨è¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç¦ç”¨ASLRè¿›è¡Œæ‰§è¡Œï¼š
```bash
setarch `arch` -R ./bin args
setarch `uname -m` -R ./bin args
```
### **å¯ç”¨ASLR**

è¦**å¯ç”¨**ASLRï¼Œæ‚¨å¯ä»¥å°†å€¼**2**å†™å…¥`/proc/sys/kernel/randomize_va_space`æ–‡ä»¶ã€‚é€šå¸¸éœ€è¦rootæƒé™ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ç”¨å®Œå…¨éšæœºåŒ–ï¼š
```bash
echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
```
### **è·¨é‡å¯ä¿æŒ**

ä½¿ç”¨`echo`å‘½ä»¤è¿›è¡Œçš„æ›´æ”¹æ˜¯ä¸´æ—¶çš„ï¼Œå°†åœ¨é‡æ–°å¯åŠ¨æ—¶é‡ç½®ã€‚è¦ä½¿æ›´æ”¹æŒä¹…åŒ–ï¼Œæ‚¨éœ€è¦ç¼–è¾‘`/etc/sysctl.conf`æ–‡ä»¶å¹¶æ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹è¡Œï¼š
```tsconfig
kernel.randomize_va_space=2 # Enable ASLR
# or
kernel.randomize_va_space=0 # Disable ASLR
```
ç¼–è¾‘`/etc/sysctl.conf`åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åº”ç”¨æ›´æ”¹ï¼š
```bash
sudo sysctl -p
```
è¿™å°†ç¡®ä¿æ‚¨çš„ASLRè®¾ç½®åœ¨é‡æ–°å¯åŠ¨åä¿æŒä¸å˜ã€‚

## **ç»•è¿‡32ä½ASLR**&#x20;

### 32ä½æš´åŠ›ç ´è§£

PaXå°†è¿›ç¨‹åœ°å€ç©ºé—´åˆ†ä¸º**3ç»„**ï¼š

* **ä»£ç å’Œæ•°æ®**ï¼ˆå·²åˆå§‹åŒ–å’Œæœªåˆå§‹åŒ–ï¼‰ï¼š`.text`ã€`.data`å’Œ`.bss` â€”> `delta_exec`å˜é‡ä¸­çš„**16ä½**ç†µã€‚è¯¥å˜é‡åœ¨æ¯ä¸ªè¿›ç¨‹ä¸­éšæœºåˆå§‹åŒ–ï¼Œå¹¶æ·»åŠ åˆ°åˆå§‹åœ°å€ä¸­ã€‚
* ç”±`mmap()`åˆ†é…çš„**å†…å­˜**å’Œ**å…±äº«åº“** â€”> **16ä½**ï¼Œç§°ä¸º`delta_mmap`ã€‚
* **å †æ ˆ** â€”> **24ä½**ï¼Œç§°ä¸º`delta_stack`ã€‚ä½†å®é™…ä¸Šåªä½¿ç”¨**11ä½**ï¼ˆä»ç¬¬10åˆ°ç¬¬20ä¸ªå­—èŠ‚ï¼ŒåŒ…æ‹¬åœ¨å†…ï¼‰ï¼Œå¯¹é½åˆ°**16å­—èŠ‚** â€”> è¿™å¯¼è‡´**524,288ä¸ªå¯èƒ½çš„çœŸå®å †æ ˆåœ°å€**ã€‚

ä¸Šè¿°æ•°æ®é€‚ç”¨äº32ä½ç³»ç»Ÿï¼Œé™ä½çš„æœ€ç»ˆç†µä½¿å¾—å¯ä»¥é€šè¿‡å¤šæ¬¡å°è¯•æ‰§è¡Œæ¥ç»•è¿‡ASLRï¼Œç›´åˆ°åˆ©ç”¨æˆåŠŸå®Œæˆã€‚

#### æš´åŠ›ç ´è§£æ€è·¯ï¼š

* å¦‚æœåˆ©ç”¨æ˜¯æœ¬åœ°çš„ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£libcçš„åŸºåœ°å€ï¼ˆé€‚ç”¨äº32ä½ç³»ç»Ÿï¼‰:
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* å¦‚æœæ”»å‡»è¿œç¨‹æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥å°è¯•**æš´åŠ›ç ´è§£`libc`å‡½æ•°`usleep`çš„åœ°å€**ï¼Œå°†10ä½œä¸ºå‚æ•°ä¼ é€’ã€‚å¦‚æœæŸä¸ªæ—¶åˆ»**æœåŠ¡å™¨éœ€è¦é¢å¤–10ç§’æ‰èƒ½å“åº”**ï¼Œåˆ™æ‰¾åˆ°äº†è¯¥å‡½æ•°çš„åœ°å€ã€‚

{% hint style="success" %}
åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œç†µè¦é«˜å¾—å¤šï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ã€‚
{% endhint %}

### Ret2ret

å°è¯•ç»•è¿‡ASLRï¼Œæ»¥ç”¨å †æ ˆå†…éƒ¨çš„åœ°å€ï¼š

{% content-ref url="../stack-overflow/ret2ret.md" %}
[ret2ret.md](../stack-overflow/ret2ret.md)
{% endcontent-ref %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* å‘ç°[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥**åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§**ã€‚

</details>
