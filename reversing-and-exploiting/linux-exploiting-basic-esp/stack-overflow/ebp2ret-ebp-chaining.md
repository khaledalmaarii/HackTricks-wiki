# EBP2Ret - EBP é“¾æ¥

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

è¿™ç§æŠ€æœ¯åˆ©ç”¨äº†æ“çºµ **åŸºæŒ‡é’ˆï¼ˆEBPï¼‰** çš„èƒ½åŠ›ï¼Œé€šè¿‡ç²¾å¿ƒä½¿ç”¨ EBP å¯„å­˜å™¨å’Œ `leave; ret` æŒ‡ä»¤åºåˆ—æ¥é“¾æ¥æ‰§è¡Œå¤šä¸ªå‡½æ•°ã€‚

ä½œä¸ºæé†’ï¼Œ**`leave`** çš„åŸºæœ¬å«ä¹‰æ˜¯ï¼š
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

è¿™ç§æŠ€æœ¯åœ¨ä½ å¯ä»¥**æ”¹å˜ EBP å¯„å­˜å™¨ä½†æ— æ³•ç›´æ¥æ”¹å˜ EIP å¯„å­˜å™¨**æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚å®ƒåˆ©ç”¨äº†å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶çš„è¡Œä¸ºã€‚

å¦‚æœåœ¨ `fvuln` æ‰§è¡ŒæœŸé—´ï¼Œä½ æˆåŠŸåœ°åœ¨æ ˆä¸­æ³¨å…¥ä¸€ä¸ªæŒ‡å‘å†…å­˜ä¸­ä½ çš„ shellcode åœ°å€çš„**ä¼ªé€  EBP**ï¼ˆå†åŠ ä¸Š 4 ä¸ªå­—èŠ‚ä»¥è€ƒè™‘ `pop` æ“ä½œï¼‰ï¼Œä½ å°±å¯ä»¥é—´æ¥æ§åˆ¶ EIPã€‚å½“ `fvuln` è¿”å›æ—¶ï¼ŒESP è¢«è®¾ç½®ä¸ºè¿™ä¸ªç²¾å¿ƒæ„é€ çš„ä½ç½®ï¼Œéšåçš„ `pop` æ“ä½œå°† ESP å‡å°‘ 4ï¼Œæœ‰æ•ˆåœ°ä½¿å…¶æŒ‡å‘ä½ çš„ shellcodeã€‚å½“æ‰§è¡Œ `ret` æŒ‡ä»¤æ—¶ï¼Œæ§åˆ¶æƒå°±è½¬ç§»åˆ°äº†ä½ çš„ shellcodeã€‚

#### åˆ©ç”¨æ„å»º

é¦–å…ˆï¼Œä½ éœ€è¦**åœ¨å¯æ‰§è¡Œå†…å­˜ä¸­çš„æŸå¤„æ³¨å…¥ä½ çš„ shellcode**å¹¶**è·å–åœ°å€**ï¼Œæˆ–è·å–åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„ [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) çš„åœ°å€ï¼Œæˆ–è®© ESP æŒ‡å‘ä¸€ä¸ªåŒ…å« `system()` åœ°å€åè·Ÿ**4 ä¸ªæ— æ•ˆå­—èŠ‚**å’Œ `"/bin/sh"` åœ°å€çš„ä½ç½®ã€‚

ç„¶åï¼Œåˆ›å»ºå¡«å……å¹¶ç”¨ shellcode/one_gadget åœ°å€å‡å» 4 çš„åœ°å€**æŸå®³ EBP**ã€‚è¿™å¿…é¡»æ˜¯ `-4`ï¼Œå› ä¸ºæœ‰ `pop` æ“ä½œã€‚ç„¶åï¼ŒESP å°†æŒ‡å‘æˆ‘ä»¬æœŸæœ›çš„åœ°å€ï¼Œ`ret` å°†è¢«æ‰§è¡Œã€‚

#### Off-By-One Exploit

è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªç‰¹å®šå˜ä½“è¢«ç§°ä¸ºâ€œOff-By-One Exploitâ€ã€‚å½“ä½ **åªèƒ½ä¿®æ”¹ EBP çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚**æ—¶ï¼Œå°±ä¼šä½¿ç”¨å®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­˜å‚¨ shellcode åœ°å€çš„å†…å­˜ä½ç½®å¿…é¡»ä¸ EBP çš„å‰ä¸‰ä¸ªå­—èŠ‚ç›¸åŒï¼Œä»è€Œå…è®¸åœ¨æ›´å—é™åˆ¶çš„æ¡ä»¶ä¸‹è¿›è¡Œç±»ä¼¼çš„æ“ä½œã€‚

### **EBP Chaining**

å› æ­¤ï¼Œåœ¨æ ˆçš„ `EBP` æ¡ç›®ä¸­æ”¾å…¥ä¸€ä¸ªå¯æ§åœ°å€ï¼Œå¹¶åœ¨ `EIP` ä¸­æ”¾å…¥ä¸€ä¸ªæŒ‡å‘ `leave; ret` çš„åœ°å€ï¼Œå°±å¯ä»¥**å°† `ESP` ç§»åŠ¨åˆ°æ ˆä¸­å—æ§ `EBP` åœ°å€**ã€‚

ç°åœ¨ï¼Œ**`ESP`** è¢«æ§åˆ¶ï¼ŒæŒ‡å‘ä¸€ä¸ªæœŸæœ›çš„åœ°å€ï¼Œä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ `RET`ã€‚ä¸ºäº†åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥åœ¨å—æ§ ESP ä½ç½®æ”¾ç½®ä»¥ä¸‹å†…å®¹ï¼š

- **`&(ä¸‹ä¸€ä¸ªä¼ªé€  EBP)`** -> ç”±äº `leave` æŒ‡ä»¤çš„ `pop ebp`ï¼ŒåŠ è½½æ–°çš„ EBP
- **`system()`** -> è¢« `ret` è°ƒç”¨
- **`&(leave;ret)`** -> åœ¨ system ç»“æŸåè¢«è°ƒç”¨ï¼Œå®ƒå°†ç§»åŠ¨ ESP åˆ°ä¼ªé€  EBP å¹¶é‡æ–°å¼€å§‹
- **`&("/bin/sh")`**-> `system` çš„å‚æ•°

åŸºæœ¬ä¸Šï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥é“¾æ¥å¤šä¸ªä¼ªé€ çš„ EBP æ¥æ§åˆ¶ç¨‹åºçš„æµç¨‹ã€‚

è¯´å®è¯ï¼Œè¿™æœ‰ç‚¹åƒ [ret2lib](ret2lib/)ï¼Œä½†æ›´å¤æ‚ï¼Œæ²¡æœ‰æ˜æ˜¾çš„å¥½å¤„ï¼Œä½†åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹å¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚
