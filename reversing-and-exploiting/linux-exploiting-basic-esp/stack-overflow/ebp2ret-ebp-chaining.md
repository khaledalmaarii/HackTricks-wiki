# EBP2Ret - EBP zincirleme

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**]'na(https://github.com/sponsors/carlospolop) gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking hilelerinizi paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bu teknik, **Base Pointer'Ä± (EBP)** manipÃ¼le etme yeteneÄŸini kullanarak EBP kaydÄ±nÄ±n dikkatli bir ÅŸekilde kullanÄ±mÄ± ve `leave; ret` komut dizisi ile birden fazla iÅŸlevin yÃ¼rÃ¼tÃ¼lmesini zincirleme ÅŸeklinde sÃ¶mÃ¼rÃ¼r.

HatÄ±rlatma olarak, **`leave`** temelde ÅŸunu ifade eder:
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

Bu teknik, **EBP kaydedicisini deÄŸiÅŸtirebilecek ancak EIP kaydedicisini doÄŸrudan deÄŸiÅŸtiremeyecek** durumlarda Ã¶zellikle kullanÄ±ÅŸlÄ±dÄ±r. FonksiyonlarÄ±n Ã§alÄ±ÅŸmasÄ±nÄ± tamamladÄ±klarÄ±nda davranÄ±ÅŸlarÄ±nÄ± kaldÄ±rmaktadÄ±r.

`fvuln`'nin yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda, stack'e **sahte bir EBP** enjekte etmeyi baÅŸarÄ±rsanÄ±z ve bu sahte EBP, shellcode'unuzun adresinin bulunduÄŸu bellek alanÄ±na iÅŸaret eder (pop iÅŸlemi iÃ§in 4 bayt eklemek iÃ§in), EIP'yi dolaylÄ± olarak kontrol edebilirsiniz. `fvuln` geri dÃ¶ndÃ¼ÄŸÃ¼nde, ESP bu hazÄ±rlanmÄ±ÅŸ konuma ayarlanÄ±r ve ardÄ±ÅŸÄ±k `pop` iÅŸlemi ESP'yi 4 azaltarak etkili bir ÅŸekilde shellcode'unuza iÅŸaret eder. `ret` talimatÄ± yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼nde, kontrol shellcode'unuza aktarÄ±lÄ±r.

#### SaldÄ±rÄ± OluÅŸturma

Ä°lk olarak, shellcode'unuzu yÃ¼rÃ¼tÃ¼lebilir bir bellek alanÄ±na **enjekte etmeniz ve adresini almanÄ±z**, veya geÃ§erli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresini almanÄ±z veya ESP'yi `system()` adresinin bulunduÄŸu bir yere ve ardÄ±ndan **4 gereksiz bayt** ve `"/bin/sh"` adresi ile iÅŸaret etmesini saÄŸlamanÄ±z gerekir.

ArdÄ±ndan, bir dolgu oluÅŸturun ve EBP'yi `shellcode/one_gadget adresi - 4` ile **tehlikeye atÄ±n**. Bu `-4` olmalÄ± Ã§Ã¼nkÃ¼ `pop` iÅŸlemi nedeniyle. Sonra, ESP istediÄŸimiz adrese iÅŸaret eder hale gelecek ve `ret` yÃ¼rÃ¼tÃ¼lecektir.

#### Bir Fazla Bir SaldÄ±rÄ±sÄ±

Bu tekniÄŸin belirli bir varyantÄ± olan "Bir Fazla Bir SaldÄ±rÄ±sÄ±" vardÄ±r. Bu, **EBP'nin en az anlamlÄ± baytÄ±nÄ± yalnÄ±zca deÄŸiÅŸtirebildiÄŸinizde kullanÄ±lÄ±r**. Bu durumda, shellcode'un adresini depolayan bellek konumu, EBP ile ilk Ã¼Ã§ baytÄ± paylaÅŸmalÄ±dÄ±r, daha kÄ±sÄ±tlayÄ±cÄ± koÅŸullarla benzer bir manipÃ¼lasyon iÃ§in izin verir.

### **EBP Zincirleme**

Bu nedenle, stack'teki `EBP` giriÅŸine kontrol edilen bir adres ve `EIP`'de `leave; ret` adresi yerleÅŸtirerek, `ESP`'yi stack'teki kontrol edilen `EBP` adresine **taÅŸÄ±mak mÃ¼mkÃ¼ndÃ¼r**.

Åimdi, **`ESP`** istenilen bir adrese iÅŸaret eder hale gelir ve yÃ¼rÃ¼tÃ¼lecek sonraki talimat bir `RET` olur. Bunu kÃ¶tÃ¼ye kullanmak iÃ§in, kontrol edilen ESP yerine ÅŸunu yerleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r:

* **`&(sonraki sahte EBP)`** -> `leave` talimatÄ±ndan `pop ebp` nedeniyle yeni EBP'yi yÃ¼kleyin
* **`system()`** -> `ret` tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
* **`&(leave;ret)`** -> sistem bittiÄŸinde Ã§aÄŸrÄ±lÄ±r, ESP'yi sahte EBP'ye taÅŸÄ±yacak ve yeniden baÅŸlayacak
* **`&("/bin/sh")`**-> `system` iÃ§in parametre

Temelde bu ÅŸekilde programÄ±n akÄ±ÅŸÄ±nÄ± kontrol etmek iÃ§in birkaÃ§ sahte EBP zincirlenmesi mÃ¼mkÃ¼ndÃ¼r.

AslÄ±nda, bu bir [ret2lib](ret2lib/) gibi, ancak aÃ§Ä±k bir fayda olmaksÄ±zÄ±n daha karmaÅŸÄ±k olabilir ve bazÄ± sÄ±nÄ±rlÄ± durumlarda ilginÃ§ olabilir.
