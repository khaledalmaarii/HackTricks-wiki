# Ret2esp / Ret2reg

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

å…¶ä»–æ”¯æŒHackTricksçš„æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **Rest2esp**

**ç”±äºESPï¼ˆå †æ ˆæŒ‡é’ˆï¼‰å§‹ç»ˆæŒ‡å‘å †æ ˆé¡¶éƒ¨**ï¼Œè¿™ç§æŠ€æœ¯æ¶‰åŠå°†EIPï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰æ›¿æ¢ä¸º**`jmp esp`**æˆ–**`call esp`**æŒ‡ä»¤çš„åœ°å€ã€‚é€šè¿‡è¿™æ ·åšï¼Œshellcodeè¢«æ”¾ç½®åœ¨è¢«è¦†ç›–çš„EIPä¹‹åã€‚å½“`ret`æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼ŒESPæŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€ï¼Œæ°å¥½æ˜¯shellcodeå­˜å‚¨çš„ä½ç½®ã€‚

å¦‚æœåœ¨Windowsæˆ–Linuxä¸­æœªå¯ç”¨**åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰**ï¼Œåˆ™å¯ä»¥ä½¿ç”¨åœ¨å…±äº«åº“ä¸­æ‰¾åˆ°çš„`jmp esp`æˆ–`call esp`æŒ‡ä»¤ã€‚ç„¶è€Œï¼Œå¦‚æœå¯ç”¨äº†[**ASLR**](../common-binary-protections-and-bypasses/aslr/)ï¼Œå¯èƒ½éœ€è¦åœ¨å—å½±å“çš„ç¨‹åºå†…éƒ¨å¯»æ‰¾è¿™äº›æŒ‡ä»¤ï¼ˆæ‚¨å¯èƒ½éœ€è¦æ‰“è´¥[**PIE**](../common-binary-protections-and-bypasses/pie/)ï¼‰ã€‚

æ­¤å¤–ï¼Œèƒ½å¤Ÿå°†shellcodeæ”¾ç½®åœ¨**EIPæŸåä¹‹å**ï¼Œè€Œä¸æ˜¯åœ¨å †æ ˆä¸­é—´ï¼Œå¯ä»¥ç¡®ä¿åœ¨å‡½æ•°è¿è¡Œè¿‡ç¨‹ä¸­æ‰§è¡Œçš„ä»»ä½•`push`æˆ–`pop`æŒ‡ä»¤ä¸ä¼šå¹²æ‰°shellcodeã€‚å¦‚æœå°†shellcodeæ”¾ç½®åœ¨å‡½æ•°å †æ ˆçš„ä¸­é—´ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå¹²æ‰°ã€‚

### ç©ºé—´ä¸è¶³

å¦‚æœåœ¨è¦†ç›–RIPåç¼ºå°‘å†™å…¥ç©ºé—´ï¼ˆå¯èƒ½åªæœ‰å‡ ä¸ªå­—èŠ‚ï¼‰ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªåˆå§‹çš„`jmp` shellcodeï¼Œä¾‹å¦‚ï¼š
```armasm
sub rsp, 0x30
jmp rsp
```
### ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)ä¸­æ‰¾åˆ°æ­¤æŠ€æœ¯çš„ç¤ºä¾‹ï¼Œæœ€ç»ˆåˆ©ç”¨å¦‚ä¸‹ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

ç±»ä¼¼åœ°ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå‡½æ•°è¿”å›å­˜å‚¨shellcodeçš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨**`call eax`**æˆ–**`jmp eax`**æŒ‡ä»¤ï¼ˆç§°ä¸º**ret2eax**æŠ€æœ¯ï¼‰ï¼Œæä¾›å¦ä¸€ç§æ‰§è¡Œæˆ‘ä»¬çš„shellcodeçš„æ–¹æ³•ã€‚å°±åƒeaxä¸€æ ·ï¼Œ**ä»»ä½•å…¶ä»–å¯„å­˜å™¨**åŒ…å«ä¸€ä¸ªæœ‰è¶£çš„åœ°å€éƒ½å¯ä»¥è¢«ä½¿ç”¨ï¼ˆ**ret2reg**ï¼‰ã€‚

### ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ï¼š[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## ä¿æŠ¤æªæ–½

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): å¦‚æœå †æ ˆä¸å¯æ‰§è¡Œï¼Œè¿™å°†æ— æµäºäº‹ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å°†shellcodeæ”¾åœ¨å †æ ˆä¸­å¹¶è·³è½¬æ‰§è¡Œå®ƒã€‚
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): è¿™äº›å¯ä»¥ä½¿æŸ¥æ‰¾è·³è½¬åˆ°espæˆ–ä»»ä½•å…¶ä»–å¯„å­˜å™¨çš„æŒ‡ä»¤å˜å¾—æ›´åŠ å›°éš¾ã€‚

## å‚è€ƒèµ„æ–™

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)
