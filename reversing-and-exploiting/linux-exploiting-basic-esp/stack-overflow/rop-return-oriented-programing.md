# ROP - Return Oriented Programing

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Osnovne informacije**

**Return-Oriented Programming (ROP)** je napredna tehnika eksploatacije koja se koristi za zaobila쬰nje sigurnosnih mera poput **No-Execute (NX)** ili **Data Execution Prevention (DEP)**. Umesto ubacivanja i izvr코avanja shell koda, napada캜 koristi delove koda ve캖 prisutne u binarnom fajlu ili u u캜itanim bibliotekama, poznate kao **"gadgeti"**. Svaki gadget obi캜no zavr코ava sa `ret` instrukcijom i obavlja malu operaciju, poput preme코tanja podataka izme캠u registara ili izvo캠enja aritmeti캜kih operacija. Spajanjem ovih gadgeta, napada캜 mo쬰 konstruisati payload za izvo캠enje proizvoljnih operacija, efikasno zaobilaze캖i NX/DEP za코tite.

### Pozivni konvencije

Razumevanje **pozivnih konvencija** je klju캜no za konstruisanje efikasnih ROP lanaca, posebno prilikom pozivanja funkcija ili manipulisanja podacima:

**x86 (32-bit)**

* **cdecl**: Pozivaoc 캜isti stek. Argumenti funkcije se guraju na stek u obrnutom redosledu (desno-levo). **Argumenti se guraju na stek s desna na levo.**
* **stdcall**: Sli캜no cdecl-u, ali je callee odgovoran za 캜i코캖enje steka.

**x64 (64-bit)**

* Koristi **System V AMD64 ABI** pozivnu konvenciju na Unix-sli캜nim sistemima, gde se **prva 코est celobrojnih ili pokaziva캜kih argumenata prosle캠uje u registre `RDI`, `RSI`, `RDX`, `RCX`, `R8`, i `R9`**. Dodatni argumenti se prosle캠uju na steku. Povratna vrednost se sme코ta u `RAX`.
* **Windows x64** pozivna konvencija koristi `RCX`, `RDX`, `R8`, i `R9` za prva 캜etiri celobrojna ili pokaziva캜ka argumenta, sa dodatnim argumentima prosle캠enim na steku. Povratna vrednost se sme코ta u `RAX`.
* **Registri**: 64-bitni registri uklju캜uju `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, i `R8` do `R15`.

{% hint style="danger" %}
Iz ovih pozivnih konvencija je mogu캖e primetiti da se u **32 bitima argumenti** funkcija **prosle캠uju preko steka** dok se u **x64** sme코taju u **specifi캜ne registre**.
{% endhint %}

### Kako ROP funkcioni코e

1. **Preuzimanje kontrole nad tokom izvr코avanja**: Prvo, napada캜 mora preuzeti kontrolu nad tokom izvr코avanja programa, obi캜no iskori코캖avanjem prelivanja bafera da bi prepisao sa캜uvanu adresu povratka na steku.
2. **Spajanje Gadgeta**: Napada캜 zatim pa쬷jivo bira i spaja gadgete da bi izvr코io 쬰ljene akcije. To mo쬰 uklju캜ivati postavljanje argumenata za poziv funkcije, pozivanje funkcije (npr. `system("/bin/sh")`), i rukovanje neophodnim 캜i코캖enjem ili dodatnim operacijama.
3. **Izvr코avanje Payload-a**: Kada ranjiva funkcija zavr코i, umesto povratka na legitimnu lokaciju, po캜inje izvr코avanje lanca gadgeta.

### ROP Lanac u x86

Razmotrimo hipoteti캜ki scenario gde 쬰limo pozvati `system("/bin/sh")` koriste캖i ROP u 32-bitnom binarnom fajlu:

1. **Pronala쬰nje Gadgeta**: Pretpostavimo da smo prona코li slede캖e gadzete u binarnom fajlu ili u캜itanim bibliotekama:
* `pop eax; ret`: Skida vrh steka u `EAX` i vra캖a se.
* `pop ebx; ret`: Skida vrh steka u `EAX` i vra캖a se.
* `mov [ebx], eax; ret`: Preme코ta vrednost iz `EAX` na lokaciju na koju pokazuje `EBX`.
* Adresa `system` funkcije.
2. **Priprema Lanca**: Potrebno je pripremiti stek koji izgleda ovako:
* Adresa gadgeta koji postavlja `EBX`.
* Adresa gadgeta `pop eax; ret`.
* Adresa stringa `"/bin/sh"` u memoriji (ili gde planiramo da ga napi코emo).
* Adresa gadgeta `mov [ebx], eax; ret`, da premesti `"/bin/sh"` na lokaciju na koju pokazuje `EBX`.
* Adresa funkcije `system`, sa `EBX` koji pokazuje na코 string.
3. **Izvr코avanje**: Kada ranjiva funkcija zavr코i, po캜inje izvr코avanje na코eg lanca gadgeta, 코to na kraju poziva `system("/bin/sh")`, i otvara shell.

### ROP u x64

Razmotrimo hipoteti캜ki scenario gde 쬰lite pozvati `execve("/bin/sh", NULL, NULL)` na x64 sistemu koriste캖i System V AMD64 ABI:

1. **Pronala쬰nje Gadgeta**: Prvo biste trebali prona캖i gadzete koji vam omogu캖avaju kontrolu nad registrima `RDI`, `RSI`, i `RDX`, jer 캖e oni dr쬬ti argumente za `execve`.
2. **Konstrukcija Lanca**:
* **Postavite `RDI` da pokazuje na string `"/bin/sh"`**: Ovo se obi캜no radi sa `pop RDI; ret` gadgetom pra캖enim adresom stringa (koji mo쬰 biti potreban da se stavi u payload ili prona캠e u memoriji).
* **Postavite `RSI` i `RDX` na nulu**: Po코to su drugi i tre캖i argumenti za `execve` `NULL`, trebate gadzete da postavite ove registre na nulu, poput `xor RSI, RSI; ret` i `xor RDX, RDX; ret`.
* **Pozovite `execve`**: Na kraju, potreban je gadzet koji ska캜e na `execve` (ili ga indirektno poziva).
3. **Izvr코avanje Payload-a**: Nakon konstruisanja i slanja ovog payload-a ranjivoj aplikaciji, ROP lanac se izvr코ava, otvaraju캖i shell.

Po코to x64 koristi registre za prvih nekoliko argumenata, 캜esto zahteva manje gadgeta od x86 za jednostavne pozive funkcija, ali pronala쬰nje i spajanje pravih gadgeta mo쬰 biti slo쬰nije zbog pove캖anog broja registara i ve캖eg adresnog prostora. Pove캖an broj registara i ve캖i adresni prostor u **x64** arhitekturi pru쬬ju i mogu캖nosti i izazove za razvoj eksploatacije, posebno u kontekstu Return-Oriented Programming (ROP).

<details>

<summary><strong>Nau캜ite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi na캜ini podr코ke HackTricks-u:

* Ako 쬰lite da vidite **va코u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvani캜ni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na코u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
