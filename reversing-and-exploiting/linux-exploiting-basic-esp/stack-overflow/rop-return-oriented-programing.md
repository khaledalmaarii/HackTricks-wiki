# ROP - Return Oriented Programing

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Podstawowe informacje**

**Return-Oriented Programming (ROP)** to zaawansowana technika eksploatacji u偶ywana do obejcia zabezpiecze takich jak **No-Execute (NX)** lub **Data Execution Prevention (DEP)**. Zamiast wstrzykiwa i wykonywa kod powoki, atakujcy wykorzystuje fragmenty kodu ju偶 obecne w binarnym pliku lub w zaadowanych bibliotekach, znanych jako **"gad偶ety"**. Ka偶dy gad偶et zazwyczaj koczy si instrukcj `ret` i wykonuje ma operacj, tak jak przenoszenie danych midzy rejestrami lub wykonywanie operacji arytmetycznych. czc te gad偶ety, atakujcy mo偶e skonstruowa adunek w celu wykonania dowolnych operacji, skutecznie omijajc zabezpieczenia NX/DEP.

### Konwencje wywoywania

Zrozumienie **konwencji wywoywania** jest kluczowe dla skutecznego tworzenia acuch贸w ROP, zwaszcza podczas wywoywania funkcji lub manipulowania danymi:

**x86 (32-bit)**

* **cdecl**: Wywoujcy czyci stos. Argumenty funkcji s przekazywane na stosie w odwrotnej kolejnoci (od prawej do lewej). **Argumenty s przekazywane na stosie od prawej do lewej.**
* **stdcall**: Podobnie jak cdecl, ale wywoywany jest odpowiedzialny za czyszczenie stosu.

**x64 (64-bit)**

* U偶ywa konwencji wywoywania **System V AMD64 ABI** w systemach przypominajcych Unix, gdzie **pierwsze sze argument贸w cakowitych lub wska藕nik贸w jest przekazywane w rejestrach `RDI`, `RSI`, `RDX`, `RCX`, `R8` i `R9`**. Dodatkowe argumenty s przekazywane na stosie. Warto zwracana jest umieszczana w `RAX`.
* Konwencja wywoywania **Windows x64** u偶ywa `RCX`, `RDX`, `R8` i `R9` dla pierwszych czterech argument贸w cakowitych lub wska藕nik贸w, z dodatkowymi argumentami przekazywanymi na stosie. Warto zwracana jest umieszczana w `RAX`.
* **Rejestry**: 64-bitowe rejestry obejmuj `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` oraz `R8` do `R15`.

{% hint style="danger" %}
Z tych konwencji wywoywania mo偶na zauwa偶y, 偶e w **32 bitach argumenty** funkcji s **przekazywane przez stos**, podczas gdy w **x64** s **umieszczane w okrelonych rejestrach**.
{% endhint %}

### Jak dziaa ROP

1. **Przechwycenie przepywu sterowania**: Najpierw atakujcy musi przej kontrol nad przepywem programu, zazwyczaj wykorzystujc przepenienie bufora, aby nadpisa zapisany adres powrotu na stosie.
2. **acuchowanie gad偶et贸w**: Atakujcy nastpnie ostro偶nie wybiera i czy gad偶ety, aby wykona po偶dane akcje. Mo偶e to obejmowa ustawienie argument贸w dla wywoania funkcji, wywoanie funkcji (np. `system("/bin/sh")`) i obsug koniecznego sprztania lub dodatkowych operacji.
3. **Wykonanie adunku**: Gdy podatna funkcja zwraca, zamiast powr贸ci do prawidowej lokalizacji, zaczyna wykonywa acuch gad偶et贸w.

### acuch ROP w x86

Rozwa偶my hipotetyczny scenariusz, w kt贸rym chcemy wywoa `system("/bin/sh")` przy u偶yciu ROP w 32-bitowym binarnym pliku:

1. **Znajd藕 Gad偶ety**: Za贸偶my, 偶e znale藕limy nastpujce gad偶ety w binarnym pliku lub zaadowanych bibliotekach:
* `pop eax; ret`: Zdejmuje warto ze stosu do `EAX` i zwraca.
* `pop ebx; ret`: Zdejmuje warto ze stosu do `EAX` i zwraca.
* `mov [ebx], eax; ret`: Przenosi warto z `EAX` do lokalizacji wskazywanej przez `EBX`.
* Adres `system`.
2. **Przygotuj acuch**: Musimy przygotowa stos, kt贸ry wyglda nastpujco:
* Adres gad偶etu ustawiajcego `EBX`.
* Adres gad偶etu `pop eax; ret`.
* Adres acucha `"/bin/sh"` w pamici (lub gdzie planujemy go zapisa).
* Adres gad偶etu `mov [ebx], eax; ret`, aby przenie `"/bin/sh"` do lokalizacji wskazywanej przez `EBX`.
* Adres funkcji `system`, gdzie `EBX` wskazuje na nasz acuch.
3. **Wykonanie**: Gdy podatna funkcja zwraca, zaczyna wykonywa nasz acuch gad偶et贸w, w kocu wywoujc `system("/bin/sh")` i otwierajc powok.

### ROP w x64

Rozwa偶my hipotetyczny scenariusz, w kt贸rym chcesz wywoa `execve("/bin/sh", NULL, NULL)` na systemie x64, korzystajc z konwencji wywoywania System V AMD64 ABI:

1. **Znajdowanie Gad偶et贸w**: Najpierw musisz znale藕 gad偶ety, kt贸re umo偶liwi kontrol nad rejestrami `RDI`, `RSI` i `RDX`, poniewa偶 bd one przechowywa argumenty dla `execve`.
2. **Konstrukcja acucha**:
* **Ustaw `RDI`, aby wskazywa na acuch `"/bin/sh"`**: Zazwyczaj jest to wykonywane za pomoc gad偶etu `pop RDI; ret`, a nastpnie adresu acucha (kt贸ry mo偶e by umieszczony w adunku lub znaleziony w pamici).
* **Wyzeruj `RSI` i `RDX`**: Poniewa偶 drugi i trzeci argument dla `execve` to `NULL`, potrzebujesz gad偶et贸w do wyzerowania tych rejestr贸w, takich jak `xor RSI, RSI; ret` i `xor RDX, RDX; ret`.
* **Wywoaj `execve`**: W kocu potrzebny jest gad偶et, kt贸ry przeskakuje do `execve` (lub porednio j wywouje).
3. **Wykonanie adunku**: Po skonstruowaniu i wysaniu tego adunku do podatnej aplikacji, acuch ROP wykonuje si, uruchamiajc powok.

Poniewa偶 x64 u偶ywa rejestr贸w dla kilku pierwszych argument贸w, czsto wymaga mniej gad偶et贸w ni偶 x86 do prostych wywoa funkcji, ale znalezienie i czenie odpowiednich gad偶et贸w mo偶e by bardziej skomplikowane ze wzgldu na zwikszon liczb rejestr贸w i wiksz przestrze adresow. Zwikszona liczba rejestr贸w i wiksza przestrze adresowa w architekturze **x64** stanowi zar贸wno szanse, jak i wyzwania dla rozwoju eksploatacji, zwaszcza w kontekcie Return-Oriented Programming (ROP).

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
