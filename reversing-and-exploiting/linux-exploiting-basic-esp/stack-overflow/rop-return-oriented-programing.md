# ROP - Return Oriented Programing

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶nderin.

</details>

## **Temel Bilgiler**

**Return-Oriented Programming (ROP)**, **No-Execute (NX)** veya **Data Execution Prevention (DEP)** gibi gÃ¼venlik Ã¶nlemlerini atlatmak iÃ§in kullanÄ±lan geliÅŸmiÅŸ bir sÄ±zma tekniÄŸidir. Bir saldÄ±rgan, shellcode enjekte etmek ve yÃ¼rÃ¼tmek yerine, binary veya yÃ¼klenmiÅŸ kÃ¼tÃ¼phanelerde zaten bulunan kod parÃ§alarÄ±nÄ±, yani **"gadget"** olarak bilinen parÃ§alarÄ± kullanÄ±r. Her gadget genellikle bir `ret` talimatÄ± ile biter ve veri taÅŸÄ±ma veya aritmetik iÅŸlemler gibi kÃ¼Ã§Ã¼k bir iÅŸlem gerÃ§ekleÅŸtirir. Bu gadget'larÄ± bir araya getirerek, bir saldÄ±rgan, NX/DEP korumalarÄ±nÄ± atlayarak keyfi iÅŸlemler gerÃ§ekleÅŸtirmek iÃ§in bir yÃ¼k oluÅŸturabilir.

### Ã‡aÄŸrÄ± KavramlarÄ±

**Ã‡aÄŸrÄ± kavramlarÄ±nÄ±** anlamak, Ã¶zellikle fonksiyonlarÄ± Ã§aÄŸÄ±rÄ±rken veya veri manipÃ¼lasyonu yaparken etkili ROP zincirleri oluÅŸturmak iÃ§in hayati Ã¶nem taÅŸÄ±r:

**x86 (32-bit)**

* **cdecl**: Ã‡aÄŸrÄ± yapan yÄ±ÄŸÄ±nÄ± temizler. Fonksiyon argÃ¼manlarÄ± ters sÄ±rayla (saÄŸdan sola) yÄ±ÄŸÄ±na itilir. **ArgÃ¼manlar saÄŸdan sola doÄŸru yÄ±ÄŸÄ±na itilir.**
* **stdcall**: cdecl'e benzer, ancak yÄ±ÄŸÄ±ndaki temizleme iÅŸlemi Ã§aÄŸrÄ±yÄ± yapan tarafÄ±ndan yapÄ±lÄ±r.

**x64 (64-bit)**

* Unix benzeri sistemlerde **System V AMD64 ABI** Ã§aÄŸrÄ± kavramÄ±nÄ± kullanÄ±r, burada **ilk altÄ± tamsayÄ± veya iÅŸaretÃ§i argÃ¼manlar `RDI`, `RSI`, `RDX`, `RCX`, `R8` ve `R9`** registerlara geÃ§irilir. Ek argÃ¼manlar yÄ±ÄŸÄ±nda geÃ§irilir. DÃ¶nÃ¼ÅŸ deÄŸeri `RAX` registerÄ±na yerleÅŸtirilir.
* **Windows x64** Ã§aÄŸrÄ± kavramÄ±, ilk dÃ¶rt tamsayÄ± veya iÅŸaretÃ§i argÃ¼manlar iÃ§in `RCX`, `RDX`, `R8` ve `R9` kullanÄ±r, ek argÃ¼manlar yÄ±ÄŸÄ±nda geÃ§irilir. DÃ¶nÃ¼ÅŸ deÄŸeri `RAX` registerÄ±na yerleÅŸtirilir.
* **Registerler**: 64-bit registerlar `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` ve `R8` ile `R15` iÃ§erir.

{% hint style="danger" %}
Bu Ã§aÄŸrÄ± kavramlarÄ±ndan, **32 bitlerde fonksiyonlara argÃ¼manlarÄ±n yÄ±ÄŸÄ±n Ã¼zerinden** geÃ§tiÄŸi, **x64**'te ise **belirli registerlara yerleÅŸtirildiÄŸi** gÃ¶rÃ¼lebilir.
{% endhint %}

### ROP NasÄ±l Ã‡alÄ±ÅŸÄ±r

1. **Kontrol AkÄ±ÅŸÄ± KaÃ§Ä±rma**: Ä°lk olarak, bir saldÄ±rganÄ±n bir programÄ±n kontrol akÄ±ÅŸÄ±nÄ± ele geÃ§irmesi gerekir, genellikle bir tampon taÅŸmasÄ± kullanarak yÄ±ÄŸÄ±nda kaydedilen bir dÃ¶nÃ¼ÅŸ adresini Ã¼zerine yazarak.
2. **Gadget Zinciri**: SaldÄ±rgan daha sonra istenilen iÅŸlemleri gerÃ§ekleÅŸtirmek iÃ§in dikkatlice gadget'larÄ± seÃ§er ve birbirine baÄŸlar. Bu, bir fonksiyon Ã§aÄŸrÄ±sÄ± iÃ§in argÃ¼manlarÄ± ayarlamayÄ±, fonksiyonu Ã§aÄŸÄ±rmayÄ± (Ã¶rneÄŸin, `system("/bin/sh")`), gerekli temizlik veya ek iÅŸlemleri ele almayÄ± iÃ§erebilir.
3. **YÃ¼k YÃ¼rÃ¼tme**: ZayÄ±f olan fonksiyon geri dÃ¶ndÃ¼ÄŸÃ¼nde, meÅŸru bir konuma dÃ¶nmemek yerine, gadget zincirini yÃ¼rÃ¼tmeye baÅŸlar.

### x86'da ROP Zinciri

32-bit bir binary'de ROP kullanarak `system("/bin/sh")` Ã§aÄŸÄ±rmak istediÄŸimiz varsayÄ±msal bir senaryoyu ele alalÄ±m:

1. **Gadget'larÄ± Bulma**: VarsayalÄ±m ki binary veya yÃ¼klenmiÅŸ kÃ¼tÃ¼phanelerde aÅŸaÄŸÄ±daki gadget'larÄ± bulduk:
* `pop eax; ret`: YÄ±ÄŸÄ±nÄ±n en Ã¼stÃ¼ndeki deÄŸeri `EAX`'a Ã§Ä±karÄ±r ve dÃ¶ner.
* `pop ebx; ret`: YÄ±ÄŸÄ±nÄ±n en Ã¼stÃ¼ndeki deÄŸeri `EAX`'a Ã§Ä±karÄ±r ve dÃ¶ner.
* `mov [ebx], eax; ret`: `EAX` iÃ§indeki deÄŸeri `EBX` tarafÄ±ndan iÅŸaret edilen konuma taÅŸÄ±r.
* `system` fonksiyonunun adresi.
2. **Zinciri HazÄ±rlama**: AÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nen bir yÄ±ÄŸÄ±n hazÄ±rlamamÄ±z gerekiyor:
* `EBX`'i ayarlayan gadget'Ä±n adresi.
* `pop eax; ret` gadget'Ä±n adresi.
* Bellekteki `"/bin/sh"` dizesinin adresi (veya yazmayÄ± planladÄ±ÄŸÄ±mÄ±z yer).
* `mov [ebx], eax; ret` gadget'Ä±n adresi, `EBX` tarafÄ±ndan iÅŸaret edilen yere `"/bin/sh"`'i taÅŸÄ±mak iÃ§in.
* `system` fonksiyonunun adresi, `EBX`'in dizesini iÅŸaret ettiÄŸi yerde.
3. **YÃ¼rÃ¼tme**: ZayÄ±f olan fonksiyon geri dÃ¶ndÃ¼ÄŸÃ¼nde, gadget zincirimizi yÃ¼rÃ¼tmeye baÅŸlar, sonunda `system("/bin/sh")`'i Ã§aÄŸÄ±rÄ±r ve bir shell aÃ§ar.

### x64'te ROP

System V AMD64 ABI'yi kullanarak x64 sistemde `execve("/bin/sh", NULL, NULL)` Ã§aÄŸÄ±rmak istediÄŸiniz varsayÄ±msal bir senaryoyu ele alalÄ±m:

1. **Gadget'larÄ± Bulma**: Ä°lk olarak, `execve`'ye geÃ§irilecek olan `RDI`, `RSI` ve `RDX` registerlarÄ±nÄ± kontrol etmenizi saÄŸlayan gadget'larÄ± bulmanÄ±z gerekir.
2. **Zincir OluÅŸturma**:
* **`RDI`'yi `"/bin/sh"` dizesine iÅŸaret etmek**: Bu genellikle bir `pop RDI; ret` gadget'Ä± ile yapÄ±lÄ±r ve ardÄ±ndan dizenin adresi (yÃ¼klÃ¼ olmasÄ± gereken veya bellekte bulunmasÄ± gereken) takip edilir.
* **`RSI` ve `RDX`'i sÄ±fÄ±rla**: `execve`'nin ikinci ve Ã¼Ã§Ã¼ncÃ¼ argÃ¼manlarÄ± `NULL` olduÄŸundan, bu registerlarÄ± sÄ±fÄ±rlayan gadget'lara ihtiyacÄ±nÄ±z vardÄ±r, Ã¶rneÄŸin `xor RSI, RSI; ret` ve `xor RDX, RDX; ret`.
* **`execve`'yi Ã§aÄŸÄ±rma**: Son olarak, `execve`'ye atlayan bir gadget'a (veya dolaylÄ± olarak Ã§aÄŸÄ±ran bir gadget) ihtiyaÃ§ vardÄ±r.
3. **YÃ¼k YÃ¼rÃ¼tme**: Bu yÃ¼kÃ¼ oluÅŸturup zayÄ±f bir uygulamaya gÃ¶nderdikten sonra, ROP zinciri yÃ¼rÃ¼tÃ¼lÃ¼r ve bir shell baÅŸlatÄ±lÄ±r.

x64, ilk birkaÃ§ argÃ¼man iÃ§in registerlarÄ± kullandÄ±ÄŸÄ±ndan, basit fonksiyon Ã§aÄŸrÄ±larÄ± iÃ§in genellikle x86'dan daha az gadget gerektirir, ancak doÄŸru gadget'larÄ± bulup birleÅŸtirmek, artan register sayÄ±sÄ± ve daha bÃ¼yÃ¼k adres alanÄ± nedeniyle daha karmaÅŸÄ±k olabilir. **x64** mimarisindeki artan register sayÄ±sÄ± ve daha bÃ¼yÃ¼k adres alanÄ±, Ã¶zellikle Return-Oriented Programming (ROP) baÄŸlamÄ±nda, sÄ±zma geliÅŸtirme iÃ§in hem fÄ±rsatlar hem de zorluklar sunar.

<details>

<summary><strong>AWS hackleme konusunda sÄ±fÄ±rdan kahramana kadar Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ±)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini alÄ±n**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± gÃ¶ndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na PR gÃ¶nderin.

</details>
