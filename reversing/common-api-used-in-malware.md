# Powszechne API u偶ywane w zoliwym oprogramowaniu

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>

## Og贸lne

### Sieci

| Surowe Gniazdka | WinAPI Sockets |
| --------------- | -------------- |
| socket()        | WSAStratup()   |
| bind()          | bind()         |
| listen()        | listen()       |
| accept()        | accept()       |
| connect()       | connect()      |
| read()/recv()   | recv()         |
| write()         | send()         |
| shutdown()      | WSACleanup()   |

### Trwao

| Rejestr           | Plik          | Usuga                      |
| ----------------- | ------------- | --------------------------- |
| RegCreateKeyEx()  | GetTempPath() | OpenSCManager               |
| RegOpenKeyEx()    | CopyFile()    | CreateService()             |
| RegSetValueEx()   | CreateFile()  | StartServiceCtrlDispatcher() |
| RegDeleteKeyEx()  | WriteFile()   |                             |
| RegGetValue()     | ReadFile()    |                             |

### Szyfrowanie

| Nazwa                  |
| ---------------------- |
| WinCrypt               |
| CryptAcquireContext()  |
| CryptGenKey()          |
| CryptDeriveKey()       |
| CryptDecrypt()         |
| CryptReleaseContext()  |

### Anty-Analiza/VM

| Nazwa Funkcji                                            | Instrukcje Assembly |
| -------------------------------------------------------- | ------------------- |
| IsDebuggerPresent()                                      | CPUID()             |
| GetSystemInfo()                                          | IN()                |
| GlobalMemoryStatusEx()                                   |                     |
| GetVersion()                                             |                     |
| CreateToolhelp32Snapshot \[Sprawd藕, czy proces jest uruchomiony] |                     |
| CreateFileW/A \[Sprawd藕, czy plik istnieje]              |                     |

### Ukrywanie

| Nazwa                    |                                                                            |
| ------------------------ | -------------------------------------------------------------------------- |
| VirtualAlloc             | Alokuje pami (pakowacze)                                                |
| VirtualProtect           | Zmienia uprawnienia pamici (pakowacz nadaje uprawnienia do wykonania sekcji) |
| ReadProcessMemory        | Wstrzyknicie do zewntrznych proces贸w                                    |
| WriteProcessMemoryA/W    | Wstrzyknicie do zewntrznych proces贸w                                    |
| NtWriteVirtualMemory     |                                                                            |
| CreateRemoteThread       | Wstrzyknicie DLL/procesu...                                              |
| NtUnmapViewOfSection     |                                                                            |
| QueueUserAPC             |                                                                            |
| CreateProcessInternalA/W |                                                                            |

### Wykonanie

| Nazwa Funkcji    |
| ---------------- |
| CreateProcessA/W |
| ShellExecute     |
| WinExec          |
| ResumeThread     |
| NtResumeThread   |

### R贸偶ne

* GetAsyncKeyState() -- Rejestracja klawiszy
* SetWindowsHookEx -- Rejestracja klawiszy
* GetForeGroundWindow -- Pobierz nazw aktywnego okna (lub witryn z przegldarki)
* LoadLibrary() -- Importuj bibliotek
* GetProcAddress() -- Importuj bibliotek
* CreateToolhelp32Snapshot() -- Lista uruchomionych proces贸w
* GetDC() -- Zrzut ekranu
* BitBlt() -- Zrzut ekranu
* InternetOpen(), InternetOpenUrl(), InternetReadFile(), InternetWriteFile() -- Dostp do Internetu
* FindResource(), LoadResource(), LockResource() -- Dostp do zasob贸w wykonywalnych

## Techniki Malware

### Wstrzykiwanie DLL

Wykonaj dowolne DLL wewntrz innego procesu

1. Zlokalizuj proces do wstrzyknicia zoliwej DLL: CreateToolhelp32Snapshot, Process32First, Process32Next
2. Otw贸rz proces: GetModuleHandle, GetProcAddress, OpenProcess
3. Zapisz cie偶k do DLL wewntrz procesu: VirtualAllocEx, WriteProcessMemory
4. Utw贸rz wtek w procesie, kt贸ry zaaduje zoliw DLL: CreateRemoteThread, LoadLibrary

Inne funkcje do u偶ycia: NTCreateThreadEx, RtlCreateUserThread

### Wstrzykiwanie Refleksyjne DLL

Zaaduj zoliw DLL bez wywoywania normalnych wywoa API systemu Windows.\
DLL jest mapowana wewntrz procesu, rozwi偶e adresy importu, naprawi relokacje i wywoa funkcj DllMain.

### Przechwytywanie Wtk贸w

Znajd藕 wtek w procesie i spraw, aby zaadowa zoliw DLL

1. Znajd藕 docelowy wtek: CreateToolhelp32Snapshot, Thread32First, Thread32Next
2. Otw贸rz wtek: OpenThread
3. Wstrzymaj wtek: SuspendThread
4. Zapisz cie偶k do zoliwej DLL wewntrz procesu ofiary: VirtualAllocEx, WriteProcessMemory
5. Wzn贸w wtek adowania biblioteki: ResumeThread

### Wstrzykiwanie PE

Wstrzyknicie Wykonywalne: Wykonywalny plik zostanie zapisany w pamici procesu ofiary i zostanie wykonany stamtd.

### Wypaczanie Proces贸w

Zoliwe oprogramowanie odmapuje legalny kod z pamici procesu i zaaduje zoliwy plik binarny

1. Utw贸rz nowy proces: CreateProcess
2. Odmapuj pami: ZwUnmapViewOfSection, NtUnmapViewOfSection
3. Zapisz zoliwy plik binarny w pamici procesu: VirtualAllocEc, WriteProcessMemory
4. Ustaw punkt wejcia i wykonaj: SetThreadContext, ResumeThread

## Hooking

* **SSDT** (**System Service Descriptor Table**) wskazuje na funkcje jdra (ntoskrnl.exe) lub sterownik GUI (win32k.sys), dziki czemu procesy u偶ytkownika mog wywoywa te funkcje.
* Rootkit mo偶e zmodyfikowa te wska藕niki na adresy, kt贸re kontroluje
* **IRP** (**I/O Request Packets**) przesyaj fragmenty danych z jednego komponentu do drugiego. Prawie wszystko w jdrze u偶ywa IRP, a ka偶dy obiekt urzdzenia ma wasn tabel funkcji, kt贸r mo偶na przechwyci: DKOM (Direct Kernel Object Manipulation)
* **IAT** (**Import Address Table**) jest przydatna do rozwizywania zale偶noci. Mo偶na przechwyci t tabel, aby przej kod, kt贸ry zostanie wywoany.
* **EAT** (**Export Address Table**) Hooks. Te haki mo偶na wykona z **userland**. Celem jest przechwycenie funkcji eksportowanych przez biblioteki DLL.
* **Inline Hooks**: Ten typ jest trudny do osignicia. Polega to na modyfikowaniu kodu funkcji. By mo偶e poprzez umieszczenie skoku na pocztku tego. 

<details>

<summary><strong>Nauka hakowania AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeli chcesz zobaczy swoj **firm reklamowan w HackTricks** lub **pobra HackTricks w formacie PDF**, sprawd藕 [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si swoimi sztuczkami hakowania, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) na GitHubie.

</details>
