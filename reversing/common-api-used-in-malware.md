# APIs Comuns Usadas em Malwares

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Gen√©rico

### Rede

| Raw Sockets   | WinAPI Sockets |
| ------------- | -------------- |
| socket()      | WSAStratup()   |
| bind()        | bind()         |
| listen()      | listen()       |
| accept()      | accept()       |
| connect()     | connect()      |
| read()/recv() | recv()         |
| write()       | send()         |
| shutdown()    | WSACleanup()   |

### Persist√™ncia

| Registro         | Arquivo       | Servi√ßo                      |
| ---------------- | ------------- | ---------------------------- |
| RegCreateKeyEx() | GetTempPath() | OpenSCManager                |
| RegOpenKeyEx()   | CopyFile()    | CreateService()              |
| RegSetValueEx()  | CreateFile()  | StartServiceCtrlDispatcher() |
| RegDeleteKeyEx() | WriteFile()   |                              |
| RegGetValue()    | ReadFile()    |                              |

### Criptografia

| Nome                  |
| --------------------- |
| WinCrypt              |
| CryptAcquireContext() |
| CryptGenKey()         |
| CryptDeriveKey()      |
| CryptDecrypt()        |
| CryptReleaseContext() |

### Anti-An√°lise/VM

| Nome da Fun√ß√£o                                           | Instru√ß√µes de Assembly |
| --------------------------------------------------------- | --------------------- |
| IsDebuggerPresent()                                       | CPUID()               |
| GetSystemInfo()                                           | IN()                  |
| GlobalMemoryStatusEx()                                    |                       |
| GetVersion()                                              |                       |
| CreateToolhelp32Snapshot \[Verificar se um processo est√° em execu√ß√£o] |                       |
| CreateFileW/A \[Verificar se um arquivo existe]                    |                       |

### Furtividade

| Nome                     |                                                                            |
| ------------------------ | -------------------------------------------------------------------------- |
| VirtualAlloc             | Alocar mem√≥ria (empacotadores)                                                     |
| VirtualProtect           | Alterar permiss√£o de mem√≥ria (empacotador dando permiss√£o de execu√ß√£o a uma se√ß√£o) |
| ReadProcessMemory        | Inje√ß√£o em processos externos                                          |
| WriteProcessMemoryA/W    | Inje√ß√£o em processos externos                                          |
| NtWriteVirtualMemory     |                                                                            |
| CreateRemoteThread       | Inje√ß√£o de DLL/Processo...                                                   |
| NtUnmapViewOfSection     |                                                                            |
| QueueUserAPC             |                                                                            |
| CreateProcessInternalA/W |                                                                            |

### Execu√ß√£o

| Nome da Fun√ß√£o    |
| ---------------- |
| CreateProcessA/W |
| ShellExecute     |
| WinExec          |
| ResumeThread     |
| NtResumeThread   |

### Diversos

* GetAsyncKeyState() -- Registro de teclas
* SetWindowsHookEx -- Registro de teclas
* GetForeGroundWindow -- Obter nome da janela em execu√ß√£o (ou o site de um navegador)
* LoadLibrary() -- Importar biblioteca
* GetProcAddress() -- Importar biblioteca
* CreateToolhelp32Snapshot() -- Listar processos em execu√ß√£o
* GetDC() -- Captura de tela
* BitBlt() -- Captura de tela
* InternetOpen(), InternetOpenUrl(), InternetReadFile(), InternetWriteFile() -- Acessar a Internet
* FindResource(), LoadResource(), LockResource() -- Acessar recursos do execut√°vel

## T√©cnicas de Malware

### Inje√ß√£o de DLL

Executar uma DLL arbitr√°ria dentro de outro processo

1. Localizar o processo para injetar a DLL maliciosa: CreateToolhelp32Snapshot, Process32First, Process32Next
2. Abrir o processo: GetModuleHandle, GetProcAddress, OpenProcess
3. Escrever o caminho da DLL dentro do processo: VirtualAllocEx, WriteProcessMemory
4. Criar uma thread no processo que carregar√° a DLL maliciosa: CreateRemoteThread, LoadLibrary

Outras fun√ß√µes a serem usadas: NTCreateThreadEx, RtlCreateUserThread

### Inje√ß√£o de DLL Reflexiva

Carregar uma DLL maliciosa sem chamar chamadas normais de API do Windows.\
A DLL √© mapeada dentro de um processo, resolver√° os endere√ßos de importa√ß√£o, corrigir√° as realoca√ß√µes e chamar√° a fun√ß√£o DllMain.

### Sequestro de Thread

Encontrar um thread de um processo e fazer com que ele carregue uma DLL maliciosa

1. Encontrar um thread alvo: CreateToolhelp32Snapshot, Thread32First, Thread32Next
2. Abrir o thread: OpenThread
3. Suspender o thread: SuspendThread
4. Escrever o caminho da DLL maliciosa dentro do processo v√≠tima: VirtualAllocEx, WriteProcessMemory
5. Retomar o thread carregando a biblioteca: ResumeThread

### Inje√ß√£o de PE

Inje√ß√£o de Execu√ß√£o Port√°til: O execut√°vel ser√° escrito na mem√≥ria do processo v√≠tima e ser√° executado a partir dali.

### Oco de Processo

O malware desmapear√° o c√≥digo leg√≠timo da mem√≥ria do processo e carregar√° um bin√°rio malicioso

1. Criar um novo processo: CreateProcess
2. Desmapear a mem√≥ria: ZwUnmapViewOfSection, NtUnmapViewOfSection
3. Escrever o bin√°rio malicioso na mem√≥ria do processo: VirtualAllocEc, WriteProcessMemory
4. Definir o ponto de entrada e executar: SetThreadContext, ResumeThread

## Hooking

* A **SSDT** (**Tabela de Descritores de Servi√ßo do Sistema**) aponta para fun√ß√µes do kernel (ntoskrnl.exe) ou driver GUI (win32k.sys) para que processos de usu√°rio possam chamar essas fun√ß√µes.
* Um rootkit pode modificar esses ponteiros para endere√ßos que ele controla
* **IRP** (**Pacotes de Solicita√ß√£o de E/S**) transmitem peda√ßos de dados de um componente para outro. Quase tudo no kernel usa IRPs e cada objeto de dispositivo tem sua pr√≥pria tabela de fun√ß√µes que pode ser sequestrada: DKOM (Manipula√ß√£o Direta de Objetos do Kernel)
* A **IAT** (**Tabela de Endere√ßos de Importa√ß√£o**) √© √∫til para resolver depend√™ncias. √â poss√≠vel sequestrar essa tabela para interceptar o c√≥digo que ser√° chamado.
* **EAT** (**Tabela de Endere√ßos de Exporta√ß√£o**) Hooks. Esses hooks podem ser feitos do **espa√ßo do usu√°rio**. O objetivo √© sequestrar fun√ß√µes exportadas por DLLs.
* **Hooks Inline**: Esse tipo √© dif√≠cil de alcan√ßar. Isso envolve modificar o c√≥digo das fun√ß√µes em si. Talvez colocando um salto no in√≠cio disso.

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no GitHub.

</details>
