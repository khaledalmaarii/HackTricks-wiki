# Shadow Credentials

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Intro <a href="#3f17" id="3f17"></a>

**Check the original post for [all the information about this technique](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab).**

**рд╕рд╛рд░рд╛рдВрд╢**: рдпрджрд┐ рдЖрдк рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рдХрдВрдкреНрдпреВрдЯрд░ рдХреА **msDS-KeyCredentialLink** рдкреНрд░реЙрдкрд░реНрдЯреА рдореЗрдВ рд▓рд┐рдЦ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЙрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдХрд╛ **NT рд╣реИрд╢** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдкреЛрд╕реНрдЯ рдореЗрдВ, рдПрдХ рд╡рд┐рдзрд┐ рдХрд╛ рд╡рд┐рд╡рд░рдг рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ-рдирд┐рдЬреА рдХреБрдВрдЬреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рддрд╛рдХрд┐ рдПрдХ рдЕрджреНрд╡рд┐рддреАрдп **рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯ** рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬрд┐рд╕рдореЗрдВ рд▓рдХреНрд╖рд┐рдд рдХрд╛ NTLM рд╣реИрд╢ рд╢рд╛рдорд┐рд▓ рд╣реЛред рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ Privilege Attribute Certificate (PAC) рдХреЗ рднреАрддрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб NTLM_SUPPLEMENTAL_CREDENTIAL рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬрд┐рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### Requirements

рдЗрд╕ рддрдХрдиреАрдХ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╢рд░реНрддреЗрдВ рдкреВрд░реА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП:
- рдПрдХ рдиреНрдпреВрдирддрдо Windows Server 2016 рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
- рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдореЗрдВ рдПрдХ рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдбрд┐рдЬрд┐рдЯрд▓ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
- рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ Windows Server 2016 рдлрд╝рдВрдХреНрд╢рдирд▓ рд╕реНрддрд░ рдкрд░ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред
- рд▓рдХреНрд╖рд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА msDS-KeyCredentialLink рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдЦрд╛рддрд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

## Abuse

рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдХреА рдЯреНрд░рд╕реНрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдЯрд┐рдХрдЯ рдЧреНрд░рд╛рдВрдЯрд┐рдВрдЧ рдЯрд┐рдХрдЯ (TGT) рдФрд░ NTLM рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╕реЗ рдкрд░реЗ рдХрджрдореЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИред рд╡рд┐рдХрд▓реНрдкреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:
1. рд▓рдХреНрд╖рд┐рдд рд╣реЛрд╕реНрдЯ рдкрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **RC4 рд╕рд┐рд▓реНрд╡рд░ рдЯрд┐рдХрдЯ** рдмрдирд╛рдирд╛ред
2. **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ** рдХреЗ рдЕрдиреБрдХрд░рдг рдХреЗ рд▓рд┐рдП **S4U2Self** рдХреЗ рд╕рд╛рде TGT рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛, рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛ рдирд╛рдо рдореЗрдВ рд╕реЗрд╡рд╛ рд╡рд░реНрдЧ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдХреА рдЯреНрд░рд╕реНрдЯ рдХреЗ рджреБрд░реБрдкрдпреЛрдЧ рдХрд╛ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд▓рд╛рдн рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдирд┐рдЬреА рдХреБрдВрдЬреА рддрдХ рд╕реАрдорд┐рдд рд╣реИ, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдХрдордЬреЛрд░ рдЦрд╛рддреЛрдВ рдХреЛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рд╕реЗ рдмрдЪрд╛рддрд╛ рд╣реИ рдФрд░ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддрд╛ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА, рдЬрд┐рд╕реЗ рд╣рдЯрд╛рдирд╛ рдЪреБрдиреМрддреАрдкреВрд░реНрдг рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

## Tools

###┬а[**Whisker**](https://github.com/eladshamir/Whisker)

рдпрд╣ рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП C# рдЗрдВрдЯрд░рдлреЗрд╕ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рд╡рд╛рд▓реЗ DSInternals рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИред Whisker рдФрд░ рдЗрд╕рдХреЗ Python рд╕рдордХрдХреНрд╖, **pyWhisker**, рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдЦрд╛рддреЛрдВ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `msDS-KeyCredentialLink` рд╡рд┐рд╢реЗрд╖рддрд╛ рдореЗрдВ рд╣реЗрд░рдлреЗрд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред рдпреЗ рдЙрдкрдХрд░рдг рд▓рдХреНрд╖рд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдХреБрдВрдЬреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдЬреЛрдбрд╝рдиреЗ, рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ, рд╣рдЯрд╛рдиреЗ рдФрд░ рд╕рд╛рдлрд╝ рдХрд░рдиреЗ рдЬреИрд╕реА рд╡рд┐рднрд┐рдиреНрди рдХрд╛рд░реНрдпрд╡рд╛рд╣рд┐рдпреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред

**Whisker** рдХрд╛рд░реНрдпреЛрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:
- **Add**: рдПрдХ рдХреБрдВрдЬреА рдЬреЛрдбрд╝реА рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдПрдХ рдХреБрдВрдЬреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЬреЛрдбрд╝рддрд╛ рд╣реИред
- **List**: рд╕рднреА рдХреБрдВрдЬреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред
- **Remove**: рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреБрдВрдЬреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХреЛ рд╣рдЯрд╛рддрд╛ рд╣реИред
- **Clear**: рд╕рднреА рдХреБрдВрдЬреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдорд┐рдЯрд╛ рджреЗрддрд╛ рд╣реИ, рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рд╡реИрдз WHfB рдЙрдкрдпреЛрдЧ рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИред
```shell
Whisker.exe add /target:computername$ /domain:constoso.local /dc:dc1.contoso.local /path:C:\path\to\file.pfx /password:P@ssword1
```
### [pyWhisker](https://github.com/ShutdownRepo/pywhisker)

рдпрд╣ Whisker рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ **UNIX-рдЖрдзрд╛рд░рд┐рдд рд╕рд┐рд╕реНрдЯрдо** рдкрд░ рдмрдврд╝рд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ KeyCredentials рдХреА рд╕реВрдЪреА рдмрдирд╛рдиреЗ, рдЬреЛрдбрд╝рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП Impacket рдФрд░ PyDSInternals рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╕рд╛рде рд╣реА рдЗрдиреНрд╣реЗрдВ JSON рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдЖрдпрд╛рдд рдФрд░ рдирд┐рд░реНрдпрд╛рдд рдХрд░рдиреЗ рдХреА рд╡реНрдпрд╛рдкрдХ рд╢реЛрд╖рдг рдХреНрд╖рдорддрд╛рдПрдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред
```shell
python3 pywhisker.py -d "domain.local" -u "user1" -p "complexpassword" --target "user2" --action "list"
```
### [ShadowSpray](https://github.com/Dec0ne/ShadowSpray/)

ShadowSpray рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп **рдбреЛрдореЗрди рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдкрд░ рд╡реНрдпрд╛рдкрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдореВрд╣реЛрдВ рдХреЗ рдкрд╛рд╕ рд╣реЛ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ GenericWrite/GenericAll рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдирд╛** рд╣реИ рддрд╛рдХрд┐ ShadowCredentials рдХреЛ рд╡реНрдпрд╛рдкрдХ рд░реВрдк рд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдЗрд╕рдореЗрдВ рдбреЛрдореЗрди рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░рдирд╛, рдбреЛрдореЗрди рдХреЗ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рд╕реНрддрд░ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдирд╛, рдбреЛрдореЗрди рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреА рдЧрдгрдирд╛ рдХрд░рдирд╛, рдФрд░ TGT рдЕрдзрд┐рдЧреНрд░рд╣рдг рдФрд░ NT рд╣реИрд╢ рдкреНрд░рдХрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП KeyCredentials рдЬреЛрдбрд╝рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред рд╕рдлрд╛рдИ рд╡рд┐рдХрд▓реНрдк рдФрд░ рдкреБрдирд░рд╛рд╡реГрддреНрдд рд╢реЛрд╖рдг рд░рдгрдиреАрддрд┐рдпрд╛рдБ рдЗрд╕рдХреА рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХреЛ рдмрдврд╝рд╛рддреА рд╣реИрдВред

## References

* [https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab)
* [https://github.com/eladshamir/Whisker](https://github.com/eladshamir/Whisker)
* [https://github.com/Dec0ne/ShadowSpray/](https://github.com/Dec0ne/ShadowSpray/)
* [https://github.com/ShutdownRepo/pywhisker](https://github.com/ShutdownRepo/pywhisker)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
