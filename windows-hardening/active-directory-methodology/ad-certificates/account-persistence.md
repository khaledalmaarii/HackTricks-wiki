# AD CS Account Persistence

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**рдпрд╣ [https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf) рд╕реЗ рд╢рд╛рдирджрд╛рд░ рд╢реЛрдз рдХреЗ рдорд╢реАрди рд╕реНрдерд┐рд░рддрд╛ рдЕрдзреНрдпрд╛рдпреЛрдВ рдХрд╛ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИред**

## **Understanding Active User Credential Theft with Certificates тАУ PERSIST1**

рдПрдХ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рдЬрд╣рд╛рдВ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬреЛ рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдЗрд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ **рдЕрдиреБрд░реЛрдз** рдХрд░рдиреЗ рдФрд░ **рдЪреЛрд░реА** рдХрд░рдиреЗ рдХрд╛ рдЕрд╡рд╕рд░ рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ **рд╕реНрдерд┐рд░рддрд╛ рдмрдирд╛рдП рд░рдЦреА рдЬрд╛ рд╕рдХреЗ**ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, Active Directory рдореЗрдВ `User` рдЯреЗрдореНрдкрд▓реЗрдЯ рдРрд╕реА рдЕрдиреБрд░реЛрдзреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕реЗ рдХрднреА-рдХрднреА рдЕрдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

[**Certify**](https://github.com/GhostPack/Certify) рдирд╛рдордХ рдПрдХ рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдХреЛрдИ рд╕реНрдерд╛рдпреА рдкрд╣реБрдВрдЪ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рдиреНрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреА рдЦреЛрдЬ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```bash
Certify.exe find /clientauth
```
рдпрд╣ рдЙрдЬрд╛рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рд╢рдХреНрддрд┐ рдЗрд╕ рдмрд╛рдд рдореЗрдВ рд╣реИ рдХрд┐ рдпрд╣ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕ рдкрд░ рдпрд╣ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ, рдХрд┐рд╕реА рднреА рдкрд╛рд╕рд╡рд░реНрдб рдкрд░рд┐рд╡рд░реНрддрди рдХреА рдкрд░рд╡рд╛рд╣ рдХрд┐рдП рдмрд┐рдирд╛, рдЬрдм рддрдХ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рдорд╛рдиреНрдп** рд╣реИред

рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ `certmgr.msc` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЧреНрд░рд╛рдлрд┐рдХрд▓ рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдпрд╛ `certreq.exe` рдХреЗ рд╕рд╛рде рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред **Certify** рдХреЗ рд╕рд╛рде, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рд░рд▓ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```bash
Certify.exe request /ca:CA-SERVER\CA-NAME /template:TEMPLATE-NAME
```
рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЕрдиреБрд░реЛрдз рдкрд░, рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЗрд╕рдХреЗ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде `.pem` рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИред рдЗрд╕реЗ Windows рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдпреЛрдЧреНрдп `.pfx` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
`.pfx` рдлрд╝рд╛рдЗрд▓ рдХреЛ рдлрд┐рд░ рдПрдХ рд▓рдХреНрд╖рд┐рдд рдкреНрд░рдгрд╛рд▓реА рдкрд░ рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ [**Rubeus**](https://github.com/GhostPack/Rubeus) рдирд╛рдордХ рдПрдХ рдЙрдкрдХрд░рдг рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯрд┐рдХрдЯ рдЧреНрд░рд╛рдВрдЯрд┐рдВрдЧ рдЯрд┐рдХрдЯ (TGT) рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рд╣рдорд▓рд╛рд╡рд░ рдХреА рдкрд╣реБрдБрдЪ рдХреЛ рддрдм рддрдХ рдмрдврд╝рд╛рддреЗ рд╣реБрдП рдЬрдм рддрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рдорд╛рдиреНрдп** рд╣реИ (рдЖрдорддреМрд░ рдкрд░ рдПрдХ рд╡рд░реНрд╖):
```bash
Rubeus.exe asktgt /user:harmj0y /certificate:C:\Temp\cert.pfx /password:CertPass!
```
рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЪреЗрддрд╛рд╡рдиреА рд╕рд╛рдЭрд╛ рдХреА рдЧрдИ рд╣реИ рдХрд┐ рдХреИрд╕реЗ рдпрд╣ рддрдХрдиреАрдХ, **THEFT5** рдЕрдиреБрднрд╛рдЧ рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдПрдХ рдЕрдиреНрдп рд╡рд┐рдзрд┐ рдХреЗ рд╕рд╛рде рдорд┐рд▓рдХрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд╕реНрдерд╛рдиреАрдп рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЙрдк-рд╕реЗрд╡рд╛ (LSASS) рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд┐рдП рдмрд┐рдирд╛ рдПрдХ рдЦрд╛рддреЗ рдХрд╛ **NTLM рд╣реИрд╢** рд▓рдЧрд╛рддрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдФрд░ рдПрдХ рдЧреИрд░-рдЙрдиреНрдирдд рд╕рдВрджрд░реНрдн рд╕реЗ, рджреАрд░реНрдШрдХрд╛рд▓рд┐рдХ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЪреЛрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдзрд┐рдХ рдЫрд┐рдкрд╛ рд╣реБрдЖ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИред

## **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд╕рд╛рде рдорд╢реАрди рд╕реНрдерд┐рд░рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ - PERSIST2**

рдПрдХ рдЕрдиреНрдп рд╡рд┐рдзрд┐ рдореЗрдВ рдПрдХ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдорд╢реАрди рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд▓рд┐рдП рдирд╛рдорд╛рдВрдХрди рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ `Machine` рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдЬреЛ рдРрд╕реА рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЙрдиреНрдирдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡реЗ **SYSTEM** рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХреА **persistence** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ:
```bash
Certify.exe request /ca:dc.theshire.local/theshire-DC-CA /template:Machine /machine
```
рдпрд╣ рдкрд╣реБрдБрдЪ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдорд╢реАрди рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ **Kerberos** рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдФрд░ рдореЗрдЬрд╝рдмрд╛рди рдкрд░ рдХрд┐рд╕реА рднреА рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП Kerberos рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **S4U2Self** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдорд╢реАрди рдкрд░ рдирд┐рд░рдВрддрд░ рдкрд╣реБрдБрдЪ рдорд┐рд▓рддреА рд╣реИред

## **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╡реАрдиреАрдХрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдирд┐рд░рдВрддрд░рддрд╛ рдмрдврд╝рд╛рдирд╛ - PERSIST3**

рдЕрдВрддрд┐рдо рд╡рд┐рдзрд┐ рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдХреА **рд╡реИрдзрддрд╛** рдФрд░ **рдирд╡реАрдиреАрдХрд░рдг рдЕрд╡рдзрд┐** рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдЙрд╕рдХреА рд╕рдорд╛рдкреНрддрд┐ рд╕реЗ рдкрд╣рд▓реЗ **рдирд╡реАрдиреАрдХрд░рдг** рдХрд░рдХреЗ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдмрдирд╛рдП рд░рдЦ рд╕рдХрддрд╛ рд╣реИ рдмрд┐рдирд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рдЯрд┐рдХрдЯ рдирд╛рдорд╛рдВрдХрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЗ, рдЬреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг (CA) рд╕рд░реНрд╡рд░ рдкрд░ рдирд┐рд╢рд╛рди рдЫреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИред

рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдПрдХ **рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдирд┐рд░рдВрддрд░рддрд╛** рд╡рд┐рдзрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, CA рд╕рд░реНрд╡рд░ рдХреЗ рд╕рд╛рде рдХрдо рдЗрдВрдЯрд░реИрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣рдЪрд╛рди рдХреЗ рдЬреЛрдЦрд┐рдо рдХреЛ рдХрдо рдХрд░рддрд╛ рд╣реИ рдФрд░ рдРрд╕реЗ рдЖрд░реНрдЯрд┐рдлреИрдХреНрдЯреНрд╕ рдХреЗ рдирд┐рд░реНрдорд╛рдг рд╕реЗ рдмрдЪрддрд╛ рд╣реИ рдЬреЛ рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ рдШреБрд╕рдкреИрда рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рддрд░реНрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
