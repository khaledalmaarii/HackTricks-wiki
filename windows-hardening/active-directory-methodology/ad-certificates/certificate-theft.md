# AD CS Certificate Theft

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

**рдпрд╣ [https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf) рд╕реЗ рд╢рд╛рдирджрд╛рд░ рд╢реЛрдз рдХреЗ рдЪреЛрд░реА рдЕрдзреНрдпрд╛рдпреЛрдВ рдХрд╛ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИред**

## What can I do with a certificate

рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЪреБрд░рд╛рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдпрд╣рд╛рдВ рдЖрдкрдХреЗ рдкрд╛рд╕ рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рд╣реИ рдХрд┐ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд┐рд╕рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИ:
```powershell
# Powershell
$CertPath = "C:\path\to\cert.pfx"
$CertPass = "P@ssw0rd"
$Cert = New-Object
System.Security.Cryptography.X509Certificates.X509Certificate2 @($CertPath, $CertPass)
$Cert.EnhancedKeyUsageList

# cmd
certutil.exe -dump -v cert.pfx
```
## Exporting Certificates Using the Crypto APIs тАУ THEFT1

In an **interactive desktop session**, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдирд┐рдХрд╛рд▓рдирд╛ рдЖрд╕рд╛рди рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдпрджрд┐ **рдирд┐рдЬреА рдХреБрдВрдЬреА рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп рд╣реИ**ред рдЗрд╕реЗ `certmgr.msc` рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрд░ рдиреЗрд╡рд┐рдЧреЗрдЯ рдХрд░рдХреЗ, рдЙрд╕ рдкрд░ рд░рд╛рдЗрдЯ-рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдФрд░ `All Tasks тЖТ Export` рдХрд╛ рдЪрдпрди рдХрд░рдХреЗ рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб-рд╕рдВрд░рдХреНрд╖рд┐рдд .pfx рдлрд╝рд╛рдЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

For a **programmatic approach**, рдЙрдкрдХрд░рдг рдЬреИрд╕реЗ PowerShell `ExportPfxCertificate` cmdlet рдпрд╛ [TheWoverтАЩs CertStealer C# project](https://github.com/TheWover/CertStealer) рдЙрдкрд▓рдмреНрдз рд╣реИрдВред рдпреЗ **Microsoft CryptoAPI** (CAPI) рдпрд╛ Cryptography API: Next Generation (CNG) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реНрдЯреЛрд░ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рддреЗ рд╣реИрдВред рдпреЗ APIs рдХрдИ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рд╕реЗрд╡рд╛рдПрдВ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рдирдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рднрдВрдбрд╛рд░рдг рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЗрд╡рд╛рдПрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдПрдХ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдЧреИрд░-рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рд╕рд╛рдорд╛рдиреНрдпрддрдГ CAPI рдФрд░ CNG рдРрд╕реЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рдирд┐рд╖реНрдХрд░реНрд╖рдг рдХреЛ рд░реЛрдХ рджреЗрдВрдЧреЗред рдЗрд╕ рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **Mimikatz** рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред Mimikatz `crypto::capi` рдФрд░ `crypto::cng` рдХрдорд╛рдВрдб рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕рдВрдмрдВрдзрд┐рдд APIs рдХреЛ рдкреИрдЪ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬрд┐рд╕рд╕реЗ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдирд┐рд░реНрдпрд╛рдд рд╕рдВрднрд╡ рд╣реЛ рд╕рдХреЗред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, `crypto::capi` рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рднреАрддрд░ CAPI рдХреЛ рдкреИрдЪ рдХрд░рддрд╛ рд╣реИ, рдЬрдмрдХрд┐ `crypto::cng` рдкреИрдЪрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП **lsass.exe** рдХреА рдореЗрдореЛрд░реА рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИред

## User Certificate Theft via DPAPI тАУ THEFT2

More info about DPAPI in:

{% content-ref url="../../windows-local-privilege-escalation/dpapi-extracting-passwords.md" %}
[dpapi-extracting-passwords.md](../../windows-local-privilege-escalation/dpapi-extracting-passwords.md)
{% endcontent-ref %}

In Windows, **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ DPAPI рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИрдВ**ред рдпрд╣ рдкрд╣рдЪрд╛рдирдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдорд╢реАрди рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рднрдВрдбрд╛рд░рдг рд╕реНрдерд╛рди** рднрд┐рдиреНрди рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ рдлрд╝рд╛рдЗрд▓ рд╕рдВрд░рдЪрдирд╛рдПрдБ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ API рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИрдВред **SharpDPAPI** рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ DPAPI рдмреНрд▓реЙрдмреНрд╕ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рддреЗ рд╕рдордп рдЗрди рднрд┐рдиреНрдирддрд╛рдУрдВ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдиреЗрд╡рд┐рдЧреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ `HKEY_CURRENT_USER\SOFTWARE\Microsoft\SystemCertificates` рдХреЗ рддрд╣рдд рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреБрдЫ `%APPDATA%\Microsoft\SystemCertificates\My\Certificates` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рднреА рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдВрдмрдВрдзрд┐рдд **рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ** рдЖрдорддреМрд░ рдкрд░ `%APPDATA%\Microsoft\Crypto\RSA\User SID\` рдореЗрдВ **CAPI** рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдФрд░ `%APPDATA%\Microsoft\Crypto\Keys\` рдореЗрдВ **CNG** рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреА рд╣реИрдВред

To **extract a certificate and its associated private key**, the process involves:

1. **рд▓рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЪрдпрди рдХрд░рдирд╛** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕реНрдЯреЛрд░ рд╕реЗ рдФрд░ рдЗрд╕рдХреЗ рдХреБрдВрдЬреА рд╕реНрдЯреЛрд░ рдирд╛рдо рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ред
2. **рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА рдХреЛ рдвреВрдВрдврдирд╛**ред
3. **рд╕рд╛рджрд╛ рдкрд╛рда DPAPI рдорд╛рд╕реНрдЯрд░рдХреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛**ред

For **acquiring the plaintext DPAPI masterkey**, the following approaches can be used:
```bash
# With mimikatz, when running in the user's context
dpapi::masterkey /in:"C:\PATH\TO\KEY" /rpc

# With mimikatz, if the user's password is known
dpapi::masterkey /in:"C:\PATH\TO\KEY" /sid:accountSid /password:PASS
```
рдорд╛рд╕реНрдЯрд░рдХреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, [**SharpDPAPI**](https://github.com/GhostPack/SharpDPAPI) рд╕реЗ `certificates` рдХрдорд╛рдВрдб рдлрд╛рдпрджреЗрдордВрдж рд╕рд╛рдмрд┐рдд рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `/pvk`, `/mkfile`, `/password`, рдпрд╛ `{GUID}:KEY` рдХреЛ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рдмрд╛рдж рдПрдХ `.pem` рдлрд╝рд╛рдЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИред
```bash
# Decrypting using SharpDPAPI
SharpDPAPI.exe certificates /mkfile:C:\temp\mkeys.txt

# Converting .pem to .pfx
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
## Machine Certificate Theft via DPAPI тАУ THEFT3

Windows рджреНрд╡рд╛рд░рд╛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates` рдкрд░ рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\RSA\MachineKeys` (CAPI рдХреЗ рд▓рд┐рдП) рдФрд░ `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\Keys` (CNG рдХреЗ рд▓рд┐рдП) рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддреА рд╣реИрдВ, рдЬреЛ рдорд╢реАрди рдХреЗ DPAPI рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИрдВред рдЗрди рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбреЛрдореЗрди рдХреЗ DPAPI рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛; рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, **DPAPI_SYSTEM LSA рд░рд╣рд╕реНрдп**, рдЬрд┐рд╕реЗ рдХреЗрд╡рд▓ SYSTEM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдореИрдиреБрдЕрд▓ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди `lsadump::secrets` рдХрдорд╛рдВрдб рдХреЛ **Mimikatz** рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдХреЗ DPAPI_SYSTEM LSA рд░рд╣рд╕реНрдп рдирд┐рдХрд╛рд▓рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рдмрд╛рдж рдЗрд╕ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдорд╢реАрди рдорд╛рд╕реНрдЯрд░рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, Mimikatz рдХрд╛ `crypto::certificates /export /systemstore:LOCAL_MACHINE` рдХрдорд╛рдВрдб CAPI/CNG рдХреЛ рдкрд╣рд▓реЗ рд╡рд░реНрдгрд┐рдд рддрд░реАрдХреЗ рд╕реЗ рдкреИрдЪ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

**SharpDPAPI** рдЕрдкрдиреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдПрдХ рдЕрдзрд┐рдХ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдЬрдм `/machine` рдзреНрд╡рдЬ рдХреЛ рдКрдВрдЪреЗ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ SYSTEM рдореЗрдВ рдмрдврд╝рддрд╛ рд╣реИ, DPAPI_SYSTEM LSA рд░рд╣рд╕реНрдп рдХреЛ рдбрдВрдк рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдорд╢реАрди DPAPI рдорд╛рд╕реНрдЯрд░рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЗрди рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рднреА рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓реБрдХрдЕрдк рдЯреЗрдмрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рддрд╛ рд╣реИред

## Finding Certificate Files тАУ THEFT4

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрднреА-рдХрднреА рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рднреАрддрд░ рд╕реАрдзреЗ рдкрд╛рдП рдЬрд╛рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдлрд╝рд╛рдЗрд▓ рд╢реЗрдпрд░ рдпрд╛ рдбрд╛рдЙрдирд▓реЛрдб рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВред Windows рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рд▓рд┐рдП рд▓рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдХрд╛рд░ `.pfx` рдФрд░ `.p12` рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХрдо рдмрд╛рд░, `.pkcs12` рдФрд░ `.pem` рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╡рд╛рд▓реА рдлрд╝рд╛рдЗрд▓реЗрдВ рднреА рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИрдВред рдЕрдиреНрдп рдЙрд▓реНрд▓реЗрдЦрдиреАрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░-рд╕рдВрдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:
- рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП `.key`,
- рдХреЗрд╡рд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП `.crt`/`.cer`,
- рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рд╛рдЗрдирд┐рдВрдЧ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдП `.csr`, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдпрд╛ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВ,
- Java рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд╕рд╛рде рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рд░рдЦрдиреЗ рд╡рд╛рд▓реЗ Java рдХреАрд╕реНрдЯреЛрд░реНрд╕ рдХреЗ рд▓рд┐рдП `.jks`/`.keystore`/`.keys`ред

рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ PowerShell рдпрд╛ рдХрдорд╛рдВрдб рдкреНрд░реЙрдореНрдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреА рдЦреЛрдЬ рдХрд░рдХреЗ рдЦреЛрдЬрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдпрджрд┐ рдПрдХ PKCS#12 рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓ рдкрд╛рдИ рдЬрд╛рддреА рд╣реИ рдФрд░ рдпрд╣ рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рддреЛ `pfx2john.py` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╣реИрд╢ рдирд┐рдХрд╛рд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ [fossies.org](https://fossies.org/dox/john-1.9.0-jumbo-1/pfx2john_8py_source.html) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред рдЗрд╕рдХреЗ рдмрд╛рдж, рдкрд╛рд╕рд╡рд░реНрдб рдХреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП JohnTheRipper рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
```powershell
# Example command to search for certificate files in PowerShell
Get-ChildItem -Recurse -Path C:\Users\ -Include *.pfx, *.p12, *.pkcs12, *.pem, *.key, *.crt, *.cer, *.csr, *.jks, *.keystore, *.keys

# Example command to use pfx2john.py for extracting a hash from a PKCS#12 file
pfx2john.py certificate.pfx > hash.txt

# Command to crack the hash with JohnTheRipper
john --wordlist=passwords.txt hash.txt
```
## NTLM Credential Theft via PKINIT тАУ THEFT5

рджрд┐рдП рдЧрдП рд╕рд╛рдордЧреНрд░реА рдореЗрдВ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ NTLM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЪреЛрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рдзрд┐ рдХрд╛ рд╡рд░реНрдгрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЪреЛрд░реА рдХреА рд╡рд┐рдзрд┐ рдЬрд┐рд╕реЗ THEFT5 рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЗрдмрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣рд╛рдБ рдПрдХ рдкреБрдирдГ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреА рдЧрдИ рд╣реИ рдЬреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд╡рд╛рдгреА рдореЗрдВ рд╣реИ, рд╕рд╛рдордЧреНрд░реА рдХреЛ рдЧреБрдордирд╛рдо рдФрд░ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд╣рд╛рдБ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ:

NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг [MS-NLMP] рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЙрди рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдЬреЛ Kerberos рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рд╕реБрд╡рд┐рдзрд╛ рдирд╣реАрдВ рджреЗрддреЗ, KDC рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ NTLM рдПрдХ-рддрд░рдлрд╛ рдлрд╝рдВрдХреНрд╢рди (OWF) рдХреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ `PAC_CREDENTIAL_INFO` рдмрдлрд░ рдореЗрдВ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ (PAC) рдХреЗ рднреАрддрд░ рд▓реМрдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрдм PKCA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдпрджрд┐ рдХреЛрдИ рдЦрд╛рддрд╛ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рддрд╛ рд╣реИ рдФрд░ рдПрдХ рдЯрд┐рдХрдЯ-рдЧреНрд░рд╛рдВрдЯрд┐рдВрдЧ рдЯрд┐рдХрдЯ (TGT) рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рдПрдХ рддрдВрддреНрд░ рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рд╡рд░реНрддрдорд╛рди рд╣реЛрд╕реНрдЯ рдХреЛ NTLM рд╣реИрд╢ рдХреЛ TGT рд╕реЗ рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд┐рд░рд╛рд╕рддреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рдмрдирд╛рдП рд░рдЦрд╛ рдЬрд╛ рд╕рдХреЗред рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `PAC_CREDENTIAL_DATA` рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреЛ рдореВрд▓ рд░реВрдк рд╕реЗ NTLM рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ рдХрд╛ рдПрдХ NDR рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреНрдб рдЪрд┐рддреНрд░рдг рд╣реИред

рдЙрдкрдпреЛрдЧрд┐рддрд╛ **Kekeo**, рдЬреЛ [https://github.com/gentilkiwi/kekeo](https://github.com/gentilkiwi/kekeo) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИ, рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рдбреЗрдЯрд╛ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ TGT рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ NTLM рдХреА рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐ рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдЗрд╕ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдХрдорд╛рдВрдб рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ:
```bash
tgt::pac /caname:generic-DC-CA /subject:genericUser /castore:current_user /domain:domain.local
```
рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдпрд╣ рдиреЛрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ Kekeo рд╕реНрдорд╛рд░реНрдЯрдХрд╛рд░реНрдб-рд╕рдВрд░рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдмрд╢рд░реНрддреЗ рдХрд┐ рдкрд┐рди рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬрд┐рд╕рдХрд╛ рд╕рдВрджрд░реНрдн [https://github.com/CCob/PinSwipe](https://github.com/CCob/PinSwipe) рдкрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣ рд╕рдорд╛рди рдХреНрд╖рдорддрд╛ **Rubeus** рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рд╣реЛрдиреЗ рдХрд╛ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ [https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред

рдпрд╣ рд╡реНрдпрд╛рдЦреНрдпрд╛ NTLM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЪреЛрд░реА рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдФрд░ рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рдХрд░рддреА рд╣реИ, рдЬреЛ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ NTLM рд╣реИрд╢ рдХреА рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ, рдЬреЛ PKINIT рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд TGT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реЛрддреА рд╣реИ, рдФрд░ рдЙрди рдЙрдкрдпреЛрдЧрд┐рддрд╛рдУрдВ рдкрд░ рдЬреЛ рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддреА рд╣реИрдВред

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
